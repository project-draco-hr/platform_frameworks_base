{
  int dcs=smsMessage.getDataCodingScheme();
  int pid=smsMessage.getProtocolIdentifier();
  byte[] pdu=smsMessage.getPdu();
  int scAddressLength=pdu[0] & 0xff;
  int tpduIndex=scAddressLength + 1;
  int tpduLength=pdu.length - tpduIndex;
  int bodyLength=getEnvelopeBodyLength(scAddressLength,tpduLength);
  int totalLength=bodyLength + 1 + (bodyLength > 127 ? 2 : 1);
  byte[] envelope=new byte[totalLength];
  int index=0;
  envelope[index++]=(byte)BER_SMS_PP_DOWNLOAD_TAG;
  if (bodyLength > 127) {
    envelope[index++]=(byte)0x81;
  }
  envelope[index++]=(byte)bodyLength;
  envelope[index++]=(byte)(0x80 | ComprehensionTlvTag.DEVICE_IDENTITIES.value());
  envelope[index++]=(byte)2;
  envelope[index++]=(byte)DEV_ID_NETWORK;
  envelope[index++]=(byte)DEV_ID_UICC;
  if (scAddressLength != 0) {
    envelope[index++]=(byte)ComprehensionTlvTag.ADDRESS.value();
    envelope[index++]=(byte)scAddressLength;
    System.arraycopy(pdu,1,envelope,index,scAddressLength);
    index+=scAddressLength;
  }
  envelope[index++]=(byte)(0x80 | ComprehensionTlvTag.SMS_TPDU.value());
  if (tpduLength > 127) {
    envelope[index++]=(byte)0x81;
  }
  envelope[index++]=(byte)tpduLength;
  System.arraycopy(pdu,tpduIndex,envelope,index,tpduLength);
  index+=tpduLength;
  if (index != envelope.length) {
    Log.e(TAG,"startDataDownload() calculated incorrect envelope length, aborting.");
    acknowledgeSmsWithError(CommandsInterface.GSM_SMS_FAIL_CAUSE_UNSPECIFIED_ERROR);
    return;
  }
  String encodedEnvelope=IccUtils.bytesToHexString(envelope);
  mCI.sendEnvelopeWithStatus(encodedEnvelope,obtainMessage(EVENT_SEND_ENVELOPE_RESPONSE,new int[]{dcs,pid}));
}
