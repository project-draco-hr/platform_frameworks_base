{
  OutputStream os=null;
  InputStream is=null;
  DrmConvertSession drmConvertSession=null;
  Uri dataUri=null;
  String path=null;
  try {
    byte[] data=part.getData();
    if (ContentType.TEXT_PLAIN.equals(contentType) || ContentType.APP_SMIL.equals(contentType) || ContentType.TEXT_HTML.equals(contentType)) {
      ContentValues cv=new ContentValues();
      cv.put(Telephony.Mms.Part.TEXT,new EncodedStringValue(data).getString());
      if (mContentResolver.update(uri,cv,null,null) != 1) {
        throw new MmsException("unable to update " + uri.toString());
      }
    }
 else {
      boolean isDrm=DownloadDrmHelper.isDrmConvertNeeded(contentType);
      if (isDrm) {
        if (uri != null) {
          try {
            path=convertUriToPath(mContext,uri);
            if (LOCAL_LOGV) {
              Log.v(TAG,"drm uri: " + uri + " path: "+ path);
            }
            File f=new File(path);
            long len=f.length();
            if (LOCAL_LOGV) {
              Log.v(TAG,"drm path: " + path + " len: "+ len);
            }
            if (len > 0) {
              return;
            }
          }
 catch (          Exception e) {
            Log.e(TAG,"Can't get file info for: " + part.getDataUri(),e);
          }
        }
        drmConvertSession=DrmConvertSession.open(mContext,contentType);
        if (drmConvertSession == null) {
          throw new MmsException("Mimetype " + contentType + " can not be converted.");
        }
      }
      os=mContentResolver.openOutputStream(uri);
      if (data == null) {
        dataUri=part.getDataUri();
        if ((dataUri == null) || (dataUri == uri)) {
          Log.w(TAG,"Can't find data for this part.");
          return;
        }
        is=mContentResolver.openInputStream(dataUri);
        if (LOCAL_LOGV) {
          Log.v(TAG,"Saving data to: " + uri);
        }
        byte[] buffer=new byte[8192];
        for (int len=0; (len=is.read(buffer)) != -1; ) {
          if (!isDrm) {
            os.write(buffer,0,len);
          }
 else {
            byte[] convertedData=drmConvertSession.convert(buffer,len);
            if (convertedData != null) {
              os.write(convertedData,0,convertedData.length);
            }
 else {
              throw new MmsException("Error converting drm data.");
            }
          }
        }
      }
 else {
        if (LOCAL_LOGV) {
          Log.v(TAG,"Saving data to: " + uri);
        }
        if (!isDrm) {
          os.write(data);
        }
 else {
          dataUri=uri;
          byte[] convertedData=drmConvertSession.convert(data,data.length);
          if (convertedData != null) {
            os.write(convertedData,0,convertedData.length);
          }
 else {
            throw new MmsException("Error converting drm data.");
          }
        }
      }
    }
  }
 catch (  FileNotFoundException e) {
    Log.e(TAG,"Failed to open Input/Output stream.",e);
    throw new MmsException(e);
  }
catch (  IOException e) {
    Log.e(TAG,"Failed to read/write data.",e);
    throw new MmsException(e);
  }
 finally {
    if (os != null) {
      try {
        os.close();
      }
 catch (      IOException e) {
        Log.e(TAG,"IOException while closing: " + os,e);
      }
    }
    if (is != null) {
      try {
        is.close();
      }
 catch (      IOException e) {
        Log.e(TAG,"IOException while closing: " + is,e);
      }
    }
    if (drmConvertSession != null) {
      drmConvertSession.close(path);
      File f=new File(path);
      ContentValues values=new ContentValues(0);
      SqliteWrapper.update(mContext,mContentResolver,Uri.parse("content://mms/resetFilePerm/" + f.getName()),values,null,null);
    }
  }
}
