{
  ArrayList<Batch> oldSet=(ArrayList<Batch>)mAlarmBatches.clone();
  mAlarmBatches.clear();
  Alarm oldPendingIdleUntil=mPendingIdleUntil;
  final long nowElapsed=SystemClock.elapsedRealtime();
  final int oldBatches=oldSet.size();
  for (int batchNum=0; batchNum < oldBatches; batchNum++) {
    Batch batch=oldSet.get(batchNum);
    final int N=batch.size();
    for (int i=0; i < N; i++) {
      reAddAlarmLocked(batch.get(i),nowElapsed,doValidate);
    }
  }
  if (oldPendingIdleUntil != null && oldPendingIdleUntil != mPendingIdleUntil) {
    Slog.wtf(TAG,"Rebatching: idle until changed from " + oldPendingIdleUntil + " to "+ mPendingIdleUntil);
    if (mPendingIdleUntil == null) {
      restorePendingWhileIdleAlarmsLocked();
    }
  }
  rescheduleKernelAlarmsLocked();
  updateNextAlarmClockLocked();
}
