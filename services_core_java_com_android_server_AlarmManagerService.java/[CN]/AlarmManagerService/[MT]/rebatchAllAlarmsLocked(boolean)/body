{
  ArrayList<Batch> oldSet=(ArrayList<Batch>)mAlarmBatches.clone();
  mAlarmBatches.clear();
  final long nowElapsed=SystemClock.elapsedRealtime();
  final int oldBatches=oldSet.size();
  for (int batchNum=0; batchNum < oldBatches; batchNum++) {
    Batch batch=oldSet.get(batchNum);
    final int N=batch.size();
    for (int i=0; i < N; i++) {
      Alarm a=batch.get(i);
      long whenElapsed=convertToElapsed(a.when,a.type);
      final long maxElapsed;
      if (a.whenElapsed == a.maxWhen) {
        maxElapsed=whenElapsed;
      }
 else {
        maxElapsed=(a.windowLength > 0) ? (whenElapsed + a.windowLength) : maxTriggerTime(nowElapsed,whenElapsed,a.repeatInterval);
      }
      setImplLocked(a.type,a.when,whenElapsed,a.windowLength,maxElapsed,a.repeatInterval,a.operation,batch.standalone,doValidate,a.workSource,a.alarmClock,a.userId);
    }
  }
}
