{
  final PrintWriter pw=getOutPrintWriter();
  boolean useJitProfiles=false;
  boolean forceCompilation=false;
  boolean allPackages=false;
  boolean clearProfileData=false;
  String compilerFilter=null;
  String compilationReason=null;
  if (peekNextArg() == null) {
    pw.println("Usage: cmd package compile [-c] [-f] [--reset] [-m mode] " + "[-r reason] [-a|pkg]");
    pw.println();
    pw.println("  -c         Clear profile data");
    pw.println("  -f         Force compilation");
    pw.println("  --reset    Reset package");
    pw.println("  -m mode    Compilation mode, one of the dex2oat compiler filters");
    pw.println("               verify-none");
    pw.println("               verify-at-runtime");
    pw.println("               verify-profile");
    pw.println("               interpret-only");
    pw.println("               space-profile");
    pw.println("               space");
    pw.println("               speed-profile");
    pw.println("               speed");
    pw.println("               everything");
    pw.println("  -r reason  Compiler reason, one of the package manager reasons");
    for (int i=0; i < PackageManagerServiceCompilerMapping.REASON_STRINGS.length; i++) {
      pw.println("               " + PackageManagerServiceCompilerMapping.REASON_STRINGS[i]);
    }
    pw.println("  -a         Apply to all packages");
    return 1;
  }
  String opt;
  while ((opt=getNextOption()) != null) {
switch (opt) {
case "-a":
      allPackages=true;
    break;
case "-c":
  clearProfileData=true;
break;
case "-f":
forceCompilation=true;
break;
case "-m":
compilerFilter=getNextArgRequired();
break;
case "-r":
compilationReason=getNextArgRequired();
break;
case "--reset":
forceCompilation=true;
clearProfileData=true;
compilerFilter="reset";
break;
default :
pw.println("Error: Unknown option: " + opt);
return 1;
}
}
if (compilerFilter != null && compilationReason != null) {
pw.println("Cannot use compilation filter (\"-m\") and compilation reason (\"-r\") " + "at the same time");
return 1;
}
if (compilerFilter == null && compilationReason == null) {
pw.println("Cannot run without any of compilation filter (\"-m\") and compilation " + "reason (\"-r\") at the same time");
return 1;
}
String targetCompilerFilter;
if (compilerFilter != null) {
if ("default".equals(compilerFilter)) {
targetCompilerFilter=PackageManagerServiceCompilerMapping.getCompilerFilterForReason(PackageManagerServiceCompilerMapping.REASON_BACKGROUND_DEXOPT);
}
 else if ("reset".equals(compilerFilter)) {
targetCompilerFilter=PackageManagerServiceCompilerMapping.getCompilerFilterForReason(PackageManagerServiceCompilerMapping.REASON_INSTALL);
}
 else {
if (!DexFile.isValidCompilerFilter(compilerFilter)) {
pw.println("Error: \"" + compilerFilter + "\" is not a valid compilation filter.");
return 1;
}
targetCompilerFilter=compilerFilter;
}
}
 else {
int reason=-1;
for (int i=0; i < PackageManagerServiceCompilerMapping.REASON_STRINGS.length; i++) {
if (PackageManagerServiceCompilerMapping.REASON_STRINGS[i].equals(compilationReason)) {
reason=i;
break;
}
}
if (reason == -1) {
pw.println("Error: Unknown compilation reason: " + compilationReason);
return 1;
}
targetCompilerFilter=PackageManagerServiceCompilerMapping.getCompilerFilterForReason(reason);
}
List<String> packageNames=null;
if (allPackages) {
packageNames=mInterface.getAllPackages();
}
 else {
String packageName=getNextArg();
if (packageName == null) {
pw.println("Error: package name not specified");
return 1;
}
packageNames=Collections.singletonList(packageName);
}
List<String> failedPackages=new ArrayList<>();
for (String packageName : packageNames) {
if (clearProfileData) {
mInterface.clearApplicationProfileData(packageName);
}
boolean result=mInterface.performDexOptMode(packageName,null,useJitProfiles,targetCompilerFilter,forceCompilation);
if (!result) {
failedPackages.add(packageName);
}
}
if (failedPackages.isEmpty()) {
pw.println("Success");
return 0;
}
 else if (failedPackages.size() == 1) {
pw.println("Failure: package " + failedPackages.get(0) + " could not be compiled");
return 1;
}
 else {
pw.print("Failure: the following packages could not be compiled: ");
boolean is_first=true;
for (String packageName : failedPackages) {
if (is_first) {
is_first=false;
}
 else {
pw.print(", ");
}
pw.print(packageName);
}
pw.println();
return 1;
}
}
