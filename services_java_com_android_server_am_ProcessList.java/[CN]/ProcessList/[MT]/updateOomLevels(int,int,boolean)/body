{
  float scaleMem=((float)(mTotalMemMb - 300)) / (700 - 300);
  int minSize=480 * 800;
  int maxSize=1280 * 800;
  float scaleDisp=((float)(displayWidth * displayHeight) - minSize) / (maxSize - minSize);
  if (false) {
    Slog.i("XXXXXX","scaleMem=" + scaleMem);
    Slog.i("XXXXXX","scaleDisp=" + scaleDisp + " dw="+ displayWidth+ " dh="+ displayHeight);
  }
  StringBuilder adjString=new StringBuilder();
  StringBuilder memString=new StringBuilder();
  float scale=scaleMem > scaleDisp ? scaleMem : scaleDisp;
  if (scale < 0)   scale=0;
 else   if (scale > 1)   scale=1;
  int minfree_adj=Resources.getSystem().getInteger(com.android.internal.R.integer.config_lowMemoryKillerMinFreeKbytesAdjust);
  int minfree_abs=Resources.getSystem().getInteger(com.android.internal.R.integer.config_lowMemoryKillerMinFreeKbytesAbsolute);
  if (false) {
    Slog.i("XXXXXX","minfree_adj=" + minfree_adj + " minfree_abs="+ minfree_abs);
  }
  for (int i=0; i < mOomAdj.length; i++) {
    long low=mOomMinFreeLow[i];
    long high=mOomMinFreeHigh[i];
    mOomMinFree[i]=(long)(low + ((high - low) * scale));
  }
  if (minfree_abs >= 0) {
    for (int i=0; i < mOomAdj.length; i++) {
      mOomMinFree[i]=(long)((float)minfree_abs * mOomMinFree[i] / mOomMinFree[mOomAdj.length - 1]);
    }
  }
  if (minfree_adj != 0) {
    for (int i=0; i < mOomAdj.length; i++) {
      mOomMinFree[i]+=(long)((float)minfree_adj * mOomMinFree[i] / mOomMinFree[mOomAdj.length - 1]);
      if (mOomMinFree[i] < 0) {
        mOomMinFree[i]=0;
      }
    }
  }
  for (int i=0; i < mOomAdj.length; i++) {
    if (i > 0) {
      adjString.append(',');
      memString.append(',');
    }
    adjString.append(mOomAdj[i]);
    memString.append((mOomMinFree[i] * 1024) / PAGE_SIZE);
  }
  int reserve=displayWidth * displayHeight * 4* 3 / 1024;
  int reserve_adj=Resources.getSystem().getInteger(com.android.internal.R.integer.config_extraFreeKbytesAdjust);
  int reserve_abs=Resources.getSystem().getInteger(com.android.internal.R.integer.config_extraFreeKbytesAbsolute);
  if (reserve_abs >= 0) {
    reserve=reserve_abs;
  }
  if (reserve_adj != 0) {
    reserve+=reserve_adj;
    if (reserve < 0) {
      reserve=0;
    }
  }
  if (write) {
    writeFile("/sys/module/lowmemorykiller/parameters/adj",adjString.toString());
    writeFile("/sys/module/lowmemorykiller/parameters/minfree",memString.toString());
    SystemProperties.set("sys.sysctl.extra_free_kbytes",Integer.toString(reserve));
  }
}
