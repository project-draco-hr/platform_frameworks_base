{
  if (view == null) {
    throw new IllegalArgumentException("view must not be null");
  }
  if (display == null) {
    throw new IllegalArgumentException("display must not be null");
  }
  if (!(params instanceof WindowManager.LayoutParams)) {
    throw new IllegalArgumentException("Params must be WindowManager.LayoutParams");
  }
  final WindowManager.LayoutParams wparams=(WindowManager.LayoutParams)params;
  if (parentWindow != null) {
    parentWindow.adjustLayoutParamsForSubWindow(wparams);
  }
  ViewRootImpl root;
  View panelParentView=null;
synchronized (mLock) {
    if (mSystemPropertyUpdater == null) {
      mSystemPropertyUpdater=new Runnable(){
        @Override public void run(){
synchronized (mLock) {
            for (int i=mRoots.size() - 1; i >= 0; --i) {
              mRoots.get(i).loadSystemProperties();
            }
          }
        }
      }
;
      SystemProperties.addChangeCallback(mSystemPropertyUpdater);
    }
    int index=findViewLocked(view,false);
    if (index >= 0) {
      throw new IllegalStateException("View " + view + " has already been added to the window manager.");
    }
    if (wparams.type >= WindowManager.LayoutParams.FIRST_SUB_WINDOW && wparams.type <= WindowManager.LayoutParams.LAST_SUB_WINDOW) {
      final int count=mViews.size();
      for (int i=0; i < count; i++) {
        if (mRoots.get(i).mWindow.asBinder() == wparams.token) {
          panelParentView=mViews.get(i);
        }
      }
    }
    root=new ViewRootImpl(view.getContext(),display);
    view.setLayoutParams(wparams);
    mViews.add(view);
    mRoots.add(root);
    mParams.add(wparams);
  }
  try {
    root.setView(view,wparams,panelParentView);
  }
 catch (  RuntimeException e) {
synchronized (mLock) {
      final int index=findViewLocked(view,false);
      if (index >= 0) {
        removeViewLocked(index,true);
      }
    }
    throw e;
  }
}
