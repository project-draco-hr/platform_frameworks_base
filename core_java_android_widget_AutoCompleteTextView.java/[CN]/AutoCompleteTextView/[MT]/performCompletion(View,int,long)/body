{
  if (isPopupShowing()) {
    Object selectedItem;
    if (position < 0) {
      selectedItem=mPopup.getSelectedItem();
    }
 else {
      selectedItem=mAdapter.getItem(position);
    }
    if (selectedItem == null) {
      Log.w(TAG,"performCompletion: no selected item");
      return;
    }
    mBlockCompletion=true;
    replaceText(convertSelectionToString(selectedItem));
    mBlockCompletion=false;
    if (mItemClickListener != null) {
      final ListPopupWindow list=mPopup;
      if (selectedView == null || position < 0) {
        selectedView=list.getSelectedView();
        position=list.getSelectedItemPosition();
        id=list.getSelectedItemId();
      }
      mItemClickListener.onItemClick(list.getListView(),selectedView,position,id);
    }
  }
  if (mDropDownDismissedOnCompletion && !mPopup.isDropDownAlwaysVisible()) {
    dismissDropDown();
  }
}
