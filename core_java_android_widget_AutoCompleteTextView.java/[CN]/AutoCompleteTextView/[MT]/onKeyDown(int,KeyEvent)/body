{
  if (isPopupShowing()) {
    if (keyCode != KeyEvent.KEYCODE_SPACE && (mDropDownList.getSelectedItemPosition() >= 0 || (keyCode != KeyEvent.KEYCODE_ENTER && keyCode != KeyEvent.KEYCODE_DPAD_CENTER))) {
      int curIndex=mDropDownList.getSelectedItemPosition();
      boolean consumed;
      final boolean below=!mPopup.isAboveAnchor();
      final ListAdapter adapter=mDropDownList.getAdapter();
      final boolean allEnabled=adapter.areAllItemsEnabled();
      final int firstItem=allEnabled ? 0 : mDropDownList.lookForSelectablePosition(0,true);
      final int lastItem=allEnabled ? adapter.getCount() - 1 : mDropDownList.lookForSelectablePosition(adapter.getCount() - 1,false);
      if ((below && keyCode == KeyEvent.KEYCODE_DPAD_UP && curIndex <= firstItem) || (!below && keyCode == KeyEvent.KEYCODE_DPAD_DOWN && curIndex >= lastItem)) {
        clearListSelection();
        mPopup.setInputMethodMode(PopupWindow.INPUT_METHOD_NEEDED);
        showDropDown();
        return true;
      }
 else {
        mDropDownList.mListSelectionHidden=false;
      }
      consumed=mDropDownList.onKeyDown(keyCode,event);
      if (DEBUG)       Log.v(TAG,"Key down: code=" + keyCode + " list consumed="+ consumed);
      if (consumed) {
        mPopup.setInputMethodMode(PopupWindow.INPUT_METHOD_NOT_NEEDED);
        mDropDownList.requestFocusFromTouch();
        showDropDown();
switch (keyCode) {
case KeyEvent.KEYCODE_ENTER:
case KeyEvent.KEYCODE_DPAD_CENTER:
case KeyEvent.KEYCODE_DPAD_DOWN:
case KeyEvent.KEYCODE_DPAD_UP:
          return true;
      }
    }
 else {
      if (below && keyCode == KeyEvent.KEYCODE_DPAD_DOWN) {
        if (curIndex == lastItem) {
          return true;
        }
      }
 else       if (!below && keyCode == KeyEvent.KEYCODE_DPAD_UP && curIndex == firstItem) {
        return true;
      }
    }
  }
}
 else {
switch (keyCode) {
case KeyEvent.KEYCODE_DPAD_DOWN:
    performValidation();
}
}
mLastKeyCode=keyCode;
boolean handled=super.onKeyDown(keyCode,event);
mLastKeyCode=KeyEvent.KEYCODE_UNKNOWN;
if (handled && isPopupShowing() && mDropDownList != null) {
clearListSelection();
}
return handled;
}
