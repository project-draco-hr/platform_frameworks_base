{
  long threshold=mPolicyThreshold.get();
  if (threshold == 0) {
    clearThrottleAndNotification();
    return;
  }
  if (!mTime.hasCache()) {
    Slog.w(TAG,"missing trusted time, skipping throttle check");
    return;
  }
  if (currentTotal > threshold) {
    if (mThrottleIndex.get() != 1) {
      mThrottleIndex.set(1);
      if (DBG)       Slog.d(TAG,"Threshold " + threshold + " exceeded!");
      try {
        mNMService.setInterfaceThrottle(mIface,mPolicyThrottleValue.get(),mPolicyThrottleValue.get());
      }
 catch (      Exception e) {
        Slog.e(TAG,"error setting Throttle: " + e);
      }
      mNotificationManager.cancel(R.drawable.stat_sys_throttled);
      postNotification(R.string.throttled_notification_title,R.string.throttled_notification_message,R.drawable.stat_sys_throttled,Notification.FLAG_ONGOING_EVENT);
      Intent broadcast=new Intent(ThrottleManager.THROTTLE_ACTION);
      broadcast.putExtra(ThrottleManager.EXTRA_THROTTLE_LEVEL,mPolicyThrottleValue.get());
      mContext.sendStickyBroadcast(broadcast);
    }
  }
 else {
    clearThrottleAndNotification();
    if ((mPolicyNotificationsAllowedMask & NOTIFICATION_WARNING) != 0) {
      long start=mRecorder.getPeriodStart();
      long end=mRecorder.getPeriodEnd();
      long periodLength=end - start;
      long now=System.currentTimeMillis();
      long timeUsed=now - start;
      long warningThreshold=2 * threshold * timeUsed / (timeUsed + periodLength);
      if ((currentTotal > warningThreshold) && (currentTotal > threshold / 4)) {
        if (mWarningNotificationSent == false) {
          mWarningNotificationSent=true;
          mNotificationManager.cancel(R.drawable.stat_sys_throttled);
          postNotification(R.string.throttle_warning_notification_title,R.string.throttle_warning_notification_message,R.drawable.stat_sys_throttled,0);
        }
      }
 else {
        if (mWarningNotificationSent == true) {
          mNotificationManager.cancel(R.drawable.stat_sys_throttled);
          mWarningNotificationSent=false;
        }
      }
    }
  }
}
