{
  VirtualMidiDevice device;
  Client client=getClient(token);
  if (client == null)   return null;
synchronized (mDevices) {
    int id=mNextDeviceId++;
    MidiDeviceInfo deviceInfo=new MidiDeviceInfo(MidiDeviceInfo.TYPE_VIRTUAL,id,properties);
    device=new VirtualMidiDevice(deviceInfo);
    if (!device.open()) {
      return null;
    }
    mDevices.put(id,device);
    client.addVirtualDevice(device);
  }
synchronized (mClients) {
    MidiDeviceInfo deviceInfo=device.getInfo();
    for (    Client c : mClients.values()) {
      c.deviceAdded(deviceInfo);
    }
  }
  return device.getProxy();
}
