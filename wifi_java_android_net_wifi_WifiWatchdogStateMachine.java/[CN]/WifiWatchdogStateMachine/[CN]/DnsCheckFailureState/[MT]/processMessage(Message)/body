{
  if (msg.what != MESSAGE_HANDLE_BAD_AP) {
    return NOT_HANDLED;
  }
  if (msg.arg1 != mNetEventCounter) {
    if (VDBG) {
      Slog.v(WWSM_TAG,"Msg out of sync, ignoring...");
    }
    return HANDLED;
  }
  if (mDisableAPNextFailure || mNumCheckFailures >= mMaxSsidBlacklists) {
    Slog.i(WWSM_TAG,"Disabling current SSID " + wifiInfoToStr(mInitialConnInfo) + ".  "+ "numCheckFailures "+ mNumCheckFailures+ ", numAPs "+ mBssids.size());
    mWifiManager.disableNetwork(mInitialConnInfo.getNetworkId());
    if (mShowDisabledNotification) {
      displayDisabledNetworkNotification();
      mShowDisabledNotification=false;
      putSettingsBoolean(mContentResolver,Settings.Secure.WIFI_WATCHDOG_SHOW_DISABLED_NETWORK_POPUP,false);
    }
    transitionTo(mNotConnectedState);
  }
 else {
    Slog.i(WWSM_TAG,"Blacklisting current BSSID.  " + wifiInfoToStr(mInitialConnInfo) + "numCheckFailures "+ mNumCheckFailures+ ", numAPs "+ mBssids.size());
    mWifiManager.addToBlacklist(mInitialConnInfo.getBSSID());
    mWifiManager.reassociate();
    transitionTo(mBlacklistedApState);
  }
  return HANDLED;
}
