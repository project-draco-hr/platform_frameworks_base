{
  boolean setInputFilter=false;
  AccessibilityInputFilter inputFilter=null;
synchronized (mLock) {
    int flags=0;
    if (userState.mIsDisplayMagnificationEnabled) {
      flags|=AccessibilityInputFilter.FLAG_FEATURE_SCREEN_MAGNIFIER;
    }
    if (userState.mIsAccessibilityEnabled && userState.mIsTouchExplorationEnabled) {
      flags|=AccessibilityInputFilter.FLAG_FEATURE_TOUCH_EXPLORATION;
    }
    if (userState.mIsFilterKeyEventsEnabled) {
      flags|=AccessibilityInputFilter.FLAG_FEATURE_FILTER_KEY_EVENTS;
    }
    if (flags != 0) {
      if (!mHasInputFilter) {
        mHasInputFilter=true;
        if (mInputFilter == null) {
          mInputFilter=new AccessibilityInputFilter(mContext,AccessibilityManagerService.this);
        }
        inputFilter=mInputFilter;
        setInputFilter=true;
      }
      mInputFilter.setEnabledFeatures(flags);
    }
 else {
      if (mHasInputFilter) {
        mHasInputFilter=false;
        mInputFilter.disableFeatures();
        inputFilter=null;
        setInputFilter=true;
      }
    }
  }
  if (setInputFilter) {
    mWindowManagerService.setInputFilter(inputFilter);
  }
}
