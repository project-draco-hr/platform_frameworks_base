{
  if (sendDelete) {
    if (r.getNotification().deleteIntent != null) {
      try {
        r.getNotification().deleteIntent.send();
      }
 catch (      PendingIntent.CanceledException ex) {
        Slog.w(TAG,"canceled PendingIntent for " + r.sbn.getPackageName(),ex);
      }
    }
  }
  if (r.getNotification().getSmallIcon() != null) {
    r.isCanceled=true;
    mListeners.notifyRemovedLocked(r.sbn);
  }
  final String canceledKey=r.getKey();
  if (canceledKey.equals(mSoundNotificationKey)) {
    mSoundNotificationKey=null;
    final long identity=Binder.clearCallingIdentity();
    try {
      final IRingtonePlayer player=mAudioManager.getRingtonePlayer();
      if (player != null) {
        player.stopAsync();
      }
    }
 catch (    RemoteException e) {
    }
 finally {
      Binder.restoreCallingIdentity(identity);
    }
  }
  if (canceledKey.equals(mVibrateNotificationKey)) {
    mVibrateNotificationKey=null;
    long identity=Binder.clearCallingIdentity();
    try {
      mVibrator.cancel();
    }
  finally {
      Binder.restoreCallingIdentity(identity);
    }
  }
  mLights.remove(canceledKey);
switch (reason) {
case REASON_DELEGATE_CANCEL:
case REASON_DELEGATE_CANCEL_ALL:
case REASON_LISTENER_CANCEL:
case REASON_LISTENER_CANCEL_ALL:
    mUsageStats.registerDismissedByUser(r);
  break;
case REASON_NOMAN_CANCEL:
case REASON_NOMAN_CANCEL_ALL:
mUsageStats.registerRemovedByApp(r);
break;
case REASON_DELEGATE_CLICK:
mUsageStats.registerCancelDueToClick(r);
break;
default :
mUsageStats.registerCancelUnknown(r);
break;
}
mNotificationsByKey.remove(r.sbn.getKey());
String groupKey=r.getGroupKey();
NotificationRecord groupSummary=mSummaryByGroupKey.get(groupKey);
if (groupSummary != null && groupSummary.getKey().equals(r.getKey())) {
mSummaryByGroupKey.remove(groupKey);
}
mArchive.record(r.sbn);
final long now=System.currentTimeMillis();
EventLogTags.writeNotificationCanceled(canceledKey,reason,r.getLifespanMs(now),r.getFreshnessMs(now),r.getExposureMs(now));
}
