{
  final int mode=Settings.Global.getInt(getContext().getContentResolver(),Settings.Global.ZEN_MODE,Settings.Global.ZEN_MODE_OFF);
  if (mode != mZenMode) {
    Slog.d(TAG,"updateZenMode: " + Settings.Global.zenModeToString(mZenMode));
  }
  mZenMode=mode;
  if (mAudioManager != null) {
    final boolean muteCalls=mZenMode != Settings.Global.ZEN_MODE_OFF;
    if (muteCalls) {
      if (DBG)       Slog.d(TAG,"Muting calls");
      mAudioManager.setStreamMute(AudioManager.STREAM_RING,true);
      final int ringerMode=mAudioManager.getRingerMode();
      if (ringerMode != AudioManager.RINGER_MODE_SILENT) {
        if (DBG)         Slog.d(TAG,"Saving ringer mode of " + ringerMode);
        mPreZenRingerMode=ringerMode;
        mAudioManager.setRingerMode(AudioManager.RINGER_MODE_SILENT);
      }
    }
 else {
      if (DBG)       Slog.d(TAG,"Unmuting calls");
      mAudioManager.setStreamMute(AudioManager.STREAM_RING,false);
      if (mPreZenRingerMode != -1) {
        if (DBG)         Slog.d(TAG,"Restoring ringer mode to " + mPreZenRingerMode);
        mAudioManager.setRingerMode(mPreZenRingerMode);
        mPreZenRingerMode=-1;
      }
    }
    final boolean muteAlarms=mZenMode == Settings.Global.ZEN_MODE_FULL;
    if (muteAlarms) {
      if (DBG)       Slog.d(TAG,"Muting alarms");
      mAudioManager.setStreamMute(AudioManager.STREAM_ALARM,true);
      final int volume=mAudioManager.getStreamVolume(AudioManager.STREAM_ALARM);
      if (volume != 0) {
        if (DBG)         Slog.d(TAG,"Saving STREAM_ALARM volume of " + volume);
        mPreZenAlarmVolume=volume;
        mAudioManager.setStreamVolume(AudioManager.STREAM_ALARM,0,0);
      }
    }
 else {
      if (DBG)       Slog.d(TAG,"Unmuting alarms");
      mAudioManager.setStreamMute(AudioManager.STREAM_ALARM,false);
      if (mPreZenAlarmVolume != -1) {
        if (DBG)         Slog.d(TAG,"Restoring STREAM_ALARM volume to " + mPreZenAlarmVolume);
        mAudioManager.setStreamVolume(AudioManager.STREAM_ALARM,mPreZenAlarmVolume,0);
        mPreZenAlarmVolume=-1;
      }
    }
  }
}
