{
  final int mode=Settings.Global.getInt(getContext().getContentResolver(),Settings.Global.ZEN_MODE,Settings.Global.ZEN_MODE_OFF);
  if (mode != mZenMode) {
    Slog.d(TAG,String.format("updateZenMode: %s -> %s",Settings.Global.zenModeToString(mZenMode),Settings.Global.zenModeToString(mode)));
  }
  mZenMode=mode;
  if (mAudioManager != null) {
    final boolean muteCalls=mZenMode != Settings.Global.ZEN_MODE_OFF;
    if (muteCalls) {
      if (!mZenMutingRinger) {
        if (DBG)         Slog.d(TAG,"Muting STREAM_RING");
        mAudioManager.setStreamMute(AudioManager.STREAM_RING,true);
        mZenMutingRinger=true;
      }
      final int ringerMode=mAudioManager.getRingerMode();
      if (ringerMode != AudioManager.RINGER_MODE_SILENT) {
        if (DBG)         Slog.d(TAG,"Saving ringer mode of " + ringerMode);
        mPreZenRingerMode=ringerMode;
        mAudioManager.setRingerMode(AudioManager.RINGER_MODE_SILENT);
      }
    }
 else {
      if (mZenMutingRinger) {
        if (DBG)         Slog.d(TAG,"Unmuting STREAM_RING");
        mAudioManager.setStreamMute(AudioManager.STREAM_RING,false);
        mZenMutingRinger=false;
      }
      if (mPreZenRingerMode != -1) {
        if (DBG)         Slog.d(TAG,"Restoring ringer mode to " + mPreZenRingerMode);
        mAudioManager.setRingerMode(mPreZenRingerMode);
        mPreZenRingerMode=-1;
      }
    }
    final boolean muteAlarms=mZenMode == Settings.Global.ZEN_MODE_FULL;
    if (muteAlarms) {
      if (!mZenMutingAlarm) {
        if (DBG)         Slog.d(TAG,"Muting STREAM_ALARM");
        mAudioManager.setStreamMute(AudioManager.STREAM_ALARM,true);
        mZenMutingAlarm=true;
      }
      final int volume=mAudioManager.getStreamVolume(AudioManager.STREAM_ALARM);
      if (volume != 0) {
        if (DBG)         Slog.d(TAG,"Saving STREAM_ALARM volume of " + volume);
        mPreZenAlarmVolume=volume;
        mAudioManager.setStreamVolume(AudioManager.STREAM_ALARM,0,0);
      }
    }
 else {
      if (mZenMutingAlarm) {
        if (DBG)         Slog.d(TAG,"Unmuting STREAM_ALARM");
        mAudioManager.setStreamMute(AudioManager.STREAM_ALARM,false);
        mZenMutingAlarm=false;
      }
      if (mPreZenAlarmVolume != -1) {
        if (DBG)         Slog.d(TAG,"Restoring STREAM_ALARM volume to " + mPreZenAlarmVolume);
        mAudioManager.setStreamVolume(AudioManager.STREAM_ALARM,mPreZenAlarmVolume,0);
        mPreZenAlarmVolume=-1;
      }
    }
  }
}
