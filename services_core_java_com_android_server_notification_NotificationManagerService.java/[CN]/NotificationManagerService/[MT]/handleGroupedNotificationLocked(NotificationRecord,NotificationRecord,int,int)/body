{
  StatusBarNotification sbn=r.sbn;
  Notification n=sbn.getNotification();
  if (n.isGroupSummary() && !sbn.isAppGroup()) {
    n.flags&=~Notification.FLAG_GROUP_SUMMARY;
  }
  String group=sbn.getGroupKey();
  boolean isSummary=n.isGroupSummary();
  Notification oldN=old != null ? old.sbn.getNotification() : null;
  String oldGroup=old != null ? old.sbn.getGroupKey() : null;
  boolean oldIsSummary=old != null && oldN.isGroupSummary();
  if (oldIsSummary) {
    NotificationRecord removedSummary=mSummaryByGroupKey.remove(oldGroup);
    if (removedSummary != old) {
      String removedKey=removedSummary != null ? removedSummary.getKey() : "<null>";
      Slog.w(TAG,"Removed summary didn't match old notification: old=" + old.getKey() + ", removed="+ removedKey);
    }
  }
  if (isSummary) {
    mSummaryByGroupKey.put(group,r);
  }
  if (oldIsSummary && (!isSummary || !oldGroup.equals(group))) {
    cancelGroupChildrenLocked(old,callingUid,callingPid,null,REASON_GROUP_SUMMARY_CANCELED);
  }
}
