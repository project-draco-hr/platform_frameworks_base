{
synchronized (mLock) {
    final long timeNow=checkAndGetTimeLocked();
    final long screenOnTime=getScreenOnTimeLocked(timeNow);
    final long deviceUsageTime=screenOnTime - (idle ? mAppIdleDurationMillis : 0) - 5000;
    final UserUsageStatsService service=getUserDataAndInitializeIfNeededLocked(userId,timeNow);
    final long beginIdleTime=service.getBeginIdleTime(packageName);
    final long lastUsedTime=service.getLastUsedTime(packageName);
    final boolean previouslyIdle=hasPassedIdleTimeoutLocked(beginIdleTime,lastUsedTime,screenOnTime,timeNow);
    service.setBeginIdleTime(packageName,deviceUsageTime);
    service.setLastUsedTime(packageName,timeNow - (idle ? DEFAULT_WALLCLOCK_APP_IDLE_THRESHOLD_MILLIS : 0) - 5000);
    if (previouslyIdle != idle) {
      mHandler.sendMessage(mHandler.obtainMessage(MSG_INFORM_LISTENERS,userId,idle ? 1 : 0,packageName));
      mAppIdleHistory.addEntry(packageName,userId,idle,timeNow);
    }
  }
}
