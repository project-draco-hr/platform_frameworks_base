{
  final int appId=getAppId(packageName);
  if (appId < 0)   return;
synchronized (mLock) {
    final long elapsedRealtime=SystemClock.elapsedRealtime();
    final boolean previouslyIdle=isAppIdleFiltered(packageName,appId,userId,elapsedRealtime);
    mAppIdleHistory.setIdleLocked(packageName,userId,idle,elapsedRealtime);
    final boolean stillIdle=isAppIdleFiltered(packageName,appId,userId,elapsedRealtime);
    if (previouslyIdle != stillIdle) {
      mHandler.sendMessage(mHandler.obtainMessage(MSG_INFORM_LISTENERS,userId,stillIdle ? 1 : 0,packageName));
      if (!stillIdle) {
        notifyBatteryStats(packageName,userId,idle);
      }
    }
  }
}
