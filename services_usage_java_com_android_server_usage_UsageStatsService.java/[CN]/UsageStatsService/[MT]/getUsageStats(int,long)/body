{
  if (bucketType < 0 || bucketType >= mCurrentStats.length) {
    return UsageStats.EMPTY_STATS;
  }
  final long timeNow=System.currentTimeMillis();
  if (beginTime > timeNow) {
    return UsageStats.EMPTY_STATS;
  }
synchronized (mLock) {
    if (beginTime >= mCurrentStats[bucketType].mEndTimeStamp) {
      if (DEBUG) {
        Slog.d(TAG,"Requesting stats after " + beginTime + " but latest is "+ mCurrentStats[bucketType].mEndTimeStamp);
      }
      return UsageStats.EMPTY_STATS;
    }
 else     if (beginTime >= mCurrentStats[bucketType].mBeginTimeStamp) {
      if (DEBUG) {
        Slog.d(TAG,"Returning in-memory stats");
      }
      return new UsageStats[]{new UsageStats(mCurrentStats[bucketType])};
    }
 else {
      persistActiveStatsLocked();
    }
  }
  if (DEBUG) {
    Slog.d(TAG,"SELECT * FROM " + bucketType + " WHERE beginTime >= "+ beginTime+ " LIMIT "+ USAGE_STAT_RESULT_LIMIT);
  }
  UsageStats[] results=mDatabase.getUsageStats(bucketType,beginTime,USAGE_STAT_RESULT_LIMIT);
  if (DEBUG) {
    Slog.d(TAG,"Results: " + results.length);
  }
  return results;
}
