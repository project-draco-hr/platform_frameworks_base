{
synchronized (mLock) {
    final long timeNow=checkAndGetTimeLocked();
    convertToSystemTimeLocked(event);
    final UserUsageStatsService service=getUserDataAndInitializeIfNeededLocked(userId,timeNow);
    final long lastUsed=service.getBeginIdleTime(event.mPackage);
    final long screenOnTime=getScreenOnTimeLocked(timeNow);
    final boolean previouslyIdle=hasPassedIdleTimeout(lastUsed,screenOnTime);
    service.reportEvent(event,screenOnTime);
    if ((event.mEventType == Event.MOVE_TO_FOREGROUND || event.mEventType == Event.MOVE_TO_BACKGROUND || event.mEventType == Event.INTERACTION)) {
      if (previouslyIdle) {
        mHandler.sendMessage(mHandler.obtainMessage(MSG_INFORM_LISTENERS,userId,0,event.mPackage));
      }
    }
  }
}
