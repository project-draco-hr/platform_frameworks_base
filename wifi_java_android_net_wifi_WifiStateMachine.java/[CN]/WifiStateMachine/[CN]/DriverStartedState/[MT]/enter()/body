{
  if (DBG)   log(getName() + "\n");
  EventLog.writeEvent(EVENTLOG_WIFI_STATE_CHANGED,getName());
  mIsRunning=true;
  mInDelayedStop=false;
  updateBatteryWorkSource(null);
  mWifiNative.setBluetoothCoexistenceScanMode(mBluetoothConnectionActive);
  setCountryCode();
  setFrequencyBand();
  setNetworkDetailedState(DetailedState.DISCONNECTED);
  mWifiNative.stopFilteringMulticastV6Packets();
  if (mFilteringMulticastV4Packets.get()) {
    mWifiNative.startFilteringMulticastV4Packets();
  }
 else {
    mWifiNative.stopFilteringMulticastV4Packets();
  }
  mWifiNative.setPowerSave(true);
  if (mIsScanMode) {
    mWifiNative.setScanResultHandling(SCAN_ONLY_MODE);
    mWifiNative.disconnect();
    transitionTo(mScanModeState);
  }
 else {
    mWifiNative.setScanResultHandling(CONNECT_MODE);
    mWifiNative.reconnect();
    mWifiNative.status();
    transitionTo(mDisconnectedState);
  }
  if (mScreenBroadcastReceived.get() == false) {
    PowerManager powerManager=(PowerManager)mContext.getSystemService(Context.POWER_SERVICE);
    handleScreenStateChanged(powerManager.isScreenOn());
  }
 else {
    mWifiNative.setSuspendOptimizations(mSuspendOptNeedsDisabled == 0 && mUserWantsSuspendOpt.get());
  }
  if (mP2pSupported)   mWifiP2pChannel.sendMessage(WifiStateMachine.CMD_ENABLE_P2P);
}
