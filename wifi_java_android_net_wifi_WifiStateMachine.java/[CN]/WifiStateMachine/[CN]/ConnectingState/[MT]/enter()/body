{
  if (DBG)   Log.d(TAG,getName() + "\n");
  EventLog.writeEvent(EVENTLOG_WIFI_STATE_CHANGED,getName());
  mUseStaticIp=WifiConfigStore.isUsingStaticIp(mLastNetworkId);
  if (!mUseStaticIp) {
    mDhcpThread=null;
    mModifiedBluetoothCoexistenceMode=false;
    mPowerMode=POWER_MODE_AUTO;
    if (!mBluetoothConnectionActive) {
      mModifiedBluetoothCoexistenceMode=true;
      WifiNative.setBluetoothCoexistenceModeCommand(WifiNative.BLUETOOTH_COEXISTENCE_MODE_DISABLED);
    }
    mPowerMode=WifiNative.getPowerModeCommand();
    if (mPowerMode < 0) {
      mPowerMode=POWER_MODE_AUTO;
    }
    if (mPowerMode != POWER_MODE_ACTIVE) {
      WifiNative.setPowerModeCommand(POWER_MODE_ACTIVE);
    }
    Log.d(TAG,"DHCP request started");
    mDhcpThread=new Thread(new Runnable(){
      public void run(){
        DhcpInfo dhcpInfo=new DhcpInfo();
        if (NetworkUtils.runDhcp(mInterfaceName,dhcpInfo)) {
          Log.d(TAG,"DHCP request succeeded");
synchronized (mDhcpInfo) {
            mDhcpInfo=dhcpInfo;
          }
          sendMessage(CMD_IP_CONFIG_SUCCESS);
        }
 else {
          Log.d(TAG,"DHCP request failed: " + NetworkUtils.getDhcpError());
          sendMessage(CMD_IP_CONFIG_FAILURE);
        }
      }
    }
);
    mDhcpThread.start();
  }
 else {
    DhcpInfo dhcpInfo=WifiConfigStore.getIpConfiguration(mLastNetworkId);
    if (NetworkUtils.configureInterface(mInterfaceName,dhcpInfo)) {
      Log.v(TAG,"Static IP configuration succeeded");
synchronized (mDhcpInfo) {
        mDhcpInfo=dhcpInfo;
      }
      sendMessage(CMD_IP_CONFIG_SUCCESS);
    }
 else {
      Log.v(TAG,"Static IP configuration failed");
      sendMessage(CMD_IP_CONFIG_FAILURE);
    }
  }
}
