{
  if (raster == null) {
    if (cm == null) {
      if (model == null) {
        throw new NullPointerException(Messages.getString("awt.3A"));
      }
      cm=model;
    }
    createRaster();
  }
  if (model == null) {
    model=cm;
  }
  if (cm != model) {
    forceToIntARGB();
  }
  if (cm == model && model.getTransferType() == DataBuffer.TYPE_INT && raster.getNumDataElements() == 1) {
    DataBufferInt dbi=(DataBufferInt)raster.getDataBuffer();
    int data[]=dbi.getData();
    int scanline=raster.getWidth();
    int rof=dbi.getOffset() + y * scanline + x;
    for (int lineOff=off, line=y; line < y + h; line++, lineOff+=scansize, rof+=scanline) {
      System.arraycopy(pixels,lineOff,data,rof,w);
    }
  }
 else   if (isIntRGB) {
    int buff[]=new int[w];
    DataBufferInt dbi=(DataBufferInt)raster.getDataBuffer();
    int data[]=dbi.getData();
    int scanline=raster.getWidth();
    int rof=dbi.getOffset() + y * scanline + x;
    for (int sy=y, sOff=off; sy < y + h; sy++, sOff+=scansize, rof+=scanline) {
      for (int sx=x, idx=0; sx < x + w; sx++, idx++) {
        buff[idx]=model.getRGB(pixels[sOff + idx]);
      }
      System.arraycopy(buff,0,data,rof,w);
    }
  }
 else {
    Object buf=null;
    for (int sy=y, sOff=off; sy < y + h; sy++, sOff+=scansize) {
      for (int sx=x, idx=0; sx < x + w; sx++, idx++) {
        int rgb=model.getRGB(pixels[sOff + idx]);
        buf=cm.getDataElements(rgb,buf);
        raster.setDataElements(sx,sy,buf);
      }
    }
  }
  if (imageSurf != null) {
    imageSurf.invalidate();
  }
  imageUpdate(this,ImageObserver.SOMEBITS,0,0,width,height);
}
