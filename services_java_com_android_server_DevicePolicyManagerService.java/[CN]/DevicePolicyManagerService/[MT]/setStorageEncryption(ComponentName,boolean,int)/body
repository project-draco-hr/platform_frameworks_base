{
  enforceCrossUserPermission(userHandle);
synchronized (this) {
    if (who == null) {
      throw new NullPointerException("ComponentName is null");
    }
    if (userHandle != UserHandle.USER_OWNER || UserHandle.getCallingUserId() != UserHandle.USER_OWNER) {
      Slog.w(TAG,"Only owner is allowed to set storage encryption. User " + UserHandle.getCallingUserId() + " is not permitted.");
      return 0;
    }
    ActiveAdmin ap=getActiveAdminForCallerLocked(who,DeviceAdminInfo.USES_ENCRYPTED_STORAGE);
    if (!isEncryptionSupported()) {
      return DevicePolicyManager.ENCRYPTION_STATUS_UNSUPPORTED;
    }
    if (ap.encryptionRequested != encrypt) {
      ap.encryptionRequested=encrypt;
      saveSettingsLocked(userHandle);
    }
    DevicePolicyData policy=getUserData(UserHandle.USER_OWNER);
    boolean newRequested=false;
    final int N=policy.mAdminList.size();
    for (int i=0; i < N; i++) {
      newRequested|=policy.mAdminList.get(i).encryptionRequested;
    }
    setEncryptionRequested(newRequested);
    return newRequested ? DevicePolicyManager.ENCRYPTION_STATUS_ACTIVE : DevicePolicyManager.ENCRYPTION_STATUS_INACTIVE;
  }
}
