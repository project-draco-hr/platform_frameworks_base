{
  int[] ifdOffsets=new int[EXIF_TAGS.length];
  int[] ifdDataSizes=new int[EXIF_TAGS.length];
  for (  ExifTag tag : IFD_POINTER_TAGS) {
    removeAttribute(tag.name);
  }
  removeAttribute(JPEG_INTERCHANGE_FORMAT_TAG.name);
  removeAttribute(JPEG_INTERCHANGE_FORMAT_LENGTH_TAG.name);
  for (int hint=0; hint < EXIF_TAGS.length; ++hint) {
    for (    Object obj : mAttributes[hint].entrySet().toArray()) {
      Map.Entry entry=(Map.Entry)obj;
      if (entry.getValue() == null) {
        mAttributes[hint].remove(entry.getKey());
      }
    }
  }
  if (!mAttributes[IFD_INTEROPERABILITY_HINT].isEmpty()) {
    mAttributes[IFD_EXIF_HINT].put(IFD_POINTER_TAGS[2].name,"0");
  }
  if (!mAttributes[IFD_EXIF_HINT].isEmpty()) {
    mAttributes[IFD_TIFF_HINT].put(IFD_POINTER_TAGS[0].name,"0");
  }
  if (!mAttributes[IFD_GPS_HINT].isEmpty()) {
    mAttributes[IFD_TIFF_HINT].put(IFD_POINTER_TAGS[1].name,"0");
  }
  if (mHasThumbnail) {
    mAttributes[IFD_TIFF_HINT].put(JPEG_INTERCHANGE_FORMAT_TAG.name,"0");
    mAttributes[IFD_TIFF_HINT].put(JPEG_INTERCHANGE_FORMAT_LENGTH_TAG.name,String.valueOf(mThumbnailLength));
  }
  for (int i=0; i < 5; ++i) {
    int sum=0;
    for (    Map.Entry entry : (Set<Map.Entry>)mAttributes[i].entrySet()) {
      String entryValue=(String)((Map.Entry)entry).getValue();
      int dataFormat=getDataFormatOfExifEntryValue(entryValue);
      int size=getSizeOfExifEntryValue(dataFormat,entryValue);
      if (size > 4) {
        sum+=size;
      }
    }
    ifdDataSizes[i]+=sum;
  }
  int position=8;
  for (int hint=0; hint < EXIF_TAGS.length; ++hint) {
    if (!mAttributes[hint].isEmpty()) {
      ifdOffsets[hint]=position;
      position+=2 + mAttributes[hint].size() * 12 + 4 + ifdDataSizes[hint];
    }
  }
  if (mHasThumbnail) {
    int thumbnailOffset=position;
    mAttributes[IFD_TIFF_HINT].put(JPEG_INTERCHANGE_FORMAT_TAG.name,String.valueOf(thumbnailOffset));
    mAttributes[IFD_TIFF_HINT].put(JPEG_INTERCHANGE_FORMAT_LENGTH_TAG.name,String.valueOf(mThumbnailLength));
    mThumbnailOffset=exifOffsetFromBeginning + thumbnailOffset;
    position+=mThumbnailLength;
  }
  int totalSize=position + 8;
  if (DEBUG) {
    Log.d(TAG,"totalSize length: " + totalSize);
    for (int i=0; i < 5; ++i) {
      Log.d(TAG,String.format("index: %d, offsets: %d, tag count: %d, data sizes: %d",i,ifdOffsets[i],mAttributes[i].size(),ifdDataSizes[i]));
    }
  }
  if (!mAttributes[IFD_EXIF_HINT].isEmpty()) {
    mAttributes[IFD_TIFF_HINT].put(IFD_POINTER_TAGS[0].name,String.valueOf(ifdOffsets[IFD_EXIF_HINT]));
  }
  if (!mAttributes[IFD_GPS_HINT].isEmpty()) {
    mAttributes[IFD_TIFF_HINT].put(IFD_POINTER_TAGS[1].name,String.valueOf(ifdOffsets[IFD_GPS_HINT]));
  }
  if (!mAttributes[IFD_INTEROPERABILITY_HINT].isEmpty()) {
    mAttributes[IFD_EXIF_HINT].put(IFD_POINTER_TAGS[2].name,String.valueOf(ifdOffsets[IFD_INTEROPERABILITY_HINT]));
  }
  dataOutputStream.writeUnsignedShort(totalSize);
  dataOutputStream.write(IDENTIFIER_EXIF_APP1);
  dataOutputStream.writeShort(BYTE_ALIGN_MM);
  dataOutputStream.writeUnsignedShort(0x2a);
  dataOutputStream.writeUnsignedInt(8);
  for (int hint=0; hint < EXIF_TAGS.length; ++hint) {
    if (!mAttributes[hint].isEmpty()) {
      dataOutputStream.writeUnsignedShort(mAttributes[hint].size());
      int dataOffset=ifdOffsets[hint] + 2 + mAttributes[hint].size() * 12 + 4;
      for (      Map.Entry entry : (Set<Map.Entry>)mAttributes[hint].entrySet()) {
        int tagNumber=(int)sExifTagMapsForWriting[hint].get(entry.getKey());
        String entryValue=(String)entry.getValue();
        int dataFormat=getDataFormatOfExifEntryValue(entryValue);
        int numberOfComponents=getNumberOfComponentsInExifEntryValue(dataFormat,entryValue);
        int byteCount=getSizeOfExifEntryValue(dataFormat,entryValue);
        dataOutputStream.writeUnsignedShort(tagNumber);
        dataOutputStream.writeUnsignedShort(dataFormat);
        dataOutputStream.writeInt(numberOfComponents);
        if (byteCount > 4) {
          dataOutputStream.writeUnsignedInt(dataOffset);
          dataOffset+=byteCount;
        }
 else {
          int bytesWritten=writeExifEntryValue(dataOutputStream,entryValue);
          if (bytesWritten < 4) {
            for (int i=bytesWritten; i < 4; ++i) {
              dataOutputStream.write(0);
            }
          }
        }
      }
      if (hint == 0 && !mAttributes[IFD_THUMBNAIL_HINT].isEmpty()) {
        dataOutputStream.writeUnsignedInt(ifdOffsets[IFD_THUMBNAIL_HINT]);
      }
 else {
        dataOutputStream.writeUnsignedInt(0);
      }
      for (      Map.Entry entry : (Set<Map.Entry>)mAttributes[hint].entrySet()) {
        String entryValue=(String)entry.getValue();
        int dataFormat=getDataFormatOfExifEntryValue(entryValue);
        int byteCount=getSizeOfExifEntryValue(dataFormat,entryValue);
        if (byteCount > 4) {
          writeExifEntryValue(dataOutputStream,entryValue);
        }
      }
    }
  }
  if (mHasThumbnail) {
    dataOutputStream.write(getThumbnail());
  }
  return totalSize;
}
