{
  ArrayList<Object> profiles=new ArrayList<Object>(10);
  ArrayList<Object> sequence=new ArrayList<Object>(10);
  ICC_Profile xyzProfile=ICC_Profile.getInstance(ColorSpace.CS_CIEXYZ);
  Object conversionFirst=null, conversionLast=null;
  int conversionLength=conversionSequence.length;
  if (conversionLength > 0) {
    conversionFirst=conversionSequence[0];
    conversionLast=conversionSequence[conversionLength - 1];
  }
  boolean iccSequenceStarted=false;
  if (src != conversionFirst && src != null) {
    if (src instanceof ICC_Profile) {
      profiles.add(src);
      iccSequenceStarted=true;
    }
 else {
      profiles.add(xyzProfile);
      sequence.add(src);
    }
  }
 else {
    profiles.add(xyzProfile);
  }
  for (int i=0; i < conversionLength; i++) {
    if (conversionSequence[i] instanceof ICC_Profile) {
      profiles.add(conversionSequence[i]);
      iccSequenceStarted=true;
    }
 else     if (iccSequenceStarted) {
      profiles.add(xyzProfile);
      Object prev=profiles.get(0);
      for (int k=1; k < profiles.size(); k++) {
        if (prev == profiles.get(k)) {
          k--;
          profiles.remove(k);
        }
        prev=profiles.get(k);
      }
      if (profiles.size() > 1) {
        sequence.add(new ICC_Transform(profiles.toArray(new ICC_Profile[0])));
        sequence.add(conversionSequence[i]);
      }
      profiles.clear();
      profiles.add(xyzProfile);
      iccSequenceStarted=false;
    }
 else {
      sequence.add(conversionSequence[i]);
    }
  }
  if (dst != conversionLast && dst != null) {
    if (dst instanceof ICC_Profile) {
      profiles.add(dst);
      iccSequenceStarted=true;
    }
 else     if (iccSequenceStarted) {
      profiles.add(xyzProfile);
    }
 else {
      sequence.add(dst);
    }
  }
  if (iccSequenceStarted) {
    sequence.add(new ICC_Transform(profiles.toArray(new ICC_Profile[0])));
    if (dst != null && !(dst instanceof ICC_Profile)) {
      sequence.add(dst);
    }
  }
  maxComponents=0;
  Object o;
  for (int i=0, size=sequence.size(); i < size; i++) {
    o=sequence.get(i);
    if (o instanceof ICC_Transform) {
      ICC_Transform t=(ICC_Transform)o;
      maxComponents=(maxComponents > t.getNumInputChannels() + 1) ? maxComponents : t.getNumInputChannels() + 1;
      maxComponents=(maxComponents > t.getNumOutputChannels() + 1) ? maxComponents : t.getNumOutputChannels() + 1;
    }
 else {
      ColorSpace cs=(ColorSpace)o;
      maxComponents=(maxComponents > cs.getNumComponents() + 1) ? maxComponents : cs.getNumComponents() + 1;
    }
  }
  return sequence.toArray();
}
