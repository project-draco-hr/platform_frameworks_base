{
  try {
    boolean enabled;
synchronized (this) {
      enabled=mFlashlightEnabled && !forceDisable;
    }
    if (enabled) {
      if (mCameraDevice == null) {
        startDevice();
        return;
      }
      if (mSession == null) {
        startSession();
        return;
      }
      if (mFlashlightRequest == null) {
        CaptureRequest.Builder builder=mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);
        builder.set(CaptureRequest.FLASH_MODE,CameraMetadata.FLASH_MODE_TORCH);
        builder.addTarget(mSurface);
        CaptureRequest request=builder.build();
        mSession.capture(request,null,mHandler);
        mFlashlightRequest=request;
      }
    }
 else {
      if (mCameraDevice != null) {
        mCameraDevice.close();
        teardown();
      }
    }
  }
 catch (  CameraAccessException|IllegalStateException|UnsupportedOperationException e) {
    Log.e(TAG,"Error in updateFlashlight",e);
    handleError();
  }
}
