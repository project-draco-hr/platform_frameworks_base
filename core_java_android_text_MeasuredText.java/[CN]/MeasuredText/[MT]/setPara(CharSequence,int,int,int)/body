{
  mText=text;
  mTextStart=start;
  int len=end - start;
  mLen=len;
  mPos=0;
  if (mWidths == null || mWidths.length < len) {
    mWidths=new float[ArrayUtils.idealFloatArraySize(len)];
  }
  if (mChars == null || mChars.length < len) {
    mChars=new char[ArrayUtils.idealCharArraySize(len)];
  }
  TextUtils.getChars(text,start,end,mChars,0);
  if (text instanceof Spanned) {
    Spanned spanned=(Spanned)text;
    ReplacementSpan[] spans=spanned.getSpans(start,end,ReplacementSpan.class);
    for (int i=0; i < spans.length; i++) {
      int startInPara=spanned.getSpanStart(spans[i]) - start;
      int endInPara=spanned.getSpanEnd(spans[i]) - start;
      for (int j=startInPara; j < endInPara; j++) {
        mChars[j]='\uFFFC';
      }
    }
  }
  if (TextUtils.doesNotNeedBidi(mChars,0,len)) {
    mDir=Layout.DIR_LEFT_TO_RIGHT;
    mEasy=true;
  }
 else {
    if (mLevels == null || mLevels.length < len) {
      mLevels=new byte[ArrayUtils.idealByteArraySize(len)];
    }
    mDir=AndroidBidi.bidi(bidiRequest,mChars,mLevels,len,false);
    mEasy=false;
  }
}
