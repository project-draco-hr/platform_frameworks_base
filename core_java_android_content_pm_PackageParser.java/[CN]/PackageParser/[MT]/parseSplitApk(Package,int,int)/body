{
  final String apkPath=pkg.splitCodePaths[splitIndex];
  final File apkFile=new File(apkPath);
  mParseError=PackageManager.INSTALL_SUCCEEDED;
  mArchiveSourcePath=apkPath;
  if ((flags & PARSE_MUST_BE_APK) != 0 && !isApkFile(apkFile)) {
    throw new PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,"Invalid package file: " + apkPath);
  }
  if (DEBUG_JAR)   Slog.d(TAG,"Scanning split APK: " + apkPath);
  AssetManager assets=null;
  Resources res=null;
  XmlResourceParser parser=null;
  try {
    assets=new AssetManager();
    int cookie=assets.addAssetPath(apkPath);
    if (cookie == 0) {
      throw new PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,"Failed adding asset path: " + apkPath);
    }
    res=new Resources(assets,mMetrics,null);
    assets.setConfiguration(0,0,null,0,0,0,0,0,0,0,0,0,0,0,0,0,Build.VERSION.RESOURCES_SDK_INT);
    parser=assets.openXmlResourceParser(cookie,ANDROID_MANIFEST_FILENAME);
    final String[] outError=new String[1];
    pkg=parseSplitApk(pkg,res,parser,flags,splitIndex,outError);
    if (pkg == null) {
      throw new PackageParserException(mParseError,apkPath + " (at " + parser.getPositionDescription()+ "): "+ outError[0]);
    }
  }
 catch (  PackageParserException e) {
    throw e;
  }
catch (  Exception e) {
    throw new PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,"Unable to read AndroidManifest.xml of " + apkPath);
  }
 finally {
    IoUtils.closeQuietly(parser);
    IoUtils.closeQuietly(assets);
  }
}
