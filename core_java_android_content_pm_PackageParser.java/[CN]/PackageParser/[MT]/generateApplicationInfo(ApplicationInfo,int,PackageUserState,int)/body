{
  if (ai == null)   return null;
  if (!checkUseInstalledOrHidden(flags,state)) {
    return null;
  }
  ai=new ApplicationInfo(ai);
  if (userId != 0) {
    ai.uid=UserHandle.getUid(userId,ai.uid);
    ai.dataDir=PackageManager.getDataDirForUser(userId,ai.packageName);
  }
  if (state.stopped) {
    ai.flags|=ApplicationInfo.FLAG_STOPPED;
  }
 else {
    ai.flags&=~ApplicationInfo.FLAG_STOPPED;
  }
  updateApplicationInfo(ai,flags,state);
  return ai;
}
