{
  final boolean isActivity=(mContext instanceof Activity);
  if (mKeyguardHost != null) {
    mKeyguardHost.saveHierarchyState(mStateContainer);
  }
  if (mKeyguardHost == null) {
    if (DEBUG)     Log.d(TAG,"keyguard host is null, creating it...");
    mKeyguardHost=new ViewManagerHost(mContext);
    int flags=WindowManager.LayoutParams.FLAG_FORCE_NOT_FULLSCREEN | WindowManager.LayoutParams.FLAG_SHOW_WALLPAPER;
    if (!mNeedsInput) {
      flags|=WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM;
    }
    if (ActivityManager.isHighEndGfx()) {
      flags|=WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;
    }
    final int stretch=ViewGroup.LayoutParams.MATCH_PARENT;
    final int type=isActivity ? WindowManager.LayoutParams.TYPE_APPLICATION : WindowManager.LayoutParams.TYPE_KEYGUARD;
    WindowManager.LayoutParams lp=new WindowManager.LayoutParams(stretch,stretch,type,flags,PixelFormat.TRANSLUCENT);
    lp.softInputMode=WindowManager.LayoutParams.SOFT_INPUT_ADJUST_RESIZE;
    lp.windowAnimations=com.android.internal.R.style.Animation_LockScreen;
    if (ActivityManager.isHighEndGfx()) {
      lp.flags|=WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;
      lp.privateFlags|=WindowManager.LayoutParams.PRIVATE_FLAG_FORCE_HARDWARE_ACCELERATED;
    }
    lp.privateFlags|=WindowManager.LayoutParams.PRIVATE_FLAG_SET_NEEDS_MENU_KEY;
    lp.inputFeatures|=WindowManager.LayoutParams.INPUT_FEATURE_DISABLE_USER_ACTIVITY;
    lp.userActivityTimeout=KeyguardViewMediator.AWAKE_INTERVAL_DEFAULT_MS;
    lp.setTitle(isActivity ? "KeyguardMock" : "Keyguard");
    mWindowLayoutParams=lp;
    mViewManager.addView(mKeyguardHost,lp);
  }
  inflateKeyguardView(options);
  mViewManager.updateViewLayout(mKeyguardHost,mWindowLayoutParams);
  mKeyguardHost.restoreHierarchyState(mStateContainer);
}
