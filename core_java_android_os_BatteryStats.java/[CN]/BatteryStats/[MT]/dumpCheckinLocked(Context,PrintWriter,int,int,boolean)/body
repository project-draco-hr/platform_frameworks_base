{
  final long rawUptime=SystemClock.uptimeMillis() * 1000;
  final long rawRealtime=SystemClock.elapsedRealtime() * 1000;
  final long batteryUptime=getBatteryUptime(rawUptime);
  final long whichBatteryUptime=computeBatteryUptime(rawUptime,which);
  final long whichBatteryRealtime=computeBatteryRealtime(rawRealtime,which);
  final long whichBatteryScreenOffUptime=computeBatteryScreenOffUptime(rawUptime,which);
  final long whichBatteryScreenOffRealtime=computeBatteryScreenOffRealtime(rawRealtime,which);
  final long totalRealtime=computeRealtime(rawRealtime,which);
  final long totalUptime=computeUptime(rawUptime,which);
  final long screenOnTime=getScreenOnTime(rawRealtime,which);
  final long interactiveTime=getInteractiveTime(rawRealtime,which);
  final long lowPowerModeEnabledTime=getLowPowerModeEnabledTime(rawRealtime,which);
  final long phoneOnTime=getPhoneOnTime(rawRealtime,which);
  final long wifiOnTime=getWifiOnTime(rawRealtime,which);
  final long wifiRunningTime=getGlobalWifiRunningTime(rawRealtime,which);
  final long bluetoothOnTime=getBluetoothOnTime(rawRealtime,which);
  StringBuilder sb=new StringBuilder(128);
  SparseArray<? extends Uid> uidStats=getUidStats();
  final int NU=uidStats.size();
  String category=STAT_NAMES[which];
  dumpLine(pw,0,category,BATTERY_DATA,which == STATS_SINCE_CHARGED ? getStartCount() : "N/A",whichBatteryRealtime / 1000,whichBatteryUptime / 1000,totalRealtime / 1000,totalUptime / 1000,getStartClockTime(),whichBatteryScreenOffRealtime / 1000,whichBatteryScreenOffUptime / 1000);
  long fullWakeLockTimeTotal=0;
  long partialWakeLockTimeTotal=0;
  for (int iu=0; iu < NU; iu++) {
    Uid u=uidStats.valueAt(iu);
    Map<String,? extends BatteryStats.Uid.Wakelock> wakelocks=u.getWakelockStats();
    if (wakelocks.size() > 0) {
      for (      Map.Entry<String,? extends BatteryStats.Uid.Wakelock> ent : wakelocks.entrySet()) {
        Uid.Wakelock wl=ent.getValue();
        Timer fullWakeTimer=wl.getWakeTime(WAKE_TYPE_FULL);
        if (fullWakeTimer != null) {
          fullWakeLockTimeTotal+=fullWakeTimer.getTotalTimeLocked(rawRealtime,which);
        }
        Timer partialWakeTimer=wl.getWakeTime(WAKE_TYPE_PARTIAL);
        if (partialWakeTimer != null) {
          partialWakeLockTimeTotal+=partialWakeTimer.getTotalTimeLocked(rawRealtime,which);
        }
      }
    }
  }
  long mobileRxTotalBytes=getNetworkActivityBytes(NETWORK_MOBILE_RX_DATA,which);
  long mobileTxTotalBytes=getNetworkActivityBytes(NETWORK_MOBILE_TX_DATA,which);
  long wifiRxTotalBytes=getNetworkActivityBytes(NETWORK_WIFI_RX_DATA,which);
  long wifiTxTotalBytes=getNetworkActivityBytes(NETWORK_WIFI_TX_DATA,which);
  long mobileRxTotalPackets=getNetworkActivityPackets(NETWORK_MOBILE_RX_DATA,which);
  long mobileTxTotalPackets=getNetworkActivityPackets(NETWORK_MOBILE_TX_DATA,which);
  long wifiRxTotalPackets=getNetworkActivityPackets(NETWORK_WIFI_RX_DATA,which);
  long wifiTxTotalPackets=getNetworkActivityPackets(NETWORK_WIFI_TX_DATA,which);
  dumpLine(pw,0,category,GLOBAL_NETWORK_DATA,mobileRxTotalBytes,mobileTxTotalBytes,wifiRxTotalBytes,wifiTxTotalBytes,mobileRxTotalPackets,mobileTxTotalPackets,wifiRxTotalPackets,wifiTxTotalPackets);
  dumpLine(pw,0,category,MISC_DATA,screenOnTime / 1000,phoneOnTime / 1000,wifiOnTime / 1000,wifiRunningTime / 1000,bluetoothOnTime / 1000,mobileRxTotalBytes,mobileTxTotalBytes,wifiRxTotalBytes,wifiTxTotalBytes,fullWakeLockTimeTotal / 1000,partialWakeLockTimeTotal / 1000,0,getMobileRadioActiveTime(rawRealtime,which) / 1000,getMobileRadioActiveAdjustedTime(which) / 1000,interactiveTime / 1000,lowPowerModeEnabledTime / 1000);
  Object[] args=new Object[NUM_SCREEN_BRIGHTNESS_BINS];
  for (int i=0; i < NUM_SCREEN_BRIGHTNESS_BINS; i++) {
    args[i]=getScreenBrightnessTime(i,rawRealtime,which) / 1000;
  }
  dumpLine(pw,0,category,SCREEN_BRIGHTNESS_DATA,args);
  args=new Object[SignalStrength.NUM_SIGNAL_STRENGTH_BINS];
  for (int i=0; i < SignalStrength.NUM_SIGNAL_STRENGTH_BINS; i++) {
    args[i]=getPhoneSignalStrengthTime(i,rawRealtime,which) / 1000;
  }
  dumpLine(pw,0,category,SIGNAL_STRENGTH_TIME_DATA,args);
  dumpLine(pw,0,category,SIGNAL_SCANNING_TIME_DATA,getPhoneSignalScanningTime(rawRealtime,which) / 1000);
  for (int i=0; i < SignalStrength.NUM_SIGNAL_STRENGTH_BINS; i++) {
    args[i]=getPhoneSignalStrengthCount(i,which);
  }
  dumpLine(pw,0,category,SIGNAL_STRENGTH_COUNT_DATA,args);
  args=new Object[NUM_DATA_CONNECTION_TYPES];
  for (int i=0; i < NUM_DATA_CONNECTION_TYPES; i++) {
    args[i]=getPhoneDataConnectionTime(i,rawRealtime,which) / 1000;
  }
  dumpLine(pw,0,category,DATA_CONNECTION_TIME_DATA,args);
  for (int i=0; i < NUM_DATA_CONNECTION_TYPES; i++) {
    args[i]=getPhoneDataConnectionCount(i,which);
  }
  dumpLine(pw,0,category,DATA_CONNECTION_COUNT_DATA,args);
  args=new Object[NUM_WIFI_STATES];
  for (int i=0; i < NUM_WIFI_STATES; i++) {
    args[i]=getWifiStateTime(i,rawRealtime,which) / 1000;
  }
  dumpLine(pw,0,category,WIFI_STATE_TIME_DATA,args);
  for (int i=0; i < NUM_WIFI_STATES; i++) {
    args[i]=getWifiStateCount(i,which);
  }
  dumpLine(pw,0,category,WIFI_STATE_COUNT_DATA,args);
  args=new Object[NUM_WIFI_SUPPL_STATES];
  for (int i=0; i < NUM_WIFI_SUPPL_STATES; i++) {
    args[i]=getWifiSupplStateTime(i,rawRealtime,which) / 1000;
  }
  dumpLine(pw,0,category,WIFI_SUPPL_STATE_TIME_DATA,args);
  for (int i=0; i < NUM_WIFI_SUPPL_STATES; i++) {
    args[i]=getWifiSupplStateCount(i,which);
  }
  dumpLine(pw,0,category,WIFI_SUPPL_STATE_COUNT_DATA,args);
  args=new Object[NUM_WIFI_SIGNAL_STRENGTH_BINS];
  for (int i=0; i < NUM_WIFI_SIGNAL_STRENGTH_BINS; i++) {
    args[i]=getWifiSignalStrengthTime(i,rawRealtime,which) / 1000;
  }
  dumpLine(pw,0,category,WIFI_SIGNAL_STRENGTH_TIME_DATA,args);
  for (int i=0; i < NUM_WIFI_SIGNAL_STRENGTH_BINS; i++) {
    args[i]=getWifiSignalStrengthCount(i,which);
  }
  dumpLine(pw,0,category,WIFI_SIGNAL_STRENGTH_COUNT_DATA,args);
  args=new Object[NUM_BLUETOOTH_STATES];
  for (int i=0; i < NUM_BLUETOOTH_STATES; i++) {
    args[i]=getBluetoothStateTime(i,rawRealtime,which) / 1000;
  }
  dumpLine(pw,0,category,BLUETOOTH_STATE_TIME_DATA,args);
  for (int i=0; i < NUM_BLUETOOTH_STATES; i++) {
    args[i]=getBluetoothStateCount(i,which);
  }
  dumpLine(pw,0,category,BLUETOOTH_STATE_COUNT_DATA,args);
  if (which == STATS_SINCE_UNPLUGGED) {
    dumpLine(pw,0,category,BATTERY_LEVEL_DATA,getDischargeStartLevel(),getDischargeCurrentLevel());
  }
  if (which == STATS_SINCE_UNPLUGGED) {
    dumpLine(pw,0,category,BATTERY_DISCHARGE_DATA,getDischargeStartLevel() - getDischargeCurrentLevel(),getDischargeStartLevel() - getDischargeCurrentLevel(),getDischargeAmountScreenOn(),getDischargeAmountScreenOff());
  }
 else {
    dumpLine(pw,0,category,BATTERY_DISCHARGE_DATA,getLowDischargeAmountSinceCharge(),getHighDischargeAmountSinceCharge(),getDischargeAmountScreenOnSinceCharge(),getDischargeAmountScreenOffSinceCharge());
  }
  if (reqUid < 0) {
    Map<String,? extends Timer> kernelWakelocks=getKernelWakelockStats();
    if (kernelWakelocks.size() > 0) {
      for (      Map.Entry<String,? extends Timer> ent : kernelWakelocks.entrySet()) {
        sb.setLength(0);
        printWakeLockCheckin(sb,ent.getValue(),rawRealtime,null,which,"");
        dumpLine(pw,0,category,KERNEL_WAKELOCK_DATA,ent.getKey(),sb.toString());
      }
    }
    Map<String,? extends Timer> wakeupReasons=getWakeupReasonStats();
    if (wakeupReasons.size() > 0) {
      for (      Map.Entry<String,? extends Timer> ent : wakeupReasons.entrySet()) {
        long totalTimeMicros=ent.getValue().getTotalTimeLocked(rawRealtime,which);
        int count=ent.getValue().getCountLocked(which);
        dumpLine(pw,0,category,WAKEUP_REASON_DATA,"\"" + ent.getKey() + "\"",(totalTimeMicros + 500) / 1000,count);
      }
    }
  }
  BatteryStatsHelper helper=new BatteryStatsHelper(context,false,wifiOnly);
  helper.create(this);
  helper.refreshStats(which,UserHandle.USER_ALL);
  List<BatterySipper> sippers=helper.getUsageList();
  if (sippers != null && sippers.size() > 0) {
    dumpLine(pw,0,category,POWER_USE_SUMMARY_DATA,BatteryStatsHelper.makemAh(helper.getPowerProfile().getBatteryCapacity()),BatteryStatsHelper.makemAh(helper.getComputedPower()),BatteryStatsHelper.makemAh(helper.getMinDrainedPower()),BatteryStatsHelper.makemAh(helper.getMaxDrainedPower()));
    for (int i=0; i < sippers.size(); i++) {
      BatterySipper bs=sippers.get(i);
      int uid=0;
      String label;
switch (bs.drainType) {
case IDLE:
        label="idle";
      break;
case CELL:
    label="cell";
  break;
case PHONE:
label="phone";
break;
case WIFI:
label="wifi";
break;
case BLUETOOTH:
label="blue";
break;
case SCREEN:
label="scrn";
break;
case FLASHLIGHT:
label="flashlight";
break;
case APP:
uid=bs.uidObj.getUid();
label="uid";
break;
case USER:
uid=UserHandle.getUid(bs.userId,0);
label="user";
break;
case UNACCOUNTED:
label="unacc";
break;
case OVERCOUNTED:
label="over";
break;
default :
label="???";
}
dumpLine(pw,uid,category,POWER_USE_ITEM_DATA,label,BatteryStatsHelper.makemAh(bs.value));
}
}
for (int iu=0; iu < NU; iu++) {
final int uid=uidStats.keyAt(iu);
if (reqUid >= 0 && uid != reqUid) {
continue;
}
Uid u=uidStats.valueAt(iu);
long mobileBytesRx=u.getNetworkActivityBytes(NETWORK_MOBILE_RX_DATA,which);
long mobileBytesTx=u.getNetworkActivityBytes(NETWORK_MOBILE_TX_DATA,which);
long wifiBytesRx=u.getNetworkActivityBytes(NETWORK_WIFI_RX_DATA,which);
long wifiBytesTx=u.getNetworkActivityBytes(NETWORK_WIFI_TX_DATA,which);
long mobilePacketsRx=u.getNetworkActivityPackets(NETWORK_MOBILE_RX_DATA,which);
long mobilePacketsTx=u.getNetworkActivityPackets(NETWORK_MOBILE_TX_DATA,which);
long mobileActiveTime=u.getMobileRadioActiveTime(which);
int mobileActiveCount=u.getMobileRadioActiveCount(which);
long wifiPacketsRx=u.getNetworkActivityPackets(NETWORK_WIFI_RX_DATA,which);
long wifiPacketsTx=u.getNetworkActivityPackets(NETWORK_WIFI_TX_DATA,which);
long fullWifiLockOnTime=u.getFullWifiLockTime(rawRealtime,which);
long wifiScanTime=u.getWifiScanTime(rawRealtime,which);
long uidWifiRunningTime=u.getWifiRunningTime(rawRealtime,which);
if (mobileBytesRx > 0 || mobileBytesTx > 0 || wifiBytesRx > 0 || wifiBytesTx > 0 || mobilePacketsRx > 0 || mobilePacketsTx > 0 || wifiPacketsRx > 0 || wifiPacketsTx > 0 || mobileActiveTime > 0 || mobileActiveCount > 0) {
dumpLine(pw,uid,category,NETWORK_DATA,mobileBytesRx,mobileBytesTx,wifiBytesRx,wifiBytesTx,mobilePacketsRx,mobilePacketsTx,wifiPacketsRx,wifiPacketsTx,mobileActiveTime,mobileActiveCount);
}
if (fullWifiLockOnTime != 0 || wifiScanTime != 0 || uidWifiRunningTime != 0) {
dumpLine(pw,uid,category,WIFI_DATA,fullWifiLockOnTime,wifiScanTime,uidWifiRunningTime);
}
if (u.hasUserActivity()) {
args=new Object[Uid.NUM_USER_ACTIVITY_TYPES];
boolean hasData=false;
for (int i=0; i < Uid.NUM_USER_ACTIVITY_TYPES; i++) {
int val=u.getUserActivityCount(i,which);
args[i]=val;
if (val != 0) hasData=true;
}
if (hasData) {
dumpLine(pw,uid,category,USER_ACTIVITY_DATA,args);
}
}
Map<String,? extends Uid.Wakelock> wakelocks=u.getWakelockStats();
if (wakelocks.size() > 0) {
for (Map.Entry<String,? extends Uid.Wakelock> ent : wakelocks.entrySet()) {
Uid.Wakelock wl=ent.getValue();
String linePrefix="";
sb.setLength(0);
linePrefix=printWakeLockCheckin(sb,wl.getWakeTime(WAKE_TYPE_FULL),rawRealtime,"f",which,linePrefix);
linePrefix=printWakeLockCheckin(sb,wl.getWakeTime(WAKE_TYPE_PARTIAL),rawRealtime,"p",which,linePrefix);
linePrefix=printWakeLockCheckin(sb,wl.getWakeTime(WAKE_TYPE_WINDOW),rawRealtime,"w",which,linePrefix);
if (sb.length() > 0) {
String name=ent.getKey();
if (name.indexOf(',') >= 0) {
name=name.replace(',','_');
}
dumpLine(pw,uid,category,WAKELOCK_DATA,name,sb.toString());
}
}
}
Map<String,? extends Timer> syncs=u.getSyncStats();
if (syncs.size() > 0) {
for (Map.Entry<String,? extends Timer> ent : syncs.entrySet()) {
Timer timer=ent.getValue();
long totalTime=(timer.getTotalTimeLocked(rawRealtime,which) + 500) / 1000;
int count=timer.getCountLocked(which);
if (totalTime != 0) {
dumpLine(pw,uid,category,SYNC_DATA,ent.getKey(),totalTime,count);
}
}
}
Map<String,? extends Timer> jobs=u.getJobStats();
if (jobs.size() > 0) {
for (Map.Entry<String,? extends Timer> ent : jobs.entrySet()) {
Timer timer=ent.getValue();
long totalTime=(timer.getTotalTimeLocked(rawRealtime,which) + 500) / 1000;
int count=timer.getCountLocked(which);
if (totalTime != 0) {
dumpLine(pw,uid,category,JOB_DATA,ent.getKey(),totalTime,count);
}
}
}
SparseArray<? extends BatteryStats.Uid.Sensor> sensors=u.getSensorStats();
int NSE=sensors.size();
for (int ise=0; ise < NSE; ise++) {
Uid.Sensor se=sensors.valueAt(ise);
int sensorNumber=sensors.keyAt(ise);
Timer timer=se.getSensorTime();
if (timer != null) {
long totalTime=(timer.getTotalTimeLocked(rawRealtime,which) + 500) / 1000;
int count=timer.getCountLocked(which);
if (totalTime != 0) {
dumpLine(pw,uid,category,SENSOR_DATA,sensorNumber,totalTime,count);
}
}
}
Timer vibTimer=u.getVibratorOnTimer();
if (vibTimer != null) {
long totalTime=(vibTimer.getTotalTimeLocked(rawRealtime,which) + 500) / 1000;
int count=vibTimer.getCountLocked(which);
if (totalTime != 0) {
dumpLine(pw,uid,category,VIBRATOR_DATA,totalTime,count);
}
}
Timer fgTimer=u.getForegroundActivityTimer();
if (fgTimer != null) {
long totalTime=(fgTimer.getTotalTimeLocked(rawRealtime,which) + 500) / 1000;
int count=fgTimer.getCountLocked(which);
if (totalTime != 0) {
dumpLine(pw,uid,category,FOREGROUND_DATA,totalTime,count);
}
}
Object[] stateTimes=new Object[Uid.NUM_PROCESS_STATE];
long totalStateTime=0;
for (int ips=0; ips < Uid.NUM_PROCESS_STATE; ips++) {
totalStateTime+=u.getProcessStateTime(ips,rawRealtime,which);
stateTimes[ips]=(totalStateTime + 500) / 1000;
}
if (totalStateTime > 0) {
dumpLine(pw,uid,category,STATE_TIME_DATA,stateTimes);
}
Map<String,? extends BatteryStats.Uid.Proc> processStats=u.getProcessStats();
if (processStats.size() > 0) {
for (Map.Entry<String,? extends BatteryStats.Uid.Proc> ent : processStats.entrySet()) {
Uid.Proc ps=ent.getValue();
final long userMillis=ps.getUserTime(which) * 10;
final long systemMillis=ps.getSystemTime(which) * 10;
final long foregroundMillis=ps.getForegroundTime(which) * 10;
final long starts=ps.getStarts(which);
if (userMillis != 0 || systemMillis != 0 || foregroundMillis != 0 || starts != 0) {
dumpLine(pw,uid,category,PROCESS_DATA,ent.getKey(),userMillis,systemMillis,foregroundMillis,starts);
}
}
}
Map<String,? extends BatteryStats.Uid.Pkg> packageStats=u.getPackageStats();
if (packageStats.size() > 0) {
for (Map.Entry<String,? extends BatteryStats.Uid.Pkg> ent : packageStats.entrySet()) {
Uid.Pkg ps=ent.getValue();
int wakeups=ps.getWakeups(which);
Map<String,? extends Uid.Pkg.Serv> serviceStats=ps.getServiceStats();
for (Map.Entry<String,? extends BatteryStats.Uid.Pkg.Serv> sent : serviceStats.entrySet()) {
BatteryStats.Uid.Pkg.Serv ss=sent.getValue();
long startTime=ss.getStartTime(batteryUptime,which);
int starts=ss.getStarts(which);
int launches=ss.getLaunches(which);
if (startTime != 0 || starts != 0 || launches != 0) {
dumpLine(pw,uid,category,APK_DATA,wakeups,ent.getKey(),sent.getKey(),startTime / 1000,starts,launches);
}
}
}
}
}
}
