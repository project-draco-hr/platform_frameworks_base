{
  prepareForDumpLocked();
  long now=getHistoryBaseTime() + SystemClock.elapsedRealtime();
  final boolean filtering=(flags & (DUMP_HISTORY_ONLY | DUMP_UNPLUGGED_ONLY | DUMP_CHARGED_ONLY)) != 0;
  if ((flags & DUMP_INCLUDE_HISTORY) != 0 || (flags & DUMP_HISTORY_ONLY) != 0) {
    final HistoryItem rec=new HistoryItem();
    if (startIteratingHistoryLocked()) {
      try {
        for (int i=0; i < getHistoryStringPoolSize(); i++) {
          pw.print(BATTERY_STATS_CHECKIN_VERSION);
          pw.print(',');
          pw.print(HISTORY_STRING_POOL);
          pw.print(',');
          pw.print(i);
          pw.print(",");
          pw.print(getHistoryTagPoolUid(i));
          pw.print(",\"");
          String str=getHistoryTagPoolString(i);
          str=str.replace("\\","\\\\");
          str=str.replace("\"","\\\"");
          pw.print(str);
          pw.print("\"");
          pw.println();
        }
        HistoryPrinter hprinter=new HistoryPrinter();
        long lastTime=-1;
        long baseTime=-1;
        boolean printed=false;
        while (getNextHistoryLocked(rec)) {
          lastTime=rec.time;
          if (baseTime < 0) {
            baseTime=lastTime;
          }
          if (rec.time >= histStart) {
            if (histStart >= 0 && !printed) {
              if (rec.cmd == HistoryItem.CMD_CURRENT_TIME) {
                printed=true;
              }
 else               if (rec.currentTime != 0) {
                printed=true;
                byte cmd=rec.cmd;
                rec.cmd=HistoryItem.CMD_CURRENT_TIME;
                pw.print(BATTERY_STATS_CHECKIN_VERSION);
                pw.print(',');
                pw.print(HISTORY_DATA);
                pw.print(',');
                hprinter.printNextItem(pw,rec,baseTime,true,false);
                rec.cmd=cmd;
              }
            }
            pw.print(BATTERY_STATS_CHECKIN_VERSION);
            pw.print(',');
            pw.print(HISTORY_DATA);
            pw.print(',');
            hprinter.printNextItem(pw,rec,baseTime,true,false);
          }
        }
        if (histStart >= 0) {
          pw.print("NEXT: ");
          pw.println(lastTime + 1);
        }
      }
  finally {
        finishIteratingHistoryLocked();
      }
    }
  }
  if (filtering && (flags & (DUMP_UNPLUGGED_ONLY | DUMP_CHARGED_ONLY)) == 0) {
    return;
  }
  if (apps != null) {
    SparseArray<ArrayList<String>> uids=new SparseArray<ArrayList<String>>();
    for (int i=0; i < apps.size(); i++) {
      ApplicationInfo ai=apps.get(i);
      ArrayList<String> pkgs=uids.get(ai.uid);
      if (pkgs == null) {
        pkgs=new ArrayList<String>();
        uids.put(ai.uid,pkgs);
      }
      pkgs.add(ai.packageName);
    }
    SparseArray<? extends Uid> uidStats=getUidStats();
    final int NU=uidStats.size();
    String[] lineArgs=new String[2];
    for (int i=0; i < NU; i++) {
      int uid=uidStats.keyAt(i);
      ArrayList<String> pkgs=uids.get(uid);
      if (pkgs != null) {
        for (int j=0; j < pkgs.size(); j++) {
          lineArgs[0]=Integer.toString(uid);
          lineArgs[1]=pkgs.get(j);
          dumpLine(pw,0,"i",UID_DATA,(Object[])lineArgs);
        }
      }
    }
  }
  if (!filtering) {
    dumpDurationSteps(pw,DISCHARGE_STEP_DATA,getDischargeStepDurationsArray(),getNumDischargeStepDurations(),true);
    String[] lineArgs=new String[1];
    long timeRemaining=computeBatteryTimeRemaining(SystemClock.elapsedRealtime());
    if (timeRemaining >= 0) {
      lineArgs[0]=Long.toString(timeRemaining);
      dumpLine(pw,0,"i",DISCHARGE_TIME_REMAIN_DATA,(Object[])lineArgs);
    }
    dumpDurationSteps(pw,CHARGE_STEP_DATA,getChargeStepDurationsArray(),getNumChargeStepDurations(),true);
    timeRemaining=computeChargeTimeRemaining(SystemClock.elapsedRealtime());
    if (timeRemaining >= 0) {
      lineArgs[0]=Long.toString(timeRemaining);
      dumpLine(pw,0,"i",CHARGE_TIME_REMAIN_DATA,(Object[])lineArgs);
    }
  }
  if (!filtering || (flags & DUMP_CHARGED_ONLY) != 0) {
    dumpCheckinLocked(context,pw,STATS_SINCE_CHARGED,-1);
  }
  if (!filtering || (flags & DUMP_UNPLUGGED_ONLY) != 0) {
    dumpCheckinLocked(context,pw,STATS_SINCE_UNPLUGGED,-1);
  }
}
