{
  int stepCount=mNumStepDurations;
  final long lastStepTime=mLastStepTime;
  if (lastStepTime >= 0 && numStepLevels > 0) {
    final long[] steps=mStepDurations;
    long duration=elapsedRealtime - lastStepTime;
    for (int i=0; i < numStepLevels; i++) {
      System.arraycopy(steps,0,steps,1,steps.length - 1);
      long thisDuration=duration / (numStepLevels - i);
      duration-=thisDuration;
      if (thisDuration > STEP_LEVEL_TIME_MASK) {
        thisDuration=STEP_LEVEL_TIME_MASK;
      }
      steps[0]=thisDuration | modeBits;
    }
    stepCount+=numStepLevels;
    if (stepCount > steps.length) {
      stepCount=steps.length;
    }
  }
  mNumStepDurations=stepCount;
  mLastStepTime=elapsedRealtime;
}
