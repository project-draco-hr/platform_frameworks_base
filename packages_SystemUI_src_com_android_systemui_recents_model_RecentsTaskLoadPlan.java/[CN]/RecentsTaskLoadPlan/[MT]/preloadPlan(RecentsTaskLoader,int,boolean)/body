{
  Resources res=mContext.getResources();
  ArrayList<Task> allTasks=new ArrayList<>();
  if (mRawTasks == null) {
    preloadRawTasks(isTopTaskHome);
  }
  SparseArray<Task.TaskKey> affiliatedTasks=new SparseArray<>();
  SparseIntArray affiliatedTaskCounts=new SparseIntArray();
  String dismissDescFormat=mContext.getString(R.string.accessibility_recents_item_will_be_dismissed);
  Formatter dismissDescFormatter=new Formatter();
  long lastStackActiveTime=Prefs.getLong(mContext,Prefs.Key.OVERVIEW_LAST_STACK_TASK_ACTIVE_TIME,0);
  if (RecentsDebugFlags.Static.EnableMockTasks) {
    lastStackActiveTime=0;
  }
  long newLastStackActiveTime=-1;
  long prevLastActiveTime=lastStackActiveTime;
  int taskCount=mRawTasks.size();
  for (int i=0; i < taskCount; i++) {
    ActivityManager.RecentTaskInfo t=mRawTasks.get(i);
    if (t.persistentId != t.affiliatedTaskId) {
      Task.TaskKey parentTask=affiliatedTasks.get(t.affiliatedTaskId);
      long parentTaskLastActiveTime=parentTask != null ? parentTask.lastActiveTime : prevLastActiveTime;
      t.lastActiveTime=parentTaskLastActiveTime + affiliatedTaskCounts.get(t.affiliatedTaskId,0) + 1;
    }
    Task.TaskKey taskKey=new Task.TaskKey(t.persistentId,t.stackId,t.baseIntent,t.userId,t.firstActiveTime,t.lastActiveTime);
    boolean isFreeformTask=SystemServicesProxy.isFreeformStack(t.stackId);
    boolean isStackTask=isFreeformTask || (!isHistoricalTask(t) || (t.lastActiveTime >= lastStackActiveTime && i >= (taskCount - MIN_NUM_TASKS)));
    boolean isLaunchTarget=taskKey.id == topTaskId;
    if (isStackTask && newLastStackActiveTime < 0) {
      newLastStackActiveTime=t.lastActiveTime;
    }
    String title=loader.getAndUpdateActivityTitle(taskKey,t.taskDescription);
    String contentDescription=loader.getAndUpdateContentDescription(taskKey,res);
    String dismissDescription=dismissDescFormatter.format(dismissDescFormat,contentDescription).toString();
    Drawable icon=isStackTask ? loader.getAndUpdateActivityIcon(taskKey,t.taskDescription,res,false) : null;
    Bitmap thumbnail=loader.getAndUpdateThumbnail(taskKey,false);
    int activityColor=loader.getActivityPrimaryColor(t.taskDescription);
    int backgroundColor=loader.getActivityBackgroundColor(t.taskDescription);
    boolean isSystemApp=(loader.getAndUpdateActivityInfo(taskKey).applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) != 0;
    Task task=new Task(taskKey,t.affiliatedTaskId,t.affiliatedTaskColor,icon,thumbnail,title,contentDescription,dismissDescription,activityColor,backgroundColor,!isStackTask,isLaunchTarget,isSystemApp,t.bounds,t.taskDescription);
    allTasks.add(task);
    affiliatedTaskCounts.put(taskKey.id,affiliatedTaskCounts.get(taskKey.id,0) + 1);
    affiliatedTasks.put(taskKey.id,taskKey);
    prevLastActiveTime=t.lastActiveTime;
  }
  if (newLastStackActiveTime != -1) {
    Prefs.putLong(mContext,Prefs.Key.OVERVIEW_LAST_STACK_TASK_ACTIVE_TIME,newLastStackActiveTime);
  }
  mStack=new TaskStack();
  mStack.setTasks(allTasks,false);
  mStack.createAffiliatedGroupings(mContext);
}
