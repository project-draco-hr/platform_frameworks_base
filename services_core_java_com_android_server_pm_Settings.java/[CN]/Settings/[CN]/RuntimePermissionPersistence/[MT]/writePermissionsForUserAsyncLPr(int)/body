{
  final long currentTimeMillis=SystemClock.uptimeMillis();
  if (mWriteScheduled.get(userId)) {
    mHandler.removeMessages(userId);
    final long lastNotWrittenMutationTimeMillis=mLastNotWrittenMutationTimesMillis.get(userId);
    final long timeSinceLastNotWrittenMutationMillis=currentTimeMillis - lastNotWrittenMutationTimeMillis;
    if (timeSinceLastNotWrittenMutationMillis >= MAX_WRITE_PERMISSIONS_DELAY_MILLIS) {
      mHandler.obtainMessage(userId).sendToTarget();
      return;
    }
    final long maxDelayMillis=Math.max(lastNotWrittenMutationTimeMillis + MAX_WRITE_PERMISSIONS_DELAY_MILLIS - currentTimeMillis,0);
    final long writeDelayMillis=Math.min(WRITE_PERMISSIONS_DELAY_MILLIS,maxDelayMillis);
    Message message=mHandler.obtainMessage(userId);
    mHandler.sendMessageDelayed(message,writeDelayMillis);
  }
 else {
    mLastNotWrittenMutationTimesMillis.put(userId,currentTimeMillis);
    Message message=mHandler.obtainMessage(userId);
    mHandler.sendMessageDelayed(message,WRITE_PERMISSIONS_DELAY_MILLIS);
    mWriteScheduled.put(userId,true);
  }
}
