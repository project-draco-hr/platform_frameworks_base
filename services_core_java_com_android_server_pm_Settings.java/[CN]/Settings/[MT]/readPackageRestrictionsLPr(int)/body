{
  if (DEBUG_MU) {
    Log.i(TAG,"Reading package restrictions for user=" + userId);
  }
  FileInputStream str=null;
  File userPackagesStateFile=getUserPackagesStateFile(userId);
  File backupFile=getUserPackagesStateBackupFile(userId);
  if (backupFile.exists()) {
    try {
      str=new FileInputStream(backupFile);
      mReadMessages.append("Reading from backup stopped packages file\n");
      PackageManagerService.reportSettingsProblem(Log.INFO,"Need to read from backup stopped packages file");
      if (userPackagesStateFile.exists()) {
        Slog.w(PackageManagerService.TAG,"Cleaning up stopped packages file " + userPackagesStateFile);
        userPackagesStateFile.delete();
      }
    }
 catch (    java.io.IOException e) {
    }
  }
  try {
    if (str == null) {
      if (!userPackagesStateFile.exists()) {
        mReadMessages.append("No stopped packages file found\n");
        PackageManagerService.reportSettingsProblem(Log.INFO,"No stopped packages file; " + "assuming all started");
        for (        PackageSetting pkg : mPackages.values()) {
          pkg.setUserState(userId,0,COMPONENT_ENABLED_STATE_DEFAULT,true,false,false,false,false,null,null,null,false,INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED,0);
        }
        return;
      }
      str=new FileInputStream(userPackagesStateFile);
    }
    final XmlPullParser parser=Xml.newPullParser();
    parser.setInput(str,StandardCharsets.UTF_8.name());
    int type;
    while ((type=parser.next()) != XmlPullParser.START_TAG && type != XmlPullParser.END_DOCUMENT) {
      ;
    }
    if (type != XmlPullParser.START_TAG) {
      mReadMessages.append("No start tag found in package restrictions file\n");
      PackageManagerService.reportSettingsProblem(Log.WARN,"No start tag found in package manager stopped packages");
      return;
    }
    int maxAppLinkGeneration=0;
    int outerDepth=parser.getDepth();
    PackageSetting ps=null;
    while ((type=parser.next()) != XmlPullParser.END_DOCUMENT && (type != XmlPullParser.END_TAG || parser.getDepth() > outerDepth)) {
      if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) {
        continue;
      }
      String tagName=parser.getName();
      if (tagName.equals(TAG_PACKAGE)) {
        String name=parser.getAttributeValue(null,ATTR_NAME);
        ps=mPackages.get(name);
        if (ps == null) {
          Slog.w(PackageManagerService.TAG,"No package known for stopped package " + name);
          XmlUtils.skipCurrentTag(parser);
          continue;
        }
        final long ceDataInode=XmlUtils.readLongAttribute(parser,ATTR_CE_DATA_INODE,0);
        final boolean installed=XmlUtils.readBooleanAttribute(parser,ATTR_INSTALLED,true);
        final boolean stopped=XmlUtils.readBooleanAttribute(parser,ATTR_STOPPED,false);
        final boolean notLaunched=XmlUtils.readBooleanAttribute(parser,ATTR_NOT_LAUNCHED,false);
        final String blockedStr=parser.getAttributeValue(null,ATTR_BLOCKED);
        boolean hidden=blockedStr == null ? false : Boolean.parseBoolean(blockedStr);
        final String hiddenStr=parser.getAttributeValue(null,ATTR_HIDDEN);
        hidden=hiddenStr == null ? hidden : Boolean.parseBoolean(hiddenStr);
        final boolean suspended=XmlUtils.readBooleanAttribute(parser,ATTR_SUSPENDED,false);
        final boolean blockUninstall=XmlUtils.readBooleanAttribute(parser,ATTR_BLOCK_UNINSTALL,false);
        final int enabled=XmlUtils.readIntAttribute(parser,ATTR_ENABLED,COMPONENT_ENABLED_STATE_DEFAULT);
        final String enabledCaller=parser.getAttributeValue(null,ATTR_ENABLED_CALLER);
        final int verifState=XmlUtils.readIntAttribute(parser,ATTR_DOMAIN_VERIFICATON_STATE,PackageManager.INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED);
        final int linkGeneration=XmlUtils.readIntAttribute(parser,ATTR_APP_LINK_GENERATION,0);
        if (linkGeneration > maxAppLinkGeneration) {
          maxAppLinkGeneration=linkGeneration;
        }
        ArraySet<String> enabledComponents=null;
        ArraySet<String> disabledComponents=null;
        int packageDepth=parser.getDepth();
        while ((type=parser.next()) != XmlPullParser.END_DOCUMENT && (type != XmlPullParser.END_TAG || parser.getDepth() > packageDepth)) {
          if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) {
            continue;
          }
          tagName=parser.getName();
          if (tagName.equals(TAG_ENABLED_COMPONENTS)) {
            enabledComponents=readComponentsLPr(parser);
          }
 else           if (tagName.equals(TAG_DISABLED_COMPONENTS)) {
            disabledComponents=readComponentsLPr(parser);
          }
        }
        ps.setUserState(userId,ceDataInode,enabled,installed,stopped,notLaunched,hidden,suspended,enabledCaller,enabledComponents,disabledComponents,blockUninstall,verifState,linkGeneration);
      }
 else       if (tagName.equals("preferred-activities")) {
        readPreferredActivitiesLPw(parser,userId);
      }
 else       if (tagName.equals(TAG_PERSISTENT_PREFERRED_ACTIVITIES)) {
        readPersistentPreferredActivitiesLPw(parser,userId);
      }
 else       if (tagName.equals(TAG_CROSS_PROFILE_INTENT_FILTERS)) {
        readCrossProfileIntentFiltersLPw(parser,userId);
      }
 else       if (tagName.equals(TAG_DEFAULT_APPS)) {
        readDefaultAppsLPw(parser,userId);
      }
 else {
        Slog.w(PackageManagerService.TAG,"Unknown element under <stopped-packages>: " + parser.getName());
        XmlUtils.skipCurrentTag(parser);
      }
    }
    str.close();
    mNextAppLinkGeneration.put(userId,maxAppLinkGeneration + 1);
  }
 catch (  XmlPullParserException e) {
    mReadMessages.append("Error reading: " + e.toString());
    PackageManagerService.reportSettingsProblem(Log.ERROR,"Error reading stopped packages: " + e);
    Slog.wtf(PackageManagerService.TAG,"Error reading package manager stopped packages",e);
  }
catch (  java.io.IOException e) {
    mReadMessages.append("Error reading: " + e.toString());
    PackageManagerService.reportSettingsProblem(Log.ERROR,"Error reading settings: " + e);
    Slog.wtf(PackageManagerService.TAG,"Error reading package manager stopped packages",e);
  }
}
