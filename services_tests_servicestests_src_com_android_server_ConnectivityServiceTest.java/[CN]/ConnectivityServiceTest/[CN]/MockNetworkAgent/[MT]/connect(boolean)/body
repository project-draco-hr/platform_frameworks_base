{
  assertEquals(mNetworkInfo.getDetailedState(),DetailedState.IDLE);
  assertFalse(mNetworkCapabilities.hasCapability(NET_CAPABILITY_INTERNET));
  NetworkCallback callback=null;
  final ConditionVariable validatedCv=new ConditionVariable();
  if (validated) {
    NetworkRequest request=new NetworkRequest.Builder().addTransportType(mNetworkCapabilities.getTransportTypes()[0]).build();
    callback=new NetworkCallback(){
      public void onCapabilitiesChanged(      Network network,      NetworkCapabilities networkCapabilities){
        if (networkCapabilities.hasCapability(NET_CAPABILITY_VALIDATED)) {
          validatedCv.open();
        }
      }
    }
;
    mCm.requestNetwork(request,callback);
  }
 else {
    mNetworkCapabilities.addCapability(NET_CAPABILITY_INTERNET);
    mNetworkAgent.sendNetworkCapabilities(mNetworkCapabilities);
  }
  mNetworkInfo.setDetailedState(DetailedState.CONNECTED,null,null);
  mNetworkAgent.sendNetworkInfo(mNetworkInfo);
  if (validated) {
    waitFor(validatedCv);
    mNetworkCapabilities.addCapability(NET_CAPABILITY_INTERNET);
    mNetworkAgent.sendNetworkCapabilities(mNetworkCapabilities);
  }
  if (callback != null)   mCm.unregisterNetworkCallback(callback);
}
