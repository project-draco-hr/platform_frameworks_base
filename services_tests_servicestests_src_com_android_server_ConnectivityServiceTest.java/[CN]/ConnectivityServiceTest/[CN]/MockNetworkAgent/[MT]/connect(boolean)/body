{
  assertEquals(mNetworkInfo.getDetailedState(),DetailedState.IDLE);
  assertFalse(mNetworkCapabilities.hasCapability(NET_CAPABILITY_INTERNET));
  NetworkCallback callback=null;
  final ConditionVariable validatedCv=new ConditionVariable();
  if (validated) {
    mWrappedNetworkMonitor.gen204ProbeResult=204;
    NetworkRequest request=new NetworkRequest.Builder().addTransportType(mNetworkCapabilities.getTransportTypes()[0]).build();
    callback=new NetworkCallback(){
      public void onCapabilitiesChanged(      Network network,      NetworkCapabilities networkCapabilities){
        if (network.equals(getNetwork()) && networkCapabilities.hasCapability(NET_CAPABILITY_VALIDATED)) {
          validatedCv.open();
        }
      }
    }
;
    mCm.registerNetworkCallback(request,callback);
  }
  addCapability(NET_CAPABILITY_INTERNET);
  connectWithoutInternet();
  if (validated) {
    waitFor(validatedCv);
    mWrappedNetworkMonitor.gen204ProbeResult=500;
  }
  if (callback != null)   mCm.unregisterNetworkCallback(callback);
}
