{
  NetworkCapabilities filter=new NetworkCapabilities();
  filter.addCapability(NET_CAPABILITY_INTERNET);
  final HandlerThread handlerThread=new HandlerThread("testNetworkFactoryRequests");
  handlerThread.start();
  final MockNetworkFactory testFactory=new MockNetworkFactory(handlerThread.getLooper(),mServiceContext,"testFactory",filter);
  testFactory.setScoreFilter(40);
  ConditionVariable cv=testFactory.getNetworkStartedCV();
  testFactory.register();
  waitFor(cv);
  assertEquals(1,testFactory.getMyRequestCount());
  assertEquals(true,testFactory.getMyStartRequested());
  MockNetworkAgent testAgent=new MockNetworkAgent(TRANSPORT_CELLULAR);
  cv=waitForConnectivityBroadcasts(1);
  ConditionVariable cvRelease=testFactory.getNetworkStoppedCV();
  testAgent.connect(true);
  waitFor(cv);
  waitFor(cvRelease);
  assertEquals(false,testFactory.getMyStartRequested());
  testFactory.waitForNetworkRequests(1);
  ConnectivityManager.NetworkCallback[] networkCallbacks=new ConnectivityManager.NetworkCallback[10];
  for (int i=0; i < networkCallbacks.length; i++) {
    networkCallbacks[i]=new ConnectivityManager.NetworkCallback();
    NetworkRequest.Builder builder=new NetworkRequest.Builder();
    builder.addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET);
    mCm.requestNetwork(builder.build(),networkCallbacks[i]);
  }
  testFactory.waitForNetworkRequests(11);
  assertEquals(false,testFactory.getMyStartRequested());
  for (int i=0; i < networkCallbacks.length; i++) {
    mCm.unregisterNetworkCallback(networkCallbacks[i]);
  }
  testFactory.waitForNetworkRequests(1);
  assertEquals(false,testFactory.getMyStartRequested());
  cv=waitForConnectivityBroadcasts(1);
  testAgent.disconnect();
  waitFor(cv);
  assertEquals(1,testFactory.getMyRequestCount());
  assertEquals(true,testFactory.getMyStartRequested());
  testFactory.unregister();
  handlerThread.quit();
}
