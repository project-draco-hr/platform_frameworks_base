{
  final TestNetworkCallback captivePortalCallback=new TestNetworkCallback();
  final NetworkRequest captivePortalRequest=new NetworkRequest.Builder().addCapability(NET_CAPABILITY_CAPTIVE_PORTAL).build();
  mCm.registerNetworkCallback(captivePortalRequest,captivePortalCallback);
  final TestNetworkCallback validatedCallback=new TestNetworkCallback();
  final NetworkRequest validatedRequest=new NetworkRequest.Builder().addCapability(NET_CAPABILITY_VALIDATED).build();
  mCm.registerNetworkCallback(validatedRequest,validatedCallback);
  ConditionVariable validatedCv=validatedCallback.getConditionVariable();
  ConditionVariable cv=captivePortalCallback.getConditionVariable();
  mWiFiNetworkAgent=new MockNetworkAgent(TRANSPORT_WIFI);
  mWiFiNetworkAgent.connectWithCaptivePortal();
  waitFor(cv);
  assertEquals(CallbackState.AVAILABLE,captivePortalCallback.getLastCallback());
  cv=captivePortalCallback.getConditionVariable();
  mWiFiNetworkAgent.disconnect();
  waitFor(cv);
  assertEquals(CallbackState.LOST,captivePortalCallback.getLastCallback());
  cv=captivePortalCallback.getConditionVariable();
  mWiFiNetworkAgent=new MockNetworkAgent(TRANSPORT_WIFI);
  mWiFiNetworkAgent.connectWithCaptivePortal();
  waitFor(cv);
  assertEquals(CallbackState.AVAILABLE,captivePortalCallback.getLastCallback());
  cv=captivePortalCallback.getConditionVariable();
  mWiFiNetworkAgent.getWrappedNetworkMonitor().gen204ProbeResult=204;
  mCm.reportNetworkConnectivity(mWiFiNetworkAgent.getNetwork(),true);
  waitFor(cv);
  assertEquals(CallbackState.LOST,captivePortalCallback.getLastCallback());
  waitFor(validatedCv);
  assertEquals(CallbackState.AVAILABLE,validatedCallback.getLastCallback());
  validatedCv=validatedCallback.getConditionVariable();
  mWiFiNetworkAgent.getWrappedNetworkMonitor().gen204ProbeResult=500;
  mCm.reportNetworkConnectivity(mWiFiNetworkAgent.getNetwork(),false);
  waitFor(validatedCv);
  assertEquals(CallbackState.LOST,validatedCallback.getLastCallback());
}
