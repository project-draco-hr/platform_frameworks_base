{
  final TestNetworkCallback wifiNetworkCallback=new TestNetworkCallback();
  final TestNetworkCallback cellNetworkCallback=new TestNetworkCallback();
  final NetworkRequest wifiRequest=new NetworkRequest.Builder().addTransportType(TRANSPORT_WIFI).build();
  final NetworkRequest cellRequest=new NetworkRequest.Builder().addTransportType(TRANSPORT_CELLULAR).build();
  mCm.registerNetworkCallback(wifiRequest,wifiNetworkCallback);
  mCm.registerNetworkCallback(cellRequest,cellNetworkCallback);
  ConditionVariable cellCv=cellNetworkCallback.getConditionVariable();
  ConditionVariable wifiCv=wifiNetworkCallback.getConditionVariable();
  ConditionVariable cv=waitForConnectivityBroadcasts(1);
  mCellNetworkAgent=new MockNetworkAgent(TRANSPORT_CELLULAR);
  mCellNetworkAgent.connect(false);
  waitFor(cellCv);
  assertEquals(CallbackState.AVAILABLE,cellNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,wifiNetworkCallback.getLastCallback());
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  waitFor(cv);
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  mCellNetworkAgent.adjustScore(-1);
  shortSleep();
  assertEquals(CallbackState.NONE,wifiNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,cellNetworkCallback.getLastCallback());
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  cv=waitForConnectivityBroadcasts(2);
  mWiFiNetworkAgent=new MockNetworkAgent(TRANSPORT_WIFI);
  mWiFiNetworkAgent.connect(false);
  waitFor(wifiCv);
  assertEquals(CallbackState.AVAILABLE,wifiNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,cellNetworkCallback.getLastCallback());
  assertEquals(mWiFiNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  waitFor(cv);
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  cv=waitForConnectivityBroadcasts(2);
  mWiFiNetworkAgent.disconnect();
  waitFor(wifiCv);
  assertEquals(CallbackState.LOST,wifiNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,cellNetworkCallback.getLastCallback());
  waitFor(cv);
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  cv=waitForConnectivityBroadcasts(1);
  mCellNetworkAgent.disconnect();
  waitFor(cellCv);
  assertEquals(CallbackState.LOST,cellNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,wifiNetworkCallback.getLastCallback());
  waitFor(cv);
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  cv=waitForConnectivityBroadcasts(1);
  mCellNetworkAgent=new MockNetworkAgent(TRANSPORT_CELLULAR);
  mCellNetworkAgent.connect(true);
  waitFor(cv);
  waitFor(cellCv);
  assertEquals(CallbackState.AVAILABLE,cellNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,wifiNetworkCallback.getLastCallback());
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  mCellNetworkAgent.adjustScore(-1);
  shortSleep();
  assertEquals(CallbackState.NONE,wifiNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,cellNetworkCallback.getLastCallback());
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  cv=waitForConnectivityBroadcasts(1);
  mWiFiNetworkAgent=new MockNetworkAgent(TRANSPORT_WIFI);
  mWiFiNetworkAgent.connect(true);
  waitFor(cv);
  waitFor(wifiCv);
  assertEquals(CallbackState.AVAILABLE,wifiNetworkCallback.getLastCallback());
  waitFor(cellCv);
  assertEquals(CallbackState.LOSING,cellNetworkCallback.getLastCallback());
  assertEquals(mWiFiNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  mWiFiNetworkAgent.disconnect();
  waitFor(wifiCv);
  assertEquals(CallbackState.LOST,wifiNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,cellNetworkCallback.getLastCallback());
  cellCv=cellNetworkCallback.getConditionVariable();
  wifiCv=wifiNetworkCallback.getConditionVariable();
  mCellNetworkAgent.disconnect();
  waitFor(cellCv);
  assertEquals(CallbackState.LOST,cellNetworkCallback.getLastCallback());
  assertEquals(CallbackState.NONE,wifiNetworkCallback.getLastCallback());
}
