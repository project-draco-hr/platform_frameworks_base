{
  final TestNetworkCallback wifiNetworkCallback=new TestNetworkCallback();
  final TestNetworkCallback cellNetworkCallback=new TestNetworkCallback();
  final NetworkRequest wifiRequest=new NetworkRequest.Builder().addTransportType(TRANSPORT_WIFI).build();
  final NetworkRequest cellRequest=new NetworkRequest.Builder().addTransportType(TRANSPORT_CELLULAR).build();
  mCm.registerNetworkCallback(wifiRequest,wifiNetworkCallback);
  mCm.registerNetworkCallback(cellRequest,cellNetworkCallback);
  ConditionVariable cv=waitForConnectivityBroadcasts(1);
  mCellNetworkAgent=new MockNetworkAgent(TRANSPORT_CELLULAR);
  mCellNetworkAgent.connect(false);
  cellNetworkCallback.expectCallback(CallbackState.AVAILABLE);
  wifiNetworkCallback.assertNoCallback();
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  waitFor(cv);
  mCellNetworkAgent.adjustScore(-1);
  mService.waitForIdle();
  wifiNetworkCallback.assertNoCallback();
  cellNetworkCallback.assertNoCallback();
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  cv=waitForConnectivityBroadcasts(2);
  mWiFiNetworkAgent=new MockNetworkAgent(TRANSPORT_WIFI);
  mWiFiNetworkAgent.connect(false);
  wifiNetworkCallback.expectCallback(CallbackState.AVAILABLE);
  cellNetworkCallback.assertNoCallback();
  assertEquals(mWiFiNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  waitFor(cv);
  cv=waitForConnectivityBroadcasts(2);
  mWiFiNetworkAgent.disconnect();
  wifiNetworkCallback.expectCallback(CallbackState.LOST);
  cellNetworkCallback.assertNoCallback();
  waitFor(cv);
  cv=waitForConnectivityBroadcasts(1);
  mCellNetworkAgent.disconnect();
  cellNetworkCallback.expectCallback(CallbackState.LOST);
  wifiNetworkCallback.assertNoCallback();
  waitFor(cv);
  mCellNetworkAgent=new MockNetworkAgent(TRANSPORT_CELLULAR);
  mCellNetworkAgent.connect(true);
  cellNetworkCallback.expectCallback(CallbackState.AVAILABLE);
  wifiNetworkCallback.assertNoCallback();
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  mCellNetworkAgent.adjustScore(-1);
  mService.waitForIdle();
  wifiNetworkCallback.assertNoCallback();
  cellNetworkCallback.assertNoCallback();
  assertEquals(mCellNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  mWiFiNetworkAgent=new MockNetworkAgent(TRANSPORT_WIFI);
  mWiFiNetworkAgent.connect(true);
  wifiNetworkCallback.expectCallback(CallbackState.AVAILABLE);
  cellNetworkCallback.expectCallback(CallbackState.LOSING);
  assertEquals(mWiFiNetworkAgent.getNetwork(),mCm.getActiveNetwork());
  mWiFiNetworkAgent.disconnect();
  wifiNetworkCallback.expectCallback(CallbackState.LOST);
  cellNetworkCallback.assertNoCallback();
  mCellNetworkAgent.disconnect();
  cellNetworkCallback.expectCallback(CallbackState.LOST);
  wifiNetworkCallback.assertNoCallback();
}
