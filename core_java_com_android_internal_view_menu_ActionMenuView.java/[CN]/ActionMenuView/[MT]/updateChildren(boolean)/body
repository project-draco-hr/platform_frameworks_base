{
  final ArrayList<MenuItemImpl> itemsToShow=mMenu.getActionItems(mReserveOverflow);
  final int itemCount=itemsToShow.size();
  boolean needsDivider=false;
  int childIndex=0;
  for (int i=0; i < itemCount; i++) {
    final MenuItemImpl itemData=itemsToShow.get(i);
    boolean hasDivider=false;
    if (needsDivider) {
      if (!isDivider(getChildAt(childIndex))) {
        addView(makeDividerView(),childIndex,makeDividerLayoutParams());
      }
      hasDivider=true;
      childIndex++;
    }
    View childToAdd=itemData.getActionView();
    boolean needsPreDivider=false;
    if (childToAdd != null) {
      childToAdd.setLayoutParams(makeActionViewLayoutParams(childToAdd));
    }
 else {
      ActionMenuItemView view=(ActionMenuItemView)itemData.getItemView(MenuBuilder.TYPE_ACTION_BUTTON,this);
      view.setItemInvoker(this);
      needsPreDivider=i > 0 && !hasDivider && view.hasText() && itemData.getIcon() == null;
      needsDivider=view.hasText();
      childToAdd=view;
    }
    boolean addPreDivider=removeChildrenUntil(childIndex,childToAdd,needsPreDivider);
    if (addPreDivider)     addView(makeDividerView(),childIndex,makeDividerLayoutParams());
    if (needsPreDivider)     childIndex++;
    if (getChildAt(childIndex) != childToAdd) {
      addView(childToAdd,childIndex);
    }
    childIndex++;
  }
  final boolean hasOverflow=mOverflowButton != null && mOverflowButton.getParent() == this;
  final boolean needsOverflow=mReserveOverflow && mMenu.getNonActionItems(true).size() > 0;
  if (hasOverflow != needsOverflow) {
    if (needsOverflow) {
      if (mOverflowButton == null) {
        OverflowMenuButton button=new OverflowMenuButton(mContext);
        mOverflowButton=button;
      }
      boolean addDivider=removeChildrenUntil(childIndex,mOverflowButton,true);
      if (addDivider && itemCount > 0) {
        addView(makeDividerView(),childIndex,makeDividerLayoutParams());
        childIndex++;
      }
      addView(mOverflowButton,childIndex);
      childIndex++;
    }
 else {
      removeView(mOverflowButton);
    }
  }
 else {
    if (needsOverflow) {
      boolean overflowDivider=itemCount > 0;
      boolean addDivider=removeChildrenUntil(childIndex,mOverflowButton,overflowDivider);
      if (addDivider && itemCount > 0) {
        addView(makeDividerView(),childIndex,makeDividerLayoutParams());
      }
      if (overflowDivider) {
        childIndex+=2;
      }
 else {
        childIndex++;
      }
    }
  }
  while (getChildCount() > childIndex) {
    removeViewAt(childIndex);
  }
}
