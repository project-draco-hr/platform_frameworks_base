{
  CharsetEncoder encoder=StandardCharsets.UTF_8.newEncoder();
  ByteBuffer buffer=ByteBuffer.allocate(LINE_LENGTH_LIMIT);
  Attributes.Name versionName=Attributes.Name.MANIFEST_VERSION;
  String version=manifest.mainAttributes.getValue(versionName);
  if (version == null) {
    versionName=Attributes.Name.SIGNATURE_VERSION;
    version=manifest.mainAttributes.getValue(versionName);
  }
  if (version != null) {
    writeEntry(out,versionName,version,encoder,buffer);
    Iterator<?> entries=manifest.mainAttributes.keySet().iterator();
    while (entries.hasNext()) {
      Attributes.Name name=(Attributes.Name)entries.next();
      if (!name.equals(versionName)) {
        writeEntry(out,name,manifest.mainAttributes.getValue(name),encoder,buffer);
      }
    }
  }
  out.write(LINE_SEPARATOR);
  Iterator<String> i=manifest.getEntries().keySet().iterator();
  while (i.hasNext()) {
    String key=i.next();
    writeEntry(out,Attributes.Name.NAME,key,encoder,buffer);
    Attributes attributes=manifest.entries.get(key);
    Iterator<?> entries=attributes.keySet().iterator();
    while (entries.hasNext()) {
      Attributes.Name name=(Attributes.Name)entries.next();
      writeEntry(out,name,attributes.getValue(name),encoder,buffer);
    }
    out.write(LINE_SEPARATOR);
  }
}
