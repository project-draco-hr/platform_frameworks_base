{
  if (r.state != ActivityState.STOPPING) {
    Slog.i(TAG,"Activity reported stop, but no longer stopping: " + r);
    mHandler.removeMessages(STOP_TIMEOUT_MSG,r);
    return;
  }
  if (DEBUG_SAVED_STATE)   Slog.i(TAG,"Saving icicle of " + r + ": "+ icicle);
  if (icicle != null) {
    r.icicle=icicle;
    r.haveState=true;
    r.launchCount=0;
    r.updateThumbnail(thumbnail,description);
  }
  if (!r.stopped) {
    if (DEBUG_STATES)     Slog.v(TAG,"Moving to STOPPED: " + r + " (stop complete)");
    mHandler.removeMessages(STOP_TIMEOUT_MSG,r);
    r.stopped=true;
    r.state=ActivityState.STOPPED;
    if (r.finishing) {
      r.clearOptionsLocked();
    }
 else {
      if (r.configDestroy) {
        destroyActivityLocked(r,true,false,"stop-config");
        resumeTopActivityLocked(null);
      }
 else {
        ProcessRecord fgApp=null;
        if (mResumedActivity != null) {
          fgApp=mResumedActivity.app;
        }
 else         if (mPausingActivity != null) {
          fgApp=mPausingActivity.app;
        }
        if (r.app != null && fgApp != null && r.app != fgApp && r.lastVisibleTime > mService.mPreviousProcessVisibleTime && r.app != mService.mHomeProcess) {
          mService.mPreviousProcess=r.app;
          mService.mPreviousProcessVisibleTime=r.lastVisibleTime;
        }
      }
    }
  }
}
