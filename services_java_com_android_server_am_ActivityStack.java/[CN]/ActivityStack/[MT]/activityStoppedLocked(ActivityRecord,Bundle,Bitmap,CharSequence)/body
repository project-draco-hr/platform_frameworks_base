{
  if (DEBUG_SAVED_STATE)   Slog.i(TAG,"Saving icicle of " + r + ": "+ icicle);
  r.icicle=icicle;
  r.haveState=true;
  r.updateThumbnail(thumbnail,description);
  r.stopped=true;
  if (DEBUG_STATES)   Slog.v(TAG,"Moving to STOPPED: " + r + " (stop complete)");
  r.state=ActivityState.STOPPED;
  if (!r.finishing) {
    if (r.configDestroy) {
      destroyActivityLocked(r,true,false,"stop-config");
      resumeTopActivityLocked(null);
    }
 else {
      ProcessRecord fgApp=null;
      if (mResumedActivity != null) {
        fgApp=mResumedActivity.app;
      }
 else {
        for (int i=mPausingActivities.size() - 1; i >= 0; i--) {
          ActivityRecord pausing=mPausingActivities.get(i);
          if (pausing.app == r.app) {
            fgApp=pausing.app;
            break;
          }
        }
      }
      if (r.app != null && fgApp != null && r.app != fgApp && r.lastVisibleTime > mService.mPreviousProcessVisibleTime && r.app != mService.mHomeProcess) {
        mService.mPreviousProcess=r.app;
        mService.mPreviousProcessVisibleTime=r.lastVisibleTime;
      }
    }
  }
}
