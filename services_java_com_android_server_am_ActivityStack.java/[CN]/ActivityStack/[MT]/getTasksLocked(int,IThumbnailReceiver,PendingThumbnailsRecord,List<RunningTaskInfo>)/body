{
  ActivityRecord topRecord=null;
  int pos=mHistory.size() - 1;
  ActivityRecord next=pos >= 0 ? mHistory.get(pos) : null;
  ActivityRecord top=null;
  TaskRecord curTask=null;
  int numActivities=0;
  int numRunning=0;
  while (pos >= 0 && maxNum > 0) {
    final ActivityRecord r=next;
    pos--;
    next=pos >= 0 ? mHistory.get(pos) : null;
    if (top == null || (top.state == ActivityState.INITIALIZING && top.task == r.task)) {
      top=r;
      curTask=r.task;
      numActivities=numRunning=0;
    }
    numActivities++;
    if (r.app != null && r.app.thread != null) {
      numRunning++;
    }
    if (localLOGV)     Slog.v(TAG,r.intent.getComponent().flattenToShortString() + ": task=" + r.task);
    if (next == null || next.task != curTask) {
      RunningTaskInfo ci=new RunningTaskInfo();
      ci.id=curTask.taskId;
      ci.baseActivity=r.intent.getComponent();
      ci.topActivity=top.intent.getComponent();
      if (top.thumbHolder != null) {
        ci.description=top.thumbHolder.lastDescription;
      }
      ci.numActivities=numActivities;
      ci.numRunning=numRunning;
      if (receiver != null) {
        if (localLOGV)         Slog.v(TAG,"State=" + top.state + "Idle="+ top.idle+ " app="+ top.app+ " thr="+ (top.app != null ? top.app.thread : null));
        if (top.state == ActivityState.RESUMED || top.state == ActivityState.PAUSING) {
          if (top.idle && top.app != null && top.app.thread != null) {
            topRecord=top;
          }
 else {
            top.thumbnailNeeded=true;
          }
        }
        pending.pendingRecords.add(top);
      }
      list.add(ci);
      maxNum--;
      top=null;
    }
  }
  return topRecord;
}
