{
  int index=indexOfTokenLocked(token);
  if (DEBUG_RESULTS)   Slog.v(TAG,"Finishing activity affinity @" + index + ": token="+ token);
  if (index < 0) {
    return false;
  }
  ActivityRecord r=mHistory.get(index);
  while (index >= 0) {
    ActivityRecord cur=mHistory.get(index);
    if (cur.task != r.task) {
      break;
    }
    if (cur.taskAffinity == null && r.taskAffinity != null) {
      break;
    }
    if (cur.taskAffinity != null && !cur.taskAffinity.equals(r.taskAffinity)) {
      break;
    }
    finishActivityLocked(cur,index,Activity.RESULT_CANCELED,null,"request-affinity",true);
    index--;
  }
  return true;
}
