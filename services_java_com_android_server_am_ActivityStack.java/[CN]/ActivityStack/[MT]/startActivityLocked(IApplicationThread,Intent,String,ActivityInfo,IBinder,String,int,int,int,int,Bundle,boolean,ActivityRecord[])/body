{
  int err=ActivityManager.START_SUCCESS;
  ProcessRecord callerApp=null;
  if (caller != null) {
    callerApp=mService.getRecordForAppLocked(caller);
    if (callerApp != null) {
      callingPid=callerApp.pid;
      callingUid=callerApp.info.uid;
    }
 else {
      Slog.w(TAG,"Unable to find app for caller " + caller + " (pid="+ callingPid+ ") when starting: "+ intent.toString());
      err=ActivityManager.START_PERMISSION_DENIED;
    }
  }
  if (err == ActivityManager.START_SUCCESS) {
    final int userId=aInfo != null ? UserHandle.getUserId(aInfo.applicationInfo.uid) : 0;
    Slog.i(TAG,"START {" + intent.toShortString(true,true,true,false) + " u="+ userId+ "} from pid "+ (callerApp != null ? callerApp.pid : callingPid));
  }
  ActivityRecord sourceRecord=null;
  ActivityRecord resultRecord=null;
  if (resultTo != null) {
    int index=indexOfTokenLocked(resultTo);
    if (DEBUG_RESULTS)     Slog.v(TAG,"Will send result to " + resultTo + " (index "+ index+ ")");
    if (index >= 0) {
      sourceRecord=mHistory.get(index);
      if (requestCode >= 0 && !sourceRecord.finishing) {
        resultRecord=sourceRecord;
      }
    }
  }
  int launchFlags=intent.getFlags();
  if ((launchFlags & Intent.FLAG_ACTIVITY_FORWARD_RESULT) != 0 && sourceRecord != null) {
    if (requestCode >= 0) {
      ActivityOptions.abort(options);
      return ActivityManager.START_FORWARD_AND_REQUEST_CONFLICT;
    }
    resultRecord=sourceRecord.resultTo;
    resultWho=sourceRecord.resultWho;
    requestCode=sourceRecord.requestCode;
    sourceRecord.resultTo=null;
    if (resultRecord != null) {
      resultRecord.removeResultsLocked(sourceRecord,resultWho,requestCode);
    }
  }
  if (err == ActivityManager.START_SUCCESS && intent.getComponent() == null) {
    err=ActivityManager.START_INTENT_NOT_RESOLVED;
  }
  if (err == ActivityManager.START_SUCCESS && aInfo == null) {
    err=ActivityManager.START_CLASS_NOT_FOUND;
  }
  if (err != ActivityManager.START_SUCCESS) {
    if (resultRecord != null) {
      sendActivityResultLocked(-1,resultRecord,resultWho,requestCode,Activity.RESULT_CANCELED,null);
    }
    mDismissKeyguardOnNextActivity=false;
    ActivityOptions.abort(options);
    return err;
  }
  final int startAnyPerm=mService.checkPermission(START_ANY_ACTIVITY,callingPid,callingUid);
  final int componentPerm=mService.checkComponentPermission(aInfo.permission,callingPid,callingUid,aInfo.applicationInfo.uid,aInfo.exported);
  if (startAnyPerm != PERMISSION_GRANTED && componentPerm != PERMISSION_GRANTED) {
    if (resultRecord != null) {
      sendActivityResultLocked(-1,resultRecord,resultWho,requestCode,Activity.RESULT_CANCELED,null);
    }
    mDismissKeyguardOnNextActivity=false;
    String msg;
    if (!aInfo.exported) {
      msg="Permission Denial: starting " + intent.toString() + " from "+ callerApp+ " (pid="+ callingPid+ ", uid="+ callingUid+ ")"+ " not exported from uid "+ aInfo.applicationInfo.uid;
    }
 else {
      msg="Permission Denial: starting " + intent.toString() + " from "+ callerApp+ " (pid="+ callingPid+ ", uid="+ callingUid+ ")"+ " requires "+ aInfo.permission;
    }
    Slog.w(TAG,msg);
    throw new SecurityException(msg);
  }
  if (mMainStack) {
    if (mService.mController != null) {
      boolean abort=false;
      try {
        Intent watchIntent=intent.cloneFilter();
        abort=!mService.mController.activityStarting(watchIntent,aInfo.applicationInfo.packageName);
      }
 catch (      RemoteException e) {
        mService.mController=null;
      }
      if (abort) {
        if (resultRecord != null) {
          sendActivityResultLocked(-1,resultRecord,resultWho,requestCode,Activity.RESULT_CANCELED,null);
        }
        mDismissKeyguardOnNextActivity=false;
        ActivityOptions.abort(options);
        return ActivityManager.START_SUCCESS;
      }
    }
  }
  ActivityRecord r=new ActivityRecord(mService,this,callerApp,callingUid,intent,resolvedType,aInfo,mService.mConfiguration,resultRecord,resultWho,requestCode,componentSpecified);
  if (outActivity != null) {
    outActivity[0]=r;
  }
  if (mMainStack) {
    if (mResumedActivity == null || mResumedActivity.info.applicationInfo.uid != callingUid) {
      if (!mService.checkAppSwitchAllowedLocked(callingPid,callingUid,"Activity start")) {
        PendingActivityLaunch pal=new PendingActivityLaunch();
        pal.r=r;
        pal.sourceRecord=sourceRecord;
        pal.startFlags=startFlags;
        mService.mPendingActivityLaunches.add(pal);
        mDismissKeyguardOnNextActivity=false;
        ActivityOptions.abort(options);
        return ActivityManager.START_SWITCHES_CANCELED;
      }
    }
    if (mService.mDidAppSwitch) {
      mService.mAppSwitchesAllowedTime=0;
    }
 else {
      mService.mDidAppSwitch=true;
    }
    mService.doPendingActivityLaunchesLocked(false);
  }
  err=startActivityUncheckedLocked(r,sourceRecord,startFlags,true,options);
  if (mDismissKeyguardOnNextActivity && mPausingActivity == null) {
    mDismissKeyguardOnNextActivity=false;
    mService.mWindowManager.dismissKeyguard();
  }
  return err;
}
