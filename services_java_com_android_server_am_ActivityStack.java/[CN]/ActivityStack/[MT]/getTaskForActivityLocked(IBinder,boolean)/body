{
  int newTaskId=newGetTaskForActivityLocked(token,onlyRoot);
  TaskRecord lastTask=null;
  final int N=mHistory.size();
  for (int i=0; i < N; i++) {
    ActivityRecord r=mHistory.get(i);
    if (r.appToken == token) {
      if (!onlyRoot || lastTask != r.task) {
        if (VALIDATE_TASK_REPLACE && newTaskId != r.task.taskId)         Slog.w(TAG,"getTaskForActivityLocked: mismatch: new=" + newTaskId + " taskId="+ r.task.taskId);
        return r.task.taskId;
      }
      if (VALIDATE_TASK_REPLACE && newTaskId != -1)       Slog.w(TAG,"getTaskForActivityLocked: mismatch: newTaskId=" + newTaskId + " not -1.");
      return -1;
    }
    lastTask=r.task;
  }
  if (VALIDATE_TASK_REPLACE && newTaskId != -1)   Slog.w(TAG,"getTaskForActivityLocked: mismatch at end: newTaskId=" + newTaskId + " not -1.");
  return -1;
}
