{
  r.startFreezingScreenLocked(app,0);
  mService.mWindowManager.setAppVisibility(r,true);
  if (checkConfig) {
    Configuration config=mService.mWindowManager.updateOrientationFromAppTokens(mService.mConfiguration,r.mayFreezeScreenLocked(app) ? r : null);
    mService.updateConfigurationLocked(config,r);
  }
  r.app=app;
  if (localLOGV)   Slog.v(TAG,"Launching: " + r);
  int idx=app.activities.indexOf(r);
  if (idx < 0) {
    app.activities.add(r);
  }
  mService.updateLruProcessLocked(app,true,true);
  try {
    if (app.thread == null) {
      throw new RemoteException();
    }
    List<ResultInfo> results=null;
    List<Intent> newIntents=null;
    if (andResume) {
      results=r.results;
      newIntents=r.newIntents;
    }
    if (DEBUG_SWITCH)     Slog.v(TAG,"Launching: " + r + " icicle="+ r.icicle+ " with results="+ results+ " newIntents="+ newIntents+ " andResume="+ andResume);
    if (andResume) {
      EventLog.writeEvent(EventLogTags.AM_RESTART_ACTIVITY,System.identityHashCode(r),r.task.taskId,r.shortComponentName);
    }
    if (r.isHomeActivity) {
      mService.mHomeProcess=app;
    }
    mService.ensurePackageDexOpt(r.intent.getComponent().getPackageName());
    r.sleeping=false;
    r.forceNewConfig=false;
    showAskCompatModeDialogLocked(r);
    app.thread.scheduleLaunchActivity(new Intent(r.intent),r,System.identityHashCode(r),r.info,mService.compatibilityInfoForPackageLocked(r.info.applicationInfo),r.icicle,results,newIntents,!andResume,mService.isNextTransitionForward());
    if ((app.info.flags & ApplicationInfo.FLAG_CANT_SAVE_STATE) != 0) {
      if (app.processName.equals(app.info.packageName)) {
        if (mService.mHeavyWeightProcess != null && mService.mHeavyWeightProcess != app) {
          Log.w(TAG,"Starting new heavy weight process " + app + " when already running "+ mService.mHeavyWeightProcess);
        }
        mService.mHeavyWeightProcess=app;
        Message msg=mService.mHandler.obtainMessage(ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);
        msg.obj=r;
        mService.mHandler.sendMessage(msg);
      }
    }
  }
 catch (  RemoteException e) {
    if (r.launchFailed) {
      Slog.e(TAG,"Second failure launching " + r.intent.getComponent().flattenToShortString() + ", giving up",e);
      mService.appDiedLocked(app,app.pid,app.thread);
      requestFinishActivityLocked(r,Activity.RESULT_CANCELED,null,"2nd-crash");
      return false;
    }
    app.activities.remove(r);
    throw e;
  }
  r.launchFailed=false;
  if (updateLRUListLocked(r)) {
    Slog.w(TAG,"Activity " + r + " being launched, but already in LRU list");
  }
  if (andResume) {
    r.state=ActivityState.RESUMED;
    r.stopped=false;
    mResumedActivity=r;
    r.task.touchActiveTime();
    if (mMainStack) {
      mService.addRecentTaskLocked(r.task);
    }
    completeResumeLocked(r);
    checkReadyForSleepLocked();
  }
 else {
    r.state=ActivityState.STOPPED;
    r.stopped=true;
  }
  r.icicle=null;
  r.haveState=false;
  if (mMainStack) {
    mService.startSetupActivityLocked();
  }
  return true;
}
