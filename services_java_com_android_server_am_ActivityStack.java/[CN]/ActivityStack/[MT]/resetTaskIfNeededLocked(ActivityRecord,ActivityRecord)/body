{
  boolean forceReset=(newActivity.info.flags & ActivityInfo.FLAG_CLEAR_TASK_ON_LAUNCH) != 0;
  if (ACTIVITY_INACTIVE_RESET_TIME > 0 && taskTop.task.getInactiveDuration() > ACTIVITY_INACTIVE_RESET_TIME) {
    if ((newActivity.info.flags & ActivityInfo.FLAG_ALWAYS_RETAIN_TASK_STATE) == 0) {
      forceReset=true;
    }
  }
  final TaskRecord task=taskTop.task;
  ActivityRecord target=null;
  int targetI=0;
  int taskTopI=-1;
  int replyChainEnd=-1;
  int lastReparentPos=-1;
  for (int i=mHistory.size() - 1; i >= -1; i--) {
    ActivityRecord below=i >= 0 ? mHistory.get(i) : null;
    if (below != null && below.finishing) {
      continue;
    }
    if (below != null && below.userId != taskTop.userId) {
      break;
    }
    if (target == null) {
      target=below;
      targetI=i;
      replyChainEnd=-1;
      continue;
    }
    final int flags=target.info.flags;
    final boolean finishOnTaskLaunch=(flags & ActivityInfo.FLAG_FINISH_ON_TASK_LAUNCH) != 0;
    final boolean allowTaskReparenting=(flags & ActivityInfo.FLAG_ALLOW_TASK_REPARENTING) != 0;
    if (target.task == task) {
      if (taskTopI < 0) {
        taskTopI=targetI;
      }
      if (below != null && below.task == task) {
        final boolean clearWhenTaskReset=(target.intent.getFlags() & Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET) != 0;
        if (!finishOnTaskLaunch && !clearWhenTaskReset && target.resultTo != null) {
          if (replyChainEnd < 0) {
            replyChainEnd=targetI;
          }
        }
 else         if (!finishOnTaskLaunch && !clearWhenTaskReset && allowTaskReparenting&& target.taskAffinity != null && !target.taskAffinity.equals(task.affinity)) {
          ActivityRecord p=mHistory.get(0);
          if (target.taskAffinity != null && target.taskAffinity.equals(p.task.affinity)) {
            target.setTask(p.task,p.thumbHolder,false);
            if (DEBUG_TASKS)             Slog.v(TAG,"Start pushing activity " + target + " out to bottom task "+ p.task);
          }
 else {
            mService.mCurTask++;
            if (mService.mCurTask <= 0) {
              mService.mCurTask=1;
            }
            target.setTask(new TaskRecord(mService.mCurTask,target.info,null),null,false);
            target.task.affinityIntent=target.intent;
            if (DEBUG_TASKS)             Slog.v(TAG,"Start pushing activity " + target + " out to new task "+ target.task);
          }
          mService.mWindowManager.setAppGroupId(target.appToken,task.taskId);
          if (replyChainEnd < 0) {
            replyChainEnd=targetI;
          }
          int dstPos=0;
          ThumbnailHolder curThumbHolder=target.thumbHolder;
          for (int srcPos=targetI; srcPos <= replyChainEnd; srcPos++) {
            p=mHistory.get(srcPos);
            if (p.finishing) {
              continue;
            }
            if (DEBUG_TASKS)             Slog.v(TAG,"Pushing next activity " + p + " out to target's task "+ target.task);
            p.setTask(target.task,curThumbHolder,false);
            curThumbHolder=p.thumbHolder;
            if (DEBUG_ADD_REMOVE) {
              RuntimeException here=new RuntimeException("here");
              here.fillInStackTrace();
              Slog.i(TAG,"Removing and adding activity " + p + " to stack at "+ dstPos,here);
            }
            mHistory.remove(srcPos);
            mHistory.add(dstPos,p);
            mService.mWindowManager.moveAppToken(dstPos,p.appToken);
            mService.mWindowManager.setAppGroupId(p.appToken,p.task.taskId);
            dstPos++;
            if (VALIDATE_TOKENS) {
              validateAppTokensLocked();
            }
            i++;
          }
          if (taskTop == p) {
            taskTop=below;
          }
          if (taskTopI == replyChainEnd) {
            taskTopI=-1;
          }
          replyChainEnd=-1;
        }
 else         if (forceReset || finishOnTaskLaunch || clearWhenTaskReset) {
          if (clearWhenTaskReset) {
            replyChainEnd=targetI + 1;
            while (replyChainEnd < mHistory.size() && (mHistory.get(replyChainEnd)).task == task) {
              replyChainEnd++;
            }
            replyChainEnd--;
          }
 else           if (replyChainEnd < 0) {
            replyChainEnd=targetI;
          }
          ActivityRecord p=null;
          for (int srcPos=targetI; srcPos <= replyChainEnd; srcPos++) {
            p=mHistory.get(srcPos);
            if (p.finishing) {
              continue;
            }
            if (finishActivityLocked(p,srcPos,Activity.RESULT_CANCELED,null,"reset",false)) {
              replyChainEnd--;
              srcPos--;
            }
          }
          if (taskTop == p) {
            taskTop=below;
          }
          if (taskTopI == replyChainEnd) {
            taskTopI=-1;
          }
          replyChainEnd=-1;
        }
 else {
          replyChainEnd=-1;
        }
      }
 else {
        replyChainEnd=-1;
      }
    }
 else     if (target.resultTo != null && (below == null || below.task == target.task)) {
      if (replyChainEnd < 0) {
        replyChainEnd=targetI;
      }
    }
 else     if (taskTopI >= 0 && allowTaskReparenting && task.affinity != null && task.affinity.equals(target.taskAffinity)) {
      if (forceReset || finishOnTaskLaunch) {
        if (replyChainEnd < 0) {
          replyChainEnd=targetI;
        }
        ActivityRecord p=null;
        if (DEBUG_TASKS)         Slog.v(TAG,"Finishing task at index " + targetI + " to "+ replyChainEnd);
        for (int srcPos=targetI; srcPos <= replyChainEnd; srcPos++) {
          p=mHistory.get(srcPos);
          if (p.finishing) {
            continue;
          }
          if (finishActivityLocked(p,srcPos,Activity.RESULT_CANCELED,null,"reset",false)) {
            taskTopI--;
            lastReparentPos--;
            replyChainEnd--;
            srcPos--;
          }
        }
        replyChainEnd=-1;
      }
 else {
        if (replyChainEnd < 0) {
          replyChainEnd=targetI;
        }
        if (DEBUG_TASKS)         Slog.v(TAG,"Reparenting task at index " + targetI + " to "+ replyChainEnd);
        for (int srcPos=replyChainEnd; srcPos >= targetI; srcPos--) {
          ActivityRecord p=mHistory.get(srcPos);
          if (p.finishing) {
            continue;
          }
          if (lastReparentPos < 0) {
            lastReparentPos=taskTopI;
            taskTop=p;
          }
 else {
            lastReparentPos--;
          }
          if (DEBUG_ADD_REMOVE) {
            RuntimeException here=new RuntimeException("here");
            here.fillInStackTrace();
            Slog.i(TAG,"Removing and adding activity " + p + " to stack at "+ lastReparentPos,here);
          }
          mHistory.remove(srcPos);
          p.setTask(task,null,false);
          mHistory.add(lastReparentPos,p);
          if (DEBUG_TASKS)           Slog.v(TAG,"Pulling activity " + p + " from "+ srcPos+ " to "+ lastReparentPos+ " in to resetting task "+ task);
          mService.mWindowManager.moveAppToken(lastReparentPos,p.appToken);
          mService.mWindowManager.setAppGroupId(p.appToken,p.task.taskId);
          if (VALIDATE_TOKENS) {
            validateAppTokensLocked();
          }
        }
        replyChainEnd=-1;
        if (target.info.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP) {
          for (int j=lastReparentPos - 1; j >= 0; j--) {
            ActivityRecord p=mHistory.get(j);
            if (p.finishing) {
              continue;
            }
            if (p.intent.getComponent().equals(target.intent.getComponent())) {
              if (finishActivityLocked(p,j,Activity.RESULT_CANCELED,null,"replace",false)) {
                taskTopI--;
                lastReparentPos--;
              }
            }
          }
        }
      }
    }
 else     if (below != null && below.task != target.task) {
      replyChainEnd=-1;
    }
    target=below;
    targetI=i;
  }
  return taskTop;
}
