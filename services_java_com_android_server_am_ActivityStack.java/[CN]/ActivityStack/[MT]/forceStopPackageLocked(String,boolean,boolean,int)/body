{
  boolean didSomething=false;
  TaskRecord lastTask=null;
  final int N=mHistory.size();
  for (int i=0; i < N; i++) {
    ActivityRecord r=mHistory.get(i);
    final boolean samePackage=r.packageName.equals(name) || (name == null && r.userId == userId);
    if ((userId == UserHandle.USER_ALL || r.userId == userId) && (samePackage || r.task == lastTask) && (r.app == null || evenPersistent || !r.app.persistent)) {
      if (!doit) {
        if (r.finishing) {
          continue;
        }
        return true;
      }
      didSomething=true;
      Slog.i(TAG,"  Force finishing activity " + r);
      if (samePackage) {
        if (r.app != null) {
          r.app.removed=true;
        }
        r.app=null;
      }
      lastTask=r.task;
      if (r.stack.finishActivityLocked(r,i,Activity.RESULT_CANCELED,null,"force-stop",true)) {
        i--;
      }
    }
  }
  return didSomething;
}
