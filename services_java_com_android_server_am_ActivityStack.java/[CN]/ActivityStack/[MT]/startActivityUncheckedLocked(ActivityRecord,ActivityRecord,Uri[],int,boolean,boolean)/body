{
  final Intent intent=r.intent;
  final int callingUid=r.launchedFromUid;
  int launchFlags=intent.getFlags();
  mUserLeaving=(launchFlags & Intent.FLAG_ACTIVITY_NO_USER_ACTION) == 0;
  if (DEBUG_USER_LEAVING)   Slog.v(TAG,"startActivity() => mUserLeaving=" + mUserLeaving);
  if (!doResume) {
    r.delayedResume=true;
  }
  ActivityRecord notTop=(launchFlags & Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP) != 0 ? r : null;
  if (onlyIfNeeded) {
    ActivityRecord checkedCaller=sourceRecord;
    if (checkedCaller == null) {
      checkedCaller=topRunningNonDelayedActivityLocked(notTop);
    }
    if (!checkedCaller.realActivity.equals(r.realActivity)) {
      onlyIfNeeded=false;
    }
  }
  if (sourceRecord == null) {
    if ((launchFlags & Intent.FLAG_ACTIVITY_NEW_TASK) == 0) {
      Slog.w(TAG,"startActivity called from non-Activity context; forcing Intent.FLAG_ACTIVITY_NEW_TASK for: " + intent);
      launchFlags|=Intent.FLAG_ACTIVITY_NEW_TASK;
    }
  }
 else   if (sourceRecord.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) {
    launchFlags|=Intent.FLAG_ACTIVITY_NEW_TASK;
  }
 else   if (r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK) {
    launchFlags|=Intent.FLAG_ACTIVITY_NEW_TASK;
  }
  if (r.resultTo != null && (launchFlags & Intent.FLAG_ACTIVITY_NEW_TASK) != 0) {
    Slog.w(TAG,"Activity is launching as a new task, so cancelling activity result.");
    sendActivityResultLocked(-1,r.resultTo,r.resultWho,r.requestCode,Activity.RESULT_CANCELED,null);
    r.resultTo=null;
  }
  boolean addingToTask=false;
  if (((launchFlags & Intent.FLAG_ACTIVITY_NEW_TASK) != 0 && (launchFlags & Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == 0) || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK || r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) {
    if (r.resultTo == null) {
      ActivityRecord taskTop=r.launchMode != ActivityInfo.LAUNCH_SINGLE_INSTANCE ? findTaskLocked(intent,r.info) : findActivityLocked(intent,r.info);
      if (taskTop != null) {
        if (taskTop.task.intent == null) {
          taskTop.task.setIntent(intent,r.info);
        }
        ActivityRecord curTop=topRunningNonDelayedActivityLocked(notTop);
        if (curTop.task != taskTop.task) {
          r.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);
          boolean callerAtFront=sourceRecord == null || curTop.task == sourceRecord.task;
          if (callerAtFront) {
            moveTaskToFrontLocked(taskTop.task,r);
          }
        }
        if ((launchFlags & Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != 0) {
          taskTop=resetTaskIfNeededLocked(taskTop,r);
        }
        if (onlyIfNeeded) {
          if (doResume) {
            resumeTopActivityLocked(null);
          }
          return START_RETURN_INTENT_TO_CALLER;
        }
        if ((launchFlags & Intent.FLAG_ACTIVITY_CLEAR_TOP) != 0 || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK || r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) {
          ActivityRecord top=performClearTaskLocked(taskTop.task.taskId,r,launchFlags,true);
          if (top != null) {
            if (top.frontOfTask) {
              top.task.setIntent(r.intent,r.info);
            }
            logStartActivity(EventLogTags.AM_NEW_INTENT,r,top.task);
            top.deliverNewIntentLocked(callingUid,r.intent);
          }
 else {
            addingToTask=true;
            sourceRecord=taskTop;
          }
        }
 else         if (r.realActivity.equals(taskTop.task.realActivity)) {
          if ((launchFlags & Intent.FLAG_ACTIVITY_SINGLE_TOP) != 0 && taskTop.realActivity.equals(r.realActivity)) {
            logStartActivity(EventLogTags.AM_NEW_INTENT,r,taskTop.task);
            if (taskTop.frontOfTask) {
              taskTop.task.setIntent(r.intent,r.info);
            }
            taskTop.deliverNewIntentLocked(callingUid,r.intent);
          }
 else           if (!r.intent.filterEquals(taskTop.task.intent)) {
            addingToTask=true;
            sourceRecord=taskTop;
          }
        }
 else         if ((launchFlags & Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == 0) {
          addingToTask=true;
          sourceRecord=taskTop;
        }
 else         if (!taskTop.task.rootWasReset) {
          taskTop.task.setIntent(r.intent,r.info);
        }
        if (!addingToTask) {
          if (doResume) {
            resumeTopActivityLocked(null);
          }
          return START_TASK_TO_FRONT;
        }
      }
    }
  }
  if (r.packageName != null) {
    ActivityRecord top=topRunningNonDelayedActivityLocked(notTop);
    if (top != null && r.resultTo == null) {
      if (top.realActivity.equals(r.realActivity)) {
        if (top.app != null && top.app.thread != null) {
          if ((launchFlags & Intent.FLAG_ACTIVITY_SINGLE_TOP) != 0 || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP || r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK) {
            logStartActivity(EventLogTags.AM_NEW_INTENT,top,top.task);
            if (doResume) {
              resumeTopActivityLocked(null);
            }
            if (onlyIfNeeded) {
              return START_RETURN_INTENT_TO_CALLER;
            }
            top.deliverNewIntentLocked(callingUid,r.intent);
            return START_DELIVERED_TO_TOP;
          }
        }
      }
    }
  }
 else {
    if (r.resultTo != null) {
      sendActivityResultLocked(-1,r.resultTo,r.resultWho,r.requestCode,Activity.RESULT_CANCELED,null);
    }
    return START_CLASS_NOT_FOUND;
  }
  boolean newTask=false;
  if (r.resultTo == null && !addingToTask && (launchFlags & Intent.FLAG_ACTIVITY_NEW_TASK) != 0) {
    mService.mCurTask++;
    if (mService.mCurTask <= 0) {
      mService.mCurTask=1;
    }
    r.task=new TaskRecord(mService.mCurTask,r.info,intent,(r.info.flags & ActivityInfo.FLAG_CLEAR_TASK_ON_LAUNCH) != 0);
    if (DEBUG_TASKS)     Slog.v(TAG,"Starting new activity " + r + " in new task "+ r.task);
    newTask=true;
    if (mMainStack) {
      mService.addRecentTaskLocked(r.task);
    }
  }
 else   if (sourceRecord != null) {
    if (!addingToTask && (launchFlags & Intent.FLAG_ACTIVITY_CLEAR_TOP) != 0) {
      ActivityRecord top=performClearTaskLocked(sourceRecord.task.taskId,r,launchFlags,true);
      if (top != null) {
        logStartActivity(EventLogTags.AM_NEW_INTENT,r,top.task);
        top.deliverNewIntentLocked(callingUid,r.intent);
        if (doResume) {
          resumeTopActivityLocked(null);
        }
        return START_DELIVERED_TO_TOP;
      }
    }
 else     if (!addingToTask && (launchFlags & Intent.FLAG_ACTIVITY_REORDER_TO_FRONT) != 0) {
      int where=findActivityInHistoryLocked(r,sourceRecord.task.taskId);
      if (where >= 0) {
        ActivityRecord top=moveActivityToFrontLocked(where);
        logStartActivity(EventLogTags.AM_NEW_INTENT,r,top.task);
        top.deliverNewIntentLocked(callingUid,r.intent);
        if (doResume) {
          resumeTopActivityLocked(null);
        }
        return START_DELIVERED_TO_TOP;
      }
    }
    r.task=sourceRecord.task;
    if (DEBUG_TASKS)     Slog.v(TAG,"Starting new activity " + r + " in existing task "+ r.task);
  }
 else {
    final int N=mHistory.size();
    ActivityRecord prev=N > 0 ? (ActivityRecord)mHistory.get(N - 1) : null;
    r.task=prev != null ? prev.task : new TaskRecord(mService.mCurTask,r.info,intent,(r.info.flags & ActivityInfo.FLAG_CLEAR_TASK_ON_LAUNCH) != 0);
    if (DEBUG_TASKS)     Slog.v(TAG,"Starting new activity " + r + " in new guessed "+ r.task);
  }
  if (grantedUriPermissions != null && callingUid > 0) {
    for (int i=0; i < grantedUriPermissions.length; i++) {
      mService.grantUriPermissionLocked(callingUid,r.packageName,grantedUriPermissions[i],grantedMode,r.getUriPermissionsLocked());
    }
  }
  mService.grantUriPermissionFromIntentLocked(callingUid,r.packageName,intent,r.getUriPermissionsLocked());
  if (newTask) {
    EventLog.writeEvent(EventLogTags.AM_CREATE_TASK,r.task.taskId);
  }
  logStartActivity(EventLogTags.AM_CREATE_ACTIVITY,r,r.task);
  startActivityLocked(r,newTask,doResume);
  return START_SUCCESS;
}
