{
  if (VALIDATE_TOKENS) {
    validateAppTokensLocked();
  }
  final boolean newResult=newSwitchUserLocked(userId,uss);
  mCurrentUser=userId;
  mStartingUsers.add(uss);
  if (mHistory.size() < 2) {
    if (VALIDATE_TASK_REPLACE && newResult)     Slog.w(TAG,"switchUserLocked: mismatch: " + newResult + " "+ false);
    return false;
  }
  boolean haveActivities=false;
  ActivityRecord top=mHistory.get(mHistory.size() - 1);
  if (top.userId == userId) {
    if (VALIDATE_TASK_REPLACE && !newResult)     Slog.w(TAG,"switchUserLocked: mismatch: " + newResult + " "+ true);
    return true;
  }
  int N=mHistory.size();
  int i=0;
  while (i < N) {
    ActivityRecord r=mHistory.get(i);
    if (r.userId == userId) {
      ActivityRecord moveToTop=mHistory.remove(i);
      mHistory.add(moveToTop);
      N--;
      haveActivities=true;
    }
 else {
      i++;
    }
  }
  if (VALIDATE_TASK_REPLACE)   Slog.w(TAG,"switchUserLocked: calling resumeTopActivity " + top);
  resumeTopActivityLocked(top);
  if (VALIDATE_TASK_REPLACE && (newResult != haveActivities))   Slog.w(TAG,"switchUserLocked: mismatch: " + newResult + " "+ haveActivities);
  return haveActivities;
}
