{
  int replyChainEnd=-1;
  final int taskId=task.taskId;
  final String taskAffinity=task.affinity;
  final ArrayList<ActivityRecord> activities=affinityTask.mActivities;
  final int numActivities=activities.size();
  for (int i=numActivities - 1; i > 0; --i) {
    ActivityRecord target=activities.get(i);
    final int flags=target.info.flags;
    boolean finishOnTaskLaunch=(flags & ActivityInfo.FLAG_FINISH_ON_TASK_LAUNCH) != 0;
    boolean allowTaskReparenting=(flags & ActivityInfo.FLAG_ALLOW_TASK_REPARENTING) != 0;
    if (target.resultTo != null) {
      if (replyChainEnd < 0) {
        replyChainEnd=i;
      }
    }
 else     if (topTaskIsHigher && allowTaskReparenting && taskAffinity != null && taskAffinity.equals(target.taskAffinity)) {
      if (forceReset || finishOnTaskLaunch) {
        final int start=replyChainEnd >= 0 ? replyChainEnd : i;
        if (DEBUG_TASKS)         Slog.v(TAG,"Finishing task at index " + start + " to "+ i);
        for (int srcPos=start; srcPos >= i; --srcPos) {
          final ActivityRecord p=activities.get(srcPos);
          if (p.finishing) {
            continue;
          }
          if (VALIDATE_TASK_REPLACE)           Slog.w(TAG,"resetAffinityTaskIfNeededLocked: calling finishActivity on " + p);
          finishActivityLocked(p,Activity.RESULT_CANCELED,null,"reset",false);
        }
      }
 else {
        int taskTopI=mHistory.indexOf(taskTop);
        final int end=replyChainEnd >= 0 ? replyChainEnd : i;
        if (DEBUG_TASKS)         Slog.v(TAG,"Reparenting task at index " + i + " to "+ end);
        for (int srcPos=i; srcPos <= end; ++srcPos) {
          final ActivityRecord p=activities.get(srcPos);
          setTask(p,task,null,false);
          task.addActivityToTop(p);
{
            mHistory.remove(p);
            mHistory.add(taskTopI,p);
          }
          if (DEBUG_ADD_REMOVE)           Slog.i(TAG,"Removing and adding activity " + p + " to stack at "+ task,new RuntimeException("here").fillInStackTrace());
          if (DEBUG_TASKS)           Slog.v(TAG,"Pulling activity " + p + " from "+ srcPos+ " in to resetting task "+ task);
          mService.mWindowManager.setAppGroupId(p.appToken,taskId);
        }
        mService.mWindowManager.moveTaskToTop(taskId);
        if (VALIDATE_TASK_REPLACE) {
          verifyActivityRecords(false);
        }
        if (VALIDATE_TOKENS) {
          validateAppTokensLocked();
        }
        if (target.info.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP) {
          ArrayList<ActivityRecord> taskActivities=task.mActivities;
          boolean found=false;
          int targetNdx=taskActivities.indexOf(target);
          if (targetNdx > 0) {
            ActivityRecord p=taskActivities.get(targetNdx - 1);
            if (p.intent.getComponent().equals(target.intent.getComponent())) {
              if (finishActivityLocked(p,Activity.RESULT_CANCELED,null,"replace",false)) {
                taskTopI--;
              }
            }
          }
        }
      }
      replyChainEnd=-1;
    }
  }
}
