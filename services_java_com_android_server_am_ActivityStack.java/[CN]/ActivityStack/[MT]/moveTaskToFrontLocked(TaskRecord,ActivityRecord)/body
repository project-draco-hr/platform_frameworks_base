{
  if (DEBUG_SWITCH)   Slog.v(TAG,"moveTaskToFront: " + tr);
  final int task=tr.taskId;
  int top=mHistory.size() - 1;
  if (top < 0 || ((ActivityRecord)mHistory.get(top)).task.taskId == task) {
    return;
  }
  ArrayList moved=new ArrayList();
  top=mHistory.size() - 1;
  int pos=top;
  while (pos >= 0) {
    ActivityRecord r=(ActivityRecord)mHistory.get(pos);
    if (localLOGV)     Slog.v(TAG,"At " + pos + " ckp "+ r.task+ ": "+ r);
    boolean first=true;
    if (r.task.taskId == task) {
      if (localLOGV)       Slog.v(TAG,"Removing and adding at " + top);
      mHistory.remove(pos);
      mHistory.add(top,r);
      moved.add(0,r);
      top--;
      if (first && mMainStack) {
        mService.addRecentTaskLocked(r.task);
        first=false;
      }
    }
    pos--;
  }
  if (DEBUG_TRANSITION)   Slog.v(TAG,"Prepare to front transition: task=" + tr);
  if (reason != null && (reason.intent.getFlags() & Intent.FLAG_ACTIVITY_NO_ANIMATION) != 0) {
    mService.mWindowManager.prepareAppTransition(WindowManagerPolicy.TRANSIT_NONE);
    ActivityRecord r=topRunningActivityLocked(null);
    if (r != null) {
      mNoAnimActivities.add(r);
    }
  }
 else {
    mService.mWindowManager.prepareAppTransition(WindowManagerPolicy.TRANSIT_TASK_TO_FRONT);
  }
  mService.mWindowManager.moveAppTokensToTop(moved);
  if (VALIDATE_TOKENS) {
    mService.mWindowManager.validateAppTokens(mHistory);
  }
  finishTaskMoveLocked(task);
  EventLog.writeEvent(EventLogTags.AM_TASK_TO_FRONT,task);
}
