{
  if (r.finishing) {
    Slog.w(TAG,"Duplicate finish request for " + r);
    return false;
  }
  r.finishing=true;
  EventLog.writeEvent(EventLogTags.AM_FINISH_ACTIVITY,System.identityHashCode(r),r.task.taskId,r.shortComponentName,reason);
  r.task.numActivities--;
  if (index < (mHistory.size() - 1)) {
    ActivityRecord next=(ActivityRecord)mHistory.get(index + 1);
    if (next.task == r.task) {
      if (r.frontOfTask) {
        next.frontOfTask=true;
      }
      if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET) != 0) {
        next.intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);
      }
    }
  }
  r.pauseKeyDispatchingLocked();
  if (mMainStack) {
    if (mService.mFocusedActivity == r) {
      mService.setFocusedActivityLocked(topRunningActivityLocked(null));
    }
  }
  ActivityRecord resultTo=r.resultTo;
  if (resultTo != null) {
    if (DEBUG_RESULTS)     Slog.v(TAG,"Adding result to " + resultTo + " who="+ r.resultWho+ " req="+ r.requestCode+ " res="+ resultCode+ " data="+ resultData);
    if (r.info.applicationInfo.uid > 0) {
      mService.grantUriPermissionFromIntentLocked(r.info.applicationInfo.uid,resultTo.packageName,resultData,resultTo.getUriPermissionsLocked());
    }
    resultTo.addResultLocked(r,r.resultWho,r.requestCode,resultCode,resultData);
    r.resultTo=null;
  }
 else   if (DEBUG_RESULTS)   Slog.v(TAG,"No result destination from " + r);
  r.results=null;
  r.pendingResults=null;
  r.newIntents=null;
  r.icicle=null;
  if (mService.mPendingThumbnails.size() > 0) {
    mService.mCancelledThumbnails.add(r);
  }
  if (mResumedActivity == r) {
    boolean endTask=index <= 0 || ((ActivityRecord)mHistory.get(index - 1)).task != r.task;
    if (DEBUG_TRANSITION)     Slog.v(TAG,"Prepare close transition: finishing " + r);
    mService.mWindowManager.prepareAppTransition(endTask ? WindowManagerPolicy.TRANSIT_TASK_CLOSE : WindowManagerPolicy.TRANSIT_ACTIVITY_CLOSE,false);
    mService.mWindowManager.setAppVisibility(r,false);
    if (mPausingActivity == null) {
      if (DEBUG_PAUSE)       Slog.v(TAG,"Finish needs to pause: " + r);
      if (DEBUG_USER_LEAVING)       Slog.v(TAG,"finish() => pause with userLeaving=false");
      startPausingLocked(false,false);
    }
  }
 else   if (r.state != ActivityState.PAUSING) {
    if (DEBUG_PAUSE)     Slog.v(TAG,"Finish not pausing: " + r);
    return finishCurrentActivityLocked(r,index,FINISH_AFTER_PAUSE) == null;
  }
 else {
    if (DEBUG_PAUSE)     Slog.v(TAG,"Finish waiting for pause of: " + r);
  }
  return false;
}
