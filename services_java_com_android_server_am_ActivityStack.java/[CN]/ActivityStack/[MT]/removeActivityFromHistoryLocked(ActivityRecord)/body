{
  if (r.state != ActivityState.DESTROYED) {
    r.makeFinishing();
    if (DEBUG_ADD_REMOVE) {
      RuntimeException here=new RuntimeException("here");
      here.fillInStackTrace();
      Slog.i(TAG,"Removing activity " + r + " from stack");
    }
    mHistory.remove(r);
    r.takeFromHistory();
    if (DEBUG_STATES)     Slog.v(TAG,"Moving to DESTROYED: " + r + " (removed from history)");
    r.state=ActivityState.DESTROYED;
    mService.mWindowManager.removeAppToken(r);
    if (VALIDATE_TOKENS) {
      mService.mWindowManager.validateAppTokens(mHistory);
    }
    cleanUpActivityServicesLocked(r);
    r.removeUriPermissionsLocked();
  }
}
