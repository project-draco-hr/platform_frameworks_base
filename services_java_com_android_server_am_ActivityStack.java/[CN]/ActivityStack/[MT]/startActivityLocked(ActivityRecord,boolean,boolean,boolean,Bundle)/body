{
  mLastHistoryModifier="startActivityLocked";
  final int NH=mHistory.size();
  int addPos=-1;
  boolean fakeStartIt=true;
  boolean wouldReturn=false;
  if (VALIDATE_TASK_REPLACE) {
    verifyActivityRecords(true);
  }
  TaskRecord task=null;
  if (!newTask) {
    for (int i=NH - 1; i >= 0 && !wouldReturn; i--) {
      ActivityRecord p=mHistory.get(i);
      if (p.task == r.task) {
        addPos=i + 1;
        if (!fakeStartIt) {
          mHistory.add(addPos,r);
          wouldReturn=true;
        }
        break;
      }
      if (p.fullscreen) {
        fakeStartIt=false;
      }
    }
    boolean startIt=true;
    for (int taskNdx=mTaskHistory.size() - 1; taskNdx >= 0; --taskNdx) {
      task=mTaskHistory.get(taskNdx);
      if (task == r.task) {
        if (fakeStartIt != startIt)         Slog.w(TAG,"Mismatch! fakeStartIt != startIt");
        if (!startIt) {
          if (DEBUG_ADD_REMOVE)           Slog.i(TAG,"Adding activity " + r + " to task "+ task,new RuntimeException("here").fillInStackTrace());
          task.addActivityToTop(r);
          if (mHistory.get(addPos) != r) {
            Slog.w(TAG,"Mismatch! mHistory(" + addPos + ") != "+ r);
          }
          r.putInHistory();
          mService.mWindowManager.addAppToken(task.mActivities.indexOf(r),r.appToken,r.task.taskId,r.info.screenOrientation,r.fullscreen,(r.info.flags & ActivityInfo.FLAG_SHOW_ON_LOCK_SCREEN) != 0);
          if (VALIDATE_TASK_REPLACE) {
            verifyActivityRecords(true);
          }
          if (VALIDATE_TOKENS) {
            validateAppTokensLocked();
          }
          ActivityOptions.abort(options);
          if (!wouldReturn) {
            Slog.w(TAG,"Mismatch! !wouldReturn");
          }
          return;
        }
        break;
      }
 else       if (task.numFullscreen > 0) {
        startIt=false;
      }
    }
    if (wouldReturn) {
      Slog.w(TAG,"Mismatch! wouldReturn");
    }
  }
 else   if (mTaskIdToTaskRecord.indexOfKey(r.task.taskId) >= 0) {
    mTaskHistory.remove(r.task);
    mTaskHistory.add(r.task);
    mService.mWindowManager.moveTaskToTop(r.task.taskId);
  }
  boolean wasLessThan0=false;
  if (addPos < 0) {
    wasLessThan0=true;
    addPos=NH;
  }
  if (task == r.task && mTaskHistory.indexOf(task) != (mTaskHistory.size() - 1)) {
    if (addPos >= NH) {
      Slog.w(TAG,"Mismatch! addPos >= NH");
    }
    mUserLeaving=false;
    if (DEBUG_USER_LEAVING)     Slog.v(TAG,"startActivity() behind front, mUserLeaving=false");
  }
 else   if (addPos < NH) {
    Slog.w(TAG,"Mismatch! addPos < NH");
  }
  task=r.task;
  if (DEBUG_ADD_REMOVE)   Slog.i(TAG,"Adding activity " + r + " to stack to task "+ task,new RuntimeException("here").fillInStackTrace());
  task.addActivityToTop(r);
  if (!wouldReturn) {
    mHistory.add(addPos,r);
    for (int i=addPos - 1; i >= 0; --i) {
      ActivityRecord test=mHistory.get(i);
      if (test.task == task) {
        mHistory.add(addPos,test);
        mHistory.remove(i);
        --addPos;
      }
    }
  }
  r.putInHistory();
  r.frontOfTask=newTask;
  if (VALIDATE_TASK_REPLACE) {
    verifyActivityRecords(false);
  }
  if (numActivities() > 1) {
    boolean showStartingIcon=newTask;
    ProcessRecord proc=r.app;
    if (proc == null) {
      proc=mService.mProcessNames.get(r.processName,r.info.applicationInfo.uid);
    }
    if (proc == null || proc.thread == null) {
      showStartingIcon=true;
    }
    if (DEBUG_TRANSITION)     Slog.v(TAG,"Prepare open transition: starting " + r);
    if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_NO_ANIMATION) != 0) {
      mService.mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE,keepCurTransition);
      mNoAnimActivities.add(r);
    }
 else {
      mService.mWindowManager.prepareAppTransition(newTask ? AppTransition.TRANSIT_TASK_OPEN : AppTransition.TRANSIT_ACTIVITY_OPEN,keepCurTransition);
      mNoAnimActivities.remove(r);
    }
    r.updateOptionsLocked(options);
    mService.mWindowManager.addAppToken(task.mActivities.indexOf(r),r.appToken,r.task.taskId,r.info.screenOrientation,r.fullscreen,(r.info.flags & ActivityInfo.FLAG_SHOW_ON_LOCK_SCREEN) != 0);
    boolean doShow=true;
    if (newTask) {
      if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != 0) {
        resetTaskIfNeededLocked(r,r);
        doShow=topRunningNonDelayedActivityLocked(null) == r;
      }
    }
    if (SHOW_APP_STARTING_PREVIEW && doShow) {
      ActivityRecord prev=mResumedActivity;
      if (prev != null) {
        if (prev.task != r.task)         prev=null;
 else         if (prev.nowVisible)         prev=null;
      }
      mService.mWindowManager.setAppStartingWindow(r.appToken,r.packageName,r.theme,mService.compatibilityInfoForPackageLocked(r.info.applicationInfo),r.nonLocalizedLabel,r.labelRes,r.icon,r.windowFlags,prev != null ? prev.appToken : null,showStartingIcon);
    }
  }
 else {
    mService.mWindowManager.addAppToken(task.mActivities.indexOf(r),r.appToken,r.task.taskId,r.info.screenOrientation,r.fullscreen,(r.info.flags & ActivityInfo.FLAG_SHOW_ON_LOCK_SCREEN) != 0);
    ActivityOptions.abort(options);
  }
  if (VALIDATE_TOKENS) {
    validateAppTokensLocked();
  }
  if (doResume) {
    resumeTopActivityLocked(null);
  }
  if (VALIDATE_TASK_REPLACE) {
    verifyActivityRecords(true);
  }
}
