{
  if (mPausingActivity != null) {
    RuntimeException e=new RuntimeException();
    Slog.e(TAG,"Trying to pause when pause is already pending for " + mPausingActivity,e);
  }
  ActivityRecord prev=mResumedActivity;
  if (prev == null) {
    RuntimeException e=new RuntimeException();
    Slog.e(TAG,"Trying to pause when nothing is resumed",e);
    resumeTopActivityLocked(null);
    return;
  }
  if (DEBUG_STATES)   Slog.v(TAG,"Moving to PAUSING: " + prev);
 else   if (DEBUG_PAUSE)   Slog.v(TAG,"Start pausing: " + prev);
  mResumedActivity=null;
  mPausingActivity=prev;
  mLastPausedActivity=prev;
  prev.state=ActivityState.PAUSING;
  prev.task.touchActiveTime();
  prev.updateThumbnail(screenshotActivities(prev),null);
  mService.updateCpuStats();
  if (prev.app != null && prev.app.thread != null) {
    if (DEBUG_PAUSE)     Slog.v(TAG,"Enqueueing pending pause: " + prev);
    try {
      EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,System.identityHashCode(prev),prev.shortComponentName);
      prev.app.thread.schedulePauseActivity(prev.appToken,prev.finishing,userLeaving,prev.configChangeFlags);
      if (mMainStack) {
        mService.updateUsageStats(prev,false);
      }
    }
 catch (    Exception e) {
      Slog.w(TAG,"Exception thrown during pause",e);
      mPausingActivity=null;
      mLastPausedActivity=null;
    }
  }
 else {
    mPausingActivity=null;
    mLastPausedActivity=null;
  }
  if (!mService.mSleeping && !mService.mShuttingDown) {
    mLaunchingActivity.acquire();
    if (!mHandler.hasMessages(LAUNCH_TIMEOUT_MSG)) {
      Message msg=mHandler.obtainMessage(LAUNCH_TIMEOUT_MSG);
      mHandler.sendMessageDelayed(msg,LAUNCH_TIMEOUT);
    }
  }
  if (mPausingActivity != null) {
    if (!uiSleeping) {
      prev.pauseKeyDispatchingLocked();
    }
 else {
      if (DEBUG_PAUSE)       Slog.v(TAG,"Key dispatch not paused for screen off");
    }
    Message msg=mHandler.obtainMessage(PAUSE_TIMEOUT_MSG);
    msg.obj=prev;
    prev.pauseTime=SystemClock.uptimeMillis();
    mHandler.sendMessageDelayed(msg,PAUSE_TIMEOUT);
    if (DEBUG_PAUSE)     Slog.v(TAG,"Waiting for pause to complete...");
  }
 else {
    if (DEBUG_PAUSE)     Slog.v(TAG,"Activity not running, resuming next.");
    resumeTopActivityLocked(null);
  }
}
