{
  Intent intent=target.intent;
  ActivityInfo info=target.info;
  ComponentName cls=intent.getComponent();
  if (info.targetActivity != null) {
    cls=new ComponentName(info.packageName,info.targetActivity);
  }
  final int userId=UserHandle.getUserId(info.applicationInfo.uid);
  if (DEBUG_TASKS)   Slog.d(TAG,"Looking for task of " + target + " in "+ this);
  for (int taskNdx=mTaskHistory.size() - 1; taskNdx >= 0; --taskNdx) {
    final TaskRecord task=mTaskHistory.get(taskNdx);
    if (task.userId != userId) {
      if (DEBUG_TASKS)       Slog.d(TAG,"Skipping " + task + ": different user");
      continue;
    }
    final ActivityRecord r=task.getTopActivity();
    if (r == null || r.finishing || r.userId != userId || r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) {
      if (DEBUG_TASKS)       Slog.d(TAG,"Skipping " + task + ": mismatch root "+ r);
      continue;
    }
    if (DEBUG_TASKS)     Slog.d(TAG,"Comparing existing cls=" + r.task.intent.getComponent().flattenToShortString() + "/aff="+ r.task.affinity+ " to new cls="+ intent.getComponent().flattenToShortString()+ "/aff="+ info.taskAffinity);
    if (task.affinity != null) {
      if (task.affinity.equals(info.taskAffinity)) {
        if (DEBUG_TASKS)         Slog.d(TAG,"Found matching affinity!");
        return r;
      }
    }
 else     if (task.intent != null && task.intent.getComponent().equals(cls)) {
      if (DEBUG_TASKS)       Slog.d(TAG,"Found matching class!");
      if (DEBUG_TASKS)       Slog.d(TAG,"For Intent " + intent + " bringing to top: "+ r.intent);
      return r;
    }
 else     if (task.affinityIntent != null && task.affinityIntent.getComponent().equals(cls)) {
      if (DEBUG_TASKS)       Slog.d(TAG,"Found matching class!");
      if (DEBUG_TASKS)       Slog.d(TAG,"For Intent " + intent + " bringing to top: "+ r.intent);
      return r;
    }
 else     if (DEBUG_TASKS) {
      Slog.d(TAG,"Not a match: " + task);
    }
  }
  return null;
}
