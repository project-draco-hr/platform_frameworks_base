{
  long now=SystemClock.elapsedRealtime();
  if ((mWifiEnabled) && (mWifiLastScanResults == null || ((now - mLastWifiScanElapsedTime) > mWifiScanFrequency))) {
    boolean fallback=false;
    if (mLastWifiScanTriggerTime != 0 && ((now - mLastWifiScanTriggerTime) < mWifiScanFrequency)) {
      if ((now - mLastWifiScanTriggerTime) > MAX_TIME_TO_WAIT_FOR_RADIO) {
        log("getLocation(): falling back to cell");
        fallback=true;
      }
 else {
        return false;
      }
    }
    WifiManager wifiManager=(WifiManager)mContext.getSystemService(Context.WIFI_SERVICE);
    log("getLocation(): triggering a wifi scan");
    mLastWifiScanTriggerTime=now;
    boolean succeeded=wifiManager.startScan();
    if (!succeeded) {
      log("getLocation(): wifi scan did not succeed");
      fallback=true;
    }
    if (!fallback) {
      return false;
    }
  }
  if (mLastCellLockTime != 0 && ((now - mLastCellLockTime) < MAX_TIME_TO_WAIT_FOR_RADIO)) {
    return false;
  }
  if (mLastCellStateChangeTime > mLastNetworkQueryTime) {
    updateLocation();
    return false;
  }
 else   if ((mLastNetworkQueryTime != 0) && (mLastNetworkQueryTime > mLastSuccessfulNetworkQueryTime) && ((now - mLastNetworkQueryTime) > MIN_NETWORK_RETRY_MILLIS)) {
    updateLocation();
    return false;
  }
  if (mLocation != null && mLocation.getAccuracy() > 0) {
    long currentTime=System.currentTimeMillis();
    if ((mLocation.getTime() + mWifiScanFrequency) < currentTime) {
      mLocation.setTime(currentTime);
    }
    l.set(mLocation);
    return true;
  }
 else {
    return false;
  }
}
