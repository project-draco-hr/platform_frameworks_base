{
  String[] projection={TvContract.WatchedPrograms.COLUMN_WATCH_END_TIME_UTC_MILLIS};
  Cursor cursor=null;
  try {
    cursor=mContentResolver.query(uri,projection,null,null,null);
    if (cursor != null && cursor.moveToNext()) {
      long watchEndTime=cursor.getLong(0);
      if (watchEndTime > 0) {
        return;
      }
      ContentValues values=new ContentValues();
      values.put(TvContract.WatchedPrograms.COLUMN_WATCH_END_TIME_UTC_MILLIS,time);
      int c=mContentResolver.update(uri,values,null,null);
    }
 else {
synchronized (mLock) {
        if (!uri.equals(sessionState.mLogUri)) {
          return;
        }
      }
    }
    if (cursor != null) {
      cursor.close();
      cursor=null;
    }
    uri=ContentUris.withAppendedId(TvContract.Channels.CONTENT_URI,channelId);
    projection=new String[]{TvContract.Channels.COLUMN_PACKAGE_NAME};
    cursor=mContentResolver.query(uri,projection,null,null,null);
    if (cursor != null && cursor.moveToNext()) {
      ContentValues values=new ContentValues();
      values.put(TvContract.WatchedPrograms.COLUMN_PACKAGE_NAME,cursor.getString(0));
      values.put(TvContract.WatchedPrograms.COLUMN_WATCH_START_TIME_UTC_MILLIS,time);
      values.put(TvContract.WatchedPrograms.COLUMN_WATCH_END_TIME_UTC_MILLIS,0);
      values.put(TvContract.WatchedPrograms.COLUMN_CHANNEL_ID,channelId);
      Uri newUri=mContentResolver.insert(TvContract.WatchedPrograms.CONTENT_URI,values);
synchronized (mLock) {
        sessionState.mLogUri=newUri;
      }
      onOpenEntry(newUri,channelId,time,sessionState);
    }
  }
  finally {
    if (cursor != null) {
      cursor.close();
    }
  }
}
