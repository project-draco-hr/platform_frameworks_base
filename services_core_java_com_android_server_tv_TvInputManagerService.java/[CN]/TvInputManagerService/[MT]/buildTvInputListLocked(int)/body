{
  UserState userState=getUserStateLocked(userId);
  Map<String,TvInputState> oldInputMap=userState.inputMap;
  userState.inputMap=new HashMap<String,TvInputState>();
  userState.packageSet.clear();
  if (DEBUG)   Slog.d(TAG,"buildTvInputList");
  PackageManager pm=mContext.getPackageManager();
  List<ResolveInfo> services=pm.queryIntentServices(new Intent(TvInputService.SERVICE_INTERFACE),PackageManager.GET_SERVICES | PackageManager.GET_META_DATA);
  for (  ResolveInfo ri : services) {
    ServiceInfo si=ri.serviceInfo;
    if (!android.Manifest.permission.BIND_TV_INPUT.equals(si.permission)) {
      Slog.w(TAG,"Skipping TV input " + si.name + ": it does not require the permission "+ android.Manifest.permission.BIND_TV_INPUT);
      continue;
    }
    try {
      TvInputInfo info=TvInputInfo.createTvInputInfo(mContext,ri);
      if (DEBUG)       Slog.d(TAG,"add " + info.getId());
      TvInputState state=oldInputMap.get(info.getId());
      if (state == null) {
        state=new TvInputState();
      }
      userState.inputMap.put(info.getId(),state);
      state.mInfo=info;
      userState.packageSet.add(si.packageName);
      updateServiceConnectionLocked(info.getId(),userId);
    }
 catch (    IOException|XmlPullParserException e) {
      Slog.e(TAG,"Can't load TV input " + si.name,e);
    }
  }
  oldInputMap.clear();
}
