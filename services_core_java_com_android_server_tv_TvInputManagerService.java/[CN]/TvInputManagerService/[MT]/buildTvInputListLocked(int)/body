{
  UserState userState=getUserStateLocked(userId);
  Map<String,TvInputState> inputMap=new HashMap<String,TvInputState>();
  userState.packageSet.clear();
  if (DEBUG)   Slog.d(TAG,"buildTvInputList");
  PackageManager pm=mContext.getPackageManager();
  List<ResolveInfo> services=pm.queryIntentServices(new Intent(TvInputService.SERVICE_INTERFACE),PackageManager.GET_SERVICES | PackageManager.GET_META_DATA);
  List<TvInputInfo> inputList=new ArrayList<TvInputInfo>();
  for (  ResolveInfo ri : services) {
    ServiceInfo si=ri.serviceInfo;
    if (!android.Manifest.permission.BIND_TV_INPUT.equals(si.permission)) {
      Slog.w(TAG,"Skipping TV input " + si.name + ": it does not require the permission "+ android.Manifest.permission.BIND_TV_INPUT);
      continue;
    }
    try {
      inputList.clear();
      ComponentName component=new ComponentName(si.packageName,si.name);
      if (hasHardwarePermission(pm,component)) {
        ServiceState serviceState=userState.serviceStateMap.get(component);
        if (serviceState == null) {
          serviceState=new ServiceState(component,userId);
          userState.serviceStateMap.put(component,serviceState);
        }
 else {
          inputList.addAll(serviceState.mInputList);
        }
      }
 else {
        inputList.add(TvInputInfo.createTvInputInfo(mContext,ri));
      }
      for (      TvInputInfo info : inputList) {
        if (DEBUG)         Slog.d(TAG,"add " + info.getId());
        TvInputState state=userState.inputMap.get(info.getId());
        if (state == null) {
          state=new TvInputState();
        }
        state.mInfo=info;
        inputMap.put(info.getId(),state);
      }
      updateServiceConnectionLocked(component,userId);
      userState.packageSet.add(si.packageName);
    }
 catch (    IOException|XmlPullParserException e) {
      Slog.e(TAG,"Can't load TV input " + si.name,e);
    }
  }
  for (  String inputId : inputMap.keySet()) {
    if (!userState.inputMap.containsKey(inputId)) {
      notifyInputAddedLocked(userState,inputId);
    }
  }
  for (  String inputId : userState.inputMap.keySet()) {
    if (!inputMap.containsKey(inputId)) {
      notifyInputRemovedLocked(userState,inputId);
    }
  }
  userState.inputMap.clear();
  userState.inputMap=inputMap;
}
