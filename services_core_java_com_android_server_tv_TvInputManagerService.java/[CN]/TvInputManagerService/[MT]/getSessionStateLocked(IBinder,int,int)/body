{
  UserState userState=getUserStateLocked(userId);
  SessionState sessionState=userState.sessionStateMap.get(sessionToken);
  if (sessionState == null) {
    throw new SessionNotFoundException("Session state not found for token " + sessionToken);
  }
  if (callingUid != Process.SYSTEM_UID && callingUid != sessionState.callingUid) {
    throw new SecurityException("Illegal access to the session with token " + sessionToken + " from uid "+ callingUid);
  }
  return sessionState;
}
