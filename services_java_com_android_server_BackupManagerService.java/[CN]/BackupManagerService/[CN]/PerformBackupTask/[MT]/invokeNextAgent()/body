{
  mStatus=BackupConstants.TRANSPORT_OK;
  if (mQueue.isEmpty()) {
    Slog.e(TAG,"Running queue but it's empty!");
    executeNextState(BackupState.FINAL);
    return;
  }
  BackupRequest request=mQueue.get(0);
  mQueue.remove(0);
  Slog.d(TAG,"starting agent for backup of " + request);
  try {
    mCurrentPackage=mPackageManager.getPackageInfo(request.packageName,PackageManager.GET_SIGNATURES);
    IBackupAgent agent=null;
    try {
      mWakelock.setWorkSource(new WorkSource(mCurrentPackage.applicationInfo.uid));
      agent=bindToAgentSynchronous(mCurrentPackage.applicationInfo,IApplicationThread.BACKUP_MODE_INCREMENTAL);
      if (agent != null) {
        mStatus=invokeAgentForBackup(request.packageName,agent,mTransport);
      }
 else {
        mStatus=BackupConstants.AGENT_ERROR;
      }
    }
 catch (    SecurityException ex) {
      Slog.d(TAG,"error in bind/backup",ex);
      mStatus=BackupConstants.AGENT_ERROR;
    }
  }
 catch (  NameNotFoundException e) {
    Slog.d(TAG,"Package does not exist; skipping");
  }
 finally {
    mWakelock.setWorkSource(null);
    if (mStatus != BackupConstants.TRANSPORT_OK) {
      BackupState nextState=BackupState.RUNNING_QUEUE;
      if (mStatus == BackupConstants.AGENT_ERROR) {
        if (MORE_DEBUG)         Slog.i(TAG,"Agent failure for " + request.packageName + " - restaging");
        dataChangedImpl(request.packageName);
        mStatus=BackupConstants.TRANSPORT_OK;
        if (mQueue.isEmpty())         nextState=BackupState.FINAL;
      }
 else       if (mStatus != BackupConstants.TRANSPORT_OK) {
        revertAndEndBackup();
        nextState=BackupState.FINAL;
      }
      executeNextState(nextState);
    }
  }
}
