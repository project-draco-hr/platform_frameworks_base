{
  if (MORE_DEBUG)   Slog.v(TAG,"operationComplete(): sending data to transport for " + mCurrentPackage.packageName);
  mBackupHandler.removeMessages(MSG_TIMEOUT);
  clearAgentState();
  addBackupTrace("operation complete");
  ParcelFileDescriptor backupData=null;
  mStatus=BackupConstants.TRANSPORT_OK;
  try {
    int size=(int)mBackupDataName.length();
    if (size > 0) {
      if (mStatus == BackupConstants.TRANSPORT_OK) {
        backupData=ParcelFileDescriptor.open(mBackupDataName,ParcelFileDescriptor.MODE_READ_ONLY);
        addBackupTrace("sending data to transport");
        mStatus=mTransport.performBackup(mCurrentPackage,backupData);
      }
      addBackupTrace("data delivered: " + mStatus);
      if (mStatus == BackupConstants.TRANSPORT_OK) {
        addBackupTrace("finishing op on transport");
        mStatus=mTransport.finishBackup();
        addBackupTrace("finished: " + mStatus);
      }
    }
 else {
      if (DEBUG)       Slog.i(TAG,"no backup data written; not calling transport");
      addBackupTrace("no data to send");
    }
    if (mStatus == BackupConstants.TRANSPORT_OK) {
      mBackupDataName.delete();
      mNewStateName.renameTo(mSavedStateName);
      EventLog.writeEvent(EventLogTags.BACKUP_PACKAGE,mCurrentPackage.packageName,size);
      logBackupComplete(mCurrentPackage.packageName);
    }
 else {
      EventLog.writeEvent(EventLogTags.BACKUP_TRANSPORT_FAILURE,mCurrentPackage.packageName);
    }
  }
 catch (  Exception e) {
    Slog.e(TAG,"Transport error backing up " + mCurrentPackage.packageName,e);
    EventLog.writeEvent(EventLogTags.BACKUP_TRANSPORT_FAILURE,mCurrentPackage.packageName);
    mStatus=BackupConstants.TRANSPORT_ERROR;
  }
 finally {
    try {
      if (backupData != null)       backupData.close();
    }
 catch (    IOException e) {
    }
  }
  final BackupState nextState;
  if (mStatus != BackupConstants.TRANSPORT_OK) {
    revertAndEndBackup();
    nextState=BackupState.FINAL;
  }
 else {
    nextState=(mQueue.isEmpty()) ? BackupState.FINAL : BackupState.RUNNING_QUEUE;
  }
  executeNextState(nextState);
}
