{
  long startRealtime=SystemClock.elapsedRealtime();
  if (DEBUG)   Slog.v(TAG,"Beginning restore process mTransport=" + mTransport + " mObserver="+ mObserver+ " mToken="+ Long.toHexString(mToken)+ " mTargetPackage="+ mTargetPackage+ " mPmToken="+ mPmToken);
  PackageManagerBackupAgent pmAgent=null;
  int error=-1;
  try {
    EventLog.writeEvent(EventLogTags.RESTORE_START,mTransport.transportDirName(),mToken);
    ArrayList<PackageInfo> restorePackages=new ArrayList<PackageInfo>();
    PackageInfo omPackage=new PackageInfo();
    omPackage.packageName=PACKAGE_MANAGER_SENTINEL;
    restorePackages.add(omPackage);
    List<PackageInfo> agentPackages=allAgentPackages();
    if (mTargetPackage == null) {
      restorePackages.addAll(agentPackages);
    }
 else {
      restorePackages.add(mTargetPackage);
    }
    if (mObserver != null) {
      try {
        mObserver.restoreStarting(restorePackages.size());
      }
 catch (      RemoteException e) {
        Slog.d(TAG,"Restore observer died at restoreStarting");
        mObserver=null;
      }
    }
    if (mTransport.startRestore(mToken,restorePackages.toArray(new PackageInfo[0])) != BackupConstants.TRANSPORT_OK) {
      Slog.e(TAG,"Error starting restore operation");
      EventLog.writeEvent(EventLogTags.RESTORE_TRANSPORT_FAILURE);
      return;
    }
    String packageName=mTransport.nextRestorePackage();
    if (packageName == null) {
      Slog.e(TAG,"Error getting first restore package");
      EventLog.writeEvent(EventLogTags.RESTORE_TRANSPORT_FAILURE);
      return;
    }
 else     if (packageName.equals("")) {
      Slog.i(TAG,"No restore data available");
      int millis=(int)(SystemClock.elapsedRealtime() - startRealtime);
      EventLog.writeEvent(EventLogTags.RESTORE_SUCCESS,0,millis);
      return;
    }
 else     if (!packageName.equals(PACKAGE_MANAGER_SENTINEL)) {
      Slog.e(TAG,"Expected restore data for \"" + PACKAGE_MANAGER_SENTINEL + "\", found only \""+ packageName+ "\"");
      EventLog.writeEvent(EventLogTags.RESTORE_AGENT_FAILURE,PACKAGE_MANAGER_SENTINEL,"Package manager data missing");
      return;
    }
    pmAgent=new PackageManagerBackupAgent(mPackageManager,agentPackages);
    processOneRestore(omPackage,0,IBackupAgent.Stub.asInterface(pmAgent.onBind()));
    if (!pmAgent.hasMetadata()) {
      Slog.e(TAG,"No restore metadata available, so not restoring settings");
      EventLog.writeEvent(EventLogTags.RESTORE_AGENT_FAILURE,PACKAGE_MANAGER_SENTINEL,"Package manager restore metadata missing");
      return;
    }
    int count=0;
    for (; ; ) {
      packageName=mTransport.nextRestorePackage();
      if (packageName == null) {
        Slog.e(TAG,"Error getting next restore package");
        EventLog.writeEvent(EventLogTags.RESTORE_TRANSPORT_FAILURE);
        return;
      }
 else       if (packageName.equals("")) {
        if (DEBUG)         Slog.v(TAG,"No next package, finishing restore");
        break;
      }
      if (mObserver != null) {
        try {
          mObserver.onUpdate(count);
        }
 catch (        RemoteException e) {
          Slog.d(TAG,"Restore observer died in onUpdate");
          mObserver=null;
        }
      }
      Metadata metaInfo=pmAgent.getRestoredMetadata(packageName);
      if (metaInfo == null) {
        Slog.e(TAG,"Missing metadata for " + packageName);
        EventLog.writeEvent(EventLogTags.RESTORE_AGENT_FAILURE,packageName,"Package metadata missing");
        continue;
      }
      PackageInfo packageInfo;
      try {
        int flags=PackageManager.GET_SIGNATURES;
        packageInfo=mPackageManager.getPackageInfo(packageName,flags);
      }
 catch (      NameNotFoundException e) {
        Slog.e(TAG,"Invalid package restoring data",e);
        EventLog.writeEvent(EventLogTags.RESTORE_AGENT_FAILURE,packageName,"Package missing on device");
        continue;
      }
      if (metaInfo.versionCode > packageInfo.versionCode) {
        if ((packageInfo.applicationInfo.flags & ApplicationInfo.FLAG_RESTORE_ANY_VERSION) == 0) {
          String message="Version " + metaInfo.versionCode + " > installed version "+ packageInfo.versionCode;
          Slog.w(TAG,"Package " + packageName + ": "+ message);
          EventLog.writeEvent(EventLogTags.RESTORE_AGENT_FAILURE,packageName,message);
          continue;
        }
 else {
          if (DEBUG)           Slog.v(TAG,"Version " + metaInfo.versionCode + " > installed "+ packageInfo.versionCode+ " but restoreAnyVersion");
        }
      }
      if (!signaturesMatch(metaInfo.signatures,packageInfo)) {
        Slog.w(TAG,"Signature mismatch restoring " + packageName);
        EventLog.writeEvent(EventLogTags.RESTORE_AGENT_FAILURE,packageName,"Signature mismatch");
        continue;
      }
      if (DEBUG)       Slog.v(TAG,"Package " + packageName + " restore version ["+ metaInfo.versionCode+ "] is compatible with installed version ["+ packageInfo.versionCode+ "]");
      boolean useRealApp=(packageInfo.applicationInfo.flags & ApplicationInfo.FLAG_RESTORE_NEEDS_APPLICATION) != 0;
      if (DEBUG && useRealApp) {
        Slog.v(TAG,"agent requires real Application subclass for restore");
      }
      IBackupAgent agent=bindToAgentSynchronous(packageInfo.applicationInfo,(useRealApp ? IApplicationThread.BACKUP_MODE_INCREMENTAL : IApplicationThread.BACKUP_MODE_RESTORE));
      if (agent == null) {
        Slog.w(TAG,"Can't find backup agent for " + packageName);
        EventLog.writeEvent(EventLogTags.RESTORE_AGENT_FAILURE,packageName,"Restore agent missing");
        continue;
      }
      try {
        processOneRestore(packageInfo,metaInfo.versionCode,agent);
        ++count;
      }
  finally {
        mActivityManager.unbindBackupAgent(packageInfo.applicationInfo);
        if (mTargetPackage == null && (packageInfo.applicationInfo.flags & ApplicationInfo.FLAG_KILL_AFTER_RESTORE) != 0) {
          if (DEBUG)           Slog.d(TAG,"Restore complete, killing host process of " + packageInfo.applicationInfo.processName);
          mActivityManager.killApplicationProcess(packageInfo.applicationInfo.processName,packageInfo.applicationInfo.uid);
        }
      }
    }
    error=0;
    int millis=(int)(SystemClock.elapsedRealtime() - startRealtime);
    EventLog.writeEvent(EventLogTags.RESTORE_SUCCESS,count,millis);
  }
 catch (  Exception e) {
    Slog.e(TAG,"Error in restore thread",e);
  }
 finally {
    if (DEBUG)     Slog.d(TAG,"finishing restore mObserver=" + mObserver);
    try {
      mTransport.finishRestore();
    }
 catch (    RemoteException e) {
      Slog.e(TAG,"Error finishing restore",e);
    }
    if (mObserver != null) {
      try {
        mObserver.restoreFinished(error);
      }
 catch (      RemoteException e) {
        Slog.d(TAG,"Restore observer died at restoreFinished");
      }
    }
    if (mTargetPackage == null && pmAgent != null) {
      mAncestralPackages=pmAgent.getRestoredPackages();
      mAncestralToken=mToken;
      writeRestoreTokens();
    }
    if (mPmToken > 0) {
      if (DEBUG)       Slog.v(TAG,"finishing PM token " + mPmToken);
      try {
        mPackageManagerBinder.finishPackageInstall(mPmToken);
      }
 catch (      RemoteException e) {
      }
    }
    mWakelock.release();
  }
}
