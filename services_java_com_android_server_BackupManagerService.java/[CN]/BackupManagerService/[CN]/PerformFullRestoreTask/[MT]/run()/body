{
  Slog.i(TAG,"--- Performing full-dataset restore ---");
  sendStartRestore();
  if (Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED)) {
    mPackagePolicies.put("com.android.sharedstoragebackup",RestorePolicy.ACCEPT);
  }
  try {
    mBytes=0;
    byte[] buffer=new byte[32 * 1024];
    FileInputStream instream=new FileInputStream(mInputFile.getFileDescriptor());
    boolean didRestore;
    do {
      didRestore=restoreOneFile(instream,buffer);
    }
 while (didRestore);
    if (DEBUG)     Slog.v(TAG,"Done consuming input tarfile, total bytes=" + mBytes);
  }
  finally {
    tearDownPipes();
    tearDownAgent(mTargetApp);
    try {
      mInputFile.close();
    }
 catch (    IOException e) {
      Slog.w(TAG,"Close of restore data pipe threw",e);
    }
synchronized (mCurrentOpLock) {
      mCurrentOperations.clear();
    }
synchronized (mLatchObject) {
      mLatchObject.set(true);
      mLatchObject.notifyAll();
    }
    sendEndRestore();
    mWakelock.release();
    if (DEBUG)     Slog.d(TAG,"Full restore pass complete.");
  }
}
