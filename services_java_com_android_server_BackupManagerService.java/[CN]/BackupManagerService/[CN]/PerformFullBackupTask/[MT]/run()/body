{
  List<PackageInfo> packagesToBackup=new ArrayList<PackageInfo>();
  Slog.i(TAG,"--- Performing full-dataset backup ---");
  sendStartBackup();
  if (mAllApps) {
    packagesToBackup=mPackageManager.getInstalledPackages(PackageManager.GET_SIGNATURES);
    if (mIncludeSystem == false) {
      for (int i=0; i < packagesToBackup.size(); ) {
        PackageInfo pkg=packagesToBackup.get(i);
        if ((pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) != 0) {
          packagesToBackup.remove(i);
        }
 else {
          i++;
        }
      }
    }
  }
  if (mPackages != null) {
    for (    String pkgName : mPackages) {
      try {
        packagesToBackup.add(mPackageManager.getPackageInfo(pkgName,PackageManager.GET_SIGNATURES));
      }
 catch (      NameNotFoundException e) {
        Slog.w(TAG,"Unknown package " + pkgName + ", skipping");
      }
    }
  }
  for (int i=0; i < packagesToBackup.size(); ) {
    PackageInfo pkg=packagesToBackup.get(i);
    if ((pkg.applicationInfo.flags & ApplicationInfo.FLAG_ALLOW_BACKUP) == 0 || pkg.packageName.equals(SHARED_BACKUP_AGENT_PACKAGE)) {
      packagesToBackup.remove(i);
    }
 else {
      i++;
    }
  }
  for (int i=0; i < packagesToBackup.size(); ) {
    PackageInfo pkg=packagesToBackup.get(i);
    if ((pkg.applicationInfo.uid < Process.FIRST_APPLICATION_UID) && (pkg.applicationInfo.backupAgentName == null)) {
      if (MORE_DEBUG) {
        Slog.i(TAG,"... ignoring non-agent system package " + pkg.packageName);
      }
      packagesToBackup.remove(i);
    }
 else {
      i++;
    }
  }
  FileOutputStream ofstream=new FileOutputStream(mOutputFile.getFileDescriptor());
  OutputStream out=null;
  PackageInfo pkg=null;
  try {
    boolean encrypting=(mEncryptPassword != null && mEncryptPassword.length() > 0);
    boolean compressing=COMPRESS_FULL_BACKUPS;
    OutputStream finalOutput=ofstream;
    if (hasBackupPassword()) {
      if (!passwordMatchesSaved(mCurrentPassword,PBKDF2_HASH_ROUNDS)) {
        if (DEBUG)         Slog.w(TAG,"Backup password mismatch; aborting");
        return;
      }
    }
    StringBuilder headerbuf=new StringBuilder(1024);
    headerbuf.append(BACKUP_FILE_HEADER_MAGIC);
    headerbuf.append(BACKUP_FILE_VERSION);
    headerbuf.append(compressing ? "\n1\n" : "\n0\n");
    try {
      if (encrypting) {
        finalOutput=emitAesBackupHeader(headerbuf,finalOutput);
      }
 else {
        headerbuf.append("none\n");
      }
      byte[] header=headerbuf.toString().getBytes("UTF-8");
      ofstream.write(header);
      if (compressing) {
        Deflater deflater=new Deflater(Deflater.BEST_COMPRESSION);
        finalOutput=new DeflaterOutputStream(finalOutput,deflater,true);
      }
      out=finalOutput;
    }
 catch (    Exception e) {
      Slog.e(TAG,"Unable to emit archive header",e);
      return;
    }
    if (mIncludeShared) {
      try {
        pkg=mPackageManager.getPackageInfo(SHARED_BACKUP_AGENT_PACKAGE,0);
        packagesToBackup.add(pkg);
      }
 catch (      NameNotFoundException e) {
        Slog.e(TAG,"Unable to find shared-storage backup handler");
      }
    }
    int N=packagesToBackup.size();
    for (int i=0; i < N; i++) {
      pkg=packagesToBackup.get(i);
      backupOnePackage(pkg,out);
    }
    finalizeBackup(out);
  }
 catch (  RemoteException e) {
    Slog.e(TAG,"App died during full backup");
  }
catch (  Exception e) {
    Slog.e(TAG,"Internal exception during full backup",e);
  }
 finally {
    tearDown(pkg);
    try {
      if (out != null)       out.close();
      mOutputFile.close();
    }
 catch (    IOException e) {
    }
synchronized (mCurrentOpLock) {
      mCurrentOperations.clear();
    }
synchronized (mLatchObject) {
      mLatchObject.set(true);
      mLatchObject.notifyAll();
    }
    sendEndBackup();
    if (DEBUG)     Slog.d(TAG,"Full backup pass complete.");
    mWakelock.release();
  }
}
