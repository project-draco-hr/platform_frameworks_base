{
  if (DEBUG)   Log.v(TAG,"Beginning restore process");
  int error=-1;
  try {
    RestoreSet[] images=mTransport.getAvailableRestoreSets();
    if (images == null) {
      Log.e(TAG,"Error getting restore sets");
      return;
    }
    if (images.length == 0) {
      Log.i(TAG,"No restore sets available");
      return;
    }
    mImage=images[0];
    ArrayList<PackageInfo> restorePackages=new ArrayList<PackageInfo>();
    PackageInfo omPackage=new PackageInfo();
    omPackage.packageName=PACKAGE_MANAGER_SENTINEL;
    restorePackages.add(omPackage);
    List<PackageInfo> agentPackages=allAgentPackages();
    restorePackages.addAll(agentPackages);
    if (mObserver != null) {
      try {
        mObserver.restoreStarting(restorePackages.size());
      }
 catch (      RemoteException e) {
        Log.d(TAG,"Restore observer died at restoreStarting");
        mObserver=null;
      }
    }
    if (!mTransport.startRestore(mToken,restorePackages.toArray(new PackageInfo[0]))) {
      Log.e(TAG,"Error starting restore operation");
      return;
    }
    String packageName=mTransport.nextRestorePackage();
    if (packageName == null) {
      Log.e(TAG,"Error getting first restore package");
      return;
    }
 else     if (packageName.equals("")) {
      Log.i(TAG,"No restore data available");
      return;
    }
 else     if (!packageName.equals(PACKAGE_MANAGER_SENTINEL)) {
      Log.e(TAG,"Expected restore data for \"" + PACKAGE_MANAGER_SENTINEL + "\", found only \""+ packageName+ "\"");
      return;
    }
    PackageManagerBackupAgent pmAgent=new PackageManagerBackupAgent(mPackageManager,agentPackages);
    processOneRestore(omPackage,0,IBackupAgent.Stub.asInterface(pmAgent.onBind()));
    int count=0;
    for (; ; ) {
      packageName=mTransport.nextRestorePackage();
      if (packageName == null) {
        Log.e(TAG,"Error getting next restore package");
        return;
      }
 else       if (packageName.equals("")) {
        break;
      }
      if (mObserver != null) {
        ++count;
        try {
          mObserver.onUpdate(count);
        }
 catch (        RemoteException e) {
          Log.d(TAG,"Restore observer died in onUpdate");
          mObserver=null;
        }
      }
      Metadata metaInfo=pmAgent.getRestoredMetadata(packageName);
      if (metaInfo == null) {
        Log.e(TAG,"Missing metadata for " + packageName);
        continue;
      }
      int flags=PackageManager.GET_SIGNATURES;
      PackageInfo packageInfo=mPackageManager.getPackageInfo(packageName,flags);
      if (metaInfo.versionCode > packageInfo.versionCode) {
        Log.w(TAG,"Package " + packageName + " restore version ["+ metaInfo.versionCode+ "] is too new for installed version ["+ packageInfo.versionCode+ "]");
        continue;
      }
      if (!signaturesMatch(metaInfo.signatures,packageInfo.signatures)) {
        Log.w(TAG,"Signature mismatch restoring " + packageName);
        continue;
      }
      if (DEBUG)       Log.v(TAG,"Package " + packageName + " restore version ["+ metaInfo.versionCode+ "] is compatible with installed version ["+ packageInfo.versionCode+ "]");
      clearApplicationDataSynchronous(packageName);
      IBackupAgent agent=bindToAgentSynchronous(packageInfo.applicationInfo,IApplicationThread.BACKUP_MODE_RESTORE);
      if (agent == null) {
        Log.w(TAG,"Can't find backup agent for " + packageName);
        continue;
      }
      try {
        processOneRestore(packageInfo,metaInfo.versionCode,agent);
      }
  finally {
        mActivityManager.unbindBackupAgent(packageInfo.applicationInfo);
      }
    }
    error=0;
  }
 catch (  NameNotFoundException e) {
    Log.e(TAG,"Invalid paackage restoring data",e);
  }
catch (  RemoteException e) {
    Log.e(TAG,"Error restoring data",e);
  }
 finally {
    try {
      mTransport.finishRestore();
    }
 catch (    RemoteException e) {
      Log.e(TAG,"Error finishing restore",e);
    }
    if (mObserver != null) {
      try {
        mObserver.restoreFinished(error);
      }
 catch (      RemoteException e) {
        Log.d(TAG,"Restore observer died at restoreFinished");
      }
    }
  }
}
