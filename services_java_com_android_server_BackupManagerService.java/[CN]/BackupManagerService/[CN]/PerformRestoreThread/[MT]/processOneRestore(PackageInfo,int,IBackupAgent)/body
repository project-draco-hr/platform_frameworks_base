{
  final String packageName=app.packageName;
  Log.d(TAG,"processOneRestore packageName=" + packageName);
  File backupDataName=new File(mDataDir,packageName + ".restore");
  backupDataName.delete();
  try {
    ParcelFileDescriptor backupData=ParcelFileDescriptor.open(backupDataName,ParcelFileDescriptor.MODE_READ_WRITE | ParcelFileDescriptor.MODE_CREATE);
    try {
      if (!mTransport.getRestoreData(backupData)) {
        Log.e(TAG,"Error getting restore data for " + packageName);
        return;
      }
    }
  finally {
      backupData.close();
    }
    File newStateName=new File(mStateDir,packageName + ".new");
    ParcelFileDescriptor newState=ParcelFileDescriptor.open(newStateName,ParcelFileDescriptor.MODE_READ_WRITE | ParcelFileDescriptor.MODE_CREATE);
    backupData=ParcelFileDescriptor.open(backupDataName,ParcelFileDescriptor.MODE_READ_ONLY);
    try {
      agent.doRestore(backupData,appVersionCode,newState);
    }
  finally {
      newState.close();
      backupData.close();
    }
    File savedStateName=new File(mStateDir,packageName);
    newStateName.renameTo(savedStateName);
  }
 catch (  Exception e) {
    Log.e(TAG,"Error restoring data for " + packageName,e);
  }
}
