{
  final String packageName=app.packageName;
  File backupDataName=new File(mDataDir,packageName + ".restore");
  backupDataName.delete();
  try {
    ParcelFileDescriptor backupData=ParcelFileDescriptor.open(backupDataName,ParcelFileDescriptor.MODE_READ_WRITE | ParcelFileDescriptor.MODE_CREATE);
    int err=-1;
    try {
      err=mTransport.getRestoreData(mImage.token,app,backupData);
    }
 catch (    RemoteException e) {
    }
 finally {
      backupData.close();
    }
    File newStateName=new File(mStateDir,packageName + ".new");
    ParcelFileDescriptor newState=ParcelFileDescriptor.open(newStateName,ParcelFileDescriptor.MODE_READ_WRITE | ParcelFileDescriptor.MODE_CREATE);
    backupData=ParcelFileDescriptor.open(backupDataName,ParcelFileDescriptor.MODE_READ_ONLY);
    boolean success=false;
    try {
      agent.doRestore(backupData,storedAppVersion,newState);
      success=true;
    }
 catch (    Exception e) {
      Log.e(TAG,"Restore failed for " + packageName);
      e.printStackTrace();
    }
 finally {
      newState.close();
      backupData.close();
    }
    if (success) {
      File savedStateName=new File(mStateDir,packageName);
      newStateName.renameTo(savedStateName);
    }
  }
 catch (  FileNotFoundException fnfe) {
    Log.v(TAG,"Couldn't open file for restore: " + fnfe);
  }
catch (  IOException ioe) {
    Log.e(TAG,"Unable to process restore file: " + ioe);
  }
catch (  Exception e) {
    Log.e(TAG,"Final exception guard in restore:");
    e.printStackTrace();
  }
}
