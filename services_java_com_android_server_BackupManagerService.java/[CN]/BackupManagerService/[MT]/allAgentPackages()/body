{
  int flags=PackageManager.GET_SIGNATURES;
  List<PackageInfo> packages=mPackageManager.getInstalledPackages(flags);
  int N=packages.size();
  for (int a=N - 1; a >= 0; a--) {
    PackageInfo pkg=packages.get(a);
    ApplicationInfo app=pkg.applicationInfo;
    if (((app.flags & ApplicationInfo.FLAG_ALLOW_BACKUP) == 0) || app.backupAgentName == null || (mPackageManager.checkPermission(android.Manifest.permission.BACKUP_DATA,pkg.packageName) != PackageManager.PERMISSION_GRANTED)) {
      packages.remove(a);
    }
  }
  return packages;
}
