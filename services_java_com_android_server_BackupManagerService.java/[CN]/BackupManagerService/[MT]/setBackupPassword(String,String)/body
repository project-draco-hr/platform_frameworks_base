{
  mContext.enforceCallingOrSelfPermission(android.Manifest.permission.BACKUP,"setBackupPassword");
  if (!passwordMatchesSaved(currentPw,PBKDF2_HASH_ROUNDS)) {
    return false;
  }
  if (newPw == null || newPw.isEmpty()) {
    if (mPasswordHashFile.exists()) {
      if (!mPasswordHashFile.delete()) {
        Slog.e(TAG,"Unable to clear backup password");
        return false;
      }
    }
    mPasswordHash=null;
    mPasswordSalt=null;
    return true;
  }
  try {
    byte[] salt=randomBytes(PBKDF2_SALT_SIZE);
    String newPwHash=buildPasswordHash(newPw,salt,PBKDF2_HASH_ROUNDS);
    OutputStream pwf=null, buffer=null;
    DataOutputStream out=null;
    try {
      pwf=new FileOutputStream(mPasswordHashFile);
      buffer=new BufferedOutputStream(pwf);
      out=new DataOutputStream(buffer);
      out.writeInt(salt.length);
      out.write(salt);
      out.writeUTF(newPwHash);
      out.flush();
      mPasswordHash=newPwHash;
      mPasswordSalt=salt;
      return true;
    }
  finally {
      if (out != null)       out.close();
      if (buffer != null)       buffer.close();
      if (pwf != null)       pwf.close();
    }
  }
 catch (  IOException e) {
    Slog.e(TAG,"Unable to set backup password");
  }
  return false;
}
