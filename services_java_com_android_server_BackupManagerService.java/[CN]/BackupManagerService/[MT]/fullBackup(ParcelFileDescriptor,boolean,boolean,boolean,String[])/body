{
  mContext.enforceCallingPermission(android.Manifest.permission.BACKUP,"fullBackup");
  if (!doAllApps) {
    if (!includeShared) {
      if (pkgList == null || pkgList.length == 0) {
        throw new IllegalArgumentException("Backup requested but neither shared nor any apps named");
      }
    }
  }
  if (DEBUG)   Slog.v(TAG,"Requesting full backup: apks=" + includeApks + " shared="+ includeShared+ " all="+ doAllApps+ " pkgs="+ pkgList);
  long oldId=Binder.clearCallingIdentity();
  try {
    FullBackupParams params=new FullBackupParams(fd,includeApks,includeShared,doAllApps,pkgList);
    final int token=generateToken();
synchronized (mFullConfirmations) {
      mFullConfirmations.put(token,params);
    }
    if (DEBUG)     Slog.d(TAG,"Starting backup confirmation UI, token=" + token);
    if (!startConfirmationUi(token,FullBackup.FULL_BACKUP_INTENT_ACTION)) {
      Slog.e(TAG,"Unable to launch full backup confirmation");
      mFullConfirmations.delete(token);
      return;
    }
    mPowerManager.userActivity(SystemClock.uptimeMillis(),false);
    startConfirmationTimeout(token,params);
    if (DEBUG)     Slog.d(TAG,"Waiting for full backup completion...");
    waitForCompletion(params);
  }
  finally {
    try {
      fd.close();
    }
 catch (    IOException e) {
    }
    Binder.restoreCallingIdentity(oldId);
  }
  if (MORE_DEBUG)   Slog.d(TAG,"Full backup done; returning to caller");
}
