{
  final int N=notificationList.size();
  for (int i=N - 1; i >= 0; i--) {
    notificationList.get(i).setRankingProxy(null);
  }
  Collections.sort(notificationList,mPreliminaryComparator);
  for (int i=N - 1; i >= 0; i--) {
    final NotificationRecord record=notificationList.get(i);
    record.setAuthoritativeRank(i);
    final String groupKey=record.getGroupKey();
    boolean isGroupSummary=record.getNotification().getGroup() != null && (record.getNotification().flags & Notification.FLAG_GROUP_SUMMARY) != 0;
    if (isGroupSummary || mProxyByGroupTmp.get(groupKey) == null) {
      mProxyByGroupTmp.put(groupKey,record);
    }
  }
  for (int i=0; i < N; i++) {
    final NotificationRecord record=notificationList.get(i);
    record.setRankingProxy(mProxyByGroupTmp.get(record.getGroupKey()));
  }
  Collections.sort(notificationList,mFinalComparator);
  mProxyByGroupTmp.clear();
}
