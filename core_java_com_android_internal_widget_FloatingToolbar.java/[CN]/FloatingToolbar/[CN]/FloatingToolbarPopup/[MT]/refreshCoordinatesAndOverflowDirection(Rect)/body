{
  refreshViewPort();
  int availableHeightAboveContent=contentRect.top - mViewPort.top - 2 * mMarginVertical;
  int availableHeightBelowContent=mViewPort.bottom - contentRect.bottom - 2 * mMarginVertical;
  int availableHeightThroughContent=mViewPort.bottom - contentRect.top + getToolbarHeightWithVerticalMargin();
  int x=contentRect.centerX() - getWidth() / 2;
  x=Math.max(0,Math.min(x,mViewPort.right - getWidth()));
  int y;
  if (mOverflowPanel == null) {
    if (availableHeightAboveContent > getToolbarHeightWithVerticalMargin()) {
      y=contentRect.top - getToolbarHeightWithVerticalMargin();
    }
 else     if (availableHeightBelowContent > getToolbarHeightWithVerticalMargin()) {
      y=contentRect.bottom;
    }
 else {
      y=Math.max(mViewPort.top,contentRect.top - getToolbarHeightWithVerticalMargin());
    }
  }
 else {
    if (availableHeightAboveContent > mOverflowPanel.getMinimumHeight()) {
      updateOverflowHeight(availableHeightAboveContent);
      y=contentRect.top - getHeight();
      mOverflowDirection=OVERFLOW_DIRECTION_UP;
    }
 else     if (availableHeightAboveContent > getToolbarHeightWithVerticalMargin() && availableHeightThroughContent > mOverflowPanel.getMinimumHeight()) {
      updateOverflowHeight(availableHeightThroughContent);
      y=contentRect.top - getToolbarHeightWithVerticalMargin();
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
 else     if (availableHeightBelowContent > mOverflowPanel.getMinimumHeight()) {
      updateOverflowHeight(availableHeightBelowContent);
      y=contentRect.bottom;
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
 else {
      updateOverflowHeight(mViewPort.height());
      y=mViewPort.bottom - getHeight();
      mOverflowDirection=OVERFLOW_DIRECTION_UP;
    }
    mOverflowPanel.setOverflowDirection(mOverflowDirection);
  }
  mCoords.set(x,y);
}
