{
  refreshViewPort();
  final int x=Math.min(contentRectOnScreen.centerX() - mPopupWindow.getWidth() / 2,mViewPortOnScreen.right - mPopupWindow.getWidth());
  final int y;
  final int availableHeightAboveContent=contentRectOnScreen.top - mViewPortOnScreen.top;
  final int availableHeightBelowContent=mViewPortOnScreen.bottom - contentRectOnScreen.bottom;
  final int margin=2 * mMarginVertical;
  final int toolbarHeightWithVerticalMargin=getLineHeight(mContext) + margin;
  if (!hasOverflow()) {
    if (availableHeightAboveContent >= toolbarHeightWithVerticalMargin) {
      y=contentRectOnScreen.top - toolbarHeightWithVerticalMargin;
    }
 else     if (availableHeightBelowContent >= toolbarHeightWithVerticalMargin) {
      y=contentRectOnScreen.bottom;
    }
 else     if (availableHeightBelowContent >= getLineHeight(mContext)) {
      y=contentRectOnScreen.bottom - mMarginVertical;
    }
 else {
      y=Math.max(mViewPortOnScreen.top,contentRectOnScreen.top - toolbarHeightWithVerticalMargin);
    }
  }
 else {
    final int minimumOverflowHeightWithMargin=calculateOverflowHeight(MIN_OVERFLOW_SIZE) + margin;
    final int availableHeightThroughContentDown=mViewPortOnScreen.bottom - contentRectOnScreen.top + toolbarHeightWithVerticalMargin;
    final int availableHeightThroughContentUp=contentRectOnScreen.bottom - mViewPortOnScreen.top + toolbarHeightWithVerticalMargin;
    if (availableHeightAboveContent >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightAboveContent - margin);
      y=contentRectOnScreen.top - mPopupWindow.getHeight();
      mOpenOverflowUpwards=true;
    }
 else     if (availableHeightAboveContent >= toolbarHeightWithVerticalMargin && availableHeightThroughContentDown >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightThroughContentDown - margin);
      y=contentRectOnScreen.top - toolbarHeightWithVerticalMargin;
      mOpenOverflowUpwards=false;
    }
 else     if (availableHeightBelowContent >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightBelowContent - margin);
      y=contentRectOnScreen.bottom;
      mOpenOverflowUpwards=false;
    }
 else     if (availableHeightBelowContent >= toolbarHeightWithVerticalMargin && mViewPortOnScreen.height() >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightThroughContentUp - margin);
      y=contentRectOnScreen.bottom + toolbarHeightWithVerticalMargin - mPopupWindow.getHeight();
      mOpenOverflowUpwards=true;
    }
 else {
      updateOverflowHeight(mViewPortOnScreen.height() - margin);
      y=mViewPortOnScreen.top;
      mOpenOverflowUpwards=false;
    }
  }
  mParent.getRootView().getLocationOnScreen(mTmpCoords);
  int rootViewLeftOnScreen=mTmpCoords[0];
  int rootViewTopOnScreen=mTmpCoords[1];
  mParent.getRootView().getLocationInWindow(mTmpCoords);
  int rootViewLeftOnWindow=mTmpCoords[0];
  int rootViewTopOnWindow=mTmpCoords[1];
  int windowLeftOnScreen=rootViewLeftOnScreen - rootViewLeftOnWindow;
  int windowTopOnScreen=rootViewTopOnScreen - rootViewTopOnWindow;
  mCoordsOnWindow.set(Math.max(0,x - windowLeftOnScreen),Math.max(0,y - windowTopOnScreen));
}
