{
  refreshViewPort();
  int x=contentRect.centerX() - getWidth() / 2;
  x=Math.max(0,Math.min(x,mViewPort.right - getWidth()));
  int y;
  int availableHeightAboveContent=contentRect.top - mViewPort.top;
  int availableHeightBelowContent=mViewPort.bottom - contentRect.bottom;
  if (mOverflowPanel == null) {
    if (availableHeightAboveContent >= getToolbarHeightWithVerticalMargin()) {
      y=contentRect.top - getToolbarHeightWithVerticalMargin();
    }
 else     if (availableHeightBelowContent >= getToolbarHeightWithVerticalMargin()) {
      y=contentRect.bottom;
    }
 else     if (availableHeightBelowContent >= getEstimatedToolbarHeight(mContext)) {
      y=contentRect.bottom - mMarginVertical;
    }
 else {
      y=Math.max(mViewPort.top,contentRect.top - getToolbarHeightWithVerticalMargin());
    }
  }
 else {
    int margin=2 * mMarginVertical;
    int minimumOverflowHeightWithMargin=mOverflowPanel.getMinimumHeight() + margin;
    int availableHeightThroughContentDown=mViewPort.bottom - contentRect.top + getToolbarHeightWithVerticalMargin();
    int availableHeightThroughContentUp=contentRect.bottom - mViewPort.top + getToolbarHeightWithVerticalMargin();
    if (availableHeightAboveContent >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightAboveContent - margin);
      y=contentRect.top - getHeight();
      mOverflowDirection=OVERFLOW_DIRECTION_UP;
    }
 else     if (availableHeightAboveContent >= getToolbarHeightWithVerticalMargin() && availableHeightThroughContentDown >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightThroughContentDown - margin);
      y=contentRect.top - getToolbarHeightWithVerticalMargin();
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
 else     if (availableHeightBelowContent >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightBelowContent - margin);
      y=contentRect.bottom;
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
 else     if (availableHeightBelowContent >= getToolbarHeightWithVerticalMargin() && mViewPort.height() >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightThroughContentUp - margin);
      y=contentRect.bottom + getToolbarHeightWithVerticalMargin() - getHeight();
      mOverflowDirection=OVERFLOW_DIRECTION_UP;
    }
 else {
      updateOverflowHeight(mViewPort.height() - margin);
      y=mViewPort.top;
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
    mOverflowPanel.setOverflowDirection(mOverflowDirection);
  }
  mCoords.set(x,y);
}
