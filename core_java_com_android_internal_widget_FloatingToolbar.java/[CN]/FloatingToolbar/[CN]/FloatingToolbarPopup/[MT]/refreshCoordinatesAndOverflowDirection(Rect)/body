{
  refreshViewPort();
  int x=contentRectOnScreen.centerX() - getWidth() / 2;
  x=Math.max(0,Math.min(x,mViewPortOnScreen.right - getWidth()));
  int y;
  int availableHeightAboveContent=contentRectOnScreen.top - mViewPortOnScreen.top;
  int availableHeightBelowContent=mViewPortOnScreen.bottom - contentRectOnScreen.bottom;
  if (mOverflowPanel == null) {
    if (availableHeightAboveContent >= getToolbarHeightWithVerticalMargin()) {
      y=contentRectOnScreen.top - getToolbarHeightWithVerticalMargin();
    }
 else     if (availableHeightBelowContent >= getToolbarHeightWithVerticalMargin()) {
      y=contentRectOnScreen.bottom;
    }
 else     if (availableHeightBelowContent >= getEstimatedToolbarHeight(mContext)) {
      y=contentRectOnScreen.bottom - mMarginVertical;
    }
 else {
      y=Math.max(mViewPortOnScreen.top,contentRectOnScreen.top - getToolbarHeightWithVerticalMargin());
    }
  }
 else {
    int margin=2 * mMarginVertical;
    int minimumOverflowHeightWithMargin=mOverflowPanel.getMinimumHeight() + margin;
    int availableHeightThroughContentDown=mViewPortOnScreen.bottom - contentRectOnScreen.top + getToolbarHeightWithVerticalMargin();
    int availableHeightThroughContentUp=contentRectOnScreen.bottom - mViewPortOnScreen.top + getToolbarHeightWithVerticalMargin();
    if (availableHeightAboveContent >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightAboveContent - margin);
      y=contentRectOnScreen.top - getHeight();
      mOverflowDirection=OVERFLOW_DIRECTION_UP;
    }
 else     if (availableHeightAboveContent >= getToolbarHeightWithVerticalMargin() && availableHeightThroughContentDown >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightThroughContentDown - margin);
      y=contentRectOnScreen.top - getToolbarHeightWithVerticalMargin();
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
 else     if (availableHeightBelowContent >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightBelowContent - margin);
      y=contentRectOnScreen.bottom;
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
 else     if (availableHeightBelowContent >= getToolbarHeightWithVerticalMargin() && mViewPortOnScreen.height() >= minimumOverflowHeightWithMargin) {
      updateOverflowHeight(availableHeightThroughContentUp - margin);
      y=contentRectOnScreen.bottom + getToolbarHeightWithVerticalMargin() - getHeight();
      mOverflowDirection=OVERFLOW_DIRECTION_UP;
    }
 else {
      updateOverflowHeight(mViewPortOnScreen.height() - margin);
      y=mViewPortOnScreen.top;
      mOverflowDirection=OVERFLOW_DIRECTION_DOWN;
    }
    mOverflowPanel.setOverflowDirection(mOverflowDirection);
  }
  mParent.getRootView().getLocationOnScreen(mTmpCoords);
  int rootViewLeftOnScreen=mTmpCoords[0];
  int rootViewTopOnScreen=mTmpCoords[1];
  mParent.getRootView().getLocationInWindow(mTmpCoords);
  int rootViewLeftOnWindow=mTmpCoords[0];
  int rootViewTopOnWindow=mTmpCoords[1];
  int windowLeftOnScreen=rootViewLeftOnScreen - rootViewLeftOnWindow;
  int windowTopOnScreen=rootViewTopOnScreen - rootViewTopOnWindow;
  mCoordsOnWindow.set(x - windowLeftOnScreen,y - windowTopOnScreen);
}
