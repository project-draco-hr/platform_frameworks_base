{
  Message msg;
  AsyncResult ar;
  MmiCode mmi;
  mRadioControl.triggerIncomingUssd("0","NOTIFY message");
  msg=mGSMTestHandler.waitForMessage(EVENT_MMI_COMPLETE);
  assertNotNull("Message Time Out",msg);
  ar=(AsyncResult)msg.obj;
  mmi=(MmiCode)ar.result;
  assertFalse(mmi.isUssdRequest());
  mRadioControl.triggerIncomingUssd("1","REQUEST Message");
  msg=mGSMTestHandler.waitForMessage(EVENT_MMI_COMPLETE);
  assertNotNull("Message Time Out",msg);
  ar=(AsyncResult)msg.obj;
  mmi=(MmiCode)ar.result;
  assertTrue(mmi.isUssdRequest());
  mGSMPhone.sendUssdResponse("## TEST: TEST_GSMPhone responding...");
  msg=mGSMTestHandler.waitForMessage(EVENT_MMI_INITIATE);
  assertNotNull("Message Time Out",msg);
  ar=(AsyncResult)msg.obj;
  mmi=(MmiCode)ar.result;
  GsmMmiCode gsmMmi=(GsmMmiCode)mmi;
  assertTrue(gsmMmi.isPendingUSSD());
  msg=mGSMTestHandler.waitForMessage(EVENT_MMI_COMPLETE);
  assertNotNull("Message Time Out",msg);
  ar=(AsyncResult)msg.obj;
  mmi=(MmiCode)ar.result;
  assertNull(ar.exception);
  assertFalse(mmi.isUssdRequest());
  mRadioControl.triggerIncomingUssd("1","REQUEST Message");
  msg=mGSMTestHandler.waitForMessage(EVENT_MMI_COMPLETE);
  assertNotNull("Message Time Out",msg);
  ar=(AsyncResult)msg.obj;
  mmi=(MmiCode)ar.result;
  assertTrue(mmi.isUssdRequest());
  mmi.cancel();
  msg=mGSMTestHandler.waitForMessage(EVENT_MMI_COMPLETE);
  assertNotNull("Message Time Out",msg);
  ar=(AsyncResult)msg.obj;
  mmi=(MmiCode)ar.result;
  assertNull(ar.exception);
  assertEquals(MmiCode.State.CANCELLED,mmi.getState());
  List mmiList=mGSMPhone.getPendingMmiCodes();
  assertEquals(0,mmiList.size());
}
