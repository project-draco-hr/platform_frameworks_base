{
  final Looper me=myLooper();
  if (me == null) {
    throw new RuntimeException("No Looper; Looper.prepare() wasn't called on this thread.");
  }
  final MessageQueue queue=me.mQueue;
  Binder.clearCallingIdentity();
  final long ident=Binder.clearCallingIdentity();
  for (; ; ) {
    Message msg=queue.next();
    if (msg == null) {
      return;
    }
    final Printer logging=me.mLogging;
    if (logging != null) {
      logging.println(">>>>> Dispatching to " + msg.target + " "+ msg.callback+ ": "+ msg.what);
    }
    final long traceTag=me.mTraceTag;
    if (traceTag != 0) {
      Trace.traceBegin(traceTag,msg.target.getTraceName(msg));
    }
    try {
      msg.target.dispatchMessage(msg);
    }
  finally {
      if (traceTag != 0) {
        Trace.traceEnd(traceTag);
      }
    }
    if (logging != null) {
      logging.println("<<<<< Finished to " + msg.target + " "+ msg.callback);
    }
    final long newIdent=Binder.clearCallingIdentity();
    if (ident != newIdent) {
      Log.wtf(TAG,"Thread identity changed from 0x" + Long.toHexString(ident) + " to 0x"+ Long.toHexString(newIdent)+ " while dispatching to "+ msg.target.getClass().getName()+ " "+ msg.callback+ " what="+ msg.what);
    }
    msg.recycleUnchecked();
  }
}
