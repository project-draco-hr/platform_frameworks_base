{
  mStreamingReadyLock.lock();
  mOutputStream=out;
  mStreamingReady.signal();
  mStreamingReadyLock.unlock();
  boolean finished=false;
  while (!finished) {
    DataPacket packet=mBuffer.get();
    if (packet == null) {
      finished=true;
    }
 else {
      write(packet);
    }
    mSignal.packetConsumed();
    mConnectionFailedLock.lock();
    if (mConnectionFailed) {
      if (Config.LOGV) {
        Log.i(LOG_TAG,"stopping loop on error");
      }
      finished=true;
    }
    mConnectionFailedLock.unlock();
  }
  if (Config.LOGV) {
    Log.i(LOG_TAG,"flushing the outputstream...");
  }
  mOutputStream.flush();
}
