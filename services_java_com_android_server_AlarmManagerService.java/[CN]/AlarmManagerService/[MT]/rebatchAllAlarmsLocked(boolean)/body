{
  ArrayList<Batch> oldSet=(ArrayList<Batch>)mAlarmBatches.clone();
  mAlarmBatches.clear();
  final long nowElapsed=SystemClock.elapsedRealtime();
  final int oldBatches=oldSet.size();
  for (int batchNum=0; batchNum < oldBatches; batchNum++) {
    Batch batch=oldSet.get(batchNum);
    final int N=batch.size();
    for (int i=0; i < N; i++) {
      Alarm a=batch.get(i);
      long whenElapsed=convertToElapsed(a.when,a.type);
      long maxElapsed=(a.whenElapsed == a.maxWhen) ? whenElapsed : maxTriggerTime(nowElapsed,whenElapsed,a.repeatInterval);
      setImplLocked(a.type,a.when,whenElapsed,maxElapsed,a.repeatInterval,a.operation,batch.standalone,doValidate,a.workSource);
    }
  }
}
