{
  Alarm a=new Alarm(type,when,whenElapsed,maxWhen,interval,operation,workSource);
  removeLocked(operation);
  final boolean reschedule;
  int whichBatch=(isStandalone) ? -1 : attemptCoalesceLocked(whenElapsed,maxWhen);
  if (whichBatch < 0) {
    Batch batch=new Batch(a);
    batch.standalone=isStandalone;
    if (DEBUG_BATCH) {
      Slog.v(TAG,"Starting new alarm batch " + batch);
    }
    reschedule=addBatchLocked(mAlarmBatches,batch);
  }
 else {
    Batch batch=mAlarmBatches.get(whichBatch);
    reschedule=batch.add(a);
    if (reschedule) {
      mAlarmBatches.remove(whichBatch);
      addBatchLocked(mAlarmBatches,batch);
    }
  }
  if (reschedule) {
    rescheduleKernelAlarmsLocked();
  }
}
