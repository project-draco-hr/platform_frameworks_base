{
  if (DEBUG_BATCH) {
    Slog.v(TAG,"RTC changed; rebatching");
  }
synchronized (mLock) {
    ArrayList<Batch> oldSet=(ArrayList<Batch>)mAlarmBatches.clone();
    mAlarmBatches.clear();
    final long nowElapsed=SystemClock.elapsedRealtime();
    for (    Batch batch : oldSet) {
      final int N=batch.size();
      for (int i=0; i < N; i++) {
        Alarm a=batch.get(i);
        long whenElapsed=convertToElapsed(a.when,a.type);
        long maxElapsed=(a.whenElapsed == a.maxWhen) ? whenElapsed : maxTriggerTime(nowElapsed,whenElapsed,a.repeatInterval);
        if (batch.standalone) {
          a=new Alarm(a.type,a.when,whenElapsed,maxElapsed,a.repeatInterval,a.operation);
          Batch newBatch=new Batch(a);
          newBatch.standalone=true;
          addBatchLocked(mAlarmBatches,newBatch);
        }
 else {
          setImplLocked(a.type,a.when,whenElapsed,maxElapsed,a.repeatInterval,a.operation,false);
        }
      }
    }
  }
}
