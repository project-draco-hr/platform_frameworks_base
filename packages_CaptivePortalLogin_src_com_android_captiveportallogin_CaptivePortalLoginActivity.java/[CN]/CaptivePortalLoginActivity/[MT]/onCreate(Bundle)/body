{
  super.onCreate(savedInstanceState);
  String server=Settings.Global.getString(getContentResolver(),"captive_portal_server");
  if (server == null)   server=DEFAULT_SERVER;
  try {
    mURL=new URL("http",server,"/generate_204");
    final Uri dataUri=getIntent().getData();
    if (!dataUri.getScheme().equals("netid")) {
      throw new MalformedURLException();
    }
    mNetId=Integer.parseInt(dataUri.getSchemeSpecificPart());
    mResponseToken=dataUri.getFragment();
  }
 catch (  MalformedURLException|NumberFormatException e) {
    done(CAPTIVE_PORTAL_APP_RETURN_WANTED_AS_IS);
  }
  final Network network=new Network(mNetId);
  ConnectivityManager.setProcessDefaultNetwork(network);
  final LinkProperties lp=ConnectivityManager.from(this).getLinkProperties(network);
  if (lp != null) {
    final ProxyInfo proxyInfo=lp.getHttpProxy();
    String host="";
    String port="";
    String exclList="";
    Uri pacFileUrl=Uri.EMPTY;
    if (proxyInfo != null) {
      host=proxyInfo.getHost();
      port=Integer.toString(proxyInfo.getPort());
      exclList=proxyInfo.getExclusionListAsString();
      pacFileUrl=proxyInfo.getPacFileUrl();
    }
    Proxy.setHttpProxySystemProperty(host,port,exclList,pacFileUrl);
    Log.v(TAG,"Set proxy system properties to " + proxyInfo);
  }
  setContentView(R.layout.activity_captive_portal_login);
  getActionBar().setDisplayShowHomeEnabled(false);
  final NetworkCapabilities networkCapabilities=ConnectivityManager.from(this).getNetworkCapabilities(network);
  if (networkCapabilities == null) {
    finish();
    return;
  }
  mNetworkCallback=new NetworkCallback(){
    @Override public void onLost(    Network lostNetwork){
      if (network.equals(lostNetwork))       done(CAPTIVE_PORTAL_APP_RETURN_UNWANTED);
    }
  }
;
  final NetworkRequest.Builder builder=new NetworkRequest.Builder();
  for (  int transportType : networkCapabilities.getTransportTypes()) {
    builder.addTransportType(transportType);
  }
  ConnectivityManager.from(this).registerNetworkCallback(builder.build(),mNetworkCallback);
  final WebView myWebView=(WebView)findViewById(R.id.webview);
  myWebView.clearCache(true);
  WebSettings webSettings=myWebView.getSettings();
  webSettings.setJavaScriptEnabled(true);
  myWebView.setWebViewClient(new MyWebViewClient());
  myWebView.setWebChromeClient(new MyWebChromeClient());
  myWebView.loadData("","text/html",null);
}
