{
  LocalSocket socket=null;
  try {
    socket=new LocalSocket();
    LocalSocketAddress address=new LocalSocketAddress(mSocket,LocalSocketAddress.Namespace.RESERVED);
    socket.connect(address);
    mCallbacks.onDaemonConnected();
    InputStream inputStream=socket.getInputStream();
    mOutputStream=socket.getOutputStream();
    byte[] buffer=new byte[4096];
    while (true) {
      int count=inputStream.read(buffer);
      if (count < 0)       break;
      int start=0;
      for (int i=0; i < count; i++) {
        if (buffer[i] == 0) {
          String event=new String(buffer,start,i - start);
          String[] tokens=event.split(" ");
          try {
            int code=Integer.parseInt(tokens[0]);
            if (code >= ResponseCode.UnsolicitedInformational) {
              try {
                if (!mCallbacks.onEvent(code,event,tokens)) {
                  Log.w(TAG,String.format("Unhandled event (%s)",event));
                }
              }
 catch (              Exception ex) {
                Log.e(TAG,String.format("Error handling '%s'",event),ex);
              }
            }
 else {
              try {
                mResponseQueue.put(event);
              }
 catch (              InterruptedException ex) {
                Log.e(TAG,"Failed to put response onto queue",ex);
              }
            }
          }
 catch (          NumberFormatException nfe) {
            Log.w(TAG,String.format("Bad msg (%s)",event));
          }
          start=i + 1;
        }
      }
    }
  }
 catch (  IOException ex) {
    Log.e(TAG,"Communications error",ex);
  }
synchronized (this) {
    if (mOutputStream != null) {
      try {
        mOutputStream.close();
      }
 catch (      IOException e) {
        Log.w(TAG,"Failed closing output stream",e);
      }
      mOutputStream=null;
    }
  }
  try {
    if (socket != null) {
      socket.close();
    }
  }
 catch (  IOException ex) {
    Log.w(TAG,"Failed closing socket",ex);
  }
  Log.e(TAG,"Failed to connect to native daemon",new IllegalStateException());
  SystemClock.sleep(5000);
}
