{
  if (state == null)   return;
  FragmentManagerState fms=(FragmentManagerState)state;
  if (fms.mActive == null)   return;
  if (nonConfig != null) {
    for (int i=0; i < nonConfig.size(); i++) {
      Fragment f=nonConfig.get(i);
      if (DEBUG)       Log.v(TAG,"restoreAllState: re-attaching retained " + f);
      FragmentState fs=fms.mActive[f.mIndex];
      fs.mInstance=f;
      f.mSavedViewState=null;
      f.mBackStackNesting=0;
      f.mInLayout=false;
      f.mAdded=false;
      f.mTarget=null;
      if (fs.mSavedFragmentState != null) {
        fs.mSavedFragmentState.setClassLoader(mHost.getContext().getClassLoader());
        f.mSavedViewState=fs.mSavedFragmentState.getSparseParcelableArray(FragmentManagerImpl.VIEW_STATE_TAG);
        f.mSavedFragmentState=fs.mSavedFragmentState;
      }
    }
  }
  mActive=new ArrayList<Fragment>(fms.mActive.length);
  if (mAvailIndices != null) {
    mAvailIndices.clear();
  }
  for (int i=0; i < fms.mActive.length; i++) {
    FragmentState fs=fms.mActive[i];
    if (fs != null) {
      Fragment f=fs.instantiate(mHost,mParent);
      if (DEBUG)       Log.v(TAG,"restoreAllState: active #" + i + ": "+ f);
      mActive.add(f);
      fs.mInstance=null;
    }
 else {
      mActive.add(null);
      if (mAvailIndices == null) {
        mAvailIndices=new ArrayList<Integer>();
      }
      if (DEBUG)       Log.v(TAG,"restoreAllState: avail #" + i);
      mAvailIndices.add(i);
    }
  }
  if (nonConfig != null) {
    for (int i=0; i < nonConfig.size(); i++) {
      Fragment f=nonConfig.get(i);
      if (f.mTargetIndex >= 0) {
        if (f.mTargetIndex < mActive.size()) {
          f.mTarget=mActive.get(f.mTargetIndex);
        }
 else {
          Log.w(TAG,"Re-attaching retained fragment " + f + " target no longer exists: "+ f.mTargetIndex);
          f.mTarget=null;
        }
      }
    }
  }
  if (fms.mAdded != null) {
    mAdded=new ArrayList<Fragment>(fms.mAdded.length);
    for (int i=0; i < fms.mAdded.length; i++) {
      Fragment f=mActive.get(fms.mAdded[i]);
      if (f == null) {
        throwException(new IllegalStateException("No instantiated fragment for index #" + fms.mAdded[i]));
      }
      f.mAdded=true;
      if (DEBUG)       Log.v(TAG,"restoreAllState: added #" + i + ": "+ f);
      if (mAdded.contains(f)) {
        throw new IllegalStateException("Already added!");
      }
      mAdded.add(f);
    }
  }
 else {
    mAdded=null;
  }
  if (fms.mBackStack != null) {
    mBackStack=new ArrayList<BackStackRecord>(fms.mBackStack.length);
    for (int i=0; i < fms.mBackStack.length; i++) {
      BackStackRecord bse=fms.mBackStack[i].instantiate(this);
      if (DEBUG) {
        Log.v(TAG,"restoreAllState: back stack #" + i + " (index "+ bse.mIndex+ "): "+ bse);
        LogWriter logw=new LogWriter(Log.VERBOSE,TAG);
        PrintWriter pw=new FastPrintWriter(logw,false,1024);
        bse.dump("  ",pw,false);
        pw.flush();
      }
      mBackStack.add(bse);
      if (bse.mIndex >= 0) {
        setBackStackIndex(bse.mIndex,bse);
      }
    }
  }
 else {
    mBackStack=null;
  }
}
