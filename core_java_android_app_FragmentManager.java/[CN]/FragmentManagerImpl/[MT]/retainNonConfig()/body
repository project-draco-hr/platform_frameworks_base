{
  ArrayList<Fragment> fragments=null;
  ArrayList<FragmentManagerNonConfig> childFragments=null;
  if (mActive != null) {
    for (int i=0; i < mActive.size(); i++) {
      Fragment f=mActive.get(i);
      if (f != null) {
        if (f.mRetainInstance) {
          if (fragments == null) {
            fragments=new ArrayList<>();
          }
          fragments.add(f);
          f.mRetaining=true;
          f.mTargetIndex=f.mTarget != null ? f.mTarget.mIndex : -1;
          if (DEBUG)           Log.v(TAG,"retainNonConfig: keeping retained " + f);
        }
        boolean addedChild=false;
        if (f.mChildFragmentManager != null) {
          FragmentManagerNonConfig child=f.mChildFragmentManager.retainNonConfig();
          if (child != null) {
            if (childFragments == null) {
              childFragments=new ArrayList<>();
              for (int j=0; j < i; j++) {
                childFragments.add(null);
              }
            }
            childFragments.add(child);
            addedChild=true;
          }
        }
        if (childFragments != null && !addedChild) {
          childFragments.add(null);
        }
      }
    }
  }
  if (fragments == null && childFragments == null) {
    return null;
  }
  return new FragmentManagerNonConfig(fragments,childFragments);
}
