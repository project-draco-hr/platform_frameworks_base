{
  if (state == null)   return;
  FragmentManagerState fms=(FragmentManagerState)state;
  if (fms.mFragments == null)   return;
  mRestoredFragments=new SparseArray<FragmentState>();
  for (int i=0; i < fms.mFragments.length; i++) {
    FragmentState fs=fms.mFragments[i];
    mRestoredFragments.put(fs.mSavedStateId,fs);
  }
  if (nonConfig != null) {
    for (int i=0; i < nonConfig.size(); i++) {
      Fragment f=nonConfig.get(i);
      FragmentState fs=mRestoredFragments.get(f.mSavedStateId);
      fs.mInstance=f;
      f.mSavedViewState=null;
      if (fs.mSavedFragmentState != null) {
        f.mSavedViewState=fs.mSavedFragmentState.getSparseParcelableArray(FragmentState.VIEW_STATE_TAG);
      }
      addFragment(f,false);
    }
  }
  if (fms.mAdded != null) {
    if (mFragments == null) {
      mFragments=new ArrayList<Fragment>(fms.mAdded.length);
    }
    for (int i=0; i < fms.mAdded.length; i++) {
      FragmentState fs=mRestoredFragments.get(fms.mAdded[i]);
      Fragment f=fs.instantiate(mActivity);
      if (f != null) {
        mFragments.add(f);
      }
    }
  }
  if (fms.mBackStack != null) {
    mBackStack=new ArrayList<BackStackEntry>(fms.mBackStack.length);
    for (int i=0; i < fms.mBackStack.length; i++) {
      BackStackEntry bse=fms.mBackStack[i].instantiate(this);
      mBackStack.add(bse);
    }
  }
}
