{
  if (mSavedFragments != null) {
    FragmentState fs=mSavedFragments.get(f);
    if (fs != null) {
      return fs;
    }
  }
 else {
    mSavedFragments=new HashMap<Fragment,FragmentState>();
  }
  f.mSavedStateSeq=mSaveStateSeq;
  f.mSavedStateId=++mCurSaveId;
  FragmentState fs=new FragmentState(f);
  mSavedFragments.put(f,fs);
  if (mStateBundle == null) {
    mStateBundle=new Bundle();
  }
  f.onSaveInstanceState(mStateBundle);
  if (!mStateBundle.isEmpty()) {
    fs.mSavedFragmentState=mStateBundle;
    mStateBundle=null;
  }
  if (f.mView != null) {
    saveFragmentViewState(f);
    if (f.mSavedViewState != null) {
      if (fs.mSavedFragmentState == null) {
        fs.mSavedFragmentState=new Bundle();
      }
      fs.mSavedFragmentState.putSparseParcelableArray(FragmentState.VIEW_STATE_TAG,f.mSavedViewState);
    }
  }
  return fs;
}
