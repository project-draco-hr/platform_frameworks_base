{
  if (DEBUG_SERVICE)   Slog.v(TAG,"startService: " + service + " type="+ resolvedType+ " args="+ service.getExtras());
  final boolean callerFg;
  if (caller != null) {
    final ProcessRecord callerApp=mAm.getRecordForAppLocked(caller);
    if (callerApp == null) {
      throw new SecurityException("Unable to find app for caller " + caller + " (pid="+ Binder.getCallingPid()+ ") when starting service "+ service);
    }
    callerFg=callerApp.setSchedGroup != Process.THREAD_GROUP_BG_NONINTERACTIVE;
  }
 else {
    callerFg=true;
  }
  ServiceLookupResult res=retrieveServiceLocked(service,resolvedType,callingPid,callingUid,userId,true,callerFg);
  if (res == null) {
    return null;
  }
  if (res.record == null) {
    return new ComponentName("!",res.permission != null ? res.permission : "private to package");
  }
  ServiceRecord r=res.record;
  NeededUriGrants neededGrants=mAm.checkGrantUriPermissionFromIntentLocked(callingUid,r.packageName,service,service.getFlags(),null);
  if (unscheduleServiceRestartLocked(r)) {
    if (DEBUG_SERVICE)     Slog.v(TAG,"START SERVICE WHILE RESTART PENDING: " + r);
  }
  r.lastActivity=SystemClock.uptimeMillis();
  r.startRequested=true;
  ProcessTracker.ServiceState stracker=r.getTracker();
  if (stracker != null) {
    stracker.setStarted(true,mAm.mProcessTracker.getMemFactorLocked(),r.lastActivity);
  }
  r.callStart=false;
  r.pendingStarts.add(new ServiceRecord.StartItem(r,false,r.makeNextStartId(),service,neededGrants));
synchronized (r.stats.getBatteryStats()) {
    r.stats.startRunningLocked();
  }
  String error=bringUpServiceLocked(r,service.getFlags(),callerFg,false);
  if (error != null) {
    return new ComponentName("!!",error);
  }
  return r.name;
}
