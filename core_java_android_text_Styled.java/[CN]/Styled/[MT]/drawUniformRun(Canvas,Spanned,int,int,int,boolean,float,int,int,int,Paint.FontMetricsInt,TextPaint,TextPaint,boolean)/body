{
  boolean haveWidth=false;
  float ret=0;
  CharacterStyle[] spans=text.getSpans(start,end,CharacterStyle.class);
  ReplacementSpan replacement=null;
  paint.bgColor=0;
  paint.baselineShift=0;
  workPaint.set(paint);
  if (spans.length > 0) {
    for (int i=0; i < spans.length; i++) {
      CharacterStyle span=spans[i];
      if (span instanceof ReplacementSpan) {
        replacement=(ReplacementSpan)span;
      }
 else {
        span.updateDrawState(workPaint);
      }
    }
  }
  if (replacement == null) {
    CharSequence tmp;
    int tmpstart, tmpend;
    if (runIsRtl) {
      tmp=TextUtils.getReverse(text,start,end);
      tmpstart=0;
      tmpend=end - start;
    }
 else {
      tmp=text;
      tmpstart=start;
      tmpend=end;
    }
    if (fmi != null) {
      workPaint.getFontMetricsInt(fmi);
    }
    if (canvas != null) {
      if (workPaint.bgColor != 0) {
        int c=workPaint.getColor();
        Paint.Style s=workPaint.getStyle();
        workPaint.setColor(workPaint.bgColor);
        workPaint.setStyle(Paint.Style.FILL);
        if (!haveWidth) {
          ret=workPaint.measureText(tmp,tmpstart,tmpend);
          haveWidth=true;
        }
        if (dir == Layout.DIR_RIGHT_TO_LEFT)         canvas.drawRect(x - ret,top,x,bottom,workPaint);
 else         canvas.drawRect(x,top,x + ret,bottom,workPaint);
        workPaint.setStyle(s);
        workPaint.setColor(c);
      }
      if (dir == Layout.DIR_RIGHT_TO_LEFT) {
        if (!haveWidth) {
          ret=workPaint.measureText(tmp,tmpstart,tmpend);
          haveWidth=true;
        }
        canvas.drawText(tmp,tmpstart,tmpend,x - ret,y + workPaint.baselineShift,workPaint);
      }
 else {
        if (needWidth) {
          if (!haveWidth) {
            ret=workPaint.measureText(tmp,tmpstart,tmpend);
            haveWidth=true;
          }
        }
        canvas.drawText(tmp,tmpstart,tmpend,x,y + workPaint.baselineShift,workPaint);
      }
    }
 else {
      if (needWidth && !haveWidth) {
        ret=workPaint.measureText(tmp,tmpstart,tmpend);
        haveWidth=true;
      }
    }
  }
 else {
    ret=replacement.getSize(workPaint,text,start,end,fmi);
    if (canvas != null) {
      if (dir == Layout.DIR_RIGHT_TO_LEFT)       replacement.draw(canvas,text,start,end,x - ret,top,y,bottom,workPaint);
 else       replacement.draw(canvas,text,start,end,x,top,y,bottom,workPaint);
    }
  }
  if (dir == Layout.DIR_RIGHT_TO_LEFT)   return -ret;
 else   return ret;
}
