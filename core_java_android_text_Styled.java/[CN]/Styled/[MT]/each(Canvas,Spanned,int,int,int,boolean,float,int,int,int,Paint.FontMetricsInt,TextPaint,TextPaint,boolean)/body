{
  boolean havewid=false;
  float ret=0;
  CharacterStyle[] spans=text.getSpans(start,end,CharacterStyle.class);
  ReplacementSpan replacement=null;
  realPaint.bgColor=0;
  realPaint.baselineShift=0;
  paint.set(realPaint);
  if (spans.length > 0) {
    for (int i=0; i < spans.length; i++) {
      CharacterStyle span=spans[i];
      if (span instanceof ReplacementSpan) {
        replacement=(ReplacementSpan)span;
      }
 else {
        span.updateDrawState(paint);
      }
    }
  }
  if (replacement == null) {
    CharSequence tmp;
    int tmpstart, tmpend;
    if (reverse) {
      tmp=TextUtils.getReverse(text,start,end);
      tmpstart=0;
      tmpend=end - start;
    }
 else {
      tmp=text;
      tmpstart=start;
      tmpend=end;
    }
    if (fm != null) {
      paint.getFontMetricsInt(fm);
    }
    if (canvas != null) {
      if (paint.bgColor != 0) {
        int c=paint.getColor();
        Paint.Style s=paint.getStyle();
        paint.setColor(paint.bgColor);
        paint.setStyle(Paint.Style.FILL);
        if (!havewid) {
          ret=paint.measureText(tmp,tmpstart,tmpend);
          havewid=true;
        }
        if (dir == Layout.DIR_RIGHT_TO_LEFT)         canvas.drawRect(x - ret,top,x,bottom,paint);
 else         canvas.drawRect(x,top,x + ret,bottom,paint);
        paint.setStyle(s);
        paint.setColor(c);
      }
      if (dir == Layout.DIR_RIGHT_TO_LEFT) {
        if (!havewid) {
          ret=paint.measureText(tmp,tmpstart,tmpend);
          havewid=true;
        }
        canvas.drawText(tmp,tmpstart,tmpend,x - ret,y + paint.baselineShift,paint);
      }
 else {
        if (needwid) {
          if (!havewid) {
            ret=paint.measureText(tmp,tmpstart,tmpend);
            havewid=true;
          }
        }
        canvas.drawText(tmp,tmpstart,tmpend,x,y + paint.baselineShift,paint);
      }
    }
 else {
      if (needwid && !havewid) {
        ret=paint.measureText(tmp,tmpstart,tmpend);
        havewid=true;
      }
    }
  }
 else {
    ret=replacement.getSize(paint,text,start,end,fm);
    if (canvas != null) {
      if (dir == Layout.DIR_RIGHT_TO_LEFT)       replacement.draw(canvas,text,start,end,x - ret,top,y,bottom,paint);
 else       replacement.draw(canvas,text,start,end,x,top,y,bottom,paint);
    }
  }
  if (dir == Layout.DIR_RIGHT_TO_LEFT)   return -ret;
 else   return ret;
}
