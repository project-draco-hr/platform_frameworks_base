{
  MetricAffectingSpan[] spans=text.getSpans(start,end,MetricAffectingSpan.class);
  ReplacementSpan replacement=null;
  paint.set(realPaint);
  for (int i=0; i < spans.length; i++) {
    MetricAffectingSpan span=spans[i];
    if (span instanceof ReplacementSpan) {
      replacement=(ReplacementSpan)span;
    }
 else {
      span.updateMeasureState(paint);
    }
  }
  if (replacement == null) {
    paint.getFontMetricsInt(fm);
    paint.getTextWidths(text,start,end,widths);
  }
 else {
    int wid=replacement.getSize(paint,text,start,end,fm);
    if (end > start) {
      widths[0]=wid;
      for (int i=start + 1; i < end; i++)       widths[i - start]=0;
    }
  }
  return end - start;
}
