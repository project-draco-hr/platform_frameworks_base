{
  MetricAffectingSpan[] spans=text.getSpans(start,end,MetricAffectingSpan.class);
  ReplacementSpan replacement=null;
  workPaint.set(paint);
  for (int i=0; i < spans.length; i++) {
    MetricAffectingSpan span=spans[i];
    if (span instanceof ReplacementSpan) {
      replacement=(ReplacementSpan)span;
    }
 else {
      span.updateMeasureState(workPaint);
    }
  }
  int result;
  if (replacement == null) {
    workPaint.getFontMetricsInt(fmi);
    result=workPaint.getTextWidths(text,start,end,widths);
  }
 else {
    int wid=replacement.getSize(workPaint,text,start,end,fmi);
    if (end > start) {
      widths[0]=wid;
      for (int i=start + 1; i < end; i++)       widths[i - start]=0;
    }
    result=end - start;
  }
  return result;
}
