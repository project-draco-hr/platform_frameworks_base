{
  if (!(text instanceof Spanned)) {
    float ret=0;
    if (reverse) {
      CharSequence tmp=TextUtils.getReverse(text,start,end);
      int tmpend=end - start;
      if (canvas != null || needwid)       ret=paint.measureText(tmp,0,tmpend);
      if (canvas != null)       canvas.drawText(tmp,0,tmpend,x - ret,y,paint);
    }
 else {
      if (needwid)       ret=paint.measureText(text,start,end);
      if (canvas != null)       canvas.drawText(text,start,end,x,y,paint);
    }
    if (fm != null) {
      paint.getFontMetricsInt(fm);
    }
    return ret * dir;
  }
  float ox=x;
  int asc=0, desc=0;
  int ftop=0, fbot=0;
  Spanned sp=(Spanned)text;
  Class division;
  if (canvas == null)   division=MetricAffectingSpan.class;
 else   division=CharacterStyle.class;
  int next;
  for (int i=start; i < end; i=next) {
    next=sp.nextSpanTransition(i,end,division);
    x+=each(canvas,sp,i,next,dir,reverse,x,top,y,bottom,fm,paint,workPaint,needwid || next != end);
    if (fm != null) {
      if (fm.ascent < asc)       asc=fm.ascent;
      if (fm.descent > desc)       desc=fm.descent;
      if (fm.top < ftop)       ftop=fm.top;
      if (fm.bottom > fbot)       fbot=fm.bottom;
    }
  }
  if (fm != null) {
    if (start == end) {
      paint.getFontMetricsInt(fm);
    }
 else {
      fm.ascent=asc;
      fm.descent=desc;
      fm.top=ftop;
      fm.bottom=fbot;
    }
  }
  return x - ox;
}
