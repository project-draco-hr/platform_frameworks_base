{
  if (!(text instanceof Spanned)) {
    float ret=0;
    if (reverse) {
      CharSequence tmp=TextUtils.getReverse(text,start,end);
      int tmpend=end - start;
      if (canvas != null || needWidth)       ret=paint.measureText(tmp,0,tmpend);
      if (canvas != null)       canvas.drawText(tmp,0,tmpend,x - ret,y,paint);
    }
 else {
      if (needWidth)       ret=paint.measureText(text,start,end);
      if (canvas != null)       canvas.drawText(text,start,end,x,y,paint);
    }
    if (fmi != null) {
      paint.getFontMetricsInt(fmi);
    }
    return ret * dir;
  }
  float ox=x;
  int asc=0, desc=0;
  int ftop=0, fbot=0;
  Spanned sp=(Spanned)text;
  Class division;
  if (canvas == null)   division=MetricAffectingSpan.class;
 else   division=CharacterStyle.class;
  int next;
  for (int i=start; i < end; i=next) {
    next=sp.nextSpanTransition(i,end,division);
    x+=each(canvas,sp,i,next,dir,reverse,x,top,y,bottom,fmi,paint,workPaint,needWidth || next != end);
    if (fmi != null) {
      if (fmi.ascent < asc)       asc=fmi.ascent;
      if (fmi.descent > desc)       desc=fmi.descent;
      if (fmi.top < ftop)       ftop=fmi.top;
      if (fmi.bottom > fbot)       fbot=fmi.bottom;
    }
  }
  if (fmi != null) {
    if (start == end) {
      paint.getFontMetricsInt(fmi);
    }
 else {
      fmi.ascent=asc;
      fmi.descent=desc;
      fmi.top=ftop;
      fmi.bottom=fbot;
    }
  }
  return x - ox;
}
