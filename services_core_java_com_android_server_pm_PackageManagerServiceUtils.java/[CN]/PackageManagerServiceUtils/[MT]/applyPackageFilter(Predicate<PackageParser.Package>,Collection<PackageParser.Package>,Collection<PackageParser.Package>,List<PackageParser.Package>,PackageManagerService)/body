{
  for (  PackageParser.Package pkg : packages) {
    if (filter.test(pkg)) {
      sortTemp.add(pkg);
    }
  }
  sortPackagesByUsageDate(sortTemp,packageManagerService);
  packages.removeAll(sortTemp);
  for (  PackageParser.Package pkg : sortTemp) {
    result.add(pkg);
    Collection<PackageParser.Package> deps=packageManagerService.findSharedNonSystemLibraries(pkg);
    if (!deps.isEmpty()) {
      deps.removeAll(result);
      result.addAll(deps);
      packages.removeAll(deps);
    }
  }
  sortTemp.clear();
}
