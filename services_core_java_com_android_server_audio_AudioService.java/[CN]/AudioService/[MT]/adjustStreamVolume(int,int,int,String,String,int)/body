{
  if (mUseFixedVolume) {
    return;
  }
  if (DEBUG_VOL)   Log.d(TAG,"adjustStreamVolume() stream=" + streamType + ", dir="+ direction+ ", flags="+ flags+ ", caller="+ caller);
  ensureValidDirection(direction);
  ensureValidStreamType(streamType);
  boolean isMuteAdjust=isMuteAdjust(direction);
  if (isMuteAdjust && !isStreamAffectedByMute(streamType)) {
    return;
  }
  int streamTypeAlias=mStreamVolumeAlias[streamType];
  VolumeStreamState streamState=mStreamStates[streamTypeAlias];
  final int device=getDeviceForStream(streamTypeAlias);
  int aliasIndex=streamState.getIndex(device);
  boolean adjustVolume=true;
  int step;
  if ((device & AudioSystem.DEVICE_OUT_ALL_A2DP) == 0 && (flags & AudioManager.FLAG_BLUETOOTH_ABS_VOLUME) != 0) {
    return;
  }
  if (uid == android.os.Process.SYSTEM_UID) {
    uid=UserHandle.getUid(getCurrentUserId(),UserHandle.getAppId(uid));
  }
  if (mAppOps.noteOp(STREAM_VOLUME_OPS[streamTypeAlias],uid,callingPackage) != AppOpsManager.MODE_ALLOWED) {
    return;
  }
synchronized (mSafeMediaVolumeState) {
    mPendingVolumeCommand=null;
  }
  flags&=~AudioManager.FLAG_FIXED_VOLUME;
  if ((streamTypeAlias == AudioSystem.STREAM_MUSIC) && ((device & mFixedVolumeDevices) != 0)) {
    flags|=AudioManager.FLAG_FIXED_VOLUME;
    if (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_ACTIVE && (device & mSafeMediaVolumeDevices) != 0) {
      step=mSafeMediaVolumeIndex;
    }
 else {
      step=streamState.getMaxIndex();
    }
    if (aliasIndex != 0) {
      aliasIndex=step;
    }
  }
 else {
    step=rescaleIndex(10,streamType,streamTypeAlias);
  }
  if (((flags & AudioManager.FLAG_ALLOW_RINGER_MODES) != 0) || (streamTypeAlias == getUiSoundsStreamType())) {
    int ringerMode=getRingerModeInternal();
    if (ringerMode == AudioManager.RINGER_MODE_VIBRATE) {
      flags&=~AudioManager.FLAG_VIBRATE;
    }
    final int result=checkForRingerModeChange(aliasIndex,direction,step,streamState.mIsMuted,callingPackage,flags);
    adjustVolume=(result & FLAG_ADJUST_VOLUME) != 0;
    if ((result & AudioManager.FLAG_SHOW_SILENT_HINT) != 0) {
      flags|=AudioManager.FLAG_SHOW_SILENT_HINT;
    }
    if ((result & AudioManager.FLAG_SHOW_VIBRATE_HINT) != 0) {
      flags|=AudioManager.FLAG_SHOW_VIBRATE_HINT;
    }
  }
  if (!volumeAdjustmentAllowedByDnd(streamTypeAlias,flags)) {
    adjustVolume=false;
  }
  int oldIndex=mStreamStates[streamType].getIndex(device);
  if (adjustVolume && (direction != AudioManager.ADJUST_SAME)) {
    mAudioHandler.removeMessages(MSG_UNMUTE_STREAM);
    if (streamTypeAlias == AudioSystem.STREAM_MUSIC && (device & AudioSystem.DEVICE_OUT_ALL_A2DP) != 0 && (flags & AudioManager.FLAG_BLUETOOTH_ABS_VOLUME) == 0) {
synchronized (mA2dpAvrcpLock) {
        if (mA2dp != null && mAvrcpAbsVolSupported) {
          mA2dp.adjustAvrcpAbsoluteVolume(direction);
        }
      }
    }
    if (isMuteAdjust) {
      boolean state;
      if (direction == AudioManager.ADJUST_TOGGLE_MUTE) {
        state=!streamState.mIsMuted;
      }
 else {
        state=direction == AudioManager.ADJUST_MUTE;
      }
      if (streamTypeAlias == AudioSystem.STREAM_MUSIC) {
        setSystemAudioMute(state);
      }
      for (int stream=0; stream < mStreamStates.length; stream++) {
        if (streamTypeAlias == mStreamVolumeAlias[stream]) {
          if (!(readCameraSoundForced() && (mStreamStates[stream].getStreamType() == AudioSystem.STREAM_SYSTEM_ENFORCED))) {
            mStreamStates[stream].mute(state);
          }
        }
      }
    }
 else     if ((direction == AudioManager.ADJUST_RAISE) && !checkSafeMediaVolume(streamTypeAlias,aliasIndex + step,device)) {
      Log.e(TAG,"adjustStreamVolume() safe volume index = " + oldIndex);
      mVolumeController.postDisplaySafeVolumeWarning(flags);
    }
 else     if (streamState.adjustIndex(direction * step,device,caller) || streamState.mIsMuted) {
      if (streamState.mIsMuted) {
        if (direction == AudioManager.ADJUST_RAISE) {
          streamState.mute(false);
        }
 else         if (direction == AudioManager.ADJUST_LOWER) {
          if (mPlatformType == AudioSystem.PLATFORM_TELEVISION) {
            sendMsg(mAudioHandler,MSG_UNMUTE_STREAM,SENDMSG_QUEUE,streamTypeAlias,flags,null,UNMUTE_STREAM_DELAY);
          }
        }
      }
      sendMsg(mAudioHandler,MSG_SET_DEVICE_VOLUME,SENDMSG_QUEUE,device,0,streamState,0);
    }
    int newIndex=mStreamStates[streamType].getIndex(device);
    if (streamTypeAlias == AudioSystem.STREAM_MUSIC) {
      setSystemAudioVolume(oldIndex,newIndex,getStreamMaxVolume(streamType),flags);
    }
    if (mHdmiManager != null) {
synchronized (mHdmiManager) {
        if (mHdmiCecSink && streamTypeAlias == AudioSystem.STREAM_MUSIC && oldIndex != newIndex) {
synchronized (mHdmiPlaybackClient) {
            int keyCode=(direction == -1) ? KeyEvent.KEYCODE_VOLUME_DOWN : KeyEvent.KEYCODE_VOLUME_UP;
            final long ident=Binder.clearCallingIdentity();
            try {
              mHdmiPlaybackClient.sendKeyEvent(keyCode,true);
              mHdmiPlaybackClient.sendKeyEvent(keyCode,false);
            }
  finally {
              Binder.restoreCallingIdentity(ident);
            }
          }
        }
      }
    }
  }
  int index=mStreamStates[streamType].getIndex(device);
  sendVolumeUpdate(streamType,oldIndex,index,flags);
}
