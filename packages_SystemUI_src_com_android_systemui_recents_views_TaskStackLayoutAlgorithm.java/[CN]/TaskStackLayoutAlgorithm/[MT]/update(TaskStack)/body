{
  SystemServicesProxy ssp=Recents.getSystemServices();
  mTaskProgressMap.clear();
  ArrayList<Task> tasks=stack.getTasks();
  if (tasks.isEmpty()) {
    mFrontMostTaskP=0;
    mMinScrollP=mMaxScrollP=0;
    mNumStackTasks=mNumFreeformTasks=0;
    return;
  }
  ArrayList<Task> freeformTasks=new ArrayList<>();
  ArrayList<Task> stackTasks=new ArrayList<>();
  for (int i=0; i < tasks.size(); i++) {
    Task task=tasks.get(i);
    if (task.isFreeformTask()) {
      freeformTasks.add(task);
    }
 else {
      stackTasks.add(task);
    }
  }
  mNumStackTasks=stackTasks.size();
  mNumFreeformTasks=freeformTasks.size();
  float pAtBackMostTaskTop=0;
  float pAtFrontMostTaskTop=pAtBackMostTaskTop;
  if (!stackTasks.isEmpty()) {
    int taskCount=stackTasks.size();
    for (int i=0; i < taskCount; i++) {
      Task task=stackTasks.get(i);
      mTaskProgressMap.put(task.key,pAtFrontMostTaskTop);
      if (DEBUG) {
        Log.d(TAG,"Update: " + task.activityLabel + " p: "+ pAtFrontMostTaskTop);
      }
      if (i < (taskCount - 1)) {
        float pPeek=task.group == null || task.group.isFrontMostTask(task) ? mBetweenAffiliationPOffset : mWithinAffiliationPOffset;
        pAtFrontMostTaskTop+=pPeek;
      }
    }
    mFrontMostTaskP=pAtFrontMostTaskTop;
    if (mNumStackTasks > 1) {
      mMaxScrollP=alignToStackBottom(pAtFrontMostTaskTop,mStackBottomPOffset + (ssp.hasFreeformWorkspaceSupport() ? mTaskHalfHeightPOffset : mTaskHeightPOffset));
      mMinScrollP=alignToStackBottom(pAtBackMostTaskTop,mStackBottomPOffset + (ssp.hasFreeformWorkspaceSupport() ? mTaskHalfHeightPOffset : mTaskHeightPOffset));
    }
 else {
      mMinScrollP=mMaxScrollP=0;
    }
  }
  if (!freeformTasks.isEmpty()) {
    mFreeformLayoutAlgorithm.update(freeformTasks,this);
    mInitialScrollP=mMaxScrollP;
  }
 else {
    mInitialScrollP=Math.max(mMinScrollP,mMaxScrollP - mTaskHalfHeightPOffset);
  }
  if (DEBUG) {
    Log.d(TAG,"mNumStackTasks: " + mNumStackTasks);
    Log.d(TAG,"mNumFreeformTasks: " + mNumFreeformTasks);
    Log.d(TAG,"mMinScrollP: " + mMinScrollP);
    Log.d(TAG,"mMaxScrollP: " + mMaxScrollP);
  }
}
