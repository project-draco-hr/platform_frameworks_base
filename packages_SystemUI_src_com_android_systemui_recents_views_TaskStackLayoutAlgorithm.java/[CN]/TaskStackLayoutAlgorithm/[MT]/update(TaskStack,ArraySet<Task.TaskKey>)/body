{
  SystemServicesProxy ssp=Recents.getSystemServices();
  RecentsActivityLaunchState launchState=Recents.getConfiguration().getLaunchState();
  mTaskIndexMap.clear();
  ArrayList<Task> tasks=stack.getStackTasks();
  if (tasks.isEmpty()) {
    mFrontMostTaskP=0;
    mMinScrollP=mMaxScrollP=0;
    mNumStackTasks=mNumFreeformTasks=0;
    return;
  }
  ArrayList<Task> freeformTasks=new ArrayList<>();
  ArrayList<Task> stackTasks=new ArrayList<>();
  for (int i=0; i < tasks.size(); i++) {
    Task task=tasks.get(i);
    if (ignoreTasksSet.contains(task.key)) {
      continue;
    }
    if (task.isFreeformTask()) {
      freeformTasks.add(task);
    }
 else {
      stackTasks.add(task);
    }
  }
  mNumStackTasks=stackTasks.size();
  mNumFreeformTasks=freeformTasks.size();
  int taskCount=stackTasks.size();
  for (int i=0; i < taskCount; i++) {
    Task task=stackTasks.get(i);
    mTaskIndexMap.put(task.key.id,i);
  }
  if (!freeformTasks.isEmpty()) {
    mFreeformLayoutAlgorithm.update(freeformTasks,this);
  }
  Task launchTask=stack.getLaunchTarget();
  int launchTaskIndex=launchTask != null ? stack.indexOfStackTask(launchTask) : mNumStackTasks - 1;
  if (getInitialFocusState() == STATE_FOCUSED) {
    mMinScrollP=0;
    mMaxScrollP=Math.max(mMinScrollP,mNumStackTasks - 1);
    if (launchState.launchedFromHome) {
      mInitialScrollP=Utilities.clamp(launchTaskIndex,mMinScrollP,mMaxScrollP);
    }
 else {
      mInitialScrollP=Utilities.clamp(launchTaskIndex - 1,mMinScrollP,mMaxScrollP);
    }
  }
 else   if (!ssp.hasFreeformWorkspaceSupport() && mNumStackTasks == 1) {
    mMinScrollP=0;
    mMaxScrollP=0;
    mInitialScrollP=0;
  }
 else {
    int maxBottomOffset=mStackBottomOffset + mTaskRect.height();
    float maxBottomOffsetPct=(float)maxBottomOffset / mStackRect.height();
    float maxBottomNormX=mUnfocusedCurveInterpolator.getX(maxBottomOffsetPct);
    mUnfocusedRange.offset(0f);
    mMinScrollP=0;
    mMaxScrollP=Math.max(mMinScrollP,(mNumStackTasks - 1) - Math.max(0,mUnfocusedRange.getAbsoluteX(maxBottomNormX)));
    boolean scrollToFront=launchState.launchedFromHome || launchState.launchedFromAppDocked;
    if (scrollToFront) {
      mInitialScrollP=Utilities.clamp(launchTaskIndex,mMinScrollP,mMaxScrollP);
    }
 else {
      mInitialScrollP=Utilities.clamp(launchTaskIndex - 1,mMinScrollP,mMaxScrollP);
    }
    int initialPeekOffset=mStackRect.height() - mInitialTopPeekHeight;
    float initialPeekOffsetPct=(float)initialPeekOffset / mStackRect.height();
    float initialPeekOffsetNormX=mUnfocusedCurveInterpolator.getX(initialPeekOffsetPct);
    float initialFocusedOffset=mStackRect.height() - mInitialTopPeekHeight - (mHeaderBarHeight * 1f) + 1;
    float initialFocusedOffsetPct=(float)initialFocusedOffset / mStackRect.height();
    float initialFocusedNormX=mUnfocusedCurveInterpolator.getX(initialFocusedOffsetPct);
    int initialBottomOffset=mStackBottomOffset + mHeaderBarHeight;
    float initialBottomOffsetPct=(float)initialBottomOffset / mStackRect.height();
    float initialBottomNormX=mUnfocusedCurveInterpolator.getX(initialBottomOffsetPct);
    mInitialNormX=scrollToFront ? new float[]{initialFocusedNormX,initialPeekOffsetNormX,0f} : new float[]{initialBottomNormX,0.5f,0f};
  }
}
