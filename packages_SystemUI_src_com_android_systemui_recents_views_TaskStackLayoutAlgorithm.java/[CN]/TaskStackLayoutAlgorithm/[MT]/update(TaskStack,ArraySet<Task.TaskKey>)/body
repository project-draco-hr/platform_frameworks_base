{
  SystemServicesProxy ssp=Recents.getSystemServices();
  RecentsActivityLaunchState launchState=Recents.getConfiguration().getLaunchState();
  mTaskIndexMap.clear();
  ArrayList<Task> tasks=stack.getStackTasks();
  if (tasks.isEmpty()) {
    mFrontMostTaskP=0;
    mMinScrollP=mMaxScrollP=0;
    mNumStackTasks=mNumFreeformTasks=0;
    return;
  }
  ArrayList<Task> freeformTasks=new ArrayList<>();
  ArrayList<Task> stackTasks=new ArrayList<>();
  for (int i=0; i < tasks.size(); i++) {
    Task task=tasks.get(i);
    if (ignoreTasksSet.contains(task.key)) {
      continue;
    }
    if (task.isFreeformTask()) {
      freeformTasks.add(task);
    }
 else {
      stackTasks.add(task);
    }
  }
  mNumStackTasks=stackTasks.size();
  mNumFreeformTasks=freeformTasks.size();
  int taskCount=stackTasks.size();
  for (int i=0; i < taskCount; i++) {
    Task task=stackTasks.get(i);
    mTaskIndexMap.put(task.key,i);
  }
  if (getDefaultFocusState() > 0f) {
    mMinScrollP=0;
    mMaxScrollP=Math.max(mMinScrollP,mNumStackTasks - 1);
  }
 else {
    if (!ssp.hasFreeformWorkspaceSupport() && mNumStackTasks == 1) {
      mMinScrollP=mMaxScrollP=0;
    }
 else {
      float bottomOffsetPct=(float)(mStackBottomOffset + mTaskRect.height()) / mStackRect.height();
      float normX=mUnfocusedCurveInterpolator.getX(bottomOffsetPct);
      mMinScrollP=0;
      mMaxScrollP=Math.max(mMinScrollP,(mNumStackTasks - 1) - Math.max(0,mUnfocusedRange.getAbsoluteX(normX)));
    }
  }
  if (!freeformTasks.isEmpty()) {
    mFreeformLayoutAlgorithm.update(freeformTasks,this);
    mInitialScrollP=mMaxScrollP;
  }
 else {
    Task launchTask=stack.getLaunchTarget();
    int launchTaskIndex=launchTask != null ? stack.indexOfStackTask(launchTask) : mNumStackTasks - 1;
    if (!ssp.hasFreeformWorkspaceSupport() && mNumStackTasks == 1) {
      mInitialScrollP=mMinScrollP;
    }
 else     if (getDefaultFocusState() > 0f) {
      if (launchState.launchedFromHome) {
        mInitialScrollP=Math.max(mMinScrollP,Math.min(mMaxScrollP,launchTaskIndex));
      }
 else {
        mInitialScrollP=Math.max(mMinScrollP,Math.min(mMaxScrollP,launchTaskIndex - 1));
      }
    }
 else {
      float offsetPct=(float)(mTaskRect.height() / 3) / mStackRect.height();
      float normX=mUnfocusedCurveInterpolator.getX(offsetPct);
      mInitialScrollP=Math.max(mMinScrollP,Math.min(mMaxScrollP,launchTaskIndex - mUnfocusedRange.getAbsoluteX(normX)));
    }
  }
}
