{
  submitCallable(new Callable<Void>(){
    public Void call() throws Exception {
      InputStream in=new BufferedInputStream(s.getInputStream());
      OutputStream out=new BufferedOutputStream(s.getOutputStream());
      int sequenceNumber=0;
      while (true) {
        RecordedRequest request=readRequest(in,sequenceNumber);
        if (request == null) {
          if (sequenceNumber == 0) {
            throw new IllegalStateException("Connection without any request!");
          }
 else {
            break;
          }
        }
        requestQueue.add(request);
        MockResponse response=computeResponse(request);
        writeResponse(out,response);
        if (response.shouldCloseConnectionAfter()) {
          break;
        }
        sequenceNumber++;
      }
      in.close();
      out.close();
      return null;
    }
  }
);
}
