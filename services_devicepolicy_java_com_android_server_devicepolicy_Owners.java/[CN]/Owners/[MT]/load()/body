{
  final File legacy=getLegacyConfigFileWithTestOverride();
  final List<UserInfo> users=mUserManager.getUsers();
  if (readLegacyOwnerFile(legacy)) {
    if (DEBUG) {
      Log.d(TAG,"Legacy config file found.");
    }
    writeDeviceOwner();
    for (    int userId : getProfileOwnerKeys()) {
      writeProfileOwner(userId);
    }
    if (DEBUG) {
      Log.d(TAG,"Deleting legacy config file");
    }
    if (!legacy.delete()) {
      Slog.e(TAG,"Failed to remove the legacy setting file");
    }
  }
 else {
    new DeviceOwnerReadWriter().readFromFileLocked();
    for (    UserInfo ui : users) {
      new ProfileOwnerReadWriter(ui.id).readFromFileLocked();
    }
  }
  mUserManagerInternal.setDeviceManaged(hasDeviceOwner());
  for (  UserInfo ui : users) {
    mUserManagerInternal.setUserManaged(ui.id,hasProfileOwner(ui.id));
  }
  if (hasDeviceOwner() && hasProfileOwner(getDeviceOwnerUserId())) {
    Slog.w(TAG,String.format("User %d has both DO and PO, which is not supported",getDeviceOwnerUserId()));
  }
  pushToPackageManager();
}
