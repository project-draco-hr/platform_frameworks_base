{
  if (DEBUG)   Slog.d(TAG,"setEnabledFunctions " + functions + " makeDefault: "+ makeDefault);
  if (functions != null && makeDefault && !needsOemUsbOverride()) {
    if (mAdbEnabled) {
      functions=addFunction(functions,UsbManager.USB_FUNCTION_ADB);
    }
 else {
      functions=removeFunction(functions,UsbManager.USB_FUNCTION_ADB);
    }
    if (!mDefaultFunctions.equals(functions)) {
      if (!setUsbConfig("none")) {
        Slog.e(TAG,"Failed to disable USB");
        setUsbConfig(mCurrentFunctions);
        return;
      }
      SystemProperties.set("persist.sys.usb.config",functions);
      if (waitForState(functions)) {
        mCurrentFunctions=functions;
        mDefaultFunctions=functions;
      }
 else {
        Slog.e(TAG,"Failed to switch persistent USB config to " + functions);
        SystemProperties.set("persist.sys.usb.config",mDefaultFunctions);
      }
    }
  }
 else {
    if (functions == null) {
      functions=mDefaultFunctions;
    }
    functions=processOemUsbOverride(functions);
    if (mAdbEnabled) {
      functions=addFunction(functions,UsbManager.USB_FUNCTION_ADB);
    }
 else {
      functions=removeFunction(functions,UsbManager.USB_FUNCTION_ADB);
    }
    if (!mCurrentFunctions.equals(functions)) {
      if (!setUsbConfig("none")) {
        Slog.e(TAG,"Failed to disable USB");
        setUsbConfig(mCurrentFunctions);
        return;
      }
      if (setUsbConfig(functions)) {
        mCurrentFunctions=functions;
      }
 else {
        Slog.e(TAG,"Failed to switch USB config to " + functions);
        setUsbConfig(mCurrentFunctions);
      }
    }
  }
}
