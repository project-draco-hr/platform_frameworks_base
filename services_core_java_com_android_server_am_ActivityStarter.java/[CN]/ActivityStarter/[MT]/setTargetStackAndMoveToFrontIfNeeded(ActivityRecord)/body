{
  mTargetStack=intentActivity.task.stack;
  mTargetStack.mLastPausedActivity=null;
  final ActivityStack focusStack=mSupervisor.getFocusedStack();
  ActivityRecord curTop=(focusStack == null) ? null : focusStack.topRunningNonDelayedActivityLocked(mNotTop);
  if (curTop != null && (curTop.task != intentActivity.task || curTop.task != focusStack.topTask())) {
    mStartActivity.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);
    if (mSourceRecord == null || (mSourceStack.topActivity() != null && mSourceStack.topActivity().task == mSourceRecord.task)) {
      if (mLaunchTaskBehind && mSourceRecord != null) {
        intentActivity.setTaskToAffiliateWith(mSourceRecord.task);
      }
      mMovedHome=true;
      final boolean willClearTask=(mLaunchFlags & (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK);
      if (!willClearTask) {
        final ActivityStack launchStack=getLaunchStack(mStartActivity,mLaunchFlags,mStartActivity.task,mOptions,true);
        if (launchStack == null || launchStack == mTargetStack) {
          mTargetStack.moveTaskToFrontLocked(intentActivity.task,mNoAnimation,mOptions,mStartActivity.appTimeTracker,"bringingFoundTaskToFront");
          mMovedToFront=true;
        }
        mOptions=null;
      }
      updateTaskReturnToType(intentActivity.task,mLaunchFlags,focusStack);
    }
  }
  if (!mMovedToFront && mDoResume) {
    if (DEBUG_TASKS)     Slog.d(TAG_TASKS,"Bring to front target: " + mTargetStack + " from "+ intentActivity);
    mTargetStack.moveToFront("intentActivityFound");
  }
  if ((mLaunchFlags & FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != 0) {
    return mTargetStack.resetTaskIfNeededLocked(intentActivity,mStartActivity);
  }
  return intentActivity;
}
