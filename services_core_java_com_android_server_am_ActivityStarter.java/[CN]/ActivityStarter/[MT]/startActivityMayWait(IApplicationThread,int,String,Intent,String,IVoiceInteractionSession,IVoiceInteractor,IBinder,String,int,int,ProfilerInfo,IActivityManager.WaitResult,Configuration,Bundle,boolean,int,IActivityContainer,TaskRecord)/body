{
  if (intent != null && intent.hasFileDescriptors()) {
    throw new IllegalArgumentException("File descriptors passed in Intent");
  }
  boolean componentSpecified=intent.getComponent() != null;
  final Intent ephemeralIntent=new Intent(intent);
  intent=new Intent(intent);
  ResolveInfo rInfo=mSupervisor.resolveIntent(intent,resolvedType,userId);
  if (rInfo == null) {
    UserInfo userInfo=mSupervisor.getUserInfo(userId);
    if (userInfo != null && userInfo.isManagedProfile()) {
      UserManager userManager=UserManager.get(mService.mContext);
      UserInfo parent=null;
      long token=Binder.clearCallingIdentity();
      try {
        parent=userManager.getProfileParent(userId);
      }
  finally {
        Binder.restoreCallingIdentity(token);
      }
      if (parent != null && userManager.isUserUnlocked(parent.getUserHandle()) && !userManager.isUserUnlocked(userInfo.getUserHandle())) {
        rInfo=mSupervisor.resolveIntent(intent,resolvedType,userId,PackageManager.MATCH_ENCRYPTION_AWARE_AND_UNAWARE);
      }
    }
  }
  ActivityInfo aInfo=mSupervisor.resolveActivity(intent,rInfo,startFlags,profilerInfo);
  ActivityOptions options=ActivityOptions.fromBundle(bOptions);
  ActivityStackSupervisor.ActivityContainer container=(ActivityStackSupervisor.ActivityContainer)iContainer;
synchronized (mService) {
    if (container != null && container.mParentActivity != null && container.mParentActivity.state != RESUMED) {
      return ActivityManager.START_CANCELED;
    }
    final int realCallingPid=Binder.getCallingPid();
    final int realCallingUid=Binder.getCallingUid();
    int callingPid;
    if (callingUid >= 0) {
      callingPid=-1;
    }
 else     if (caller == null) {
      callingPid=realCallingPid;
      callingUid=realCallingUid;
    }
 else {
      callingPid=callingUid=-1;
    }
    final ActivityStack stack;
    if (container == null || container.mStack.isOnHomeDisplay()) {
      stack=mSupervisor.mFocusedStack;
    }
 else {
      stack=container.mStack;
    }
    stack.mConfigWillChange=config != null && mService.mConfiguration.diff(config) != 0;
    if (DEBUG_CONFIGURATION)     Slog.v(TAG_CONFIGURATION,"Starting activity when config will change = " + stack.mConfigWillChange);
    final long origId=Binder.clearCallingIdentity();
    if (aInfo != null && (aInfo.applicationInfo.privateFlags & ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != 0) {
      if (aInfo.processName.equals(aInfo.applicationInfo.packageName)) {
        final ProcessRecord heavy=mService.mHeavyWeightProcess;
        if (heavy != null && (heavy.info.uid != aInfo.applicationInfo.uid || !heavy.processName.equals(aInfo.processName))) {
          int appCallingUid=callingUid;
          if (caller != null) {
            ProcessRecord callerApp=mService.getRecordForAppLocked(caller);
            if (callerApp != null) {
              appCallingUid=callerApp.info.uid;
            }
 else {
              Slog.w(TAG,"Unable to find app for caller " + caller + " (pid="+ callingPid+ ") when starting: "+ intent.toString());
              ActivityOptions.abort(options);
              return ActivityManager.START_PERMISSION_DENIED;
            }
          }
          IIntentSender target=mService.getIntentSenderLocked(ActivityManager.INTENT_SENDER_ACTIVITY,"android",appCallingUid,userId,null,null,0,new Intent[]{intent},new String[]{resolvedType},PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_ONE_SHOT,null);
          Intent newIntent=new Intent();
          if (requestCode >= 0) {
            newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_HAS_RESULT,true);
          }
          newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_INTENT,new IntentSender(target));
          if (heavy.activities.size() > 0) {
            ActivityRecord hist=heavy.activities.get(0);
            newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_APP,hist.packageName);
            newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_CUR_TASK,hist.task.taskId);
          }
          newIntent.putExtra(HeavyWeightSwitcherActivity.KEY_NEW_APP,aInfo.packageName);
          newIntent.setFlags(intent.getFlags());
          newIntent.setClassName("android",HeavyWeightSwitcherActivity.class.getName());
          intent=newIntent;
          resolvedType=null;
          caller=null;
          callingUid=Binder.getCallingUid();
          callingPid=Binder.getCallingPid();
          componentSpecified=true;
          rInfo=mSupervisor.resolveIntent(intent,null,userId);
          aInfo=rInfo != null ? rInfo.activityInfo : null;
          if (aInfo != null) {
            aInfo=mService.getActivityInfoForUser(aInfo,userId);
          }
        }
      }
    }
    int res=startActivityLocked(caller,intent,ephemeralIntent,resolvedType,aInfo,rInfo,voiceSession,voiceInteractor,resultTo,resultWho,requestCode,callingPid,callingUid,callingPackage,realCallingPid,realCallingUid,startFlags,options,ignoreTargetSecurity,componentSpecified,null,container,inTask);
    Binder.restoreCallingIdentity(origId);
    if (stack.mConfigWillChange) {
      mService.enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,"updateConfiguration()");
      stack.mConfigWillChange=false;
      if (DEBUG_CONFIGURATION)       Slog.v(TAG_CONFIGURATION,"Updating to new configuration after starting activity.");
      mService.updateConfigurationLocked(config,null,false);
    }
    if (outResult != null) {
      outResult.result=res;
      if (res == ActivityManager.START_SUCCESS) {
        mSupervisor.mWaitingActivityLaunched.add(outResult);
        do {
          try {
            mService.wait();
          }
 catch (          InterruptedException e) {
          }
        }
 while (!outResult.timeout && outResult.who == null);
      }
 else       if (res == START_TASK_TO_FRONT) {
        ActivityRecord r=stack.topRunningActivityLocked();
        if (r.nowVisible && r.state == RESUMED) {
          outResult.timeout=false;
          outResult.who=new ComponentName(r.info.packageName,r.info.name);
          outResult.totalTime=0;
          outResult.thisTime=0;
        }
 else {
          outResult.thisTime=SystemClock.uptimeMillis();
          mSupervisor.mWaitingActivityVisible.add(outResult);
          do {
            try {
              mService.wait();
            }
 catch (            InterruptedException e) {
            }
          }
 while (!outResult.timeout && outResult.who == null);
        }
      }
    }
    return res;
  }
}
