{
  enforceSystemUid();
  if (rule == NetworkPolicyManager.FIREWALL_RULE_ALLOW) {
    Preconditions.checkState(mFirewallEnabled);
  }
synchronized (mQuotaLock) {
    final int oldUidFirewallRule=mUidFirewallRules.get(uid);
    if (DBG) {
      Slog.d(TAG,"oldRule = " + oldUidFirewallRule + ", newRule="+ rule+ " for uid="+ uid);
    }
    if (oldUidFirewallRule == rule) {
      if (DBG)       Slog.d(TAG,"!!!!! Skipping change");
      return;
    }
    try {
      String ruleName;
      if (isFirewallEnabled()) {
        if (rule == NetworkPolicyManager.FIREWALL_RULE_ALLOW) {
          ruleName="allow";
        }
 else {
          ruleName="deny";
        }
      }
 else {
        if (rule == NetworkPolicyManager.FIREWALL_RULE_DENY) {
          ruleName="deny";
        }
 else {
          ruleName="allow";
        }
      }
      if (rule == NetworkPolicyManager.FIREWALL_RULE_DEFAULT) {
        mUidFirewallRules.delete(uid);
      }
 else {
        mUidFirewallRules.put(uid,rule);
      }
      mConnector.execute("firewall","set_uid_rule",uid,ruleName);
    }
 catch (    NativeDaemonConnectorException e) {
      throw e.rethrowAsParcelableException();
    }
  }
}
