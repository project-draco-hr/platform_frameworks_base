{
  if (getUserManager() == null || userAccounts == null || userAccounts.userId < 0 || callingUid == Process.myUid()) {
    return unfiltered;
  }
  UserInfo user=mUserManager.getUserInfo(userAccounts.userId);
  if (user != null && user.isRestricted()) {
    String[] packages=mPackageManager.getPackagesForUid(callingUid);
    String whiteList=mContext.getResources().getString(com.android.internal.R.string.config_appsAuthorizedForSharedAccounts);
    for (    String packageName : packages) {
      if (whiteList.contains(";" + packageName + ";")) {
        return unfiltered;
      }
    }
    ArrayList<Account> allowed=new ArrayList<Account>();
    Account[] sharedAccounts=getSharedAccountsAsUser(userAccounts.userId);
    if (sharedAccounts == null || sharedAccounts.length == 0)     return unfiltered;
    String requiredAccountType="";
    try {
      if (callingPackage != null) {
        PackageInfo pi=mPackageManager.getPackageInfo(callingPackage,0);
        if (pi != null && pi.restrictedAccountType != null) {
          requiredAccountType=pi.restrictedAccountType;
        }
      }
 else {
        for (        String packageName : packages) {
          PackageInfo pi=mPackageManager.getPackageInfo(packageName,0);
          if (pi != null && pi.restrictedAccountType != null) {
            requiredAccountType=pi.restrictedAccountType;
            break;
          }
        }
      }
    }
 catch (    NameNotFoundException nnfe) {
    }
    for (    Account account : unfiltered) {
      if (account.type.equals(requiredAccountType)) {
        allowed.add(account);
      }
 else {
        boolean found=false;
        for (        Account shared : sharedAccounts) {
          if (shared.equals(account)) {
            found=true;
            break;
          }
        }
        if (!found) {
          allowed.add(account);
        }
      }
    }
    Account[] filtered=new Account[allowed.size()];
    allowed.toArray(filtered);
    return filtered;
  }
 else {
    return unfiltered;
  }
}
