{
  if (invalidateAuthenticatorCache) {
    mAuthenticatorCache.invalidateCache(accounts.userId);
  }
  final HashSet<AuthenticatorDescription> knownAuth=Sets.newHashSet();
  for (  RegisteredServicesCache.ServiceInfo<AuthenticatorDescription> service : mAuthenticatorCache.getAllServices(accounts.userId)) {
    knownAuth.add(service.type);
  }
synchronized (accounts.cacheLock) {
    final SQLiteDatabase db=accounts.openHelper.getWritableDatabase();
    boolean accountDeleted=false;
    Cursor cursor=db.query(TABLE_ACCOUNTS,new String[]{ACCOUNTS_ID,ACCOUNTS_TYPE,ACCOUNTS_NAME},null,null,null,null,ACCOUNTS_ID);
    try {
      accounts.accountCache.clear();
      final HashMap<String,ArrayList<String>> accountNamesByType=new LinkedHashMap<String,ArrayList<String>>();
      while (cursor.moveToNext()) {
        final long accountId=cursor.getLong(0);
        final String accountType=cursor.getString(1);
        final String accountName=cursor.getString(2);
        if (!knownAuth.contains(AuthenticatorDescription.newKey(accountType))) {
          Slog.w(TAG,"deleting account " + accountName + " because type "+ accountType+ " no longer has a registered authenticator");
          db.delete(TABLE_ACCOUNTS,ACCOUNTS_ID + "=" + accountId,null);
          accountDeleted=true;
          logRecord(db,DebugDbHelper.ACTION_AUTHENTICATOR_REMOVE,TABLE_ACCOUNTS,accountId,accounts);
          final Account account=new Account(accountName,accountType);
          accounts.userDataCache.remove(account);
          accounts.authTokenCache.remove(account);
          accounts.accountTokenCaches.remove(account);
        }
 else {
          ArrayList<String> accountNames=accountNamesByType.get(accountType);
          if (accountNames == null) {
            accountNames=new ArrayList<String>();
            accountNamesByType.put(accountType,accountNames);
          }
          accountNames.add(accountName);
        }
      }
      for (      Map.Entry<String,ArrayList<String>> cur : accountNamesByType.entrySet()) {
        final String accountType=cur.getKey();
        final ArrayList<String> accountNames=cur.getValue();
        final Account[] accountsForType=new Account[accountNames.size()];
        int i=0;
        for (        String accountName : accountNames) {
          accountsForType[i]=new Account(accountName,accountType);
          ++i;
        }
        accounts.accountCache.put(accountType,accountsForType);
      }
    }
  finally {
      cursor.close();
      if (accountDeleted) {
        sendAccountsChangedBroadcast(accounts.userId);
      }
    }
  }
}
