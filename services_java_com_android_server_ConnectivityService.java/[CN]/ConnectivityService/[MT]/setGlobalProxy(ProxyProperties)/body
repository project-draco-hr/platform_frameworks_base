{
  enforceConnectivityInternalPermission();
synchronized (mProxyLock) {
    if (proxyProperties == mGlobalProxy)     return;
    if (proxyProperties != null && proxyProperties.equals(mGlobalProxy))     return;
    if (mGlobalProxy != null && mGlobalProxy.equals(proxyProperties))     return;
    String host="";
    int port=0;
    String exclList="";
    if (proxyProperties != null && !TextUtils.isEmpty(proxyProperties.getHost())) {
      if (!proxyProperties.isValid()) {
        if (DBG)         log("Invalid proxy properties, ignoring: " + proxyProperties.toString());
        return;
      }
      mGlobalProxy=new ProxyProperties(proxyProperties);
      host=mGlobalProxy.getHost();
      port=mGlobalProxy.getPort();
      exclList=mGlobalProxy.getExclusionList();
    }
 else {
      mGlobalProxy=null;
    }
    ContentResolver res=mContext.getContentResolver();
    final long token=Binder.clearCallingIdentity();
    try {
      Settings.Global.putString(res,Settings.Global.GLOBAL_HTTP_PROXY_HOST,host);
      Settings.Global.putInt(res,Settings.Global.GLOBAL_HTTP_PROXY_PORT,port);
      Settings.Global.putString(res,Settings.Global.GLOBAL_HTTP_PROXY_EXCLUSION_LIST,exclList);
    }
  finally {
      Binder.restoreCallingIdentity(token);
    }
  }
  if (mGlobalProxy == null) {
    proxyProperties=mDefaultProxy;
  }
  sendProxyBroadcast(proxyProperties);
}
