{
  ColorModel srcCM=src.getColorModel();
  if (srcCM instanceof IndexColorModel) {
    throw new IllegalArgumentException(Messages.getString("awt.220"));
  }
  int nComponents=srcCM.getNumComponents();
  int nLUTComponents=lut.getNumComponents();
  boolean skipAlpha;
  if (srcCM.hasAlpha()) {
    if (nLUTComponents == 1 || nLUTComponents == nComponents - 1) {
      skipAlpha=true;
    }
 else     if (nLUTComponents == nComponents) {
      skipAlpha=false;
    }
 else {
      throw new IllegalArgumentException(Messages.getString("awt.229"));
    }
  }
 else   if (nLUTComponents == 1 || nLUTComponents == nComponents) {
    skipAlpha=false;
  }
 else {
    throw new IllegalArgumentException(Messages.getString("awt.229"));
  }
  BufferedImage finalDst=null;
  if (dst == null) {
    finalDst=dst;
    dst=createCompatibleDestImage(src,null);
  }
 else {
    if (src.getWidth() != dst.getWidth()) {
      throw new IllegalArgumentException(Messages.getString("awt.291"));
    }
    if (src.getHeight() != dst.getHeight()) {
      throw new IllegalArgumentException(Messages.getString("awt.292"));
    }
    if (!srcCM.equals(dst.getColorModel())) {
      if (!((src.getType() == BufferedImage.TYPE_INT_RGB || src.getType() == BufferedImage.TYPE_INT_ARGB) && (dst.getType() == BufferedImage.TYPE_INT_RGB || dst.getType() == BufferedImage.TYPE_INT_ARGB))) {
        finalDst=dst;
        dst=createCompatibleDestImage(src,null);
      }
    }
  }
  if (slowFilter(src.getRaster(),dst.getRaster(),skipAlpha) != 0) {
    throw new ImagingOpException(Messages.getString("awt.21F"));
  }
  if (finalDst != null) {
    Graphics2D g=finalDst.createGraphics();
    g.setComposite(AlphaComposite.Src);
    g.drawImage(dst,0,0,null);
  }
 else {
    finalDst=dst;
  }
  return dst;
}
