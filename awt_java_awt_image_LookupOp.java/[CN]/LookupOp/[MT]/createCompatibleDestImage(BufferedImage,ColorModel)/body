{
  if (dstCM == null) {
    dstCM=src.getColorModel();
    if (dstCM instanceof ComponentColorModel) {
      int transferType=dstCM.getTransferType();
      if (lut instanceof ByteLookupTable) {
        transferType=DataBuffer.TYPE_BYTE;
      }
 else       if (lut instanceof ShortLookupTable) {
        transferType=DataBuffer.TYPE_SHORT;
      }
      dstCM=new ComponentColorModel(dstCM.cs,dstCM.hasAlpha(),dstCM.isAlphaPremultiplied,dstCM.transparency,transferType);
    }
  }
  WritableRaster r=dstCM.isCompatibleSampleModel(src.getSampleModel()) ? src.getRaster().createCompatibleWritableRaster(src.getWidth(),src.getHeight()) : dstCM.createCompatibleWritableRaster(src.getWidth(),src.getHeight());
  return new BufferedImage(dstCM,r,dstCM.isAlphaPremultiplied(),null);
}
