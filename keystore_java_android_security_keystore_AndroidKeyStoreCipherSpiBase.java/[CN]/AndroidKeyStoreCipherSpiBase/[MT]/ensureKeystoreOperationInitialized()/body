{
  if (mMainDataStreamer != null) {
    return;
  }
  if (mCachedException != null) {
    return;
  }
  if (mKey == null) {
    throw new IllegalStateException("Not initialized");
  }
  KeymasterArguments keymasterInputArgs=new KeymasterArguments();
  addAlgorithmSpecificParametersToBegin(keymasterInputArgs);
  byte[] additionalEntropy=KeyStoreCryptoOperationUtils.getRandomBytesToMixIntoKeystoreRng(mRng,getAdditionalEntropyAmountForBegin());
  int purpose;
  if (mKeymasterPurposeOverride != -1) {
    purpose=mKeymasterPurposeOverride;
  }
 else {
    purpose=mEncrypting ? KeymasterDefs.KM_PURPOSE_ENCRYPT : KeymasterDefs.KM_PURPOSE_DECRYPT;
  }
  OperationResult opResult=mKeyStore.begin(mKey.getAlias(),purpose,true,keymasterInputArgs,additionalEntropy,mKey.getUid());
  if (opResult == null) {
    throw new KeyStoreConnectException();
  }
  mOperationToken=opResult.token;
  mOperationHandle=opResult.operationHandle;
  GeneralSecurityException e=KeyStoreCryptoOperationUtils.getExceptionForCipherInit(mKeyStore,mKey,opResult.resultCode);
  if (e != null) {
    if (e instanceof InvalidKeyException) {
      throw (InvalidKeyException)e;
    }
 else     if (e instanceof InvalidAlgorithmParameterException) {
      throw (InvalidAlgorithmParameterException)e;
    }
 else {
      throw new ProviderException("Unexpected exception type",e);
    }
  }
  if (mOperationToken == null) {
    throw new ProviderException("Keystore returned null operation token");
  }
  if (mOperationHandle == 0) {
    throw new ProviderException("Keystore returned invalid operation handle");
  }
  loadAlgorithmSpecificParametersFromBeginResult(opResult.outParams);
  mMainDataStreamer=createMainDataStreamer(mKeyStore,opResult.token);
  mAdditionalAuthenticationDataStreamer=createAdditionalAuthenticationDataStreamer(mKeyStore,opResult.token);
  mAdditionalAuthenticationDataStreamerClosed=false;
}
