{
  if (DEBUG)   Slog.v(TAG,"loadSettingsLocked");
  JournaledFile journal=makeJournaledFile(userId);
  FileInputStream stream=null;
  File file=journal.chooseForRead();
  if (!file.exists()) {
    migrateFromOld();
  }
  WallpaperData wallpaper=mWallpaperMap.get(userId);
  if (wallpaper == null) {
    wallpaper=new WallpaperData(userId,WALLPAPER,WALLPAPER_CROP);
    wallpaper.allowBackup=true;
    mWallpaperMap.put(userId,wallpaper);
    if (!wallpaper.cropExists()) {
      generateCrop(wallpaper);
    }
  }
  boolean success=false;
  try {
    stream=new FileInputStream(file);
    XmlPullParser parser=Xml.newPullParser();
    parser.setInput(stream,StandardCharsets.UTF_8.name());
    int type;
    do {
      type=parser.next();
      if (type == XmlPullParser.START_TAG) {
        String tag=parser.getName();
        if ("wp".equals(tag)) {
          parseWallpaperAttributes(parser,wallpaper,keepDimensionHints);
          String comp=parser.getAttributeValue(null,"component");
          wallpaper.nextWallpaperComponent=comp != null ? ComponentName.unflattenFromString(comp) : null;
          if (wallpaper.nextWallpaperComponent == null || "android".equals(wallpaper.nextWallpaperComponent.getPackageName())) {
            wallpaper.nextWallpaperComponent=mImageWallpaper;
          }
          if (DEBUG) {
            Slog.v(TAG,"mWidth:" + wallpaper.width);
            Slog.v(TAG,"mHeight:" + wallpaper.height);
            Slog.v(TAG,"cropRect:" + wallpaper.cropHint);
            Slog.v(TAG,"mName:" + wallpaper.name);
            Slog.v(TAG,"mNextWallpaperComponent:" + wallpaper.nextWallpaperComponent);
          }
        }
 else         if ("kwp".equals(tag)) {
          WallpaperData lockWallpaper=mLockWallpaperMap.get(userId);
          if (lockWallpaper == null) {
            lockWallpaper=new WallpaperData(userId,WALLPAPER_LOCK_ORIG,WALLPAPER_LOCK_CROP);
            mLockWallpaperMap.put(userId,lockWallpaper);
          }
          parseWallpaperAttributes(parser,lockWallpaper,false);
        }
      }
    }
 while (type != XmlPullParser.END_DOCUMENT);
    success=true;
  }
 catch (  FileNotFoundException e) {
    Slog.w(TAG,"no current wallpaper -- first boot?");
  }
catch (  NullPointerException e) {
    Slog.w(TAG,"failed parsing " + file + " "+ e);
  }
catch (  NumberFormatException e) {
    Slog.w(TAG,"failed parsing " + file + " "+ e);
  }
catch (  XmlPullParserException e) {
    Slog.w(TAG,"failed parsing " + file + " "+ e);
  }
catch (  IOException e) {
    Slog.w(TAG,"failed parsing " + file + " "+ e);
  }
catch (  IndexOutOfBoundsException e) {
    Slog.w(TAG,"failed parsing " + file + " "+ e);
  }
  IoUtils.closeQuietly(stream);
  if (!success) {
    wallpaper.width=-1;
    wallpaper.height=-1;
    wallpaper.cropHint.set(0,0,0,0);
    wallpaper.padding.set(0,0,0,0);
    wallpaper.name="";
    mLockWallpaperMap.remove(userId);
  }
 else {
    if (wallpaper.wallpaperId <= 0) {
      wallpaper.wallpaperId=makeWallpaperIdLocked();
      if (DEBUG) {
        Slog.w(TAG,"Didn't set wallpaper id in loadSettingsLocked(" + userId + "); now "+ wallpaper.wallpaperId);
      }
    }
  }
  ensureSaneWallpaperData(wallpaper);
  WallpaperData lockWallpaper=mLockWallpaperMap.get(userId);
  if (lockWallpaper != null) {
    ensureSaneWallpaperData(lockWallpaper);
  }
}
