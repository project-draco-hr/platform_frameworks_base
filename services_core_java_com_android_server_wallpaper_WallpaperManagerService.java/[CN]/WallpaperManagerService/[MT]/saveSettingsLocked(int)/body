{
  JournaledFile journal=makeJournaledFile(userId);
  FileOutputStream fstream=null;
  BufferedOutputStream stream=null;
  try {
    XmlSerializer out=new FastXmlSerializer();
    fstream=new FileOutputStream(journal.chooseForWrite(),false);
    stream=new BufferedOutputStream(fstream);
    out.setOutput(stream,StandardCharsets.UTF_8.name());
    out.startDocument(null,true);
    WallpaperData wallpaper;
    wallpaper=mWallpaperMap.get(userId);
    if (wallpaper != null) {
      writeWallpaperAttributes(out,"wp",wallpaper);
    }
    wallpaper=mLockWallpaperMap.get(userId);
    if (wallpaper != null) {
      writeWallpaperAttributes(out,"kwp",wallpaper);
    }
    out.endDocument();
    stream.flush();
    FileUtils.sync(fstream);
    stream.close();
    journal.commit();
  }
 catch (  IOException e) {
    IoUtils.closeQuietly(stream);
    journal.rollback();
  }
}
