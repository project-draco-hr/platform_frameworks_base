{
  checkPermission(android.Manifest.permission.SET_WALLPAPER);
  if (which == 0) {
    return null;
  }
  if (!isWallpaperSupported(callingPackage)) {
    return null;
  }
  if (cropHint == null) {
    cropHint=new Rect(0,0,0,0);
  }
 else {
    if (cropHint.isEmpty() || cropHint.left < 0 || cropHint.top < 0) {
      return null;
    }
  }
synchronized (mLock) {
    if (DEBUG)     Slog.v(TAG,"setWallpaper");
    int userId=UserHandle.getCallingUserId();
    WallpaperData wallpaper=getWallpaperSafeLocked(userId);
    final long ident=Binder.clearCallingIdentity();
    try {
      ParcelFileDescriptor pfd=updateWallpaperBitmapLocked(name,wallpaper,extras);
      if (pfd != null) {
        wallpaper.imageWallpaperPending=true;
        wallpaper.setComplete=completion;
        wallpaper.cropHint.set(cropHint);
      }
      return pfd;
    }
  finally {
      Binder.restoreCallingIdentity(ident);
    }
  }
}
