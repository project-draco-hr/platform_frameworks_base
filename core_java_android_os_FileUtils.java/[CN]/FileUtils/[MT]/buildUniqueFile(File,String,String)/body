{
  String name;
  String ext;
  if (Document.MIME_TYPE_DIR.equals(mimeType)) {
    name=displayName;
    ext=null;
  }
 else {
    String mimeTypeFromExt;
    final int lastDot=displayName.lastIndexOf('.');
    if (lastDot >= 0) {
      name=displayName.substring(0,lastDot);
      ext=displayName.substring(lastDot + 1);
      mimeTypeFromExt=MimeTypeMap.getSingleton().getMimeTypeFromExtension(ext.toLowerCase());
    }
 else {
      name=displayName;
      ext=null;
      mimeTypeFromExt=null;
    }
    if (mimeTypeFromExt == null) {
      mimeTypeFromExt="application/octet-stream";
    }
    final String extFromMimeType=MimeTypeMap.getSingleton().getExtensionFromMimeType(mimeType);
    if (Objects.equals(mimeType,mimeTypeFromExt) || Objects.equals(ext,extFromMimeType)) {
    }
 else {
      name=displayName;
      ext=extFromMimeType;
    }
  }
  File file=buildFile(parent,name,ext);
  int n=0;
  while (file.exists()) {
    if (n++ >= 32) {
      throw new FileNotFoundException("Failed to create unique file");
    }
    file=buildFile(parent,name + " (" + n+ ")",ext);
  }
  return file;
}
