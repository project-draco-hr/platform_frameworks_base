{
  validatePermission(android.Manifest.permission.SHUTDOWN);
  Log.i(TAG,"Shutting down");
  String path=Environment.getExternalStorageDirectory().getPath();
  String state=getVolumeState(path);
  if (state.equals(Environment.MEDIA_SHARED)) {
    setUsbMassStorageEnabled(false);
  }
 else   if (state.equals(Environment.MEDIA_CHECKING)) {
    int retries=30;
    while (state.equals(Environment.MEDIA_CHECKING) && (retries-- >= 0)) {
      try {
        Thread.sleep(1000);
      }
 catch (      InterruptedException iex) {
        Log.e(TAG,"Interrupted while waiting for media",iex);
        break;
      }
      state=Environment.getExternalStorageState();
    }
    if (retries == 0) {
      Log.e(TAG,"Timed out waiting for media to check");
    }
  }
  if (state.equals(Environment.MEDIA_MOUNTED)) {
    ShutdownCallBack ucb=new ShutdownCallBack(path,observer);
    mHandler.sendMessage(mHandler.obtainMessage(H_UNMOUNT_PM_UPDATE,ucb));
  }
}
