{
  final StorageVolume volume;
  final String state;
synchronized (mVolumesLock) {
    volume=mVolumesByPath.get(path);
    state=getVolumeState(path);
  }
  if (DEBUG_EVENTS)   Slog.i(TAG,"notifyVolumeStateChange::" + state);
  String action=null;
  if (oldState == VolumeState.Shared && newState != oldState) {
    if (LOCAL_LOGD)     Slog.d(TAG,"Sending ACTION_MEDIA_UNSHARED intent");
    sendStorageIntent(Intent.ACTION_MEDIA_UNSHARED,volume,UserHandle.ALL);
  }
  if (newState == VolumeState.Init) {
  }
 else   if (newState == VolumeState.NoMedia) {
  }
 else   if (newState == VolumeState.Idle) {
    if (!state.equals(Environment.MEDIA_BAD_REMOVAL) && !state.equals(Environment.MEDIA_NOFS) && !state.equals(Environment.MEDIA_UNMOUNTABLE)&& !getUmsEnabling()) {
      if (DEBUG_EVENTS)       Slog.i(TAG,"updating volume state for media bad removal nofs and unmountable");
      updatePublicVolumeState(volume,Environment.MEDIA_UNMOUNTED);
      action=Intent.ACTION_MEDIA_UNMOUNTED;
    }
  }
 else   if (newState == VolumeState.Pending) {
  }
 else   if (newState == VolumeState.Checking) {
    if (DEBUG_EVENTS)     Slog.i(TAG,"updating volume state checking");
    updatePublicVolumeState(volume,Environment.MEDIA_CHECKING);
    action=Intent.ACTION_MEDIA_CHECKING;
  }
 else   if (newState == VolumeState.Mounted) {
    if (DEBUG_EVENTS)     Slog.i(TAG,"updating volume state mounted");
    updatePublicVolumeState(volume,Environment.MEDIA_MOUNTED);
    action=Intent.ACTION_MEDIA_MOUNTED;
  }
 else   if (newState == VolumeState.Unmounting) {
    action=Intent.ACTION_MEDIA_EJECT;
  }
 else   if (newState == VolumeState.Formatting) {
  }
 else   if (newState == VolumeState.Shared) {
    if (DEBUG_EVENTS)     Slog.i(TAG,"Updating volume state media mounted");
    updatePublicVolumeState(volume,Environment.MEDIA_UNMOUNTED);
    sendStorageIntent(Intent.ACTION_MEDIA_UNMOUNTED,volume,UserHandle.ALL);
    if (DEBUG_EVENTS)     Slog.i(TAG,"Updating media shared");
    updatePublicVolumeState(volume,Environment.MEDIA_SHARED);
    action=Intent.ACTION_MEDIA_SHARED;
    if (LOCAL_LOGD)     Slog.d(TAG,"Sending ACTION_MEDIA_SHARED intent");
  }
 else   if (newState == VolumeState.SharedMnt) {
    Slog.e(TAG,"Live shared mounts not supported yet!");
    return;
  }
 else {
    Slog.e(TAG,"Unhandled VolumeState {" + newState + "}");
  }
  if (action != null) {
    sendStorageIntent(action,volume,UserHandle.ALL);
  }
}
