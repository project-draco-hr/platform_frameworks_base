{
  if (!Environment.isExternalStorageEmulated()) {
    return canonicalPath;
  }
  String path=canonicalPath.toString();
  final UserEnvironment userEnv=new UserEnvironment(userId);
  final String externalPath=userEnv.getExternalStorageDirectory().getAbsolutePath();
  final String legacyExternalPath=Environment.getLegacyExternalStorageDirectory().getAbsolutePath();
  if (path.startsWith(externalPath)) {
    path=path.substring(externalPath.length() + 1);
  }
 else   if (path.startsWith(legacyExternalPath)) {
    path=path.substring(legacyExternalPath.length() + 1);
  }
 else {
    return canonicalPath;
  }
  final String obbPath="Android/obb";
  if (path.startsWith(obbPath)) {
    path=path.substring(obbPath.length() + 1);
    if (forVold) {
      return new File(Environment.getEmulatedStorageObbSource(),path).getAbsolutePath();
    }
 else {
      final UserEnvironment ownerEnv=new UserEnvironment(UserHandle.USER_OWNER);
      return new File(ownerEnv.buildExternalStorageAndroidObbDirs()[0],path).getAbsolutePath();
    }
  }
  if (forVold) {
    return new File(Environment.getEmulatedStorageSource(userId),path).getAbsolutePath();
  }
 else {
    return new File(userEnv.getExternalDirs()[0],path).getAbsolutePath();
  }
}
