{
  if (mEmulatedTemplate == null) {
    throw new IllegalStateException("Missing emulated volume multi-user template");
  }
  final UserEnvironment userEnv=new UserEnvironment(user.getIdentifier());
  final File path=userEnv.getExternalStorageDirectory();
  final StorageVolume volume=StorageVolume.fromTemplate(mEmulatedTemplate,path,user);
  volume.setStorageId(0);
  addVolumeLocked(volume);
  if (mSystemReady) {
    updatePublicVolumeState(volume,Environment.MEDIA_MOUNTED);
  }
 else {
    mVolumeStates.put(volume.getPath(),Environment.MEDIA_MOUNTED);
  }
}
