{
synchronized (mListeners) {
    mUmsAvailable=avail;
    for (int i=mListeners.size() - 1; i >= 0; i--) {
      MountServiceBinderListener bl=mListeners.get(i);
      try {
        bl.mListener.onUsbMassStorageConnectionChanged(avail);
      }
 catch (      RemoteException rex) {
        Slog.e(TAG,"Listener dead");
        mListeners.remove(i);
      }
catch (      Exception ex) {
        Slog.e(TAG,"Listener failed",ex);
      }
    }
  }
  if (mBooted == true) {
    sendUmsIntent(avail);
  }
 else {
    mSendUmsConnectedOnBoot=avail;
  }
  final String path=Environment.getExternalStorageDirectory().getPath();
  if (avail == false && getVolumeState(path).equals(Environment.MEDIA_SHARED)) {
    new Thread(){
      @Override public void run(){
        try {
          int rc;
          Slog.w(TAG,"Disabling UMS after cable disconnect");
          doShareUnshareVolume(path,"ums",false);
          if ((rc=doMountVolume(path)) != StorageResultCode.OperationSucceeded) {
            Slog.e(TAG,String.format("Failed to remount {%s} on UMS enabled-disconnect (%d)",path,rc));
          }
        }
 catch (        Exception ex) {
          Slog.w(TAG,"Failed to mount media on UMS enabled-disconnect",ex);
        }
      }
    }
.start();
  }
}
