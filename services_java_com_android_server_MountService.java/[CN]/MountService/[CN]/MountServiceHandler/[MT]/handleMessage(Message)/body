{
switch (msg.what) {
case H_UNMOUNT_PM_UPDATE:
{
      if (DEBUG_UNMOUNT)       Log.i(TAG,"H_UNMOUNT_PM_UPDATE");
      UnmountCallBack ucb=(UnmountCallBack)msg.obj;
      mForceUnmounts.add(ucb);
      if (DEBUG_UNMOUNT)       Log.i(TAG," registered = " + mUpdatingStatus);
      if (!mUpdatingStatus) {
        if (DEBUG_UNMOUNT)         Log.i(TAG,"Updating external media status on PackageManager");
        mUpdatingStatus=true;
        mPms.updateExternalMediaStatus(false,true);
      }
      break;
    }
case H_UNMOUNT_PM_DONE:
{
    if (DEBUG_UNMOUNT)     Log.i(TAG,"H_UNMOUNT_PM_DONE");
    if (!mUpdatingStatus) {
      return;
    }
    if (DEBUG_UNMOUNT)     Log.i(TAG,"Updated status. Processing requests");
    mUpdatingStatus=false;
    int size=mForceUnmounts.size();
    int sizeArr[]=new int[size];
    int sizeArrN=0;
    for (int i=0; i < size; i++) {
      UnmountCallBack ucb=mForceUnmounts.get(i);
      String path=ucb.path;
      boolean done=false;
      if (!ucb.force) {
        done=true;
      }
 else {
        int pids[]=getStorageUsers(path);
        if (pids == null || pids.length == 0) {
          done=true;
        }
 else {
          ActivityManagerService ams=(ActivityManagerService)ServiceManager.getService("activity");
          boolean ret=ams.killPids(pids,"Unmount media");
          if (ret) {
            pids=getStorageUsers(path);
            if (pids == null || pids.length == 0) {
              done=true;
            }
          }
        }
      }
      if (done) {
        sizeArr[sizeArrN++]=i;
        mHandler.sendMessage(mHandler.obtainMessage(H_UNMOUNT_MS,ucb));
      }
 else {
        if (ucb.retries >= MAX_UNMOUNT_RETRIES) {
          Log.i(TAG,"Cannot unmount media inspite of " + MAX_UNMOUNT_RETRIES + " retries");
        }
 else {
          mHandler.sendMessageDelayed(mHandler.obtainMessage(H_UNMOUNT_PM_DONE,ucb.retries++),RETRY_UNMOUNT_DELAY);
        }
      }
    }
    for (int i=(sizeArrN - 1); i >= 0; i--) {
      mForceUnmounts.remove(sizeArr[i]);
    }
    break;
  }
case H_UNMOUNT_MS:
{
  if (DEBUG_UNMOUNT)   Log.i(TAG,"H_UNMOUNT_MS");
  UnmountCallBack ucb=(UnmountCallBack)msg.obj;
  ucb.handleFinished();
  break;
}
}
}
