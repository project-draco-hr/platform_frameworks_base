{
  final boolean hadData=mPackages.getMap().size() > 0 || mProcesses.getMap().size() > 0;
  if (hadData) {
    resetSafely();
  }
  if (!readCheckedInt(in,MAGIC,"magic number")) {
    return;
  }
  int version=in.readInt();
  if (version != PARCEL_VERSION) {
    mReadError="bad version: " + version;
    return;
  }
  if (!readCheckedInt(in,STATE_COUNT,"state count")) {
    return;
  }
  if (!readCheckedInt(in,ADJ_COUNT,"adj count")) {
    return;
  }
  if (!readCheckedInt(in,PSS_COUNT,"pss count")) {
    return;
  }
  if (!readCheckedInt(in,SYS_MEM_USAGE_COUNT,"sys mem usage count")) {
    return;
  }
  if (!readCheckedInt(in,SparseMappingTable.ARRAY_SIZE,"longs size")) {
    return;
  }
  mIndexToCommonString=new ArrayList<String>();
  mTimePeriodStartClock=in.readLong();
  buildTimePeriodStartClockStr();
  mTimePeriodStartRealtime=in.readLong();
  mTimePeriodEndRealtime=in.readLong();
  mTimePeriodStartUptime=in.readLong();
  mTimePeriodEndUptime=in.readLong();
  mRuntime=in.readString();
  mHasSwappedOutPss=in.readInt() != 0;
  mFlags=in.readInt();
  mTableData.readFromParcel(in);
  readCompactedLongArray(in,version,mMemFactorDurations,mMemFactorDurations.length);
  if (!mSysMemUsage.readFromParcel(in)) {
    return;
  }
  int NPROC=in.readInt();
  if (NPROC < 0) {
    mReadError="bad process count: " + NPROC;
    return;
  }
  while (NPROC > 0) {
    NPROC--;
    final String procName=readCommonString(in,version);
    if (procName == null) {
      mReadError="bad process name";
      return;
    }
    int NUID=in.readInt();
    if (NUID < 0) {
      mReadError="bad uid count: " + NUID;
      return;
    }
    while (NUID > 0) {
      NUID--;
      final int uid=in.readInt();
      if (uid < 0) {
        mReadError="bad uid: " + uid;
        return;
      }
      final String pkgName=readCommonString(in,version);
      if (pkgName == null) {
        mReadError="bad process package name";
        return;
      }
      final int vers=in.readInt();
      ProcessState proc=hadData ? mProcesses.get(procName,uid) : null;
      if (proc != null) {
        if (!proc.readFromParcel(in,false)) {
          return;
        }
      }
 else {
        proc=new ProcessState(this,pkgName,uid,vers,procName);
        if (!proc.readFromParcel(in,true)) {
          return;
        }
      }
      if (DEBUG_PARCEL)       Slog.d(TAG,"Adding process: " + procName + " "+ uid+ " "+ proc);
      mProcesses.put(procName,uid,proc);
    }
  }
  if (DEBUG_PARCEL)   Slog.d(TAG,"Read " + mProcesses.getMap().size() + " processes");
  int NPKG=in.readInt();
  if (NPKG < 0) {
    mReadError="bad package count: " + NPKG;
    return;
  }
  while (NPKG > 0) {
    NPKG--;
    final String pkgName=readCommonString(in,version);
    if (pkgName == null) {
      mReadError="bad package name";
      return;
    }
    int NUID=in.readInt();
    if (NUID < 0) {
      mReadError="bad uid count: " + NUID;
      return;
    }
    while (NUID > 0) {
      NUID--;
      final int uid=in.readInt();
      if (uid < 0) {
        mReadError="bad uid: " + uid;
        return;
      }
      int NVERS=in.readInt();
      if (NVERS < 0) {
        mReadError="bad versions count: " + NVERS;
        return;
      }
      while (NVERS > 0) {
        NVERS--;
        final int vers=in.readInt();
        PackageState pkgState=new PackageState(pkgName,uid);
        SparseArray<PackageState> vpkg=mPackages.get(pkgName,uid);
        if (vpkg == null) {
          vpkg=new SparseArray<PackageState>();
          mPackages.put(pkgName,uid,vpkg);
        }
        vpkg.put(vers,pkgState);
        int NPROCS=in.readInt();
        if (NPROCS < 0) {
          mReadError="bad package process count: " + NPROCS;
          return;
        }
        while (NPROCS > 0) {
          NPROCS--;
          String procName=readCommonString(in,version);
          if (procName == null) {
            mReadError="bad package process name";
            return;
          }
          int hasProc=in.readInt();
          if (DEBUG_PARCEL)           Slog.d(TAG,"Reading package " + pkgName + " "+ uid+ " process "+ procName+ " hasProc="+ hasProc);
          ProcessState commonProc=mProcesses.get(procName,uid);
          if (DEBUG_PARCEL)           Slog.d(TAG,"Got common proc " + procName + " "+ uid+ ": "+ commonProc);
          if (commonProc == null) {
            mReadError="no common proc: " + procName;
            return;
          }
          if (hasProc != 0) {
            ProcessState proc=hadData ? pkgState.mProcesses.get(procName) : null;
            if (proc != null) {
              if (!proc.readFromParcel(in,false)) {
                return;
              }
            }
 else {
              proc=new ProcessState(commonProc,pkgName,uid,vers,procName,0);
              if (!proc.readFromParcel(in,true)) {
                return;
              }
            }
            if (DEBUG_PARCEL)             Slog.d(TAG,"Adding package " + pkgName + " process: "+ procName+ " "+ uid+ " "+ proc);
            pkgState.mProcesses.put(procName,proc);
          }
 else {
            if (DEBUG_PARCEL)             Slog.d(TAG,"Adding package " + pkgName + " process: "+ procName+ " "+ uid+ " "+ commonProc);
            pkgState.mProcesses.put(procName,commonProc);
          }
        }
        int NSRVS=in.readInt();
        if (NSRVS < 0) {
          mReadError="bad package service count: " + NSRVS;
          return;
        }
        while (NSRVS > 0) {
          NSRVS--;
          String serviceName=in.readString();
          if (serviceName == null) {
            mReadError="bad package service name";
            return;
          }
          String processName=version > 9 ? readCommonString(in,version) : null;
          ServiceState serv=hadData ? pkgState.mServices.get(serviceName) : null;
          if (serv == null) {
            serv=new ServiceState(this,pkgName,serviceName,processName,null);
          }
          if (!serv.readFromParcel(in)) {
            return;
          }
          if (DEBUG_PARCEL)           Slog.d(TAG,"Adding package " + pkgName + " service: "+ serviceName+ " "+ uid+ " "+ serv);
          pkgState.mServices.put(serviceName,serv);
        }
      }
    }
  }
  final int NPAGETYPES=in.readInt();
  mPageTypeZones.clear();
  mPageTypeZones.ensureCapacity(NPAGETYPES);
  mPageTypeLabels.clear();
  mPageTypeLabels.ensureCapacity(NPAGETYPES);
  mPageTypeSizes.clear();
  mPageTypeSizes.ensureCapacity(NPAGETYPES);
  for (int i=0; i < NPAGETYPES; i++) {
    mPageTypeZones.add(in.readInt());
    mPageTypeLabels.add(in.readString());
    mPageTypeSizes.add(in.createIntArray());
  }
  mIndexToCommonString=null;
  if (DEBUG_PARCEL)   Slog.d(TAG,"Successfully read procstats!");
}
