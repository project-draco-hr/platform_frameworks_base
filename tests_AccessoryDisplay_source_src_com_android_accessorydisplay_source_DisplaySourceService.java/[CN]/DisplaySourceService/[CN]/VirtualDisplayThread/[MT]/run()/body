{
  MediaFormat format=MediaFormat.createVideoFormat("video/avc",mWidth,mHeight);
  format.setInteger(MediaFormat.KEY_COLOR_FORMAT,MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);
  format.setInteger(MediaFormat.KEY_BIT_RATE,BIT_RATE);
  format.setInteger(MediaFormat.KEY_FRAME_RATE,FRAME_RATE);
  format.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL,I_FRAME_INTERVAL);
  MediaCodec codec;
  try {
    codec=MediaCodec.createEncoderByType("video/avc");
  }
 catch (  IOException e) {
    throw new RuntimeException("IOException in MediaCodec.createEncoderByType for video/avc",e);
  }
  codec.configure(format,null,null,MediaCodec.CONFIGURE_FLAG_ENCODE);
  Surface surface=codec.createInputSurface();
  codec.start();
  VirtualDisplay virtualDisplay=mDisplayManager.createVirtualDisplay(DISPLAY_NAME,mWidth,mHeight,mDensityDpi,surface,0);
  if (virtualDisplay != null) {
    mHandler.obtainMessage(MSG_DISPATCH_DISPLAY_ADDED,virtualDisplay.getDisplay()).sendToTarget();
    stream(codec);
    mHandler.obtainMessage(MSG_DISPATCH_DISPLAY_REMOVED,virtualDisplay.getDisplay()).sendToTarget();
    virtualDisplay.release();
  }
  codec.signalEndOfInputStream();
  codec.stop();
}
