{
synchronized (mWindowMap) {
    mWaitingForDrawnCallback=callback;
    for (int displayNdx=mDisplayContents.size() - 1; displayNdx >= 0; --displayNdx) {
      final WindowList windows=mDisplayContents.valueAt(displayNdx).getWindowList();
      for (int winNdx=windows.size() - 1; winNdx >= 0; --winNdx) {
        final WindowState win=windows.get(winNdx);
        if (win.mHasSurface) {
          win.mWinAnimator.mDrawState=WindowStateAnimator.DRAW_PENDING;
          win.mLastContentInsets.set(-1,-1,-1,-1);
          if (DEBUG_SCREEN_ON)           Slog.d(TAG,"waitForAllWindowsDrawn: adding " + win);
          mWaitingForDrawn.add(win);
        }
      }
    }
    requestTraversalLocked();
    mH.removeMessages(H.WAITING_FOR_DRAWN_TIMEOUT);
    mH.sendEmptyMessageDelayed(H.WAITING_FOR_DRAWN_TIMEOUT,timeout);
  }
  checkDrawnWindowsLocked();
}
