{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"addAppToken()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
  long inputDispatchingTimeoutNanos;
  try {
    inputDispatchingTimeoutNanos=token.getKeyDispatchingTimeout() * 1000000L;
  }
 catch (  RemoteException ex) {
    Slog.w(TAG_WM,"Could not get dispatching timeout.",ex);
    inputDispatchingTimeoutNanos=DEFAULT_INPUT_DISPATCHING_TIMEOUT_NANOS;
  }
synchronized (mWindowMap) {
    AppWindowToken atoken=findAppWindowToken(token.asBinder());
    if (atoken != null) {
      Slog.w(TAG_WM,"Attempted to add existing app token: " + token);
      return;
    }
    atoken=new AppWindowToken(this,token,voiceInteraction);
    atoken.inputDispatchingTimeoutNanos=inputDispatchingTimeoutNanos;
    atoken.appFullscreen=fullscreen;
    atoken.showForAllUsers=showForAllUsers;
    atoken.requestedOrientation=requestedOrientation;
    atoken.layoutConfigChanges=(configChanges & (ActivityInfo.CONFIG_SCREEN_SIZE | ActivityInfo.CONFIG_ORIENTATION)) != 0;
    atoken.mLaunchTaskBehind=launchTaskBehind;
    atoken.mCropWindowsToStack=cropWindowsToStack;
    if (DEBUG_TOKEN_MOVEMENT || DEBUG_ADD_REMOVE)     Slog.v(TAG_WM,"addAppToken: " + atoken + " to stack="+ stackId+ " task="+ taskId+ " at "+ addPos);
    Task task=mTaskIdToTask.get(taskId);
    if (task == null) {
      task=createTaskLocked(taskId,stackId,userId,atoken,taskBounds,config);
    }
    task.addAppToken(addPos,atoken);
    mTokenMap.put(token.asBinder(),atoken);
    atoken.hidden=true;
    atoken.hiddenRequested=true;
  }
}
