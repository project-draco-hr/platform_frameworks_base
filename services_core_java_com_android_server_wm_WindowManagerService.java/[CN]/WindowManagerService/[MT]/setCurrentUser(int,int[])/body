{
synchronized (mWindowMap) {
    mCurrentUserId=newUserId;
    mCurrentProfileIds=currentProfileIds;
    mAppTransition.setCurrentUser(newUserId);
    mPolicy.setCurrentUserLw(newUserId);
    mPolicy.enableKeyguard(true);
    final int numDisplays=mDisplayContents.size();
    for (int displayNdx=0; displayNdx < numDisplays; ++displayNdx) {
      final DisplayContent displayContent=mDisplayContents.valueAt(displayNdx);
      displayContent.switchUserStacks();
      rebuildAppWindowListLocked(displayContent);
    }
    mWindowPlacerLocked.performSurfacePlacement();
    final DisplayContent displayContent=getDefaultDisplayContentLocked();
    displayContent.mDividerControllerLocked.notifyDockedStackExistsChanged(hasDockedTasksForUser(newUserId));
    if (mDisplayReady) {
      final int forcedDensity=getForcedDisplayDensityForUserLocked(newUserId);
      final int targetDensity=forcedDensity != 0 ? forcedDensity : displayContent.mInitialDisplayDensity;
      setForcedDisplayDensityLocked(displayContent,targetDensity);
    }
  }
}
