{
  if (DEBUG_DRAG) {
    Slog.d(TAG_WM,"prepare drag surface: w=" + width + " h="+ height+ " flags="+ Integer.toHexString(flags)+ " win="+ window+ " asbinder="+ window.asBinder());
  }
  final int callerPid=Binder.getCallingPid();
  final int callerUid=Binder.getCallingUid();
  final long origId=Binder.clearCallingIdentity();
  IBinder token=null;
  try {
synchronized (mWindowMap) {
      try {
        if (mDragState == null) {
          final DisplayContent displayContent=getDefaultDisplayContentLocked();
          final Display display=displayContent.getDisplay();
          SurfaceControl surface=new SurfaceControl(session,"drag surface",width,height,PixelFormat.TRANSLUCENT,SurfaceControl.HIDDEN);
          surface.setLayerStack(display.getLayerStack());
          float alpha=1;
          if ((flags & View.DRAG_FLAG_OPAQUE) == 0) {
            alpha=DRAG_SHADOW_ALPHA_TRANSPARENT;
          }
          surface.setAlpha(alpha);
          if (SHOW_TRANSACTIONS)           Slog.i(TAG_WM,"  DRAG " + surface + ": CREATE");
          outSurface.copyFrom(surface);
          final IBinder winBinder=window.asBinder();
          token=new Binder();
          mDragState=new DragState(this,token,surface,flags,winBinder);
          mDragState.mPid=callerPid;
          mDragState.mUid=callerUid;
          mDragState.mOriginalAlpha=alpha;
          token=mDragState.mToken=new Binder();
          mH.removeMessages(H.DRAG_START_TIMEOUT,winBinder);
          Message msg=mH.obtainMessage(H.DRAG_START_TIMEOUT,winBinder);
          mH.sendMessageDelayed(msg,5000);
        }
 else {
          Slog.w(TAG_WM,"Drag already in progress");
        }
      }
 catch (      OutOfResourcesException e) {
        Slog.e(TAG_WM,"Can't allocate drag surface w=" + width + " h="+ height,e);
        if (mDragState != null) {
          mDragState.reset();
          mDragState=null;
        }
      }
    }
  }
  finally {
    Binder.restoreCallingIdentity(origId);
  }
  return token;
}
