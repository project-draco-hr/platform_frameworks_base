{
  int appsCount=mOpeningApps.size();
  if (!checkIfTransitionGoodToGo(appsCount)) {
    return 0;
  }
  if (DEBUG_APP_TRANSITIONS)   Slog.v(TAG,"**** GOOD TO GO");
  int transit=mAppTransition.getAppTransition();
  if (mSkipAppTransitionAnimation) {
    transit=AppTransition.TRANSIT_UNSET;
  }
  mSkipAppTransitionAnimation=false;
  mNoAnimationNotifyOnTransitionFinished.clear();
  mH.removeMessages(H.APP_TRANSITION_TIMEOUT);
  rebuildAppWindowListLocked();
  mInnerFields.mWallpaperMayChange=false;
  LayoutParams animLp=null;
  int bestAnimLayer=-1;
  boolean fullscreenAnim=false;
  boolean voiceInteraction=false;
  final WindowState lowerWallpaperTarget=mWallpaperControllerLocked.getLowerWallpaperTarget();
  final WindowState upperWallpaperTarget=mWallpaperControllerLocked.getUpperWallpaperTarget();
  boolean openingAppHasWallpaper=false;
  boolean closingAppHasWallpaper=false;
  final AppWindowToken lowerWallpaperAppToken;
  final AppWindowToken upperWallpaperAppToken;
  if (lowerWallpaperTarget == null) {
    lowerWallpaperAppToken=upperWallpaperAppToken=null;
  }
 else {
    lowerWallpaperAppToken=lowerWallpaperTarget.mAppToken;
    upperWallpaperAppToken=upperWallpaperTarget.mAppToken;
  }
  int i;
  final int closingAppsCount=mClosingApps.size();
  appsCount=closingAppsCount + mOpeningApps.size();
  for (i=0; i < appsCount; i++) {
    final AppWindowToken wtoken;
    if (i < closingAppsCount) {
      wtoken=mClosingApps.valueAt(i);
      if (wtoken == lowerWallpaperAppToken || wtoken == upperWallpaperAppToken) {
        closingAppHasWallpaper=true;
      }
    }
 else {
      wtoken=mOpeningApps.valueAt(i - closingAppsCount);
      if (wtoken == lowerWallpaperAppToken || wtoken == upperWallpaperAppToken) {
        openingAppHasWallpaper=true;
      }
    }
    voiceInteraction|=wtoken.voiceInteraction;
    if (wtoken.appFullscreen) {
      WindowState ws=wtoken.findMainWindow();
      if (ws != null) {
        animLp=ws.mAttrs;
        bestAnimLayer=ws.mLayer;
        fullscreenAnim=true;
      }
    }
 else     if (!fullscreenAnim) {
      WindowState ws=wtoken.findMainWindow();
      if (ws != null) {
        if (ws.mLayer > bestAnimLayer) {
          animLp=ws.mAttrs;
          bestAnimLayer=ws.mLayer;
        }
      }
    }
  }
  transit=maybeUpdateTransitToWallpaper(transit,openingAppHasWallpaper,closingAppHasWallpaper,lowerWallpaperTarget,upperWallpaperTarget);
  if (!mPolicy.allowAppAnimationsLw()) {
    if (DEBUG_APP_TRANSITIONS)     Slog.v(TAG,"Animations disallowed by keyguard or dream.");
    animLp=null;
  }
  processApplicationsAnimatingInPlace(transit);
  AppWindowToken topClosingApp=null;
  int topClosingLayer=0;
  appsCount=mClosingApps.size();
  for (i=0; i < appsCount; i++) {
    AppWindowToken wtoken=mClosingApps.valueAt(i);
    final AppWindowAnimator appAnimator=wtoken.mAppAnimator;
    if (DEBUG_APP_TRANSITIONS)     Slog.v(TAG,"Now closing app " + wtoken);
    appAnimator.clearThumbnail();
    appAnimator.animation=null;
    wtoken.inPendingTransaction=false;
    setTokenVisibilityLocked(wtoken,animLp,false,transit,false,voiceInteraction);
    wtoken.updateReportedVisibilityLocked();
    wtoken.allDrawn=true;
    wtoken.deferClearAllDrawn=false;
    if (wtoken.startingWindow != null && !wtoken.startingWindow.mExiting) {
      scheduleRemoveStartingWindowLocked(wtoken);
    }
    mAnimator.mAppWindowAnimating|=appAnimator.isAnimating();
    if (animLp != null) {
      int layer=-1;
      for (int j=0; j < wtoken.windows.size(); j++) {
        WindowState win=wtoken.windows.get(j);
        if (win.mWinAnimator.mAnimLayer > layer) {
          layer=win.mWinAnimator.mAnimLayer;
        }
      }
      if (topClosingApp == null || layer > topClosingLayer) {
        topClosingApp=wtoken;
        topClosingLayer=layer;
      }
    }
  }
  AppWindowToken topOpeningApp=null;
  appsCount=mOpeningApps.size();
  for (i=0; i < appsCount; i++) {
    AppWindowToken wtoken=mOpeningApps.valueAt(i);
    final AppWindowAnimator appAnimator=wtoken.mAppAnimator;
    if (DEBUG_APP_TRANSITIONS)     Slog.v(TAG,"Now opening app" + wtoken);
    if (!appAnimator.usingTransferredAnimation) {
      appAnimator.clearThumbnail();
      appAnimator.animation=null;
    }
    wtoken.inPendingTransaction=false;
    if (!setTokenVisibilityLocked(wtoken,animLp,true,transit,false,voiceInteraction)) {
      mNoAnimationNotifyOnTransitionFinished.add(wtoken.token);
    }
    wtoken.updateReportedVisibilityLocked();
    wtoken.waitingToShow=false;
    appAnimator.mAllAppWinAnimators.clear();
    final int windowsCount=wtoken.allAppWindows.size();
    for (int j=0; j < windowsCount; j++) {
      appAnimator.mAllAppWinAnimators.add(wtoken.allAppWindows.get(j).mWinAnimator);
    }
    mAnimator.mAnimating|=appAnimator.showAllWindowsLocked();
    mAnimator.mAppWindowAnimating|=appAnimator.isAnimating();
    int topOpeningLayer=0;
    if (animLp != null) {
      int layer=-1;
      for (int j=0; j < wtoken.windows.size(); j++) {
        WindowState win=wtoken.windows.get(j);
        if (win.mWinAnimator.mAnimLayer > layer) {
          layer=win.mWinAnimator.mAnimLayer;
        }
      }
      if (topOpeningApp == null || layer > topOpeningLayer) {
        topOpeningApp=wtoken;
        topOpeningLayer=layer;
      }
    }
    createThumbnailAppAnimator(transit,wtoken,topOpeningLayer,topClosingLayer);
  }
  AppWindowAnimator openingAppAnimator=(topOpeningApp == null) ? null : topOpeningApp.mAppAnimator;
  AppWindowAnimator closingAppAnimator=(topClosingApp == null) ? null : topClosingApp.mAppAnimator;
  mAppTransition.goodToGo(openingAppAnimator,closingAppAnimator);
  mAppTransition.postAnimationCallback();
  mAppTransition.clear();
  mOpeningApps.clear();
  mClosingApps.clear();
  getDefaultDisplayContentLocked().layoutNeeded=true;
  if (windows == getDefaultWindowListLocked() && !moveInputMethodWindowsIfNeededLocked(true)) {
    assignLayersLocked(windows);
  }
  updateFocusedWindowLocked(UPDATE_FOCUS_PLACING_SURFACES,true);
  mFocusMayChange=false;
  notifyActivityDrawnForKeyguard();
  return WindowManagerPolicy.FINISH_LAYOUT_REDO_LAYOUT | WindowManagerPolicy.FINISH_LAYOUT_REDO_CONFIG;
}
