{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"setFocusedApp()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
synchronized (mWindowMap) {
    final AppWindowToken newFocus;
    if (token == null) {
      if (DEBUG_FOCUS_LIGHT)       Slog.v(TAG,"Clearing focused app, was " + mFocusedApp);
      newFocus=null;
    }
 else {
      newFocus=findAppWindowToken(token);
      if (newFocus == null) {
        Slog.w(TAG,"Attempted to set focus to non-existing app token: " + token);
      }
      if (DEBUG_FOCUS_LIGHT)       Slog.v(TAG,"Set focused app to: " + newFocus + " old focus="+ mFocusedApp+ " moveFocusNow="+ moveFocusNow);
    }
    final boolean changed=mFocusedApp != newFocus;
    if (changed) {
      mFocusedApp=newFocus;
      mInputMonitor.setFocusedAppLw(newFocus);
      setFocusedStackFrame();
      if (SHOW_LIGHT_TRANSACTIONS)       Slog.i(TAG,">>> OPEN TRANSACTION setFocusedApp");
      SurfaceControl.openTransaction();
      try {
        setFocusedStackLayer();
      }
  finally {
        SurfaceControl.closeTransaction();
        if (SHOW_LIGHT_TRANSACTIONS)         Slog.i(TAG,">>> CLOSE TRANSACTION setFocusedApp");
      }
    }
    if (moveFocusNow && changed) {
      final long origId=Binder.clearCallingIdentity();
      updateFocusedWindowLocked(UPDATE_FOCUS_NORMAL,true);
      Binder.restoreCallingIdentity(origId);
    }
  }
}
