{
  if (!checkCallingPermission(Manifest.permission.READ_FRAME_BUFFER,"screenshotApplications()")) {
    throw new SecurityException("Requires READ_FRAME_BUFFER permission");
  }
  final DisplayContent displayContent=getDisplayContentLocked(displayId);
  if (displayContent == null) {
    if (DEBUG_SCREENSHOT)     Slog.i(TAG,"Screenshot of " + appToken + ": returning null. No Display for displayId="+ displayId);
    return null;
  }
  final DisplayInfo displayInfo=displayContent.getDisplayInfo();
  int dw=displayInfo.logicalWidth;
  int dh=displayInfo.logicalHeight;
  if (dw == 0 || dh == 0) {
    if (DEBUG_SCREENSHOT)     Slog.i(TAG,"Screenshot of " + appToken + ": returning null. logical widthxheight="+ dw+ "x"+ dh);
    return null;
  }
  Bitmap bm=null;
  int maxLayer=0;
  final Rect frame=new Rect();
  final Rect stackBounds=new Rect();
  float scale=0;
  int rot=Surface.ROTATION_0;
  boolean screenshotReady;
  int minLayer;
  if (appToken == null) {
    screenshotReady=true;
    minLayer=0;
  }
 else {
    screenshotReady=false;
    minLayer=Integer.MAX_VALUE;
  }
  int retryCount=0;
  WindowState appWin=null;
  boolean appIsImTarget;
synchronized (mWindowMap) {
    appIsImTarget=mInputMethodTarget != null && mInputMethodTarget.mAppToken != null && mInputMethodTarget.mAppToken.appToken != null && mInputMethodTarget.mAppToken.appToken.asBinder() == appToken;
  }
  final int aboveAppLayer=(mPolicy.windowTypeToLayerLw(TYPE_APPLICATION) + 1) * TYPE_LAYER_MULTIPLIER + TYPE_LAYER_OFFSET;
  while (true) {
    if (retryCount++ > 0) {
      maxLayer=0;
      minLayer=Integer.MAX_VALUE;
      try {
        Thread.sleep(100);
      }
 catch (      InterruptedException e) {
      }
    }
synchronized (mWindowMap) {
      appWin=null;
      final WindowList windows=displayContent.getWindowList();
      for (int i=windows.size() - 1; i >= 0; i--) {
        WindowState ws=windows.get(i);
        if (!ws.mHasSurface) {
          continue;
        }
        if (ws.mLayer >= aboveAppLayer) {
          continue;
        }
        if (ws.mIsImWindow) {
          if (!appIsImTarget) {
            continue;
          }
        }
 else         if (ws.mIsWallpaper) {
          if (appWin == null) {
            continue;
          }
        }
 else         if (appToken != null) {
          if (ws.mAppToken == null || ws.mAppToken.token != appToken) {
            continue;
          }
          appWin=ws;
        }
        final WindowStateAnimator winAnim=ws.mWinAnimator;
        if (maxLayer < winAnim.mSurfaceLayer) {
          maxLayer=winAnim.mSurfaceLayer;
        }
        if (minLayer > winAnim.mSurfaceLayer) {
          minLayer=winAnim.mSurfaceLayer;
        }
        if (!ws.mIsWallpaper) {
          final Rect wf=ws.mFrame;
          final Rect cr=ws.mContentInsets;
          int left=wf.left + cr.left;
          int top=wf.top + cr.top;
          int right=wf.right - cr.right;
          int bottom=wf.bottom - cr.bottom;
          frame.union(left,top,right,bottom);
          ws.getStackBounds(stackBounds);
          frame.intersect(stackBounds);
        }
        if (ws.mAppToken != null && ws.mAppToken.token == appToken && ws.isDisplayedLw() && winAnim.mSurfaceShown) {
          screenshotReady=true;
        }
        if (ws.isFullscreen(dw,dh) && ws.isOpaqueDrawn()) {
          break;
        }
      }
      if (appToken != null && appWin == null) {
        if (DEBUG_SCREENSHOT)         Slog.i(TAG,"Screenshot: Couldn't find a surface matching " + appToken);
        return null;
      }
      if (!screenshotReady) {
        if (retryCount > MAX_SCREENSHOT_RETRIES) {
          Slog.i(TAG,"Screenshot max retries " + retryCount + " of "+ appToken+ " appWin="+ (appWin == null ? "null" : (appWin + " drawState=" + appWin.mWinAnimator.mDrawState)));
          return null;
        }
        if (DEBUG_SCREENSHOT)         Slog.i(TAG,"Screenshot: No image ready for " + appToken + ", "+ appWin+ " drawState="+ appWin.mWinAnimator.mDrawState);
        continue;
      }
      if (maxLayer == 0) {
        if (DEBUG_SCREENSHOT)         Slog.i(TAG,"Screenshot of " + appToken + ": returning null maxLayer="+ maxLayer);
        return null;
      }
      frame.intersect(0,0,dw,dh);
      Rect crop=new Rect(frame);
      if (width / (float)frame.width() < height / (float)frame.height()) {
        int cropWidth=(int)((float)width / (float)height * frame.height());
        crop.right=crop.left + cropWidth;
      }
 else {
        int cropHeight=(int)((float)height / (float)width * frame.width());
        crop.bottom=crop.top + cropHeight;
      }
      rot=getDefaultDisplayContentLocked().getDisplay().getRotation();
      if (rot == Surface.ROTATION_90 || rot == Surface.ROTATION_270) {
        rot=(rot == Surface.ROTATION_90) ? Surface.ROTATION_270 : Surface.ROTATION_90;
      }
      convertCropForSurfaceFlinger(crop,rot,dw,dh);
      if (DEBUG_SCREENSHOT) {
        Slog.i(TAG,"Screenshot: " + dw + "x"+ dh+ " from "+ minLayer+ " to "+ maxLayer+ " appToken="+ appToken);
        for (int i=0; i < windows.size(); i++) {
          WindowState win=windows.get(i);
          Slog.i(TAG,win + ": " + win.mLayer+ " animLayer="+ win.mWinAnimator.mAnimLayer+ " surfaceLayer="+ win.mWinAnimator.mSurfaceLayer);
        }
      }
      ScreenRotationAnimation screenRotationAnimation=mAnimator.getScreenRotationAnimationLocked(Display.DEFAULT_DISPLAY);
      final boolean inRotation=screenRotationAnimation != null && screenRotationAnimation.isAnimating();
      if (DEBUG_SCREENSHOT && inRotation)       Slog.v(TAG,"Taking screenshot while rotating");
      bm=SurfaceControl.screenshot(crop,width,height,minLayer,maxLayer,inRotation,rot);
      if (bm == null) {
        Slog.w(TAG,"Screenshot failure taking screenshot for (" + dw + "x"+ dh+ ") to layer "+ maxLayer);
        return null;
      }
    }
    break;
  }
  if (DEBUG_SCREENSHOT) {
    int[] buffer=new int[bm.getWidth() * bm.getHeight()];
    bm.getPixels(buffer,0,bm.getWidth(),0,0,bm.getWidth(),bm.getHeight());
    boolean allBlack=true;
    final int firstColor=buffer[0];
    for (int i=0; i < buffer.length; i++) {
      if (buffer[i] != firstColor) {
        allBlack=false;
        break;
      }
    }
    if (allBlack) {
      Slog.i(TAG,"Screenshot " + appWin + " was monochrome("+ Integer.toHexString(firstColor)+ ")! mSurfaceLayer="+ (appWin != null ? appWin.mWinAnimator.mSurfaceLayer : "null")+ " minLayer="+ minLayer+ " maxLayer="+ maxLayer);
    }
  }
  Bitmap ret=bm.copy(bm.getConfig(),true);
  bm.recycle();
  return ret;
}
