{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"setAppVisibility()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
  AppWindowToken wtoken;
synchronized (mWindowMap) {
    wtoken=findAppWindowToken(token);
    if (wtoken == null) {
      Slog.w(TAG_WM,"Attempted to set visibility of non-existing app token: " + token);
      return;
    }
    if (DEBUG_APP_TRANSITIONS || DEBUG_ORIENTATION)     Slog.v(TAG_WM,"setAppVisibility(" + token + ", visible="+ visible+ "): "+ mAppTransition+ " hidden="+ wtoken.hidden+ " hiddenRequested="+ wtoken.hiddenRequested+ " Callers="+ Debug.getCallers(6));
    mOpeningApps.remove(wtoken);
    mClosingApps.remove(wtoken);
    wtoken.waitingToShow=false;
    wtoken.hiddenRequested=!visible;
    if (!visible) {
      wtoken.removeAllDeadWindows();
      wtoken.setVisibleBeforeClientHidden();
    }
 else     if (visible) {
      if (!mAppTransition.isTransitionSet() && mAppTransition.isReady()) {
        mOpeningApps.add(wtoken);
      }
      wtoken.startingMoved=false;
      if (wtoken.hidden || wtoken.mAppStopped) {
        wtoken.clearAllDrawn();
        if (wtoken.hidden) {
          wtoken.waitingToShow=true;
        }
        if (wtoken.clientHidden) {
          wtoken.clientHidden=false;
          wtoken.sendAppVisibilityToClients();
        }
      }
      wtoken.requestUpdateWallpaperIfNeeded();
      if (DEBUG_ADD_REMOVE)       Slog.v(TAG_WM,"No longer Stopped: " + wtoken);
      wtoken.mAppStopped=false;
    }
    if (okToDisplay() && mAppTransition.isTransitionSet()) {
      if (wtoken.mAppAnimator.usingTransferredAnimation && wtoken.mAppAnimator.animation == null) {
        Slog.wtf(TAG_WM,"Will NOT set dummy animation on: " + wtoken + ", using null transfered animation!");
      }
      if (!wtoken.mAppAnimator.usingTransferredAnimation && (!wtoken.startingDisplayed || mSkipAppTransitionAnimation)) {
        if (DEBUG_APP_TRANSITIONS)         Slog.v(TAG_WM,"Setting dummy animation on: " + wtoken);
        wtoken.mAppAnimator.setDummyAnimation();
      }
      wtoken.inPendingTransaction=true;
      if (visible) {
        mOpeningApps.add(wtoken);
        wtoken.mEnteringAnimation=true;
      }
 else {
        mClosingApps.add(wtoken);
        wtoken.mEnteringAnimation=false;
      }
      if (mAppTransition.getAppTransition() == AppTransition.TRANSIT_TASK_OPEN_BEHIND) {
        final WindowState win=findFocusedWindowLocked(getDefaultDisplayContentLocked());
        if (win != null) {
          final AppWindowToken focusedToken=win.mAppToken;
          if (focusedToken != null) {
            if (DEBUG_APP_TRANSITIONS)             Slog.d(TAG_WM,"TRANSIT_TASK_OPEN_BEHIND, " + " adding " + focusedToken + " to mOpeningApps");
            focusedToken.hidden=true;
            mOpeningApps.add(focusedToken);
          }
        }
      }
      return;
    }
    final long origId=Binder.clearCallingIdentity();
    wtoken.inPendingTransaction=false;
    setTokenVisibilityLocked(wtoken,null,visible,AppTransition.TRANSIT_UNSET,true,wtoken.voiceInteraction);
    wtoken.updateReportedVisibilityLocked();
    Binder.restoreCallingIdentity(origId);
  }
}
