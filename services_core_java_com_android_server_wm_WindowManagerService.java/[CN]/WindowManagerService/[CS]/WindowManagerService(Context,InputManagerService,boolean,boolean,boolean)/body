{
  mContext=context;
  mHaveInputMethods=haveInputMethods;
  mAllowBootMessages=showBootMsgs;
  mOnlyCore=onlyCore;
  mLimitedAlphaCompositing=context.getResources().getBoolean(com.android.internal.R.bool.config_sf_limitedAlpha);
  mHasPermanentDpad=context.getResources().getBoolean(com.android.internal.R.bool.config_hasPermanentDpad);
  mInputManager=inputManager;
  mDisplayManagerInternal=LocalServices.getService(DisplayManagerInternal.class);
  mDisplaySettings=new DisplaySettings();
  mDisplaySettings.readSettingsLocked();
  LocalServices.addService(WindowManagerPolicy.class,mPolicy);
  mPointerEventDispatcher=new PointerEventDispatcher(mInputManager.monitorInput(TAG));
  mFxSession=new SurfaceSession();
  mDisplayManager=(DisplayManager)context.getSystemService(Context.DISPLAY_SERVICE);
  Display[] displays=mDisplayManager.getDisplays();
  for (  Display display : displays) {
    createDisplayContentLocked(display);
  }
  mKeyguardDisableHandler=new KeyguardDisableHandler(mContext,mPolicy);
  mPowerManager=(PowerManager)context.getSystemService(Context.POWER_SERVICE);
  mPowerManagerInternal=LocalServices.getService(PowerManagerInternal.class);
  mPowerManagerInternal.registerLowPowerModeObserver(new PowerManagerInternal.LowPowerModeListener(){
    @Override public void onLowPowerModeChanged(    boolean enabled){
synchronized (mWindowMap) {
        if (mAnimationsDisabled != enabled) {
          mAnimationsDisabled=enabled;
          dispatchNewAnimatorScaleLocked(null);
        }
      }
    }
  }
);
  mAnimationsDisabled=mPowerManagerInternal.getLowPowerModeEnabled();
  mScreenFrozenLock=mPowerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,"SCREEN_FROZEN");
  mScreenFrozenLock.setReferenceCounted(false);
  mAppTransition=new AppTransition(context,mH);
  mActivityManager=ActivityManagerNative.getDefault();
  mBatteryStats=BatteryStatsService.getService();
  mAppOps=(AppOpsManager)context.getSystemService(Context.APP_OPS_SERVICE);
  AppOpsManager.OnOpChangedInternalListener opListener=new AppOpsManager.OnOpChangedInternalListener(){
    @Override public void onOpChanged(    int op,    String packageName){
      updateAppOpsState();
    }
  }
;
  mAppOps.startWatchingMode(AppOpsManager.OP_SYSTEM_ALERT_WINDOW,null,opListener);
  mAppOps.startWatchingMode(AppOpsManager.OP_TOAST_WINDOW,null,opListener);
  mWindowAnimationScaleSetting=Settings.Global.getFloat(context.getContentResolver(),Settings.Global.WINDOW_ANIMATION_SCALE,mWindowAnimationScaleSetting);
  mTransitionAnimationScaleSetting=Settings.Global.getFloat(context.getContentResolver(),Settings.Global.TRANSITION_ANIMATION_SCALE,mTransitionAnimationScaleSetting);
  setAnimatorDurationScale(Settings.Global.getFloat(context.getContentResolver(),Settings.Global.ANIMATOR_DURATION_SCALE,mAnimatorDurationScaleSetting));
  IntentFilter filter=new IntentFilter();
  filter.addAction(DevicePolicyManager.ACTION_DEVICE_POLICY_MANAGER_STATE_CHANGED);
  mContext.registerReceiver(mBroadcastReceiver,filter);
  mSettingsObserver=new SettingsObserver();
  updateShowImeWithHardKeyboard();
  mHoldingScreenWakeLock=mPowerManager.newWakeLock(PowerManager.SCREEN_BRIGHT_WAKE_LOCK | PowerManager.ON_AFTER_RELEASE,TAG);
  mHoldingScreenWakeLock.setReferenceCounted(false);
  mAnimator=new WindowAnimator(this);
  mAllowTheaterModeWakeFromLayout=context.getResources().getBoolean(com.android.internal.R.bool.config_allowTheaterModeWakeFromWindowLayout);
  LocalServices.addService(WindowManagerInternal.class,new LocalService());
  initPolicy();
  Watchdog.getInstance().addMonitor(this);
  SurfaceControl.openTransaction();
  try {
    createWatermarkInTransaction();
    mFocusedStackFrame=new FocusedStackFrame(getDefaultDisplayContentLocked().getDisplay(),mFxSession);
  }
  finally {
    SurfaceControl.closeTransaction();
  }
  updateCircularDisplayMaskIfNeeded();
  showEmulatorDisplayOverlayIfNeeded();
}
