{
  mPopup=new ListPopupWindow(mContext,null,com.android.internal.R.attr.popupMenuStyle);
  mPopup.setOnItemClickListener(this);
  mPopup.setOnDismissListener(this);
  final MenuAdapter adapter=mOverflowOnly ? mMenu.getOverflowMenuAdapter(MenuBuilder.TYPE_POPUP) : mMenu.getMenuAdapter(MenuBuilder.TYPE_POPUP);
  mPopup.setAdapter(adapter);
  mPopup.setModal(true);
  View anchor=mAnchorView != null ? mAnchorView.get() : null;
  if (anchor == null && mMenu instanceof SubMenuBuilder) {
    SubMenuBuilder subMenu=(SubMenuBuilder)mMenu;
    final MenuItemImpl itemImpl=(MenuItemImpl)subMenu.getItem();
    anchor=itemImpl.getItemView(MenuBuilder.TYPE_ACTION_BUTTON,null);
    mAnchorView=new WeakReference<View>(anchor);
  }
  if (anchor != null) {
    mTreeObserver=anchor.getViewTreeObserver();
    mTreeObserver.addOnGlobalLayoutListener(this);
    mPopup.setAnchorView(anchor);
  }
 else {
    throw new IllegalStateException("MenuPopupHelper cannot be used without an anchor");
  }
  mPopup.setContentWidth(Math.min(measureContentWidth(adapter),mPopupMaxWidth));
  mPopup.show();
  mPopup.getListView().setOnKeyListener(this);
}
