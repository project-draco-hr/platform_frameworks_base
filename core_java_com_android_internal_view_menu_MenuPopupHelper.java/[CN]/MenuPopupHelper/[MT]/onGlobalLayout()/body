{
  if (!isShowing()) {
    mTreeObserver.removeGlobalOnLayoutListener(this);
    mTreeObserver=null;
  }
 else {
    final View anchor=mAnchorView != null ? mAnchorView.get() : null;
    if (anchor != null && !anchor.isShown()) {
      dismiss();
    }
 else {
      mPopup.show();
    }
  }
}
