{
synchronized (mLock) {
    final int resolvedUserId=mSecurityPolicy.resolveCallingUserIdEnforcingPermissionsLocked(userId);
    final int windowId=sNextWindowId++;
    if (mSecurityPolicy.isCallerInteractingAcrossUsers(userId)) {
      AccessibilityConnectionWrapper wrapper=new AccessibilityConnectionWrapper(windowId,connection,UserHandle.USER_ALL);
      wrapper.linkToDeath();
      mGlobalInteractionConnections.put(windowId,wrapper);
      mGlobalWindowTokens.put(windowId,windowToken.asBinder());
      if (DEBUG) {
        Slog.i(LOG_TAG,"Added global connection for pid:" + Binder.getCallingPid() + " with windowId: "+ windowId);
      }
    }
 else {
      AccessibilityConnectionWrapper wrapper=new AccessibilityConnectionWrapper(windowId,connection,resolvedUserId);
      wrapper.linkToDeath();
      UserState userState=getUserStateLocked(resolvedUserId);
      userState.mInteractionConnections.put(windowId,wrapper);
      userState.mWindowTokens.put(windowId,windowToken.asBinder());
      if (DEBUG) {
        Slog.i(LOG_TAG,"Added user connection for pid:" + Binder.getCallingPid() + " with windowId: "+ windowId+ " and userId:"+ mCurrentUserId);
      }
    }
    if (DEBUG) {
      Slog.i(LOG_TAG,"Adding interaction connection to windowId: " + windowId);
    }
    return windowId;
  }
}
