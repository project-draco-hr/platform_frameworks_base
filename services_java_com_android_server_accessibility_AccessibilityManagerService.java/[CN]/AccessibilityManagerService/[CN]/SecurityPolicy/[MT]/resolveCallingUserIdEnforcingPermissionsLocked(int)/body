{
  final int callingUid=Binder.getCallingUid();
  if (callingUid == Process.SYSTEM_UID || callingUid == Process.SHELL_UID) {
    return mCurrentUserId;
  }
  final int callingUserId=UserHandle.getUserId(callingUid);
  if (callingUserId == userId) {
    return userId;
  }
  if (!hasPermission(Manifest.permission.INTERACT_ACROSS_USERS) && !hasPermission(Manifest.permission.INTERACT_ACROSS_USERS_FULL)) {
    throw new SecurityException("Call from user " + callingUserId + " as user "+ userId+ " without permission INTERACT_ACROSS_USERS or "+ "INTERACT_ACROSS_USERS_FULL not allowed.");
  }
  if (userId == UserHandle.USER_CURRENT || userId == UserHandle.USER_CURRENT_OR_SELF) {
    return mCurrentUserId;
  }
  throw new IllegalArgumentException("Calling user can be changed to only " + "UserHandle.USER_CURRENT or UserHandle.USER_CURRENT_OR_SELF.");
}
