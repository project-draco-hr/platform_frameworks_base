{
  long now=System.currentTimeMillis();
  Cursor c=null;
  try {
    c=getVisitedLike(cr,url);
    if (c.moveToFirst()) {
      ContentValues values=new ContentValues();
      if (real) {
        values.put(History.VISITS,c.getInt(1) + 1);
      }
 else {
        values.put(History.USER_ENTERED,1);
      }
      values.put(History.DATE_LAST_VISITED,now);
      cr.update(ContentUris.withAppendedId(History.CONTENT_URI,c.getLong(0)),values,null,null);
    }
 else {
      truncateHistory(cr);
      ContentValues values=new ContentValues();
      int visits;
      int user_entered;
      if (real) {
        visits=1;
        user_entered=0;
      }
 else {
        visits=0;
        user_entered=1;
      }
      values.put(History.URL,url);
      values.put(History.VISITS,visits);
      values.put(History.DATE_LAST_VISITED,now);
      values.put(History.TITLE,url);
      values.put(History.DATE_CREATED,0);
      values.put(History.USER_ENTERED,user_entered);
      cr.insert(History.CONTENT_URI,values);
    }
  }
 catch (  IllegalStateException e) {
    Log.e(LOGTAG,"updateVisitedHistory",e);
  }
 finally {
    if (c != null)     c.close();
  }
}
