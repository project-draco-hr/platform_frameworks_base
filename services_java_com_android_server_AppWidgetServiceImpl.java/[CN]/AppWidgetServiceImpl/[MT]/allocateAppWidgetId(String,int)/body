{
  int callingUid=enforceSystemOrCallingUid(packageName);
synchronized (mAppWidgetIds) {
    ensureStateLoadedLocked();
    int appWidgetId=mNextAppWidgetId++;
    Host host=lookupOrAddHostLocked(callingUid,packageName,hostId);
    AppWidgetId id=new AppWidgetId();
    id.appWidgetId=appWidgetId;
    id.host=host;
    host.instances.add(id);
    mAppWidgetIds.add(id);
    saveStateAsync();
    if (DBG)     log("Allocating AppWidgetId for " + packageName + " host="+ hostId+ " id="+ appWidgetId);
    return appWidgetId;
  }
}
