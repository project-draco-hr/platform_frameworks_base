{
  final long ident=Binder.clearCallingIdentity();
  try {
synchronized (mAppWidgetIds) {
      options=cloneIfLocalBinder(options);
      ensureStateLoadedLocked();
      AppWidgetId id=lookupAppWidgetIdLocked(appWidgetId);
      if (id == null) {
        throw new IllegalArgumentException("bad appWidgetId");
      }
      if (id.provider != null) {
        throw new IllegalArgumentException("appWidgetId " + appWidgetId + " already bound to "+ id.provider.info.provider);
      }
      Provider p=lookupProviderLocked(provider);
      if (p == null) {
        throw new IllegalArgumentException("not a appwidget provider: " + provider);
      }
      if (p.zombie) {
        throw new IllegalArgumentException("can't bind to a 3rd party provider in" + " safe mode: " + provider);
      }
      id.provider=p;
      if (options == null) {
        options=new Bundle();
      }
      id.options=options;
      if (!options.containsKey(AppWidgetManager.OPTION_APPWIDGET_HOST_CATEGORY)) {
        options.putInt(AppWidgetManager.OPTION_APPWIDGET_HOST_CATEGORY,AppWidgetProviderInfo.WIDGET_CATEGORY_HOME_SCREEN);
      }
      p.instances.add(id);
      int instancesSize=p.instances.size();
      if (instancesSize == 1) {
        sendEnableIntentLocked(p);
      }
      sendUpdateIntentLocked(p,new int[]{appWidgetId});
      registerForBroadcastsLocked(p,getAppWidgetIds(p));
      saveStateLocked();
    }
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
}
