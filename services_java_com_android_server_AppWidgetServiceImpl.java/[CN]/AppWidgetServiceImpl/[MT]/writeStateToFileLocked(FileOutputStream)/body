{
  int N;
  try {
    XmlSerializer out=new FastXmlSerializer();
    out.setOutput(stream,"utf-8");
    out.startDocument(null,true);
    out.startTag(null,"gs");
    int providerIndex=0;
    N=mInstalledProviders.size();
    for (int i=0; i < N; i++) {
      Provider p=mInstalledProviders.get(i);
      if (p.instances.size() > 0) {
        out.startTag(null,"p");
        out.attribute(null,"pkg",p.info.provider.getPackageName());
        out.attribute(null,"cl",p.info.provider.getClassName());
        out.endTag(null,"p");
        p.tag=providerIndex;
        providerIndex++;
      }
    }
    N=mHosts.size();
    for (int i=0; i < N; i++) {
      Host host=mHosts.get(i);
      out.startTag(null,"h");
      out.attribute(null,"pkg",host.packageName);
      out.attribute(null,"id",Integer.toHexString(host.hostId));
      out.endTag(null,"h");
      host.tag=i;
    }
    N=mAppWidgetIds.size();
    for (int i=0; i < N; i++) {
      AppWidgetId id=mAppWidgetIds.get(i);
      out.startTag(null,"g");
      out.attribute(null,"id",Integer.toHexString(id.appWidgetId));
      out.attribute(null,"h",Integer.toHexString(id.host.tag));
      if (id.provider != null) {
        out.attribute(null,"p",Integer.toHexString(id.provider.tag));
      }
      out.endTag(null,"g");
    }
    Iterator<String> it=mPackagesWithBindWidgetPermission.iterator();
    while (it.hasNext()) {
      out.startTag(null,"b");
      out.attribute(null,"packageName",it.next());
      out.endTag(null,"b");
    }
    out.endTag(null,"gs");
    out.endDocument();
    return true;
  }
 catch (  IOException e) {
    Slog.w(TAG,"Failed to write state: " + e);
    return false;
  }
}
