{
  if (mIteratingHistory) {
    throw new IllegalStateException("Can't do this while iterating history!");
  }
  mHistoryBufferLastPos=mHistoryBuffer.dataPosition();
  mHistoryLastLastWritten.setTo(mHistoryLastWritten);
  mHistoryLastWritten.setTo(mHistoryBaseTime + elapsedRealtimeMs,cmd,mHistoryCur);
  writeHistoryDelta(mHistoryBuffer,mHistoryLastWritten,mHistoryLastLastWritten);
  mLastHistoryElapsedRealtime=elapsedRealtimeMs;
  mLastHistoryUptime=uptimeMs;
  mHistoryCur.wakelockTag=null;
  mHistoryCur.wakeReasonTag=null;
  mHistoryCur.eventCode=HistoryItem.EVENT_NONE;
  mHistoryCur.eventTag=null;
  if (DEBUG_HISTORY)   Slog.i(TAG,"Writing history buffer: was " + mHistoryBufferLastPos + " now "+ mHistoryBuffer.dataPosition()+ " size is now "+ mHistoryBuffer.dataSize());
}
