{
  if (!mHaveBatteryLevel || !mRecordingHistory) {
    return;
  }
  final long timeDiff=(mHistoryBaseTime + elapsedRealtimeMs) - mHistoryLastWritten.time;
  final int diffStates=mHistoryLastWritten.states ^ mHistoryCur.states;
  final int lastDiffStates=mHistoryLastWritten.states ^ mHistoryLastLastWritten.states;
  if (DEBUG)   Slog.i(TAG,"ADD: tdelta=" + timeDiff + " diff="+ Integer.toHexString(diffStates)+ " lastDiff="+ Integer.toHexString(lastDiffStates));
  if (mHistoryBufferLastPos >= 0 && mHistoryLastWritten.cmd == HistoryItem.CMD_UPDATE && timeDiff < 1000 && (diffStates & lastDiffStates) == 0 && (mHistoryLastWritten.wakelockTag == null || mHistoryCur.wakelockTag == null) && (mHistoryLastWritten.wakeReasonTag == null || mHistoryCur.wakeReasonTag == null) && (mHistoryLastWritten.eventCode == HistoryItem.EVENT_NONE || mHistoryCur.eventCode == HistoryItem.EVENT_NONE) && mHistoryLastWritten.batteryLevel == mHistoryCur.batteryLevel && mHistoryLastWritten.batteryStatus == mHistoryCur.batteryStatus && mHistoryLastWritten.batteryHealth == mHistoryCur.batteryHealth && mHistoryLastWritten.batteryPlugType == mHistoryCur.batteryPlugType && mHistoryLastWritten.batteryTemperature == mHistoryCur.batteryTemperature && mHistoryLastWritten.batteryVoltage == mHistoryCur.batteryVoltage) {
    if (DEBUG)     Slog.i(TAG,"ADD: rewinding back to " + mHistoryBufferLastPos);
    mHistoryBuffer.setDataSize(mHistoryBufferLastPos);
    mHistoryBuffer.setDataPosition(mHistoryBufferLastPos);
    mHistoryBufferLastPos=-1;
    elapsedRealtimeMs=mHistoryLastWritten.time - mHistoryBaseTime;
    if (mHistoryLastWritten.wakelockTag != null) {
      mHistoryCur.wakelockTag=mHistoryCur.localWakelockTag;
      mHistoryCur.wakelockTag.setTo(mHistoryLastWritten.wakelockTag);
    }
    if (mHistoryLastWritten.wakeReasonTag != null) {
      mHistoryCur.wakeReasonTag=mHistoryCur.localWakeReasonTag;
      mHistoryCur.wakeReasonTag.setTo(mHistoryLastWritten.wakeReasonTag);
    }
    if (mHistoryLastWritten.eventCode != HistoryItem.EVENT_NONE) {
      mHistoryCur.eventCode=mHistoryLastWritten.eventCode;
      mHistoryCur.eventTag=mHistoryCur.localEventTag;
      mHistoryCur.eventTag.setTo(mHistoryLastWritten.eventTag);
    }
    mHistoryLastWritten.setTo(mHistoryLastLastWritten);
  }
  final int dataSize=mHistoryBuffer.dataSize();
  if (dataSize >= MAX_HISTORY_BUFFER) {
    if (!mHistoryOverflow) {
      mHistoryOverflow=true;
      addHistoryBufferLocked(elapsedRealtimeMs,uptimeMs,HistoryItem.CMD_UPDATE);
      addHistoryBufferLocked(elapsedRealtimeMs,uptimeMs,HistoryItem.CMD_OVERFLOW);
      return;
    }
    if (mHistoryLastWritten.batteryLevel == mHistoryCur.batteryLevel && (dataSize >= MAX_MAX_HISTORY_BUFFER || ((mHistoryLastWritten.states ^ mHistoryCur.states) & HistoryItem.MOST_INTERESTING_STATES) == 0)) {
      return;
    }
    addHistoryBufferLocked(elapsedRealtimeMs,uptimeMs,HistoryItem.CMD_UPDATE);
    return;
  }
  addHistoryBufferLocked(elapsedRealtimeMs,uptimeMs,HistoryItem.CMD_UPDATE);
}
