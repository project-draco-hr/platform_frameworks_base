{
  pullPendingStateUpdatesLocked();
  final long NOW_SYS=SystemClock.uptimeMillis() * 1000;
  final long NOWREAL_SYS=SystemClock.elapsedRealtime() * 1000;
  out.writeInt(VERSION);
  writeHistory(out,true);
  out.writeInt(mStartCount);
  out.writeLong(computeUptime(NOW_SYS,STATS_SINCE_CHARGED));
  out.writeLong(computeRealtime(NOWREAL_SYS,STATS_SINCE_CHARGED));
  out.writeLong(mStartClockTime);
  mOnBatteryTimeBase.writeSummaryToParcel(out,NOW_SYS,NOWREAL_SYS);
  mOnBatteryScreenOffTimeBase.writeSummaryToParcel(out,NOW_SYS,NOWREAL_SYS);
  out.writeInt(mDischargeUnplugLevel);
  out.writeInt(mDischargePlugLevel);
  out.writeInt(mDischargeCurrentLevel);
  out.writeInt(mCurrentBatteryLevel);
  out.writeInt(getLowDischargeAmountSinceCharge());
  out.writeInt(getHighDischargeAmountSinceCharge());
  out.writeInt(getDischargeAmountScreenOnSinceCharge());
  out.writeInt(getDischargeAmountScreenOffSinceCharge());
  mScreenOnTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  for (int i=0; i < NUM_SCREEN_BRIGHTNESS_BINS; i++) {
    mScreenBrightnessTimer[i].writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  }
  mInputEventCounter.writeSummaryFromParcelLocked(out);
  mPhoneOnTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  for (int i=0; i < SignalStrength.NUM_SIGNAL_STRENGTH_BINS; i++) {
    mPhoneSignalStrengthsTimer[i].writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  }
  mPhoneSignalScanningTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  for (int i=0; i < NUM_DATA_CONNECTION_TYPES; i++) {
    mPhoneDataConnectionsTimer[i].writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  }
  for (int i=0; i < NUM_NETWORK_ACTIVITY_TYPES; i++) {
    mNetworkByteActivityCounters[i].writeSummaryFromParcelLocked(out);
    mNetworkPacketActivityCounters[i].writeSummaryFromParcelLocked(out);
  }
  mMobileRadioActiveTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  mMobileRadioActivePerAppTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  mMobileRadioActiveAdjustedTime.writeSummaryFromParcelLocked(out);
  mMobileRadioActiveUnknownTime.writeSummaryFromParcelLocked(out);
  mMobileRadioActiveUnknownCount.writeSummaryFromParcelLocked(out);
  mWifiOnTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  mGlobalWifiRunningTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  for (int i=0; i < NUM_WIFI_STATES; i++) {
    mWifiStateTimer[i].writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  }
  mBluetoothOnTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  for (int i=0; i < NUM_BLUETOOTH_STATES; i++) {
    mBluetoothStateTimer[i].writeSummaryFromParcelLocked(out,NOWREAL_SYS);
  }
  out.writeInt(mKernelWakelockStats.size());
  for (  Map.Entry<String,SamplingTimer> ent : mKernelWakelockStats.entrySet()) {
    Timer kwlt=ent.getValue();
    if (kwlt != null) {
      out.writeInt(1);
      out.writeString(ent.getKey());
      kwlt.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
  }
  out.writeInt(mWakeupReasonStats.size());
  for (  Map.Entry<String,LongSamplingCounter> ent : mWakeupReasonStats.entrySet()) {
    LongSamplingCounter counter=ent.getValue();
    if (counter != null) {
      out.writeInt(1);
      out.writeString(ent.getKey());
      counter.writeSummaryFromParcelLocked(out);
    }
 else {
      out.writeInt(0);
    }
  }
  out.writeInt(sNumSpeedSteps);
  final int NU=mUidStats.size();
  out.writeInt(NU);
  for (int iu=0; iu < NU; iu++) {
    out.writeInt(mUidStats.keyAt(iu));
    Uid u=mUidStats.valueAt(iu);
    if (u.mWifiRunningTimer != null) {
      out.writeInt(1);
      u.mWifiRunningTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    if (u.mFullWifiLockTimer != null) {
      out.writeInt(1);
      u.mFullWifiLockTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    if (u.mWifiScanTimer != null) {
      out.writeInt(1);
      u.mWifiScanTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    for (int i=0; i < Uid.NUM_WIFI_BATCHED_SCAN_BINS; i++) {
      if (u.mWifiBatchedScanTimer[i] != null) {
        out.writeInt(1);
        u.mWifiBatchedScanTimer[i].writeSummaryFromParcelLocked(out,NOWREAL_SYS);
      }
 else {
        out.writeInt(0);
      }
    }
    if (u.mWifiMulticastTimer != null) {
      out.writeInt(1);
      u.mWifiMulticastTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    if (u.mAudioTurnedOnTimer != null) {
      out.writeInt(1);
      u.mAudioTurnedOnTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    if (u.mVideoTurnedOnTimer != null) {
      out.writeInt(1);
      u.mVideoTurnedOnTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    if (u.mForegroundActivityTimer != null) {
      out.writeInt(1);
      u.mForegroundActivityTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    if (u.mVibratorOnTimer != null) {
      out.writeInt(1);
      u.mVibratorOnTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
    }
 else {
      out.writeInt(0);
    }
    if (u.mUserActivityCounters == null) {
      out.writeInt(0);
    }
 else {
      out.writeInt(1);
      for (int i=0; i < Uid.NUM_USER_ACTIVITY_TYPES; i++) {
        u.mUserActivityCounters[i].writeSummaryFromParcelLocked(out);
      }
    }
    if (u.mNetworkByteActivityCounters == null) {
      out.writeInt(0);
    }
 else {
      out.writeInt(1);
      for (int i=0; i < NUM_NETWORK_ACTIVITY_TYPES; i++) {
        u.mNetworkByteActivityCounters[i].writeSummaryFromParcelLocked(out);
        u.mNetworkPacketActivityCounters[i].writeSummaryFromParcelLocked(out);
      }
      u.mMobileRadioActiveTime.writeSummaryFromParcelLocked(out);
      u.mMobileRadioActiveCount.writeSummaryFromParcelLocked(out);
    }
    int NW=u.mWakelockStats.size();
    out.writeInt(NW);
    if (NW > 0) {
      for (      Map.Entry<String,BatteryStatsImpl.Uid.Wakelock> ent : u.mWakelockStats.entrySet()) {
        out.writeString(ent.getKey());
        Uid.Wakelock wl=ent.getValue();
        if (wl.mTimerFull != null) {
          out.writeInt(1);
          wl.mTimerFull.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
        }
 else {
          out.writeInt(0);
        }
        if (wl.mTimerPartial != null) {
          out.writeInt(1);
          wl.mTimerPartial.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
        }
 else {
          out.writeInt(0);
        }
        if (wl.mTimerWindow != null) {
          out.writeInt(1);
          wl.mTimerWindow.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
        }
 else {
          out.writeInt(0);
        }
      }
    }
    int NSE=u.mSensorStats.size();
    out.writeInt(NSE);
    if (NSE > 0) {
      for (      Map.Entry<Integer,BatteryStatsImpl.Uid.Sensor> ent : u.mSensorStats.entrySet()) {
        out.writeInt(ent.getKey());
        Uid.Sensor se=ent.getValue();
        if (se.mTimer != null) {
          out.writeInt(1);
          se.mTimer.writeSummaryFromParcelLocked(out,NOWREAL_SYS);
        }
 else {
          out.writeInt(0);
        }
      }
    }
    int NP=u.mProcessStats.size();
    out.writeInt(NP);
    if (NP > 0) {
      for (      Map.Entry<String,BatteryStatsImpl.Uid.Proc> ent : u.mProcessStats.entrySet()) {
        out.writeString(ent.getKey());
        Uid.Proc ps=ent.getValue();
        out.writeLong(ps.mUserTime);
        out.writeLong(ps.mSystemTime);
        out.writeLong(ps.mForegroundTime);
        out.writeInt(ps.mStarts);
        final int N=ps.mSpeedBins.length;
        out.writeInt(N);
        for (int i=0; i < N; i++) {
          if (ps.mSpeedBins[i] != null) {
            out.writeInt(1);
            ps.mSpeedBins[i].writeSummaryFromParcelLocked(out);
          }
 else {
            out.writeInt(0);
          }
        }
        ps.writeExcessivePowerToParcelLocked(out);
      }
    }
    NP=u.mPackageStats.size();
    out.writeInt(NP);
    if (NP > 0) {
      for (      Map.Entry<String,BatteryStatsImpl.Uid.Pkg> ent : u.mPackageStats.entrySet()) {
        out.writeString(ent.getKey());
        Uid.Pkg ps=ent.getValue();
        out.writeInt(ps.mWakeups);
        final int NS=ps.mServiceStats.size();
        out.writeInt(NS);
        if (NS > 0) {
          for (          Map.Entry<String,BatteryStatsImpl.Uid.Pkg.Serv> sent : ps.mServiceStats.entrySet()) {
            out.writeString(sent.getKey());
            BatteryStatsImpl.Uid.Pkg.Serv ss=sent.getValue();
            long time=ss.getStartTimeToNowLocked(mOnBatteryTimeBase.getUptime(NOW_SYS));
            out.writeLong(time);
            out.writeInt(ss.mStarts);
            out.writeInt(ss.mLaunches);
          }
        }
      }
    }
  }
}
