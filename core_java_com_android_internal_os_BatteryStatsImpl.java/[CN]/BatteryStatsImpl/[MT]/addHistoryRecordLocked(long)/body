{
  addHistoryBufferLocked(curTime);
  if (!mHaveBatteryLevel || !mRecordingHistory) {
    return;
  }
  if (mHistoryEnd != null && mHistoryEnd.cmd == HistoryItem.CMD_UPDATE && (mHistoryBaseTime + curTime) < (mHistoryEnd.time + 2000) && ((mHistoryEnd.states ^ mHistoryCur.states) & mChangedStates) == 0) {
    if (mHistoryLastEnd != null && mHistoryLastEnd.cmd == HistoryItem.CMD_UPDATE && mHistoryLastEnd.same(mHistoryCur)) {
      mHistoryLastEnd.next=null;
      mHistoryEnd.next=mHistoryCache;
      mHistoryCache=mHistoryEnd;
      mHistoryEnd=mHistoryLastEnd;
      mHistoryLastEnd=null;
    }
 else {
      mChangedStates|=mHistoryEnd.states ^ mHistoryCur.states;
      mHistoryEnd.setTo(mHistoryEnd.time,HistoryItem.CMD_UPDATE,mHistoryCur);
    }
    return;
  }
  mChangedStates=0;
  if (mNumHistoryItems == MAX_HISTORY_ITEMS || mNumHistoryItems == MAX_MAX_HISTORY_ITEMS) {
    addHistoryRecordLocked(curTime,HistoryItem.CMD_OVERFLOW);
  }
  if (mNumHistoryItems >= MAX_HISTORY_ITEMS) {
    if (mHistoryEnd != null && mHistoryEnd.batteryLevel == mHistoryCur.batteryLevel && (mNumHistoryItems >= MAX_MAX_HISTORY_ITEMS || ((mHistoryEnd.states ^ mHistoryCur.states) & HistoryItem.MOST_INTERESTING_STATES) == 0)) {
      return;
    }
  }
  addHistoryRecordLocked(curTime,HistoryItem.CMD_UPDATE);
}
