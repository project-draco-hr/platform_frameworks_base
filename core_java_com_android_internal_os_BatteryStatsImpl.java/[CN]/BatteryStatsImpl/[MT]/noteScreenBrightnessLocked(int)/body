{
  int bin=brightness / (256 / NUM_SCREEN_BRIGHTNESS_BINS);
  if (bin < 0)   bin=0;
 else   if (bin >= NUM_SCREEN_BRIGHTNESS_BINS)   bin=NUM_SCREEN_BRIGHTNESS_BINS - 1;
  if (mScreenBrightnessBin != bin) {
    final long elapsedRealtime=mClocks.elapsedRealtime();
    final long uptime=mClocks.uptimeMillis();
    mHistoryCur.states=(mHistoryCur.states & ~HistoryItem.STATE_BRIGHTNESS_MASK) | (bin << HistoryItem.STATE_BRIGHTNESS_SHIFT);
    if (DEBUG_HISTORY)     Slog.v(TAG,"Screen brightness " + bin + " to: "+ Integer.toHexString(mHistoryCur.states));
    addHistoryRecordLocked(elapsedRealtime,uptime);
    if (mScreenState == Display.STATE_ON) {
      if (mScreenBrightnessBin >= 0) {
        mScreenBrightnessTimer[mScreenBrightnessBin].stopRunningLocked(elapsedRealtime);
      }
      mScreenBrightnessTimer[bin].startRunningLocked(elapsedRealtime);
    }
    mScreenBrightnessBin=bin;
  }
}
