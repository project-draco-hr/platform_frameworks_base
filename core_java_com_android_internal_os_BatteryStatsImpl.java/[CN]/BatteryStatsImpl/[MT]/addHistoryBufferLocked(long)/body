{
  if (!mHaveBatteryLevel || !mRecordingHistory) {
    return;
  }
  final long timeDiff=(mHistoryBaseTime + curTime) - mHistoryLastWritten.time;
  if (mHistoryBufferLastPos >= 0 && mHistoryLastWritten.cmd == HistoryItem.CMD_UPDATE && timeDiff < 2000 && ((mHistoryLastWritten.states ^ mHistoryCur.states) & mChangedBufferStates) == 0) {
    mHistoryBuffer.setDataSize(mHistoryBufferLastPos);
    mHistoryBuffer.setDataPosition(mHistoryBufferLastPos);
    mHistoryBufferLastPos=-1;
    if (mHistoryLastLastWritten.cmd == HistoryItem.CMD_UPDATE && timeDiff < 500 && mHistoryLastLastWritten.same(mHistoryCur)) {
      mHistoryLastWritten.setTo(mHistoryLastLastWritten);
      mHistoryLastLastWritten.cmd=HistoryItem.CMD_NULL;
      return;
    }
    mChangedBufferStates|=mHistoryLastWritten.states ^ mHistoryCur.states;
    curTime=mHistoryLastWritten.time - mHistoryBaseTime;
    mHistoryLastWritten.setTo(mHistoryLastLastWritten);
  }
 else {
    mChangedBufferStates=0;
  }
  final int dataSize=mHistoryBuffer.dataSize();
  if (dataSize >= MAX_HISTORY_BUFFER) {
    if (!mHistoryOverflow) {
      mHistoryOverflow=true;
      addHistoryBufferLocked(curTime,HistoryItem.CMD_OVERFLOW);
    }
    if (mHistoryLastWritten.batteryLevel == mHistoryCur.batteryLevel && (dataSize >= MAX_MAX_HISTORY_BUFFER || ((mHistoryEnd.states ^ mHistoryCur.states) & HistoryItem.MOST_INTERESTING_STATES) == 0)) {
      return;
    }
  }
  addHistoryBufferLocked(curTime,HistoryItem.CMD_UPDATE);
}
