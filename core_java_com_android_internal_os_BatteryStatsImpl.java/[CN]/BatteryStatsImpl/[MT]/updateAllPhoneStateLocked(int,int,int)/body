{
  boolean scanning=false;
  boolean newHistory=false;
  mPhoneServiceStateRaw=state;
  mPhoneSimStateRaw=simState;
  mPhoneSignalStrengthBinRaw=bin;
  if (simState == TelephonyManager.SIM_STATE_ABSENT) {
    if (state == ServiceState.STATE_OUT_OF_SERVICE && bin > SignalStrength.SIGNAL_STRENGTH_NONE_OR_UNKNOWN) {
      state=ServiceState.STATE_IN_SERVICE;
    }
  }
  if (state == ServiceState.STATE_POWER_OFF) {
    bin=-1;
  }
 else   if (state == ServiceState.STATE_IN_SERVICE) {
  }
 else   if (state == ServiceState.STATE_OUT_OF_SERVICE) {
    scanning=true;
    bin=SignalStrength.SIGNAL_STRENGTH_NONE_OR_UNKNOWN;
    if (!mPhoneSignalScanningTimer.isRunningLocked()) {
      mHistoryCur.states|=HistoryItem.STATE_PHONE_SCANNING_FLAG;
      newHistory=true;
      if (DEBUG_HISTORY)       Slog.v(TAG,"Phone started scanning to: " + Integer.toHexString(mHistoryCur.states));
      mPhoneSignalScanningTimer.startRunningLocked(this);
    }
  }
  if (!scanning) {
    if (mPhoneSignalScanningTimer.isRunningLocked()) {
      mHistoryCur.states&=~HistoryItem.STATE_PHONE_SCANNING_FLAG;
      if (DEBUG_HISTORY)       Slog.v(TAG,"Phone stopped scanning to: " + Integer.toHexString(mHistoryCur.states));
      newHistory=true;
      mPhoneSignalScanningTimer.stopRunningLocked(this);
    }
  }
  if (mPhoneServiceState != state) {
    mHistoryCur.states=(mHistoryCur.states & ~HistoryItem.STATE_PHONE_STATE_MASK) | (state << HistoryItem.STATE_PHONE_STATE_SHIFT);
    if (DEBUG_HISTORY)     Slog.v(TAG,"Phone state " + state + " to: "+ Integer.toHexString(mHistoryCur.states));
    newHistory=true;
    mPhoneServiceState=state;
  }
  if (mPhoneSignalStrengthBin != bin) {
    if (mPhoneSignalStrengthBin >= 0) {
      mPhoneSignalStrengthsTimer[mPhoneSignalStrengthBin].stopRunningLocked(this);
    }
    if (bin >= 0) {
      if (!mPhoneSignalStrengthsTimer[bin].isRunningLocked()) {
        mPhoneSignalStrengthsTimer[bin].startRunningLocked(this);
      }
      mHistoryCur.states=(mHistoryCur.states & ~HistoryItem.STATE_SIGNAL_STRENGTH_MASK) | (bin << HistoryItem.STATE_SIGNAL_STRENGTH_SHIFT);
      if (DEBUG_HISTORY)       Slog.v(TAG,"Signal strength " + bin + " to: "+ Integer.toHexString(mHistoryCur.states));
      newHistory=true;
    }
 else {
      stopAllSignalStrengthTimersLocked(-1);
    }
    mPhoneSignalStrengthBin=bin;
  }
  if (newHistory) {
    addHistoryRecordLocked(SystemClock.elapsedRealtime());
  }
}
