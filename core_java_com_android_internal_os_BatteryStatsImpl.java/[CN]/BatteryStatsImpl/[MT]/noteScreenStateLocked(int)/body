{
  if (mScreenState != state) {
    final int oldState=mScreenState;
    mScreenState=state;
    if (DEBUG)     Slog.v(TAG,"Screen state: oldState=" + Display.stateToString(oldState) + ", newState="+ Display.stateToString(state));
    if (state == Display.STATE_ON) {
      mHistoryCur.states|=HistoryItem.STATE_SCREEN_ON_FLAG;
      if (DEBUG_HISTORY)       Slog.v(TAG,"Screen on to: " + Integer.toHexString(mHistoryCur.states));
      addHistoryRecordLocked(SystemClock.elapsedRealtime());
      mScreenOnTimer.startRunningLocked(this);
      if (mScreenBrightnessBin >= 0) {
        mScreenBrightnessTimer[mScreenBrightnessBin].startRunningLocked(this);
      }
      noteStartWakeLocked(-1,-1,"dummy",WAKE_TYPE_PARTIAL);
      if (mOnBatteryInternal) {
        updateDischargeScreenLevelsLocked(false,true);
      }
    }
 else     if (oldState == Display.STATE_ON) {
      mHistoryCur.states&=~HistoryItem.STATE_SCREEN_ON_FLAG;
      if (DEBUG_HISTORY)       Slog.v(TAG,"Screen off to: " + Integer.toHexString(mHistoryCur.states));
      addHistoryRecordLocked(SystemClock.elapsedRealtime());
      mScreenOnTimer.stopRunningLocked(this);
      if (mScreenBrightnessBin >= 0) {
        mScreenBrightnessTimer[mScreenBrightnessBin].stopRunningLocked(this);
      }
      noteStopWakeLocked(-1,-1,"dummy",WAKE_TYPE_PARTIAL);
      if (mOnBatteryInternal) {
        updateDischargeScreenLevelsLocked(true,false);
      }
    }
  }
}
