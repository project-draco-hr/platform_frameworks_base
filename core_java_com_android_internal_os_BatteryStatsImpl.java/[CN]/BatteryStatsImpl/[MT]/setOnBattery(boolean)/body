{
synchronized (this) {
    if (mOnBattery != onBattery) {
      if (mScreenOn) {
        updateScreenOnTime(true);
      }
      long uptime=SystemClock.uptimeMillis() * 1000;
      long mSecRealtime=SystemClock.elapsedRealtime();
      long realtime=mSecRealtime * 1000;
      if (onBattery) {
        mTrackBatteryUptimeStart=getBatteryUptime(uptime);
        mTrackBatteryRealtimeStart=getBatteryRealtime(realtime);
        unplugTcpCounters();
        unplugTimers();
        mUnpluggedBatteryUptime=getBatteryUptime(uptime);
        mUnpluggedBatteryRealtime=getBatteryRealtime(realtime);
      }
 else {
        mTrackBatteryPastUptime+=uptime - mTrackBatteryUptimeStart;
        mTrackBatteryPastRealtime+=realtime - mTrackBatteryRealtimeStart;
      }
      mOnBattery=onBattery;
      if ((mLastWriteTime + (60 * 1000)) < mSecRealtime) {
        if (mFile != null) {
          writeLocked();
        }
      }
    }
  }
}
