{
synchronized (this) {
    if (mOnBattery != onBattery) {
      if (mScreenOn) {
        updateScreenOnTimeLocked(true);
      }
      mOnBattery=mOnBatteryInternal=onBattery;
      long uptime=SystemClock.uptimeMillis() * 1000;
      long mSecRealtime=SystemClock.elapsedRealtime();
      long realtime=mSecRealtime * 1000;
      if (onBattery) {
        mTrackBatteryUptimeStart=uptime;
        mTrackBatteryRealtimeStart=realtime;
        mUnpluggedBatteryUptime=getBatteryUptimeLocked(uptime);
        mUnpluggedBatteryRealtime=getBatteryRealtimeLocked(realtime);
        doUnplug(mUnpluggedBatteryUptime,mUnpluggedBatteryRealtime);
      }
 else {
        mTrackBatteryPastUptime+=uptime - mTrackBatteryUptimeStart;
        mTrackBatteryPastRealtime+=realtime - mTrackBatteryRealtimeStart;
        doPlug(mUnpluggedBatteryUptime,mUnpluggedBatteryRealtime);
      }
      if ((mLastWriteTime + (60 * 1000)) < mSecRealtime) {
        if (mFile != null) {
          writeLocked();
        }
      }
    }
  }
}
