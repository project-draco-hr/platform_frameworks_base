{
  final boolean hasMask=mMask != null;
  final boolean drawNonMaskContent=mLayerState.mNum > (hasMask ? 1 : 0);
  final boolean drawMask=hasMask && mMask.getOpacity() != PixelFormat.OPAQUE;
  final Rect bounds=getDirtyBounds();
  final int contentLayer=drawNonMaskContent ? drawContentLayer(canvas,bounds,SRC_OVER) : -1;
  final PorterDuffXfermode xfermode=(hasMask || !drawNonMaskContent) ? SRC_OVER : SRC_ATOP;
  final int backgroundLayer=drawBackgroundLayer(canvas,bounds,xfermode);
  if (backgroundLayer >= 0) {
    if (drawMask) {
      drawMaskingLayer(canvas,bounds,DST_IN);
    }
    canvas.restoreToCount(backgroundLayer);
  }
  final int rippleLayer=drawRippleLayer(canvas,bounds,xfermode);
  if (rippleLayer >= 0) {
    if (drawMask) {
      drawMaskingLayer(canvas,bounds,DST_IN);
    }
    canvas.restoreToCount(rippleLayer);
  }
  if (contentLayer >= 0) {
    canvas.restoreToCount(contentLayer);
  }
}
