{
  int oldState=getBondState(address);
  if (oldState == state) {
    return;
  }
  if (DBG)   log(address + " bond state " + oldState+ " -> "+ state+ " ("+ reason+ ")");
  Intent intent=new Intent(BluetoothIntent.BOND_STATE_CHANGED_ACTION);
  intent.putExtra(BluetoothIntent.ADDRESS,address);
  intent.putExtra(BluetoothIntent.BOND_STATE,state);
  intent.putExtra(BluetoothIntent.BOND_PREVIOUS_STATE,oldState);
  if (state == BluetoothDevice.BOND_NOT_BONDED) {
    if (reason <= 0) {
      Log.w(TAG,"setBondState() called to unbond device with invalid reason code " + "Setting reason = BOND_RESULT_REMOVED");
      reason=BluetoothDevice.UNBOND_REASON_REMOVED;
    }
    intent.putExtra(BluetoothIntent.REASON,reason);
    mState.remove(address);
  }
 else {
    mState.put(address,state);
  }
  if (state == BluetoothDevice.BOND_BONDING) {
    mPinAttempt.put(address,Integer.valueOf(0));
  }
 else {
    mPinAttempt.remove(address);
  }
  mContext.sendBroadcast(intent,BLUETOOTH_PERM);
}
