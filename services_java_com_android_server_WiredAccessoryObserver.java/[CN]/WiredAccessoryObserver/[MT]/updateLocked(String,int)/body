{
  int headsetState=newState & SUPPORTED_HEADSETS;
  int usb_headset_anlg=headsetState & BIT_USB_HEADSET_ANLG;
  int usb_headset_dgtl=headsetState & BIT_USB_HEADSET_DGTL;
  int h2w_headset=headsetState & (BIT_HEADSET | BIT_HEADSET_NO_MIC);
  boolean h2wStateChange=true;
  boolean usbStateChange=true;
  if (LOG)   Slog.v(TAG,"newState = " + newState + ", headsetState = "+ headsetState+ ","+ "mHeadsetState = "+ mHeadsetState);
  if (mHeadsetState == headsetState || ((h2w_headset & (h2w_headset - 1)) != 0)) {
    Log.e(TAG,"unsetting h2w flag");
    h2wStateChange=false;
  }
  if ((usb_headset_anlg >> 2) == 1 && (usb_headset_dgtl >> 3) == 1) {
    Log.e(TAG,"unsetting usb flag");
    usbStateChange=false;
  }
  if (!h2wStateChange && !usbStateChange) {
    Log.e(TAG,"invalid transition, returning ...");
    return;
  }
  mHeadsetName=newName;
  mPrevHeadsetState=mHeadsetState;
  mHeadsetState=headsetState;
  mWakeLock.acquire();
  Message msg=mHandler.obtainMessage(0,mHeadsetState,mPrevHeadsetState,mHeadsetName);
  mHandler.sendMessage(msg);
}
