{
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkState(buildWifiState());
  expectNetworkStatsSummary(buildEmptyStats());
  expectNetworkStatsUidDetail(buildEmptyStats());
  expectNetworkStatsPoll();
  expectBandwidthControlCheck();
  replay();
  mService.forceUpdateIfaces();
  verifyAndReset();
  incrementCurrentTime(HOUR_IN_MILLIS);
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,4128L,258L,544L,34L));
  expectNetworkStatsUidDetail(new NetworkStats(getElapsedRealtime(),1).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,TAG_NONE,16L,1L,16L,1L,0L).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,0xFAAD,16L,1L,16L,1L,0L).addValues(TEST_IFACE,UID_BLUE,SET_DEFAULT,TAG_NONE,4096L,258L,512L,32L,0L).addValues(TEST_IFACE,UID_GREEN,SET_DEFAULT,TAG_NONE,16L,1L,16L,1L,0L));
  expectNetworkStatsPoll();
  mService.incrementOperationCount(UID_RED,0xFAAD,10);
  replay();
  forcePollAndWaitForIdle();
  assertNetworkTotal(sTemplateWifi,4128L,258L,544L,34L,0);
  assertUidTotal(sTemplateWifi,UID_RED,16L,1L,16L,1L,10);
  assertUidTotal(sTemplateWifi,UID_BLUE,4096L,258L,512L,32L,0);
  assertUidTotal(sTemplateWifi,UID_GREEN,16L,1L,16L,1L,0);
  verifyAndReset();
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,4128L,258L,544L,34L));
  expectNetworkStatsUidDetail(new NetworkStats(getElapsedRealtime(),1).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,TAG_NONE,16L,1L,16L,1L,0L).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,0xFAAD,16L,1L,16L,1L,0L).addValues(TEST_IFACE,UID_BLUE,SET_DEFAULT,TAG_NONE,4096L,258L,512L,32L,0L).addValues(TEST_IFACE,UID_GREEN,SET_DEFAULT,TAG_NONE,16L,1L,16L,1L,0L));
  expectNetworkStatsPoll();
  replay();
  final Intent intent=new Intent(ACTION_UID_REMOVED);
  intent.putExtra(EXTRA_UID,UID_BLUE);
  mServiceContext.sendBroadcast(intent);
  intent.putExtra(EXTRA_UID,UID_RED);
  mServiceContext.sendBroadcast(intent);
  assertNetworkTotal(sTemplateWifi,4128L,258L,544L,34L,0);
  assertUidTotal(sTemplateWifi,UID_RED,0L,0L,0L,0L,0);
  assertUidTotal(sTemplateWifi,UID_BLUE,0L,0L,0L,0L,0);
  assertUidTotal(sTemplateWifi,UID_GREEN,16L,1L,16L,1L,0);
  assertUidTotal(sTemplateWifi,UID_REMOVED,4112L,259L,528L,33L,10);
  verifyAndReset();
}
