{
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkState(buildMobile3gState(IMSI_1));
  expectNetworkStatsSummary(buildEmptyStats());
  expectNetworkStatsUidDetail(buildEmptyStats());
  expectNetworkStatsPoll();
  expectBandwidthControlCheck();
  replay();
  mService.forceUpdateIfaces();
  verifyAndReset();
  incrementCurrentTime(HOUR_IN_MILLIS);
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,2048L,16L,512L,4L));
  expectNetworkStatsUidDetail(new NetworkStats(getElapsedRealtime(),3).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,TAG_NONE,1536L,12L,512L,4L,0L).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,0xF00D,512L,4L,512L,4L,0L).addValues(TEST_IFACE,UID_BLUE,SET_DEFAULT,TAG_NONE,512L,4L,0L,0L,0L));
  expectNetworkStatsPoll();
  mService.incrementOperationCount(UID_RED,0xF00D,10);
  replay();
  forcePollAndWaitForIdle();
  assertNetworkTotal(sTemplateImsi1,2048L,16L,512L,4L,0);
  assertNetworkTotal(sTemplateWifi,0L,0L,0L,0L,0);
  assertUidTotal(sTemplateImsi1,UID_RED,1536L,12L,512L,4L,10);
  assertUidTotal(sTemplateImsi1,UID_BLUE,512L,4L,0L,0L,0);
  verifyAndReset();
  incrementCurrentTime(HOUR_IN_MILLIS);
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkState(buildMobile3gState(IMSI_2));
  expectNetworkStatsSummary(new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,2048L,16L,512L,4L));
  expectNetworkStatsUidDetail(new NetworkStats(getElapsedRealtime(),3).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,TAG_NONE,1536L,12L,512L,4L,0L).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,0xF00D,512L,4L,512L,4L,0L).addValues(TEST_IFACE,UID_BLUE,SET_DEFAULT,TAG_NONE,512L,4L,0L,0L,0L));
  expectNetworkStatsPoll();
  expectBandwidthControlCheck();
  replay();
  mService.forceUpdateIfaces();
  forcePollAndWaitForIdle();
  verifyAndReset();
  incrementCurrentTime(HOUR_IN_MILLIS);
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,2176L,17L,1536L,12L));
  expectNetworkStatsUidDetail(new NetworkStats(getElapsedRealtime(),1).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,TAG_NONE,1536L,12L,512L,4L,0L).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,0xF00D,512L,4L,512L,4L,0L).addValues(TEST_IFACE,UID_BLUE,SET_DEFAULT,TAG_NONE,640L,5L,1024L,8L,0L).addValues(TEST_IFACE,UID_BLUE,SET_DEFAULT,0xFAAD,128L,1L,1024L,8L,0L));
  expectNetworkStatsPoll();
  mService.incrementOperationCount(UID_BLUE,0xFAAD,10);
  replay();
  forcePollAndWaitForIdle();
  assertNetworkTotal(sTemplateImsi1,2048L,16L,512L,4L,0);
  assertUidTotal(sTemplateImsi1,UID_RED,1536L,12L,512L,4L,10);
  assertUidTotal(sTemplateImsi1,UID_BLUE,512L,4L,0L,0L,0);
  assertNetworkTotal(sTemplateImsi2,128L,1L,1024L,8L,0);
  assertNetworkTotal(sTemplateWifi,0L,0L,0L,0L,0);
  assertUidTotal(sTemplateImsi2,UID_BLUE,128L,1L,1024L,8L,10);
  verifyAndReset();
}
