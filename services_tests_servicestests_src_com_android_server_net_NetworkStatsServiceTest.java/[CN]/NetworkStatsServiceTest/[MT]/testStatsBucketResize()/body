{
  NetworkStatsHistory history=null;
  assertStatsFilesExist(false);
  expectCurrentTime();
  expectSettings(0L,HOUR_IN_MILLIS,WEEK_IN_MILLIS);
  expectNetworkState(buildWifiState());
  expectNetworkStatsSummary(buildEmptyStats());
  expectNetworkStatsUidDetail(buildEmptyStats());
  expectNetworkStatsPoll();
  expectBandwidthControlCheck();
  replay();
  mService.forceUpdateIfaces();
  verifyAndReset();
  incrementCurrentTime(2 * HOUR_IN_MILLIS);
  expectCurrentTime();
  expectSettings(0L,HOUR_IN_MILLIS,WEEK_IN_MILLIS);
  expectNetworkStatsSummary(new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,512L,4L,512L,4L));
  expectNetworkStatsUidDetail(buildEmptyStats());
  expectNetworkStatsPoll();
  replay();
  forcePollAndWaitForIdle();
  history=mSession.getHistoryForNetwork(sTemplateWifi,FIELD_ALL);
  assertValues(history,Long.MIN_VALUE,Long.MAX_VALUE,512L,4L,512L,4L,0);
  assertEquals(HOUR_IN_MILLIS,history.getBucketDuration());
  assertEquals(2,history.size());
  verifyAndReset();
  expectCurrentTime();
  expectSettings(0L,30 * MINUTE_IN_MILLIS,WEEK_IN_MILLIS);
  expectNetworkStatsSummary(buildEmptyStats());
  expectNetworkStatsUidDetail(buildEmptyStats());
  expectNetworkStatsPoll();
  replay();
  forcePollAndWaitForIdle();
  history=mSession.getHistoryForNetwork(sTemplateWifi,FIELD_ALL);
  assertValues(history,Long.MIN_VALUE,Long.MAX_VALUE,512L,4L,512L,4L,0);
  assertEquals(30 * MINUTE_IN_MILLIS,history.getBucketDuration());
  assertEquals(4,history.size());
  verifyAndReset();
}
