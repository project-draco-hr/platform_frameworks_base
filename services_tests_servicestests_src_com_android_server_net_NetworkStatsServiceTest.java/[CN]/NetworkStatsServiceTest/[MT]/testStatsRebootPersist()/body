{
  assertStatsFilesExist(false);
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkState(buildWifiState());
  expectNetworkStatsSummary(buildEmptyStats());
  expectNetworkStatsUidDetail(buildEmptyStats());
  expectNetworkStatsPoll();
  expectBandwidthControlCheck();
  replay();
  mService.forceUpdateIfaces();
  assertNetworkTotal(sTemplateWifi,0L,0L,0L,0L,0);
  verifyAndReset();
  incrementCurrentTime(HOUR_IN_MILLIS);
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,1024L,8L,2048L,16L));
  expectNetworkStatsUidDetail(new NetworkStats(getElapsedRealtime(),2).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,TAG_NONE,512L,4L,256L,2L,0L).addValues(TEST_IFACE,UID_RED,SET_DEFAULT,0xFAAD,256L,2L,128L,1L,0L).addValues(TEST_IFACE,UID_RED,SET_FOREGROUND,TAG_NONE,512L,4L,256L,2L,0L).addValues(TEST_IFACE,UID_RED,SET_FOREGROUND,0xFAAD,256L,2L,128L,1L,0L).addValues(TEST_IFACE,UID_BLUE,SET_DEFAULT,TAG_NONE,128L,1L,128L,1L,0L));
  expectNetworkStatsPoll();
  mService.setUidForeground(UID_RED,false);
  mService.incrementOperationCount(UID_RED,0xFAAD,4);
  mService.setUidForeground(UID_RED,true);
  mService.incrementOperationCount(UID_RED,0xFAAD,6);
  replay();
  forcePollAndWaitForIdle();
  assertNetworkTotal(sTemplateWifi,1024L,8L,2048L,16L,0);
  assertUidTotal(sTemplateWifi,UID_RED,1024L,8L,512L,4L,10);
  assertUidTotal(sTemplateWifi,UID_RED,SET_DEFAULT,ROAMING_NO,512L,4L,256L,2L,4);
  assertUidTotal(sTemplateWifi,UID_RED,SET_FOREGROUND,ROAMING_NO,512L,4L,256L,2L,6);
  assertUidTotal(sTemplateWifi,UID_BLUE,128L,1L,128L,1L,0);
  verifyAndReset();
  expectCurrentTime();
  expectDefaultSettings();
  replay();
  mServiceContext.sendBroadcast(new Intent(Intent.ACTION_SHUTDOWN));
  verifyAndReset();
  assertStatsFilesExist(true);
  expectCurrentTime();
  expectDefaultSettings();
  expectNetworkStatsUidDetail(buildEmptyStats());
  expectSystemReady();
  final Capture<INetworkManagementEventObserver> networkObserver=new Capture<INetworkManagementEventObserver>();
  mNetManager.registerObserver(capture(networkObserver));
  expectLastCall().atLeastOnce();
  replay();
  mService.systemReady();
  mNetworkObserver=networkObserver.getValue();
  assertNetworkTotal(sTemplateWifi,1024L,8L,2048L,16L,0);
  assertUidTotal(sTemplateWifi,UID_RED,1024L,8L,512L,4L,10);
  assertUidTotal(sTemplateWifi,UID_RED,SET_DEFAULT,ROAMING_NO,512L,4L,256L,2L,4);
  assertUidTotal(sTemplateWifi,UID_RED,SET_FOREGROUND,ROAMING_NO,512L,4L,256L,2L,6);
  assertUidTotal(sTemplateWifi,UID_BLUE,128L,1L,128L,1L,0);
  verifyAndReset();
}
