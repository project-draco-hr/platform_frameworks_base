{
  mImageReaderLock.lock();
  try {
    if (reader != mImageReader) {
      return;
    }
    Log.d(TAG,"New image available from virtual display.");
    Image image=reader.acquireLatestImage();
    if (image != null) {
      try {
        int color=scanImage(image);
synchronized (this) {
          if (mColor != color) {
            mColor=color;
            notifyAll();
          }
        }
      }
  finally {
        image.close();
      }
    }
  }
 catch (  MaxImagesAcquiredException e) {
    throw new IllegalStateException(e);
  }
 finally {
    mImageReaderLock.unlock();
  }
}
