{
  mImageReaderLock.lock();
  try {
    if (reader != mImageReader) {
      return;
    }
    Log.d(TAG,"New image available from virtual display.");
    Image image=reader.getNextImage();
    if (image != null) {
      try {
        for (; ; ) {
          Image nextImage=reader.getNextImage();
          if (nextImage == null) {
            break;
          }
          reader.releaseImage(image);
          image=nextImage;
        }
        int color=scanImage(image);
synchronized (this) {
          if (mColor != color) {
            mColor=color;
            notifyAll();
          }
        }
      }
  finally {
        reader.releaseImage(image);
      }
    }
  }
  finally {
    mImageReaderLock.unlock();
  }
}
