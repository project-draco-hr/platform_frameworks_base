{
  final TaskRecord task=r.task;
  if (r.isApplicationActivity() || (task != null && task.isApplicationTask())) {
    if (task != null) {
      final ActivityStack taskStack=task.stack;
      if (mFocusedStack != taskStack) {
        if (DEBUG_FOCUS || DEBUG_STACK)         Slog.d(TAG,"adjustStackFocus: Setting focused stack to r=" + r + " task="+ task);
        mFocusedStack=taskStack;
      }
 else {
        if (DEBUG_FOCUS || DEBUG_STACK)         Slog.d(TAG,"adjustStackFocus: Focused stack already=" + mFocusedStack);
      }
      return taskStack;
    }
    if (mFocusedStack != mHomeStack) {
      if (DEBUG_FOCUS || DEBUG_STACK)       Slog.d(TAG,"adjustStackFocus: Have a focused stack=" + mFocusedStack);
      return mFocusedStack;
    }
    int numDisplays=mDisplayInfos.size();
    for (int displayNdx=0; displayNdx < numDisplays; ++displayNdx) {
      ArrayList<ActivityStack> stacks=mDisplayInfos.valueAt(displayNdx).stacks;
      for (int stackNdx=stacks.size() - 1; stackNdx >= 0; --stackNdx) {
        ActivityStack stack=stacks.get(stackNdx);
        if (!stack.isHomeStack()) {
          if (DEBUG_FOCUS || DEBUG_STACK)           Slog.d(TAG,"adjustStackFocus: Setting focused stack=" + stack);
          mFocusedStack=stack;
          return mFocusedStack;
        }
      }
    }
    int stackId=createStackOnDisplay(null,getNextStackId(),Display.DEFAULT_DISPLAY);
    if (DEBUG_FOCUS || DEBUG_STACK)     Slog.d(TAG,"adjustStackFocus: New stack r=" + r + " stackId="+ stackId);
    mFocusedStack=getStack(stackId);
    return mFocusedStack;
  }
  return mHomeStack;
}
