{
  if (oldPackage != null && !oldPackage.equals(mPackage)) {
    return false;
  }
  if (newPackage == null || (newPackage.equals(mPackage) && !newPackage.equals(VpnConfig.LEGACY_VPN))) {
    return true;
  }
  enforceControlPermission();
  if (mInterface != null) {
    final long token=Binder.clearCallingIdentity();
    try {
      mCallback.restore();
      final int size=mVpnUsers.size();
      final boolean forwardDns=(mConfig.dnsServers != null && mConfig.dnsServers.size() != 0);
      for (int i=0; i < size; i++) {
        int user=mVpnUsers.keyAt(i);
        mCallback.clearUserForwarding(mInterface,user,forwardDns);
        hideNotification(user);
      }
      mCallback.clearMarkedForwarding(mInterface);
    }
  finally {
      Binder.restoreCallingIdentity(token);
    }
    jniReset(mInterface);
    mInterface=null;
    mVpnUsers=null;
  }
  if (mConnection != null) {
    try {
      mConnection.mService.transact(IBinder.LAST_CALL_TRANSACTION,Parcel.obtain(),null,IBinder.FLAG_ONEWAY);
    }
 catch (    Exception e) {
    }
    mContext.unbindService(mConnection);
    mConnection=null;
  }
 else   if (mLegacyVpnRunner != null) {
    mLegacyVpnRunner.exit();
    mLegacyVpnRunner=null;
  }
  Log.i(TAG,"Switched from " + mPackage + " to "+ newPackage);
  mPackage=newPackage;
  mConfig=null;
  updateState(DetailedState.IDLE,"prepare");
  return true;
}
