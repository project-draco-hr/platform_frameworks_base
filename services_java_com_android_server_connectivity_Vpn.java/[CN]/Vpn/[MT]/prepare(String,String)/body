{
  if (oldPackage != null && !oldPackage.equals(mPackageName)) {
    return false;
  }
  if (newPackage == null || (newPackage.equals(mPackageName) && !newPackage.equals(VpnConfig.LEGACY_VPN))) {
    return true;
  }
  if (Binder.getCallingUid() != Process.SYSTEM_UID) {
    throw new SecurityException("Unauthorized Caller");
  }
  PackageManager pm=mContext.getPackageManager();
  if (!newPackage.equals(VpnConfig.LEGACY_VPN) && pm.checkPermission(VPN,newPackage) != PackageManager.PERMISSION_GRANTED) {
    throw new SecurityException(newPackage + " does not have " + VPN);
  }
  if (mInterfaceName != null) {
    jniResetInterface(mInterfaceName);
    mCallback.restore();
    hideNotification();
    mInterfaceName=null;
  }
  if (!mPackageName.equals(VpnConfig.LEGACY_VPN)) {
    Intent intent=new Intent(VpnConfig.ACTION_VPN_REVOKED);
    intent.setPackage(mPackageName);
    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);
    mContext.sendBroadcast(intent);
  }
 else   if (mLegacyVpnRunner != null) {
    mLegacyVpnRunner.exit();
    mLegacyVpnRunner=null;
  }
  Log.i(TAG,"Switched from " + mPackageName + " to "+ newPackage);
  mPackageName=newPackage;
  return true;
}
