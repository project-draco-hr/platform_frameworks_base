{
  if (oldPackage != null && !oldPackage.equals(mPackage)) {
    return false;
  }
  if (newPackage == null || (newPackage.equals(mPackage) && !newPackage.equals(VpnConfig.LEGACY_VPN))) {
    return true;
  }
  if (Binder.getCallingUid() != Process.SYSTEM_UID) {
    throw new SecurityException("Unauthorized Caller");
  }
  PackageManager pm=mContext.getPackageManager();
  if (!newPackage.equals(VpnConfig.LEGACY_VPN) && pm.checkPermission(VPN,newPackage) != PackageManager.PERMISSION_GRANTED) {
    throw new SecurityException(newPackage + " does not have " + VPN);
  }
  if (mInterface != null) {
    jniReset(mInterface);
    mCallback.restore();
    hideNotification();
    mInterface=null;
  }
  if (!mPackage.equals(VpnConfig.LEGACY_VPN)) {
    Intent intent=new Intent(VpnConfig.ACTION_VPN_REVOKED);
    intent.setPackage(mPackage);
    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);
    mContext.sendBroadcast(intent);
  }
 else   if (mLegacyVpnRunner != null) {
    mLegacyVpnRunner.exit();
    mLegacyVpnRunner=null;
  }
  Log.i(TAG,"Switched from " + mPackage + " to "+ newPackage);
  mPackage=newPackage;
  return true;
}
