{
  mContext=context;
  mContentResolver=context.getContentResolver();
  mAppOps=(AppOpsManager)context.getSystemService(Context.APP_OPS_SERVICE);
  if (mContext.getResources().getBoolean(com.android.internal.R.bool.config_voice_capable)) {
    mPlatformType=PLATFORM_VOICE;
  }
 else   if (context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_TELEVISION)) {
    mPlatformType=PLATFORM_TELEVISION;
  }
 else {
    mPlatformType=PLATFORM_DEFAULT;
  }
  PowerManager pm=(PowerManager)context.getSystemService(Context.POWER_SERVICE);
  mAudioEventWakeLock=pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,"handleAudioEvent");
  Vibrator vibrator=(Vibrator)context.getSystemService(Context.VIBRATOR_SERVICE);
  mHasVibrator=vibrator == null ? false : vibrator.hasVibrator();
  MAX_STREAM_VOLUME[AudioSystem.STREAM_VOICE_CALL]=SystemProperties.getInt("ro.config.vc_call_vol_steps",MAX_STREAM_VOLUME[AudioSystem.STREAM_VOICE_CALL]);
  MAX_STREAM_VOLUME[AudioSystem.STREAM_MUSIC]=SystemProperties.getInt("ro.config.music_vol_steps",MAX_STREAM_VOLUME[AudioSystem.STREAM_MUSIC]);
  sSoundEffectVolumeDb=context.getResources().getInteger(com.android.internal.R.integer.config_soundEffectVolumeDb);
  mForcedUseForComm=AudioSystem.FORCE_NONE;
  createAudioSystemThread();
  mMediaFocusControl=new MediaFocusControl(mAudioHandler.getLooper(),mContext,mVolumeController,this);
  AudioSystem.setErrorCallback(mAudioSystemCallback);
  boolean cameraSoundForced=mContext.getResources().getBoolean(com.android.internal.R.bool.config_camera_sound_forced);
  mCameraSoundForced=new Boolean(cameraSoundForced);
  sendMsg(mAudioHandler,MSG_SET_FORCE_USE,SENDMSG_QUEUE,AudioSystem.FOR_SYSTEM,cameraSoundForced ? AudioSystem.FORCE_SYSTEM_ENFORCED : AudioSystem.FORCE_NONE,null,0);
  mSafeMediaVolumeState=new Integer(Settings.Global.getInt(mContentResolver,Settings.Global.AUDIO_SAFE_VOLUME_STATE,SAFE_MEDIA_VOLUME_NOT_CONFIGURED));
  mSafeMediaVolumeIndex=mContext.getResources().getInteger(com.android.internal.R.integer.config_safe_media_volume_index) * 10;
  mUseFixedVolume=mContext.getResources().getBoolean(com.android.internal.R.bool.config_useFixedVolume);
  updateStreamVolumeAlias(false);
  readPersistedSettings();
  mSettingsObserver=new SettingsObserver();
  createStreamStates();
  readAndSetLowRamDevice();
  mRingerModeMutedStreams=0;
  setRingerModeInt(getRingerMode(),false);
  IntentFilter intentFilter=new IntentFilter(BluetoothHeadset.ACTION_AUDIO_STATE_CHANGED);
  intentFilter.addAction(BluetoothHeadset.ACTION_CONNECTION_STATE_CHANGED);
  intentFilter.addAction(Intent.ACTION_DOCK_EVENT);
  intentFilter.addAction(AudioManager.ACTION_USB_AUDIO_ACCESSORY_PLUG);
  intentFilter.addAction(AudioManager.ACTION_USB_AUDIO_DEVICE_PLUG);
  intentFilter.addAction(Intent.ACTION_SCREEN_ON);
  intentFilter.addAction(Intent.ACTION_SCREEN_OFF);
  intentFilter.addAction(Intent.ACTION_USER_SWITCHED);
  intentFilter.addAction(UsbManager.ACTION_USB_DEVICE_ATTACHED);
  intentFilter.addAction(Intent.ACTION_CONFIGURATION_CHANGED);
  mMonitorOrientation=SystemProperties.getBoolean("ro.audio.monitorOrientation",false);
  if (mMonitorOrientation) {
    Log.v(TAG,"monitoring device orientation");
    setOrientationForAudioSystem();
  }
  mMonitorRotation=SystemProperties.getBoolean("ro.audio.monitorRotation",false);
  if (mMonitorRotation) {
    mDeviceRotation=((WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE)).getDefaultDisplay().getRotation();
    Log.v(TAG,"monitoring device rotation, initial=" + mDeviceRotation);
    setRotationForAudioSystem();
  }
  context.registerReceiver(mReceiver,intentFilter);
  mUseMasterVolume=context.getResources().getBoolean(com.android.internal.R.bool.config_useMasterVolume);
  restoreMasterVolume();
  mMasterVolumeRamp=context.getResources().getIntArray(com.android.internal.R.array.config_masterVolumeRamp);
  LocalServices.addService(AudioManagerInternal.class,new AudioServiceInternal());
}
