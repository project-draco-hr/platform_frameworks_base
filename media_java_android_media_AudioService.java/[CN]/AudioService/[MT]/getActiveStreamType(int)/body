{
  boolean isOffhook=false;
  try {
    ITelephony phone=ITelephony.Stub.asInterface(ServiceManager.checkService("phone"));
    if (phone != null)     isOffhook=phone.isOffhook();
  }
 catch (  RemoteException e) {
    Log.w(TAG,"Couldn't connect to phone service",e);
  }
  if (AudioSystem.getForceUse(AudioSystem.FOR_COMMUNICATION) == AudioSystem.FORCE_BT_SCO) {
    return AudioSystem.STREAM_BLUETOOTH_SCO;
  }
 else   if (isOffhook || AudioSystem.isStreamActive(AudioSystem.STREAM_VOICE_CALL)) {
    return AudioSystem.STREAM_VOICE_CALL;
  }
 else   if (AudioSystem.isStreamActive(AudioSystem.STREAM_MUSIC)) {
    return AudioSystem.STREAM_MUSIC;
  }
 else   if (suggestedStreamType == AudioManager.USE_DEFAULT_STREAM_TYPE) {
    if (mVoiceCapable) {
      return AudioSystem.STREAM_RING;
    }
 else {
      return AudioSystem.STREAM_MUSIC;
    }
  }
 else {
    return suggestedStreamType;
  }
}
