{
  ensureValidStreamType(streamType);
  VolumeStreamState streamState=mStreamStates[mStreamVolumeAlias[streamType]];
  final int device=getDeviceForStream(streamType);
  int oldIndex;
synchronized (mSafeMediaVolumeState) {
    mPendingVolumeCommand=null;
    oldIndex=streamState.getIndex(device,(streamState.muteCount() != 0));
    index=rescaleIndex(index * 10,streamType,mStreamVolumeAlias[streamType]);
    flags&=~AudioManager.FLAG_FIXED_VOLUME;
    if ((mStreamVolumeAlias[streamType] == AudioSystem.STREAM_MUSIC) && ((device & mFixedVolumeDevices) != 0)) {
      flags|=AudioManager.FLAG_FIXED_VOLUME;
      if (index != 0) {
        if (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_ACTIVE && (device & mSafeMediaVolumeDevices) != 0) {
          index=mSafeMediaVolumeIndex;
        }
 else {
          index=streamState.getMaxIndex();
        }
      }
    }
    if (!checkSafeMediaVolume(mStreamVolumeAlias[streamType],index,device)) {
      mVolumePanel.postDisplaySafeVolumeWarning(flags);
      mPendingVolumeCommand=new StreamVolumeCommand(streamType,index,flags,device);
    }
 else {
      onSetStreamVolume(streamType,index,flags,device);
      index=mStreamStates[streamType].getIndex(device,(mStreamStates[streamType].muteCount() != 0));
    }
  }
  sendVolumeUpdate(streamType,oldIndex,index,flags);
}
