{
  DimLayerState state=getOrCreateDimLayerState(dimLayerUser,false);
  final boolean previousFullscreen=state.dimLayer != null && state.dimLayer == mSharedFullScreenDimLayer;
  DimLayer newDimLayer;
  final int displayId=mDisplayContent.getDisplayId();
  if (dimLayerUser.isFullscreen()) {
    if (previousFullscreen) {
      return;
    }
    newDimLayer=mSharedFullScreenDimLayer;
    if (newDimLayer == null) {
      if (state.dimLayer != null) {
        newDimLayer=state.dimLayer;
      }
 else {
        newDimLayer=new DimLayer(mDisplayContent.mService,dimLayerUser,displayId);
      }
      dimLayerUser.getBounds(mTmpBounds);
      newDimLayer.setBounds(mTmpBounds);
      mSharedFullScreenDimLayer=newDimLayer;
    }
 else     if (state.dimLayer != null) {
      state.dimLayer.destroySurface();
    }
  }
 else {
    newDimLayer=(state.dimLayer == null || previousFullscreen) ? new DimLayer(mDisplayContent.mService,dimLayerUser,displayId) : state.dimLayer;
    dimLayerUser.getBounds(mTmpBounds);
    newDimLayer.setBounds(mTmpBounds);
  }
  state.dimLayer=newDimLayer;
}
