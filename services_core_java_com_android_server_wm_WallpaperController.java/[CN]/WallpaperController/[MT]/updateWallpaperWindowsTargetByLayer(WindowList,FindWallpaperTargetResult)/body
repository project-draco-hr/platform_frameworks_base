{
  WindowState wallpaperTarget=result.wallpaperTarget;
  int wallpaperTargetIndex=result.wallpaperTargetIndex;
  boolean visible=wallpaperTarget != null;
  if (visible) {
    visible=isWallpaperVisible(wallpaperTarget);
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"Wallpaper visibility: " + visible);
    mWallpaperAnimLayerAdjustment=(mLowerWallpaperTarget == null && wallpaperTarget.mAppToken != null) ? wallpaperTarget.mAppToken.mAppAnimator.animLayerAdjustment : 0;
    final int maxLayer=(mService.mPolicy.getMaxWallpaperLayer() * TYPE_LAYER_MULTIPLIER) + TYPE_LAYER_OFFSET;
    while (wallpaperTargetIndex > 0) {
      WindowState wb=windows.get(wallpaperTargetIndex - 1);
      if (wb.mBaseLayer < maxLayer && wb.mAttachedWindow != wallpaperTarget && (wallpaperTarget.mAttachedWindow == null || wb.mAttachedWindow != wallpaperTarget.mAttachedWindow) && (wb.mAttrs.type != TYPE_APPLICATION_STARTING || wallpaperTarget.mToken == null || wb.mToken != wallpaperTarget.mToken)) {
        break;
      }
      wallpaperTarget=wb;
      wallpaperTargetIndex--;
    }
  }
 else {
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"No wallpaper target");
  }
  result.setWallpaperTarget(wallpaperTarget,wallpaperTargetIndex);
  return visible;
}
