{
  boolean targetChanged=false;
  WindowState wallpaperTarget=result.wallpaperTarget;
  int wallpaperTargetIndex=result.wallpaperTargetIndex;
  if (mWallpaperTarget != wallpaperTarget && (mLowerWallpaperTarget == null || mLowerWallpaperTarget != wallpaperTarget)) {
    if (DEBUG_WALLPAPER_LIGHT)     Slog.v(TAG,"New wallpaper target: " + wallpaperTarget + " oldTarget: "+ mWallpaperTarget);
    mLowerWallpaperTarget=null;
    mUpperWallpaperTarget=null;
    WindowState oldW=mWallpaperTarget;
    mWallpaperTarget=wallpaperTarget;
    targetChanged=true;
    if (wallpaperTarget != null && oldW != null) {
      boolean oldAnim=oldW.isAnimatingLw();
      boolean foundAnim=wallpaperTarget.isAnimatingLw();
      if (DEBUG_WALLPAPER_LIGHT)       Slog.v(TAG,"New animation: " + foundAnim + " old animation: "+ oldAnim);
      if (foundAnim && oldAnim) {
        int oldI=windows.indexOf(oldW);
        if (DEBUG_WALLPAPER_LIGHT)         Slog.v(TAG,"New i: " + wallpaperTargetIndex + " old i: "+ oldI);
        if (oldI >= 0) {
          if (DEBUG_WALLPAPER_LIGHT)           Slog.v(TAG,"Animating wallpapers: old#" + oldI + "="+ oldW+ "; new#"+ wallpaperTargetIndex+ "="+ wallpaperTarget);
          if (wallpaperTarget.mAppToken != null && wallpaperTarget.mAppToken.hiddenRequested) {
            if (DEBUG_WALLPAPER_LIGHT)             Slog.v(TAG,"Old wallpaper still the target.");
            mWallpaperTarget=oldW;
            wallpaperTarget=oldW;
            wallpaperTargetIndex=oldI;
          }
 else           if (wallpaperTargetIndex > oldI) {
            if (DEBUG_WALLPAPER_LIGHT)             Slog.v(TAG,"Found target above old target.");
            mUpperWallpaperTarget=wallpaperTarget;
            mLowerWallpaperTarget=oldW;
            wallpaperTarget=oldW;
            wallpaperTargetIndex=oldI;
          }
 else {
            if (DEBUG_WALLPAPER_LIGHT)             Slog.v(TAG,"Found target below old target.");
            mUpperWallpaperTarget=oldW;
            mLowerWallpaperTarget=wallpaperTarget;
          }
        }
      }
    }
  }
 else   if (mLowerWallpaperTarget != null) {
    if (!mLowerWallpaperTarget.isAnimatingLw() || !mUpperWallpaperTarget.isAnimatingLw()) {
      if (DEBUG_WALLPAPER_LIGHT)       Slog.v(TAG,"No longer animating wallpaper targets!");
      mLowerWallpaperTarget=null;
      mUpperWallpaperTarget=null;
      mWallpaperTarget=wallpaperTarget;
      targetChanged=true;
    }
  }
  result.setWallpaperTarget(wallpaperTarget,wallpaperTargetIndex);
  return targetChanged;
}
