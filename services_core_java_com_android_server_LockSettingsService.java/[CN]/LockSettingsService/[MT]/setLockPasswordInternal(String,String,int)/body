{
  byte[] currentHandle=getCurrentHandle(userId);
  if (password == null) {
    clearUserKeyProtection(userId);
    getGateKeeperService().clearSecureUserId(userId);
    mStorage.writePasswordHash(null,userId);
    setKeystorePassword(null,userId);
    fixateNewestUserKeyAuth(userId);
    onUserLockChanged(userId);
    return;
  }
  if (isManagedProfileWithUnifiedLock(userId)) {
    try {
      savedCredential=getDecryptedPasswordForTiedProfile(userId);
    }
 catch (    FileNotFoundException e) {
      Slog.i(TAG,"Child profile key not found");
    }
catch (    UnrecoverableKeyException|InvalidKeyException|KeyStoreException|NoSuchAlgorithmException|NoSuchPaddingException|InvalidAlgorithmParameterException|IllegalBlockSizeException|BadPaddingException|CertificateException|IOException e) {
      Slog.e(TAG,"Failed to decrypt child profile key",e);
    }
  }
 else {
    if (currentHandle == null) {
      if (savedCredential != null) {
        Slog.w(TAG,"Saved credential provided, but none stored");
      }
      savedCredential=null;
    }
  }
  byte[] enrolledHandle=enrollCredential(currentHandle,savedCredential,password,userId);
  if (enrolledHandle != null) {
    CredentialHash willStore=new CredentialHash(enrolledHandle,CredentialHash.VERSION_GATEKEEPER);
    setUserKeyProtection(userId,password,doVerifyPassword(password,willStore,true,0,userId));
    mStorage.writePasswordHash(enrolledHandle,userId);
    fixateNewestUserKeyAuth(userId);
    onUserLockChanged(userId);
  }
 else {
    throw new RemoteException("Failed to enroll password");
  }
}
