{
  checkPasswordReadPermission(userId);
  CredentialHash storedHash=mStorage.readPatternHash(userId);
  if ((storedHash == null || storedHash.hash.length == 0) && TextUtils.isEmpty(pattern)) {
    return null;
  }
  if (TextUtils.isEmpty(pattern)) {
    throw new VerificationFailedException();
  }
  if (storedHash.version == CredentialHash.VERSION_LEGACY) {
    byte[] hash=mLockPatternUtils.patternToHash(mLockPatternUtils.stringToPattern(pattern));
    if (Arrays.equals(hash,storedHash.hash)) {
      maybeUpdateKeystore(pattern,userId);
      setLockPattern(pattern,null,userId);
      if (!hasChallenge) {
        return null;
      }
    }
 else {
      throw new VerificationFailedException();
    }
  }
  byte[] token=null;
  if (hasChallenge) {
    token=getGateKeeperService().verifyChallenge(userId,challenge,storedHash.hash,pattern.getBytes());
    if (token == null) {
      throw new VerificationFailedException();
    }
  }
 else   if (!getGateKeeperService().verify(userId,storedHash.hash,pattern.getBytes())) {
    throw new VerificationFailedException();
  }
  maybeUpdateKeystore(pattern,userId);
  return token;
}
