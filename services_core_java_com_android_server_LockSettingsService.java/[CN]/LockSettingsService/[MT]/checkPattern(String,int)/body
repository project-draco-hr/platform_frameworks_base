{
  checkPasswordReadPermission(userId);
  CredentialHash storedHash=mStorage.readPatternHash(userId);
  if (storedHash == null) {
    return true;
  }
  if (storedHash.version == CredentialHash.VERSION_LEGACY) {
    byte[] hash=LockPatternUtils.patternToHash(LockPatternUtils.stringToPattern(pattern));
    boolean matched=Arrays.equals(hash,storedHash.hash);
    if (matched && !TextUtils.isEmpty(pattern)) {
      maybeUpdateKeystore(pattern,userId);
      setLockPattern(pattern,null,userId);
    }
    return matched;
  }
  boolean matched=getGateKeeperService().verify(userId,storedHash.hash,pattern.getBytes());
  if (matched && !TextUtils.isEmpty(pattern)) {
    maybeUpdateKeystore(pattern,userId);
    return true;
  }
  return matched;
}
