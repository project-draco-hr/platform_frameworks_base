{
  checkPasswordReadPermission(userId);
  CredentialHash storedHash=mStorage.readPasswordHash(userId);
  if (storedHash == null) {
    return true;
  }
  if (storedHash.version == CredentialHash.VERSION_LEGACY) {
    byte[] hash=mLockPatternUtils.passwordToHash(password,userId);
    boolean matched=Arrays.equals(hash,storedHash.hash);
    if (matched && !TextUtils.isEmpty(password)) {
      maybeUpdateKeystore(password,userId);
      setLockPassword(password,null,userId);
    }
    return matched;
  }
  boolean matched=getGateKeeperService().verify(userId,storedHash.hash,password.getBytes());
  if (!TextUtils.isEmpty(password) && matched) {
    maybeUpdateKeystore(password,userId);
  }
  return matched;
}
