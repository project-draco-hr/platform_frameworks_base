{
  mHandler.post(new Runnable(){
    @Override public void run(){
      try {
        final IActivityManager am=ActivityManagerNative.getDefault();
        if (am == null)         return;
        final int[] resolvedUserIds;
        if (userIds == null) {
          resolvedUserIds=am.getRunningUserIds();
        }
 else {
          resolvedUserIds=userIds;
        }
        for (        int id : resolvedUserIds) {
          final Intent intent=new Intent(action,pkg != null ? Uri.fromParts("package",pkg,null) : null);
          if (extras != null) {
            intent.putExtras(extras);
          }
          if (targetPkg != null) {
            intent.setPackage(targetPkg);
          }
          int uid=intent.getIntExtra(Intent.EXTRA_UID,-1);
          if (uid > 0 && UserHandle.getUserId(uid) != id) {
            uid=UserHandle.getUid(id,UserHandle.getAppId(uid));
            intent.putExtra(Intent.EXTRA_UID,uid);
          }
          intent.putExtra(Intent.EXTRA_USER_HANDLE,id);
          intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT | flags);
          if (DEBUG_BROADCASTS) {
            RuntimeException here=new RuntimeException("here");
            here.fillInStackTrace();
            Slog.d(TAG,"Sending to user " + id + ": "+ intent.toShortString(false,true,false,false)+ " "+ intent.getExtras(),here);
          }
          am.broadcastIntent(null,intent,null,finishedReceiver,0,null,null,null,android.app.AppOpsManager.OP_NONE,null,finishedReceiver != null,false,id);
        }
      }
 catch (      RemoteException ex) {
      }
    }
  }
);
}
