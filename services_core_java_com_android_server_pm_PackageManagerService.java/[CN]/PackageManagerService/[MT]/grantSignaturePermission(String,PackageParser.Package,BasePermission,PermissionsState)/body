{
  boolean allowed;
  allowed=(compareSignatures(bp.packageSetting.signatures.mSignatures,pkg.mSignatures) == PackageManager.SIGNATURE_MATCH) || (compareSignatures(mPlatformPackage.mSignatures,pkg.mSignatures) == PackageManager.SIGNATURE_MATCH);
  if (!allowed && (bp.protectionLevel & PermissionInfo.PROTECTION_FLAG_SYSTEM) != 0) {
    if (isSystemApp(pkg)) {
      if (pkg.isUpdatedSystemApp()) {
        final PackageSetting sysPs=mSettings.getDisabledSystemPkgLPr(pkg.packageName);
        if (sysPs.getPermissionsState().hasInstallPermission(perm)) {
          if (sysPs.isPrivileged()) {
            allowed=true;
          }
        }
 else {
          if (sysPs.pkg != null && sysPs.isPrivileged()) {
            for (int j=0; j < sysPs.pkg.requestedPermissions.size(); j++) {
              if (perm.equals(sysPs.pkg.requestedPermissions.get(j))) {
                allowed=true;
                break;
              }
            }
          }
        }
      }
 else {
        allowed=isPrivilegedApp(pkg);
      }
    }
  }
  if (!allowed && (bp.protectionLevel & PermissionInfo.PROTECTION_FLAG_PRE23) != 0 && pkg.applicationInfo.targetSdkVersion < Build.VERSION_CODES.MNC) {
    allowed=true;
  }
  if (!allowed && (bp.protectionLevel & PermissionInfo.PROTECTION_FLAG_DEVELOPMENT) != 0) {
    allowed=origPermissions.hasInstallPermission(perm);
  }
  return allowed;
}
