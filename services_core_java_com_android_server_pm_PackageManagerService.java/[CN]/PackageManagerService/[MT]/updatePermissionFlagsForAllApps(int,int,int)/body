{
  if (!sUserManager.exists(userId)) {
    return;
  }
  enforceGrantRevokeRuntimePermissionPermissions("updatePermissionFlagsForAllApps");
  enforceCrossUserPermission(Binder.getCallingUid(),userId,true,true,"updatePermissionFlagsForAllApps");
  if (getCallingUid() != Process.SYSTEM_UID) {
    flagMask&=~PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;
    flagValues&=~PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;
  }
synchronized (mPackages) {
    boolean changed=false;
    final int packageCount=mPackages.size();
    for (int pkgIndex=0; pkgIndex < packageCount; pkgIndex++) {
      final PackageParser.Package pkg=mPackages.valueAt(pkgIndex);
      SettingBase sb=(SettingBase)pkg.mExtras;
      if (sb == null) {
        continue;
      }
      PermissionsState permissionsState=sb.getPermissionsState();
      changed|=permissionsState.updatePermissionFlagsForAllPermissions(userId,flagMask,flagValues);
    }
    if (changed) {
      mSettings.writeRuntimePermissionsForUserLPr(userId,false);
    }
  }
}
