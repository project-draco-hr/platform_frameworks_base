{
  if (DEBUG_PREFERRED || DEBUG_DOMAIN_VERIFICATION) {
    Slog.v(TAG,"Filtering results with preferred activities. Candidates count: " + candidates.size());
  }
  ArrayList<ResolveInfo> result=new ArrayList<ResolveInfo>();
  ArrayList<ResolveInfo> alwaysList=new ArrayList<ResolveInfo>();
  ArrayList<ResolveInfo> undefinedList=new ArrayList<ResolveInfo>();
  ArrayList<ResolveInfo> neverList=new ArrayList<ResolveInfo>();
  ArrayList<ResolveInfo> matchAllList=new ArrayList<ResolveInfo>();
synchronized (mPackages) {
    final int count=candidates.size();
    for (int n=0; n < count; n++) {
      ResolveInfo info=candidates.get(n);
      String packageName=info.activityInfo.packageName;
      PackageSetting ps=mSettings.mPackages.get(packageName);
      if (ps != null) {
        if (info.handleAllWebDataURI) {
          matchAllList.add(info);
          continue;
        }
        long packedStatus=getDomainVerificationStatusLPr(ps,userId);
        int status=(int)(packedStatus >> 32);
        int linkGeneration=(int)(packedStatus & 0xFFFFFFFF);
        if (status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_ALWAYS) {
          if (DEBUG_DOMAIN_VERIFICATION) {
            Slog.i(TAG,"  + always: " + info.activityInfo.packageName + " : linkgen="+ linkGeneration);
          }
          info.preferredOrder=linkGeneration;
          alwaysList.add(info);
        }
 else         if (status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_NEVER) {
          if (DEBUG_DOMAIN_VERIFICATION) {
            Slog.i(TAG,"  + never: " + info.activityInfo.packageName);
          }
          neverList.add(info);
        }
 else         if (status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED || status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_ASK) {
          if (DEBUG_DOMAIN_VERIFICATION) {
            Slog.i(TAG,"  + ask: " + info.activityInfo.packageName);
          }
          undefinedList.add(info);
        }
      }
    }
    if (alwaysList.size() > 0) {
      result.addAll(alwaysList);
    }
 else     if (xpDomainInfo != null && xpDomainInfo.bestDomainVerificationStatus == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_ALWAYS) {
      result.add(xpDomainInfo.resolveInfo);
    }
 else {
      result.addAll(undefinedList);
      if (xpDomainInfo != null && (xpDomainInfo.bestDomainVerificationStatus == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED || xpDomainInfo.bestDomainVerificationStatus == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_ASK)) {
        result.add(xpDomainInfo.resolveInfo);
      }
      if ((flags & MATCH_ALL) != 0) {
        result.addAll(matchAllList);
      }
 else {
        final String defaultBrowserPackageName=getDefaultBrowserPackageName(UserHandle.myUserId());
        if (!TextUtils.isEmpty(defaultBrowserPackageName)) {
          boolean defaultBrowserFound=false;
          final int browserCount=matchAllList.size();
          for (int n=0; n < browserCount; n++) {
            ResolveInfo browser=matchAllList.get(n);
            if (browser.activityInfo.packageName.equals(defaultBrowserPackageName)) {
              result.add(browser);
              defaultBrowserFound=true;
              break;
            }
          }
          if (!defaultBrowserFound) {
            result.addAll(matchAllList);
          }
        }
 else {
          result.addAll(matchAllList);
        }
      }
      if (result.size() == 0) {
        result.addAll(candidates);
        result.removeAll(neverList);
      }
    }
  }
  if (DEBUG_PREFERRED || DEBUG_DOMAIN_VERIFICATION) {
    Slog.v(TAG,"Filtered results with preferred activities. New candidates count: " + result.size());
    for (    ResolveInfo info : result) {
      Slog.v(TAG,"  + " + info.activityInfo);
    }
  }
  return result;
}
