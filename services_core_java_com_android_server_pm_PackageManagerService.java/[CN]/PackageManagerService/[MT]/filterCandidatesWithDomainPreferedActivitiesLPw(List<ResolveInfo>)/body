{
  if (DEBUG_PREFERRED) {
    Slog.v("TAG","Filtering results with prefered activities. Candidates count: " + candidates.size());
  }
  final int userId=UserHandle.getCallingUserId();
  ArrayList<ResolveInfo> result=new ArrayList<ResolveInfo>(candidates);
synchronized (mPackages) {
    final int count=result.size();
    for (int n=count - 1; n >= 0; n--) {
      ResolveInfo info=result.get(n);
      if (!info.filterNeedsVerification) {
        continue;
      }
      String packageName=info.activityInfo.packageName;
      PackageSetting ps=mSettings.mPackages.get(packageName);
      if (ps != null) {
        int status=ps.getDomainVerificationStatusForUser(userId);
        if (status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED) {
          if (ps.getIntentFilterVerificationInfo() != null) {
            status=ps.getIntentFilterVerificationInfo().getStatus();
          }
        }
        if (status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_ALWAYS) {
          result.clear();
          result.add(info);
          break;
        }
 else         if (status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_NEVER) {
          result.remove(n);
        }
      }
    }
  }
  if (DEBUG_PREFERRED) {
    Slog.v("TAG","Filtered results with prefered activities. New candidates count: " + result.size());
  }
  return result;
}
