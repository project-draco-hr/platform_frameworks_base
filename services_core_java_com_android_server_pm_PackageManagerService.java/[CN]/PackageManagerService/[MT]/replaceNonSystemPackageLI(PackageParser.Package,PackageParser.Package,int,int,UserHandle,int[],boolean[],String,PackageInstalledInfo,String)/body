{
  PackageParser.Package newPackage=null;
  String pkgName=deletedPackage.packageName;
  boolean deletedPkg=true;
  boolean updatedSettings=false;
  if (DEBUG_INSTALL)   Slog.d(TAG,"replaceNonSystemPackageLI: new=" + pkg + ", old="+ deletedPackage);
  long origUpdateTime;
  if (pkg.mExtras != null) {
    origUpdateTime=((PackageSetting)pkg.mExtras).lastUpdateTime;
  }
 else {
    origUpdateTime=0;
  }
  if (!deletePackageLI(pkgName,null,true,null,null,PackageManager.DELETE_KEEP_DATA,res.removedInfo,true)) {
    res.returnCode=PackageManager.INSTALL_FAILED_REPLACE_COULDNT_DELETE;
    deletedPkg=false;
  }
 else {
    mLastScanError=PackageManager.INSTALL_SUCCEEDED;
    newPackage=scanPackageLI(pkg,parseFlags,scanMode | SCAN_UPDATE_TIME,System.currentTimeMillis(),user,abiOverride);
    if (newPackage == null) {
      Slog.w(TAG,"Package couldn't be installed in " + pkg.codePath);
      if ((res.returnCode=mLastScanError) == PackageManager.INSTALL_SUCCEEDED) {
        res.returnCode=PackageManager.INSTALL_FAILED_INVALID_APK;
      }
    }
 else {
      updateSettingsLI(deletedPackage,newPackage,installerPackageName,allUsers,perUserInstalled,res);
      updatedSettings=true;
    }
  }
  if (res.returnCode != PackageManager.INSTALL_SUCCEEDED) {
    if (updatedSettings) {
      if (DEBUG_INSTALL)       Slog.d(TAG,"Install failed, rolling pack: " + pkgName);
      deletePackageLI(pkgName,null,true,allUsers,perUserInstalled,PackageManager.DELETE_KEEP_DATA,res.removedInfo,true);
    }
    if (deletedPkg) {
      if (DEBUG_INSTALL)       Slog.d(TAG,"Install failed, reinstalling: " + deletedPackage);
      File restoreFile=new File(deletedPackage.codePath);
      boolean oldOnSd=isExternal(deletedPackage);
      int oldParseFlags=mDefParseFlags | PackageParser.PARSE_CHATTY | (isForwardLocked(deletedPackage) ? PackageParser.PARSE_FORWARD_LOCK : 0)| (oldOnSd ? PackageParser.PARSE_ON_SDCARD : 0);
      int oldScanMode=(oldOnSd ? 0 : SCAN_MONITOR) | SCAN_UPDATE_SIGNATURE | SCAN_UPDATE_TIME;
      if (scanPackageLI(restoreFile,oldParseFlags,oldScanMode,origUpdateTime,null,null) == null) {
        Slog.e(TAG,"Failed to restore package : " + pkgName + " after failed upgrade");
        return;
      }
synchronized (mPackages) {
        updatePermissionsLPw(deletedPackage.packageName,deletedPackage,UPDATE_PERMISSIONS_ALL);
        mSettings.writeLPr();
      }
      Slog.i(TAG,"Successfully restored package : " + pkgName + " after failed upgrade");
    }
  }
}
