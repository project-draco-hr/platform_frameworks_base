{
  final String[] instructionSets=targetInstructionSets != null ? targetInstructionSets : getAppDexInstructionSets(pkg.applicationInfo);
  if (done != null) {
    done.add(pkg.packageName);
    if (pkg.usesLibraries != null) {
      performDexOptLibsLI(pkg.usesLibraries,instructionSets,forceDex,defer,done);
    }
    if (pkg.usesOptionalLibraries != null) {
      performDexOptLibsLI(pkg.usesOptionalLibraries,instructionSets,forceDex,defer,done);
    }
  }
  if ((pkg.applicationInfo.flags & ApplicationInfo.FLAG_HAS_CODE) != 0) {
    final Collection<String> paths=pkg.getAllCodePaths();
    for (    String path : paths) {
      for (      String instructionSet : instructionSets) {
        try {
          boolean isDexOptNeededInternal=DexFile.isDexOptNeededInternal(path,pkg.packageName,instructionSet,defer);
          if (forceDex || (!defer && isDexOptNeededInternal)) {
            Log.i(TAG,"Running dexopt on: " + pkg.applicationInfo.packageName);
            final int sharedGid=UserHandle.getSharedAppGid(pkg.applicationInfo.uid);
            int ret=mInstaller.dexopt(path,sharedGid,!isForwardLocked(pkg),pkg.packageName,instructionSet);
            pkg.mDexOptNeeded=false;
            if (ret < 0) {
              return DEX_OPT_FAILED;
            }
            return DEX_OPT_PERFORMED;
          }
          if (defer && isDexOptNeededInternal) {
            if (mDeferredDexOpt == null) {
              mDeferredDexOpt=new HashSet<PackageParser.Package>();
            }
            mDeferredDexOpt.add(pkg);
            return DEX_OPT_DEFERRED;
          }
          pkg.mDexOptNeeded=false;
          return DEX_OPT_SKIPPED;
        }
 catch (        FileNotFoundException e) {
          Slog.w(TAG,"Apk not found for dexopt: " + path);
          return DEX_OPT_FAILED;
        }
catch (        IOException e) {
          Slog.w(TAG,"IOException reading apk: " + path,e);
          return DEX_OPT_FAILED;
        }
catch (        StaleDexCacheError e) {
          Slog.w(TAG,"StaleDexCacheError when reading apk: " + path,e);
          return DEX_OPT_FAILED;
        }
catch (        Exception e) {
          Slog.w(TAG,"Exception when doing dexopt : ",e);
          return DEX_OPT_FAILED;
        }
      }
    }
  }
  return DEX_OPT_SKIPPED;
}
