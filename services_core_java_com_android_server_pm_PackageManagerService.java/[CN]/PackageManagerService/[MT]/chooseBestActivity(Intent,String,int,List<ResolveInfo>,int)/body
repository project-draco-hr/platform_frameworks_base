{
  final boolean isWebUri=hasWebURI(intent);
  if (isWebUri && mEphemeralResolverConnection != null) {
    boolean hasAlwaysHandler=false;
synchronized (mPackages) {
      final int count=query.size();
      for (int n=0; n < count; n++) {
        ResolveInfo info=query.get(n);
        String packageName=info.activityInfo.packageName;
        PackageSetting ps=mSettings.mPackages.get(packageName);
        if (ps != null) {
          long packedStatus=getDomainVerificationStatusLPr(ps,userId);
          int status=(int)(packedStatus >> 32);
          if (status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_ALWAYS || status == INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_ALWAYS_ASK) {
            hasAlwaysHandler=true;
            break;
          }
        }
      }
    }
    if (!hasAlwaysHandler && isEphemeralAvailable(intent,resolvedType,userId)) {
      if (DEBUG_EPHEMERAL) {
        Slog.v(TAG,"Resolving to the ephemeral installer");
      }
      ResolveInfo ri=new ResolveInfo(mEphemeralInstallerInfo);
      ri.activityInfo=new ActivityInfo(ri.activityInfo);
      ri.activityInfo.applicationInfo=new ApplicationInfo(ri.activityInfo.applicationInfo);
      if (userId != 0) {
        ri.activityInfo.applicationInfo.uid=UserHandle.getUid(userId,UserHandle.getAppId(ri.activityInfo.applicationInfo.uid));
      }
      return ri;
    }
  }
  if (query != null) {
    final int N=query.size();
    if (N == 1) {
      return query.get(0);
    }
 else     if (N > 1) {
      final boolean debug=((intent.getFlags() & Intent.FLAG_DEBUG_LOG_RESOLUTION) != 0);
      ResolveInfo r0=query.get(0);
      ResolveInfo r1=query.get(1);
      if (DEBUG_INTENT_MATCHING || debug) {
        Slog.v(TAG,r0.activityInfo.name + "=" + r0.priority+ " vs "+ r1.activityInfo.name+ "="+ r1.priority);
      }
      if (r0.priority != r1.priority || r0.preferredOrder != r1.preferredOrder || r0.isDefault != r1.isDefault) {
        return query.get(0);
      }
      ResolveInfo ri=findPreferredActivity(intent,resolvedType,flags,query,r0.priority,true,false,debug,userId);
      if (ri != null) {
        return ri;
      }
      ri=new ResolveInfo(mResolveInfo);
      ri.activityInfo=new ActivityInfo(ri.activityInfo);
      ri.activityInfo.applicationInfo=new ApplicationInfo(ri.activityInfo.applicationInfo);
      if (userId != 0) {
        ri.activityInfo.applicationInfo.uid=UserHandle.getUid(userId,UserHandle.getAppId(ri.activityInfo.applicationInfo.uid));
      }
      if (ri.activityInfo.metaData == null)       ri.activityInfo.metaData=new Bundle();
      ri.activityInfo.metaData.putBoolean(Intent.METADATA_DOCK_HOME,true);
      return ri;
    }
  }
  return null;
}
