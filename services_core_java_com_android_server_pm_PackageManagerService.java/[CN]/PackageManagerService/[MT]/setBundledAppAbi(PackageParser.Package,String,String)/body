{
  final File codeFile=new File(pkg.codePath);
  final boolean has64BitLibs;
  final boolean has32BitLibs;
  if (isApkFile(codeFile)) {
    has64BitLibs=(new File(apkRoot,new File(LIB64_DIR_NAME,apkName).getPath())).exists();
    has32BitLibs=(new File(apkRoot,new File(LIB_DIR_NAME,apkName).getPath())).exists();
  }
 else {
    final File rootDir=new File(codeFile,LIB_DIR_NAME);
    if (!ArrayUtils.isEmpty(Build.SUPPORTED_64_BIT_ABIS) && !TextUtils.isEmpty(Build.SUPPORTED_64_BIT_ABIS[0])) {
      final String isa=VMRuntime.getInstructionSet(Build.SUPPORTED_64_BIT_ABIS[0]);
      has64BitLibs=(new File(rootDir,isa)).exists();
    }
 else {
      has64BitLibs=false;
    }
    if (!ArrayUtils.isEmpty(Build.SUPPORTED_32_BIT_ABIS) && !TextUtils.isEmpty(Build.SUPPORTED_32_BIT_ABIS[0])) {
      final String isa=VMRuntime.getInstructionSet(Build.SUPPORTED_32_BIT_ABIS[0]);
      has32BitLibs=(new File(rootDir,isa)).exists();
    }
 else {
      has32BitLibs=false;
    }
  }
  if (has64BitLibs && !has32BitLibs) {
    pkg.applicationInfo.primaryCpuAbi=Build.SUPPORTED_64_BIT_ABIS[0];
    pkg.applicationInfo.secondaryCpuAbi=null;
  }
 else   if (has32BitLibs && !has64BitLibs) {
    pkg.applicationInfo.primaryCpuAbi=Build.SUPPORTED_32_BIT_ABIS[0];
    pkg.applicationInfo.secondaryCpuAbi=null;
  }
 else   if (has32BitLibs && has64BitLibs) {
    if ((pkg.applicationInfo.flags & ApplicationInfo.FLAG_MULTIARCH) == 0) {
      Slog.e(TAG,"Package " + pkg + " has multiple bundled libs, but is not multiarch.");
    }
    if (VMRuntime.is64BitInstructionSet(getPreferredInstructionSet())) {
      pkg.applicationInfo.primaryCpuAbi=Build.SUPPORTED_64_BIT_ABIS[0];
      pkg.applicationInfo.secondaryCpuAbi=Build.SUPPORTED_32_BIT_ABIS[0];
    }
 else {
      pkg.applicationInfo.primaryCpuAbi=Build.SUPPORTED_32_BIT_ABIS[0];
      pkg.applicationInfo.secondaryCpuAbi=Build.SUPPORTED_64_BIT_ABIS[0];
    }
  }
 else {
    pkg.applicationInfo.primaryCpuAbi=null;
    pkg.applicationInfo.secondaryCpuAbi=null;
  }
}
