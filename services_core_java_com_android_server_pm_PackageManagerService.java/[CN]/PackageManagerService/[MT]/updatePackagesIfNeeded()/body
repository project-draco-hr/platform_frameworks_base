{
  enforceSystemOrRoot("Only the system can request package update");
  boolean causeUpgrade=isUpgrade();
  boolean causeFirstBoot=isFirstBoot() || mIsPreNUpgrade;
  boolean causePrunedCache=VMRuntime.didPruneDalvikCache();
  if (!causeUpgrade && !causeFirstBoot && !causePrunedCache) {
    return;
  }
  List<PackageParser.Package> pkgs;
synchronized (mPackages) {
    pkgs=PackageManagerServiceUtils.getPackagesForDexopt(mPackages.values(),this);
  }
  final long startTime=System.nanoTime();
  final int[] stats=performDexOpt(pkgs,mIsPreNUpgrade,getCompilerFilterForReason(causeFirstBoot ? REASON_FIRST_BOOT : REASON_BOOT));
  final int elapsedTimeSeconds=(int)TimeUnit.NANOSECONDS.toSeconds(System.nanoTime() - startTime);
  MetricsLogger.histogram(mContext,"opt_dialog_num_dexopted",stats[0]);
  MetricsLogger.histogram(mContext,"opt_dialog_num_skipped",stats[1]);
  MetricsLogger.histogram(mContext,"opt_dialog_num_failed",stats[2]);
  MetricsLogger.histogram(mContext,"opt_dialog_num_total",getOptimizablePackages().size());
  MetricsLogger.histogram(mContext,"opt_dialog_time_s",elapsedTimeSeconds);
}
