{
  if (!nativeLibraryDir.isDirectory()) {
    nativeLibraryDir.delete();
    if (!nativeLibraryDir.mkdir()) {
      throw new IOException("Cannot create " + nativeLibraryDir.getPath());
    }
    try {
      Os.chmod(nativeLibraryDir.getPath(),S_IRWXU | S_IRGRP | S_IXGRP| S_IROTH| S_IXOTH);
    }
 catch (    ErrnoException e) {
      throw new IOException("Cannot chmod native library directory " + nativeLibraryDir.getPath(),e);
    }
  }
 else   if (!SELinux.restorecon(nativeLibraryDir)) {
    throw new IOException("Cannot set SELinux context for " + nativeLibraryDir.getPath());
  }
  final NativeLibraryHelper.ApkHandle handle=new NativeLibraryHelper.ApkHandle(scanFile);
  try {
    int abi=NativeLibraryHelper.findSupportedAbi(handle,Build.SUPPORTED_ABIS);
    if (abi >= 0) {
      int copyRet=NativeLibraryHelper.copyNativeBinariesIfNeededLI(handle,nativeLibraryDir,Build.SUPPORTED_ABIS[abi]);
      if (copyRet != PackageManager.INSTALL_SUCCEEDED) {
        return copyRet;
      }
    }
    return abi;
  }
  finally {
    handle.close();
  }
}
