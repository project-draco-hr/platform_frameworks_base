{
  final boolean bundledApk=isSystemApp(pkg) && !isUpdatedSystemApp(pkg);
  final File codeFile=new File(pkg.applicationInfo.getCodePath());
  final String apkName=deriveCodePathName(pkg.applicationInfo.getCodePath());
  final String nativeLibraryPath;
  if (bundledApk) {
    String apkRoot=calculateApkRoot(pkg.applicationInfo.getCodePath());
    File lib64=new File(apkRoot,LIB64_DIR_NAME);
    File packLib64=new File(lib64,apkName);
    File libDir=(packLib64.exists()) ? lib64 : new File(apkRoot,LIB_DIR_NAME);
    nativeLibraryPath=(new File(libDir,apkName)).getAbsolutePath();
  }
 else {
    nativeLibraryPath=pkg.applicationInfo.nativeLibraryDir;
  }
  pkg.applicationInfo.nativeLibraryDir=nativeLibraryPath;
  if (pkgSetting != null) {
    pkgSetting.nativeLibraryPathString=nativeLibraryPath;
  }
}
