{
  String pkgName=pkg.packageName;
  if (DEBUG_INSTALL)   Slog.d(TAG,"installNewPackageLI: " + pkg);
  boolean dataDirExists=getDataPathForPackage(pkg.packageName,0).exists();
synchronized (mPackages) {
    if (mSettings.mRenamedPackages.containsKey(pkgName)) {
      Slog.w(TAG,"Attempt to re-install " + pkgName + " without first uninstalling package running as "+ mSettings.mRenamedPackages.get(pkgName));
      res.returnCode=PackageManager.INSTALL_FAILED_ALREADY_EXISTS;
      return;
    }
    if (mPackages.containsKey(pkgName) || mAppDirs.containsKey(pkg.codePath)) {
      Slog.w(TAG,"Attempt to re-install " + pkgName + " without first uninstalling.");
      res.returnCode=PackageManager.INSTALL_FAILED_ALREADY_EXISTS;
      return;
    }
  }
  mLastScanError=PackageManager.INSTALL_SUCCEEDED;
  PackageParser.Package newPackage=scanPackageLI(pkg,parseFlags,scanMode,System.currentTimeMillis(),user,abiOverride);
  if (newPackage == null) {
    Slog.w(TAG,"Package couldn't be installed in " + pkg.codePath);
    if ((res.returnCode=mLastScanError) == PackageManager.INSTALL_SUCCEEDED) {
      res.returnCode=PackageManager.INSTALL_FAILED_INVALID_APK;
    }
  }
 else {
    updateSettingsLI(null,newPackage,installerPackageName,null,null,res);
    if (res.returnCode != PackageManager.INSTALL_SUCCEEDED) {
      deletePackageLI(pkgName,UserHandle.ALL,false,null,null,dataDirExists ? PackageManager.DELETE_KEEP_DATA : 0,res.removedInfo,true);
    }
  }
}
