{
  final long identity=Binder.clearCallingIdentity();
  try {
    if (sb instanceof SharedUserSetting) {
      SharedUserSetting sus=(SharedUserSetting)sb;
      final int packageCount=sus.packages.size();
      for (int i=0; i < packageCount; i++) {
        PackageSetting susPs=sus.packages.valueAt(i);
        if (userId == UserHandle.USER_ALL) {
          killApplication(susPs.pkg.packageName,susPs.appId,reason);
        }
 else {
          final int uid=UserHandle.getUid(userId,susPs.appId);
          killUid(uid,reason);
        }
      }
    }
 else     if (sb instanceof PackageSetting) {
      PackageSetting ps=(PackageSetting)sb;
      if (userId == UserHandle.USER_ALL) {
        killApplication(ps.pkg.packageName,ps.appId,reason);
      }
 else {
        final int uid=UserHandle.getUid(userId,ps.appId);
        killUid(uid,reason);
      }
    }
  }
  finally {
    Binder.restoreCallingIdentity(identity);
  }
}
