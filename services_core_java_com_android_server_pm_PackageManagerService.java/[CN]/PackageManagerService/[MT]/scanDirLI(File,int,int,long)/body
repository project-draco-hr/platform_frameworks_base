{
  final File[] files=dir.listFiles();
  if (ArrayUtils.isEmpty(files)) {
    Log.d(TAG,"No files in app dir " + dir);
    return;
  }
  if (DEBUG_PACKAGE_SCANNING) {
    Log.d(TAG,"Scanning app dir " + dir + " scanMode="+ scanMode+ " flags=0x"+ Integer.toHexString(flags));
  }
  for (  File file : files) {
    if (!isApkFile(file)) {
      continue;
    }
    PackageParser.Package pkg=scanPackageLI(file,flags | PackageParser.PARSE_MUST_BE_APK,scanMode,currentTime,null,null);
    if (pkg == null && (flags & PackageParser.PARSE_IS_SYSTEM) == 0 && mLastScanError == PackageManager.INSTALL_FAILED_INVALID_APK) {
      Slog.w(TAG,"Cleaning up failed install of " + file);
      file.delete();
    }
  }
}
