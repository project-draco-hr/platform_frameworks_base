{
  if (mContext.checkCallingOrSelfPermission(android.Manifest.permission.DUMP) != PackageManager.PERMISSION_GRANTED) {
    pw.println("Permission Denial: can't dump ActivityManager from from pid=" + Binder.getCallingPid() + ", uid="+ Binder.getCallingUid()+ " without permission "+ android.Manifest.permission.DUMP);
    return;
  }
  DumpState dumpState=new DumpState();
  boolean fullPreferred=false;
  boolean checkin=false;
  String packageName=null;
  int opti=0;
  while (opti < args.length) {
    String opt=args[opti];
    if (opt == null || opt.length() <= 0 || opt.charAt(0) != '-') {
      break;
    }
    opti++;
    if ("-a".equals(opt)) {
    }
 else     if ("-h".equals(opt)) {
      pw.println("Package manager dump options:");
      pw.println("  [-h] [-f] [--checkin] [cmd] ...");
      pw.println("    --checkin: dump for a checkin");
      pw.println("    -f: print details of intent filters");
      pw.println("    -h: print this help");
      pw.println("  cmd may be one of:");
      pw.println("    l[ibraries]: list known shared libraries");
      pw.println("    f[ibraries]: list device features");
      pw.println("    k[eysets]: print known keysets");
      pw.println("    r[esolvers]: dump intent resolvers");
      pw.println("    perm[issions]: dump permissions");
      pw.println("    pref[erred]: print preferred package settings");
      pw.println("    preferred-xml [--full]: print preferred package settings as xml");
      pw.println("    prov[iders]: dump content providers");
      pw.println("    p[ackages]: dump installed packages");
      pw.println("    s[hared-users]: dump shared user IDs");
      pw.println("    m[essages]: print collected runtime messages");
      pw.println("    v[erifiers]: print package verifier info");
      pw.println("    version: print database version info");
      pw.println("    write: write current settings now");
      pw.println("    <package.name>: info about given package");
      pw.println("    installs: details about install sessions");
      return;
    }
 else     if ("--checkin".equals(opt)) {
      checkin=true;
    }
 else     if ("-f".equals(opt)) {
      dumpState.setOptionEnabled(DumpState.OPTION_SHOW_FILTERS);
    }
 else {
      pw.println("Unknown argument: " + opt + "; use -h for help");
    }
  }
  if (opti < args.length) {
    String cmd=args[opti];
    opti++;
    if ("android".equals(cmd) || cmd.contains(".")) {
      packageName=cmd;
      dumpState.setOptionEnabled(DumpState.OPTION_SHOW_FILTERS);
    }
 else     if ("l".equals(cmd) || "libraries".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_LIBS);
    }
 else     if ("f".equals(cmd) || "features".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_FEATURES);
    }
 else     if ("r".equals(cmd) || "resolvers".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_RESOLVERS);
    }
 else     if ("perm".equals(cmd) || "permissions".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_PERMISSIONS);
    }
 else     if ("pref".equals(cmd) || "preferred".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_PREFERRED);
    }
 else     if ("preferred-xml".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_PREFERRED_XML);
      if (opti < args.length && "--full".equals(args[opti])) {
        fullPreferred=true;
        opti++;
      }
    }
 else     if ("p".equals(cmd) || "packages".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_PACKAGES);
    }
 else     if ("s".equals(cmd) || "shared-users".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_SHARED_USERS);
    }
 else     if ("prov".equals(cmd) || "providers".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_PROVIDERS);
    }
 else     if ("m".equals(cmd) || "messages".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_MESSAGES);
    }
 else     if ("v".equals(cmd) || "verifiers".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_VERIFIERS);
    }
 else     if ("version".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_VERSION);
    }
 else     if ("k".equals(cmd) || "keysets".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_KEYSETS);
    }
 else     if ("installs".equals(cmd)) {
      dumpState.setDump(DumpState.DUMP_INSTALLS);
    }
 else     if ("write".equals(cmd)) {
synchronized (mPackages) {
        mSettings.writeLPr();
        pw.println("Settings written.");
        return;
      }
    }
  }
  if (checkin) {
    pw.println("vers,1");
  }
synchronized (mPackages) {
    if (dumpState.isDumping(DumpState.DUMP_VERSION) && packageName == null) {
      if (!checkin) {
        if (dumpState.onTitlePrinted())         pw.println();
        pw.println("Database versions:");
        pw.print("  SDK Version:");
        pw.print(" internal=");
        pw.print(mSettings.mInternalSdkPlatform);
        pw.print(" external=");
        pw.println(mSettings.mExternalSdkPlatform);
        pw.print("  DB Version:");
        pw.print(" internal=");
        pw.print(mSettings.mInternalDatabaseVersion);
        pw.print(" external=");
        pw.println(mSettings.mExternalDatabaseVersion);
      }
    }
    if (dumpState.isDumping(DumpState.DUMP_VERIFIERS) && packageName == null) {
      if (!checkin) {
        if (dumpState.onTitlePrinted())         pw.println();
        pw.println("Verifiers:");
        pw.print("  Required: ");
        pw.print(mRequiredVerifierPackage);
        pw.print(" (uid=");
        pw.print(getPackageUid(mRequiredVerifierPackage,0));
        pw.println(")");
      }
 else       if (mRequiredVerifierPackage != null) {
        pw.print("vrfy,");
        pw.print(mRequiredVerifierPackage);
        pw.print(",");
        pw.println(getPackageUid(mRequiredVerifierPackage,0));
      }
    }
    if (dumpState.isDumping(DumpState.DUMP_LIBS) && packageName == null) {
      boolean printedHeader=false;
      final Iterator<String> it=mSharedLibraries.keySet().iterator();
      while (it.hasNext()) {
        String name=it.next();
        SharedLibraryEntry ent=mSharedLibraries.get(name);
        if (!checkin) {
          if (!printedHeader) {
            if (dumpState.onTitlePrinted())             pw.println();
            pw.println("Libraries:");
            printedHeader=true;
          }
          pw.print("  ");
        }
 else {
          pw.print("lib,");
        }
        pw.print(name);
        if (!checkin) {
          pw.print(" -> ");
        }
        if (ent.path != null) {
          if (!checkin) {
            pw.print("(jar) ");
            pw.print(ent.path);
          }
 else {
            pw.print(",jar,");
            pw.print(ent.path);
          }
        }
 else {
          if (!checkin) {
            pw.print("(apk) ");
            pw.print(ent.apk);
          }
 else {
            pw.print(",apk,");
            pw.print(ent.apk);
          }
        }
        pw.println();
      }
    }
    if (dumpState.isDumping(DumpState.DUMP_FEATURES) && packageName == null) {
      if (dumpState.onTitlePrinted())       pw.println();
      if (!checkin) {
        pw.println("Features:");
      }
      Iterator<String> it=mAvailableFeatures.keySet().iterator();
      while (it.hasNext()) {
        String name=it.next();
        if (!checkin) {
          pw.print("  ");
        }
 else {
          pw.print("feat,");
        }
        pw.println(name);
      }
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_RESOLVERS)) {
      if (mActivities.dump(pw,dumpState.getTitlePrinted() ? "\nActivity Resolver Table:" : "Activity Resolver Table:","  ",packageName,dumpState.isOptionEnabled(DumpState.OPTION_SHOW_FILTERS))) {
        dumpState.setTitlePrinted(true);
      }
      if (mReceivers.dump(pw,dumpState.getTitlePrinted() ? "\nReceiver Resolver Table:" : "Receiver Resolver Table:","  ",packageName,dumpState.isOptionEnabled(DumpState.OPTION_SHOW_FILTERS))) {
        dumpState.setTitlePrinted(true);
      }
      if (mServices.dump(pw,dumpState.getTitlePrinted() ? "\nService Resolver Table:" : "Service Resolver Table:","  ",packageName,dumpState.isOptionEnabled(DumpState.OPTION_SHOW_FILTERS))) {
        dumpState.setTitlePrinted(true);
      }
      if (mProviders.dump(pw,dumpState.getTitlePrinted() ? "\nProvider Resolver Table:" : "Provider Resolver Table:","  ",packageName,dumpState.isOptionEnabled(DumpState.OPTION_SHOW_FILTERS))) {
        dumpState.setTitlePrinted(true);
      }
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_PREFERRED)) {
      for (int i=0; i < mSettings.mPreferredActivities.size(); i++) {
        PreferredIntentResolver pir=mSettings.mPreferredActivities.valueAt(i);
        int user=mSettings.mPreferredActivities.keyAt(i);
        if (pir.dump(pw,dumpState.getTitlePrinted() ? "\nPreferred Activities User " + user + ":" : "Preferred Activities User " + user + ":","  ",packageName,true)) {
          dumpState.setTitlePrinted(true);
        }
      }
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_PREFERRED_XML)) {
      pw.flush();
      FileOutputStream fout=new FileOutputStream(fd);
      BufferedOutputStream str=new BufferedOutputStream(fout);
      XmlSerializer serializer=new FastXmlSerializer();
      try {
        serializer.setOutput(str,"utf-8");
        serializer.startDocument(null,true);
        serializer.setFeature("http://xmlpull.org/v1/doc/features.html#indent-output",true);
        mSettings.writePreferredActivitiesLPr(serializer,0,fullPreferred);
        serializer.endDocument();
        serializer.flush();
      }
 catch (      IllegalArgumentException e) {
        pw.println("Failed writing: " + e);
      }
catch (      IllegalStateException e) {
        pw.println("Failed writing: " + e);
      }
catch (      IOException e) {
        pw.println("Failed writing: " + e);
      }
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_PERMISSIONS)) {
      mSettings.dumpPermissionsLPr(pw,packageName,dumpState);
      if (packageName == null) {
        for (int iperm=0; iperm < mAppOpPermissionPackages.size(); iperm++) {
          if (iperm == 0) {
            if (dumpState.onTitlePrinted())             pw.println();
            pw.println("AppOp Permissions:");
          }
          pw.print("  AppOp Permission ");
          pw.print(mAppOpPermissionPackages.keyAt(iperm));
          pw.println(":");
          ArraySet<String> pkgs=mAppOpPermissionPackages.valueAt(iperm);
          for (int ipkg=0; ipkg < pkgs.size(); ipkg++) {
            pw.print("    ");
            pw.println(pkgs.valueAt(ipkg));
          }
        }
      }
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_PROVIDERS)) {
      boolean printedSomething=false;
      for (      PackageParser.Provider p : mProviders.mProviders.values()) {
        if (packageName != null && !packageName.equals(p.info.packageName)) {
          continue;
        }
        if (!printedSomething) {
          if (dumpState.onTitlePrinted())           pw.println();
          pw.println("Registered ContentProviders:");
          printedSomething=true;
        }
        pw.print("  ");
        p.printComponentShortName(pw);
        pw.println(":");
        pw.print("    ");
        pw.println(p.toString());
      }
      printedSomething=false;
      for (      Map.Entry<String,PackageParser.Provider> entry : mProvidersByAuthority.entrySet()) {
        PackageParser.Provider p=entry.getValue();
        if (packageName != null && !packageName.equals(p.info.packageName)) {
          continue;
        }
        if (!printedSomething) {
          if (dumpState.onTitlePrinted())           pw.println();
          pw.println("ContentProvider Authorities:");
          printedSomething=true;
        }
        pw.print("  [");
        pw.print(entry.getKey());
        pw.println("]:");
        pw.print("    ");
        pw.println(p.toString());
        if (p.info != null && p.info.applicationInfo != null) {
          final String appInfo=p.info.applicationInfo.toString();
          pw.print("      applicationInfo=");
          pw.println(appInfo);
        }
      }
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_KEYSETS)) {
      mSettings.mKeySetManagerService.dumpLPr(pw,packageName,dumpState);
    }
    if (dumpState.isDumping(DumpState.DUMP_PACKAGES)) {
      mSettings.dumpPackagesLPr(pw,packageName,dumpState,checkin);
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_SHARED_USERS)) {
      mSettings.dumpSharedUsersLPr(pw,packageName,dumpState);
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_INSTALLS) && packageName == null) {
      if (dumpState.onTitlePrinted())       pw.println();
      mInstallerService.dump(new IndentingPrintWriter(pw,"  ",120));
    }
    if (!checkin && dumpState.isDumping(DumpState.DUMP_MESSAGES) && packageName == null) {
      if (dumpState.onTitlePrinted())       pw.println();
      mSettings.dumpReadMessagesLPr(pw,dumpState);
      pw.println();
      pw.println("Package warning messages:");
      final File fname=getSettingsProblemFile();
      FileInputStream in=null;
      try {
        in=new FileInputStream(fname);
        final int avail=in.available();
        final byte[] data=new byte[avail];
        in.read(data);
        pw.print(new String(data));
      }
 catch (      FileNotFoundException e) {
      }
catch (      IOException e) {
      }
 finally {
        if (in != null) {
          try {
            in.close();
          }
 catch (          IOException e) {
          }
        }
      }
    }
  }
}
