{
  final String volumeUuid=vol.fsUuid;
  if (TextUtils.isEmpty(volumeUuid)) {
    Slog.e(TAG,"Unloading internal storage is probably a mistake; ignoring");
    return;
  }
  final ArrayList<ApplicationInfo> unloaded=new ArrayList<>();
synchronized (mInstallLock) {
synchronized (mPackages) {
      final List<PackageSetting> packages=mSettings.getVolumePackagesLPr(volumeUuid);
      for (      PackageSetting ps : packages) {
        if (ps.pkg == null)         continue;
        final ApplicationInfo info=ps.pkg.applicationInfo;
        final PackageRemovedInfo outInfo=new PackageRemovedInfo();
        if (deletePackageLI(ps.name,null,false,null,PackageManager.DELETE_KEEP_DATA,outInfo,false,null)) {
          unloaded.add(info);
        }
 else {
          Slog.w(TAG,"Failed to unload " + ps.codePath);
        }
      }
      mSettings.writeLPr();
    }
  }
  if (DEBUG_INSTALL)   Slog.d(TAG,"Unloaded packages " + unloaded);
  sendResourcesChangedBroadcast(false,false,unloaded,null);
}
