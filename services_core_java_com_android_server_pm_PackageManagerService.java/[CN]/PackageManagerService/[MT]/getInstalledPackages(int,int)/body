{
  final boolean listUninstalled=(flags & PackageManager.GET_UNINSTALLED_PACKAGES) != 0;
  enforceCrossUserPermission(Binder.getCallingUid(),userId,true,"get installed packages");
synchronized (mPackages) {
    ArrayList<PackageInfo> list;
    if (listUninstalled) {
      list=new ArrayList<PackageInfo>(mSettings.mPackages.size());
      for (      PackageSetting ps : mSettings.mPackages.values()) {
        PackageInfo pi;
        if (ps.pkg != null) {
          pi=generatePackageInfo(ps.pkg,flags,userId);
        }
 else {
          pi=generatePackageInfoFromSettingsLPw(ps.name,flags,userId);
        }
        if (pi != null) {
          list.add(pi);
        }
      }
    }
 else {
      list=new ArrayList<PackageInfo>(mPackages.size());
      for (      PackageParser.Package p : mPackages.values()) {
        PackageInfo pi=generatePackageInfo(p,flags,userId);
        if (pi != null) {
          list.add(pi);
        }
      }
    }
    return new ParceledListSlice<PackageInfo>(list);
  }
}
