{
  if (DEBUG_INSTALL)   Slog.d(TAG,"replaceSystemPackageLI: new=" + pkg + ", old="+ deletedPackage);
  PackageParser.Package newPackage=null;
  boolean updatedSettings=false;
  parseFlags|=PackageManager.INSTALL_REPLACE_EXISTING | PackageParser.PARSE_IS_SYSTEM;
  if ((deletedPackage.applicationInfo.flags & ApplicationInfo.FLAG_PRIVILEGED) != 0) {
    parseFlags|=PackageParser.PARSE_IS_PRIVILEGED;
  }
  String packageName=deletedPackage.packageName;
  res.returnCode=PackageManager.INSTALL_FAILED_REPLACE_COULDNT_DELETE;
  if (packageName == null) {
    Slog.w(TAG,"Attempt to delete null packageName.");
    return;
  }
  PackageParser.Package oldPkg;
  PackageSetting oldPkgSetting;
synchronized (mPackages) {
    oldPkg=mPackages.get(packageName);
    oldPkgSetting=mSettings.mPackages.get(packageName);
    if ((oldPkg == null) || (oldPkg.applicationInfo == null) || (oldPkgSetting == null)) {
      Slog.w(TAG,"Couldn't find package:" + packageName + " information");
      return;
    }
  }
  killApplication(packageName,oldPkg.applicationInfo.uid,"replace sys pkg");
  res.removedInfo.uid=oldPkg.applicationInfo.uid;
  res.removedInfo.removedPackage=packageName;
  removePackageLI(oldPkgSetting,true);
synchronized (mPackages) {
    if (!mSettings.disableSystemPackageLPw(packageName) && deletedPackage != null) {
      res.removedInfo.args=createInstallArgs(0,deletedPackage.applicationInfo.sourceDir,deletedPackage.applicationInfo.publicSourceDir,deletedPackage.applicationInfo.nativeLibraryDir);
    }
 else {
      res.removedInfo.args=null;
    }
  }
  mLastScanError=PackageManager.INSTALL_SUCCEEDED;
  pkg.applicationInfo.flags|=ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;
  newPackage=scanPackageLI(pkg,parseFlags,scanMode,0,user);
  if (newPackage == null) {
    Slog.w(TAG,"Package couldn't be installed in " + pkg.mPath);
    if ((res.returnCode=mLastScanError) == PackageManager.INSTALL_SUCCEEDED) {
      res.returnCode=PackageManager.INSTALL_FAILED_INVALID_APK;
    }
  }
 else {
    if (newPackage.mExtras != null) {
      final PackageSetting newPkgSetting=(PackageSetting)newPackage.mExtras;
      newPkgSetting.firstInstallTime=oldPkgSetting.firstInstallTime;
      newPkgSetting.lastUpdateTime=System.currentTimeMillis();
      if (oldPkgSetting.sharedUser != newPkgSetting.sharedUser) {
        Slog.w(TAG,"Forbidding shared user change from " + oldPkgSetting.sharedUser + " to "+ newPkgSetting.sharedUser);
        res.returnCode=PackageManager.INSTALL_FAILED_SHARED_USER_INCOMPATIBLE;
        updatedSettings=true;
      }
    }
    if (res.returnCode == PackageManager.INSTALL_SUCCEEDED) {
      updateSettingsLI(newPackage,installerPackageName,allUsers,perUserInstalled,res);
      updatedSettings=true;
    }
  }
  if (res.returnCode != PackageManager.INSTALL_SUCCEEDED) {
    if (newPackage != null) {
      removeInstalledPackageLI(newPackage,true);
    }
    scanPackageLI(oldPkg,parseFlags,SCAN_MONITOR | SCAN_UPDATE_SIGNATURE,0,user);
synchronized (mPackages) {
      if (updatedSettings) {
        mSettings.enableSystemPackageLPw(packageName);
        mSettings.setInstallerPackageName(packageName,oldPkgSetting.installerPackageName);
      }
      mSettings.writeLPr();
    }
  }
}
