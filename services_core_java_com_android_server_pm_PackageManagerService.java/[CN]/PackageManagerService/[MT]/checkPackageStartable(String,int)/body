{
  final boolean userKeyUnlocked=isUserKeyUnlocked(userId);
synchronized (mPackages) {
    final PackageSetting ps=mSettings.mPackages.get(packageName);
    if (ps == null) {
      throw new SecurityException("Package " + packageName + " was not found!");
    }
    if (mSafeMode && !ps.isSystem()) {
      throw new SecurityException("Package " + packageName + " not a system app!");
    }
    if (ps.frozen) {
      throw new SecurityException("Package " + packageName + " is currently frozen!");
    }
    if (!userKeyUnlocked && !(ps.pkg.applicationInfo.isEncryptionAware() || ps.pkg.applicationInfo.isPartiallyEncryptionAware())) {
      throw new SecurityException("Package " + packageName + " is not encryption aware!");
    }
  }
}
