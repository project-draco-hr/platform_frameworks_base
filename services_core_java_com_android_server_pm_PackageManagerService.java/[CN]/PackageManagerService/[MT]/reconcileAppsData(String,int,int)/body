{
  Slog.v(TAG,"reconcileAppsData for " + volumeUuid + " u"+ userId+ " 0x"+ Integer.toHexString(flags));
  final File ceDir=Environment.getDataUserCredentialEncryptedDirectory(volumeUuid,userId);
  final File deDir=Environment.getDataUserDeviceEncryptedDirectory(volumeUuid,userId);
  boolean restoreconNeeded=false;
  if ((flags & Installer.FLAG_CE_STORAGE) != 0) {
    if (!isUserKeyUnlocked(userId)) {
      throw new RuntimeException("Yikes, someone asked us to reconcile CE storage while " + userId + " was still locked; this would have caused massive data loss!");
    }
    restoreconNeeded|=SELinuxMMAC.isRestoreconNeeded(ceDir);
    final File[] files=FileUtils.listFilesOrEmpty(ceDir);
    for (    File file : files) {
      final String packageName=file.getName();
      try {
        assertPackageKnownAndInstalled(volumeUuid,packageName,userId);
      }
 catch (      PackageManagerException e) {
        logCriticalInfo(Log.WARN,"Destroying " + file + " due to: "+ e);
synchronized (mInstallLock) {
          destroyAppDataLI(volumeUuid,packageName,userId,Installer.FLAG_CE_STORAGE);
        }
      }
    }
  }
  if ((flags & Installer.FLAG_DE_STORAGE) != 0) {
    restoreconNeeded|=SELinuxMMAC.isRestoreconNeeded(deDir);
    final File[] files=FileUtils.listFilesOrEmpty(deDir);
    for (    File file : files) {
      final String packageName=file.getName();
      try {
        assertPackageKnownAndInstalled(volumeUuid,packageName,userId);
      }
 catch (      PackageManagerException e) {
        logCriticalInfo(Log.WARN,"Destroying " + file + " due to: "+ e);
synchronized (mInstallLock) {
          destroyAppDataLI(volumeUuid,packageName,userId,Installer.FLAG_DE_STORAGE);
        }
      }
    }
  }
  final List<PackageSetting> packages;
synchronized (mPackages) {
    packages=mSettings.getVolumePackagesLPr(volumeUuid);
  }
  int preparedCount=0;
  for (  PackageSetting ps : packages) {
    final String packageName=ps.name;
    if (ps.pkg == null) {
      Slog.w(TAG,"Odd, missing scanned package " + packageName);
      continue;
    }
    if (ps.getInstalled(userId)) {
      prepareAppData(volumeUuid,userId,flags,ps.pkg,restoreconNeeded);
      preparedCount++;
    }
  }
  if (restoreconNeeded) {
    if ((flags & Installer.FLAG_CE_STORAGE) != 0) {
      SELinuxMMAC.setRestoreconDone(ceDir);
    }
    if ((flags & Installer.FLAG_DE_STORAGE) != 0) {
      SELinuxMMAC.setRestoreconDone(deDir);
    }
  }
  Slog.v(TAG,"reconcileAppsData finished " + preparedCount + " packages; restoreconNeeded was "+ restoreconNeeded);
}
