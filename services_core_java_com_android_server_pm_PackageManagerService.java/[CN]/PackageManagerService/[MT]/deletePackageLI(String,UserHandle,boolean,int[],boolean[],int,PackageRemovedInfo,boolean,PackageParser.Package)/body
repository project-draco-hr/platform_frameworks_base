{
  if (packageName == null) {
    Slog.w(TAG,"Attempt to delete null packageName.");
    return false;
  }
  if (DEBUG_REMOVE)   Slog.d(TAG,"deletePackageLI: " + packageName + " user "+ user);
  PackageSetting ps;
  int removeUser=-1;
synchronized (mPackages) {
    ps=mSettings.mPackages.get(packageName);
    if (ps == null) {
      Slog.w(TAG,"Package named '" + packageName + "' doesn't exist.");
      return false;
    }
    if (ps.pkg.parentPackage != null && (!isSystemApp(ps) || (flags & PackageManager.DELETE_SYSTEM_APP) != 0)) {
      if (DEBUG_REMOVE) {
        Slog.d(TAG,"Uninstalled child package:" + packageName + " for user:"+ ((user == null) ? UserHandle.USER_ALL : user));
      }
      if (!clearPackageStateForUser(ps,removeUser,outInfo)) {
        return false;
      }
      markPackageUninstalledForUserLPw(ps,user);
      scheduleWritePackageRestrictionsLocked(user);
      return true;
    }
  }
  if (((!isSystemApp(ps) || (flags & PackageManager.DELETE_SYSTEM_APP) != 0) && user != null && user.getIdentifier() != UserHandle.USER_ALL)) {
    markPackageUninstalledForUserLPw(ps,user);
    if (!isSystemApp(ps)) {
      boolean keepUninstalledPackage=shouldKeepUninstalledPackageLPr(packageName);
      if (ps.isAnyInstalled(sUserManager.getUserIds()) || keepUninstalledPackage) {
        if (DEBUG_REMOVE)         Slog.d(TAG,"Still installed by other users");
        if (!clearPackageStateForUser(ps,removeUser,outInfo)) {
          return false;
        }
        scheduleWritePackageRestrictionsLocked(user);
        return true;
      }
 else {
        if (DEBUG_REMOVE)         Slog.d(TAG,"Not installed by other users, full delete");
        ps.setInstalled(true,user.getIdentifier());
      }
    }
 else {
      if (DEBUG_REMOVE)       Slog.d(TAG,"Deleting system app");
      if (!clearPackageStateForUser(ps,removeUser,outInfo)) {
        return false;
      }
      scheduleWritePackageRestrictionsLocked(user);
      return true;
    }
  }
  boolean ret=false;
  if (isSystemApp(ps)) {
    if (DEBUG_REMOVE)     Slog.d(TAG,"Removing system package: " + ps.name);
    ret=deleteSystemPackageLI(ps.pkg,ps,allUserHandles,perUserInstalled,flags,outInfo,writeSettings,replacingPackage);
  }
 else {
    if (DEBUG_REMOVE)     Slog.d(TAG,"Removing non-system package: " + ps.name);
    killApplication(packageName,ps.appId,"uninstall pkg");
    ret=deleteInstalledPackageLI(ps.pkg,deleteCodeAndResources,flags,allUserHandles,perUserInstalled,outInfo,writeSettings,replacingPackage);
  }
  return ret;
}
