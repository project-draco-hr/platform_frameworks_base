{
  mContext.enforceCallingOrSelfPermission(android.Manifest.permission.INSTALL_PACKAGES,null);
  PackageSetting pkgSetting;
  final int uid=Binder.getCallingUid();
  enforceCrossUserPermission(uid,userId,true,true,"installExistingPackage for user " + userId);
  if (isUserRestricted(userId,UserManager.DISALLOW_INSTALL_APPS)) {
    return PackageManager.INSTALL_FAILED_USER_RESTRICTED;
  }
  long callingId=Binder.clearCallingIdentity();
  try {
    boolean installed=false;
synchronized (mPackages) {
      pkgSetting=mSettings.mPackages.get(packageName);
      if (pkgSetting == null) {
        return PackageManager.INSTALL_FAILED_INVALID_URI;
      }
      if (!pkgSetting.getInstalled(userId)) {
        pkgSetting.setInstalled(true,userId);
        pkgSetting.setHidden(false,userId);
        mSettings.writePackageRestrictionsLPr(userId);
        installed=true;
      }
    }
    if (installed) {
synchronized (mInstallLock) {
        final int flags=Installer.FLAG_DE_STORAGE | Installer.FLAG_CE_STORAGE;
        try {
          mInstaller.createAppData(pkgSetting.volumeUuid,packageName,userId,flags,pkgSetting.appId,pkgSetting.pkg.applicationInfo.seinfo);
        }
 catch (        InstallerException e) {
          throw new IllegalStateException(e);
        }
      }
      sendPackageAddedForUser(packageName,pkgSetting,userId);
    }
  }
  finally {
    Binder.restoreCallingIdentity(callingId);
  }
  return PackageManager.INSTALL_SUCCEEDED;
}
