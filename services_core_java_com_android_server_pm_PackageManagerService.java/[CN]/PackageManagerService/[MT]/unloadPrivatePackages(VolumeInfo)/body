{
  final ArrayList<ApplicationInfo> unloaded=new ArrayList<>();
synchronized (mPackages) {
    final List<PackageSetting> packages=mSettings.getVolumePackagesLPr(vol.fsUuid);
    for (    PackageSetting ps : packages) {
      if (ps.pkg == null)       continue;
synchronized (mInstallLock) {
        final ApplicationInfo info=ps.pkg.applicationInfo;
        final PackageRemovedInfo outInfo=new PackageRemovedInfo();
        if (deletePackageLI(ps.name,null,false,null,null,PackageManager.DELETE_KEEP_DATA,outInfo,false)) {
          unloaded.add(info);
        }
 else {
          Slog.w(TAG,"Failed to unload " + ps.codePath);
        }
      }
    }
    mSettings.writeLPr();
  }
  Slog.d(TAG,"Unloaded packages " + unloaded);
  sendResourcesChangedBroadcast(false,false,unloaded,null);
}
