{
  if (!sUserManager.exists(userId))   return null;
  flags=updateFlagsForResolve(flags,userId,intent);
  enforceCrossUserPermission(Binder.getCallingUid(),userId,false,false,"resolve intent");
  List<ResolveInfo> query=queryIntentActivities(intent,resolvedType,flags,userId);
  final ResolveInfo bestChoice=chooseBestActivity(intent,resolvedType,flags,query,userId);
  if (isEphemeralAllowed(intent,query,userId)) {
    final EphemeralResolveInfo ai=getEphemeralResolveInfo(intent,resolvedType,userId);
    if (ai != null) {
      if (DEBUG_EPHEMERAL) {
        Slog.v(TAG,"Returning an EphemeralResolveInfo");
      }
      bestChoice.ephemeralInstaller=mEphemeralInstallerInfo;
      bestChoice.ephemeralResolveInfo=ai;
    }
  }
  return bestChoice;
}
