{
  try {
    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER,"resolveIntent");
    if (!sUserManager.exists(userId))     return null;
    flags=updateFlagsForResolve(flags,userId,intent);
    enforceCrossUserPermission(Binder.getCallingUid(),userId,false,false,"resolve intent");
    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER,"queryIntentActivities");
    final List<ResolveInfo> query=queryIntentActivitiesInternal(intent,resolvedType,flags,userId);
    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);
    final ResolveInfo bestChoice=chooseBestActivity(intent,resolvedType,flags,query,userId);
    if (isEphemeralAllowed(intent,query,userId)) {
      Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER,"resolveEphemeral");
      final EphemeralResolveInfo ai=getEphemeralResolveInfo(intent,resolvedType,userId);
      if (ai != null) {
        if (DEBUG_EPHEMERAL) {
          Slog.v(TAG,"Returning an EphemeralResolveInfo");
        }
        bestChoice.ephemeralInstaller=mEphemeralInstallerInfo;
        bestChoice.ephemeralResolveInfo=ai;
      }
      Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);
    }
    return bestChoice;
  }
  finally {
    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);
  }
}
