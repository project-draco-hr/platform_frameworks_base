{
  if (!sUserManager.exists(userId))   return ParceledListSlice.emptyList();
  flags=updateFlagsForPackage(flags,userId,permissions);
  final boolean listUninstalled=(flags & PackageManager.GET_UNINSTALLED_PACKAGES) != 0;
synchronized (mPackages) {
    ArrayList<PackageInfo> list=new ArrayList<PackageInfo>();
    boolean[] tmpBools=new boolean[permissions.length];
    if (listUninstalled) {
      for (      PackageSetting ps : mSettings.mPackages.values()) {
        addPackageHoldingPermissions(list,ps,permissions,tmpBools,flags,userId);
      }
    }
 else {
      for (      PackageParser.Package pkg : mPackages.values()) {
        PackageSetting ps=(PackageSetting)pkg.mExtras;
        if (ps != null) {
          addPackageHoldingPermissions(list,ps,permissions,tmpBools,flags,userId);
        }
      }
    }
    return new ParceledListSlice<PackageInfo>(list);
  }
}
