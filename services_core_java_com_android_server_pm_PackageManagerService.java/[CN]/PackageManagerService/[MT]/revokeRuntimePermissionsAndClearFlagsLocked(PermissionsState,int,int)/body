{
  boolean needsWrite=false;
  for (  PermissionState state : permissionsState.getRuntimePermissionStates(userId)) {
    BasePermission bp=mSettings.mPermissions.get(state.getName());
    if (bp != null) {
      permissionsState.revokeRuntimePermission(bp,userId);
      permissionsState.updatePermissionFlags(bp,userId,flags,0);
      needsWrite=true;
    }
  }
  mHandler.post(new Runnable(){
    @Override public void run(){
      mDefaultPermissionPolicy.grantDefaultPermissions(userId);
    }
  }
);
  if (needsWrite) {
    mSettings.writeRuntimePermissionsForUserLPr(userId,true);
  }
}
