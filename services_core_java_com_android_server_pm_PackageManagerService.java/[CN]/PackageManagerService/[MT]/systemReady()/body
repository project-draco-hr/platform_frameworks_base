{
  mSystemReady=true;
  boolean compatibilityModeEnabled=android.provider.Settings.Global.getInt(mContext.getContentResolver(),android.provider.Settings.Global.COMPATIBILITY_MODE,1) == 1;
  PackageParser.setCompatibilityModeEnabled(compatibilityModeEnabled);
  if (DEBUG_SETTINGS) {
    Log.d(TAG,"compatibility mode:" + compatibilityModeEnabled);
  }
synchronized (mPackages) {
    ArrayList<PreferredActivity> removed=new ArrayList<PreferredActivity>();
    for (int i=0; i < mSettings.mPreferredActivities.size(); i++) {
      PreferredIntentResolver pir=mSettings.mPreferredActivities.valueAt(i);
      removed.clear();
      for (      PreferredActivity pa : pir.filterSet()) {
        if (mActivities.mActivities.get(pa.mPref.mComponent) == null) {
          removed.add(pa);
        }
      }
      if (removed.size() > 0) {
        for (int r=0; r < removed.size(); r++) {
          PreferredActivity pa=removed.get(r);
          Slog.w(TAG,"Removing dangling preferred activity: " + pa.mPref.mComponent);
          pir.removeFilter(pa);
        }
        mSettings.writePackageRestrictionsLPr(mSettings.mPreferredActivities.keyAt(i));
      }
    }
  }
  sUserManager.systemReady();
  if (mPostSystemReadyMessages != null) {
    for (    Message msg : mPostSystemReadyMessages) {
      msg.sendToTarget();
    }
    mPostSystemReadyMessages=null;
  }
  final StorageManager storage=mContext.getSystemService(StorageManager.class);
  storage.registerListener(mStorageListener);
  mInstallerService.systemReady();
  mPackageDexOptimizer.systemReady();
}
