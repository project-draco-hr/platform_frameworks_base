{
  final ArrayList<ApplicationInfo> finalList=new ArrayList<ApplicationInfo>();
synchronized (mPackages) {
    final Iterator<PackageParser.Package> i=mPackages.values().iterator();
    final int userId=UserHandle.getCallingUserId();
    while (i.hasNext()) {
      final PackageParser.Package p=i.next();
      if (p.applicationInfo == null)       continue;
      final boolean matchesUnaware=((flags & MATCH_DIRECT_BOOT_UNAWARE) != 0) && !p.applicationInfo.isDirectBootAware();
      final boolean matchesAware=((flags & MATCH_DIRECT_BOOT_AWARE) != 0) && p.applicationInfo.isDirectBootAware();
      if ((p.applicationInfo.flags & ApplicationInfo.FLAG_PERSISTENT) != 0 && (!mSafeMode || isSystemApp(p)) && (matchesUnaware || matchesAware)) {
        PackageSetting ps=mSettings.mPackages.get(p.packageName);
        if (ps != null) {
          ApplicationInfo ai=PackageParser.generateApplicationInfo(p,flags,ps.readUserState(userId),userId);
          if (ai != null) {
            finalList.add(ai);
          }
        }
      }
    }
  }
  return finalList;
}
