{
  final boolean DEBUG_CLEAN_APKS=false;
  int[] users=userManager.getUserIds();
  Iterator<PackageSetting> psit=mSettings.mPackages.values().iterator();
  while (psit.hasNext()) {
    PackageSetting ps=psit.next();
    if (ps.pkg == null) {
      continue;
    }
    final String packageName=ps.pkg.packageName;
    if ((ps.pkgFlags & ApplicationInfo.FLAG_SYSTEM) != 0) {
      continue;
    }
    if (DEBUG_CLEAN_APKS) {
      Slog.i(TAG,"Checking package " + packageName);
    }
    boolean keep=shouldKeepUninstalledPackageLPr(packageName);
    if (keep) {
      if (DEBUG_CLEAN_APKS) {
        Slog.i(TAG,"  Keeping package " + packageName + " - requested by DO");
      }
    }
 else {
      for (int i=0; i < users.length; i++) {
        if (users[i] != userHandle && ps.getInstalled(users[i])) {
          keep=true;
          if (DEBUG_CLEAN_APKS) {
            Slog.i(TAG,"  Keeping package " + packageName + " for user "+ users[i]);
          }
          break;
        }
      }
    }
    if (!keep) {
      if (DEBUG_CLEAN_APKS) {
        Slog.i(TAG,"  Removing package " + packageName);
      }
      mHandler.post(new Runnable(){
        public void run(){
          deletePackageX(packageName,userHandle,0);
        }
      }
);
    }
  }
}
