{
  mContext.enforceCallingOrSelfPermission(android.Manifest.permission.MANAGE_USERS,null);
  enforceCrossUserPermission(Binder.getCallingUid(),userId,true,true,"setPackageSuspended for user " + userId);
  if (isPackageDeviceAdmin(packageName,userId)) {
    Slog.w(TAG,"Not suspending/un-suspending package \"" + packageName + "\": has active device admin");
    return false;
  }
  long callingId=Binder.clearCallingIdentity();
  try {
    boolean changed=false;
    boolean success=false;
    int appId=-1;
synchronized (mPackages) {
      final PackageSetting pkgSetting=mSettings.mPackages.get(packageName);
      if (pkgSetting != null) {
        if (pkgSetting.getSuspended(userId) != suspended) {
          pkgSetting.setSuspended(suspended,userId);
          mSettings.writePackageRestrictionsLPr(userId);
          appId=pkgSetting.appId;
          changed=true;
        }
        success=true;
      }
    }
    if (changed) {
      sendPackagesSuspendedForUser(new String[]{packageName},userId,suspended);
      if (suspended) {
        killApplication(packageName,UserHandle.getUid(userId,appId),"suspending package");
      }
    }
    return success;
  }
  finally {
    Binder.restoreCallingIdentity(callingId);
  }
}
