{
  try {
    final File tempDir=createTempPackageDir(mAppInstallDir);
    codeFile=tempDir;
    resourceFile=tempDir;
  }
 catch (  IOException e) {
    Slog.w(TAG,"Failed to create copy file: " + e);
    return PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;
  }
  final IParcelFileDescriptorFactory target=new IParcelFileDescriptorFactory.Stub(){
    @Override public ParcelFileDescriptor open(    String name,    int mode) throws RemoteException {
      if (!FileUtils.isValidExtFilename(name)) {
        throw new IllegalArgumentException("Invalid filename: " + name);
      }
      try {
        final File file=new File(codeFile,name);
        final FileDescriptor fd=Os.open(file.getAbsolutePath(),O_RDWR | O_CREAT,0644);
        Os.chmod(file.getAbsolutePath(),0644);
        return new ParcelFileDescriptor(fd);
      }
 catch (      ErrnoException e) {
        throw new RemoteException("Failed to open: " + e.getMessage());
      }
    }
  }
;
  int ret=imcs.copyPackage(originFile.getAbsolutePath(),target);
  if (ret != PackageManager.INSTALL_SUCCEEDED) {
    Slog.e(TAG,"Failed to copy package");
    return ret;
  }
  String[] abiList=(abiOverride != null) ? new String[]{abiOverride} : Build.SUPPORTED_ABIS;
  NativeLibraryHelper.Handle handle=null;
  try {
    handle=NativeLibraryHelper.Handle.create(codeFile);
    if (Build.SUPPORTED_64_BIT_ABIS.length > 0 && abiOverride == null && NativeLibraryHelper.hasRenderscriptBitcode(handle)) {
      abiList=Build.SUPPORTED_32_BIT_ABIS;
    }
    final int abiIndex=NativeLibraryHelper.findSupportedAbi(handle,abiList);
    if (abiIndex < 0 && abiIndex != PackageManager.NO_NATIVE_LIBRARIES) {
      return abiIndex;
    }
 else     if (abiIndex >= 0) {
      final File baseLibFile=new File(codeFile,LIB_DIR_NAME);
      baseLibFile.mkdir();
      Os.chmod(baseLibFile.getAbsolutePath(),0755);
      final String abi=Build.SUPPORTED_ABIS[abiIndex];
      final String instructionSet=VMRuntime.getInstructionSet(abi);
      nativeLibraryFile=new File(baseLibFile,instructionSet);
      nativeLibraryFile.mkdir();
      Os.chmod(nativeLibraryFile.getAbsolutePath(),0755);
      copyNativeLibrariesForInternalApp(handle,nativeLibraryFile,abiList);
    }
  }
 catch (  IOException|ErrnoException e) {
    Slog.e(TAG,"Copying native libraries failed",e);
    ret=PackageManager.INSTALL_FAILED_INTERNAL_ERROR;
  }
 finally {
    IoUtils.closeQuietly(handle);
  }
  return ret;
}
