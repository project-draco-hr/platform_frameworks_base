{
  if (status != PackageManager.INSTALL_SUCCEEDED) {
    cleanUp();
    return false;
  }
 else {
    final File beforeCodeFile=codeFile;
    final File afterCodeFile=new File(mAppInstallDir,getNextCodePath(oldCodePath,pkg.packageName,null));
    Slog.d(TAG,"Renaming " + beforeCodeFile + " to "+ afterCodeFile);
    if (!beforeCodeFile.renameTo(afterCodeFile)) {
      return false;
    }
    if (!SELinux.restoreconRecursive(afterCodeFile)) {
      return false;
    }
    codeFile=afterCodeFile;
    resourceFile=afterCodeFile;
    pkg.codePath=afterCodeFile.getAbsolutePath();
    pkg.baseCodePath=FileUtils.rewriteAfterRename(beforeCodeFile,afterCodeFile,pkg.baseCodePath);
    pkg.splitCodePaths=FileUtils.rewriteAfterRename(beforeCodeFile,afterCodeFile,pkg.splitCodePaths);
    pkg.applicationInfo.setCodePath(pkg.codePath);
    pkg.applicationInfo.setBaseCodePath(pkg.baseCodePath);
    pkg.applicationInfo.setSplitCodePaths(pkg.splitCodePaths);
    pkg.applicationInfo.setResourcePath(pkg.codePath);
    pkg.applicationInfo.setBaseResourcePath(pkg.baseCodePath);
    pkg.applicationInfo.setSplitResourcePaths(pkg.splitCodePaths);
    return true;
  }
}
