{
  if (status != PackageManager.INSTALL_SUCCEEDED) {
    cleanUp();
    return false;
  }
 else {
    final File targetDir=codeFile.getParentFile();
    final File beforeCodeFile=codeFile;
    final File afterCodeFile=getNextCodePath(targetDir,pkg.packageName);
    Slog.d(TAG,"Renaming " + beforeCodeFile + " to "+ afterCodeFile);
    try {
      Os.rename(beforeCodeFile.getAbsolutePath(),afterCodeFile.getAbsolutePath());
    }
 catch (    ErrnoException e) {
      Slog.d(TAG,"Failed to rename",e);
      return false;
    }
    if (!SELinux.restoreconRecursive(afterCodeFile)) {
      Slog.d(TAG,"Failed to restorecon");
      return false;
    }
    codeFile=afterCodeFile;
    resourceFile=afterCodeFile;
    pkg.codePath=afterCodeFile.getAbsolutePath();
    pkg.baseCodePath=FileUtils.rewriteAfterRename(beforeCodeFile,afterCodeFile,pkg.baseCodePath);
    pkg.splitCodePaths=FileUtils.rewriteAfterRename(beforeCodeFile,afterCodeFile,pkg.splitCodePaths);
    pkg.applicationInfo.setCodePath(pkg.codePath);
    pkg.applicationInfo.setBaseCodePath(pkg.baseCodePath);
    pkg.applicationInfo.setSplitCodePaths(pkg.splitCodePaths);
    pkg.applicationInfo.setResourcePath(pkg.codePath);
    pkg.applicationInfo.setBaseResourcePath(pkg.baseCodePath);
    pkg.applicationInfo.setSplitResourcePaths(pkg.splitCodePaths);
    return true;
  }
}
