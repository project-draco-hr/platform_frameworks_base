{
synchronized (mPackages) {
synchronized (mFileLock) {
      AtomicFile file=getFile();
      FileOutputStream f=null;
      try {
        f=file.startWrite();
        BufferedOutputStream out=new BufferedOutputStream(f);
        FileUtils.setPermissions(file.getBaseFile().getPath(),0640,SYSTEM_UID,PACKAGE_INFO_GID);
        StringBuilder sb=new StringBuilder();
        for (        PackageParser.Package pkg : mPackages.values()) {
          if (pkg.mLastPackageUsageTimeInMills == 0) {
            continue;
          }
          sb.setLength(0);
          sb.append(pkg.packageName);
          sb.append(' ');
          sb.append((long)pkg.mLastPackageUsageTimeInMills);
          sb.append('\n');
          out.write(sb.toString().getBytes(StandardCharsets.US_ASCII));
        }
        out.flush();
        file.finishWrite(f);
      }
 catch (      IOException e) {
        if (f != null) {
          file.failWrite(f);
        }
        Log.e(TAG,"Failed to write package usage times",e);
      }
    }
  }
  mLastWritten.set(SystemClock.elapsedRealtime());
}
