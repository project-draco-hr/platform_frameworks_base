{
  String newCacheId=getNextCodePath(oldCodePath,pkg.packageName,"/" + RES_FILE_NAME);
  String newMountPath=null;
  if (PackageHelper.isContainerMounted(cid)) {
    if (!PackageHelper.unMountSdDir(cid)) {
      Slog.i(TAG,"Failed to unmount " + cid + " before renaming");
      return false;
    }
  }
  if (!PackageHelper.renameSdDir(cid,newCacheId)) {
    Slog.e(TAG,"Failed to rename " + cid + " to "+ newCacheId+ " which might be stale. Will try to clean up.");
    if (!PackageHelper.destroySdDir(newCacheId)) {
      Slog.e(TAG,"Very strange. Cannot clean up stale container " + newCacheId);
      return false;
    }
    if (!PackageHelper.renameSdDir(cid,newCacheId)) {
      Slog.e(TAG,"Failed to rename " + cid + " to "+ newCacheId+ " inspite of cleaning it up.");
      return false;
    }
  }
  if (!PackageHelper.isContainerMounted(newCacheId)) {
    Slog.w(TAG,"Mounting container " + newCacheId);
    newMountPath=PackageHelper.mountSdDir(newCacheId,getEncryptKey(),Process.SYSTEM_UID);
  }
 else {
    newMountPath=PackageHelper.getSdDir(newCacheId);
  }
  if (newMountPath == null) {
    Slog.w(TAG,"Failed to get cache path for  " + newCacheId);
    return false;
  }
  Log.i(TAG,"Succesfully renamed " + cid + " to "+ newCacheId+ " at new path: "+ newMountPath);
  cid=newCacheId;
  final File beforeCodeFile=new File(packagePath);
  setMountPath(newMountPath);
  final File afterCodeFile=new File(packagePath);
  pkg.codePath=afterCodeFile.getAbsolutePath();
  pkg.baseCodePath=FileUtils.rewriteAfterRename(beforeCodeFile,afterCodeFile,pkg.baseCodePath);
  pkg.splitCodePaths=FileUtils.rewriteAfterRename(beforeCodeFile,afterCodeFile,pkg.splitCodePaths);
  pkg.applicationInfo.setCodePath(pkg.codePath);
  pkg.applicationInfo.setBaseCodePath(pkg.baseCodePath);
  pkg.applicationInfo.setSplitCodePaths(pkg.splitCodePaths);
  pkg.applicationInfo.setResourcePath(pkg.codePath);
  pkg.applicationInfo.setBaseResourcePath(pkg.baseCodePath);
  pkg.applicationInfo.setSplitResourcePaths(pkg.splitCodePaths);
  return true;
}
