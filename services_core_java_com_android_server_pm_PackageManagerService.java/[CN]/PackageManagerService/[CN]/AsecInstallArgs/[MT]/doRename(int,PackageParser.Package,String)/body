{
  String newCacheId=getNextCodePath(oldCodePath,pkg.packageName,"/" + RES_FILE_NAME);
  String newCachePath=null;
  if (PackageHelper.isContainerMounted(cid)) {
    if (!PackageHelper.unMountSdDir(cid)) {
      Slog.i(TAG,"Failed to unmount " + cid + " before renaming");
      return false;
    }
  }
  if (!PackageHelper.renameSdDir(cid,newCacheId)) {
    Slog.e(TAG,"Failed to rename " + cid + " to "+ newCacheId+ " which might be stale. Will try to clean up.");
    if (!PackageHelper.destroySdDir(newCacheId)) {
      Slog.e(TAG,"Very strange. Cannot clean up stale container " + newCacheId);
      return false;
    }
    if (!PackageHelper.renameSdDir(cid,newCacheId)) {
      Slog.e(TAG,"Failed to rename " + cid + " to "+ newCacheId+ " inspite of cleaning it up.");
      return false;
    }
  }
  if (!PackageHelper.isContainerMounted(newCacheId)) {
    Slog.w(TAG,"Mounting container " + newCacheId);
    newCachePath=PackageHelper.mountSdDir(newCacheId,getEncryptKey(),Process.SYSTEM_UID);
  }
 else {
    newCachePath=PackageHelper.getSdDir(newCacheId);
  }
  if (newCachePath == null) {
    Slog.w(TAG,"Failed to get cache path for  " + newCacheId);
    return false;
  }
  Log.i(TAG,"Succesfully renamed " + cid + " to "+ newCacheId+ " at new path: "+ newCachePath);
  cid=newCacheId;
  setCachePath(newCachePath);
  pkg.codePath=getCodePath();
  pkg.baseCodePath=getCodePath();
  pkg.splitCodePaths=null;
  pkg.applicationInfo.setCodePath(getCodePath());
  pkg.applicationInfo.setBaseCodePath(getCodePath());
  pkg.applicationInfo.setSplitCodePaths(null);
  pkg.applicationInfo.setResourcePath(getResourcePath());
  pkg.applicationInfo.setBaseResourcePath(getResourcePath());
  pkg.applicationInfo.setSplitResourcePaths(null);
  pkg.applicationInfo.legacyNativeLibraryDir=legacyNativeLibraryDir;
  return true;
}
