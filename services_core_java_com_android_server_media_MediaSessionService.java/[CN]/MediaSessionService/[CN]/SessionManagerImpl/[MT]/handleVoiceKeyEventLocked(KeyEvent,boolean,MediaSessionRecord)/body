{
  if (session != null && session.hasFlag(MediaSession.FLAG_EXCLUSIVE_GLOBAL_PRIORITY)) {
    dispatchMediaKeyEventLocked(keyEvent,needWakeLock,session);
    return;
  }
  int action=keyEvent.getAction();
  boolean isLongPress=(keyEvent.getFlags() & KeyEvent.FLAG_LONG_PRESS) != 0;
  if (action == KeyEvent.ACTION_DOWN) {
    if (keyEvent.getRepeatCount() == 0) {
      mVoiceButtonDown=true;
      mVoiceButtonHandled=false;
    }
 else     if (mVoiceButtonDown && !mVoiceButtonHandled && isLongPress) {
      mVoiceButtonHandled=true;
      startVoiceInput(needWakeLock);
    }
  }
 else   if (action == KeyEvent.ACTION_UP) {
    if (mVoiceButtonDown) {
      mVoiceButtonDown=false;
      if (!mVoiceButtonHandled && !keyEvent.isCanceled()) {
        KeyEvent downEvent=KeyEvent.changeAction(keyEvent,KeyEvent.ACTION_DOWN);
        dispatchMediaKeyEventLocked(downEvent,needWakeLock,session);
        dispatchMediaKeyEventLocked(keyEvent,needWakeLock,session);
      }
    }
  }
}
