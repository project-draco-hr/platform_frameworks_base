{
  if (session != null) {
    if (DEBUG) {
      Log.d(TAG,"Sending media key to " + session.toString());
    }
    if (needWakeLock) {
      mKeyEventReceiver.aquireWakeLockLocked();
    }
    session.sendMediaButton(keyEvent,needWakeLock ? mKeyEventReceiver.mLastTimeoutId : -1,mKeyEventReceiver);
  }
 else {
    int userId=ActivityManager.getCurrentUser();
    UserRecord user=mUserRecords.get(userId);
    if (user.mLastMediaButtonReceiver != null) {
      if (DEBUG) {
        Log.d(TAG,"Sending media key to last known PendingIntent");
      }
      if (needWakeLock) {
        mKeyEventReceiver.aquireWakeLockLocked();
      }
      Intent mediaButtonIntent=new Intent(Intent.ACTION_MEDIA_BUTTON);
      mediaButtonIntent.putExtra(Intent.EXTRA_KEY_EVENT,keyEvent);
      try {
        user.mLastMediaButtonReceiver.send(getContext(),needWakeLock ? mKeyEventReceiver.mLastTimeoutId : -1,mediaButtonIntent,mKeyEventReceiver,null);
      }
 catch (      CanceledException e) {
        Log.i(TAG,"Error sending key event to media button receiver " + user.mLastMediaButtonReceiver,e);
      }
    }
 else {
      if (DEBUG) {
        Log.d(TAG,"Sending media key ordered broadcast");
      }
      if (needWakeLock) {
        mMediaEventWakeLock.acquire();
      }
      Intent keyIntent=new Intent(Intent.ACTION_MEDIA_BUTTON,null);
      keyIntent.putExtra(Intent.EXTRA_KEY_EVENT,keyEvent);
      if (needWakeLock) {
        keyIntent.putExtra(EXTRA_WAKELOCK_ACQUIRED,WAKELOCK_RELEASE_ON_FINISHED);
      }
      getContext().sendOrderedBroadcastAsUser(keyIntent,UserHandle.ALL,null,mKeyEventDone,mHandler,Activity.RESULT_OK,null,null);
    }
  }
}
