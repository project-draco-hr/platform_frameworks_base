{
  if (keyEvent == null || !KeyEvent.isMediaKey(keyEvent.getKeyCode())) {
    Log.w(TAG,"Attempted to dispatch null or non-media key event.");
    return;
  }
  final int pid=Binder.getCallingPid();
  final int uid=Binder.getCallingUid();
  final long token=Binder.clearCallingIdentity();
  try {
synchronized (mLock) {
      MediaSessionRecord mbSession=mPriorityStack.getDefaultMediaButtonSession(mCurrentUserId);
      if (mbSession != null) {
        if (DEBUG) {
          Log.d(TAG,"Sending media key to " + mbSession.getSessionInfo());
        }
        if (needWakeLock) {
          mKeyEventReceiver.aquireWakeLockLocked();
        }
        mbSession.sendMediaButton(keyEvent,needWakeLock ? mKeyEventReceiver.mLastTimeoutId : -1,mKeyEventReceiver);
      }
 else {
        if (needWakeLock) {
          mMediaEventWakeLock.acquire();
        }
        if (DEBUG) {
          Log.d(TAG,"Sending media key ordered broadcast");
        }
        Intent keyIntent=new Intent(Intent.ACTION_MEDIA_BUTTON,null);
        keyIntent.putExtra(Intent.EXTRA_KEY_EVENT,keyEvent);
        if (needWakeLock) {
          keyIntent.putExtra(EXTRA_WAKELOCK_ACQUIRED,WAKELOCK_RELEASE_ON_FINISHED);
        }
        getContext().sendOrderedBroadcastAsUser(keyIntent,UserHandle.ALL,null,mKeyEventDone,mHandler,Activity.RESULT_OK,null,null);
      }
    }
  }
  finally {
    Binder.restoreCallingIdentity(token);
  }
}
