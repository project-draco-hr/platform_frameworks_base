{
  byte[] headerData=SmsHeader.toByteArray(uData.userDataHeader);
  if (uData.msgEncodingSet) {
    if (uData.msgEncoding == UserData.ENCODING_GSM_7BIT_ALPHABET) {
      encode7bitEms(uData,headerData,true);
    }
 else     if (uData.msgEncoding == UserData.ENCODING_UNICODE_16) {
      encode16bitEms(uData,headerData);
    }
 else {
      throw new CodingException("unsupported EMS user data encoding (" + uData.msgEncoding + ")");
    }
  }
 else {
    try {
      encode7bitEms(uData,headerData,false);
    }
 catch (    CodingException ex) {
      encode16bitEms(uData,headerData);
    }
  }
}
