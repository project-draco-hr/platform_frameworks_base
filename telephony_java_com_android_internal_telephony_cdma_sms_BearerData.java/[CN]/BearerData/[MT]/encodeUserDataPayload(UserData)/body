{
  if (uData.msgEncodingSet) {
    if (uData.msgEncoding == UserData.ENCODING_OCTET) {
      if (uData.payload == null) {
        Log.e(LOG_TAG,"user data with octet encoding but null payload");
        uData.payload=new byte[0];
      }
    }
 else {
      if (uData.payloadStr == null) {
        Log.e(LOG_TAG,"non-octet user data with null payloadStr");
        uData.payloadStr="";
      }
      if (uData.msgEncoding == UserData.ENCODING_GSM_7BIT_ALPHABET) {
        uData.payload=encode7bitGsm(uData.payloadStr);
      }
 else       if (uData.msgEncoding == UserData.ENCODING_7BIT_ASCII) {
        uData.payload=encode7bitAscii(uData.payloadStr);
      }
 else       if (uData.msgEncoding == UserData.ENCODING_UNICODE_16) {
        uData.payload=encodeUtf16(uData.payloadStr);
      }
 else {
        throw new CodingException("unsupported user data encoding (" + uData.msgEncoding + ")");
      }
      uData.numFields=uData.payloadStr.length();
    }
  }
 else {
    if (uData.payloadStr == null) {
      Log.e(LOG_TAG,"user data with null payloadStr");
      uData.payloadStr="";
    }
    try {
      uData.payload=encode7bitAscii(uData.payloadStr);
      uData.msgEncoding=UserData.ENCODING_7BIT_ASCII;
    }
 catch (    CodingException ex) {
      uData.payload=encodeUtf16(uData.payloadStr);
      uData.msgEncoding=UserData.ENCODING_UNICODE_16;
    }
    uData.msgEncodingSet=true;
    uData.numFields=uData.payloadStr.length();
  }
  if (uData.payload.length > SmsMessage.MAX_USER_DATA_BYTES) {
    throw new CodingException("encoded user data too large (" + uData.payload.length + " > "+ SmsMessage.MAX_USER_DATA_BYTES+ " bytes)");
  }
}
