{
  if ((uData.payloadStr == null) && (uData.msgEncoding != UserData.ENCODING_OCTET)) {
    Log.e(LOG_TAG,"user data with null payloadStr");
    uData.payloadStr="";
  }
  if (uData.userDataHeader != null) {
    encodeEmsUserDataPayload(uData);
    return;
  }
  if (uData.msgEncodingSet) {
    if (uData.msgEncoding == UserData.ENCODING_OCTET) {
      if (uData.payload == null) {
        Log.e(LOG_TAG,"user data with octet encoding but null payload");
        uData.payload=new byte[0];
        uData.numFields=0;
      }
 else {
        uData.payload=uData.payload;
        uData.numFields=uData.payload.length;
      }
    }
 else {
      if (uData.payloadStr == null) {
        Log.e(LOG_TAG,"non-octet user data with null payloadStr");
        uData.payloadStr="";
      }
      if (uData.msgEncoding == UserData.ENCODING_GSM_7BIT_ALPHABET) {
        Gsm7bitCodingResult gcr=encode7bitGsm(uData.payloadStr,0,true);
        uData.payload=gcr.data;
        uData.numFields=gcr.septets;
      }
 else       if (uData.msgEncoding == UserData.ENCODING_7BIT_ASCII) {
        uData.payload=encode7bitAscii(uData.payloadStr,true);
        uData.numFields=uData.payloadStr.length();
      }
 else       if (uData.msgEncoding == UserData.ENCODING_UNICODE_16) {
        uData.payload=encodeUtf16(uData.payloadStr);
        uData.numFields=uData.payloadStr.length();
      }
 else {
        throw new CodingException("unsupported user data encoding (" + uData.msgEncoding + ")");
      }
    }
  }
 else {
    try {
      uData.payload=encode7bitAscii(uData.payloadStr,false);
      uData.msgEncoding=UserData.ENCODING_7BIT_ASCII;
    }
 catch (    CodingException ex) {
      uData.payload=encodeUtf16(uData.payloadStr);
      uData.msgEncoding=UserData.ENCODING_UNICODE_16;
    }
    uData.numFields=uData.payloadStr.length();
    uData.msgEncodingSet=true;
  }
}
