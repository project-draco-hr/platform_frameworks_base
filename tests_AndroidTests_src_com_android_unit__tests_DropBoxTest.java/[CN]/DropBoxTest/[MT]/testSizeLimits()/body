{
  File dir=getEmptyDir("testSizeLimits");
  int blockSize=new StatFs(dir.getPath()).getBlockSize();
  int kb=blockSize * 10 / 1024;
  Intent override=new Intent(Settings.Gservices.OVERRIDE_ACTION);
  override.putExtra(Settings.Gservices.DROPBOX_QUOTA_KB,Integer.toString(kb));
  waitForBroadcast(override);
  final int overhead=64;
  long before=System.currentTimeMillis();
  DropBoxService dropbox=new DropBoxService(getContext(),dir);
  addRandomEntry(dropbox,"DropBoxTest0",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest0",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize * 2 - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize * 20 - overhead);
  addRandomEntry(dropbox,"DropBoxTest2",blockSize * 4 - overhead);
  addRandomEntry(dropbox,"DropBoxTest2",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest2",blockSize - overhead);
  DropBoxEntry e0=dropbox.getNextEntry(null,before);
  DropBoxEntry e1=dropbox.getNextEntry(null,e0.getTimeMillis());
  DropBoxEntry e2=dropbox.getNextEntry(null,e1.getTimeMillis());
  DropBoxEntry e3=dropbox.getNextEntry(null,e2.getTimeMillis());
  DropBoxEntry e4=dropbox.getNextEntry(null,e3.getTimeMillis());
  DropBoxEntry e5=dropbox.getNextEntry(null,e4.getTimeMillis());
  DropBoxEntry e6=dropbox.getNextEntry(null,e5.getTimeMillis());
  DropBoxEntry e7=dropbox.getNextEntry(null,e6.getTimeMillis());
  DropBoxEntry e8=dropbox.getNextEntry(null,e7.getTimeMillis());
  DropBoxEntry e9=dropbox.getNextEntry(null,e8.getTimeMillis());
  assertTrue(null == dropbox.getNextEntry(null,e9.getTimeMillis()));
  assertEquals("DropBoxTest0",e0.getTag());
  assertEquals("DropBoxTest0",e1.getTag());
  assertEquals(blockSize - overhead,getEntrySize(e0));
  assertEquals(blockSize - overhead,getEntrySize(e1));
  assertEquals("DropBoxTest1",e2.getTag());
  assertEquals("DropBoxTest1",e3.getTag());
  assertEquals("DropBoxTest1",e4.getTag());
  assertEquals("DropBoxTest1",e5.getTag());
  assertEquals("DropBoxTest1",e6.getTag());
  assertEquals(-1,getEntrySize(e2));
  assertEquals(blockSize - overhead,getEntrySize(e3));
  assertEquals(blockSize * 2 - overhead,getEntrySize(e4));
  assertEquals(blockSize - overhead,getEntrySize(e5));
  assertEquals(-1,getEntrySize(e6));
  assertEquals("DropBoxTest2",e7.getTag());
  assertEquals("DropBoxTest2",e8.getTag());
  assertEquals("DropBoxTest2",e9.getTag());
  assertEquals(-1,getEntrySize(e7));
  assertEquals(blockSize - overhead,getEntrySize(e8));
  assertEquals(blockSize - overhead,getEntrySize(e9));
  e0.close();
  e1.close();
  e2.close();
  e3.close();
  e4.close();
  e5.close();
  e6.close();
  e7.close();
  e8.close();
  e9.close();
  DropBoxEntry t0=dropbox.getNextEntry("DropBoxTest1",before);
  DropBoxEntry t1=dropbox.getNextEntry("DropBoxTest1",t0.getTimeMillis());
  DropBoxEntry t2=dropbox.getNextEntry("DropBoxTest1",t1.getTimeMillis());
  assertTrue(null == dropbox.getNextEntry("DropBoxTest1",t2.getTimeMillis()));
  assertEquals("DropBoxTest1",t0.getTag());
  assertEquals("DropBoxTest1",t1.getTag());
  assertEquals("DropBoxTest1",t2.getTag());
  assertEquals(blockSize - overhead,getEntrySize(t0));
  assertEquals(blockSize * 2 - overhead,getEntrySize(t1));
  assertEquals(blockSize - overhead,getEntrySize(t2));
  t0.close();
  t1.close();
  t2.close();
  dropbox.stop();
}
