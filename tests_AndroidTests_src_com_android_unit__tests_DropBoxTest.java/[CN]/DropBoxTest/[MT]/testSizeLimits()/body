{
  File dir=getEmptyDir("testSizeLimits");
  int blockSize=new StatFs(dir.getPath()).getBlockSize();
  int kb=blockSize * 10 / 1024;
  Intent override=new Intent(Settings.Gservices.OVERRIDE_ACTION);
  override.putExtra(Settings.Gservices.DROPBOX_QUOTA_KB,Integer.toString(kb));
  waitForBroadcast(override);
  final int overhead=64;
  long before=System.currentTimeMillis();
  DropBoxService dropbox=new DropBoxService(getContext(),dir);
  addRandomEntry(dropbox,"DropBoxTest0",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest0",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize * 2 - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest1",blockSize * 20 - overhead);
  addRandomEntry(dropbox,"DropBoxTest2",blockSize * 4 - overhead);
  addRandomEntry(dropbox,"DropBoxTest2",blockSize - overhead);
  addRandomEntry(dropbox,"DropBoxTest2",blockSize - overhead);
  DropBoxEntry e0=getNextTestEntry(dropbox,before);
  DropBoxEntry e1=getNextTestEntry(dropbox,e0.getTimeMillis());
  DropBoxEntry e2=getNextTestEntry(dropbox,e1.getTimeMillis());
  DropBoxEntry e3=getNextTestEntry(dropbox,e2.getTimeMillis());
  DropBoxEntry e4=getNextTestEntry(dropbox,e3.getTimeMillis());
  DropBoxEntry e5=getNextTestEntry(dropbox,e4.getTimeMillis());
  DropBoxEntry e6=getNextTestEntry(dropbox,e5.getTimeMillis());
  DropBoxEntry e7=getNextTestEntry(dropbox,e6.getTimeMillis());
  DropBoxEntry e8=getNextTestEntry(dropbox,e7.getTimeMillis());
  DropBoxEntry e9=getNextTestEntry(dropbox,e8.getTimeMillis());
  assertTrue(null == getNextTestEntry(dropbox,e9.getTimeMillis()));
  assertEquals("DropBoxTest0",e0.getTag());
  assertEquals("DropBoxTest0",e1.getTag());
  assertEquals(blockSize - overhead,getEntrySize(e0));
  assertEquals(blockSize - overhead,getEntrySize(e1));
  assertEquals("DropBoxTest1",e2.getTag());
  assertEquals("DropBoxTest1",e3.getTag());
  assertEquals("DropBoxTest1",e4.getTag());
  assertEquals("DropBoxTest1",e5.getTag());
  assertEquals("DropBoxTest1",e6.getTag());
  assertEquals(-1,getEntrySize(e2));
  assertEquals(blockSize - overhead,getEntrySize(e3));
  assertEquals(blockSize * 2 - overhead,getEntrySize(e4));
  assertEquals(blockSize - overhead,getEntrySize(e5));
  assertEquals(-1,getEntrySize(e6));
  assertEquals("DropBoxTest2",e7.getTag());
  assertEquals("DropBoxTest2",e8.getTag());
  assertEquals("DropBoxTest2",e9.getTag());
  assertEquals(-1,getEntrySize(e7));
  assertEquals(blockSize - overhead,getEntrySize(e8));
  assertEquals(blockSize - overhead,getEntrySize(e9));
  e0.close();
  e1.close();
  e2.close();
  e3.close();
  e4.close();
  e5.close();
  e6.close();
  e7.close();
  e8.close();
  e9.close();
  dropbox.stop();
}
