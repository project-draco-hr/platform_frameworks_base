{
  int callerUid=UserHandle.getCallingUserId();
  int myUid=UserHandle.myUserId();
  if (DBG) {
    Slog.d(TAG,"listen: E pkg=" + pkgForDebug + " events=0x"+ Integer.toHexString(events)+ " myUid="+ myUid+ " callerUid="+ callerUid);
  }
  if (events != 0) {
    checkListenerPermission(events);
synchronized (mRecords) {
      Record r=null;
      find_and_add: {
        IBinder b=callback.asBinder();
        final int N=mRecords.size();
        for (int i=0; i < N; i++) {
          r=mRecords.get(i);
          if (b == r.binder) {
            break find_and_add;
          }
        }
        r=new Record();
        r.binder=b;
        r.callback=callback;
        r.pkgForDebug=pkgForDebug;
        r.callerUid=callerUid;
        mRecords.add(r);
        if (DBG)         Slog.i(TAG,"listen: add new record=" + r);
      }
      int send=events & (events ^ r.events);
      r.events=events;
      if (notifyNow) {
        if ((events & PhoneStateListener.LISTEN_SERVICE_STATE) != 0) {
          try {
            r.callback.onServiceStateChanged(new ServiceState(mServiceState));
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_SIGNAL_STRENGTH) != 0) {
          try {
            int gsmSignalStrength=mSignalStrength.getGsmSignalStrength();
            r.callback.onSignalStrengthChanged((gsmSignalStrength == 99 ? -1 : gsmSignalStrength));
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_MESSAGE_WAITING_INDICATOR) != 0) {
          try {
            r.callback.onMessageWaitingIndicatorChanged(mMessageWaiting);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_CALL_FORWARDING_INDICATOR) != 0) {
          try {
            r.callback.onCallForwardingIndicatorChanged(mCallForwarding);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if (validateEventsAndUserLocked(r,PhoneStateListener.LISTEN_CELL_LOCATION)) {
          try {
            if (DBG_LOC)             Slog.d(TAG,"listen: mCellLocation=" + mCellLocation);
            r.callback.onCellLocationChanged(new Bundle(mCellLocation));
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_CALL_STATE) != 0) {
          try {
            r.callback.onCallStateChanged(mCallState,mCallIncomingNumber);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_DATA_CONNECTION_STATE) != 0) {
          try {
            r.callback.onDataConnectionStateChanged(mDataConnectionState,mDataConnectionNetworkType);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_DATA_ACTIVITY) != 0) {
          try {
            r.callback.onDataActivity(mDataActivity);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_SIGNAL_STRENGTHS) != 0) {
          try {
            r.callback.onSignalStrengthsChanged(mSignalStrength);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if ((events & PhoneStateListener.LISTEN_OTASP_CHANGED) != 0) {
          try {
            r.callback.onOtaspChanged(mOtaspMode);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
        if (validateEventsAndUserLocked(r,PhoneStateListener.LISTEN_CELL_INFO)) {
          try {
            if (DBG_LOC)             Slog.d(TAG,"listen: mCellInfo=" + mCellInfo);
            r.callback.onCellInfoChanged(mCellInfo);
          }
 catch (          RemoteException ex) {
            remove(r.binder);
          }
        }
      }
    }
  }
 else {
    remove(callback.asBinder());
  }
}
