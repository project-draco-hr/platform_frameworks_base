{
  SharedPreferencesImpl sp;
  File f=getSharedPrefsFile(name);
synchronized (sSharedPrefs) {
    sp=sSharedPrefs.get(f);
    if (sp != null && !sp.hasFileChanged()) {
      return sp;
    }
  }
  FileInputStream str=null;
  File backup=makeBackupFile(f);
  if (backup.exists()) {
    f.delete();
    backup.renameTo(f);
  }
  if (f.exists() && !f.canRead()) {
    Log.w(TAG,"Attempt to read preferences file " + f + " without permission");
  }
  Map map=null;
  if (f.exists() && f.canRead()) {
    try {
      str=new FileInputStream(f);
      map=XmlUtils.readMapXml(str);
      str.close();
    }
 catch (    org.xmlpull.v1.XmlPullParserException e) {
      Log.w(TAG,"getSharedPreferences",e);
    }
catch (    FileNotFoundException e) {
      Log.w(TAG,"getSharedPreferences",e);
    }
catch (    IOException e) {
      Log.w(TAG,"getSharedPreferences",e);
    }
  }
synchronized (sSharedPrefs) {
    if (sp != null) {
      sp.replace(map);
    }
 else {
      sp=sSharedPrefs.get(f);
      if (sp == null) {
        sp=new SharedPreferencesImpl(f,mode,map);
        sSharedPrefs.put(f,sp);
      }
    }
    return sp;
  }
}
