{
  mContext.enforceCallingOrSelfPermission(MANAGE_NETWORK_POLICY,TAG);
  final boolean oldStatus;
  final boolean needFirewallRules;
synchronized (mRulesLock) {
    oldStatus=mRestrictBackgroundWhitelistUids.get(uid);
    if (oldStatus) {
      if (LOGD)       Slog.d(TAG,"uid " + uid + " is already whitelisted");
      return;
    }
    needFirewallRules=isUidValidForWhitelistRules(uid);
    Slog.i(TAG,"adding uid " + uid + " to restrict background whitelist");
    mRestrictBackgroundWhitelistUids.append(uid,true);
    if (mDefaultRestrictBackgroundWhitelistUids.get(uid) && mRestrictBackgroundWhitelistRevokedUids.get(uid)) {
      if (LOGD)       Slog.d(TAG,"Removing uid " + uid + " from revoked restrict background whitelist");
      mRestrictBackgroundWhitelistRevokedUids.delete(uid);
    }
    if (needFirewallRules) {
      updateRulesForDataUsageRestrictionsLocked(uid);
    }
    writePolicyLocked();
  }
  int changed=(mRestrictBackground && !oldStatus && needFirewallRules) ? 1 : 0;
  mHandler.obtainMessage(MSG_RESTRICT_BACKGROUND_WHITELIST_CHANGED,uid,changed,Boolean.TRUE).sendToTarget();
}
