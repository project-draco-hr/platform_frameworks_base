{
  mContext.enforceCallingOrSelfPermission(MANAGE_NETWORK_POLICY,TAG);
  if (!isUidValidForRules(uid))   return;
  final boolean changed;
synchronized (mRulesLock) {
    final boolean oldStatus=mRestrictBackgroundWhitelistUids.get(uid);
    if (oldStatus) {
      if (LOGD)       Slog.d(TAG,"uid " + uid + " is already whitelisted");
      return;
    }
    Slog.i(TAG,"adding uid " + uid + " to restrict background whitelist");
    mRestrictBackgroundWhitelistUids.append(uid,true);
    if (mDefaultRestrictBackgroundWhitelistUids.get(uid) && mRestrictBackgroundWhitelistRevokedUids.get(uid)) {
      if (LOGD)       Slog.d(TAG,"Removing uid " + uid + " from revoked restrict background whitelist");
      mRestrictBackgroundWhitelistRevokedUids.delete(uid);
    }
    changed=mRestrictBackground && !oldStatus;
    if (changed && hasInternetPermissions(uid)) {
      setUidNetworkRules(uid,false);
    }
    writePolicyLocked();
  }
  if (changed) {
    mHandler.obtainMessage(MSG_RESTRICT_BACKGROUND_WHITELIST_CHANGED,uid,0).sendToTarget();
  }
}
