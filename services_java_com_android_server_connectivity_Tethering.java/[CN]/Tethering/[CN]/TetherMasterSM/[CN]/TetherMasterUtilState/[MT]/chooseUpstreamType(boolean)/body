{
  String iface=findActiveUpstreamIface();
  IBinder b=ServiceManager.getService(Context.CONNECTIVITY_SERVICE);
  IConnectivityManager cm=IConnectivityManager.Stub.asInterface(b);
  mConnectionRequested=false;
  mUseHiPri=false;
  Log.d(TAG,"chooseUpstreamType(" + tryCell + "),  dunRequired ="+ mDunRequired+ ", iface="+ iface);
  if (mDunRequired) {
    try {
      NetworkInfo info=cm.getNetworkInfo(ConnectivityManager.TYPE_MOBILE_DUN);
      if (info.isConnected()) {
        Log.d(TAG,"setting dun ifacename =" + iface);
        notifyTetheredOfNewIface(iface);
        turnOnMobileConnection();
      }
    }
 catch (    RemoteException e) {
      Log.e(TAG,"RemoteException calling ConnectivityManager");
      notifyTetheredOfNewIface(null);
    }
    if (tryCell == TRY_TO_SETUP_MOBILE_CONNECTION) {
      turnOnMobileConnection();
    }
  }
 else {
    if (iface == null) {
      if (tryCell == TRY_TO_SETUP_MOBILE_CONNECTION) {
        Log.d(TAG,"turning on hipri");
        mUseHiPri=true;
        turnOnMobileConnection();
      }
    }
 else {
      try {
        Log.d(TAG,"checking if hipri brought us this connection");
        NetworkInfo info=cm.getNetworkInfo(ConnectivityManager.TYPE_MOBILE_HIPRI);
        if (info.isConnected()) {
          Log.d(TAG,"yes - hipri in use");
          mUseHiPri=true;
          turnOnMobileConnection();
        }
      }
 catch (      RemoteException e) {
        Log.e(TAG,"RemoteException calling ConnectivityManager");
      }
      Log.d(TAG,"setting non-dun iface =" + iface);
      notifyTetheredOfNewIface(iface);
    }
  }
  if (iface == null) {
    sendMessageDelayed(CMD_RETRY_UPSTREAM,UPSTREAM_SETTLE_TIME_MS);
  }
}
