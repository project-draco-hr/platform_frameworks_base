{
  final int callingUid=Binder.getCallingUid();
  mPm.enforceCrossUserPermission(callingUid,userId,false,TAG);
  if (mPm.isUserRestricted(UserHandle.getUserId(callingUid),UserManager.DISALLOW_INSTALL_APPS)) {
    throw new SecurityException("User restriction prevents installing");
  }
  if ((callingUid == Process.SHELL_UID) || (callingUid == 0)) {
    params.installFlags|=INSTALL_FROM_ADB;
  }
 else {
    mAppOps.checkPackage(callingUid,installerPackageName);
    params.installFlags&=~INSTALL_FROM_ADB;
    params.installFlags&=~INSTALL_ALL_USERS;
    params.installFlags|=INSTALL_REPLACE_EXISTING;
  }
synchronized (mSessions) {
    final long createdMillis=System.currentTimeMillis();
    final int sessionId=allocateSessionIdLocked();
    final File sessionStageDir=prepareSessionStageDir(sessionId);
    final PackageInstallerSession session=new PackageInstallerSession(mCallback,mPm,sessionId,userId,installerPackageName,callingUid,params,createdMillis,sessionStageDir,mInstallThread.getLooper());
    mSessions.put(sessionId,session);
    writeSessionsAsync();
    return sessionId;
  }
}
