{
  long elapsedRealtime=0;
  expectTime(TEST_START + elapsedRealtime);
  expectDefaultSettings();
  expectNetworkState(buildMobile3gState(IMSI_1));
  expectNetworkStatsSummary(buildEmptyStats(elapsedRealtime));
  replay();
  mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION));
  verifyAndReset();
  performBootstrapPoll(TEST_START,elapsedRealtime);
  elapsedRealtime+=HOUR_IN_MILLIS;
  expectTime(TEST_START + elapsedRealtime);
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats(elapsedRealtime,1).addValues(TEST_IFACE,UID_ALL,TAG_NONE,2048L,16L,512L,4L));
  expectNetworkStatsUidDetail(new NetworkStats(elapsedRealtime,3).addValues(TEST_IFACE,UID_RED,TAG_NONE,1536L,12L,512L,4L).addValues(TEST_IFACE,UID_RED,0xF00D,512L,4L,512L,4L).addValues(TEST_IFACE,UID_BLUE,TAG_NONE,512L,4L,0L,0L));
  mService.incrementOperationCount(UID_RED,TAG_NONE,15);
  mService.incrementOperationCount(UID_RED,0xF00D,10);
  mService.incrementOperationCount(UID_BLUE,TAG_NONE,5);
  replay();
  mServiceContext.sendBroadcast(new Intent(ACTION_NETWORK_STATS_POLL));
  assertNetworkTotal(sTemplateImsi1,2048L,16L,512L,4L,0);
  assertNetworkTotal(sTemplateWifi,0L,0L,0L,0L,0);
  assertUidTotal(sTemplateImsi1,UID_RED,1536L,12L,512L,4L,15);
  assertUidTotal(sTemplateImsi1,UID_BLUE,512L,4L,0L,0L,5);
  verifyAndReset();
  elapsedRealtime+=HOUR_IN_MILLIS;
  expectTime(TEST_START + elapsedRealtime);
  expectDefaultSettings();
  expectNetworkState(buildMobile3gState(IMSI_2));
  expectNetworkStatsSummary(buildEmptyStats(elapsedRealtime));
  expectNetworkStatsUidDetail(buildEmptyStats(elapsedRealtime));
  replay();
  mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION));
  mServiceContext.sendBroadcast(new Intent(ACTION_NETWORK_STATS_POLL));
  verifyAndReset();
  elapsedRealtime+=HOUR_IN_MILLIS;
  expectTime(TEST_START + elapsedRealtime);
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats(elapsedRealtime,1).addValues(TEST_IFACE,UID_ALL,TAG_NONE,128L,1L,1024L,8L));
  expectNetworkStatsUidDetail(new NetworkStats(elapsedRealtime,1).addValues(TEST_IFACE,UID_BLUE,TAG_NONE,128L,1L,1024L,8L));
  mService.incrementOperationCount(UID_BLUE,TAG_NONE,10);
  replay();
  mServiceContext.sendBroadcast(new Intent(ACTION_NETWORK_STATS_POLL));
  assertNetworkTotal(sTemplateImsi1,2048L,16L,512L,4L,0);
  assertUidTotal(sTemplateImsi1,UID_RED,1536L,12L,512L,4L,15);
  assertUidTotal(sTemplateImsi1,UID_BLUE,512L,4L,0L,0L,5);
  assertNetworkTotal(sTemplateImsi2,128L,1L,1024L,8L,0);
  assertNetworkTotal(sTemplateWifi,0L,0L,0L,0L,0);
  assertUidTotal(sTemplateImsi2,UID_BLUE,128L,1L,1024L,8L,10);
  verifyAndReset();
}
