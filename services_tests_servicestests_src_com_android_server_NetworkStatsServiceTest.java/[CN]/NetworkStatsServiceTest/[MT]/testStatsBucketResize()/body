{
  long elapsedRealtime=0;
  NetworkStatsHistory history=null;
  long[] total=null;
  assertStatsFilesExist(false);
  expectTime(TEST_START + elapsedRealtime);
  expectSettings(0L,HOUR_IN_MILLIS,WEEK_IN_MILLIS);
  expectNetworkState(buildWifiState());
  expectNetworkStatsSummary(buildEmptyStats(elapsedRealtime));
  replay();
  mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION));
  verifyAndReset();
  elapsedRealtime+=2 * HOUR_IN_MILLIS;
  expectTime(TEST_START + elapsedRealtime);
  expectSettings(0L,HOUR_IN_MILLIS,WEEK_IN_MILLIS);
  expectNetworkStatsSummary(new NetworkStats.Builder(elapsedRealtime,1).addEntry(TEST_IFACE,UID_ALL,512L,512L).build());
  expectNetworkStatsDetail(buildEmptyStats(elapsedRealtime));
  replay();
  mServiceContext.sendBroadcast(new Intent(ACTION_NETWORK_STATS_POLL));
  history=mService.getHistoryForNetwork(TEMPLATE_WIFI);
  total=history.getTotalData(Long.MIN_VALUE,Long.MAX_VALUE,null);
  assertEquals(512L,total[0]);
  assertEquals(512L,total[1]);
  assertEquals(HOUR_IN_MILLIS,history.bucketDuration);
  assertEquals(2,history.bucketCount);
  verifyAndReset();
  expectTime(TEST_START + elapsedRealtime);
  expectSettings(0L,30 * MINUTE_IN_MILLIS,WEEK_IN_MILLIS);
  expectNetworkStatsSummary(buildEmptyStats(elapsedRealtime));
  expectNetworkStatsDetail(buildEmptyStats(elapsedRealtime));
  replay();
  mServiceContext.sendBroadcast(new Intent(ACTION_NETWORK_STATS_POLL));
  history=mService.getHistoryForNetwork(TEMPLATE_WIFI);
  total=history.getTotalData(Long.MIN_VALUE,Long.MAX_VALUE,null);
  assertEquals(512L,total[0]);
  assertEquals(512L,total[1]);
  assertEquals(30 * MINUTE_IN_MILLIS,history.bucketDuration);
  assertEquals(4,history.bucketCount);
  verifyAndReset();
}
