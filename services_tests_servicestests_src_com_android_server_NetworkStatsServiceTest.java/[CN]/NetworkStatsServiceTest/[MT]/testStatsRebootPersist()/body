{
  long elapsedRealtime=0;
  assertStatsFilesExist(false);
  expectTime(TEST_START + elapsedRealtime);
  expectDefaultSettings();
  expectNetworkState(buildWifiState());
  expectNetworkStatsSummary(buildEmptyStats(elapsedRealtime));
  replay();
  mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION));
  assertNetworkTotal(TEMPLATE_WIFI,0L,0L);
  verifyAndReset();
  elapsedRealtime+=HOUR_IN_MILLIS;
  expectTime(TEST_START + elapsedRealtime);
  expectDefaultSettings();
  expectNetworkStatsSummary(new NetworkStats.Builder(elapsedRealtime,1).addEntry(TEST_IFACE,UID_ALL,1024L,2048L).build());
  expectNetworkStatsDetail(new NetworkStats.Builder(elapsedRealtime,2).addEntry(IFACE_ALL,TEST_UID_1,512L,256L).addEntry(IFACE_ALL,TEST_UID_2,128L,128L).build());
  replay();
  mServiceContext.sendBroadcast(new Intent(ACTION_NETWORK_STATS_POLL));
  assertNetworkTotal(TEMPLATE_WIFI,1024L,2048L);
  assertUidTotal(TEST_UID_1,TEMPLATE_WIFI,512L,256L);
  assertUidTotal(TEST_UID_2,TEMPLATE_WIFI,128L,128L);
  verifyAndReset();
  mServiceContext.sendBroadcast(new Intent(Intent.ACTION_SHUTDOWN));
  expectDefaultSettings();
  replay();
  assertNetworkTotal(TEMPLATE_WIFI,0L,0L);
  verifyAndReset();
  assertStatsFilesExist(true);
  expectDefaultSettings();
  expectSystemReady();
  replay();
  mService.systemReady();
  assertNetworkTotal(TEMPLATE_WIFI,1024L,2048L);
  assertUidTotal(TEST_UID_1,TEMPLATE_WIFI,512L,256L);
  assertUidTotal(TEST_UID_2,TEMPLATE_WIFI,128L,128L);
  verifyAndReset();
}
