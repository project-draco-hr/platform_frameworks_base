{
synchronized (mExternalStatsLock) {
    if (mContext == null) {
      return;
    }
    if (BatteryStatsImpl.DEBUG_ENERGY) {
      Slog.d(TAG,"Updating external stats: reason=" + reason);
    }
    WifiActivityEnergyInfo wifiEnergyInfo=null;
    if ((updateFlags & UPDATE_WIFI) != 0) {
      wifiEnergyInfo=pullWifiEnergyInfoLocked();
    }
    BluetoothActivityEnergyInfo bluetoothEnergyInfo=null;
    if ((updateFlags & UPDATE_BT) != 0) {
      bluetoothEnergyInfo=pullBluetoothEnergyInfoLocked();
    }
synchronized (mStats) {
      final long elapsedRealtime=SystemClock.elapsedRealtime();
      final long uptime=SystemClock.uptimeMillis();
      if (mStats.mRecordAllHistory) {
        mStats.addHistoryEventLocked(elapsedRealtime,uptime,BatteryStats.HistoryItem.EVENT_COLLECT_EXTERNAL_STATS,reason,0);
      }
      if ((updateFlags & UPDATE_CPU) != 0) {
        mStats.updateCpuTimeLocked();
        mStats.updateKernelWakelocksLocked();
      }
      if ((updateFlags & UPDATE_RADIO) != 0) {
        mStats.updateMobileRadioStateLocked(elapsedRealtime);
      }
      if ((updateFlags & UPDATE_WIFI) != 0) {
        mStats.updateWifiStateLocked(wifiEnergyInfo);
      }
      if ((updateFlags & UPDATE_BT) != 0) {
        mStats.updateBluetoothStateLocked(bluetoothEnergyInfo);
      }
    }
  }
}
