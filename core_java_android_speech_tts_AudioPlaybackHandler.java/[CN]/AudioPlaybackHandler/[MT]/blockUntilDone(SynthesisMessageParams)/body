{
  if (params.mAudioTrack == null || params.mBytesWritten <= 0) {
    return;
  }
  final AudioTrack audioTrack=params.mAudioTrack;
  final int bytesPerFrame=getBytesPerFrame(params.mAudioFormat);
  final int lengthInBytes=params.mBytesWritten;
  final int lengthInFrames=lengthInBytes / bytesPerFrame;
  int currentPosition=0;
  while ((currentPosition=audioTrack.getPlaybackHeadPosition()) < lengthInFrames) {
    if (audioTrack.getPlayState() != AudioTrack.PLAYSTATE_PLAYING) {
      break;
    }
    long estimatedTimeMs=((lengthInFrames - currentPosition) * 1000) / audioTrack.getSampleRate();
    if (DBG)     Log.d(TAG,"About to sleep for : " + estimatedTimeMs + " ms,"+ " Playback position : "+ currentPosition);
    try {
      Thread.sleep(estimatedTimeMs);
    }
 catch (    InterruptedException ie) {
      break;
    }
  }
}
