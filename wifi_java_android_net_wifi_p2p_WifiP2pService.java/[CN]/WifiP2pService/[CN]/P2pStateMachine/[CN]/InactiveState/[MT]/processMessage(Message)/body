{
  if (DBG)   logd(getName() + message.toString());
switch (message.what) {
case WifiP2pManager.CONNECT:
    if (DBG)     logd(getName() + " sending connect");
  mSavedPeerConfig=(WifiP2pConfig)message.obj;
String updatedPeerDetails=WifiNative.p2pPeer(mSavedPeerConfig.deviceAddress);
mPeers.update(new WifiP2pDevice(updatedPeerDetails));
mPersistGroup=false;
int netId=configuredNetworkId(mSavedPeerConfig.deviceAddress);
if (netId >= 0) {
WifiNative.p2pReinvoke(netId,mSavedPeerConfig.deviceAddress);
}
 else {
if (isGroupOwner(mSavedPeerConfig.deviceAddress)) {
p2pConnectWithPinDisplay(mSavedPeerConfig,JOIN_GROUP);
transitionTo(mGroupNegotiationState);
}
 else {
transitionTo(mProvisionDiscoveryState);
}
}
updateDeviceStatus(mSavedPeerConfig.deviceAddress,WifiP2pDevice.INVITED);
sendP2pPeersChangedBroadcast();
replyToMessage(message,WifiP2pManager.CONNECT_SUCCEEDED);
break;
case WifiMonitor.P2P_GO_NEGOTIATION_REQUEST_EVENT:
mSavedPeerConfig=(WifiP2pConfig)message.obj;
transitionTo(mUserAuthorizingInvitationState);
break;
case WifiMonitor.P2P_INVITATION_RECEIVED_EVENT:
WifiP2pGroup group=(WifiP2pGroup)message.obj;
WifiP2pDevice owner=group.getOwner();
if (owner == null) {
if (DBG) loge("Ignored invitation from null owner");
break;
}
mSavedPeerConfig=new WifiP2pConfig();
mSavedPeerConfig.deviceAddress=group.getOwner().deviceAddress;
if ((owner=getDeviceFromPeerList(owner.deviceAddress)) != null) {
if (owner.wpsPbcSupported()) {
mSavedPeerConfig.wps.setup=WpsInfo.PBC;
}
 else if (owner.wpsKeypadSupported()) {
mSavedPeerConfig.wps.setup=WpsInfo.KEYPAD;
}
 else if (owner.wpsDisplaySupported()) {
mSavedPeerConfig.wps.setup=WpsInfo.DISPLAY;
}
}
transitionTo(mUserAuthorizingInvitationState);
break;
case WifiMonitor.P2P_PROV_DISC_PBC_REQ_EVENT:
case WifiMonitor.P2P_PROV_DISC_ENTER_PIN_EVENT:
case WifiMonitor.P2P_PROV_DISC_SHOW_PIN_EVENT:
WifiP2pProvDiscEvent provDisc=(WifiP2pProvDiscEvent)message.obj;
mSavedPeerConfig=new WifiP2pConfig();
mSavedPeerConfig.deviceAddress=provDisc.device.deviceAddress;
if (message.what == WifiMonitor.P2P_PROV_DISC_ENTER_PIN_EVENT) {
mSavedPeerConfig.wps.setup=WpsInfo.KEYPAD;
if (DBG) logd("Keypad prov disc request");
}
 else if (message.what == WifiMonitor.P2P_PROV_DISC_SHOW_PIN_EVENT) {
mSavedPeerConfig.wps.setup=WpsInfo.DISPLAY;
mSavedPeerConfig.wps.pin=provDisc.pin;
if (DBG) logd("Display prov disc request");
}
 else {
mSavedPeerConfig.wps.setup=WpsInfo.PBC;
if (DBG) logd("PBC prov disc request");
}
transitionTo(mUserAuthorizingInvitationState);
break;
case WifiP2pManager.CREATE_GROUP:
mPersistGroup=true;
if (WifiNative.p2pGroupAdd()) {
replyToMessage(message,WifiP2pManager.CREATE_GROUP_SUCCEEDED);
}
 else {
replyToMessage(message,WifiP2pManager.CREATE_GROUP_FAILED,WifiP2pManager.ERROR);
}
transitionTo(mGroupNegotiationState);
break;
default :
return NOT_HANDLED;
}
return HANDLED;
}
