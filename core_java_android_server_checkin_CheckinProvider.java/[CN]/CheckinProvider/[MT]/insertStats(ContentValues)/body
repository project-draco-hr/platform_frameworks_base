{
synchronized (mStatsLock) {
    String tag=values.getAsString(Checkin.Stats.TAG);
    if (tag == null) {
      throw new IllegalArgumentException("Tag required:" + values);
    }
    SQLiteDatabase db=mOpenHelper.getWritableDatabase();
    Cursor cursor=db.query(false,Checkin.Stats.TABLE_NAME,new String[]{Checkin.Stats._ID,Checkin.Stats.COUNT,Checkin.Stats.SUM},Checkin.Stats.TAG + "=?",new String[]{tag},null,null,null,null);
    try {
      if (cursor == null || !cursor.moveToNext()) {
        return db.insert(Checkin.Stats.TABLE_NAME,null,values);
      }
 else {
        long id=cursor.getLong(0);
        int count=cursor.getInt(1);
        double sum=cursor.getDouble(2);
        Integer countAdd=values.getAsInteger(Checkin.Stats.COUNT);
        if (countAdd != null)         count+=countAdd.intValue();
        Double sumAdd=values.getAsDouble(Checkin.Stats.SUM);
        if (sumAdd != null)         sum+=sumAdd.doubleValue();
        if (count <= 0 && sum == 0.0) {
          cursor.deleteRow();
          getContext().getContentResolver().notifyChange(ContentUris.withAppendedId(Checkin.Stats.CONTENT_URI,id),null);
          return -1;
        }
 else {
          if (countAdd != null)           cursor.updateInt(1,count);
          if (sumAdd != null)           cursor.updateDouble(2,sum);
          cursor.commitUpdates();
          return id;
        }
      }
    }
  finally {
      if (cursor != null)       cursor.close();
    }
  }
}
