{
  int line=getLineForOffset(caret);
  int lineStart=getLineStart(line);
  int lineEnd=getLineEnd(line);
  int lineDir=getParagraphDirection(line);
  boolean lineChanged=false;
  boolean advance=toLeft == (lineDir == DIR_RIGHT_TO_LEFT);
  if (advance) {
    if (caret == lineEnd) {
      if (line < getLineCount() - 1) {
        lineChanged=true;
        ++line;
      }
 else {
        return caret;
      }
    }
  }
 else {
    if (caret == lineStart) {
      if (line > 0) {
        lineChanged=true;
        --line;
      }
 else {
        return caret;
      }
    }
  }
  if (lineChanged) {
    lineStart=getLineStart(line);
    lineEnd=getLineEnd(line);
    int newDir=getParagraphDirection(line);
    if (newDir != lineDir) {
      toLeft=!toLeft;
      lineDir=newDir;
    }
  }
  Directions directions=getLineDirections(line);
  TextLine tl=TextLine.obtain();
  tl.set(mPaint,mText,lineStart,lineEnd,lineDir,directions,false,null);
  caret=lineStart + tl.getOffsetToLeftRightOf(caret - lineStart,toLeft);
  tl=TextLine.recycle(tl);
  return caret;
}
