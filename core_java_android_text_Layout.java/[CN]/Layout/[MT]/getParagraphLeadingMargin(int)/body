{
  if (!mSpannedText) {
    return 0;
  }
  Spanned spanned=(Spanned)mText;
  int lineStart=getLineStart(line);
  int lineEnd=getLineEnd(line);
  int spanEnd=spanned.nextSpanTransition(lineStart,lineEnd,LeadingMarginSpan.class);
  LeadingMarginSpan[] spans=getParagraphSpans(spanned,lineStart,spanEnd,LeadingMarginSpan.class);
  if (spans.length == 0) {
    return 0;
  }
  int margin=0;
  boolean isFirstParaLine=lineStart == 0 || spanned.charAt(lineStart - 1) == '\n';
  boolean useFirstLineMargin=isFirstParaLine;
  for (int i=0; i < spans.length; i++) {
    if (spans[i] instanceof LeadingMarginSpan2) {
      int spStart=spanned.getSpanStart(spans[i]);
      int spanLine=getLineForOffset(spStart);
      int count=((LeadingMarginSpan2)spans[i]).getLeadingMarginLineCount();
      useFirstLineMargin|=line < spanLine + count;
    }
  }
  for (int i=0; i < spans.length; i++) {
    LeadingMarginSpan span=spans[i];
    margin+=span.getLeadingMargin(useFirstLineMargin);
  }
  return margin;
}
