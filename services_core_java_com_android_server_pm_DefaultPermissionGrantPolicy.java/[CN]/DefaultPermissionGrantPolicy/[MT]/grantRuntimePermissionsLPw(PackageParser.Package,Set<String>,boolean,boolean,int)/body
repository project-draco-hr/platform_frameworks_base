{
  List<String> requestedPermissions=pkg.requestedPermissions;
  if (pkg.isUpdatedSystemApp()) {
    PackageSetting sysPs=mService.mSettings.getDisabledSystemPkgLPr(pkg.packageName);
    if (sysPs != null) {
      requestedPermissions=sysPs.pkg.requestedPermissions;
    }
  }
  final int permissionCount=requestedPermissions.size();
  for (int i=0; i < permissionCount; i++) {
    String permission=requestedPermissions.get(i);
    if (permissions.contains(permission)) {
      final int flags=mService.getPermissionFlags(permission,pkg.packageName,userId);
      if (flags == 0 || overrideUserChoice) {
        final int fixedFlags=PackageManager.FLAG_PERMISSION_SYSTEM_FIXED | PackageManager.FLAG_PERMISSION_POLICY_FIXED;
        if ((flags & fixedFlags) != 0) {
          continue;
        }
        mService.grantRuntimePermission(pkg.packageName,permission,userId);
        if (DEBUG) {
          Log.i(TAG,"Granted " + permission + " to default handler "+ pkg.packageName);
        }
        int newFlags=PackageManager.FLAG_PERMISSION_GRANTED_BY_DEFAULT;
        if (systemFixed) {
          newFlags|=PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;
        }
        mService.updatePermissionFlags(permission,pkg.packageName,newFlags,newFlags,userId);
      }
    }
  }
}
