{
  if (transportLen < 0) {
    throw new IllegalArgumentException("Transport length < 0: " + transportLen);
  }
  int sum;
  byte ver=ipversion(buf,ipOffset);
  if (ver == 4) {
    sum=pseudoChecksumIPv4(buf,ipOffset,protocol,transportLen);
  }
 else   if (ver == 6) {
    sum=pseudoChecksumIPv6(buf,ipOffset,protocol,transportLen);
  }
 else {
    throw new UnsupportedOperationException("Checksum must be IPv4 or IPv6");
  }
  sum=checksum(buf,sum,transportOffset,transportOffset + transportLen);
  if (protocol == IPPROTO_UDP && sum == 0) {
    sum=(short)0xffff;
  }
  return (short)sum;
}
