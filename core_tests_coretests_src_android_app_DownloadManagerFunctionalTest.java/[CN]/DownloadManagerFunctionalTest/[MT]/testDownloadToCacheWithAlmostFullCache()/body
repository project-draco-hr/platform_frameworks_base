{
  int DOWNLOAD_FILE_SIZE=1024 * 1024;
  StatFs fs=new StatFs(CACHE_DIR);
  int blockSize=fs.getBlockSize();
  int availableBlocks=fs.getAvailableBlocks();
  int availableBytes=blockSize * availableBlocks;
  Log.i(TAG,"INITIAL stage, available space in /cache: " + availableBytes);
  File outFile=File.createTempFile("DM_TEST",null,new File(CACHE_DIR));
  byte[] buffer=new byte[blockSize];
  try {
    if (DOWNLOAD_FILE_SIZE <= availableBytes) {
      int writeSizeBytes=availableBytes - (DOWNLOAD_FILE_SIZE / 2);
      int writeSizeBlocks=writeSizeBytes / blockSize;
      int remainderSizeBlocks=availableBlocks - writeSizeBlocks;
      FileOutputStream fo=null;
      try {
        fo=new FileOutputStream(outFile);
        while (fs.getAvailableBlocks() >= remainderSizeBlocks) {
          fo.write(buffer);
          fs.restat(CACHE_DIR);
        }
      }
 catch (      IOException e) {
        Log.e(LOG_TAG,"error filling file: ",e);
        throw e;
      }
 finally {
        if (fo != null) {
          fo.close();
        }
      }
    }
    long spaceAvailable=fs.getAvailableBlocks() * blockSize;
    Log.i(TAG,"BEFORE download, available space in /cache: " + spaceAvailable);
    assertTrue(DOWNLOAD_FILE_SIZE > spaceAvailable);
    byte[] blobData=generateData(DOWNLOAD_FILE_SIZE,DataType.TEXT);
    long dlRequest=doBasicDownload(blobData,DOWNLOAD_TO_SYSTEM_CACHE);
    verifyAndCleanupSingleFileDownload(dlRequest,blobData);
  }
  finally {
    if (outFile != null) {
      outFile.delete();
    }
  }
}
