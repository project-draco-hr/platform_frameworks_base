{
synchronized (this) {
    if (currentValue != endValue) {
      final long now=SystemClock.elapsedRealtime();
      final int elapsed=(int)(now - startTimeMillis);
      int newValue;
      if (elapsed < duration) {
        int delta=endValue - startValue;
        newValue=startValue + delta * elapsed / duration;
        newValue=Math.max(PowerManager.BRIGHTNESS_OFF,newValue);
        newValue=Math.min(PowerManager.BRIGHTNESS_ON,newValue);
        if (delay > 0 && newValue == currentValue) {
          final int timePerStep=duration / Math.abs(delta);
          delay=Math.min(duration - elapsed,timePerStep);
          newValue+=delta < 0 ? -1 : 1;
        }
        delta=endSensorValue - startSensorValue;
        mHighestLightSensorValue=startSensorValue + delta * elapsed / duration;
      }
 else {
        newValue=endValue;
        mHighestLightSensorValue=endSensorValue;
        mInitialAnimation=false;
      }
      if (mDebugLightAnimation) {
        Slog.v(TAG,"Animating light: " + "start:" + startValue + ", end:"+ endValue+ ", elapsed:"+ elapsed+ ", duration:"+ duration+ ", current:"+ currentValue+ ", newValue:"+ newValue+ ", delay:"+ delay+ ", highestSensor:"+ mHighestLightSensorValue);
      }
      if (turningOff && !mHeadless && !mAnimateScreenLights) {
        int mode=mScreenOffReason == OFF_BECAUSE_OF_PROX_SENSOR ? 0 : mAnimationSetting;
        if (mDebugLightAnimation) {
          Slog.v(TAG,"Doing power-off anim, mode=" + mode);
        }
        mScreenBrightnessHandler.obtainMessage(ANIMATE_POWER_OFF,mode,0).sendToTarget();
      }
      mScreenBrightnessHandler.removeMessages(ScreenBrightnessAnimator.ANIMATE_LIGHTS);
      Message msg=mScreenBrightnessHandler.obtainMessage(ANIMATE_LIGHTS,mask,newValue);
      mScreenBrightnessHandler.sendMessageDelayed(msg,delay);
    }
  }
}
