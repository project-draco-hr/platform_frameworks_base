{
  if (DEBUG_SCREEN_ON) {
    RuntimeException e=new RuntimeException("here");
    e.fillInStackTrace();
    Slog.i(TAG,"Set screen state: " + on,e);
  }
  if (on) {
    if ((mPowerState & SCREEN_ON_BIT) == 0 || mSkippedScreenOn) {
      if (DEBUG_SCREEN_ON) {
        Slog.i(TAG,"Forcing brightness 0: mPowerState=0x" + Integer.toHexString(mPowerState) + " mSkippedScreenOn="+ mSkippedScreenOn);
      }
      mScreenBrightnessHandler.removeMessages(ScreenBrightnessAnimator.ANIMATE_LIGHTS);
      mScreenBrightnessAnimator.animateTo(PowerManager.BRIGHTNESS_OFF,SCREEN_BRIGHT_BIT,0);
    }
  }
  int err=nativeSetScreenState(on);
  if (err == 0) {
    mLastScreenOnTime=(on ? SystemClock.elapsedRealtime() : 0);
    if (mUseSoftwareAutoBrightness) {
      enableLightSensorLocked(on);
      if (!on) {
        mButtonLight.turnOff();
        mKeyboardLight.turnOff();
      }
    }
  }
  return err;
}
