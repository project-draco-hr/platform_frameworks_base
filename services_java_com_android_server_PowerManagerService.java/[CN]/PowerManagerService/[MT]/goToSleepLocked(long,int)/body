{
  if (mSpew) {
    Exception ex=new Exception();
    ex.fillInStackTrace();
    Slog.d(TAG,"goToSleep mLastEventTime=" + mLastEventTime + " time="+ time+ " reason="+ reason,ex);
  }
  if (mLastEventTime <= time) {
    mLastEventTime=time;
    mWakeLockState=SCREEN_OFF;
    int N=mLocks.size();
    int numCleared=0;
    boolean proxLock=false;
    for (int i=0; i < N; i++) {
      WakeLock wl=mLocks.get(i);
      if (isScreenLock(wl.flags)) {
        if (((wl.flags & LOCK_MASK) == PowerManager.PROXIMITY_SCREEN_OFF_WAKE_LOCK) && reason == WindowManagerPolicy.OFF_BECAUSE_OF_PROX_SENSOR) {
          proxLock=true;
        }
 else {
          mLocks.get(i).activated=false;
          numCleared++;
        }
      }
    }
    if (!proxLock) {
      mProxIgnoredBecauseScreenTurnedOff=true;
      if (mDebugProximitySensor) {
        Slog.d(TAG,"setting mProxIgnoredBecauseScreenTurnedOff");
      }
    }
    EventLog.writeEvent(EventLogTags.POWER_SLEEP_REQUESTED,numCleared);
    mStillNeedSleepNotification=true;
    mUserState=SCREEN_OFF;
    setPowerState(SCREEN_OFF,false,reason);
    cancelTimerLocked();
  }
}
