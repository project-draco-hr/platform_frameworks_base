{
  WakeLock wl=mLocks.removeLock(lock);
  if (wl == null) {
    return;
  }
  if (mSpew) {
    Slog.d(TAG,"releaseWakeLock flags=0x" + Integer.toHexString(wl.flags) + " tag="+ wl.tag);
  }
  if (isScreenLock(wl.flags)) {
    if ((wl.flags & LOCK_MASK) == PowerManager.PROXIMITY_SCREEN_OFF_WAKE_LOCK) {
      mProximityWakeLockCount--;
      if (mProximityWakeLockCount == 0) {
        if (mProximitySensorActive && ((flags & PowerManager.WAIT_FOR_PROXIMITY_NEGATIVE) != 0)) {
          if (mDebugProximitySensor) {
            Slog.d(TAG,"waiting for proximity sensor to go negative");
          }
        }
 else {
          disableProximityLockLocked();
        }
      }
    }
 else {
      mWakeLockState=mLocks.gatherState();
      if ((wl.flags & PowerManager.ON_AFTER_RELEASE) != 0) {
        userActivity(SystemClock.uptimeMillis(),-1,false,OTHER_EVENT,false);
      }
      setPowerState(mWakeLockState | mUserState);
    }
  }
 else   if ((wl.flags & LOCK_MASK) == PowerManager.PARTIAL_WAKE_LOCK) {
    mPartialCount--;
    if (mPartialCount == 0) {
      if (LOG_PARTIAL_WL)       EventLog.writeEvent(EventLogTags.POWER_PARTIAL_WAKE_STATE,0,wl.tag);
      nativeReleaseWakeLock(PARTIAL_NAME);
    }
  }
  wl.binder.unlinkToDeath(wl,0);
  noteStopWakeLocked(wl,wl.ws);
}
