{
  int ret;
  if (mSocketState == SocketState.CLOSED)   return EBADFD;
  IBluetooth bluetoothProxy=BluetoothAdapter.getDefaultAdapter().getBluetoothService(null);
  if (bluetoothProxy == null) {
    Log.e(TAG,"bindListen fail, reason: bluetooth is off");
    return -1;
  }
  try {
    mPfd=bluetoothProxy.createSocketChannel(mType,mServiceName,mUuid,mPort,getSecurityFlags());
  }
 catch (  RemoteException e) {
    Log.e(TAG,Log.getStackTraceString(new Throwable()));
    return -1;
  }
  try {
synchronized (this) {
      if (DBG)       Log.d(TAG,"bindListen(), SocketState: " + mSocketState + ", mPfd: "+ mPfd);
      if (mSocketState != SocketState.INIT)       return EBADFD;
      if (mPfd == null)       return -1;
      FileDescriptor fd=mPfd.getFileDescriptor();
      if (DBG)       Log.d(TAG,"bindListen(), new LocalSocket ");
      mSocket=new LocalSocket(fd);
      if (DBG)       Log.d(TAG,"bindListen(), new LocalSocket.getInputStream() ");
      mSocketIS=mSocket.getInputStream();
      mSocketOS=mSocket.getOutputStream();
    }
    if (DBG)     Log.d(TAG,"bindListen(), readInt mSocketIS: " + mSocketIS);
    int channel=readInt(mSocketIS);
synchronized (this) {
      if (mSocketState == SocketState.INIT)       mSocketState=SocketState.LISTENING;
    }
    if (DBG)     Log.d(TAG,"channel: " + channel);
    if (mPort <= -1) {
      mPort=channel;
    }
    ret=0;
  }
 catch (  IOException e) {
    if (mPfd != null) {
      try {
        mPfd.close();
      }
 catch (      IOException e1) {
        Log.e(TAG,"bindListen, close mPfd: " + e1);
      }
      mPfd=null;
    }
    Log.e(TAG,"bindListen, fail to get port number, exception: " + e);
    return -1;
  }
  return ret;
}
