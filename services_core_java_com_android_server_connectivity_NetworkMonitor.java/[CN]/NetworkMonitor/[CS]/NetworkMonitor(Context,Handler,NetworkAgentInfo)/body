{
  super(TAG + networkAgentInfo.name());
  mContext=context;
  mConnectivityServiceHandler=handler;
  mNetworkAgentInfo=networkAgentInfo;
  mTelephonyManager=(TelephonyManager)context.getSystemService(Context.TELEPHONY_SERVICE);
  mWifiManager=(WifiManager)context.getSystemService(Context.WIFI_SERVICE);
  mAlarmManager=(AlarmManager)context.getSystemService(Context.ALARM_SERVICE);
  addState(mDefaultState);
  addState(mOfflineState,mDefaultState);
  addState(mValidatedState,mDefaultState);
  addState(mMaybeNotifyState,mDefaultState);
  addState(mEvaluatingState,mMaybeNotifyState);
  addState(mCaptivePortalState,mMaybeNotifyState);
  addState(mLingeringState,mDefaultState);
  setInitialState(mDefaultState);
  mServer=Settings.Global.getString(mContext.getContentResolver(),Settings.Global.CAPTIVE_PORTAL_SERVER);
  if (mServer == null)   mServer=DEFAULT_SERVER;
  mLingerDelayMs=SystemProperties.getInt(LINGER_DELAY_PROPERTY,DEFAULT_LINGER_DELAY_MS);
  mReevaluateDelayMs=SystemProperties.getInt(REEVALUATE_DELAY_PROPERTY,DEFAULT_REEVALUATE_DELAY_MS);
  mIsCaptivePortalCheckEnabled=Settings.Global.getInt(mContext.getContentResolver(),Settings.Global.CAPTIVE_PORTAL_DETECTION_ENABLED,1) == 1;
  mCaptivePortalLoggedInResponseToken=String.valueOf(new Random().nextLong());
  start();
}
