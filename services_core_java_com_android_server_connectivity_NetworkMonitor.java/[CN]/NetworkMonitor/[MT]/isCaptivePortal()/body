{
  if (!mIsCaptivePortalCheckEnabled)   return 204;
  HttpURLConnection urlConnection=null;
  int httpResponseCode=599;
  try {
    URL url=new URL("http",mServer,"/generate_204");
    if (DBG) {
      log("Checking " + url.toString() + " on "+ mNetworkAgentInfo.networkInfo.getExtraInfo());
    }
    urlConnection=(HttpURLConnection)mNetworkAgentInfo.network.openConnection(url);
    urlConnection.setInstanceFollowRedirects(false);
    urlConnection.setConnectTimeout(SOCKET_TIMEOUT_MS);
    urlConnection.setReadTimeout(SOCKET_TIMEOUT_MS);
    urlConnection.setUseCaches(false);
    long requestTimestamp=SystemClock.elapsedRealtime();
    urlConnection.getInputStream();
    long responseTimestamp=SystemClock.elapsedRealtime();
    httpResponseCode=urlConnection.getResponseCode();
    if (DBG) {
      log("isCaptivePortal: ret=" + httpResponseCode + " headers="+ urlConnection.getHeaderFields());
    }
    if (httpResponseCode == 200 && urlConnection.getContentLength() == 0) {
      if (DBG)       log("Empty 200 response interpreted as 204 response.");
      httpResponseCode=204;
    }
    sendNetworkConditionsBroadcast(true,httpResponseCode != 204,requestTimestamp,responseTimestamp);
  }
 catch (  IOException e) {
    if (DBG)     log("Probably not a portal: exception " + e);
    if (httpResponseCode == 599) {
    }
  }
 finally {
    if (urlConnection != null) {
      urlConnection.disconnect();
    }
  }
  return httpResponseCode;
}
