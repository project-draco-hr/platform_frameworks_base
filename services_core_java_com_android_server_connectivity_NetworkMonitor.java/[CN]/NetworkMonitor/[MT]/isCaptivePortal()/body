{
  if (!mIsCaptivePortalCheckEnabled)   return 204;
  String urlString="http://" + mServer + "/generate_204";
  if (DBG)   log("Checking " + urlString);
  HttpURLConnection urlConnection=null;
  Socket socket=null;
  int httpResponseCode=500;
  try {
    URL url=new URL(urlString);
    if (false) {
      urlConnection=(HttpURLConnection)url.openConnection();
      urlConnection.setInstanceFollowRedirects(false);
      urlConnection.setConnectTimeout(SOCKET_TIMEOUT_MS);
      urlConnection.setReadTimeout(SOCKET_TIMEOUT_MS);
      urlConnection.setUseCaches(false);
      urlConnection.getInputStream();
      httpResponseCode=urlConnection.getResponseCode();
    }
 else {
      socket=new Socket();
      InetSocketAddress address=new InetSocketAddress(url.getHost(),80);
      socket.connect(address);
      BufferedReader reader=new BufferedReader(new InputStreamReader(socket.getInputStream()));
      OutputStreamWriter writer=new OutputStreamWriter(socket.getOutputStream());
      writer.write("GET " + url.getFile() + " HTTP/1.1\r\n\n");
      writer.flush();
      String response=reader.readLine();
      if (response.startsWith("HTTP/1.1 ")) {
        httpResponseCode=Integer.parseInt(response.substring(9,12));
      }
    }
    if (DBG)     log("isCaptivePortal: ret=" + httpResponseCode);
  }
 catch (  IOException e) {
    if (DBG)     log("Probably not a portal: exception " + e);
  }
 finally {
    if (urlConnection != null) {
      urlConnection.disconnect();
    }
    if (socket != null) {
      try {
        socket.close();
      }
 catch (      IOException e) {
      }
    }
  }
  return httpResponseCode;
}
