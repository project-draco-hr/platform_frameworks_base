{
  boolean waiting=false;
  for (  PanelView pv : mPanels) {
    if (animate && !pv.isFullyCollapsed()) {
      pv.collapse();
      waiting=true;
    }
 else {
      pv.setExpandedFraction(0);
      pv.setVisibility(View.GONE);
      pv.cancelPeek();
      pv.resetViews();
    }
  }
  if (DEBUG)   LOG("collapseAllPanels: animate=%s waiting=%s",animate,waiting);
  if (!waiting && mState != STATE_CLOSED) {
    go(STATE_CLOSED);
    onAllPanelsCollapsed();
  }
}
