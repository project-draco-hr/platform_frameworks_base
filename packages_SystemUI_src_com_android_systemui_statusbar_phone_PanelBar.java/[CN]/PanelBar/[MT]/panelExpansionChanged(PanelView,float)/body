{
  boolean fullyClosed=true;
  PanelView fullyOpenedPanel=null;
  if (DEBUG)   LOG("panelExpansionChanged: start state=%d panel=%s",mState,panel.getName());
  mPanelExpandedFractionSum=0f;
  for (  PanelView pv : mPanels) {
    final boolean visible=pv.getVisibility() == View.VISIBLE;
    if (pv.getExpandedHeight() > 0f) {
      if (mState == STATE_CLOSED) {
        go(STATE_OPENING);
        onPanelPeeked();
      }
      fullyClosed=false;
      final float thisFrac=pv.getExpandedFraction();
      mPanelExpandedFractionSum+=(visible ? thisFrac : 0);
      if (DEBUG)       LOG("panelExpansionChanged:  -> %s: f=%.1f",pv.getName(),thisFrac);
      if (panel == pv) {
        if (thisFrac == 1f)         fullyOpenedPanel=panel;
      }
    }
    if (pv.getExpandedHeight() > 0f) {
      if (!visible)       pv.setVisibility(View.VISIBLE);
    }
 else {
      if (visible)       pv.setVisibility(View.GONE);
    }
  }
  mPanelExpandedFractionSum/=mPanels.size();
  if (fullyOpenedPanel != null && !mTracking) {
    go(STATE_OPEN);
    onPanelFullyOpened(fullyOpenedPanel);
  }
 else   if (fullyClosed && !mTracking && mState != STATE_CLOSED) {
    go(STATE_CLOSED);
    onAllPanelsCollapsed();
  }
  if (DEBUG)   LOG("panelExpansionChanged: end state=%d [%s%s ]",mState,(fullyOpenedPanel != null) ? " fullyOpened" : "",fullyClosed ? " fullyClosed" : "");
}
