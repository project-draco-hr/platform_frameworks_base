{
  TextureSource targetTex=TextureSource.newExternalTexture();
  ImageShader copyShader=shaderForContext(RenderTarget.currentContext());
  if (targetTex == null || copyShader == null) {
    throw new RuntimeException("Attempting to grab camera frame from unknown " + "thread: " + Thread.currentThread() + "!");
  }
  mPreviewSurfaceTexture.attachToGLContext(targetTex.getTextureId());
  updateTransform(copyShader);
  updateShaderTargetRect(copyShader);
  targetFrame.resize(new int[]{mOutWidth,mOutHeight});
  copyShader.process(targetTex,targetFrame.lockRenderTarget(),mOutWidth,mOutHeight);
  targetFrame.setTimestamp(mPreviewSurfaceTexture.getTimestamp());
  targetFrame.unlock();
  mPreviewSurfaceTexture.detachFromGLContext();
  targetTex.release();
}
