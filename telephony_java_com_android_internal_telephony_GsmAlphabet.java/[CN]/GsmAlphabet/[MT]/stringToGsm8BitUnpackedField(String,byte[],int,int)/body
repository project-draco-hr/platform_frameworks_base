{
  int outByteIndex=offset;
  for (int i=0, sz=s.length(); i < sz && (outByteIndex - offset) < length; i++) {
    char c=s.charAt(i);
    int v=GsmAlphabet.charToGsm(c);
    if (v == GSM_EXTENDED_ESCAPE) {
      if (!(outByteIndex + 1 - offset < length)) {
        break;
      }
      dest[outByteIndex++]=GSM_EXTENDED_ESCAPE;
      v=GsmAlphabet.charToGsmExtended(c);
    }
    dest[outByteIndex++]=(byte)v;
  }
  while ((outByteIndex - offset) < length) {
    dest[outByteIndex++]=(byte)0xff;
  }
}
