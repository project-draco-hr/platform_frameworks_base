{
  if (bm == null || opts == null) {
    return bm;
  }
  final int density=opts.inDensity;
  if (density == 0) {
    return bm;
  }
  bm.setDensity(density);
  final int targetDensity=opts.inTargetDensity;
  if (targetDensity == 0 || density == targetDensity || density == opts.inScreenDensity) {
    return bm;
  }
  byte[] np=bm.getNinePatchChunk();
  final boolean isNinePatch=np != null && NinePatch.isNinePatchChunk(np);
  if (opts.inScaled || isNinePatch) {
    float scale=targetDensity / (float)density;
    if (scale != 1.0f) {
      final Bitmap oldBitmap=bm;
      bm=Bitmap.createScaledBitmap(oldBitmap,(int)(bm.getWidth() * scale + 0.5f),(int)(bm.getHeight() * scale + 0.5f),true);
      if (bm != oldBitmap)       oldBitmap.recycle();
    }
    if (isNinePatch) {
      if (scale != 1.0f)       np=nativeScaleNinePatch(np,scale,outPadding);
      bm.setNinePatchChunk(np);
    }
    bm.setDensity(targetDensity);
  }
  return bm;
}
