{
  if (bm == null || opts == null) {
    return bm;
  }
  final int density=opts.inDensity;
  if (density == 0) {
    return bm;
  }
  bm.setDensity(density);
  final int targetDensity=opts.inTargetDensity;
  if (targetDensity == 0 || density == targetDensity || density == opts.inScreenDensity) {
    return bm;
  }
  byte[] np=bm.getNinePatchChunk();
  int[] lb=bm.getLayoutBounds();
  final boolean isNinePatch=np != null && NinePatch.isNinePatchChunk(np);
  if (opts.inScaled || isNinePatch) {
    float scale=targetDensity / (float)density;
    if (scale != 1.0f) {
      final Bitmap oldBitmap=bm;
      bm=Bitmap.createScaledBitmap(oldBitmap,(int)(bm.getWidth() * scale + 0.5f),(int)(bm.getHeight() * scale + 0.5f),true);
      if (bm != oldBitmap)       oldBitmap.recycle();
      if (isNinePatch) {
        np=nativeScaleNinePatch(np,scale,outPadding);
        bm.setNinePatchChunk(np);
      }
      if (lb != null) {
        int[] newLb=new int[lb.length];
        for (int i=0; i < lb.length; i++) {
          newLb[i]=(int)((lb[i] * scale) + .5f);
        }
        bm.setLayoutBounds(newLb);
      }
    }
    bm.setDensity(targetDensity);
  }
  return bm;
}
