{
  String digest=Settings.Gservices.getString(resolver,Settings.Gservices.PROVISIONING_DIGEST);
  if (sCachedDigest != null && sCachedDigest.equals(digest)) {
    if (LOCAL_LOGV)     Log.v(TAG,"Using cached rules for digest: " + digest);
    return sCachedRules;
  }
  if (LOCAL_LOGV)   Log.v(TAG,"Scanning for Gservices \"url:*\" rules");
  Cursor cursor=resolver.query(Settings.Gservices.CONTENT_URI,new String[]{Settings.Gservices.NAME,Settings.Gservices.VALUE},Settings.Gservices.NAME + " like \"url:%\"",null,Settings.Gservices.NAME);
  try {
    ArrayList<Rule> rules=new ArrayList<Rule>();
    while (cursor.moveToNext()) {
      try {
        String name=cursor.getString(0).substring(4);
        String value=cursor.getString(1);
        if (value == null || value.length() == 0)         continue;
        if (LOCAL_LOGV)         Log.v(TAG,"  Rule " + name + ": "+ value);
        rules.add(new Rule(name,value));
      }
 catch (      RuleFormatException e) {
        Log.e(TAG,"Invalid rule from Gservices",e);
        Checkin.logEvent(resolver,Checkin.Events.Tag.GSERVICES_ERROR,e.toString());
      }
    }
    sCachedRules=new UrlRules(rules.toArray(new Rule[rules.size()]));
    sCachedDigest=digest;
    if (LOCAL_LOGV)     Log.v(TAG,"New rules stored for digest: " + digest);
  }
  finally {
    cursor.close();
  }
  return sCachedRules;
}
