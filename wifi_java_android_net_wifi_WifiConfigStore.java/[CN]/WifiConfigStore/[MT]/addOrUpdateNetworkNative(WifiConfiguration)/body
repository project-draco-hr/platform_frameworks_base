{
  localLog("addOrUpdateNetworkNative " + config.getPrintableSsid());
  int netId=config.networkId;
  boolean newNetwork=false;
  if (netId == INVALID_NETWORK_ID) {
    Integer savedNetId=mNetworkIds.get(configKey(config));
    if (savedNetId != null) {
      netId=savedNetId;
    }
 else {
      newNetwork=true;
      netId=mWifiNative.addNetwork();
      if (netId < 0) {
        loge("Failed to add a network!");
        return new NetworkUpdateResult(INVALID_NETWORK_ID);
      }
    }
  }
  boolean updateFailed=true;
  setVariables: {
    if (config.SSID != null && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.ssidVarName,config.SSID)) {
      loge("failed to set SSID: " + config.SSID);
      break setVariables;
    }
    if (config.BSSID != null && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.bssidVarName,config.BSSID)) {
      loge("failed to set BSSID: " + config.BSSID);
      break setVariables;
    }
    String allowedKeyManagementString=makeString(config.allowedKeyManagement,WifiConfiguration.KeyMgmt.strings);
    if (config.allowedKeyManagement.cardinality() != 0 && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.KeyMgmt.varName,allowedKeyManagementString)) {
      loge("failed to set key_mgmt: " + allowedKeyManagementString);
      break setVariables;
    }
    String allowedProtocolsString=makeString(config.allowedProtocols,WifiConfiguration.Protocol.strings);
    if (config.allowedProtocols.cardinality() != 0 && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.Protocol.varName,allowedProtocolsString)) {
      loge("failed to set proto: " + allowedProtocolsString);
      break setVariables;
    }
    String allowedAuthAlgorithmsString=makeString(config.allowedAuthAlgorithms,WifiConfiguration.AuthAlgorithm.strings);
    if (config.allowedAuthAlgorithms.cardinality() != 0 && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.AuthAlgorithm.varName,allowedAuthAlgorithmsString)) {
      loge("failed to set auth_alg: " + allowedAuthAlgorithmsString);
      break setVariables;
    }
    String allowedPairwiseCiphersString=makeString(config.allowedPairwiseCiphers,WifiConfiguration.PairwiseCipher.strings);
    if (config.allowedPairwiseCiphers.cardinality() != 0 && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.PairwiseCipher.varName,allowedPairwiseCiphersString)) {
      loge("failed to set pairwise: " + allowedPairwiseCiphersString);
      break setVariables;
    }
    String allowedGroupCiphersString=makeString(config.allowedGroupCiphers,WifiConfiguration.GroupCipher.strings);
    if (config.allowedGroupCiphers.cardinality() != 0 && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.GroupCipher.varName,allowedGroupCiphersString)) {
      loge("failed to set group: " + allowedGroupCiphersString);
      break setVariables;
    }
    if (config.preSharedKey != null && !config.preSharedKey.equals("*") && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.pskVarName,config.preSharedKey)) {
      loge("failed to set psk");
      break setVariables;
    }
    boolean hasSetKey=false;
    if (config.wepKeys != null) {
      for (int i=0; i < config.wepKeys.length; i++) {
        if (config.wepKeys[i] != null && !config.wepKeys[i].equals("*")) {
          if (!mWifiNative.setNetworkVariable(netId,WifiConfiguration.wepKeyVarNames[i],config.wepKeys[i])) {
            loge("failed to set wep_key" + i + ": "+ config.wepKeys[i]);
            break setVariables;
          }
          hasSetKey=true;
        }
      }
    }
    if (hasSetKey) {
      if (!mWifiNative.setNetworkVariable(netId,WifiConfiguration.wepTxKeyIdxVarName,Integer.toString(config.wepTxKeyIndex))) {
        loge("failed to set wep_tx_keyidx: " + config.wepTxKeyIndex);
        break setVariables;
      }
    }
    if (!mWifiNative.setNetworkVariable(netId,WifiConfiguration.priorityVarName,Integer.toString(config.priority))) {
      loge(config.SSID + ": failed to set priority: " + config.priority);
      break setVariables;
    }
    if (config.hiddenSSID && !mWifiNative.setNetworkVariable(netId,WifiConfiguration.hiddenSSIDVarName,Integer.toString(config.hiddenSSID ? 1 : 0))) {
      loge(config.SSID + ": failed to set hiddenSSID: " + config.hiddenSSID);
      break setVariables;
    }
    if (config.enterpriseConfig != null && config.enterpriseConfig.getEapMethod() != WifiEnterpriseConfig.Eap.NONE) {
      WifiEnterpriseConfig enterpriseConfig=config.enterpriseConfig;
      if (enterpriseConfig.needsKeyStore()) {
        if (mKeyStore.state() != KeyStore.State.UNLOCKED) {
          loge(config.SSID + ": key store is locked");
          break setVariables;
        }
        try {
          WifiConfiguration currentConfig=mConfiguredNetworks.get(netId);
          String keyId=config.getKeyIdForCredentials(currentConfig);
          if (!enterpriseConfig.installKeys(mKeyStore,keyId)) {
            loge(config.SSID + ": failed to install keys");
            break setVariables;
          }
        }
 catch (        IllegalStateException e) {
          loge(config.SSID + " invalid config for key installation");
          break setVariables;
        }
      }
      HashMap<String,String> enterpriseFields=enterpriseConfig.getFields();
      for (      String key : enterpriseFields.keySet()) {
        String value=enterpriseFields.get(key);
        if (!mWifiNative.setNetworkVariable(netId,key,value)) {
          enterpriseConfig.removeKeys(mKeyStore);
          loge(config.SSID + ": failed to set " + key+ ": "+ value);
          break setVariables;
        }
      }
    }
    updateFailed=false;
  }
  if (updateFailed) {
    if (newNetwork) {
      mWifiNative.removeNetwork(netId);
      loge("Failed to set a network variable, removed network: " + netId);
    }
    return new NetworkUpdateResult(INVALID_NETWORK_ID);
  }
  WifiConfiguration currentConfig=mConfiguredNetworks.get(netId);
  if (currentConfig == null) {
    currentConfig=new WifiConfiguration();
    currentConfig.ipAssignment=IpAssignment.DHCP;
    currentConfig.proxySettings=ProxySettings.NONE;
    currentConfig.networkId=netId;
  }
  readNetworkVariables(currentConfig);
  mConfiguredNetworks.put(netId,currentConfig);
  mNetworkIds.put(configKey(currentConfig),netId);
  NetworkUpdateResult result=writeIpAndProxyConfigurationsOnChange(currentConfig,config);
  result.setIsNewNetwork(newNetwork);
  result.setNetworkId(netId);
  return result;
}
