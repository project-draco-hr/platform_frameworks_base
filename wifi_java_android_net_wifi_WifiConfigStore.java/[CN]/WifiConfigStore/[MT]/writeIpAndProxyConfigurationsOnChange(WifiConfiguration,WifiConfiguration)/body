{
  boolean ipChanged=false;
  boolean proxyChanged=false;
  LinkProperties linkProperties=new LinkProperties();
switch (newConfig.ipAssignment) {
case STATIC:
    Collection<LinkAddress> currentLinkAddresses=currentConfig.linkProperties.getLinkAddresses();
  Collection<LinkAddress> newLinkAddresses=newConfig.linkProperties.getLinkAddresses();
Collection<InetAddress> currentDnses=currentConfig.linkProperties.getDnses();
Collection<InetAddress> newDnses=newConfig.linkProperties.getDnses();
InetAddress currentGateway=currentConfig.linkProperties.getGateway();
InetAddress newGateway=newConfig.linkProperties.getGateway();
boolean linkAddressesDiffer=!currentLinkAddresses.containsAll(newLinkAddresses) || (currentLinkAddresses.size() != newLinkAddresses.size());
boolean dnsesDiffer=!currentDnses.containsAll(newDnses) || (currentDnses.size() != newDnses.size());
boolean gatewaysDiffer=(currentGateway == null) || !currentGateway.equals(newGateway);
if ((currentConfig.ipAssignment != newConfig.ipAssignment) || linkAddressesDiffer || dnsesDiffer|| gatewaysDiffer) {
ipChanged=true;
}
break;
case DHCP:
if (currentConfig.ipAssignment != newConfig.ipAssignment) {
ipChanged=true;
}
break;
case UNASSIGNED:
break;
default :
Log.e(TAG,"Ignore invalid ip assignment during write");
break;
}
switch (newConfig.proxySettings) {
case STATIC:
ProxyProperties newHttpProxy=newConfig.linkProperties.getHttpProxy();
ProxyProperties currentHttpProxy=currentConfig.linkProperties.getHttpProxy();
if (newHttpProxy != null) {
proxyChanged=!newHttpProxy.equals(currentHttpProxy);
}
 else {
proxyChanged=(currentHttpProxy != null);
}
break;
case NONE:
if (currentConfig.proxySettings != newConfig.proxySettings) {
proxyChanged=true;
}
break;
case UNASSIGNED:
break;
default :
Log.e(TAG,"Ignore invalid proxy configuration during write");
break;
}
if (!ipChanged) {
addIpSettingsFromConfig(linkProperties,currentConfig);
}
 else {
currentConfig.ipAssignment=newConfig.ipAssignment;
addIpSettingsFromConfig(linkProperties,newConfig);
Log.d(TAG,"IP config changed SSID = " + currentConfig.SSID + " linkProperties: "+ linkProperties.toString());
}
if (!proxyChanged) {
linkProperties.setHttpProxy(currentConfig.linkProperties.getHttpProxy());
}
 else {
currentConfig.proxySettings=newConfig.proxySettings;
linkProperties.setHttpProxy(newConfig.linkProperties.getHttpProxy());
Log.d(TAG,"proxy changed SSID = " + currentConfig.SSID);
if (linkProperties.getHttpProxy() != null) {
Log.d(TAG," proxyProperties: " + linkProperties.getHttpProxy().toString());
}
}
if (ipChanged || proxyChanged) {
currentConfig.linkProperties=linkProperties;
writeIpAndProxyConfigurations();
sendConfigChangeBroadcast();
}
}
