{
  final boolean isRtl=heuristic.isRtl(str,0,str.length());
  String origStr=str;
  str=TextUtils.htmlEncode(str);
  StringBuilder result=new StringBuilder();
  if (getStereoReset() && isolate) {
    result.append(markBefore(origStr,isRtl ? TextDirectionHeuristics.RTL : TextDirectionHeuristics.LTR));
  }
  if (isRtl != mIsRtlContext) {
    result.append("<span ").append(dirAttr(isRtl)).append('>').append(str).append("</span>");
  }
 else {
    result.append(str);
  }
  if (isolate) {
    result.append(markAfter(origStr,isRtl ? TextDirectionHeuristics.RTL : TextDirectionHeuristics.LTR));
  }
  return result.toString();
}
