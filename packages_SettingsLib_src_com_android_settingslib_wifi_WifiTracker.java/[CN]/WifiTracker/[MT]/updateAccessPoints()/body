{
  List<AccessPoint> cachedAccessPoints=getAccessPoints();
  ArrayList<AccessPoint> accessPoints=new ArrayList<>();
  for (  AccessPoint accessPoint : cachedAccessPoints) {
    accessPoint.clearConfig();
  }
  Multimap<String,AccessPoint> apMap=new Multimap<String,AccessPoint>();
  WifiConfiguration connectionConfig=null;
  if (mLastInfo != null) {
    connectionConfig=getWifiConfigurationForNetworkId(mLastInfo.getNetworkId());
  }
  final Collection<ScanResult> results=fetchScanResults();
  final List<WifiConfiguration> configs=mWifiManager.getConfiguredNetworks();
  if (configs != null) {
    mSavedNetworksExist=configs.size() != 0;
    for (    WifiConfiguration config : configs) {
      if (config.selfAdded && config.numAssociation == 0) {
        continue;
      }
      AccessPoint accessPoint=getCachedOrCreate(config,cachedAccessPoints);
      if (mLastInfo != null && mLastNetworkInfo != null) {
        if (config.isPasspoint() == false) {
          accessPoint.update(connectionConfig,mLastInfo,mLastNetworkInfo);
        }
      }
      if (mIncludeSaved) {
        if (!config.isPasspoint() || mIncludePasspoints) {
          boolean apFound=false;
          for (          ScanResult result : results) {
            if (result.SSID.equals(accessPoint.getSsidStr())) {
              apFound=true;
              break;
            }
          }
          if (!apFound) {
            accessPoint.setRssi(Integer.MAX_VALUE);
          }
          accessPoints.add(accessPoint);
        }
        if (config.isPasspoint() == false) {
          apMap.put(accessPoint.getSsidStr(),accessPoint);
        }
      }
 else {
        cachedAccessPoints.add(accessPoint);
      }
    }
  }
  if (results != null) {
    for (    ScanResult result : results) {
      if (result.SSID == null || result.SSID.length() == 0 || result.capabilities.contains("[IBSS]")) {
        continue;
      }
      boolean found=false;
      for (      AccessPoint accessPoint : apMap.getAll(result.SSID)) {
        if (accessPoint.update(result)) {
          found=true;
          break;
        }
      }
      if (!found && mIncludeScans) {
        AccessPoint accessPoint=getCachedOrCreate(result,cachedAccessPoints);
        if (mLastInfo != null && mLastNetworkInfo != null) {
          accessPoint.update(connectionConfig,mLastInfo,mLastNetworkInfo);
        }
        if (result.isPasspointNetwork()) {
          WifiConfiguration config=mWifiManager.getMatchingWifiConfig(result);
          if (config != null) {
            accessPoint.update(config);
          }
        }
        if (mLastInfo != null && mLastInfo.getBSSID() != null && mLastInfo.getBSSID().equals(result.BSSID) && connectionConfig != null && connectionConfig.isPasspoint()) {
          accessPoint.update(connectionConfig);
        }
        accessPoints.add(accessPoint);
        apMap.put(accessPoint.getSsidStr(),accessPoint);
      }
    }
  }
  Collections.sort(accessPoints);
  if (DBG)   Log.d(TAG,"------ Dumping SSIDs that were not seen on this scan ------");
  for (  AccessPoint prevAccessPoint : mAccessPoints) {
    if (prevAccessPoint.getSsid() == null)     continue;
    String prevSsid=prevAccessPoint.getSsidStr();
    boolean found=false;
    for (    AccessPoint newAccessPoint : accessPoints) {
      if (newAccessPoint.getSsid() != null && newAccessPoint.getSsid().equals(prevSsid)) {
        found=true;
        break;
      }
    }
    if (!found)     if (DBG)     Log.d(TAG,"Did not find " + prevSsid + " in this scan");
  }
  if (DBG)   Log.d(TAG,"---- Done dumping SSIDs that were not seen on this scan ----");
  mAccessPoints=accessPoints;
  mMainHandler.sendEmptyMessage(MainHandler.MSG_ACCESS_POINT_CHANGED);
}
