{
  boolean managed=true;
  int userId=UserHandle.USER_CURRENT;
  String opt;
  while ((opt=nextOption()) != null) {
    if (opt.equals("--user")) {
      userId=parseUserArg(nextArgRequired());
      if (userId == UserHandle.USER_ALL) {
        System.err.println("Error: Can't dump heap with user 'all'");
        return;
      }
    }
 else     if (opt.equals("-n")) {
      managed=false;
    }
 else {
      System.err.println("Error: Unknown option: " + opt);
      return;
    }
  }
  String process=nextArgRequired();
  String heapFile=nextArgRequired();
  ParcelFileDescriptor fd=null;
  try {
    File file=new File(heapFile);
    file.delete();
    fd=openForSystemServer(file,ParcelFileDescriptor.MODE_CREATE | ParcelFileDescriptor.MODE_TRUNCATE | ParcelFileDescriptor.MODE_WRITE_ONLY);
  }
 catch (  FileNotFoundException e) {
    System.err.println("Error: Unable to open file: " + heapFile);
    System.err.println("Consider using a file under /data/local/tmp/");
    return;
  }
  if (!mAm.dumpHeap(process,userId,managed,heapFile,fd)) {
    throw new AndroidException("HEAP DUMP FAILED on process " + process);
  }
}
