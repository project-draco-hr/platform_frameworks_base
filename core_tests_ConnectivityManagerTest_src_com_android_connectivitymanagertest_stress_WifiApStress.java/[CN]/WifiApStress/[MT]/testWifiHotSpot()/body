{
  if (mWifiOnlyFlag) {
    logv(getName() + " is excluded for wi-fi only test");
    return;
  }
  WifiConfiguration config=new WifiConfiguration();
  config.SSID=NETWORK_ID;
  config.allowedKeyManagement.set(KeyMgmt.WPA_PSK);
  config.allowedAuthAlgorithms.set(AuthAlgorithm.OPEN);
  config.preSharedKey=PASSWD;
  assertTrue("failed to disable wifi hotspot",mWifiManager.setWifiApEnabled(config,false));
  assertTrue("wifi hotspot not enabled",waitForWifiApState(WifiManager.WIFI_AP_STATE_DISABLED,2 * LONG_TIMEOUT));
  if (mWifiManager.isWifiEnabled()) {
    assertTrue("failed to disable wifi",disableWifi());
    assertTrue("wifi state not disabled",waitForWifiState(WifiManager.WIFI_STATE_DISABLED,LONG_TIMEOUT));
  }
  int i;
  for (i=0; i < mTotalIterations; i++) {
    logv("iteration: " + i);
    mLastIteration=i;
    assertTrue("failed to enable wifi hotspot",mWifiManager.setWifiApEnabled(config,true));
    assertTrue("wifi hotspot not enabled",waitForWifiApState(WifiManager.WIFI_AP_STATE_ENABLED,2 * LONG_TIMEOUT));
    assertTrue("tether state not changed",waitForTetherStateChange(LONG_TIMEOUT));
    try {
      Thread.sleep(2 * SHORT_TIMEOUT);
    }
 catch (    Exception e) {
    }
    assertTrue("no uplink data connection after Wi-Fi tethering",pingTest());
    assertTrue("failed to disable wifi hotspot",mWifiManager.setWifiApEnabled(config,false));
    assertTrue("wifi hotspot not enabled",waitForWifiApState(WifiManager.WIFI_AP_STATE_DISABLED,2 * LONG_TIMEOUT));
    assertFalse("wifi hotspot still enabled",mWifiManager.isWifiApEnabled());
  }
}
