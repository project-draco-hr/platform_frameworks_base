{
  if (DEBUG)   Slog.d(TAG,"rebindServices");
  final int[] userIds=mUserProfiles.getCurrentProfileIds();
  final int nUserIds=userIds.length;
  final SparseArray<ArraySet<ComponentName>> componentsByUser=new SparseArray<>();
  for (int i=0; i < nUserIds; ++i) {
    componentsByUser.put(userIds[i],loadComponentNamesFromSetting(mConfig.secureSettingName,userIds[i]));
  }
  final ArrayList<ManagedServiceInfo> removableBoundServices=new ArrayList<>();
  final SparseArray<Set<ComponentName>> toAdd=new SparseArray<>();
synchronized (mMutex) {
    for (    ManagedServiceInfo service : mServices) {
      if (!service.isSystem && !service.isGuest(this)) {
        removableBoundServices.add(service);
      }
    }
    final ArraySet<ComponentName> newEnabled=new ArraySet<>();
    final ArraySet<String> newPackages=new ArraySet<>();
    for (int i=0; i < nUserIds; ++i) {
      final ArraySet<ComponentName> userComponents=componentsByUser.get(userIds[i]);
      if (null == userComponents) {
        toAdd.put(userIds[i],new HashSet<ComponentName>());
        continue;
      }
      final Set<ComponentName> add=new HashSet<>(userComponents);
      for (      Entry<String,Boolean> e : mCategoryEnabled.entrySet()) {
        if (!e.getValue()) {
          Set<ComponentName> c=queryPackageForServices(null,userIds[i],e.getKey());
          add.removeAll(c);
        }
      }
      add.removeAll(mSnoozingForCurrentProfiles);
      toAdd.put(userIds[i],add);
      newEnabled.addAll(userComponents);
      for (int j=0; j < userComponents.size(); j++) {
        final ComponentName component=userComponents.valueAt(j);
        newPackages.add(component.getPackageName());
      }
    }
    mEnabledServicesForCurrentProfiles=newEnabled;
    mEnabledServicesPackageNames=newPackages;
  }
  for (  ManagedServiceInfo info : removableBoundServices) {
    final ComponentName component=info.component;
    final int oldUser=info.userid;
    final Set<ComponentName> allowedComponents=toAdd.get(info.userid);
    if (allowedComponents != null) {
      if (allowedComponents.contains(component)) {
        allowedComponents.remove(component);
      }
 else {
        Slog.v(TAG,"disabling " + getCaption() + " for user "+ oldUser+ ": "+ component);
        unregisterService(component,oldUser);
      }
    }
  }
  for (int i=0; i < nUserIds; ++i) {
    final Set<ComponentName> add=toAdd.get(userIds[i]);
    for (    ComponentName component : add) {
      Slog.v(TAG,"enabling " + getCaption() + " for user "+ userIds[i]+ ": "+ component);
      registerService(component,userIds[i]);
    }
  }
  mLastSeenProfileIds=userIds;
}
