{
  final SQLiteDatabase database=mDatabase.getSQLiteDatabase();
  boolean added=false;
  database.beginTransaction();
  try {
    for (    final ContentValues values : valuesList) {
      final Cursor candidateCursor=database.query(TABLE_DOCUMENTS,strings(Document.COLUMN_DOCUMENT_ID),selection + " AND " + COLUMN_ROW_STATE+ "=? AND "+ mappingKey+ "=?",strings(arg,ROW_STATE_INVALIDATED,values.getAsString(mappingKey)),null,null,null,"1");
      try {
        final long rowId;
        if (candidateCursor.getCount() == 0) {
          rowId=database.insert(TABLE_DOCUMENTS,null,values);
          if (rowId == -1) {
            throw new SQLiteException("Failed to put a document into database.");
          }
          added=true;
        }
 else         if (!heuristic) {
          candidateCursor.moveToNext();
          final String documentId=candidateCursor.getString(0);
          rowId=database.update(TABLE_DOCUMENTS,values,SELECTION_DOCUMENT_ID,strings(documentId));
        }
 else {
          values.put(COLUMN_ROW_STATE,ROW_STATE_PENDING);
          rowId=database.insert(TABLE_DOCUMENTS,null,values);
        }
        values.put(Document.COLUMN_DOCUMENT_ID,rowId);
      }
  finally {
        candidateCursor.close();
      }
    }
    database.setTransactionSuccessful();
    return added;
  }
  finally {
    database.endTransaction();
  }
}
