{
  Preconditions.checkState(!mMappingMode.containsKey(parentDocumentId));
  final String selection;
  final String[] args;
  if (parentDocumentId != null) {
    selection=COLUMN_PARENT_DOCUMENT_ID + " = ?";
    args=strings(parentDocumentId);
  }
 else {
    selection=COLUMN_PARENT_DOCUMENT_ID + " IS NULL";
    args=new String[0];
  }
  final SQLiteDatabase database=mDatabase.getSQLiteDatabase();
  database.beginTransaction();
  try {
    mDatabase.deleteDocumentsAndRootsRecursively(selection + " AND " + COLUMN_ROW_STATE+ "=?",DatabaseUtils.appendSelectionArgs(args,strings(ROW_STATE_PENDING)));
    final ContentValues values=new ContentValues();
    values.put(COLUMN_ROW_STATE,ROW_STATE_INVALIDATED);
    database.update(TABLE_DOCUMENTS,values,selection,args);
    final boolean useNameForResolving=DatabaseUtils.queryNumEntries(database,TABLE_DOCUMENTS,selection + " AND " + COLUMN_STORAGE_ID+ " IS NULL",args) > 0;
    database.setTransactionSuccessful();
    mMappingMode.put(parentDocumentId,useNameForResolving ? MAP_BY_NAME : MAP_BY_MTP_IDENTIFIER);
  }
  finally {
    database.endTransaction();
  }
}
