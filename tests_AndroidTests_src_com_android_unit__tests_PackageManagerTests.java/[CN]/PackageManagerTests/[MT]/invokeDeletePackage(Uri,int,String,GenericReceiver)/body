{
  DeleteObserver observer=new DeleteObserver();
  final boolean received=false;
  mContext.registerReceiver(receiver,receiver.filter);
  try {
synchronized (observer) {
synchronized (receiver) {
        getPm().deletePackage(pkgName,observer,flags);
        long waitTime=0;
        while ((!observer.isDone()) && (waitTime < MAX_WAIT_TIME)) {
          observer.wait(WAIT_TIME_INCR);
          waitTime+=WAIT_TIME_INCR;
        }
        if (!observer.isDone()) {
          throw new Exception("Timed out waiting for packageInstalled callback");
        }
        waitTime=0;
        while ((!receiver.isDone()) && (waitTime < MAX_WAIT_TIME)) {
          receiver.wait(WAIT_TIME_INCR);
          waitTime+=WAIT_TIME_INCR;
        }
        if (!receiver.isDone()) {
          throw new Exception("Timed out waiting for PACKAGE_REMOVED notification");
        }
        return receiver.received;
      }
    }
  }
  finally {
    mContext.unregisterReceiver(receiver);
  }
}
