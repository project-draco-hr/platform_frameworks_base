{
  int foregroundUser;
  int callingUser=UserHandle.getCallingUserId();
  int callingUid=Binder.getCallingUid();
  long callingIdentity=Binder.clearCallingIdentity();
  UserManager um=(UserManager)mContext.getSystemService(Context.USER_SERVICE);
  UserInfo ui=um.getProfileParent(callingUser);
  int parentUser=(ui != null) ? ui.id : UserHandle.USER_NULL;
  int callingAppId=UserHandle.getAppId(callingUid);
  boolean valid=false;
  try {
    foregroundUser=ActivityManager.getCurrentUser();
    valid=(callingUser == foregroundUser) || parentUser == foregroundUser || callingAppId == Process.NFC_UID || callingAppId == mSystemUiUid;
    if (DBG) {
      Slog.d(TAG,"checkIfCallerIsForegroundUser: valid=" + valid + " callingUser="+ callingUser+ " parentUser="+ parentUser+ " foregroundUser="+ foregroundUser);
    }
  }
  finally {
    Binder.restoreCallingIdentity(callingIdentity);
  }
  return valid;
}
