{
  SyncStorageEngine.init(context);
  mSyncStorageEngine=SyncStorageEngine.getSingleton();
  mSyncQueue=new SyncQueue(mSyncStorageEngine);
  mContext=context;
  mSyncThread=new HandlerThread("SyncHandlerThread",Process.THREAD_PRIORITY_BACKGROUND);
  mSyncThread.start();
  mSyncHandler=new SyncHandler(mSyncThread.getLooper());
  mPackageManager=null;
  mSyncAlarmIntent=PendingIntent.getBroadcast(mContext,0,new Intent(ACTION_SYNC_ALARM),0);
  mSyncPollAlarmIntent=PendingIntent.getBroadcast(mContext,0,new Intent(SYNC_POLL_ALARM),0);
  IntentFilter intentFilter=new IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION);
  context.registerReceiver(mConnectivityIntentReceiver,intentFilter);
  intentFilter=new IntentFilter(Intent.ACTION_DEVICE_STORAGE_LOW);
  intentFilter.addAction(Intent.ACTION_DEVICE_STORAGE_OK);
  context.registerReceiver(mStorageIntentReceiver,intentFilter);
  if (!factoryTest) {
    mNotificationMgr=(NotificationManager)context.getSystemService(Context.NOTIFICATION_SERVICE);
    context.registerReceiver(new SyncAlarmIntentReceiver(),new IntentFilter(ACTION_SYNC_ALARM));
  }
 else {
    mNotificationMgr=null;
  }
  PowerManager pm=(PowerManager)context.getSystemService(Context.POWER_SERVICE);
  mSyncWakeLock=pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,SYNC_WAKE_LOCK);
  mSyncWakeLock.setReferenceCounted(false);
  mHandleAlarmWakeLock=pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,HANDLE_SYNC_ALARM_WAKE_LOCK);
  mHandleAlarmWakeLock.setReferenceCounted(false);
  if (!factoryTest) {
    AccountMonitorListener listener=new AccountMonitorListener(){
      public void onAccountsUpdated(      String[] accounts){
        final boolean hadAccountsAlready=mAccounts != null;
        String[] newAccounts=new String[accounts.length];
        System.arraycopy(accounts,0,newAccounts,0,accounts.length);
        mAccounts=newAccounts;
        ActiveSyncContext activeSyncContext=mActiveSyncContext;
        if (activeSyncContext != null) {
          if (!ArrayUtils.contains(newAccounts,activeSyncContext.mSyncOperation.account)) {
            Log.d(TAG,"canceling sync since the account has been removed");
            sendSyncFinishedOrCanceledMessage(activeSyncContext,null);
          }
        }
        sendCheckAlarmsMessage();
        mSyncStorageEngine.doDatabaseCleanup(accounts);
        if (hadAccountsAlready && mAccounts.length > 0) {
          startSync(null,null);
        }
      }
    }
;
    mAccountMonitor=new AccountMonitor(context,listener);
  }
}
