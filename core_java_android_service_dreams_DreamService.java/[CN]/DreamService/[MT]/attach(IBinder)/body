{
  if (DEBUG)   Slog.v(TAG,"Attached on thread " + Thread.currentThread().getId());
  if (mSandman == null) {
    Slog.w(TAG,"No dream manager found, super.onCreate may not have been called");
    loadSandman();
  }
  mWindowToken=windowToken;
  mWindow=PolicyManager.makeNewWindow(this);
  mWindow.setCallback(this);
  mWindow.requestFeature(Window.FEATURE_NO_TITLE);
  mWindow.setBackgroundDrawable(new ColorDrawable(0xFF000000));
  if (DEBUG)   Slog.v(TAG,String.format("Attaching window token: %s to window of type %s",windowToken,WindowManager.LayoutParams.TYPE_DREAM));
  WindowManager.LayoutParams lp=mWindow.getAttributes();
  lp.type=WindowManager.LayoutParams.TYPE_DREAM;
  lp.token=windowToken;
  lp.windowAnimations=com.android.internal.R.style.Animation_Dream;
  lp.flags|=(WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED | WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD | WindowManager.LayoutParams.FLAG_ALLOW_LOCK_WHILE_SCREEN_ON| (mScreenBright ? WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON : 0));
  mWindow.setAttributes(lp);
  if (DEBUG)   Slog.v(TAG,"Created and attached window: " + mWindow);
  mWindow.setWindowManager(null,windowToken,"dream",true);
  mWindowManager=mWindow.getWindowManager();
  mHandler.post(new Runnable(){
    @Override public void run(){
      if (DEBUG)       Slog.v(TAG,"Window added on thread " + Thread.currentThread().getId());
      try {
        applySystemUiVisibilityFlags((mLowProfile ? View.SYSTEM_UI_FLAG_LOW_PROFILE : 0) | (mFullscreen ? View.SYSTEM_UI_FLAG_FULLSCREEN : 0),View.SYSTEM_UI_FLAG_LOW_PROFILE | View.SYSTEM_UI_FLAG_FULLSCREEN);
        getWindowManager().addView(mWindow.getDecorView(),mWindow.getAttributes());
      }
 catch (      Throwable t) {
        Slog.w("Crashed adding window view",t);
        safelyFinish();
        return;
      }
      try {
        onStart();
      }
 catch (      Throwable t) {
        Slog.w("Crashed in onStart()",t);
        safelyFinish();
      }
    }
  }
);
}
