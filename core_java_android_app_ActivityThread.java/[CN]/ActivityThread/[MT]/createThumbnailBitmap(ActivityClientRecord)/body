{
  Bitmap thumbnail=null;
  try {
    int w=mThumbnailWidth;
    int h;
    if (w < 0) {
      Resources res=r.activity.getResources();
      mThumbnailHeight=h=res.getDimensionPixelSize(com.android.internal.R.dimen.thumbnail_height);
      mThumbnailWidth=w=res.getDimensionPixelSize(com.android.internal.R.dimen.thumbnail_width);
    }
 else {
      h=mThumbnailHeight;
    }
    if ((w > 0) && (h > 0)) {
      View topView=r.activity.getWindow().getDecorView();
      if (topView.getWidth() >= topView.getHeight()) {
        thumbnail=Bitmap.createBitmap(w,h,THUMBNAIL_FORMAT);
      }
 else {
        thumbnail=Bitmap.createBitmap(h,w,THUMBNAIL_FORMAT);
      }
      thumbnail.eraseColor(0);
      Canvas cv=new Canvas(thumbnail);
      if (!r.activity.onCreateThumbnail(thumbnail,cv)) {
        thumbnail=null;
      }
    }
  }
 catch (  Exception e) {
    if (!mInstrumentation.onException(r.activity,e)) {
      throw new RuntimeException("Unable to create thumbnail of " + r.intent.getComponent().toShortString() + ": "+ e.toString(),e);
    }
    thumbnail=null;
  }
  return thumbnail;
}
