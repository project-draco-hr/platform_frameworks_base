{
  if (localLOGV)   Slog.v(TAG,"Performing stop of " + r);
  Bundle state=null;
  if (r != null) {
    if (!keepShown && r.stopped) {
      if (r.activity.mFinished) {
        return;
      }
      RuntimeException e=new RuntimeException("Performing stop of activity that is not resumed: " + r.intent.getComponent().toShortString());
      Slog.e(TAG,e.getMessage(),e);
    }
    if (info != null) {
      try {
        info.thumbnail=createThumbnailBitmap(r);
        info.description=r.activity.onCreateDescription();
      }
 catch (      Exception e) {
        if (!mInstrumentation.onException(r.activity,e)) {
          throw new RuntimeException("Unable to save state of activity " + r.intent.getComponent().toShortString() + ": "+ e.toString(),e);
        }
      }
    }
    if (!r.activity.mFinished && saveState) {
      if (r.state == null) {
        state=new Bundle();
        mInstrumentation.callActivityOnSaveInstanceState(r.activity,state);
        r.state=state;
      }
 else {
        state=r.state;
      }
    }
    if (!keepShown) {
      try {
        r.activity.performStop();
      }
 catch (      Exception e) {
        if (!mInstrumentation.onException(r.activity,e)) {
          throw new RuntimeException("Unable to stop activity " + r.intent.getComponent().toShortString() + ": "+ e.toString(),e);
        }
      }
      r.stopped=true;
    }
    r.paused=true;
  }
}
