{
  ActivityRecord r=performDestroyActivity(token,finishing,configChanges,getNonConfigInstance);
  if (r != null) {
    WindowManager wm=r.activity.getWindowManager();
    View v=r.activity.mDecor;
    if (v != null) {
      if (r.activity.mVisibleFromServer) {
        mNumVisibleActivities--;
      }
      IBinder wtoken=v.getWindowToken();
      if (r.activity.mWindowAdded) {
        wm.removeViewImmediate(v);
      }
      if (wtoken != null) {
        WindowManagerImpl.getDefault().closeAll(wtoken,r.activity.getClass().getName(),"Activity");
      }
      r.activity.mDecor=null;
    }
    WindowManagerImpl.getDefault().closeAll(token,r.activity.getClass().getName(),"Activity");
    Context c=r.activity.getBaseContext();
    if (c instanceof ApplicationContext) {
      ((ApplicationContext)c).scheduleFinalCleanup(r.activity.getClass().getName(),"Activity");
    }
  }
  if (finishing) {
    try {
      ActivityManagerNative.getDefault().activityDestroyed(token);
    }
 catch (    RemoteException ex) {
    }
  }
}
