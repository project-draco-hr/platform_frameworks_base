{
  mHandler.removeMessages(MSG_PROCESS_KEYBOARD_STATE);
  if (!mEnabled) {
    mState=STATE_NOT_ENABLED;
    return;
  }
  if (!mBootCompleted) {
    mState=STATE_WAITING_FOR_BOOT_COMPLETED;
    return;
  }
  if (mInTabletMode != InputManager.SWITCH_STATE_OFF) {
    if (mState == STATE_WAITING_FOR_DEVICE_DISCOVERY) {
      stopScanning();
    }
    mState=STATE_WAITING_FOR_TABLET_MODE_EXIT;
    return;
  }
  final int btState=mLocalBluetoothAdapter.getState();
  if (btState == BluetoothAdapter.STATE_TURNING_ON || btState == BluetoothAdapter.STATE_ON && mState == STATE_WAITING_FOR_BLUETOOTH) {
    mUIHandler.sendEmptyMessage(MSG_DISMISS_BLUETOOTH_DIALOG);
  }
  if (btState == BluetoothAdapter.STATE_TURNING_ON) {
    mState=STATE_WAITING_FOR_BLUETOOTH;
    return;
  }
  if (btState != BluetoothAdapter.STATE_ON) {
    mState=STATE_WAITING_FOR_BLUETOOTH;
    showBluetoothDialog();
    return;
  }
  CachedBluetoothDevice device=getPairedKeyboard();
  if ((mState == STATE_WAITING_FOR_TABLET_MODE_EXIT || mState == STATE_WAITING_FOR_BLUETOOTH) && device != null) {
    mState=STATE_PAIRED;
    device.connect(false);
    return;
  }
  device=getDiscoveredKeyboard();
  if (device != null) {
    mState=STATE_PAIRING;
    device.startPairing();
  }
 else {
    mState=STATE_WAITING_FOR_DEVICE_DISCOVERY;
    startScanning();
  }
}
