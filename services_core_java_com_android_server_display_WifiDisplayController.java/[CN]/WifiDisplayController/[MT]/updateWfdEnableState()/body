{
  if (mWifiDisplayOnSetting && mWifiP2pEnabled) {
    if (!mWfdEnabled && !mWfdEnabling) {
      mWfdEnabling=true;
      WifiP2pWfdInfo wfdInfo=new WifiP2pWfdInfo();
      wfdInfo.setWfdEnabled(true);
      wfdInfo.setDeviceType(WifiP2pWfdInfo.WFD_SOURCE);
      wfdInfo.setSessionAvailable(true);
      wfdInfo.setControlPort(DEFAULT_CONTROL_PORT);
      wfdInfo.setMaxThroughput(MAX_THROUGHPUT);
      mWifiP2pManager.setWFDInfo(mWifiP2pChannel,wfdInfo,new ActionListener(){
        @Override public void onSuccess(){
          if (DEBUG) {
            Slog.d(TAG,"Successfully set WFD info.");
          }
          if (mWfdEnabling) {
            mWfdEnabling=false;
            mWfdEnabled=true;
            reportFeatureState();
            updateScanState();
          }
        }
        @Override public void onFailure(        int reason){
          if (DEBUG) {
            Slog.d(TAG,"Failed to set WFD info with reason " + reason + ".");
          }
          mWfdEnabling=false;
        }
      }
);
    }
  }
 else {
    if (mWfdEnabled || mWfdEnabling) {
      WifiP2pWfdInfo wfdInfo=new WifiP2pWfdInfo();
      wfdInfo.setWfdEnabled(false);
      mWifiP2pManager.setWFDInfo(mWifiP2pChannel,wfdInfo,new ActionListener(){
        @Override public void onSuccess(){
          if (DEBUG) {
            Slog.d(TAG,"Successfully set WFD info.");
          }
        }
        @Override public void onFailure(        int reason){
          if (DEBUG) {
            Slog.d(TAG,"Failed to set WFD info with reason " + reason + ".");
          }
        }
      }
);
    }
    mWfdEnabling=false;
    mWfdEnabled=false;
    reportFeatureState();
    updateScanState();
    disconnect();
  }
}
