{
  try {
    int bytesRead=0;
    int needBytes, offset, bytesInBuffer=0;
    boolean eosReached=false;
    GifGraphicBlock blockToDispose=null;
    if (currBlock == null) {
      currBlock=new GifGraphicBlock();
      gifDataStream.graphicBlocks.add(currBlock);
    }
    for (; ; ) {
      needBytes=BUFFER_SIZE - bytesInBuffer;
      offset=bytesInBuffer;
      bytesRead=inputStream.read(buffer,offset,needBytes);
      if (bytesRead < 0) {
        eosReached=true;
        bytesRead=0;
      }
      bytesInBuffer+=bytesRead;
      int numLines=decode(buffer,bytesRead,hNativeDecoder,gifDataStream,currBlock);
      bytesInBuffer-=bytesConsumed;
      if (!consumersPrepared && gifDataStream.logicalScreen.completed && gifDataStream.logicalScreen.globalColorTable.completed&& (currBlock.imageData != null || currBlock.rgbImageData != null)) {
        prepareConsumers();
        consumersPrepared=true;
      }
      if (bytesConsumed < 0) {
        break;
      }
      if (currBlock != null) {
        if (numLines != 0) {
          if (blockToDispose != null) {
            blockToDispose.dispose();
            blockToDispose=null;
          }
          currBlock.sendNewData(this,numLines);
        }
        if (currBlock.completed && hNativeDecoder != 0) {
          blockToDispose=currBlock;
          currBlock=new GifGraphicBlock();
          gifDataStream.graphicBlocks.add(currBlock);
        }
      }
      if (hNativeDecoder == 0) {
        break;
      }
      if (eosReached && numLines == 0) {
        releaseNativeDecoder(hNativeDecoder);
        break;
      }
    }
  }
  finally {
    closeStream();
  }
  if (gifDataStream.loopCount != 1) {
    if (currBlock.completed == false) {
      gifDataStream.graphicBlocks.remove(currBlock);
    }
    int numFrames=gifDataStream.graphicBlocks.size();
    GifGraphicBlock gb=gifDataStream.graphicBlocks.get(numFrames - 1);
    ImageLoader.beginAnimation();
    while (gifDataStream.loopCount != 1) {
      if (gifDataStream.loopCount != 0) {
        gifDataStream.loopCount--;
      }
      for (int i=0; i < numFrames; i++) {
        gb.dispose();
        gb=gifDataStream.graphicBlocks.get(i);
        if (forceRGB) {
          setPixels(gb.imageLeft,gb.imageTop,gb.imageWidth,gb.imageHeight,ColorModel.getRGBdefault(),gb.getRgbImageData(),0,gb.imageWidth);
        }
 else {
          setPixels(gb.imageLeft,gb.imageTop,gb.imageWidth,gb.imageHeight,null,gb.imageData,0,gb.imageWidth);
        }
      }
    }
    ImageLoader.endAnimation();
  }
  imageComplete(ImageConsumer.STATICIMAGEDONE);
}
