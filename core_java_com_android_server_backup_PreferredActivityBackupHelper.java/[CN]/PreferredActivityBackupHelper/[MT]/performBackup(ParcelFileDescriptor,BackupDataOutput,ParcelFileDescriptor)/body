{
  byte[] payload=null;
  try {
    byte[] oldPayload=readState(oldState);
    IPackageManager pm=AppGlobals.getPackageManager();
    byte[] newPayload=pm.getPreferredActivityBackup(UserHandle.USER_OWNER);
    if (!Arrays.areEqual(oldPayload,newPayload)) {
      if (DEBUG) {
        Slog.i(TAG,"State has changed => writing new preferred app payload");
      }
      data.writeEntityHeader(KEY_PREFERRED,newPayload.length);
      data.writeEntityData(newPayload,newPayload.length);
    }
 else {
      if (DEBUG) {
        Slog.i(TAG,"No change to state => not writing to wire");
      }
    }
    payload=newPayload;
  }
 catch (  Exception e) {
    Slog.w(TAG,"Unable to record preferred activities",e);
  }
 finally {
    writeState(newState,payload);
  }
}
