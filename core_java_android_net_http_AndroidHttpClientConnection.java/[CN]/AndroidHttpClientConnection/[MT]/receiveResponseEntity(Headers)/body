{
  assertOpen();
  BasicHttpEntity entity=new BasicHttpEntity();
  long len=determineLength(headers);
  if (len == ContentLengthStrategy.CHUNKED) {
    entity.setChunked(true);
    entity.setContentLength(-1);
    entity.setContent(new ChunkedInputStream(inbuffer));
  }
 else   if (len == ContentLengthStrategy.IDENTITY) {
    entity.setChunked(false);
    entity.setContentLength(-1);
    entity.setContent(new IdentityInputStream(inbuffer));
  }
 else {
    entity.setChunked(false);
    entity.setContentLength(len);
    entity.setContent(new ContentLengthInputStream(inbuffer,len));
  }
  String contentTypeHeader=headers.getContentType();
  if (contentTypeHeader != null) {
    entity.setContentType(contentTypeHeader);
  }
  String contentEncodingHeader=headers.getContentEncoding();
  if (contentEncodingHeader != null) {
    entity.setContentEncoding(contentEncodingHeader);
  }
  return entity;
}
