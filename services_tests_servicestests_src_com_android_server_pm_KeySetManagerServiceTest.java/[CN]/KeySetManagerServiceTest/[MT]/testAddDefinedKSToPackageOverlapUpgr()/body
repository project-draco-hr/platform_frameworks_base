{
  PackageSetting ps=generateFakePackageSetting("packageA");
  mPackagesMap.put(ps.name,ps);
  ArrayMap<String,ArraySet<PublicKey>> definedKS=new ArrayMap<String,ArraySet<PublicKey>>();
  ArraySet<PublicKey> keys1=new ArraySet<PublicKey>();
  ArraySet<PublicKey> keys2=new ArraySet<PublicKey>();
  PublicKey keyA=PackageParser.parsePublicKey(KeySetStrings.ctsKeySetPublicKeyA);
  PublicKey keyB=PackageParser.parsePublicKey(KeySetStrings.ctsKeySetPublicKeyB);
  keys1.add(keyA);
  keys2.add(keyB);
  definedKS.put("aliasA",keys1);
  definedKS.put("aliasB",keys2);
  mKsms.addDefinedKeySetsToPackageLPw(ps.name,definedKS);
  keys1=new ArraySet<PublicKey>();
  PublicKey keyC=PackageParser.parsePublicKey(KeySetStrings.ctsKeySetPublicKeyC);
  keys1.add(keyC);
  definedKS.remove("aliasA");
  definedKS.put("aliasC",keys1);
  mKsms.addDefinedKeySetsToPackageLPw(ps.name,definedKS);
  assertEquals(1,KeySetUtils.getKeySetRefCount(mKsms,3));
  assertEquals(1,KeySetUtils.getPubKeyRefCount(mKsms,3));
  assertEquals(keyC,KeySetUtils.getPubKey(mKsms,3));
  LongSparseArray<ArraySet<Long>> ksMapping=KeySetUtils.getKeySetMapping(mKsms);
  assertEquals(2,ksMapping.size());
  ArraySet<Long> mapping=ksMapping.get(3);
  assertEquals(1,mapping.size());
  assertTrue(mapping.contains(new Long(3)));
  assertEquals(new Long(3),ps.keySetData.getAliases().get("aliasC"));
  if (1 == KeySetUtils.getKeySetRefCount(mKsms,1)) {
    assertEquals(1,KeySetUtils.getPubKeyRefCount(mKsms,1));
    assertEquals(0,KeySetUtils.getKeySetRefCount(mKsms,2));
    assertEquals(0,KeySetUtils.getPubKeyRefCount(mKsms,2));
    assertEquals(keyB,KeySetUtils.getPubKey(mKsms,1));
    mapping=ksMapping.get(1);
    assertEquals(1,mapping.size());
    assertTrue(mapping.contains(new Long(1)));
    assertEquals(new Long(1),ps.keySetData.getAliases().get("aliasB"));
  }
 else {
    assertEquals(1,KeySetUtils.getKeySetRefCount(mKsms,2));
    assertEquals(1,KeySetUtils.getPubKeyRefCount(mKsms,2));
    assertEquals(0,KeySetUtils.getKeySetRefCount(mKsms,1));
    assertEquals(0,KeySetUtils.getPubKeyRefCount(mKsms,1));
    assertEquals(keyB,KeySetUtils.getPubKey(mKsms,2));
    mapping=ksMapping.get(2);
    assertEquals(1,mapping.size());
    assertTrue(mapping.contains(new Long(2)));
    assertEquals(new Long(2),ps.keySetData.getAliases().get("aliasB"));
  }
  assertNull(ps.keySetData.getAliases().get("aliasA"));
}
