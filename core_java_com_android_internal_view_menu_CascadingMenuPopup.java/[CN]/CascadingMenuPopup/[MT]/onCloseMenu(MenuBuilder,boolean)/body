{
  int menuIndex=-1;
  boolean wasSelected=false;
  for (int i=0; i < mListViews.size(); i++) {
    ListView view=mListViews.get(i);
    MenuAdapter adapter=toMenuAdapter(view.getAdapter());
    if (menuIndex == -1 && menu == adapter.mAdapterMenu) {
      menuIndex=i;
      wasSelected=view.getSelectedView() != null;
    }
    if (menuIndex != -1) {
      adapter.mAdapterMenu.removeMenuPresenter(this);
    }
  }
  if (menuIndex != -1) {
    for (int i=menuIndex; i < mPopupWindows.size(); i++) {
      mPopupWindows.get(i).dismiss();
    }
    mPopupWindows.subList(menuIndex,mPopupWindows.size()).clear();
    mListViews.subList(menuIndex,mListViews.size()).clear();
    mOffsets.subList(menuIndex,mOffsets.size()).clear();
    mPositions.subList(menuIndex,mPositions.size()).clear();
    if (mPositions.size() > 0) {
      mLastPosition=mPositions.get(mPositions.size() - 1);
    }
 else {
      mLastPosition=getInitialMenuPosition();
    }
  }
  if (mListViews.size() == 0 || wasSelected) {
    dismiss();
    if (mPresenterCallback != null) {
      mPresenterCallback.onCloseMenu(menu,allMenusAreClosing);
    }
  }
  if (mPopupWindows.size() == 0) {
    if (mTreeObserver != null) {
      if (mTreeObserver.isAlive()) {
        mTreeObserver.removeGlobalOnLayoutListener(mGlobalLayoutListener);
      }
      mTreeObserver=null;
    }
    mShownAnchorView.removeOnAttachStateChangeListener(mAttachStateChangeListener);
    mOnDismissListener.onDismiss();
  }
}
