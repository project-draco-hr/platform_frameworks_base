{
  final VMRuntime runtime=VMRuntime.getRuntime();
  InputStream is=ZygoteInit.class.getClassLoader().getResourceAsStream(PRELOADED_CLASSES);
  if (is == null) {
    Log.e(TAG,"Couldn't find " + PRELOADED_CLASSES + ".");
  }
 else {
    Log.i(TAG,"Preloading classes...");
    long startTime=SystemClock.uptimeMillis();
    setEffectiveGroup(UNPRIVILEGED_GID);
    setEffectiveUser(UNPRIVILEGED_UID);
    float defaultUtilization=runtime.getTargetHeapUtilization();
    runtime.setTargetHeapUtilization(0.8f);
    runtime.gcSoftReferences();
    runtime.runFinalizationSync();
    Debug.startAllocCounting();
    try {
      BufferedReader br=new BufferedReader(new InputStreamReader(is),256);
      int count=0;
      String line;
      String missingClasses=null;
      while ((line=br.readLine()) != null) {
        line=line.trim();
        if (line.startsWith("#") || line.equals("")) {
          continue;
        }
        try {
          if (Config.LOGV) {
            Log.v(TAG,"Preloading " + line + "...");
          }
          Class.forName(line);
          if (Debug.getGlobalAllocSize() > PRELOAD_GC_THRESHOLD) {
            if (Config.LOGV) {
              Log.v(TAG," GC at " + Debug.getGlobalAllocSize());
            }
            runtime.gcSoftReferences();
            runtime.runFinalizationSync();
            Debug.resetGlobalAllocSize();
          }
          count++;
        }
 catch (        ClassNotFoundException e) {
          Log.e(TAG,"Class not found for preloading: " + line);
          if (missingClasses == null) {
            missingClasses=line;
          }
 else {
            missingClasses+=" " + line;
          }
        }
catch (        Throwable t) {
          Log.e(TAG,"Error preloading " + line + ".",t);
          if (t instanceof Error) {
            throw (Error)t;
          }
          if (t instanceof RuntimeException) {
            throw (RuntimeException)t;
          }
          throw new RuntimeException(t);
        }
      }
      if (missingClasses != null && "1".equals(SystemProperties.get("persist.service.adb.enable"))) {
        throw new IllegalStateException("Missing class(es) for preloading, update preloaded-classes [" + missingClasses + "]");
      }
      Log.i(TAG,"...preloaded " + count + " classes in "+ (SystemClock.uptimeMillis() - startTime)+ "ms.");
    }
 catch (    IOException e) {
      Log.e(TAG,"Error reading " + PRELOADED_CLASSES + ".",e);
    }
 finally {
      runtime.setTargetHeapUtilization(defaultUtilization);
      Debug.stopAllocCounting();
      setEffectiveUser(ROOT_UID);
      setEffectiveGroup(ROOT_GID);
    }
  }
}
