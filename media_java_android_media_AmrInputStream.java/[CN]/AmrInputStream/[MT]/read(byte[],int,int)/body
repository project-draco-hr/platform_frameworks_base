{
  if (mGae == 0)   throw new IllegalStateException("not open");
  if (mBufOut >= mBufIn) {
    mBufOut=0;
    mBufIn=0;
    for (int i=0; i < SAMPLES_PER_FRAME * 2; ) {
      int n=mInputStream.read(mBuf,i,SAMPLES_PER_FRAME * 2 - i);
      if (n == -1)       return -1;
      i+=n;
    }
    mBufIn=GsmAmrEncoderEncode(mGae,mBuf,0,mBuf,0);
  }
  if (length > mBufIn - mBufOut)   length=mBufIn - mBufOut;
  System.arraycopy(mBuf,mBufOut,b,offset,length);
  mBufOut+=length;
  return length;
}
