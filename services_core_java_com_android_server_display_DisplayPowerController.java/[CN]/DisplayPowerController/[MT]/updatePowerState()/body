{
  final boolean mustNotify;
  boolean mustInitialize=false;
  boolean wasDimOrDoze=false;
  boolean autoBrightnessAdjustmentChanged=false;
synchronized (mLock) {
    mPendingUpdatePowerStateLocked=false;
    if (mPendingRequestLocked == null) {
      return;
    }
    if (mPowerRequest == null) {
      mPowerRequest=new DisplayPowerRequest(mPendingRequestLocked);
      mWaitingForNegativeProximity=mPendingWaitForNegativeProximityLocked;
      mPendingWaitForNegativeProximityLocked=false;
      mPendingRequestChangedLocked=false;
      mustInitialize=true;
    }
 else     if (mPendingRequestChangedLocked) {
      wasDimOrDoze=(mPowerRequest.screenState == DisplayPowerRequest.SCREEN_STATE_DIM || mPowerRequest.screenState == DisplayPowerRequest.SCREEN_STATE_DOZE);
      autoBrightnessAdjustmentChanged=(mPowerRequest.screenAutoBrightnessAdjustment != mPendingRequestLocked.screenAutoBrightnessAdjustment);
      mPowerRequest.copyFrom(mPendingRequestLocked);
      mWaitingForNegativeProximity|=mPendingWaitForNegativeProximityLocked;
      mPendingWaitForNegativeProximityLocked=false;
      mPendingRequestChangedLocked=false;
      mDisplayReadyLocked=false;
    }
    mustNotify=!mDisplayReadyLocked;
  }
  if (mustInitialize) {
    initialize();
  }
  if (mProximitySensor != null) {
    if (mPowerRequest.useProximitySensor && mPowerRequest.screenState != DisplayPowerRequest.SCREEN_STATE_OFF) {
      setProximitySensorEnabled(true);
      if (!mScreenOffBecauseOfProximity && mProximity == PROXIMITY_POSITIVE) {
        mScreenOffBecauseOfProximity=true;
        sendOnProximityPositiveWithWakelock();
      }
    }
 else     if (mWaitingForNegativeProximity && mScreenOffBecauseOfProximity && mProximity == PROXIMITY_POSITIVE && mPowerRequest.screenState != DisplayPowerRequest.SCREEN_STATE_OFF) {
      setProximitySensorEnabled(true);
    }
 else {
      setProximitySensorEnabled(false);
      mWaitingForNegativeProximity=false;
    }
    if (mScreenOffBecauseOfProximity && mProximity != PROXIMITY_POSITIVE) {
      mScreenOffBecauseOfProximity=false;
      sendOnProximityNegativeWithWakelock();
    }
  }
 else {
    mWaitingForNegativeProximity=false;
  }
  if (mAutomaticBrightnessController != null) {
    mAutomaticBrightnessController.updatePowerState(mPowerRequest);
  }
  if (mPowerRequest.wantScreenOnAny()) {
    int target;
    boolean slow;
    int screenAutoBrightness=mAutomaticBrightnessController != null ? mAutomaticBrightnessController.getAutomaticScreenBrightness() : -1;
    if (screenAutoBrightness >= 0 && mPowerRequest.useAutoBrightness) {
      target=screenAutoBrightness;
      slow=mUsingScreenAutoBrightness && !autoBrightnessAdjustmentChanged;
      mUsingScreenAutoBrightness=true;
    }
 else {
      target=mPowerRequest.screenBrightness;
      slow=false;
      mUsingScreenAutoBrightness=false;
    }
    if (mPowerRequest.screenState == DisplayPowerRequest.SCREEN_STATE_DOZE) {
      target=mScreenBrightnessDozeConfig;
      slow=false;
    }
 else     if (mPowerRequest.screenState == DisplayPowerRequest.SCREEN_STATE_DIM) {
      target=Math.min(target - SCREEN_DIM_MINIMUM_REDUCTION,mScreenBrightnessDimConfig);
      slow=false;
    }
 else     if (wasDimOrDoze) {
      slow=false;
    }
    if (mPowerRequest.lowPowerMode) {
      target=target / 2;
    }
    animateScreenBrightness(clampScreenBrightness(target),slow ? BRIGHTNESS_RAMP_RATE_SLOW : BRIGHTNESS_RAMP_RATE_FAST);
  }
 else {
    mUsingScreenAutoBrightness=false;
  }
  if (mScreenOffBecauseOfProximity) {
    setScreenState(Display.STATE_OFF);
    unblockScreenOn();
  }
 else   if (mPowerRequest.wantScreenOnAny()) {
    if (!mElectronBeamOffAnimator.isStarted()) {
      if (mPowerRequest.screenState == DisplayPowerRequest.SCREEN_STATE_DOZE) {
        if (!mScreenBrightnessRampAnimator.isAnimating()) {
          setScreenState(Display.STATE_DOZING);
        }
      }
 else {
        setScreenState(Display.STATE_ON);
      }
      if (mPowerRequest.blockScreenOn && mPowerState.getElectronBeamLevel() == 0.0f) {
        blockScreenOn();
      }
 else {
        unblockScreenOn();
        if (USE_ELECTRON_BEAM_ON_ANIMATION) {
          if (!mElectronBeamOnAnimator.isStarted()) {
            if (mPowerState.getElectronBeamLevel() == 1.0f) {
              mPowerState.dismissElectronBeam();
            }
 else             if (mPowerState.prepareElectronBeam(mElectronBeamFadesConfig ? ElectronBeam.MODE_FADE : ElectronBeam.MODE_WARM_UP)) {
              mElectronBeamOnAnimator.start();
            }
 else {
              mElectronBeamOnAnimator.end();
            }
          }
        }
 else {
          mPowerState.setElectronBeamLevel(1.0f);
          mPowerState.dismissElectronBeam();
        }
      }
    }
  }
 else {
    unblockScreenOn();
    if (!mElectronBeamOnAnimator.isStarted()) {
      if (!mElectronBeamOffAnimator.isStarted()) {
        if (mPowerState.getElectronBeamLevel() == 0.0f) {
          setScreenState(Display.STATE_OFF);
        }
 else         if (mPowerState.prepareElectronBeam(mElectronBeamFadesConfig ? ElectronBeam.MODE_FADE : ElectronBeam.MODE_COOL_DOWN) && mPowerState.getScreenState() != Display.STATE_OFF) {
          mElectronBeamOffAnimator.start();
        }
 else {
          mElectronBeamOffAnimator.end();
        }
      }
    }
  }
  if (mustNotify && !mScreenOnWasBlocked && !mElectronBeamOnAnimator.isStarted()&& !mElectronBeamOffAnimator.isStarted()&& !mScreenBrightnessRampAnimator.isAnimating()&& mPowerState.waitUntilClean(mCleanListener)) {
synchronized (mLock) {
      if (!mPendingRequestChangedLocked) {
        mDisplayReadyLocked=true;
        if (DEBUG) {
          Slog.d(TAG,"Display ready!");
        }
      }
    }
    sendOnStateChangedWithWakelock();
  }
}
