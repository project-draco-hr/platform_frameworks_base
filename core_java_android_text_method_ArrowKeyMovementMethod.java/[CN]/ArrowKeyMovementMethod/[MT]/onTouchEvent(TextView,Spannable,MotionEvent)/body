{
  int initialScrollX=-1, initialScrollY=-1;
  if (event.getAction() == MotionEvent.ACTION_UP) {
    initialScrollX=Touch.getInitialScrollX(widget,buffer);
    initialScrollY=Touch.getInitialScrollY(widget,buffer);
  }
  boolean handled=Touch.onTouchEvent(widget,buffer,event);
  if (widget.isFocused() && !widget.didTouchFocusSelect()) {
    if (event.getAction() == MotionEvent.ACTION_UP) {
      if ((initialScrollY >= 0 && initialScrollY != widget.getScrollY()) || (initialScrollX >= 0 && initialScrollX != widget.getScrollX())) {
        widget.moveCursorToVisibleOffset();
        return true;
      }
      int x=(int)event.getX();
      int y=(int)event.getY();
      x-=widget.getTotalPaddingLeft();
      y-=widget.getTotalPaddingTop();
      if (x < 0) {
        x=0;
      }
 else       if (x >= (widget.getWidth() - widget.getTotalPaddingRight())) {
        x=widget.getWidth() - widget.getTotalPaddingRight() - 1;
      }
      if (y < 0) {
        y=0;
      }
 else       if (y >= (widget.getHeight() - widget.getTotalPaddingBottom())) {
        y=widget.getHeight() - widget.getTotalPaddingBottom() - 1;
      }
      x+=widget.getScrollX();
      y+=widget.getScrollY();
      Layout layout=widget.getLayout();
      int line=layout.getLineForVertical(y);
      int off=layout.getOffsetForHorizontal(line,x);
      boolean cap=(MetaKeyKeyListener.getMetaState(buffer,KeyEvent.META_SHIFT_ON) == 1) || (MetaKeyKeyListener.getMetaState(buffer,MetaKeyKeyListener.META_SELECTING) != 0);
      if (cap) {
        Selection.extendSelection(buffer,off);
      }
 else {
        Selection.setSelection(buffer,off);
      }
      MetaKeyKeyListener.adjustMetaAfterKeypress(buffer);
      MetaKeyKeyListener.resetLockedMeta(buffer);
      return true;
    }
  }
  return handled;
}
