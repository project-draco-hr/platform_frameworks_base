{
  x-=widget.getTotalPaddingLeft();
  y-=widget.getTotalPaddingTop();
  if (x < 0) {
    x=0;
  }
 else   if (x >= (widget.getWidth() - widget.getTotalPaddingRight())) {
    x=widget.getWidth() - widget.getTotalPaddingRight() - 1;
  }
  if (y < 0) {
    y=0;
  }
 else   if (y >= (widget.getHeight() - widget.getTotalPaddingBottom())) {
    y=widget.getHeight() - widget.getTotalPaddingBottom() - 1;
  }
  x+=widget.getScrollX();
  y+=widget.getScrollY();
  Layout layout=widget.getLayout();
  int line=layout.getLineForVertical(y);
  int offset=layout.getOffsetForHorizontal(line,x);
  return offset;
}
