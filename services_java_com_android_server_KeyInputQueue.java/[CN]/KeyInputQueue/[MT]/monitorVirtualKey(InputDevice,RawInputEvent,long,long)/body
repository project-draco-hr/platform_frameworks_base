{
  VirtualKey vk=mPressedVirtualKey;
  if (vk == null) {
    return false;
  }
  final InputDevice.MotionState ms=di.mAbs;
  if (ms.mNextNumPointers <= 0) {
    mPressedVirtualKey=null;
    ms.mLastNumPointers=0;
    if (DEBUG_VIRTUAL_KEYS)     Log.v(TAG,"Generate key up for: " + vk.scancode);
    KeyEvent event=newKeyEvent(di,di.mKeyDownTime,curTime,false,vk.lastKeycode,0,vk.scancode,KeyEvent.FLAG_VIRTUAL_HARD_KEY);
    mHapticFeedbackCallback.virtualKeyFeedback(event);
    addLocked(di,curTimeNano,ev.flags,RawInputEvent.CLASS_KEYBOARD,event);
    return true;
  }
 else   if (isInsideDisplay(di)) {
    mPressedVirtualKey=null;
    if (DEBUG_VIRTUAL_KEYS)     Log.v(TAG,"Cancel key up for: " + vk.scancode);
    KeyEvent event=newKeyEvent(di,di.mKeyDownTime,curTime,false,vk.lastKeycode,0,vk.scancode,KeyEvent.FLAG_CANCELED | KeyEvent.FLAG_VIRTUAL_HARD_KEY);
    mHapticFeedbackCallback.virtualKeyFeedback(event);
    addLocked(di,curTimeNano,ev.flags,RawInputEvent.CLASS_KEYBOARD,event);
    ms.mLastNumPointers=0;
    return false;
  }
  return true;
}
