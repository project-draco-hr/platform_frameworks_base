{
  int mask;
switch (keycode) {
case KeyEvent.KEYCODE_ALT_LEFT:
    mask=KeyEvent.META_ALT_LEFT_ON;
  break;
case KeyEvent.KEYCODE_ALT_RIGHT:
mask=KeyEvent.META_ALT_RIGHT_ON;
break;
case KeyEvent.KEYCODE_SHIFT_LEFT:
mask=KeyEvent.META_SHIFT_LEFT_ON;
break;
case KeyEvent.KEYCODE_SHIFT_RIGHT:
mask=KeyEvent.META_SHIFT_RIGHT_ON;
break;
case KeyEvent.KEYCODE_SYM:
mask=KeyEvent.META_SYM_ON;
break;
default :
return old;
}
int result=~(KeyEvent.META_ALT_ON | KeyEvent.META_SHIFT_ON) & (down ? (old | mask) : (old & ~mask));
if (0 != (result & (KeyEvent.META_ALT_LEFT_ON | KeyEvent.META_ALT_RIGHT_ON))) {
result|=KeyEvent.META_ALT_ON;
}
if (0 != (result & (KeyEvent.META_SHIFT_LEFT_ON | KeyEvent.META_SHIFT_RIGHT_ON))) {
result|=KeyEvent.META_SHIFT_ON;
}
return result;
}
