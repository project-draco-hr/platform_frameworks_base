{
  final boolean selfTransformation=mHasLocalTransformation;
  Transformation attachedTransformation=(mAttachedWindow != null && mAttachedWindow.mWinAnimator.mHasLocalTransformation) ? mAttachedWindow.mWinAnimator.mTransformation : null;
  Transformation appTransformation=(mWin.mAppToken != null && mWin.mAppToken.hasTransformation) ? mWin.mAppToken.transformation : null;
  if (mWin.mAttrs.type == TYPE_WALLPAPER && mService.mLowerWallpaperTarget == null && mService.mWallpaperTarget != null) {
    if (mService.mWallpaperTarget.mWinAnimator.mHasLocalTransformation && mService.mWallpaperTarget.mWinAnimator.mAnimation != null && !mService.mWallpaperTarget.mWinAnimator.mAnimation.getDetachWallpaper()) {
      attachedTransformation=mService.mWallpaperTarget.mWinAnimator.mTransformation;
      if (WindowManagerService.DEBUG_WALLPAPER && attachedTransformation != null) {
        Slog.v(TAG,"WP target attached xform: " + attachedTransformation);
      }
    }
    if (mService.mWallpaperTarget.mAppToken != null && mService.mWallpaperTarget.mAppToken.hasTransformation && mService.mWallpaperTarget.mAppToken.animation != null && !mService.mWallpaperTarget.mAppToken.animation.getDetachWallpaper()) {
      appTransformation=mService.mWallpaperTarget.mAppToken.transformation;
      if (WindowManagerService.DEBUG_WALLPAPER && appTransformation != null) {
        Slog.v(TAG,"WP target app xform: " + appTransformation);
      }
    }
  }
  final boolean screenAnimation=mService.mAnimator.mScreenRotationAnimation != null && mService.mAnimator.mScreenRotationAnimation.isAnimating();
  if (selfTransformation || attachedTransformation != null || appTransformation != null || screenAnimation) {
    final Rect frame=mWin.mFrame;
    final float tmpFloats[]=mService.mTmpFloats;
    final Matrix tmpMatrix=mWin.mTmpMatrix;
    if (screenAnimation) {
      final float w=frame.width();
      final float h=frame.height();
      if (w >= 1 && h >= 1) {
        tmpMatrix.setScale(1 + 2 / w,1 + 2 / h,w / 2,h / 2);
      }
 else {
        tmpMatrix.reset();
      }
    }
 else {
      tmpMatrix.reset();
    }
    tmpMatrix.postScale(mWin.mGlobalScale,mWin.mGlobalScale);
    if (selfTransformation) {
      tmpMatrix.postConcat(mTransformation.getMatrix());
    }
    tmpMatrix.postTranslate(frame.left + mWin.mXOffset,frame.top + mWin.mYOffset);
    if (attachedTransformation != null) {
      tmpMatrix.postConcat(attachedTransformation.getMatrix());
    }
    if (appTransformation != null) {
      tmpMatrix.postConcat(appTransformation.getMatrix());
    }
    if (screenAnimation) {
      tmpMatrix.postConcat(mService.mAnimator.mScreenRotationAnimation.getEnterTransformation().getMatrix());
    }
    mHaveMatrix=true;
    tmpMatrix.getValues(tmpFloats);
    mDsDx=tmpFloats[Matrix.MSCALE_X];
    mDtDx=tmpFloats[Matrix.MSKEW_Y];
    mDsDy=tmpFloats[Matrix.MSKEW_X];
    mDtDy=tmpFloats[Matrix.MSCALE_Y];
    float x=tmpFloats[Matrix.MTRANS_X];
    float y=tmpFloats[Matrix.MTRANS_Y];
    int w=frame.width();
    int h=frame.height();
    mWin.mShownFrame.set(x,y,x + w,y + h);
    mShownAlpha=mAlpha;
    if (!mService.mLimitedAlphaCompositing || (!PixelFormat.formatHasAlpha(mWin.mAttrs.format) || (mWin.isIdentityMatrix(mDsDx,mDtDx,mDsDy,mDtDy) && x == frame.left && y == frame.top))) {
      if (selfTransformation) {
        mShownAlpha*=mTransformation.getAlpha();
      }
      if (attachedTransformation != null) {
        mShownAlpha*=attachedTransformation.getAlpha();
      }
      if (appTransformation != null) {
        mShownAlpha*=appTransformation.getAlpha();
      }
      if (screenAnimation) {
        mShownAlpha*=mService.mAnimator.mScreenRotationAnimation.getEnterTransformation().getAlpha();
      }
    }
 else {
    }
    if (WindowManagerService.localLOGV)     Slog.v(TAG,"computeShownFrameLocked: Animating " + this + ": "+ mWin.mShownFrame+ ", alpha="+ mTransformation.getAlpha()+ ", mShownAlpha="+ mShownAlpha);
    return;
  }
  if (WindowManagerService.localLOGV)   Slog.v(TAG,"computeShownFrameLocked: " + this + " not attached, mAlpha="+ mAlpha);
  mWin.mShownFrame.set(mWin.mFrame);
  if (mWin.mXOffset != 0 || mWin.mYOffset != 0) {
    mWin.mShownFrame.offset(mWin.mXOffset,mWin.mYOffset);
  }
  mShownAlpha=mAlpha;
  mHaveMatrix=false;
  mDsDx=mWin.mGlobalScale;
  mDtDx=0;
  mDsDy=0;
  mDtDy=mWin.mGlobalScale;
}
