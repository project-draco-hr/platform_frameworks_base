{
  final WindowState w=mWin;
  if (mSurface == null) {
    if (w.mOrientationChanging) {
      if (WindowManagerService.DEBUG_ORIENTATION) {
        Slog.v(TAG,"Orientation change skips hidden " + w);
      }
      w.mOrientationChanging=false;
    }
    return;
  }
  boolean displayed=false;
  computeShownFrameLocked();
  int width, height;
  if ((w.mAttrs.flags & LayoutParams.FLAG_SCALED) != 0) {
    width=w.mRequestedWidth;
    height=w.mRequestedHeight;
  }
 else {
    width=w.mCompatFrame.width();
    height=w.mCompatFrame.height();
  }
  if (width < 1) {
    width=1;
  }
  if (height < 1) {
    height=1;
  }
  final boolean surfaceResized=mSurfaceW != width || mSurfaceH != height;
  if (surfaceResized) {
    mSurfaceW=width;
    mSurfaceH=height;
  }
  if (mSurfaceX != w.mShownFrame.left || mSurfaceY != w.mShownFrame.top) {
    try {
      if (WindowManagerService.SHOW_TRANSACTIONS)       WindowManagerService.logSurface(w,"POS " + w.mShownFrame.left + ", "+ w.mShownFrame.top,null);
      mSurfaceX=w.mShownFrame.left;
      mSurfaceY=w.mShownFrame.top;
      mSurface.setPosition(w.mShownFrame.left,w.mShownFrame.top);
    }
 catch (    RuntimeException e) {
      Slog.w(TAG,"Error positioning surface of " + w + " pos=("+ w.mShownFrame.left+ ","+ w.mShownFrame.top+ ")",e);
      if (!recoveringMemory) {
        mService.reclaimSomeSurfaceMemoryLocked(this,"position",true);
      }
    }
  }
  if (surfaceResized) {
    try {
      if (WindowManagerService.SHOW_TRANSACTIONS)       WindowManagerService.logSurface(w,"SIZE " + width + "x"+ height,null);
      mSurfaceResized=true;
      mSurface.setSize(width,height);
    }
 catch (    RuntimeException e) {
      Slog.e(TAG,"Error resizing surface of " + w + " size=("+ width+ "x"+ height+ ")",e);
      if (!recoveringMemory) {
        mService.reclaimSomeSurfaceMemoryLocked(this,"size",true);
      }
    }
  }
  if (w.mAttachedHidden || !w.isReadyForDisplay()) {
    if (!w.mLastHidden) {
      w.mLastHidden=true;
      if (WindowManagerService.SHOW_TRANSACTIONS)       WindowManagerService.logSurface(w,"HIDE (performLayout)",null);
      if (mSurface != null) {
        mSurfaceShown=false;
        try {
          mSurface.hide();
        }
 catch (        RuntimeException e) {
          Slog.w(TAG,"Exception hiding surface in " + w);
        }
      }
    }
    if (w.mOrientationChanging) {
      w.mOrientationChanging=false;
      if (WindowManagerService.DEBUG_ORIENTATION)       Slog.v(TAG,"Orientation change skips hidden " + w);
    }
  }
 else   if (mLastLayer != mAnimLayer || mLastAlpha != mShownAlpha || mLastDsDx != mDsDx || mLastDtDx != mDtDx || mLastDsDy != mDsDy || mLastDtDy != mDtDy || w.mLastHScale != w.mHScale || w.mLastVScale != w.mVScale || w.mLastHidden) {
    displayed=true;
    mLastAlpha=mShownAlpha;
    mLastLayer=mAnimLayer;
    mLastDsDx=mDsDx;
    mLastDtDx=mDtDx;
    mLastDsDy=mDsDy;
    mLastDtDy=mDtDy;
    w.mLastHScale=w.mHScale;
    w.mLastVScale=w.mVScale;
    if (WindowManagerService.SHOW_TRANSACTIONS)     WindowManagerService.logSurface(w,"alpha=" + mShownAlpha + " layer="+ mAnimLayer+ " matrix=["+ (mDsDx * w.mHScale)+ ","+ (mDtDx * w.mVScale)+ "]["+ (mDsDy * w.mHScale)+ ","+ (mDtDy * w.mVScale)+ "]",null);
    if (mSurface != null) {
      try {
        mSurfaceAlpha=mShownAlpha;
        mSurface.setAlpha(mShownAlpha);
        mSurfaceLayer=w.mWinAnimator.mAnimLayer;
        mSurface.setLayer(w.mWinAnimator.mAnimLayer);
        mSurface.setMatrix(mDsDx * w.mHScale,mDtDx * w.mVScale,mDsDy * w.mHScale,mDtDy * w.mVScale);
      }
 catch (      RuntimeException e) {
        Slog.w(TAG,"Error updating surface in " + w,e);
        if (!recoveringMemory) {
          mService.reclaimSomeSurfaceMemoryLocked(this,"update",true);
        }
      }
    }
    if (w.mLastHidden && w.isDrawnLw() && !w.mReadyToShow) {
      if (WindowManagerService.SHOW_TRANSACTIONS)       WindowManagerService.logSurface(w,"SHOW (performLayout)",null);
      if (WindowManagerService.DEBUG_VISIBILITY)       Slog.v(TAG,"Showing " + w + " during relayout");
      if (showSurfaceRobustlyLocked()) {
        w.mHasDrawn=true;
        w.mLastHidden=false;
      }
 else {
        w.mOrientationChanging=false;
      }
    }
    if (mSurface != null) {
      w.mToken.hasVisible=true;
    }
  }
 else {
    displayed=true;
  }
  if (displayed) {
    if (w.mOrientationChanging) {
      if (!w.isDrawnLw()) {
        mService.mInnerFields.mOrientationChangeComplete=false;
        if (WindowManagerService.DEBUG_ORIENTATION)         Slog.v(TAG,"Orientation continue waiting for draw in " + w);
      }
 else {
        w.mOrientationChanging=false;
        if (WindowManagerService.DEBUG_ORIENTATION)         Slog.v(TAG,"Orientation change complete in " + w);
      }
    }
    w.mToken.hasVisible=true;
  }
}
