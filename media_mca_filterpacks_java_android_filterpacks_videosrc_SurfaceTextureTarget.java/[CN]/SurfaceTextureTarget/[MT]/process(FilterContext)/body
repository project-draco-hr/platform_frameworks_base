{
  if (mLogVerbose)   Log.v(TAG,"Starting frame processing");
  GLEnvironment glEnv=context.getGLEnvironment();
  Frame input=pullInput("frame");
  boolean createdFrame=false;
  float currentAspectRatio=(float)input.getFormat().getWidth() / input.getFormat().getHeight();
  if (currentAspectRatio != mAspectRatio) {
    if (mLogVerbose)     Log.v(TAG,"New aspect ratio: " + currentAspectRatio + ", previously: "+ mAspectRatio);
    mAspectRatio=currentAspectRatio;
    updateTargetRect();
  }
  Frame gpuFrame=null;
  if (mLogVerbose)   Log.v("SurfaceTextureTarget","Got input format: " + input.getFormat());
  int target=input.getFormat().getTarget();
  if (target != FrameFormat.TARGET_GPU) {
    gpuFrame=context.getFrameManager().duplicateFrameToTarget(input,FrameFormat.TARGET_GPU);
    createdFrame=true;
  }
 else {
    gpuFrame=input;
  }
  glEnv.activateSurfaceWithId(mSurfaceId);
  mProgram.process(gpuFrame,mScreen);
  glEnv.setSurfaceTimestamp(input.getTimestamp());
  glEnv.swapBuffers();
  if (createdFrame) {
    gpuFrame.release();
  }
}
