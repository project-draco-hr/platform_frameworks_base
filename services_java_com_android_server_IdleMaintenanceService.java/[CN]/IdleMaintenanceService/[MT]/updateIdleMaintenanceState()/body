{
  if (mIdleMaintenanceStarted) {
    if (!lastUserActivityPermitsIdleMaintenanceRunning() || !batteryLevelAndMaintenanceTimeoutPermitsIdleMaintenanceRunning()) {
      unscheduleUpdateIdleMaintenanceState();
      mIdleMaintenanceStarted=false;
      EventLogTags.writeIdleMaintenanceWindowFinish(SystemClock.elapsedRealtime(),mLastUserActivityElapsedTimeMillis,mBatteryService.getBatteryLevel(),isBatteryCharging() ? 1 : 0);
      sendIdleMaintenanceEndIntent();
      if (!batteryLevelAndMaintenanceTimeoutPermitsIdleMaintenanceRunning()) {
        scheduleUpdateIdleMaintenanceState(getNextIdleMaintenanceIntervalStartFromNow());
      }
    }
  }
 else   if (deviceStatePermitsIdleMaintenanceStart() && lastUserActivityPermitsIdleMaintenanceStart() && lastRunPermitsIdleMaintenanceStart()) {
    scheduleUpdateIdleMaintenanceState(MAX_IDLE_MAINTENANCE_DURATION);
    mIdleMaintenanceStarted=true;
    EventLogTags.writeIdleMaintenanceWindowStart(SystemClock.elapsedRealtime(),mLastUserActivityElapsedTimeMillis,mBatteryService.getBatteryLevel(),isBatteryCharging() ? 1 : 0);
    mLastIdleMaintenanceStartTimeMillis=SystemClock.elapsedRealtime();
    sendIdleMaintenanceStartIntent();
  }
 else   if (lastUserActivityPermitsIdleMaintenanceStart()) {
    if (lastRunPermitsIdleMaintenanceStart()) {
      scheduleUpdateIdleMaintenanceState(MIN_USER_INACTIVITY_IDLE_MAINTENANCE_START);
    }
 else {
      scheduleUpdateIdleMaintenanceState(getNextIdleMaintenanceIntervalStartFromNow());
    }
  }
}
