{
  if (mUsbManager.hasPermission(device)) {
    return;
  }
  final CountDownLatch latch=new CountDownLatch(1);
  final BroadcastReceiver receiver=new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      latch.countDown();
      getInstrumentation().getTargetContext().unregisterReceiver(this);
    }
  }
;
  getInstrumentation().getTargetContext().registerReceiver(receiver,new IntentFilter(ACTION_USB_PERMISSION));
  mUsbManager.requestPermission(device,PendingIntent.getBroadcast(getInstrumentation().getTargetContext(),0,new Intent(ACTION_USB_PERMISSION),0));
  latch.await();
  assertTrue(mUsbManager.hasPermission(device));
}
