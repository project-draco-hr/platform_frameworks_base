{
  final long currentTimeMillis=SystemClock.uptimeMillis();
  if (mWriteScheduled) {
    mHandler.removeMessages(MyHandler.MSG_PERSIST_SETTINGS);
    final long timeSinceLastNotWrittenMutationMillis=currentTimeMillis - mLastNotWrittenMutationTimeMillis;
    if (timeSinceLastNotWrittenMutationMillis >= MAX_WRITE_SETTINGS_DELAY_MILLIS) {
      mHandler.obtainMessage(MyHandler.MSG_PERSIST_SETTINGS).sendToTarget();
      return;
    }
    final long maxDelayMillis=Math.max(mLastNotWrittenMutationTimeMillis + MAX_WRITE_SETTINGS_DELAY_MILLIS - currentTimeMillis,0);
    final long writeDelayMillis=Math.min(WRITE_SETTINGS_DELAY_MILLIS,maxDelayMillis);
    Message message=mHandler.obtainMessage(MyHandler.MSG_PERSIST_SETTINGS);
    mHandler.sendMessageDelayed(message,writeDelayMillis);
  }
 else {
    mLastNotWrittenMutationTimeMillis=currentTimeMillis;
    Message message=mHandler.obtainMessage(MyHandler.MSG_PERSIST_SETTINGS);
    mHandler.sendMessageDelayed(message,WRITE_SETTINGS_DELAY_MILLIS);
    mWriteScheduled=true;
  }
}
