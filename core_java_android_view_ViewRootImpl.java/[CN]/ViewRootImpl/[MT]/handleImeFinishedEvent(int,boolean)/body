{
  final QueuedInputEvent q=mCurrentInputEvent;
  if (q != null && q.mEvent.getSequenceNumber() == seq) {
    if (DEBUG_IMF) {
      Log.v(TAG,"IME finished event: seq=" + seq + " handled="+ handled+ " event="+ q);
    }
    if (handled) {
      finishInputEvent(q,true);
    }
 else {
      if (q.mEvent instanceof KeyEvent) {
        KeyEvent event=(KeyEvent)q.mEvent;
        if (event.getAction() != KeyEvent.ACTION_UP) {
          if (!mAttachInfo.mHasWindowFocus) {
            Slog.w(TAG,"Dropping event due to no window focus: " + event);
            finishInputEvent(q,true);
            return;
          }
        }
        deliverKeyEventPostIme(q);
      }
 else {
        MotionEvent event=(MotionEvent)q.mEvent;
        if (event.getAction() != MotionEvent.ACTION_CANCEL && event.getAction() != MotionEvent.ACTION_UP) {
          if (!mAttachInfo.mHasWindowFocus) {
            Slog.w(TAG,"Dropping event due to no window focus: " + event);
            finishInputEvent(q,true);
            return;
          }
        }
        final int source=q.mEvent.getSource();
        if ((source & InputDevice.SOURCE_CLASS_TRACKBALL) != 0) {
          deliverTrackballEventPostIme(q);
        }
 else {
          deliverGenericMotionEventPostIme(q);
        }
      }
    }
  }
 else {
    if (DEBUG_IMF) {
      Log.v(TAG,"IME finished event: seq=" + seq + " handled="+ handled+ ", event not found!");
    }
  }
}
