{
  if (usbManager.hasPermission(device)) {
    return;
  }
  final CountDownLatch latch=new CountDownLatch(1);
  final BroadcastReceiver receiver=new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      latch.countDown();
      instrumentation.getTargetContext().unregisterReceiver(this);
    }
  }
;
  instrumentation.getTargetContext().registerReceiver(receiver,new IntentFilter(ACTION_USB_PERMISSION));
  usbManager.requestPermission(device,PendingIntent.getBroadcast(instrumentation.getTargetContext(),0,new Intent(ACTION_USB_PERMISSION),0));
  latch.await();
  Assert.assertTrue(usbManager.hasPermission(device));
}
