{
  if (FORMAT_AND_FACTORY_RESET.equals(intent.getAction())) {
    mFactoryReset=true;
  }
  if (intent.getBooleanExtra(EXTRA_ALWAYS_RESET,false)) {
    mAlwaysReset=true;
  }
  mReason=intent.getStringExtra(Intent.EXTRA_REASON);
  StorageVolume userVol=intent.getParcelableExtra(StorageVolume.EXTRA_STORAGE_VOLUME);
  if (userVol == null) {
    Slog.w(TAG,"Missing explicit storage volume; assuming default");
    userVol=mStorageManager.getPrimaryVolume();
  }
  final String volumeId=userVol.getId();
  mProgressDialog=new ProgressDialog(this);
  mProgressDialog.setIndeterminate(true);
  mProgressDialog.getWindow().setType(WindowManager.LayoutParams.TYPE_SYSTEM_ALERT);
  mProgressDialog.setMessage(getText(R.string.progress_unmounting));
  mProgressDialog.show();
  new FormatTask(volumeId).start();
  return Service.START_REDELIVER_INTENT;
}
