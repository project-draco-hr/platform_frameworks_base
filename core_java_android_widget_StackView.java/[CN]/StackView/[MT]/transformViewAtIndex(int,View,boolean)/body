{
  final float maxPerspectiveShiftY=mPerspectiveShiftY;
  final float maxPerspectiveShiftX=mPerspectiveShiftX;
  index=mMaxNumActiveViews - index - 1;
  if (index == mMaxNumActiveViews - 1)   index--;
  float r=(index * 1.0f) / (mMaxNumActiveViews - 2);
  final float scale=1 - PERSPECTIVE_SCALE_FACTOR * (1 - r);
  int stackDirection=(mStackMode == ITEMS_SLIDE_UP) ? 1 : -1;
  float perspectiveTranslationY=-stackDirection * r * maxPerspectiveShiftY;
  float scaleShiftCorrectionY=stackDirection * (1 - scale) * (getMeasuredHeight() * (1 - PERSPECTIVE_SHIFT_FACTOR_Y) / 2.0f);
  final float transY=perspectiveTranslationY + scaleShiftCorrectionY;
  float perspectiveTranslationX=(1 - r) * maxPerspectiveShiftX;
  float scaleShiftCorrectionX=(1 - scale) * (getMeasuredWidth() * (1 - PERSPECTIVE_SHIFT_FACTOR_X) / 2.0f);
  final float transX=perspectiveTranslationX + scaleShiftCorrectionX;
  if (animate) {
    PropertyValuesHolder translationX=PropertyValuesHolder.ofFloat("translationX",transX);
    PropertyValuesHolder translationY=PropertyValuesHolder.ofFloat("translationY",transY);
    PropertyValuesHolder scalePropX=PropertyValuesHolder.ofFloat("scaleX",scale);
    PropertyValuesHolder scalePropY=PropertyValuesHolder.ofFloat("scaleY",scale);
    ObjectAnimator oa=ObjectAnimator.ofPropertyValuesHolder(view,scalePropX,scalePropY,translationY,translationX);
    oa.setDuration(STACK_RELAYOUT_DURATION);
    view.setTagInternal(com.android.internal.R.id.viewAnimation,new WeakReference<ObjectAnimator>(oa));
    oa.start();
  }
 else {
    Object tag=view.getTag(com.android.internal.R.id.viewAnimation);
    if (tag instanceof WeakReference<?>) {
      Object obj=((WeakReference<?>)tag).get();
      if (obj instanceof ObjectAnimator) {
        ((ObjectAnimator)obj).cancel();
      }
    }
    view.setTranslationX(transX);
    view.setTranslationY(transY);
    view.setScaleX(scale);
    view.setScaleY(scale);
  }
}
