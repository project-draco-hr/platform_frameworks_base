{
  final WindowState w=mWin;
  if (w.hasSavedSurface()) {
    if (DEBUG_ANIM)     Slog.i(TAG,"createSurface: " + this + ": called when we had a saved surface");
    w.restoreSavedSurface();
    return mSurfaceController;
  }
  if (mSurfaceController == null) {
    if (DEBUG_ANIM || DEBUG_ORIENTATION)     Slog.i(TAG,"createSurface " + this + ": mDrawState=DRAW_PENDING");
    mDrawState=DRAW_PENDING;
    if (w.mAppToken != null) {
      if (w.mAppToken.mAppAnimator.animation == null) {
        w.mAppToken.allDrawn=false;
        w.mAppToken.deferClearAllDrawn=false;
      }
 else {
        w.mAppToken.deferClearAllDrawn=true;
      }
    }
    mService.makeWindowFreezingScreenIfNeededLocked(w);
    int flags=SurfaceControl.HIDDEN;
    final WindowManager.LayoutParams attrs=w.mAttrs;
    if (mService.isSecureLocked(w)) {
      flags|=SurfaceControl.SECURE;
    }
    mTmpSize.set(w.mFrame.left + w.mXOffset,w.mFrame.top + w.mYOffset,0,0);
    calculateSurfaceBounds(w,attrs);
    final int width=mTmpSize.width();
    final int height=mTmpSize.height();
    if (DEBUG_VISIBILITY) {
      Slog.v(TAG,"Creating surface in session " + mSession.mSurfaceSession + " window "+ this+ " w="+ width+ " h="+ height+ " x="+ mTmpSize.left+ " y="+ mTmpSize.top+ " format="+ attrs.format+ " flags="+ flags);
    }
    mLastSystemDecorRect.set(0,0,0,0);
    mHasClipRect=false;
    mClipRect.set(0,0,0,0);
    mLastClipRect.set(0,0,0,0);
    try {
      final boolean isHwAccelerated=(attrs.flags & FLAG_HARDWARE_ACCELERATED) != 0;
      final int format=isHwAccelerated ? PixelFormat.TRANSLUCENT : attrs.format;
      if (!PixelFormat.formatHasAlpha(attrs.format) && attrs.surfaceInsets.left == 0 && attrs.surfaceInsets.top == 0 && attrs.surfaceInsets.right == 0 && attrs.surfaceInsets.bottom == 0 && !w.isDragResizing()) {
        flags|=SurfaceControl.OPAQUE;
      }
      mSurfaceController=new WindowSurfaceController(mSession.mSurfaceSession,attrs.getTitle().toString(),width,height,format,flags,this);
      w.setHasSurface(true);
      if (SHOW_TRANSACTIONS || SHOW_SURFACE_ALLOC) {
        Slog.i(TAG,"  CREATE SURFACE " + mSurfaceController + " IN SESSION "+ mSession.mSurfaceSession+ ": pid="+ mSession.mPid+ " format="+ attrs.format+ " flags=0x"+ Integer.toHexString(flags)+ " / "+ this);
      }
    }
 catch (    OutOfResourcesException e) {
      w.setHasSurface(false);
      Slog.w(TAG,"OutOfResourcesException creating surface");
      mService.reclaimSomeSurfaceMemoryLocked(this,"create",true);
      mDrawState=NO_SURFACE;
      return null;
    }
catch (    Exception e) {
      w.setHasSurface(false);
      Slog.e(TAG,"Exception creating surface",e);
      mDrawState=NO_SURFACE;
      return null;
    }
    if (WindowManagerService.localLOGV) {
      Slog.v(TAG,"Got surface: " + mSurfaceController + ", set left="+ w.mFrame.left+ " top="+ w.mFrame.top+ ", animLayer="+ mAnimLayer);
    }
    if (SHOW_LIGHT_TRANSACTIONS) {
      Slog.i(TAG,">>> OPEN TRANSACTION createSurfaceLocked");
      WindowManagerService.logSurface(w,"CREATE pos=(" + w.mFrame.left + ","+ w.mFrame.top+ ") ("+ width+ "x"+ height+ "), layer="+ mAnimLayer+ " HIDE",false);
    }
    final int layerStack=w.getDisplayContent().getDisplay().getLayerStack();
    if (SHOW_TRANSACTIONS)     WindowManagerService.logSurface(w,"POS " + mTmpSize.left + ", "+ mTmpSize.top,false);
    mSurfaceController.setPositionAndLayer(mTmpSize.left,mTmpSize.top,layerStack,mAnimLayer);
    mLastHidden=true;
    if (WindowManagerService.localLOGV)     Slog.v(TAG,"Created surface " + this);
  }
  return mSurfaceController;
}
