{
  final WindowState w=mWin;
  final DisplayContent displayContent=w.getDisplayContent();
  if (displayContent == null) {
    return;
  }
  DisplayInfo displayInfo=displayContent.getDisplayInfo();
  if ((w.mAttrs.flags & LayoutParams.FLAG_SCALED) != 0) {
    w.mSystemDecorRect.set(0,0,w.mRequestedWidth,w.mRequestedHeight);
  }
 else   if (!w.isDefaultDisplay()) {
    w.mSystemDecorRect.set(0,0,w.mCompatFrame.width(),w.mCompatFrame.height());
    w.mSystemDecorRect.intersect(-w.mCompatFrame.left,-w.mCompatFrame.top,displayInfo.logicalWidth - w.mCompatFrame.left,displayInfo.logicalHeight - w.mCompatFrame.top);
  }
 else   if (w.mLayer >= mService.mSystemDecorLayer) {
    if (mAnimator.mUniverseBackground == null) {
      w.mSystemDecorRect.set(0,0,w.mCompatFrame.width(),w.mCompatFrame.height());
    }
 else {
      applyDecorRect(mService.mScreenRect);
    }
  }
 else   if (w.mAttrs.type == WindowManager.LayoutParams.TYPE_UNIVERSE_BACKGROUND || w.mDecorFrame.isEmpty()) {
    w.mSystemDecorRect.set(0,0,w.mCompatFrame.width(),w.mCompatFrame.height());
  }
 else {
    applyDecorRect(w.mDecorFrame);
  }
  Rect clipRect=w.mSystemDecorRect;
  if (mHasClipRect) {
    int offsetTop=Math.max(w.mSystemDecorRect.top,w.mContentInsets.top);
    mTmpClipRect.set(w.mSystemDecorRect);
    mTmpClipRect.offset(0,-offsetTop);
    mTmpClipRect.intersect(mClipRect);
    mTmpClipRect.offset(0,offsetTop);
    clipRect=mTmpClipRect;
  }
  if (!clipRect.equals(mLastClipRect)) {
    mLastClipRect.set(clipRect);
    try {
      if (WindowManagerService.SHOW_TRANSACTIONS)       WindowManagerService.logSurface(w,"CROP " + clipRect.toShortString(),null);
      mSurfaceControl.setWindowCrop(clipRect);
    }
 catch (    RuntimeException e) {
      Slog.w(TAG,"Error setting crop surface of " + w + " crop="+ clipRect.toShortString(),e);
      if (!recoveringMemory) {
        mService.reclaimSomeSurfaceMemoryLocked(this,"crop",true);
      }
    }
  }
}
