{
  final WindowState w=mWin;
  final DisplayContent displayContent=w.getDisplayContent();
  if (displayContent == null) {
    clipRect.setEmpty();
    finalClipRect.setEmpty();
    return;
  }
  final DisplayInfo displayInfo=displayContent.getDisplayInfo();
  if (DEBUG_WINDOW_CROP)   Slog.d(TAG,"Updating crop for window: " + w + ", "+ "mLastCrop="+ mLastClipRect);
  if (!w.isDefaultDisplay()) {
    mSystemDecorRect.set(0,0,w.mCompatFrame.width(),w.mCompatFrame.height());
    mSystemDecorRect.intersect(-w.mCompatFrame.left,-w.mCompatFrame.top,displayInfo.logicalWidth - w.mCompatFrame.left,displayInfo.logicalHeight - w.mCompatFrame.top);
  }
 else   if (w.mLayer >= mService.mSystemDecorLayer) {
    mSystemDecorRect.set(0,0,w.mCompatFrame.width(),w.mCompatFrame.height());
  }
 else   if (w.mDecorFrame.isEmpty()) {
    mSystemDecorRect.set(0,0,w.mCompatFrame.width(),w.mCompatFrame.height());
  }
 else   if (w.mAttrs.type == LayoutParams.TYPE_WALLPAPER && mAnimator.isAnimating()) {
    mTmpClipRect.set(mSystemDecorRect);
    calculateSystemDecorRect();
    mSystemDecorRect.union(mTmpClipRect);
  }
 else {
    calculateSystemDecorRect();
    if (DEBUG_WINDOW_CROP)     Slog.d(TAG,"Applying decor to crop for " + w + ", mDecorFrame="+ w.mDecorFrame+ ", mSystemDecorRect="+ mSystemDecorRect);
  }
  final boolean fullscreen=w.isFrameFullscreen(displayInfo);
  final boolean isFreeformResizing=w.isDragResizing() && w.getResizeMode() == DRAG_RESIZE_MODE_FREEFORM;
  clipRect.set((mHasClipRect && !fullscreen) ? mClipRect : mSystemDecorRect);
  if (DEBUG_WINDOW_CROP)   Slog.d(TAG,"Initial clip rect: " + clipRect + ", mHasClipRect="+ mHasClipRect+ ", fullscreen="+ fullscreen);
  if (isFreeformResizing && !w.isChildWindow()) {
    clipRect.offset(w.mShownPosition.x,w.mShownPosition.y);
  }
  final WindowManager.LayoutParams attrs=w.mAttrs;
  clipRect.left-=attrs.surfaceInsets.left;
  clipRect.top-=attrs.surfaceInsets.top;
  clipRect.right+=attrs.surfaceInsets.right;
  clipRect.bottom+=attrs.surfaceInsets.bottom;
  if (mHasClipRect && fullscreen) {
    clipRect.intersect(mClipRect);
  }
  clipRect.offset(attrs.surfaceInsets.left,attrs.surfaceInsets.top);
  finalClipRect.setEmpty();
  adjustCropToStackBounds(w,clipRect,finalClipRect,isFreeformResizing);
  if (DEBUG_WINDOW_CROP)   Slog.d(TAG,"Clip rect after stack adjustment=" + clipRect);
  w.transformFromScreenToSurfaceSpace(clipRect);
  if (w.hasJustMovedInStack() && mLastClipRect.isEmpty() && !clipRect.isEmpty()) {
    clipRect.setEmpty();
  }
}
