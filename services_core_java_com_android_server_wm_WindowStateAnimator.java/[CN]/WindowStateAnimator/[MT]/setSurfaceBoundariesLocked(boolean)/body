{
  final WindowState w=mWin;
  final Task task=w.getTask();
  if (w.isResizedWhileNotDragResizing() && !w.isGoneForLayoutLw()) {
    return;
  }
  mTmpSize.set(w.mShownPosition.x,w.mShownPosition.y,0,0);
  calculateSurfaceBounds(w,w.getAttrs());
  mExtraHScale=(float)1.0;
  mExtraVScale=(float)1.0;
  if (!w.inPinnedWorkspace() || (!w.mRelayoutCalled || w.mInRelayout)) {
    mSurfaceResized=mSurfaceController.setSizeInTransaction(mTmpSize.width(),mTmpSize.height(),recoveringMemory);
  }
 else {
    mSurfaceResized=false;
  }
  mForceScaleUntilResize=mForceScaleUntilResize && !mSurfaceResized;
  calculateSurfaceWindowCrop(mTmpClipRect,mTmpFinalClipRect);
  if ((task != null && task.mStack.getForceScaleToCrop()) || mForceScaleUntilResize) {
    int hInsets=w.getAttrs().surfaceInsets.left + w.getAttrs().surfaceInsets.right;
    int vInsets=w.getAttrs().surfaceInsets.top + w.getAttrs().surfaceInsets.bottom;
    float surfaceWidth=mSurfaceController.getWidth();
    float surfaceHeight=mSurfaceController.getHeight();
    mExtraHScale=(mTmpClipRect.width() - hInsets) / (float)(surfaceWidth - hInsets);
    mExtraVScale=(mTmpClipRect.height() - vInsets) / (float)(surfaceHeight - vInsets);
    int posX=(int)(mTmpSize.left - w.mAttrs.x * (1 - mExtraHScale));
    int posY=(int)(mTmpSize.top - w.mAttrs.y * (1 - mExtraVScale));
    posX+=w.getAttrs().surfaceInsets.left * (1 - mExtraHScale);
    posY+=w.getAttrs().surfaceInsets.top * (1 - mExtraVScale);
    mSurfaceController.setPositionInTransaction(posX,posY,recoveringMemory);
    mTmpClipRect.set(0,0,(int)surfaceWidth,(int)surfaceHeight);
    mTmpFinalClipRect.setEmpty();
    mForceScaleUntilResize=true;
  }
 else {
    mSurfaceController.setPositionInTransaction(mTmpSize.left,mTmpSize.top,recoveringMemory);
  }
  updateSurfaceWindowCrop(mTmpClipRect,mTmpFinalClipRect,recoveringMemory);
  mSurfaceController.setMatrixInTransaction(mDsDx * w.mHScale * mExtraHScale,mDtDx * w.mVScale * mExtraVScale,mDsDy * w.mHScale * mExtraHScale,mDtDy * w.mVScale * mExtraVScale,recoveringMemory);
  if (mSurfaceResized) {
    mReportSurfaceResized=true;
    mAnimator.setPendingLayoutChanges(w.getDisplayId(),WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER);
    w.applyDimLayerIfNeeded();
  }
}
