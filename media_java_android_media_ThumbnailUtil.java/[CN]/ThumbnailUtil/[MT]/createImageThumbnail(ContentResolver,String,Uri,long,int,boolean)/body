{
  boolean wantMini=(kind == Images.Thumbnails.MINI_KIND || saveMini);
  int targetSize=wantMini ? ThumbnailUtil.THUMBNAIL_TARGET_SIZE : ThumbnailUtil.MINI_THUMB_TARGET_SIZE;
  int maxPixels=wantMini ? ThumbnailUtil.THUMBNAIL_MAX_NUM_PIXELS : ThumbnailUtil.MINI_THUMB_MAX_NUM_PIXELS;
  byte[] thumbData=createThumbnailFromEXIF(filePath,targetSize);
  Bitmap bitmap=null;
  if (thumbData != null) {
    BitmapFactory.Options options=new BitmapFactory.Options();
    options.inSampleSize=computeSampleSize(options,targetSize,maxPixels);
    options.inDither=false;
    options.inPreferredConfig=Bitmap.Config.ARGB_8888;
    options.inJustDecodeBounds=false;
    bitmap=BitmapFactory.decodeByteArray(thumbData,0,thumbData.length,options);
  }
  if (bitmap == null) {
    bitmap=ThumbnailUtil.makeBitmap(targetSize,maxPixels,uri,cr);
  }
  if (bitmap == null) {
    return null;
  }
  if (saveMini) {
    if (thumbData != null) {
      ThumbnailUtil.storeThumbnail(cr,origId,thumbData,bitmap.getWidth(),bitmap.getHeight());
    }
 else {
      ThumbnailUtil.storeThumbnail(cr,origId,bitmap);
    }
  }
  if (kind == Images.Thumbnails.MICRO_KIND) {
    bitmap=ThumbnailUtil.extractMiniThumb(bitmap,ThumbnailUtil.MINI_THUMB_TARGET_SIZE,ThumbnailUtil.MINI_THUMB_TARGET_SIZE,ThumbnailUtil.RECYCLE_INPUT);
  }
  return bitmap;
}
