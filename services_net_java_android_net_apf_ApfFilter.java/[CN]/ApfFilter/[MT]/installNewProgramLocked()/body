{
  purgeExpiredRasLocked();
  final byte[] program;
  long programMinLifetime=Long.MAX_VALUE;
  try {
    ApfGenerator gen=beginProgramLocked();
    ArrayList<Ra> rasToFilter=new ArrayList<Ra>();
    for (    Ra ra : mRas) {
      ra.generateFilterLocked(gen);
      if (gen.programLengthOverEstimate() > mApfCapabilities.maximumApfProgramSize)       break;
      rasToFilter.add(ra);
    }
    gen=beginProgramLocked();
    for (    Ra ra : rasToFilter) {
      programMinLifetime=Math.min(programMinLifetime,ra.generateFilterLocked(gen));
    }
    program=gen.generate();
  }
 catch (  IllegalInstructionException e) {
    Log.e(TAG,"Program failed to generate: ",e);
    return;
  }
  mLastTimeInstalledProgram=curTime();
  mLastInstalledProgramMinLifetime=programMinLifetime;
  mLastInstalledProgram=program;
  mNumProgramUpdates++;
  if (VDBG) {
    hexDump("Installing filter: ",program,program.length);
  }
  mIpManagerCallback.installPacketFilter(program);
}
