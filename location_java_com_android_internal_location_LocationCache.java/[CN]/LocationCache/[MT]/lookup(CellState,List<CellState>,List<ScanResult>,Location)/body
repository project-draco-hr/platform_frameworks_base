{
  if (Log.isLoggable(TAG,Log.VERBOSE)) {
    Log.d(TAG,"including cell:" + (cellState != null) + ", wifi:"+ ((scanResults != null) ? scanResults.size() : "null"));
  }
  long now=System.currentTimeMillis();
  mCellCentroid.reset();
  mWifiCentroid.reset();
  if (cellState != null) {
    String primaryCellKey=getCellCacheKey(cellState.getMcc(),cellState.getMnc(),cellState.getLac(),cellState.getCid());
    Record record=mCellCache.lookup(primaryCellKey);
    if (record == null) {
      return false;
    }
    if (record.isValid()) {
      mCellCentroid.addLocation(record.getLat(),record.getLng(),record.getAccuracy(),record.getConfidence());
    }
  }
  if (cellHistory != null) {
    for (    CellState historicalCell : cellHistory) {
      if (now - historicalCell.getTime() < CELL_SMOOTHING_WINDOW) {
        String historicalCellKey=getCellCacheKey(historicalCell.getMcc(),historicalCell.getMnc(),historicalCell.getLac(),historicalCell.getCid());
        Record record=mCellCache.lookup(historicalCellKey);
        if (record != null && record.isValid()) {
          mCellCentroid.addLocation(record.getLat(),record.getLng(),record.getAccuracy(),record.getConfidence());
        }
      }
    }
  }
  if (scanResults != null) {
    int miss=0;
    for (    ScanResult scanResult : scanResults) {
      String wifiKey=scanResult.BSSID;
      Record record=mWifiCache.lookup(wifiKey);
      if (record == null) {
        miss++;
      }
 else {
        if (record.isValid()) {
          mWifiCentroid.addLocation(record.getLat(),record.getLng(),record.getAccuracy(),record.getConfidence());
        }
      }
    }
    if (mWifiCentroid.getNumber() >= WIFI_MIN_AP_REQUIRED) {
    }
 else     if (miss > Math.min(WIFI_MAX_MISS_ALLOWED,(scanResults.size() + 1) / 2)) {
      return false;
    }
 else {
      mWifiCache.save();
      mWifiCentroid.reset();
    }
  }
  if (mCellCentroid.getNumber() > 0) {
    mCellCache.save();
  }
  if (mWifiCentroid.getNumber() > 0) {
    mWifiCache.save();
  }
  int cellAccuracy=mCellCentroid.getAccuracy();
  int wifiAccuracy=mWifiCentroid.getAccuracy();
  int cellConfidence=mCellCentroid.getConfidence();
  int wifiConfidence=mWifiCentroid.getConfidence();
  if (Log.isLoggable(TAG,Log.VERBOSE)) {
    Log.d(TAG,"cellAccuracy:" + cellAccuracy + ", wifiAccuracy:"+ wifiAccuracy);
  }
  if (mCellCentroid.getNumber() != 0 && cellAccuracy <= MAX_ACCURACY_ALLOWED && (mWifiCentroid.getNumber() == 0 || cellConfidence >= wifiConfidence || cellAccuracy < wifiAccuracy)) {
    result.setAccuracy(cellAccuracy);
    result.setLatitude(mCellCentroid.getCentroidLat());
    result.setLongitude(mCellCentroid.getCentroidLng());
    result.setTime(now);
    Bundle extras=result.getExtras() == null ? new Bundle() : result.getExtras();
    extras.putString(EXTRA_KEY_LOCATION_TYPE,EXTRA_VALUE_LOCATION_TYPE_CELL);
    result.setExtras(extras);
  }
 else   if (mWifiCentroid.getNumber() != 0 && wifiAccuracy <= MAX_ACCURACY_ALLOWED) {
    result.setAccuracy(wifiAccuracy);
    result.setLatitude(mWifiCentroid.getCentroidLat());
    result.setLongitude(mWifiCentroid.getCentroidLng());
    result.setTime(now);
    Bundle extras=result.getExtras() == null ? new Bundle() : result.getExtras();
    extras.putString(EXTRA_KEY_LOCATION_TYPE,EXTRA_VALUE_LOCATION_TYPE_WIFI);
    result.setExtras(extras);
  }
 else {
    result.setAccuracy(-1);
  }
  return true;
}
