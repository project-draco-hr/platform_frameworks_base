{
  if (DEBUG)   Log.v(TAG,"performBackup() pkg=" + packageInfo.packageName);
  File packageDir=new File(mDataDir,packageInfo.packageName);
  packageDir.mkdirs();
  if (wipeAllFirst) {
    if (DEBUG)     Log.v(TAG,"wiping all data first");
    deleteContents(mDataDir);
  }
  BackupDataInput changeSet=new BackupDataInput(data.getFileDescriptor());
  try {
    int bufSize=512;
    byte[] buf=new byte[bufSize];
    while (changeSet.readNextHeader()) {
      String key=changeSet.getKey();
      String base64Key=new String(Base64.encode(key.getBytes()));
      File entityFile=new File(packageDir,base64Key);
      int dataSize=changeSet.getDataSize();
      if (DEBUG)       Log.v(TAG,"Got change set key=" + key + " size="+ dataSize+ " key64="+ base64Key);
      if (dataSize >= 0) {
        FileOutputStream entity=new FileOutputStream(entityFile);
        if (dataSize > bufSize) {
          bufSize=dataSize;
          buf=new byte[bufSize];
        }
        changeSet.readEntityData(buf,0,dataSize);
        if (DEBUG)         Log.v(TAG,"  data size " + dataSize);
        try {
          entity.write(buf,0,dataSize);
        }
 catch (        IOException e) {
          Log.e(TAG,"Unable to update key file " + entityFile.getAbsolutePath());
          return false;
        }
 finally {
          entity.close();
        }
      }
 else {
        entityFile.delete();
      }
    }
    return true;
  }
 catch (  IOException e) {
    Log.v(TAG,"Exception reading backup input:",e);
    return false;
  }
}
