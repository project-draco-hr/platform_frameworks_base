{
  final StubDocument document=mStorage.get(docId);
  if (document == null || !document.file.isFile())   throw new FileNotFoundException();
  if ("r".equals(mode)) {
    ParcelFileDescriptor pfd=ParcelFileDescriptor.open(document.file,ParcelFileDescriptor.MODE_READ_ONLY);
    if (mSimulateReadErrors) {
      pfd=new ParcelFileDescriptor(pfd){
        @Override public void checkError() throws IOException {
          throw new IOException("Test error");
        }
      }
;
    }
    return pfd;
  }
  if ("w".equals(mode)) {
    return startWrite(document);
  }
  throw new FileNotFoundException();
}
