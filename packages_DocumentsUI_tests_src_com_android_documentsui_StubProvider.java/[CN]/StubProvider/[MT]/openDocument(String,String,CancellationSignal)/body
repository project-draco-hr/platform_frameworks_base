{
  final StubDocument document=mStorage.get(docId);
  if (document == null || !document.file.isFile()) {
    throw new FileNotFoundException();
  }
  if ((document.flags & Document.FLAG_VIRTUAL_DOCUMENT) != 0) {
    throw new IllegalStateException("Tried to open a virtual file.");
  }
  if ("r".equals(mode)) {
    final ParcelFileDescriptor pfd=ParcelFileDescriptor.open(document.file,ParcelFileDescriptor.MODE_READ_ONLY);
    if (docId.equals(mSimulateReadErrors)) {
      return new ParcelFileDescriptor(pfd){
        @Override public void checkError() throws IOException {
          throw new IOException("Test error");
        }
      }
;
    }
    return pfd;
  }
  if ("w".equals(mode)) {
    return startWrite(document);
  }
  throw new FileNotFoundException();
}
