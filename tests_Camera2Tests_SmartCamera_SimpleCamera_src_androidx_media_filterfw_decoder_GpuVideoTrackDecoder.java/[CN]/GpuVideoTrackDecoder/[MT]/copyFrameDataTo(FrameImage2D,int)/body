{
  TextureSource targetTexture=TextureSource.newExternalTexture();
  mSurfaceTexture.attachToGLContext(targetTexture.getTextureId());
  mSurfaceTexture.getTransformMatrix(mTransformMatrix);
  ImageShader imageShader=getImageShader();
  imageShader.setSourceTransform(mTransformMatrix);
  int outputWidth=mOutputWidth;
  int outputHeight=mOutputHeight;
  if (rotation != 0) {
    float[] targetCoords=getRotationCoords(rotation);
    imageShader.setTargetCoords(targetCoords);
    if (needSwapDimension(rotation)) {
      outputWidth=mOutputHeight;
      outputHeight=mOutputWidth;
    }
  }
  outputVideoFrame.resize(new int[]{outputWidth,outputHeight});
  imageShader.process(targetTexture,outputVideoFrame.lockRenderTarget(),outputWidth,outputHeight);
  outputVideoFrame.setTimestamp(mCurrentPresentationTimeUs * 1000);
  outputVideoFrame.unlock();
  targetTexture.release();
  mSurfaceTexture.detachFromGLContext();
}
