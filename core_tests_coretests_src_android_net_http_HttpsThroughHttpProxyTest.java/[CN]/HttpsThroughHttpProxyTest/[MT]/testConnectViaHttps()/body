{
  TestSSLContext testSSLContext=TestSSLContext.create();
  MockWebServer server=new MockWebServer();
  server.useHttps(testSSLContext.serverContext.getSocketFactory(),false);
  server.enqueue(new MockResponse().setResponseCode(200).setBody("this response comes via HTTPS"));
  server.play();
  HttpClient httpClient=new DefaultHttpClient();
  SSLSocketFactory sslSocketFactory=new SSLSocketFactory(testSSLContext.clientContext.getSocketFactory());
  sslSocketFactory.setHostnameVerifier(new AllowAllHostnameVerifier());
  httpClient.getConnectionManager().getSchemeRegistry().register(new Scheme("https",sslSocketFactory,server.getPort()));
  HttpResponse response=httpClient.execute(new HttpGet("https://localhost:" + server.getPort() + "/foo"));
  assertEquals("this response comes via HTTPS",contentToString(response));
  RecordedRequest request=server.takeRequest();
  assertEquals("GET /foo HTTP/1.1",request.getRequestLine());
}
