{
  final Layout layout=mTextView.getLayout();
  if (layout == null) {
    positionAndAdjustForCrossingHandles(mTextView.getOffsetForPosition(x,y));
    return;
  }
  if (mPreviousLineTouched == UNSET_LINE) {
    mPreviousLineTouched=mTextView.getLineAtCoordinate(y);
  }
  boolean positionCursor=false;
  final int selectionStart=mTextView.getSelectionStart();
  int currLine=getCurrentLineAdjustedForSlop(layout,mPreviousLineTouched,y);
  int initialOffset=mTextView.getOffsetAtCoordinate(currLine,x);
  if (initialOffset <= selectionStart) {
    currLine=layout.getLineForOffset(selectionStart);
    initialOffset=mTextView.getOffsetAtCoordinate(currLine,x);
  }
  int offset=initialOffset;
  int end=getWordEnd(offset);
  int start=getWordStart(offset);
  if (mPrevX == UNSET_X_VALUE) {
    mPrevX=x;
  }
  final int selectionEnd=mTextView.getSelectionEnd();
  final boolean selectionEndRtl=layout.isRtlCharAt(selectionEnd);
  final boolean atRtl=layout.isRtlCharAt(offset);
  final boolean isLvlBoundary=layout.isLevelBoundary(offset);
  boolean isExpanding;
  if (isLvlBoundary || (selectionEndRtl && !atRtl) || (!selectionEndRtl && atRtl)) {
    mLanguageDirectionChanged=true;
    mTouchWordDelta=0.0f;
    positionAndAdjustForCrossingHandles(offset);
    return;
  }
 else   if (mLanguageDirectionChanged && !isLvlBoundary) {
    positionAndAdjustForCrossingHandles(offset);
    mTouchWordDelta=0.0f;
    mLanguageDirectionChanged=false;
    return;
  }
 else {
    final float xDiff=x - mPrevX;
    if (atRtl) {
      isExpanding=xDiff < 0 || currLine < mPreviousLineTouched;
    }
 else {
      isExpanding=xDiff > 0 || currLine > mPreviousLineTouched;
    }
  }
  if (mTextView.getHorizontallyScrolling()) {
    if (positionNearEdgeOfScrollingView(x,atRtl) && mTextView.canScrollHorizontally(atRtl ? -1 : 1) && ((isExpanding && offset > selectionEnd) || !isExpanding)) {
      mTouchWordDelta=0.0f;
      final int nextOffset=atRtl ? layout.getOffsetToLeftOf(mPreviousOffset) : layout.getOffsetToRightOf(mPreviousOffset);
      positionAndAdjustForCrossingHandles(nextOffset);
      return;
    }
  }
  if (isExpanding) {
    if (!mInWord || currLine > mPrevLine) {
      int wordEndOnCurrLine=end;
      if (layout != null && layout.getLineForOffset(end) != currLine) {
        wordEndOnCurrLine=layout.getLineEnd(currLine);
      }
      final int offsetThresholdToSnap=start + ((wordEndOnCurrLine - start) / 2);
      if (offset >= offsetThresholdToSnap || currLine > mPrevLine) {
        offset=end;
      }
 else {
        offset=mPreviousOffset;
      }
    }
    if (offset > initialOffset) {
      final float adjustedX=layout.getPrimaryHorizontal(offset);
      mTouchWordDelta=adjustedX - mTextView.convertToLocalHorizontalCoordinate(x);
    }
 else {
      mTouchWordDelta=0.0f;
    }
    positionCursor=true;
  }
 else {
    final int adjustedOffset=mTextView.getOffsetAtCoordinate(currLine,x + mTouchWordDelta);
    if (adjustedOffset < mPreviousOffset || currLine < mPrevLine) {
      if (currLine < mPrevLine) {
        offset=end;
        if (offset > initialOffset) {
          final float adjustedX=layout.getPrimaryHorizontal(offset);
          mTouchWordDelta=adjustedX - mTextView.convertToLocalHorizontalCoordinate(x);
        }
 else {
          mTouchWordDelta=0.0f;
        }
      }
 else {
        offset=adjustedOffset;
      }
      positionCursor=true;
    }
 else     if (adjustedOffset > mPreviousOffset) {
      mTouchWordDelta=layout.getPrimaryHorizontal(mPreviousOffset) - mTextView.convertToLocalHorizontalCoordinate(x);
    }
  }
  if (positionCursor) {
    mPreviousLineTouched=currLine;
    positionAndAdjustForCrossingHandles(offset);
  }
  mPrevX=x;
}
