{
  Editable editable=(Editable)mTextView.getText();
  SuggestionInfo suggestionInfo=mSuggestionInfos[position];
  if (suggestionInfo.suggestionIndex == DELETE_TEXT) {
    final int spanUnionStart=editable.getSpanStart(mSuggestionRangeSpan);
    int spanUnionEnd=editable.getSpanEnd(mSuggestionRangeSpan);
    if (spanUnionStart >= 0 && spanUnionEnd > spanUnionStart) {
      if (spanUnionEnd < editable.length() && Character.isSpaceChar(editable.charAt(spanUnionEnd)) && (spanUnionStart == 0 || Character.isSpaceChar(editable.charAt(spanUnionStart - 1)))) {
        spanUnionEnd=spanUnionEnd + 1;
      }
      mTextView.deleteText_internal(spanUnionStart,spanUnionEnd);
    }
    hide();
    return;
  }
  final int spanStart=editable.getSpanStart(suggestionInfo.suggestionSpan);
  final int spanEnd=editable.getSpanEnd(suggestionInfo.suggestionSpan);
  if (spanStart < 0 || spanEnd <= spanStart) {
    hide();
    return;
  }
  final String originalText=editable.toString().substring(spanStart,spanEnd);
  if (suggestionInfo.suggestionIndex == ADD_TO_DICTIONARY) {
    Intent intent=new Intent(Settings.ACTION_USER_DICTIONARY_INSERT);
    intent.putExtra("word",originalText);
    intent.putExtra("locale",mTextView.getTextServicesLocale().toString());
    intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);
    mTextView.getContext().startActivity(intent);
    editable.removeSpan(suggestionInfo.suggestionSpan);
    Selection.setSelection(editable,spanEnd);
    updateSpellCheckSpans(spanStart,spanEnd,false);
  }
 else {
    SuggestionSpan[] suggestionSpans=editable.getSpans(spanStart,spanEnd,SuggestionSpan.class);
    final int length=suggestionSpans.length;
    int[] suggestionSpansStarts=new int[length];
    int[] suggestionSpansEnds=new int[length];
    int[] suggestionSpansFlags=new int[length];
    for (int i=0; i < length; i++) {
      final SuggestionSpan suggestionSpan=suggestionSpans[i];
      suggestionSpansStarts[i]=editable.getSpanStart(suggestionSpan);
      suggestionSpansEnds[i]=editable.getSpanEnd(suggestionSpan);
      suggestionSpansFlags[i]=editable.getSpanFlags(suggestionSpan);
      int suggestionSpanFlags=suggestionSpan.getFlags();
      if ((suggestionSpanFlags & SuggestionSpan.FLAG_MISSPELLED) > 0) {
        suggestionSpanFlags&=~SuggestionSpan.FLAG_MISSPELLED;
        suggestionSpanFlags&=~SuggestionSpan.FLAG_EASY_CORRECT;
        suggestionSpan.setFlags(suggestionSpanFlags);
      }
    }
    final int suggestionStart=suggestionInfo.suggestionStart;
    final int suggestionEnd=suggestionInfo.suggestionEnd;
    final String suggestion=suggestionInfo.text.subSequence(suggestionStart,suggestionEnd).toString();
    mTextView.replaceText_internal(spanStart,spanEnd,suggestion);
    if (!TextUtils.isEmpty(suggestionInfo.suggestionSpan.getNotificationTargetClassName())) {
      InputMethodManager imm=InputMethodManager.peekInstance();
      if (imm != null) {
        imm.notifySuggestionPicked(suggestionInfo.suggestionSpan,originalText,suggestionInfo.suggestionIndex);
      }
    }
    String[] suggestions=suggestionInfo.suggestionSpan.getSuggestions();
    suggestions[suggestionInfo.suggestionIndex]=originalText;
    final int lengthDifference=suggestion.length() - (spanEnd - spanStart);
    for (int i=0; i < length; i++) {
      if (suggestionSpansStarts[i] <= spanStart && suggestionSpansEnds[i] >= spanEnd) {
        mTextView.setSpan_internal(suggestionSpans[i],suggestionSpansStarts[i],suggestionSpansEnds[i] + lengthDifference,suggestionSpansFlags[i]);
      }
    }
    final int newCursorPosition=spanEnd + lengthDifference;
    mTextView.setCursorPosition_internal(newCursorPosition,newCursorPosition);
  }
  hide();
}
