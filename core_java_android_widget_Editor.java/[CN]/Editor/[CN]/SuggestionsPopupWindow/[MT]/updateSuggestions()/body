{
  Spannable spannable=(Spannable)mTextView.getText();
  mNumberOfSuggestions=mSuggestionHelper.getSuggestionInfo(mSuggestionInfos);
  if (mNumberOfSuggestions == 0) {
    return false;
  }
  int spanUnionStart=mTextView.getText().length();
  int spanUnionEnd=0;
  mMisspelledSpan=null;
  for (int i=0; i < mNumberOfSuggestions; i++) {
    final SuggestionInfo suggestionInfo=mSuggestionInfos[i];
    final SuggestionSpan suggestionSpan=suggestionInfo.mSuggestionSpan;
    if ((suggestionSpan.getFlags() & SuggestionSpan.FLAG_MISSPELLED) != 0) {
      mMisspelledSpan=suggestionSpan;
    }
    spanUnionStart=Math.min(spanUnionStart,suggestionInfo.mSuggestionSpanStart);
    spanUnionEnd=Math.max(spanUnionEnd,suggestionInfo.mSuggestionSpanEnd);
  }
  for (int i=0; i < mNumberOfSuggestions; i++) {
    highlightTextDifferences(mSuggestionInfos[i],spanUnionStart,spanUnionEnd);
  }
  int addToDictionaryButtonVisibility=View.GONE;
  if (mMisspelledSpan != null) {
    final int misspelledStart=spannable.getSpanStart(mMisspelledSpan);
    final int misspelledEnd=spannable.getSpanEnd(mMisspelledSpan);
    if (misspelledStart >= 0 && misspelledEnd > misspelledStart) {
      addToDictionaryButtonVisibility=View.VISIBLE;
    }
  }
  mAddToDictionaryButton.setVisibility(addToDictionaryButtonVisibility);
  if (mSuggestionRangeSpan == null)   mSuggestionRangeSpan=new SuggestionRangeSpan();
  final int underlineColor=mSuggestionInfos[0].mSuggestionSpan.getUnderlineColor();
  if (underlineColor == 0) {
    mSuggestionRangeSpan.setBackgroundColor(mTextView.mHighlightColor);
  }
 else {
    final float BACKGROUND_TRANSPARENCY=0.4f;
    final int newAlpha=(int)(Color.alpha(underlineColor) * BACKGROUND_TRANSPARENCY);
    mSuggestionRangeSpan.setBackgroundColor((underlineColor & 0x00FFFFFF) + (newAlpha << 24));
  }
  spannable.setSpan(mSuggestionRangeSpan,spanUnionStart,spanUnionEnd,Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);
  mSuggestionsAdapter.notifyDataSetChanged();
  return true;
}
