{
  final int width=mTextView.getWidth();
  final long lineRange=layout.getLineRangeForDraw(canvas);
  int firstLine=TextUtils.unpackRangeStartFromLong(lineRange);
  int lastLine=TextUtils.unpackRangeEndFromLong(lineRange);
  if (lastLine < 0)   return;
  layout.drawBackground(canvas,highlight,highlightPaint,cursorOffsetVertical,firstLine,lastLine);
  if (layout instanceof DynamicLayout) {
    if (mTextDisplayLists == null) {
      mTextDisplayLists=new DisplayList[ArrayUtils.idealObjectArraySize(0)];
    }
    DynamicLayout dynamicLayout=(DynamicLayout)layout;
    int[] blockEndLines=dynamicLayout.getBlockEndLines();
    int[] blockIndices=dynamicLayout.getBlockIndices();
    final int numberOfBlocks=dynamicLayout.getNumberOfBlocks();
    final int scrollX=mTextView.getScrollX();
    final int scrollY=mTextView.getScrollY();
    canvas.translate(scrollX,scrollY);
    int endOfPreviousBlock=-1;
    int searchStartIndex=0;
    for (int i=0; i < numberOfBlocks; i++) {
      int blockEndLine=blockEndLines[i];
      int blockIndex=blockIndices[i];
      final boolean blockIsInvalid=blockIndex == DynamicLayout.INVALID_BLOCK_INDEX;
      if (blockIsInvalid) {
        blockIndex=getAvailableDisplayListIndex(blockIndices,numberOfBlocks,searchStartIndex);
        blockIndices[i]=blockIndex;
        searchStartIndex=blockIndex + 1;
      }
      DisplayList blockDisplayList=mTextDisplayLists[blockIndex];
      if (blockDisplayList == null) {
        blockDisplayList=mTextDisplayLists[blockIndex]=mTextView.getHardwareRenderer().createDisplayList("Text " + blockIndex);
      }
 else {
        if (blockIsInvalid)         blockDisplayList.invalidate();
      }
      if (!blockDisplayList.isValid()) {
        final int blockBeginLine=endOfPreviousBlock + 1;
        final int top=layout.getLineTop(blockBeginLine);
        final int bottom=layout.getLineBottom(blockEndLine);
        final HardwareCanvas hardwareCanvas=blockDisplayList.start();
        try {
          hardwareCanvas.setViewport(width,bottom - top);
          hardwareCanvas.onPreDraw(null);
          hardwareCanvas.translate(-scrollX,-top);
          layout.drawText(hardwareCanvas,blockBeginLine,blockEndLine);
          hardwareCanvas.translate(scrollX,top);
        }
  finally {
          hardwareCanvas.onPostDraw();
          blockDisplayList.end();
          blockDisplayList.setLeftTopRightBottom(0,top,width,bottom);
          blockDisplayList.setClipChildren(false);
        }
      }
      ((HardwareCanvas)canvas).drawDisplayList(blockDisplayList,null,0);
      endOfPreviousBlock=blockEndLine;
      canvas.translate(-scrollX,-scrollY);
    }
  }
 else {
    layout.drawText(canvas,firstLine,lastLine);
  }
}
