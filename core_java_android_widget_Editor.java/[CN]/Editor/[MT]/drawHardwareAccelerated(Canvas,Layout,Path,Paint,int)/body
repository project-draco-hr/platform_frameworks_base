{
  final long lineRange=layout.getLineRangeForDraw(canvas);
  int firstLine=TextUtils.unpackRangeStartFromLong(lineRange);
  int lastLine=TextUtils.unpackRangeEndFromLong(lineRange);
  if (lastLine < 0)   return;
  layout.drawBackground(canvas,highlight,highlightPaint,cursorOffsetVertical,firstLine,lastLine);
  final HardwareRenderer renderer=mTextView.getHardwareRenderer();
  if (layout instanceof DynamicLayout) {
    if (mTextDisplayLists == null) {
      mTextDisplayLists=new DisplayList[ArrayUtils.idealObjectArraySize(0)];
    }
    DynamicLayout dynamicLayout=(DynamicLayout)layout;
    int[] blockEndLines=dynamicLayout.getBlockEndLines();
    int[] blockIndices=dynamicLayout.getBlockIndices();
    final int numberOfBlocks=dynamicLayout.getNumberOfBlocks();
    final int indexFirstChangedBlock=dynamicLayout.getIndexFirstChangedBlock();
    int endOfPreviousBlock=-1;
    int searchStartIndex=0;
    for (int i=0; i < numberOfBlocks; i++) {
      int blockEndLine=blockEndLines[i];
      int blockIndex=blockIndices[i];
      final boolean blockIsInvalid=blockIndex == DynamicLayout.INVALID_BLOCK_INDEX;
      if (blockIsInvalid) {
        blockIndex=getAvailableDisplayListIndex(blockIndices,numberOfBlocks,searchStartIndex);
        blockIndices[i]=blockIndex;
        searchStartIndex=blockIndex + 1;
      }
      DisplayList blockDisplayList=mTextDisplayLists[blockIndex];
      if (blockDisplayList == null) {
        blockDisplayList=mTextDisplayLists[blockIndex]=DisplayList.create("Text " + blockIndex);
      }
      final boolean blockDisplayListIsInvalid=!blockDisplayList.isValid();
      if (i >= indexFirstChangedBlock || blockDisplayListIsInvalid) {
        final int blockBeginLine=endOfPreviousBlock + 1;
        final int top=layout.getLineTop(blockBeginLine);
        final int bottom=layout.getLineBottom(blockEndLine);
        int left=0;
        int right=mTextView.getWidth();
        if (mTextView.getHorizontallyScrolling()) {
          float min=Float.MAX_VALUE;
          float max=Float.MIN_VALUE;
          for (int line=blockBeginLine; line <= blockEndLine; line++) {
            min=Math.min(min,layout.getLineLeft(line));
            max=Math.max(max,layout.getLineRight(line));
          }
          left=(int)min;
          right=(int)(max + 0.5f);
        }
        if (blockDisplayListIsInvalid) {
          final HardwareCanvas hardwareCanvas=blockDisplayList.start(right - left,bottom - top);
          try {
            hardwareCanvas.translate(-left,-top);
            layout.drawText(hardwareCanvas,blockBeginLine,blockEndLine);
          }
  finally {
            blockDisplayList.end(renderer,hardwareCanvas);
            blockDisplayList.setClipToBounds(false);
          }
        }
        blockDisplayList.setLeftTopRightBottom(left,top,right,bottom);
      }
      ((HardwareCanvas)canvas).drawDisplayList(blockDisplayList,null,0);
      endOfPreviousBlock=blockEndLine;
    }
    dynamicLayout.setIndexFirstChangedBlock(numberOfBlocks);
  }
 else {
    layout.drawText(canvas,firstLine,lastLine);
  }
}
