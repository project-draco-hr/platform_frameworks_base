{
  StringBuilder content=new StringBuilder("");
  ClipData clipData=event.getClipData();
  final int itemCount=clipData.getItemCount();
  for (int i=0; i < itemCount; i++) {
    Item item=clipData.getItemAt(i);
    content.append(item.coerceToStyledText(mTextView.getContext()));
  }
  final int offset=mTextView.getOffsetForPosition(event.getX(),event.getY());
  Object localState=event.getLocalState();
  DragLocalState dragLocalState=null;
  if (localState instanceof DragLocalState) {
    dragLocalState=(DragLocalState)localState;
  }
  boolean dragDropIntoItself=dragLocalState != null && dragLocalState.sourceTextView == mTextView;
  if (dragDropIntoItself) {
    if (offset >= dragLocalState.start && offset < dragLocalState.end) {
      return;
    }
  }
  final int originalLength=mTextView.getText().length();
  long minMax=mTextView.prepareSpacesAroundPaste(offset,offset,content);
  int min=TextUtils.unpackRangeStartFromLong(minMax);
  int max=TextUtils.unpackRangeEndFromLong(minMax);
  Selection.setSelection((Spannable)mTextView.getText(),max);
  mTextView.replaceText_internal(min,max,content);
  if (dragDropIntoItself) {
    int dragSourceStart=dragLocalState.start;
    int dragSourceEnd=dragLocalState.end;
    if (max <= dragSourceStart) {
      final int shift=mTextView.getText().length() - originalLength;
      dragSourceStart+=shift;
      dragSourceEnd+=shift;
    }
    mTextView.deleteText_internal(dragSourceStart,dragSourceEnd);
    CharSequence t=mTextView.getTransformedText(dragSourceStart - 1,dragSourceStart + 1);
    if ((dragSourceStart == 0 || Character.isSpaceChar(t.charAt(0))) && (dragSourceStart == mTextView.getText().length() || Character.isSpaceChar(t.charAt(1)))) {
      final int pos=dragSourceStart == mTextView.getText().length() ? dragSourceStart - 1 : dragSourceStart;
      mTextView.deleteText_internal(pos,pos + 1);
    }
  }
}
