{
  final Editable editable=(Editable)mTextView.getText();
  if (editable.getSpanStart(suggestionInfo.mSuggestionSpan) < 0) {
    final SuggestionSpan[] suggestionSpans=editable.getSpans(suggestionInfo.mSuggestionSpanStart,suggestionInfo.mSuggestionSpanEnd,SuggestionSpan.class);
    for (    final SuggestionSpan suggestionSpan : suggestionSpans) {
      final int spanStart=editable.getSpanStart(suggestionSpan);
      if (spanStart != suggestionInfo.mSuggestionSpanStart) {
        continue;
      }
      int spanEnd=editable.getSpanEnd(suggestionSpan);
      if (spanEnd != suggestionInfo.mSuggestionSpanEnd) {
        continue;
      }
      if (suggestionSpan.equals(suggestionInfo.mSuggestionSpan)) {
        suggestionInfo.mSuggestionSpan=suggestionSpan;
        break;
      }
    }
  }
  final int spanStart=editable.getSpanStart(suggestionInfo.mSuggestionSpan);
  final int spanEnd=editable.getSpanEnd(suggestionInfo.mSuggestionSpan);
  if (spanStart < 0 || spanEnd <= spanStart) {
    return;
  }
  final String originalText=TextUtils.substring(editable,spanStart,spanEnd);
  SuggestionSpan[] suggestionSpans=editable.getSpans(spanStart,spanEnd,SuggestionSpan.class);
  final int length=suggestionSpans.length;
  int[] suggestionSpansStarts=new int[length];
  int[] suggestionSpansEnds=new int[length];
  int[] suggestionSpansFlags=new int[length];
  for (int i=0; i < length; i++) {
    final SuggestionSpan suggestionSpan=suggestionSpans[i];
    suggestionSpansStarts[i]=editable.getSpanStart(suggestionSpan);
    suggestionSpansEnds[i]=editable.getSpanEnd(suggestionSpan);
    suggestionSpansFlags[i]=editable.getSpanFlags(suggestionSpan);
    int suggestionSpanFlags=suggestionSpan.getFlags();
    if ((suggestionSpanFlags & SuggestionSpan.FLAG_MISSPELLED) != 0) {
      suggestionSpanFlags&=~SuggestionSpan.FLAG_MISSPELLED;
      suggestionSpanFlags&=~SuggestionSpan.FLAG_EASY_CORRECT;
      suggestionSpan.setFlags(suggestionSpanFlags);
    }
  }
  suggestionInfo.mSuggestionSpan.notifySelection(mTextView.getContext(),originalText,suggestionInfo.mSuggestionIndex);
  final int suggestionStart=suggestionInfo.mSuggestionStart;
  final int suggestionEnd=suggestionInfo.mSuggestionEnd;
  final String suggestion=suggestionInfo.mText.subSequence(suggestionStart,suggestionEnd).toString();
  mTextView.replaceText_internal(spanStart,spanEnd,suggestion);
  String[] suggestions=suggestionInfo.mSuggestionSpan.getSuggestions();
  suggestions[suggestionInfo.mSuggestionIndex]=originalText;
  final int lengthDelta=suggestion.length() - (spanEnd - spanStart);
  for (int i=0; i < length; i++) {
    if (suggestionSpansStarts[i] <= spanStart && suggestionSpansEnds[i] >= spanEnd) {
      mTextView.setSpan_internal(suggestionSpans[i],suggestionSpansStarts[i],suggestionSpansEnds[i] + lengthDelta,suggestionSpansFlags[i]);
    }
  }
  final int newCursorPosition=spanEnd + lengthDelta;
  mTextView.setCursorPosition_internal(newCursorPosition,newCursorPosition);
}
