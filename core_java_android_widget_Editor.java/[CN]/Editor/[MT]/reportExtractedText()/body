{
  final Editor.InputMethodState ims=mInputMethodState;
  if (ims != null) {
    final boolean contentChanged=ims.mContentChanged;
    if (contentChanged || ims.mSelectionModeChanged) {
      ims.mContentChanged=false;
      ims.mSelectionModeChanged=false;
      final ExtractedTextRequest req=ims.mExtractedTextRequest;
      if (req != null) {
        InputMethodManager imm=InputMethodManager.peekInstance();
        if (imm != null) {
          if (TextView.DEBUG_EXTRACT)           Log.v(TextView.LOG_TAG,"Retrieving extracted start=" + ims.mChangedStart + " end="+ ims.mChangedEnd+ " delta="+ ims.mChangedDelta);
          if (ims.mChangedStart < 0 && !contentChanged) {
            ims.mChangedStart=EXTRACT_NOTHING;
          }
          if (extractTextInternal(req,ims.mChangedStart,ims.mChangedEnd,ims.mChangedDelta,ims.mExtractedText)) {
            if (TextView.DEBUG_EXTRACT)             Log.v(TextView.LOG_TAG,"Reporting extracted start=" + ims.mExtractedText.partialStartOffset + " end="+ ims.mExtractedText.partialEndOffset+ ": "+ ims.mExtractedText.text);
            imm.updateExtractedText(mTextView,req.token,ims.mExtractedText);
            ims.mChangedStart=EXTRACT_UNKNOWN;
            ims.mChangedEnd=EXTRACT_UNKNOWN;
            ims.mChangedDelta=0;
            ims.mContentChanged=false;
            return true;
          }
        }
      }
    }
  }
  return false;
}
