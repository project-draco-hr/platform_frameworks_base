{
  int flashMode=getOrDefault(r,FLASH_MODE,FLASH_MODE_OFF);
  int aeMode=getOrDefault(r,CONTROL_AE_MODE,CONTROL_AE_MODE_ON);
  List<String> supportedFlashModes=p.getSupportedFlashModes();
  String flashModeSetting=null;
  if (ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_OFF)) {
    flashModeSetting=Parameters.FLASH_MODE_OFF;
  }
  if (aeMode == CONTROL_AE_MODE_ON) {
    if (flashMode == FLASH_MODE_TORCH) {
      if (ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_TORCH)) {
        flashModeSetting=Parameters.FLASH_MODE_TORCH;
      }
 else {
        Log.w(TAG,"mapAeAndFlashMode - Ignore flash.mode == TORCH;" + "camera does not support it");
      }
    }
 else     if (flashMode == FLASH_MODE_SINGLE) {
      if (ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_ON)) {
        flashModeSetting=Parameters.FLASH_MODE_ON;
      }
 else {
        Log.w(TAG,"mapAeAndFlashMode - Ignore flash.mode == SINGLE;" + "camera does not support it");
      }
    }
 else {
    }
  }
 else   if (aeMode == CONTROL_AE_MODE_ON_ALWAYS_FLASH) {
    if (ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_ON)) {
      flashModeSetting=Parameters.FLASH_MODE_ON;
    }
 else {
      Log.w(TAG,"mapAeAndFlashMode - Ignore control.aeMode == ON_ALWAYS_FLASH;" + "camera does not support it");
    }
  }
 else   if (aeMode == CONTROL_AE_MODE_ON_AUTO_FLASH) {
    if (ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_AUTO)) {
      flashModeSetting=Parameters.FLASH_MODE_AUTO;
    }
 else {
      Log.w(TAG,"mapAeAndFlashMode - Ignore control.aeMode == ON_AUTO_FLASH;" + "camera does not support it");
    }
  }
 else   if (aeMode == CONTROL_AE_MODE_ON_AUTO_FLASH_REDEYE) {
    if (ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_RED_EYE)) {
      flashModeSetting=Parameters.FLASH_MODE_RED_EYE;
    }
 else {
      Log.w(TAG,"mapAeAndFlashMode - Ignore control.aeMode == ON_AUTO_FLASH_REDEYE;" + "camera does not support it");
    }
  }
 else {
  }
  if (flashModeSetting != null) {
    p.setFlashMode(flashModeSetting);
  }
  if (VERBOSE) {
    Log.v(TAG,"mapAeAndFlashMode - set flash.mode (api1) to " + flashModeSetting + ", requested (api2) "+ flashMode+ ", supported (api1) "+ ListUtils.listToString(supportedFlashModes));
  }
}
