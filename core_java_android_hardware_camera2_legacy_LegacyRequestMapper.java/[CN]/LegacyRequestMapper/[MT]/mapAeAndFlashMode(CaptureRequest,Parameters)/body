{
  int flashMode=getOrDefault(r,FLASH_MODE,FLASH_MODE_OFF);
  int aeMode=getOrDefault(r,CONTROL_AE_MODE,CONTROL_AE_MODE_ON);
  List<String> supportedFlashModes=p.getSupportedFlashModes();
  if (aeMode == CONTROL_AE_MODE_ON) {
    p.setFlashMode(Parameters.FLASH_MODE_OFF);
    if (flashMode == FLASH_MODE_TORCH && ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_TORCH)) {
      p.setFlashMode(Parameters.FLASH_MODE_TORCH);
    }
 else     if (flashMode == FLASH_MODE_SINGLE && ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_ON)) {
      p.setFlashMode(Parameters.FLASH_MODE_ON);
    }
  }
 else   if (aeMode == CONTROL_AE_MODE_ON_ALWAYS_FLASH && ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_ON)) {
    p.setFlashMode(Parameters.FLASH_MODE_ON);
  }
 else   if (aeMode == CONTROL_AE_MODE_ON_AUTO_FLASH && ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_AUTO)) {
    p.setFlashMode(Parameters.FLASH_MODE_AUTO);
  }
 else   if (aeMode == CONTROL_AE_MODE_ON_AUTO_FLASH_REDEYE && ListUtils.listContains(supportedFlashModes,Parameters.FLASH_MODE_RED_EYE)) {
    p.setFlashMode(Parameters.FLASH_MODE_RED_EYE);
  }
 else {
    p.setFlashMode(Parameters.FLASH_MODE_OFF);
  }
}
