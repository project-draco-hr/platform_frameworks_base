{
  String name="test";
  KeymasterArguments args=new KeymasterArguments();
  args.addInt(KeymasterDefs.KM_TAG_PURPOSE,KeymasterDefs.KM_PURPOSE_ENCRYPT);
  args.addInt(KeymasterDefs.KM_TAG_PURPOSE,KeymasterDefs.KM_PURPOSE_DECRYPT);
  args.addInt(KeymasterDefs.KM_TAG_ALGORITHM,KeymasterDefs.KM_ALGORITHM_AES);
  args.addInt(KeymasterDefs.KM_TAG_PADDING,KeymasterDefs.KM_PAD_NONE);
  args.addInt(KeymasterDefs.KM_TAG_KEY_SIZE,256);
  args.addInt(KeymasterDefs.KM_TAG_BLOCK_MODE,KeymasterDefs.KM_MODE_OCB);
  args.addInt(KeymasterDefs.KM_TAG_CHUNK_LENGTH,4096);
  args.addInt(KeymasterDefs.KM_TAG_MAC_LENGTH,16);
  args.addBlob(KeymasterDefs.KM_TAG_APPLICATION_ID,null);
  args.addBlob(KeymasterDefs.KM_TAG_APPLICATION_DATA,null);
  KeyCharacteristics outCharacteristics=new KeyCharacteristics();
  int rc=mKeyStore.generateKey(name,args,0,outCharacteristics);
  assertEquals("Generate should succeed",KeyStore.NO_ERROR,rc);
  KeymasterArguments out=new KeymasterArguments();
  args=new KeymasterArguments();
  args.addBlob(KeymasterDefs.KM_TAG_APPLICATION_ID,null);
  args.addBlob(KeymasterDefs.KM_TAG_APPLICATION_DATA,null);
  OperationResult result=mKeyStore.begin(name,KeymasterDefs.KM_PURPOSE_ENCRYPT,true,args,out);
  assertEquals("Begin should succeed",KeyStore.NO_ERROR,result.resultCode);
  IBinder first=result.token;
  for (int i=0; i < 16; i++) {
    result=mKeyStore.begin(name,KeymasterDefs.KM_PURPOSE_ENCRYPT,true,args,out);
    assertEquals("Begin should succeed",KeyStore.NO_ERROR,result.resultCode);
  }
  assertEquals("Operation should be pruned",KeymasterDefs.KM_ERROR_INVALID_OPERATION_HANDLE,mKeyStore.update(first,null,new byte[]{0x01}).resultCode);
}
