{
  if (DEBUG)   Log.d(TAG,"onRegistrationDone(): " + session);
synchronized (SipService.this) {
    if (notCurrentSession(session))     return;
    mProxy.onRegistrationDone(session,duration);
    if (duration > 0) {
      mSession.clearReRegisterRequired();
      mExpiryTime=SystemClock.elapsedRealtime() + (duration * 1000);
      if (!mRegistered) {
        mRegistered=true;
        duration-=MIN_EXPIRY_TIME;
        if (duration < MIN_EXPIRY_TIME) {
          duration=MIN_EXPIRY_TIME;
        }
        restart(duration);
        if (isBehindNAT(mLocalIp) || mSession.getLocalProfile().getSendKeepAlive()) {
          if (mKeepAliveProcess == null) {
            mKeepAliveProcess=new KeepAliveProcess(mSession);
          }
          mKeepAliveProcess.start();
        }
      }
      mMyWakeLock.release(session);
    }
 else {
      mRegistered=false;
      mExpiryTime=-1L;
      if (DEBUG)       Log.d(TAG,"Refresh registration immediately");
      run();
    }
  }
}
