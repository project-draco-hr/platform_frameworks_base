{
  if (DEBUG)   Log.d(TAG,"onRegistrationDone(): " + session);
synchronized (SipService.this) {
    if (notCurrentSession(session))     return;
    mProxy.onRegistrationDone(session,duration);
    if (duration > 0) {
      mExpiryTime=SystemClock.elapsedRealtime() + (duration * 1000);
      if (!mRegistered) {
        mRegistered=true;
        duration-=MIN_EXPIRY_TIME;
        if (duration < MIN_EXPIRY_TIME) {
          duration=MIN_EXPIRY_TIME;
        }
        restart(duration);
        SipProfile localProfile=mSession.getLocalProfile();
        if ((mKeepAliveSession == null) && (isBehindNAT(mLocalIp) || localProfile.getSendKeepAlive())) {
          mKeepAliveSession=mSession.duplicate();
          Log.d(TAG,"start keepalive");
          try {
            mKeepAliveSession.startKeepAliveProcess(getKeepAliveInterval(),this);
          }
 catch (          SipException e) {
            Log.e(TAG,"AutoRegistrationProcess",e);
          }
        }
      }
      mMyWakeLock.release(session);
    }
 else {
      mRegistered=false;
      mExpiryTime=-1L;
      if (DEBUG)       Log.d(TAG,"Refresh registration immediately");
      run();
    }
  }
}
