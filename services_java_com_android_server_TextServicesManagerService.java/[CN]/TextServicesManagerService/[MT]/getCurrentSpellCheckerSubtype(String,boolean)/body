{
synchronized (mSpellCheckerMap) {
    final String subtypeHashCodeStr=Settings.Secure.getString(mContext.getContentResolver(),Settings.Secure.SELECTED_SPELL_CHECKER_SUBTYPE);
    if (DBG) {
      Slog.w(TAG,"getCurrentSpellCheckerSubtype: " + subtypeHashCodeStr);
    }
    final SpellCheckerInfo sci=getCurrentSpellChecker(null);
    if (sci == null || sci.getSubtypeCount() == 0) {
      if (DBG) {
        Slog.w(TAG,"Subtype not found.");
      }
      return null;
    }
    final int hashCode;
    if (!TextUtils.isEmpty(subtypeHashCodeStr)) {
      hashCode=Integer.valueOf(subtypeHashCodeStr);
    }
 else {
      hashCode=0;
    }
    if (hashCode == 0 && !allowImplicitlySelectedSubtype) {
      return null;
    }
    final String systemLocale=mContext.getResources().getConfiguration().locale.toString();
    SpellCheckerSubtype candidate=null;
    for (int i=0; i < sci.getSubtypeCount(); ++i) {
      final SpellCheckerSubtype scs=sci.getSubtypeAt(i);
      if (hashCode == 0) {
        if (systemLocale.equals(locale)) {
          return scs;
        }
 else         if (candidate == null) {
          final String scsLocale=scs.getLocale();
          if (systemLocale.length() >= 2 && scsLocale.length() >= 2 && systemLocale.substring(0,2).equals(scsLocale.substring(0,2))) {
            candidate=scs;
          }
        }
      }
 else       if (scs.hashCode() == hashCode) {
        if (DBG) {
          Slog.w(TAG,"Return subtype " + scs.hashCode() + ", input= "+ locale+ ", "+ scs.getLocale());
        }
        return scs;
      }
    }
    return candidate;
  }
}
