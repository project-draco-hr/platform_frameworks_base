{
synchronized (mSpellCheckerMap) {
    final String subtypeHashCodeStr=Settings.Secure.getString(mContext.getContentResolver(),Settings.Secure.SELECTED_SPELL_CHECKER_SUBTYPE);
    if (DBG) {
      Slog.w(TAG,"getCurrentSpellCheckerSubtype: " + subtypeHashCodeStr);
    }
    final SpellCheckerInfo sci=getCurrentSpellChecker(null);
    if (sci == null || sci.getSubtypeCount() == 0) {
      if (DBG) {
        Slog.w(TAG,"Subtype not found.");
      }
      return null;
    }
    final int hashCode;
    if (!TextUtils.isEmpty(subtypeHashCodeStr)) {
      hashCode=Integer.valueOf(subtypeHashCodeStr);
    }
 else {
      hashCode=0;
    }
    if (hashCode == 0 && !allowImplicitlySelectedSubtype) {
      return null;
    }
    String candidateLocale=null;
    if (hashCode == 0) {
      final InputMethodManager imm=(InputMethodManager)mContext.getSystemService(Context.INPUT_METHOD_SERVICE);
      if (imm != null) {
        final InputMethodSubtype currentInputMethodSubtype=imm.getCurrentInputMethodSubtype();
        if (currentInputMethodSubtype != null) {
          final String localeString=currentInputMethodSubtype.getLocale();
          if (!TextUtils.isEmpty(localeString)) {
            candidateLocale=localeString;
          }
        }
      }
      if (candidateLocale == null) {
        candidateLocale=mContext.getResources().getConfiguration().locale.toString();
      }
    }
    SpellCheckerSubtype candidate=null;
    for (int i=0; i < sci.getSubtypeCount(); ++i) {
      final SpellCheckerSubtype scs=sci.getSubtypeAt(i);
      if (hashCode == 0) {
        final String scsLocale=scs.getLocale();
        if (candidateLocale.equals(scsLocale)) {
          return scs;
        }
 else         if (candidate == null) {
          if (candidateLocale.length() >= 2 && scsLocale.length() >= 2 && candidateLocale.startsWith(scsLocale)) {
            candidate=scs;
          }
        }
      }
 else       if (scs.hashCode() == hashCode) {
        if (DBG) {
          Slog.w(TAG,"Return subtype " + scs.hashCode() + ", input= "+ locale+ ", "+ scs.getLocale());
        }
        return scs;
      }
    }
    return candidate;
  }
}
