{
  mContext=context;
  mPM=(PowerManager)context.getSystemService(Context.POWER_SERVICE);
  mUserManager=(UserManager)mContext.getSystemService(Context.USER_SERVICE);
  mShowKeyguardWakeLock=mPM.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,"show keyguard");
  mShowKeyguardWakeLock.setReferenceCounted(false);
  mContext.registerReceiver(mBroadcastReceiver,new IntentFilter(DELAYED_KEYGUARD_ACTION));
  mKeyguardDisplayManager=new KeyguardDisplayManager(context);
  mAlarmManager=(AlarmManager)context.getSystemService(Context.ALARM_SERVICE);
  mUpdateMonitor=KeyguardUpdateMonitor.getInstance(context);
  mLockPatternUtils=lockPatternUtils != null ? lockPatternUtils : new LockPatternUtils(mContext);
  mLockPatternUtils.setCurrentUser(UserHandle.USER_OWNER);
  mShowing=(mUpdateMonitor.isDeviceProvisioned() || mLockPatternUtils.isSecure()) && !mLockPatternUtils.isLockScreenDisabled();
  WindowManager wm=(WindowManager)context.getSystemService(Context.WINDOW_SERVICE);
  final ContentResolver cr=mContext.getContentResolver();
  if (ENABLE_ANALYTICS && !LockPatternUtils.isSafeModeEnabled() && Settings.Secure.getInt(cr,KEYGUARD_ANALYTICS_SETTING,0) == 1) {
    mKeyguardAnalytics=new KeyguardAnalytics(context,new SessionTypeAdapter(){
      @Override public int getSessionType(){
        return mLockPatternUtils.isSecure() ? Session.TYPE_KEYGUARD_SECURE : Session.TYPE_KEYGUARD_INSECURE;
      }
    }
,new File(mContext.getCacheDir(),"keyguard_analytics.bin"));
  }
 else {
    mKeyguardAnalytics=null;
  }
  mKeyguardViewManager=new KeyguardViewManager(context,wm,mViewMediatorCallback,mLockPatternUtils,mKeyguardAnalytics != null ? mKeyguardAnalytics.getCallback() : null);
  mScreenOn=mPM.isScreenOn();
  mLockSounds=new SoundPool(1,AudioManager.STREAM_SYSTEM,0);
  String soundPath=Settings.Global.getString(cr,Settings.Global.LOCK_SOUND);
  if (soundPath != null) {
    mLockSoundId=mLockSounds.load(soundPath,1);
  }
  if (soundPath == null || mLockSoundId == 0) {
    Log.w(TAG,"failed to load lock sound from " + soundPath);
  }
  soundPath=Settings.Global.getString(cr,Settings.Global.UNLOCK_SOUND);
  if (soundPath != null) {
    mUnlockSoundId=mLockSounds.load(soundPath,1);
  }
  if (soundPath == null || mUnlockSoundId == 0) {
    Log.w(TAG,"failed to load unlock sound from " + soundPath);
  }
  int lockSoundDefaultAttenuation=context.getResources().getInteger(com.android.internal.R.integer.config_lockSoundVolumeDb);
  mLockSoundVolume=(float)Math.pow(10,(float)lockSoundDefaultAttenuation / 20);
}
