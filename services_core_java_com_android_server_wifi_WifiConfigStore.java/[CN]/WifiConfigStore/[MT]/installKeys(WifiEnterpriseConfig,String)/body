{
  boolean ret=true;
  String privKeyName=Credentials.USER_PRIVATE_KEY + name;
  String userCertName=Credentials.USER_CERTIFICATE + name;
  String caCertName=Credentials.CA_CERTIFICATE + name;
  if (config.getClientCertificate() != null) {
    byte[] privKeyData=config.getClientPrivateKey().getEncoded();
    if (isHardwareBackedKey(config.getClientPrivateKey())) {
      if (DBG)       Log.d(TAG,"importing keys " + name + " in hardware backed store");
      ret=mKeyStore.importKey(privKeyName,privKeyData,android.os.Process.WIFI_UID,KeyStore.FLAG_NONE);
    }
 else {
      if (DBG)       Log.d(TAG,"importing keys " + name + " in software backed store");
      ret=mKeyStore.importKey(privKeyName,privKeyData,Process.WIFI_UID,KeyStore.FLAG_ENCRYPTED);
    }
    if (ret == false) {
      return ret;
    }
    ret=putCertInKeyStore(userCertName,config.getClientCertificate());
    if (ret == false) {
      mKeyStore.delKey(privKeyName,Process.WIFI_UID);
      return ret;
    }
  }
  if (config.getCaCertificate() != null) {
    ret=putCertInKeyStore(caCertName,config.getCaCertificate());
    if (ret == false) {
      if (config.getClientCertificate() != null) {
        mKeyStore.delKey(privKeyName,Process.WIFI_UID);
        mKeyStore.delete(userCertName,Process.WIFI_UID);
      }
      return ret;
    }
  }
  if (config.getClientCertificate() != null) {
    config.setClientCertificateAlias(name);
    config.resetClientKeyEntry();
  }
  if (config.getCaCertificate() != null) {
    config.setCaCertificateAlias(name);
    config.resetCaCertificate();
  }
  return ret;
}
