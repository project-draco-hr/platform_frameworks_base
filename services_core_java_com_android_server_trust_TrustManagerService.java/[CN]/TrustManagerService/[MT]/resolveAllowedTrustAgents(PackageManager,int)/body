{
  List<ResolveInfo> resolveInfos=pm.queryIntentServicesAsUser(TRUST_AGENT_INTENT,PackageManager.MATCH_DIRECT_BOOT_AWARE | PackageManager.MATCH_DIRECT_BOOT_UNAWARE,userId);
  ArrayList<ResolveInfo> allowedAgents=new ArrayList<>(resolveInfos.size());
  for (  ResolveInfo resolveInfo : resolveInfos) {
    if (resolveInfo.serviceInfo == null)     continue;
    if (resolveInfo.serviceInfo.applicationInfo == null)     continue;
    String packageName=resolveInfo.serviceInfo.packageName;
    if (pm.checkPermission(PERMISSION_PROVIDE_AGENT,packageName) != PackageManager.PERMISSION_GRANTED) {
      ComponentName name=getComponentName(resolveInfo);
      Log.w(TAG,"Skipping agent " + name + " because package does not have"+ " permission "+ PERMISSION_PROVIDE_AGENT+ ".");
      continue;
    }
    allowedAgents.add(resolveInfo);
  }
  return allowedAgents;
}
