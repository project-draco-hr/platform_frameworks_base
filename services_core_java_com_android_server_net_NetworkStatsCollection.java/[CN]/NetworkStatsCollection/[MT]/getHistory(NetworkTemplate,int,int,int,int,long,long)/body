{
  final int callerUid=Binder.getCallingUid();
  if (!isAccessibleToUser(uid,callerUid)) {
    throw new SecurityException("Network stats history of uid " + uid + " is forbidden for caller "+ callerUid);
  }
  final NetworkStatsHistory combined=new NetworkStatsHistory(mBucketDuration,start == end ? 1 : estimateBuckets(),fields);
  if (start == end)   return combined;
  for (int i=0; i < mStats.size(); i++) {
    final Key key=mStats.keyAt(i);
    final boolean setMatches=set == SET_ALL || key.set == set;
    if (key.uid == uid && setMatches && key.tag == tag && templateMatches(template,key.ident)) {
      final NetworkStatsHistory value=mStats.valueAt(i);
      combined.recordHistory(value,start,end);
    }
  }
  return combined;
}
