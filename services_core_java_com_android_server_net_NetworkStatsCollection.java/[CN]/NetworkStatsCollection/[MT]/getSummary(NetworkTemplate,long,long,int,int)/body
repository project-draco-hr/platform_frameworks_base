{
  final long now=System.currentTimeMillis();
  final NetworkStats stats=new NetworkStats(end - start,24);
  if (start == end)   return stats;
  final NetworkStats.Entry entry=new NetworkStats.Entry();
  NetworkStatsHistory.Entry historyEntry=null;
  for (int i=0; i < mStats.size(); i++) {
    final Key key=mStats.keyAt(i);
    if (templateMatches(template,key.ident) && NetworkStatsAccess.isAccessibleToUser(key.uid,callerUid,accessLevel) && key.set < NetworkStats.SET_DEBUG_START) {
      final NetworkStatsHistory value=mStats.valueAt(i);
      historyEntry=value.getValues(start,end,now,historyEntry);
      entry.iface=IFACE_ALL;
      entry.uid=key.uid;
      entry.set=key.set;
      entry.tag=key.tag;
      entry.roaming=key.ident.isAnyMemberRoaming() ? ROAMING_YES : ROAMING_NO;
      entry.rxBytes=historyEntry.rxBytes;
      entry.rxPackets=historyEntry.rxPackets;
      entry.txBytes=historyEntry.txBytes;
      entry.txPackets=historyEntry.txPackets;
      entry.operations=historyEntry.operations;
      if (!entry.isEmpty()) {
        stats.combineValues(entry);
      }
    }
  }
  return stats;
}
