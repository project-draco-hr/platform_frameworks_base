{
  final HashMap<NetworkIdentitySet,ArrayList<Key>> keysByIdent=Maps.newHashMap();
  for (  Key key : mStats.keySet()) {
    ArrayList<Key> keys=keysByIdent.get(key.ident);
    if (keys == null) {
      keys=Lists.newArrayList();
      keysByIdent.put(key.ident,keys);
    }
    keys.add(key);
  }
  out.writeInt(FILE_MAGIC);
  out.writeInt(VERSION_UNIFIED_INIT);
  out.writeInt(keysByIdent.size());
  for (  NetworkIdentitySet ident : keysByIdent.keySet()) {
    final ArrayList<Key> keys=keysByIdent.get(ident);
    ident.writeToStream(out);
    out.writeInt(keys.size());
    for (    Key key : keys) {
      final NetworkStatsHistory history=mStats.get(key);
      out.writeInt(key.uid);
      out.writeInt(key.set);
      out.writeInt(key.tag);
      history.writeToStream(out);
    }
  }
  out.flush();
}
