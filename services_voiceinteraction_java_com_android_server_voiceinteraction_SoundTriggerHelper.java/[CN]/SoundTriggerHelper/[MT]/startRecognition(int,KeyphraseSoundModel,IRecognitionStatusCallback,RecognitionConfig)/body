{
  if (DBG) {
    Slog.d(TAG,"startRecognition for keyphraseId=" + keyphraseId + " soundModel="+ soundModel+ ", listener="+ listener+ ", recognitionConfig="+ recognitionConfig);
    Slog.d(TAG,"moduleProperties=" + moduleProperties);
    Slog.d(TAG,"# of current listeners=" + mActiveListeners.size());
    Slog.d(TAG,"current SoundModel handle=" + mCurrentSoundModelHandle);
    Slog.d(TAG,"current SoundModel UUID=" + (mCurrentSoundModelUuid == null ? null : mCurrentSoundModelUuid));
  }
  if (moduleProperties == null || mModule == null) {
    Slog.w(TAG,"Attempting startRecognition without the capability");
    return STATUS_ERROR;
  }
  if (mCurrentSoundModelHandle != INVALID_SOUND_MODEL_HANDLE && !soundModel.uuid.equals(mCurrentSoundModelUuid)) {
    Slog.w(TAG,"Unloading previous sound model");
    int status=mModule.unloadSoundModel(mCurrentSoundModelHandle);
    if (status != SoundTrigger.STATUS_OK) {
      Slog.w(TAG,"unloadSoundModel call failed with " + status);
      return status;
    }
    mCurrentSoundModelHandle=INVALID_SOUND_MODEL_HANDLE;
    mCurrentSoundModelUuid=null;
  }
  IRecognitionStatusCallback oldListener=mActiveListeners.get(keyphraseId);
  if (oldListener != null && oldListener.asBinder() != listener.asBinder()) {
    Slog.w(TAG,"Canceling previous recognition");
    try {
      oldListener.onError(STATUS_ERROR);
    }
 catch (    RemoteException e) {
      Slog.w(TAG,"RemoteException in onDetectionStopped");
    }
    mActiveListeners.remove(keyphraseId);
  }
  int soundModelHandle=mCurrentSoundModelHandle;
  if (mCurrentSoundModelHandle == INVALID_SOUND_MODEL_HANDLE || mCurrentSoundModelUuid == null) {
    int[] handle=new int[]{INVALID_SOUND_MODEL_HANDLE};
    int status=mModule.loadSoundModel(soundModel,handle);
    if (status != SoundTrigger.STATUS_OK) {
      Slog.w(TAG,"loadSoundModel call failed with " + status);
      return status;
    }
    if (handle[0] == INVALID_SOUND_MODEL_HANDLE) {
      Slog.w(TAG,"loadSoundModel call returned invalid sound model handle");
      return STATUS_ERROR;
    }
    soundModelHandle=handle[0];
  }
 else {
    if (DBG)     Slog.d(TAG,"Reusing previously loaded sound model");
  }
  int status=mModule.startRecognition(soundModelHandle,recognitionConfig);
  if (status != SoundTrigger.STATUS_OK) {
    Slog.w(TAG,"startRecognition failed with " + status);
    return status;
  }
  mCurrentSoundModelHandle=soundModelHandle;
  mCurrentSoundModelUuid=soundModel.uuid;
  mActiveListeners.put(keyphraseId,listener);
  return STATUS_OK;
}
