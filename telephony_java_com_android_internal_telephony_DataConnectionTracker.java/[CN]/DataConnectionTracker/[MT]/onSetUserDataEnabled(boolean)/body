{
synchronized (mDataEnabledLock) {
    final boolean prevEnabled=getAnyDataEnabled();
    if (mUserDataEnabled != enabled) {
      mUserDataEnabled=enabled;
      Settings.Secure.putInt(mPhone.getContext().getContentResolver(),Settings.Secure.MOBILE_DATA,enabled ? 1 : 0);
      if (getDataOnRoamingEnabled() == false && mPhone.getServiceState().getRoaming() == true) {
        if (enabled) {
          notifyOffApnsOfAvailability(Phone.REASON_ROAMING_ON);
        }
 else {
          notifyOffApnsOfAvailability(Phone.REASON_DATA_DISABLED);
        }
      }
      if (prevEnabled != getAnyDataEnabled()) {
        if (!prevEnabled) {
          resetAllRetryCounts();
          onTrySetupData(Phone.REASON_DATA_ENABLED);
        }
 else {
          onCleanUpAllConnections(Phone.REASON_DATA_DISABLED);
        }
      }
    }
  }
}
