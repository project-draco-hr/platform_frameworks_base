{
  final ArraySet<String> pinnedByCallerSet=(callingLauncher == null) ? null : s.getLauncherShortcuts(callingLauncher,mUserId,launcherUserId).getPinnedShortcutIds(mPackageName);
  for (int i=0; i < mShortcuts.size(); i++) {
    final ShortcutInfo si=mShortcuts.valueAt(i);
    final boolean isPinnedByCaller=(callingLauncher == null) || ((pinnedByCallerSet != null) && pinnedByCallerSet.contains(si.getId()));
    if (!si.isDynamic()) {
      if (!si.isPinned()) {
        s.wtf("Shortcut not pinned here");
        continue;
      }
      if (!isPinnedByCaller) {
        continue;
      }
    }
    final ShortcutInfo clone=si.clone(cloneFlag);
    if (!isPinnedByCaller) {
      clone.clearFlags(ShortcutInfo.FLAG_PINNED);
    }
    if (query == null || query.test(clone)) {
      result.add(clone);
    }
  }
}
