{
  Message ret;
synchronized (this) {
    long time=SystemClock.uptimeMillis();
    waitBeforeReturning=false;
    this.notifyAll();
    try {
      while (nextMessage == null) {
        if (failTimeoutMillis > 0 && ((SystemClock.uptimeMillis() - time) > failTimeoutMillis)) {
          throw new RuntimeException("Timeout exceeded exceeded");
        }
        try {
          this.wait(failTimeoutMillis);
        }
 catch (        InterruptedException ex) {
        }
      }
      ret=nextMessage;
      nextMessage=null;
    }
  finally {
      waitBeforeReturning=true;
    }
  }
  return ret;
}
