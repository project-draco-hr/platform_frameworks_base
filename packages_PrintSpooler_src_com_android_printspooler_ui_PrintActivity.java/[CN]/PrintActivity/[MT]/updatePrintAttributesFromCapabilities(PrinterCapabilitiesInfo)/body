{
  PrintAttributes defaults=capabilities.getDefaults();
  List<MediaSize> sortedMediaSizes=new ArrayList<>(capabilities.getMediaSizes());
  Collections.sort(sortedMediaSizes,mMediaSizeComparator);
  PrintAttributes attributes=mPrintJob.getAttributes();
  MediaSize currMediaSize=attributes.getMediaSize();
  if (currMediaSize == null) {
    attributes.setMediaSize(defaults.getMediaSize());
  }
 else {
    boolean foundCurrentMediaSize=false;
    MediaSize currMediaSizePortrait=currMediaSize.asPortrait();
    final int mediaSizeCount=sortedMediaSizes.size();
    for (int i=0; i < mediaSizeCount; i++) {
      MediaSize mediaSize=sortedMediaSizes.get(i);
      if (currMediaSizePortrait.equals(mediaSize.asPortrait())) {
        attributes.setMediaSize(currMediaSize);
        foundCurrentMediaSize=true;
        break;
      }
    }
    if (!foundCurrentMediaSize) {
      attributes.setMediaSize(defaults.getMediaSize());
    }
  }
  final int colorMode=attributes.getColorMode();
  if ((capabilities.getColorModes() & colorMode) == 0) {
    attributes.setColorMode(defaults.getColorMode());
  }
  Resolution resolution=attributes.getResolution();
  if (resolution == null || !capabilities.getResolutions().contains(resolution)) {
    attributes.setResolution(defaults.getResolution());
  }
  attributes.setMinMargins(defaults.getMinMargins());
}
