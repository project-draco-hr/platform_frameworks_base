{
  MockIpManagerCallback ipManagerCallback=new MockIpManagerCallback();
  ApfFilter apfFilter=new TestApfFilter(ipManagerCallback,false);
  byte[] program=ipManagerCallback.getApfProgram();
  ByteBuffer mcastv4packet=ByteBuffer.wrap(new byte[100]);
  mcastv4packet.putShort(ETH_ETHERTYPE_OFFSET,(short)ETH_P_IP);
  mcastv4packet.position(IPV4_DEST_ADDR_OFFSET);
  mcastv4packet.put(new byte[]{(byte)224,0,0,1});
  ByteBuffer mcastv6packet=ByteBuffer.wrap(new byte[100]);
  mcastv6packet.putShort(ETH_ETHERTYPE_OFFSET,(short)ETH_P_IPV6);
  mcastv6packet.put(IPV6_NEXT_HEADER_OFFSET,(byte)IPPROTO_UDP);
  mcastv6packet.position(IPV6_DEST_ADDR_OFFSET);
  mcastv6packet.put(new byte[]{(byte)0xff,2,0,0,0,0,0,0,0,0,0,0,0,0,0,(byte)0xfb});
  ByteBuffer bcastv4packet=ByteBuffer.wrap(new byte[100]);
  bcastv4packet.put(ETH_BROADCAST_MAC_ADDRESS);
  bcastv4packet.putShort(ETH_ETHERTYPE_OFFSET,(short)ETH_P_IP);
  bcastv4packet.position(IPV4_DEST_ADDR_OFFSET);
  bcastv4packet.put(new byte[]{(byte)192,(byte)0,(byte)2,(byte)63});
  assertPass(program,bcastv4packet.array(),0);
  assertPass(program,mcastv4packet.array(),0);
  assertPass(program,mcastv6packet.array(),0);
  ipManagerCallback.resetApfProgramWait();
  apfFilter.setMulticastFilter(true);
  program=ipManagerCallback.getApfProgram();
  assertDrop(program,bcastv4packet.array(),0);
  assertDrop(program,mcastv4packet.array(),0);
  assertDrop(program,mcastv6packet.array(),0);
  ipManagerCallback.resetApfProgramWait();
  apfFilter.setMulticastFilter(false);
  program=ipManagerCallback.getApfProgram();
  assertPass(program,bcastv4packet.array(),0);
  assertPass(program,mcastv4packet.array(),0);
  assertPass(program,mcastv6packet.array(),0);
  ipManagerCallback.resetApfProgramWait();
  apfFilter.shutdown();
  apfFilter=new TestApfFilter(ipManagerCallback,true);
  program=ipManagerCallback.getApfProgram();
  assertDrop(program,bcastv4packet.array(),0);
  assertDrop(program,mcastv4packet.array(),0);
  assertDrop(program,mcastv6packet.array(),0);
  mcastv6packet.put(IPV6_NEXT_HEADER_OFFSET,(byte)IPPROTO_ICMPV6);
  assertPass(program,mcastv6packet.array(),0);
  apfFilter.shutdown();
}
