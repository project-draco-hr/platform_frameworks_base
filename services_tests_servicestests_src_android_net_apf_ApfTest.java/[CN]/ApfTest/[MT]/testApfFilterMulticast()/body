{
  MockIpManagerCallback ipManagerCallback=new MockIpManagerCallback();
  ApfFilter apfFilter=new TestApfFilter(ipManagerCallback,false);
  byte[] program=ipManagerCallback.getApfProgram();
  ByteBuffer v4packet=ByteBuffer.wrap(new byte[100]);
  v4packet.putShort(ETH_ETHERTYPE_OFFSET,(short)ETH_P_IP);
  v4packet.position(IPV4_DEST_ADDR_OFFSET);
  v4packet.put(new byte[]{(byte)224,0,0,1});
  ByteBuffer v6packet=ByteBuffer.wrap(new byte[100]);
  v6packet.putShort(ETH_ETHERTYPE_OFFSET,(short)ETH_P_IPV6);
  v6packet.put(IPV6_NEXT_HEADER_OFFSET,(byte)IPPROTO_UDP);
  v6packet.position(IPV6_DEST_ADDR_OFFSET);
  v6packet.put(new byte[]{(byte)0xff,2,0,0,0,0,0,0,0,0,0,0,0,0,0,(byte)0xfb});
  assertPass(program,v4packet.array(),0);
  assertPass(program,v6packet.array(),0);
  ipManagerCallback.resetApfProgramWait();
  apfFilter.setMulticastFilter(true);
  program=ipManagerCallback.getApfProgram();
  assertDrop(program,v4packet.array(),0);
  assertDrop(program,v6packet.array(),0);
  ipManagerCallback.resetApfProgramWait();
  apfFilter.setMulticastFilter(false);
  program=ipManagerCallback.getApfProgram();
  assertPass(program,v4packet.array(),0);
  assertPass(program,v6packet.array(),0);
  ipManagerCallback.resetApfProgramWait();
  apfFilter.shutdown();
  apfFilter=new TestApfFilter(ipManagerCallback,true);
  program=ipManagerCallback.getApfProgram();
  assertDrop(program,v4packet.array(),0);
  assertDrop(program,v6packet.array(),0);
  v6packet.put(IPV6_NEXT_HEADER_OFFSET,(byte)IPPROTO_ICMPV6);
  assertPass(program,v6packet.array(),0);
  apfFilter.shutdown();
}
