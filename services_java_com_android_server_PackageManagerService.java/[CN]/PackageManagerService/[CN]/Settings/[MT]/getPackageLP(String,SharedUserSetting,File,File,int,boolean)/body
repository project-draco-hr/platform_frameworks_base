{
  PackageSetting p=mPackages.get(name);
  if (p != null) {
    if (!p.codePath.equals(codePath)) {
      PackageSetting ps=mDisabledSysPackages.get(name);
      if ((ps != null) && ((ps.pkgFlags & ApplicationInfo.FLAG_SYSTEM) != 0)) {
        return p;
      }
 else {
        reportSettingsProblem(Log.WARN,"Package " + name + " codePath changed from "+ p.codePath+ " to "+ codePath+ "; replacing with new");
        p=null;
      }
    }
 else     if (p.sharedUser != sharedUser) {
      reportSettingsProblem(Log.WARN,"Package " + name + " shared user changed from "+ (p.sharedUser != null ? p.sharedUser.name : "<nothing>")+ " to "+ (sharedUser != null ? sharedUser.name : "<nothing>")+ "; replacing with new");
      p=null;
    }
  }
  if (p == null) {
    if (!create) {
      return null;
    }
    p=new PackageSetting(name,codePath,resourcePath,pkgFlags);
    p.setTimeStamp(codePath.lastModified());
    if (sharedUser != null) {
      p.userId=sharedUser.userId;
    }
 else     if (MULTIPLE_APPLICATION_UIDS) {
      p.userId=newUserIdLP(p);
    }
 else {
      p.userId=FIRST_APPLICATION_UID;
    }
    if (p.userId < 0) {
      reportSettingsProblem(Log.WARN,"Package " + name + " could not be assigned a valid uid");
      return null;
    }
    mPackages.put(name,p);
  }
  if (sharedUser != null) {
    if (p.sharedUser != null && p.sharedUser != sharedUser) {
      reportSettingsProblem(Log.ERROR,"Package " + p.name + " was user "+ p.sharedUser+ " but is now "+ sharedUser+ "; I am not changing its files so it will probably fail!");
      p.sharedUser.packages.remove(p);
    }
 else     if (p.userId != sharedUser.userId) {
      reportSettingsProblem(Log.ERROR,"Package " + p.name + " was user id "+ p.userId+ " but is now user "+ sharedUser+ " with id "+ sharedUser.userId+ "; I am not changing its files so it will probably fail!");
    }
    sharedUser.packages.add(p);
    p.sharedUser=sharedUser;
    p.userId=sharedUser.userId;
  }
  return p;
}
