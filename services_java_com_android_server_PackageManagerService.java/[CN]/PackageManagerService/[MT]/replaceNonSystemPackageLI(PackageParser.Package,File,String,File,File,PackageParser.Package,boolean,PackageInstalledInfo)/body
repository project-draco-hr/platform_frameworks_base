{
  PackageParser.Package newPackage=null;
  String pkgName=deletedPackage.packageName;
  boolean deletedPkg=true;
  boolean updatedSettings=false;
  int parseFlags=PackageManager.REPLACE_EXISTING_PACKAGE;
  if (!deletePackageLI(pkgName,false,PackageManager.DONT_DELETE_DATA,res.removedInfo)) {
    res.returnCode=PackageManager.INSTALL_FAILED_REPLACE_COULDNT_DELETE;
    deletedPkg=false;
  }
 else {
    mLastScanError=PackageManager.INSTALL_SUCCEEDED;
    newPackage=scanPackageLI(tmpPackageFile,destPackageFile,destResourceFile,pkg,parseFlags,SCAN_MONITOR | SCAN_FORCE_DEX | SCAN_UPDATE_SIGNATURE| (forwardLocked ? SCAN_FORWARD_LOCKED : 0));
    if (newPackage == null) {
      Log.w(TAG,"Package couldn't be installed in " + destPackageFile);
      if ((res.returnCode=mLastScanError) == PackageManager.INSTALL_SUCCEEDED) {
        res.returnCode=PackageManager.INSTALL_FAILED_INVALID_APK;
      }
    }
 else {
      updateSettingsLI(pkgName,tmpPackageFile,destFilePath,destPackageFile,destResourceFile,pkg,newPackage,true,forwardLocked,res);
      updatedSettings=true;
    }
  }
  if (res.returnCode == PackageManager.INSTALL_SUCCEEDED) {
    final ApplicationInfo deletedPackageAppInfo=deletedPackage.applicationInfo;
    final ApplicationInfo installedPackageAppInfo=newPackage.applicationInfo;
    if (!deletedPackageAppInfo.sourceDir.equals(installedPackageAppInfo.sourceDir)) {
      new File(deletedPackageAppInfo.sourceDir).delete();
    }
    if (!deletedPackageAppInfo.publicSourceDir.equals(installedPackageAppInfo.publicSourceDir)) {
      new File(deletedPackageAppInfo.publicSourceDir).delete();
    }
synchronized (mPackages) {
      verifySignaturesLP(mSettings.mPackages.get(pkgName),pkg,parseFlags,true);
    }
  }
 else {
    if (updatedSettings) {
      deletePackageLI(pkgName,true,PackageManager.DONT_DELETE_DATA,res.removedInfo);
    }
    if (deletedPkg) {
      installPackageLI(Uri.fromFile(new File(deletedPackage.mPath)),isForwardLocked(deletedPackage) ? PackageManager.FORWARD_LOCK_PACKAGE : 0);
    }
  }
}
