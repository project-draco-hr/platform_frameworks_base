{
  String pkgName=newPackage.packageName;
synchronized (mPackages) {
    mSettings.setInstallStatus(pkgName,PKG_INSTALL_INCOMPLETE);
    mSettings.writeLP();
  }
  int retCode=0;
  if ((newPackage.applicationInfo.flags & ApplicationInfo.FLAG_HAS_CODE) != 0) {
    retCode=mInstaller.movedex(newPackage.mScanPath,newPackage.mPath);
    if (retCode != 0) {
      Log.e(TAG,"Couldn't rename dex file: " + newPackage.mPath);
      res.returnCode=PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;
      return;
    }
  }
  res.returnCode=setPermissionsLI(newPackage);
  if (res.returnCode != PackageManager.INSTALL_SUCCEEDED) {
    return;
  }
 else {
    Log.d(TAG,"New package installed in " + newPackage.mPath);
  }
  if (res.returnCode != PackageManager.INSTALL_SUCCEEDED) {
    if (mInstaller != null) {
      mInstaller.rmdex(newPackage.mScanPath);
    }
  }
synchronized (mPackages) {
    grantPermissionsLP(newPackage,true);
    res.name=pkgName;
    res.uid=newPackage.applicationInfo.uid;
    res.pkg=newPackage;
    mSettings.setInstallStatus(pkgName,PKG_INSTALL_COMPLETE);
    mSettings.setInstallerPackageName(pkgName,installerPackageName);
    res.returnCode=PackageManager.INSTALL_SUCCEEDED;
    mSettings.writeLP();
  }
}
