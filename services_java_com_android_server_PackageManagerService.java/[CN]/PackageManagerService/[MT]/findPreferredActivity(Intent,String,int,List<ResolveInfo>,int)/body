{
synchronized (mPackages) {
    if (DEBUG_PREFERRED)     intent.addFlags(Intent.FLAG_DEBUG_LOG_RESOLUTION);
    List<PreferredActivity> prefs=mSettings.mPreferredActivities.queryIntent(intent,resolvedType,(flags & PackageManager.MATCH_DEFAULT_ONLY) != 0);
    if (prefs != null && prefs.size() > 0) {
      int match=0;
      final int N=query.size();
      if (DEBUG_PREFERRED)       Log.v(TAG,"Figuring out best match...");
      for (int j=0; j < N; j++) {
        ResolveInfo ri=query.get(j);
        if (DEBUG_PREFERRED)         Log.v(TAG,"Match for " + ri.activityInfo + ": 0x"+ Integer.toHexString(match));
        if (ri.match > match)         match=ri.match;
      }
      if (DEBUG_PREFERRED)       Log.v(TAG,"Best match: 0x" + Integer.toHexString(match));
      match&=IntentFilter.MATCH_CATEGORY_MASK;
      final int M=prefs.size();
      for (int i=0; i < M; i++) {
        PreferredActivity pa=prefs.get(i);
        if (pa.mMatch != match) {
          continue;
        }
        ActivityInfo ai=getActivityInfo(pa.mActivity,flags);
        if (DEBUG_PREFERRED) {
          Log.v(TAG,"Got preferred activity:");
          ai.dump(new LogPrinter(Log.INFO,TAG),"  ");
        }
        if (ai != null) {
          for (int j=0; j < N; j++) {
            ResolveInfo ri=query.get(j);
            if (!ri.activityInfo.applicationInfo.packageName.equals(ai.applicationInfo.packageName)) {
              continue;
            }
            if (!ri.activityInfo.name.equals(ai.name)) {
              continue;
            }
            if (!pa.sameSet(query,priority)) {
              Slog.i(TAG,"Result set changed, dropping preferred activity for " + intent + " type "+ resolvedType);
              mSettings.mPreferredActivities.removeFilter(pa);
              return null;
            }
            return ri;
          }
        }
      }
    }
  }
  return null;
}
