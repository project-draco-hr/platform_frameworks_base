{
  MountService mountService=getMountService();
  long len=tmpPackageFile.length();
  int mbLen=(int)(len / (1024 * 1024));
  if ((len - (mbLen * 1024 * 1024)) > 0) {
    mbLen++;
  }
  if (DEBUG_SD_INSTALL)   Log.i(TAG,"mbLen=" + mbLen);
  String cachePath=null;
  String sdEncKey;
  try {
    sdEncKey=SystemKeyStore.getInstance().retrieveKeyHexString(mSdEncryptKey);
    if (sdEncKey == null) {
      sdEncKey=SystemKeyStore.getInstance().generateNewKeyHexString(128,mSdEncryptAlg,mSdEncryptKey);
      if (sdEncKey == null) {
        Log.e(TAG,"Failed to create encryption keys for package: " + pkgName + ".");
        return null;
      }
    }
  }
 catch (  NoSuchAlgorithmException nsae) {
    Log.e(TAG,"Failed to create encryption keys with exception: " + nsae);
    return null;
  }
  try {
    cachePath=mountService.createSecureContainer(pkgName,mbLen,"vfat",sdEncKey,Process.SYSTEM_UID);
    if (DEBUG_SD_INSTALL)     Log.i(TAG,"Trying to install " + pkgName + ", cachePath ="+ cachePath);
    return cachePath;
  }
 catch (  IllegalStateException e) {
    Log.e(TAG,"Failed to create storage on sdcard with exception: " + e);
  }
  try {
    mountService.destroySecureContainer(pkgName);
    if (DEBUG_SD_INSTALL)     Log.i(TAG,"Destroying cache for " + pkgName + ", cachePath ="+ cachePath);
  }
 catch (  IllegalStateException e) {
    Log.e(TAG,"Failed to destroy existing cache: " + e);
    return null;
  }
  try {
    cachePath=mountService.createSecureContainer(pkgName,mbLen,"vfat",sdEncKey,Process.SYSTEM_UID);
    if (DEBUG_SD_INSTALL)     Log.i(TAG,"Trying to install again " + pkgName + ", cachePath ="+ cachePath);
    return cachePath;
  }
 catch (  IllegalStateException e) {
    Log.e(TAG,"Failed to create storage on sdcard with exception: " + e);
    return null;
  }
}
