{
  mContext.enforceCallingOrSelfPermission(android.Manifest.permission.MOVE_PACKAGE,null);
  int returnCode=PackageManager.MOVE_SUCCEEDED;
  int currFlags=0;
  int newFlags=0;
synchronized (mPackages) {
    PackageParser.Package pkg=mPackages.get(packageName);
    if (pkg == null) {
      returnCode=PackageManager.MOVE_FAILED_DOESNT_EXIST;
    }
 else {
      if (pkg.applicationInfo != null && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) != 0) {
        Slog.w(TAG,"Cannot move system application");
        returnCode=PackageManager.MOVE_FAILED_SYSTEM_PACKAGE;
      }
 else       if (pkg.applicationInfo != null && (pkg.applicationInfo.flags & ApplicationInfo.FLAG_FORWARD_LOCK) != 0) {
        Slog.w(TAG,"Cannot move forward locked app.");
        returnCode=PackageManager.MOVE_FAILED_FORWARD_LOCKED;
      }
 else       if (pkg.mOperationPending) {
        Slog.w(TAG,"Attempt to move package which has pending operations");
        returnCode=PackageManager.MOVE_FAILED_OPERATION_PENDING;
      }
 else {
        if ((flags & PackageManager.MOVE_EXTERNAL_MEDIA) != 0 && (flags & PackageManager.MOVE_INTERNAL) != 0) {
          Slog.w(TAG,"Ambigous flags specified for move location.");
          returnCode=PackageManager.MOVE_FAILED_INVALID_LOCATION;
        }
 else {
          newFlags=(flags & PackageManager.MOVE_EXTERNAL_MEDIA) != 0 ? PackageManager.INSTALL_EXTERNAL : PackageManager.INSTALL_INTERNAL;
          currFlags=(pkg.applicationInfo.flags & ApplicationInfo.FLAG_EXTERNAL_STORAGE) != 0 ? PackageManager.INSTALL_EXTERNAL : PackageManager.INSTALL_INTERNAL;
          if (newFlags == currFlags) {
            Slog.w(TAG,"No move required. Trying to move to same location");
            returnCode=PackageManager.MOVE_FAILED_INVALID_LOCATION;
          }
        }
        if (returnCode == PackageManager.MOVE_SUCCEEDED) {
          pkg.mOperationPending=true;
        }
      }
    }
    if (returnCode != PackageManager.MOVE_SUCCEEDED) {
      processPendingMove(new MoveParams(null,observer,0,packageName),returnCode);
    }
 else {
      Message msg=mHandler.obtainMessage(INIT_COPY);
      InstallArgs srcArgs=createInstallArgs(currFlags,pkg.applicationInfo.sourceDir,pkg.applicationInfo.publicSourceDir);
      MoveParams mp=new MoveParams(srcArgs,observer,newFlags,packageName);
      msg.obj=mp;
      mHandler.sendMessage(msg);
    }
  }
}
