{
  if (!isAutomaticTimeRequested())   return;
  final long refTime=SystemClock.elapsedRealtime();
  if (mNitzTimeSetTime != NOT_SET && refTime - mNitzTimeSetTime < mPollingIntervalMs) {
    resetAlarm(mPollingIntervalMs);
    return;
  }
  final long currentTime=System.currentTimeMillis();
  if (DBG)   Log.d(TAG,"System time = " + currentTime);
  if (mLastNtpFetchTime == NOT_SET || refTime >= mLastNtpFetchTime + mPollingIntervalMs || event == EVENT_AUTO_TIME_CHANGED) {
    if (DBG)     Log.d(TAG,"Before Ntp fetch");
    if (mTime.getCacheAge() >= mPollingIntervalMs) {
      mTime.forceRefresh();
    }
    if (mTime.getCacheAge() < mPollingIntervalMs) {
      final long ntp=mTime.currentTimeMillis();
      mTryAgainCounter=0;
      if (Math.abs(ntp - currentTime) > mTimeErrorThresholdMs || mLastNtpFetchTime == NOT_SET) {
        if (DBG && mLastNtpFetchTime == NOT_SET && Math.abs(ntp - currentTime) <= mTimeErrorThresholdMs) {
          Log.d(TAG,"For initial setup, rtc = " + currentTime);
        }
        if (DBG)         Log.d(TAG,"Ntp time to be set = " + ntp);
        if (ntp / 1000 < Integer.MAX_VALUE) {
          SystemClock.setCurrentTimeMillis(ntp);
        }
      }
 else {
        if (DBG)         Log.d(TAG,"Ntp time is close enough = " + ntp);
      }
      mLastNtpFetchTime=SystemClock.elapsedRealtime();
    }
 else {
      mTryAgainCounter++;
      if (mTryAgainTimesMax < 0 || mTryAgainCounter <= mTryAgainTimesMax) {
        resetAlarm(mPollingIntervalShorterMs);
      }
 else {
        mTryAgainCounter=0;
        resetAlarm(mPollingIntervalMs);
      }
      return;
    }
  }
  resetAlarm(mPollingIntervalMs);
}
