{
  int state=mLocalBluetoothManager.getBluetoothAdapter().getConnectionState();
  if (state != mConnectionState) {
    mConnectionState=state;
    mHandler.sendEmptyMessage(H.MSG_STATE_CHANGED);
  }
  if (mLastDevice != null && mLastDevice.isConnected()) {
    return;
  }
  mLastDevice=null;
  for (  CachedBluetoothDevice device : getDevices()) {
    if (device.isConnected()) {
      mLastDevice=device;
    }
  }
  if (mLastDevice == null && mConnectionState == BluetoothAdapter.STATE_CONNECTED) {
    mConnectionState=BluetoothAdapter.STATE_DISCONNECTED;
    mHandler.sendEmptyMessage(H.MSG_STATE_CHANGED);
  }
}
