{
  final int layerCount=getNumberOfLayers();
  if (layerCount == 0) {
    return;
  }
  getDrawable(0).draw(canvas);
  final ArrayList<Ripple> activeRipples=mActiveRipples;
  if (layerCount == 1 || activeRipples == null || activeRipples.isEmpty()) {
    return;
  }
  final Rect bounds=getBounds();
  final int width=bounds.width();
  final int height=bounds.height();
  if (mRipplePaint == null) {
    mRipplePaint=new Paint();
    mRipplePaint.setAntiAlias(true);
  }
  boolean needsMask=false;
  int layerSaveCount=-1;
  int n=activeRipples.size();
  for (int i=0; i < n; i++) {
    final Ripple ripple=activeRipples.get(i);
    if (!ripple.active()) {
      activeRipples.remove(i);
      i--;
      n--;
    }
 else {
      if (layerSaveCount < 0) {
        layerSaveCount=canvas.saveLayer(0,0,width,height,null,0);
      }
      needsMask|=ripple.draw(canvas,mRipplePaint);
    }
  }
  if (layerSaveCount >= 0) {
    if (needsMask) {
      if (mMaskingPaint == null) {
        mMaskingPaint=new Paint();
        mMaskingPaint.setXfermode(new PorterDuffXfermode(Mode.SRC_IN));
      }
      canvas.saveLayer(0,0,width,height,mMaskingPaint,0);
      getDrawable(1).draw(canvas);
    }
    canvas.restoreToCount(layerSaveCount);
  }
}
