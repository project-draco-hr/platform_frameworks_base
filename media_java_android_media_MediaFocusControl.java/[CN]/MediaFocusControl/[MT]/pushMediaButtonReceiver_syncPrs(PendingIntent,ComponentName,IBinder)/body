{
  if (mPRStack.empty()) {
    mPRStack.push(new PlayerRecord(mediaIntent,target,token));
    return true;
  }
 else   if (mPRStack.peek().hasMatchingMediaButtonIntent(mediaIntent)) {
    return false;
  }
  if (mAppOps.noteOp(AppOpsManager.OP_TAKE_MEDIA_BUTTONS,Binder.getCallingUid(),mediaIntent.getCreatorPackage()) != AppOpsManager.MODE_ALLOWED) {
    return false;
  }
  PlayerRecord oldTopPrse=mPRStack.lastElement();
  boolean topChanged=false;
  PlayerRecord prse=null;
  int lastPlayingIndex=mPRStack.size();
  int inStackIndex=-1;
  try {
    for (int index=mPRStack.size() - 1; index >= 0; index--) {
      prse=mPRStack.elementAt(index);
      if (prse.isPlaybackActive()) {
        lastPlayingIndex=index;
      }
      if (prse.hasMatchingMediaButtonIntent(mediaIntent)) {
        inStackIndex=index;
      }
    }
    if (inStackIndex == -1) {
      prse=new PlayerRecord(mediaIntent,target,token);
      mPRStack.add(lastPlayingIndex,prse);
    }
 else {
      if (mPRStack.size() > 1) {
        prse=mPRStack.elementAt(inStackIndex);
        mPRStack.removeElementAt(inStackIndex);
        if (prse.isPlaybackActive()) {
          mPRStack.push(prse);
        }
 else {
          if (inStackIndex > lastPlayingIndex) {
            mPRStack.add(lastPlayingIndex,prse);
          }
 else {
            mPRStack.add(lastPlayingIndex - 1,prse);
          }
        }
      }
    }
  }
 catch (  ArrayIndexOutOfBoundsException e) {
    Log.e(TAG,"Wrong index (inStack=" + inStackIndex + " lastPlaying="+ lastPlayingIndex+ " size="+ mPRStack.size()+ " accessing media button stack",e);
  }
  return (topChanged);
}
