{
  Log.i(TAG," AudioFocus  requestAudioFocus() from " + clientId);
  if (!cb.pingBinder()) {
    Log.e(TAG," AudioFocus DOA client for requestAudioFocus(), aborting.");
    return AudioManager.AUDIOFOCUS_REQUEST_FAILED;
  }
  if (mAppOps.noteOp(AppOpsManager.OP_TAKE_AUDIO_FOCUS,Binder.getCallingUid(),callingPackageName) != AppOpsManager.MODE_ALLOWED) {
    return AudioManager.AUDIOFOCUS_REQUEST_FAILED;
  }
synchronized (mAudioFocusLock) {
    if (!canReassignAudioFocus()) {
      return AudioManager.AUDIOFOCUS_REQUEST_FAILED;
    }
    AudioFocusDeathHandler afdh=new AudioFocusDeathHandler(cb);
    try {
      cb.linkToDeath(afdh,0);
    }
 catch (    RemoteException e) {
      Log.w(TAG,"AudioFocus  requestAudioFocus() could not link to " + cb + " binder death");
      return AudioManager.AUDIOFOCUS_REQUEST_FAILED;
    }
    if (!mFocusStack.empty() && mFocusStack.peek().mClientId.equals(clientId)) {
      if (mFocusStack.peek().mFocusChangeType == focusChangeHint) {
        cb.unlinkToDeath(afdh,0);
        return AudioManager.AUDIOFOCUS_REQUEST_GRANTED;
      }
      FocusStackEntry fse=mFocusStack.pop();
      fse.unlinkToDeath();
    }
    if (!mFocusStack.empty() && (mFocusStack.peek().mFocusDispatcher != null)) {
      try {
        mFocusStack.peek().mFocusDispatcher.dispatchAudioFocusChange(-1 * focusChangeHint,mFocusStack.peek().mClientId);
      }
 catch (      RemoteException e) {
        Log.e(TAG," Failure to signal loss of focus due to " + e);
        e.printStackTrace();
      }
    }
    removeFocusStackEntry(clientId,false);
    mFocusStack.push(new FocusStackEntry(mainStreamType,focusChangeHint,fd,cb,clientId,afdh,callingPackageName,Binder.getCallingUid()));
synchronized (mRCStack) {
      checkUpdateRemoteControlDisplay_syncAfRcs(RC_INFO_ALL);
    }
  }
  return AudioManager.AUDIOFOCUS_REQUEST_GRANTED;
}
