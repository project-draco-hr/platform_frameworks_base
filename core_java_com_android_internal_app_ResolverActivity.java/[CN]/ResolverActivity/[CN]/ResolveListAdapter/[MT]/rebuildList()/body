{
  List<ResolveInfo> currentResolveList;
  try {
    mLastChosen=AppGlobals.getPackageManager().getLastChosenActivity(mIntent,mIntent.resolveTypeIfNeeded(getContentResolver()),PackageManager.MATCH_DEFAULT_ONLY);
  }
 catch (  RemoteException re) {
    Log.d(TAG,"Error calling setLastChosenActivity\n" + re);
  }
  mOtherProfile=null;
  mList.clear();
  if (mBaseResolveList != null) {
    currentResolveList=mOrigResolveList=mBaseResolveList;
  }
 else {
    currentResolveList=mOrigResolveList=mPm.queryIntentActivities(mIntent,PackageManager.MATCH_DEFAULT_ONLY | (mFilterLastUsed ? PackageManager.GET_RESOLVED_FILTER : 0) | (shouldGetActivityMetadata() ? PackageManager.GET_META_DATA : 0));
    if (currentResolveList != null) {
      for (int i=currentResolveList.size() - 1; i >= 0; i--) {
        ActivityInfo ai=currentResolveList.get(i).activityInfo;
        int granted=ActivityManager.checkComponentPermission(ai.permission,mLaunchedFromUid,ai.applicationInfo.uid,ai.exported);
        if (granted != PackageManager.PERMISSION_GRANTED) {
          if (mOrigResolveList == currentResolveList) {
            mOrigResolveList=new ArrayList<ResolveInfo>(mOrigResolveList);
          }
          currentResolveList.remove(i);
        }
      }
    }
  }
  int N;
  if ((currentResolveList != null) && ((N=currentResolveList.size()) > 0)) {
    ResolveInfo r0=currentResolveList.get(0);
    for (int i=1; i < N; i++) {
      ResolveInfo ri=currentResolveList.get(i);
      if (DEBUG)       Log.v(TAG,r0.activityInfo.name + "=" + r0.priority+ "/"+ r0.isDefault+ " vs "+ ri.activityInfo.name+ "="+ ri.priority+ "/"+ ri.isDefault);
      if (r0.priority != ri.priority || r0.isDefault != ri.isDefault) {
        while (i < N) {
          if (mOrigResolveList == currentResolveList) {
            mOrigResolveList=new ArrayList<ResolveInfo>(mOrigResolveList);
          }
          currentResolveList.remove(i);
          N--;
        }
      }
    }
    if (N > 1) {
      Comparator<ResolveInfo> rComparator=new ResolverComparator(ResolverActivity.this,mIntent);
      Collections.sort(currentResolveList,rComparator);
    }
    if (mInitialIntents != null) {
      for (int i=0; i < mInitialIntents.length; i++) {
        Intent ii=mInitialIntents[i];
        if (ii == null) {
          continue;
        }
        ActivityInfo ai=ii.resolveActivityInfo(getPackageManager(),0);
        if (ai == null) {
          Log.w(TAG,"No activity found for " + ii);
          continue;
        }
        ResolveInfo ri=new ResolveInfo();
        ri.activityInfo=ai;
        UserManager userManager=(UserManager)getSystemService(Context.USER_SERVICE);
        if (userManager.isManagedProfile()) {
          ri.noResourceId=true;
        }
        if (ii instanceof LabeledIntent) {
          LabeledIntent li=(LabeledIntent)ii;
          ri.resolvePackageName=li.getSourcePackage();
          ri.labelRes=li.getLabelResource();
          ri.nonLocalizedLabel=li.getNonLocalizedLabel();
          ri.icon=li.getIconResource();
        }
        addResolveInfo(new DisplayResolveInfo(ri,ri.loadLabel(getPackageManager()),null,ii));
      }
    }
    r0=currentResolveList.get(0);
    int start=0;
    CharSequence r0Label=r0.loadLabel(mPm);
    mHasExtendedInfo=false;
    for (int i=1; i < N; i++) {
      if (r0Label == null) {
        r0Label=r0.activityInfo.packageName;
      }
      ResolveInfo ri=currentResolveList.get(i);
      CharSequence riLabel=ri.loadLabel(mPm);
      if (riLabel == null) {
        riLabel=ri.activityInfo.packageName;
      }
      if (riLabel.equals(r0Label)) {
        continue;
      }
      processGroup(currentResolveList,start,(i - 1),r0,r0Label);
      r0=ri;
      r0Label=riLabel;
      start=i;
    }
    processGroup(currentResolveList,start,(N - 1),r0,r0Label);
  }
  if (mOtherProfile != null && mLastChosenPosition >= 0) {
    mLastChosenPosition=-1;
    mFilterLastUsed=false;
  }
  onListRebuilt();
}
