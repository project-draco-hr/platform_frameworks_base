{
  if (Config.LOGD) {
    Log.d(TAG,"processSetUpMenu begins");
  }
  Menu menu=new Menu();
  boolean first=true;
  boolean removeExistingMenu=false;
  Iterator<ComprehensionTlv> iter=ctlvs.iterator();
  ComprehensionTlv ctlv=searchForTag(ComprehensionTlvTag.ALPHA_ID,ctlvs);
  if (ctlv != null) {
    menu.title=retrieveAlphaId(ctlv);
  }
  ctlv=searchForTag(ComprehensionTlvTag.TEXT_ATTRIBUTE,ctlvs);
  if (ctlv != null) {
    menu.titleAttrs=retrieveTextAttribute(ctlv);
  }
  while (true) {
    ctlv=searchForNextTag(ComprehensionTlvTag.ITEM,iter);
    if (ctlv != null) {
      Item item=retrieveItem(ctlv);
      if (first && item == null) {
        removeExistingMenu=true;
        break;
      }
      menu.items.add(retrieveItem(ctlv));
      first=false;
    }
 else {
      break;
    }
  }
  menu.softKeyPreferred=(cmdDet.commandQualifier & 0x01) != 0;
  menu.helpAvailable=(cmdDet.commandQualifier & 0x80) != 0;
  if (menu.items.size() == 0 && !removeExistingMenu) {
    if (Config.LOGD) {
      Log.d(TAG,"processSetUpMenu: Need at least one menu item");
    }
    throw new ResultException(ResultCode.REQUIRED_VALUES_MISSING);
  }
  mCmdParams=new CommandParams(cmdDet);
  if (removeExistingMenu) {
    mState=State.IDLE;
    mMainMenu=null;
    setAppState(false);
  }
 else {
    Menu currentMenu=mMainMenu;
    mState=State.MAIN_MENU;
    mMainMenu=menu;
    if (!isStkSupported()) {
      setAppState(true);
      setAppIndication(APP_INDICATOR_INSTALLED_NORMAL);
      mInstallIndicator=APP_INDICATOR_INSTALLED_NORMAL;
    }
  }
  return true;
}
