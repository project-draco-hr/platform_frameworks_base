{
  checkIncomingCall(pkg);
  if (!pkg.equals("com.android.providers.downloads") || Log.isLoggable("DownloadManager",Log.VERBOSE)) {
    EventLog.writeEvent(EVENT_LOG_ENQUEUE,pkg,id,notification.toString());
  }
  if (pkg == null || notification == null) {
    throw new IllegalArgumentException("null not allowed: pkg=" + pkg + " id="+ id+ " notification="+ notification);
  }
  if (notification.icon != 0) {
    if (notification.contentView == null) {
      throw new IllegalArgumentException("contentView required: pkg=" + pkg + " id="+ id+ " notification="+ notification);
    }
    if (notification.contentIntent == null) {
      throw new IllegalArgumentException("contentIntent required: pkg=" + pkg + " id="+ id+ " notification="+ notification);
    }
  }
synchronized (mNotificationList) {
    NotificationRecord r=new NotificationRecord(pkg,id,notification);
    NotificationRecord old=null;
    int index=indexOfNotificationLocked(pkg,id);
    if (index < 0) {
      mNotificationList.add(r);
    }
 else {
      old=mNotificationList.remove(index);
      mNotificationList.add(index,r);
      if (old != null) {
        notification.flags|=old.notification.flags & Notification.FLAG_FOREGROUND_SERVICE;
      }
    }
    if ((notification.flags & Notification.FLAG_FOREGROUND_SERVICE) != 0) {
      notification.flags|=Notification.FLAG_ONGOING_EVENT | Notification.FLAG_NO_CLEAR;
    }
    if (notification.icon != 0) {
      IconData icon=IconData.makeIcon(null,pkg,notification.icon,notification.iconLevel,notification.number);
      CharSequence truncatedTicker=notification.tickerText;
      final int maxTickerLen=80;
      if (truncatedTicker != null && truncatedTicker.length() > maxTickerLen) {
        truncatedTicker=truncatedTicker.subSequence(0,maxTickerLen);
      }
      NotificationData n=new NotificationData();
      n.id=id;
      n.pkg=pkg;
      n.when=notification.when;
      n.tickerText=truncatedTicker;
      n.ongoingEvent=(notification.flags & Notification.FLAG_ONGOING_EVENT) != 0;
      if (!n.ongoingEvent && (notification.flags & Notification.FLAG_NO_CLEAR) == 0) {
        n.clearable=true;
      }
      n.contentView=notification.contentView;
      n.contentIntent=notification.contentIntent;
      n.deleteIntent=notification.deleteIntent;
      if (old != null && old.statusBarKey != null) {
        r.statusBarKey=old.statusBarKey;
        long identity=Binder.clearCallingIdentity();
        try {
          mStatusBarService.updateIcon(r.statusBarKey,icon,n);
        }
  finally {
          Binder.restoreCallingIdentity(identity);
        }
      }
 else {
        long identity=Binder.clearCallingIdentity();
        try {
          r.statusBarKey=mStatusBarService.addIcon(icon,n);
          mHardware.pulseBreathingLight();
        }
  finally {
          Binder.restoreCallingIdentity(identity);
        }
      }
      sendAccessibilityEvent(notification,pkg);
    }
 else {
      if (old != null && old.statusBarKey != null) {
        long identity=Binder.clearCallingIdentity();
        try {
          mStatusBarService.removeIcon(old.statusBarKey);
        }
  finally {
          Binder.restoreCallingIdentity(identity);
        }
      }
    }
    if (((mDisabledNotifications & StatusBarManager.DISABLE_NOTIFICATION_ALERTS) == 0) && (!(old != null && (notification.flags & Notification.FLAG_ONLY_ALERT_ONCE) != 0)) && mSystemReady) {
      final boolean useDefaultSound=(notification.defaults & Notification.DEFAULT_SOUND) != 0;
      if (useDefaultSound || notification.sound != null) {
        Uri uri;
        if (useDefaultSound) {
          uri=Settings.System.DEFAULT_NOTIFICATION_URI;
        }
 else {
          uri=notification.sound;
        }
        boolean looping=(notification.flags & Notification.FLAG_INSISTENT) != 0;
        int audioStreamType;
        if (notification.audioStreamType >= 0) {
          audioStreamType=notification.audioStreamType;
        }
 else {
          audioStreamType=DEFAULT_STREAM_TYPE;
        }
        mSoundNotification=r;
        long identity=Binder.clearCallingIdentity();
        try {
          mSound.play(mContext,uri,looping,audioStreamType);
        }
  finally {
          Binder.restoreCallingIdentity(identity);
        }
      }
      final AudioManager audioManager=(AudioManager)mContext.getSystemService(Context.AUDIO_SERVICE);
      final boolean useDefaultVibrate=(notification.defaults & Notification.DEFAULT_VIBRATE) != 0;
      if ((useDefaultVibrate || notification.vibrate != null) && audioManager.shouldVibrate(AudioManager.VIBRATE_TYPE_NOTIFICATION)) {
        mVibrateNotification=r;
        mVibrator.vibrate(useDefaultVibrate ? DEFAULT_VIBRATE_PATTERN : notification.vibrate,((notification.flags & Notification.FLAG_INSISTENT) != 0) ? 0 : -1);
      }
    }
    mLights.remove(old);
    if (mLedNotification == old) {
      mLedNotification=null;
    }
    if ((notification.flags & Notification.FLAG_SHOW_LIGHTS) != 0) {
      mLights.add(r);
      updateLightsLocked();
    }
 else {
      if (old != null && ((old.notification.flags & Notification.FLAG_SHOW_LIGHTS) != 0)) {
        updateLightsLocked();
      }
    }
  }
  idOut[0]=id;
}
