{
  int currentUser=ActivityManager.getCurrentUser();
  String flatIn=Settings.Secure.getStringForUser(mContext.getContentResolver(),Settings.Secure.ENABLED_NOTIFICATION_LISTENERS,currentUser);
  if (!TextUtils.isEmpty(flatIn)) {
    if (DBG)     Slog.v(TAG,"flat before: " + flatIn);
    PackageManager pm=mContext.getPackageManager();
    List<ResolveInfo> installedServices=pm.queryIntentServicesAsUser(new Intent(NotificationListenerService.SERVICE_INTERFACE),PackageManager.GET_SERVICES | PackageManager.GET_META_DATA,currentUser);
    Set<ComponentName> installed=new HashSet<ComponentName>();
    for (int i=0, count=installedServices.size(); i < count; i++) {
      ResolveInfo resolveInfo=installedServices.get(i);
      ServiceInfo info=resolveInfo.serviceInfo;
      if (!android.Manifest.permission.BIND_NOTIFICATION_LISTENER_SERVICE.equals(info.permission)) {
        Slog.w(TAG,"Skipping notification listener service " + info.packageName + "/"+ info.name+ ": it does not require the permission "+ android.Manifest.permission.BIND_NOTIFICATION_LISTENER_SERVICE);
        continue;
      }
      installed.add(new ComponentName(info.packageName,info.name));
    }
    String flatOut="";
    if (!installed.isEmpty()) {
      String[] enabled=flatIn.split(ENABLED_NOTIFICATION_LISTENERS_SEPARATOR);
      ArrayList<String> remaining=new ArrayList<String>(enabled.length);
      for (int i=0; i < enabled.length; i++) {
        ComponentName enabledComponent=ComponentName.unflattenFromString(enabled[i]);
        if (installed.contains(enabledComponent)) {
          remaining.add(enabled[i]);
        }
      }
      flatOut=TextUtils.join(ENABLED_NOTIFICATION_LISTENERS_SEPARATOR,remaining);
    }
    if (DBG)     Slog.v(TAG,"flat after: " + flatOut);
    if (!flatIn.equals(flatOut)) {
      Settings.Secure.putStringForUser(mContext.getContentResolver(),Settings.Secure.ENABLED_NOTIFICATION_LISTENERS,flatOut,currentUser);
    }
  }
}
