{
  SystemServicesProxy ssp=Recents.getSystemServices();
  if (toTransform != null && toTask.key != null) {
    Bitmap thumbnail;
synchronized (mHeaderBarLock) {
      int toHeaderWidth=(int)toTransform.rect.width();
      int toHeaderHeight=(int)(mHeaderBar.getMeasuredHeight() * toTransform.scale);
      boolean disabledInSafeMode=!toTask.isSystemApp && ssp.isInSafeMode();
      mHeaderBar.onTaskViewSizeChanged((int)toTransform.rect.width(),(int)toTransform.rect.height());
      thumbnail=Bitmap.createBitmap(toHeaderWidth,toHeaderHeight,Bitmap.Config.ARGB_8888);
      if (RecentsDebugFlags.Static.EnableTransitionThumbnailDebugMode) {
        thumbnail.eraseColor(0xFFff0000);
      }
 else {
        Canvas c=new Canvas(thumbnail);
        c.scale(toTransform.scale,toTransform.scale);
        Drawable icon=mHeaderBar.getIconView().getDrawable();
        if (icon != null) {
          icon.setCallback(null);
        }
        mHeaderBar.rebindToTask(toTask,false,disabledInSafeMode);
        mHeaderBar.setDimAlpha(toTransform.dimAlpha);
        mHeaderBar.draw(c);
        c.setBitmap(null);
      }
    }
    return thumbnail.createAshmemBitmap();
  }
  return null;
}
