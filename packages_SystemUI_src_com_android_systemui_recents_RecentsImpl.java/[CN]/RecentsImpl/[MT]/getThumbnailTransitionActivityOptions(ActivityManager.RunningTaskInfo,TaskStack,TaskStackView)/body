{
  if (topTask.stackId == FREEFORM_WORKSPACE_STACK_ID) {
    ArrayList<AppTransitionAnimationSpec> specs=new ArrayList<>();
    stackView.getScroller().setStackScrollToInitialState();
    ArrayList<Task> tasks=stack.getTasks();
    for (int i=tasks.size() - 1; i >= 0; i--) {
      Task task=tasks.get(i);
      if (SystemServicesProxy.isFreeformStack(task.key.stackId)) {
        mTmpTransform=stackView.getStackAlgorithm().getStackTransform(task,stackView.getScroller().getStackScroll(),mTmpTransform,null);
        Rect toTaskRect=new Rect();
        mTmpTransform.rect.round(toTaskRect);
        Bitmap thumbnail=getThumbnailBitmap(topTask,task,mTmpTransform);
        specs.add(new AppTransitionAnimationSpec(task.key.id,thumbnail,toTaskRect));
      }
    }
    AppTransitionAnimationSpec[] specsArray=new AppTransitionAnimationSpec[specs.size()];
    specs.toArray(specsArray);
    return ActivityOptions.makeThumbnailAspectScaleDownAnimation(mDummyStackView,specsArray,mHandler,this);
  }
 else {
    Task toTask=new Task();
    TaskViewTransform toTransform=getThumbnailTransitionTransform(stack,stackView,topTask.id,toTask);
    RectF toTaskRect=toTransform.rect;
    Bitmap thumbnail=getThumbnailBitmap(topTask,toTask,toTransform);
    if (thumbnail != null) {
      return ActivityOptions.makeThumbnailAspectScaleDownAnimation(mDummyStackView,thumbnail,(int)toTaskRect.left,(int)toTaskRect.top,(int)toTaskRect.width(),(int)toTaskRect.height(),mHandler,this);
    }
    return getUnknownTransitionActivityOptions();
  }
}
