{
  if (runningTask != null && runningTask.stackId == FREEFORM_WORKSPACE_STACK_ID) {
    ArrayList<AppTransitionAnimationSpec> specs=new ArrayList<>();
    ArrayList<Task> tasks=stackView.getStack().getStackTasks();
    TaskStackLayoutAlgorithm stackLayout=stackView.getStackAlgorithm();
    TaskStackViewScroller stackScroller=stackView.getScroller();
    stackView.updateLayoutAlgorithm(true);
    stackView.updateToInitialState();
    for (int i=tasks.size() - 1; i >= 0; i--) {
      Task task=tasks.get(i);
      if (task.isFreeformTask()) {
        mTmpTransform=stackLayout.getStackTransformScreenCoordinates(task,stackScroller.getStackScroll(),mTmpTransform,null,windowOverrideRect);
        Bitmap thumbnail=drawThumbnailTransitionBitmap(task,mTmpTransform,mThumbTransitionBitmapCache);
        Rect toTaskRect=new Rect();
        mTmpTransform.rect.round(toTaskRect);
        specs.add(new AppTransitionAnimationSpec(task.key.id,thumbnail,toTaskRect));
      }
    }
    AppTransitionAnimationSpec[] specsArray=new AppTransitionAnimationSpec[specs.size()];
    specs.toArray(specsArray);
    return ActivityOptions.makeThumbnailAspectScaleDownAnimation(mDummyStackView,specsArray,mHandler,null,this);
  }
 else {
    Task toTask=new Task();
    TaskViewTransform toTransform=getThumbnailTransitionTransform(stackView,toTask,windowOverrideRect);
    Bitmap thumbnail=drawThumbnailTransitionBitmap(toTask,toTransform,mThumbTransitionBitmapCache);
    if (thumbnail != null) {
      RectF toTaskRect=toTransform.rect;
      return ActivityOptions.makeThumbnailAspectScaleDownAnimation(mDummyStackView,thumbnail,(int)toTaskRect.left,(int)toTaskRect.top,(int)toTaskRect.width(),(int)toTaskRect.height(),mHandler,null);
    }
    return getUnknownTransitionActivityOptions();
  }
}
