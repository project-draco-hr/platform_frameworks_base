{
  String packageName=pkgLite.packageName;
  int installLocation=pkgLite.installLocation;
  boolean onSd=(flags & PackageManager.INSTALL_EXTERNAL) != 0;
synchronized (mPackages) {
    PackageParser.Package pkg=mPackages.get(packageName);
    if (pkg != null) {
      if ((flags & PackageManager.INSTALL_REPLACE_EXISTING) != 0) {
        if ((flags & PackageManager.INSTALL_ALLOW_DOWNGRADE) == 0) {
          if (pkgLite.versionCode < pkg.mVersionCode) {
            Slog.w(TAG,"Can't install update of " + packageName + " update version "+ pkgLite.versionCode+ " is older than installed version "+ pkg.mVersionCode);
            return PackageHelper.RECOMMEND_FAILED_VERSION_DOWNGRADE;
          }
        }
        if ((pkg.applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) != 0) {
          if (onSd) {
            Slog.w(TAG,"Cannot install update to system app on sdcard");
            return PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION;
          }
          return PackageHelper.RECOMMEND_INSTALL_INTERNAL;
        }
 else {
          if (onSd) {
            return PackageHelper.RECOMMEND_INSTALL_EXTERNAL;
          }
          if (installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY) {
            return PackageHelper.RECOMMEND_INSTALL_INTERNAL;
          }
 else           if (installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL) {
          }
 else {
            if (isExternal(pkg)) {
              return PackageHelper.RECOMMEND_INSTALL_EXTERNAL;
            }
            return PackageHelper.RECOMMEND_INSTALL_INTERNAL;
          }
        }
      }
 else {
        return PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS;
      }
    }
  }
  if (onSd) {
    return PackageHelper.RECOMMEND_INSTALL_EXTERNAL;
  }
  return pkgLite.recommendedInstallLocation;
}
