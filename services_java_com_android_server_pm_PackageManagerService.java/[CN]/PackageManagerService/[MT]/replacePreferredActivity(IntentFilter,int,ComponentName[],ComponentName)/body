{
  if (filter.countActions() != 1) {
    throw new IllegalArgumentException("replacePreferredActivity expects filter to have only 1 action.");
  }
  if (filter.countDataAuthorities() != 0 || filter.countDataPaths() != 0 || filter.countDataSchemes() != 0 || filter.countDataTypes() != 0) {
    throw new IllegalArgumentException("replacePreferredActivity expects filter to have no data authorities, " + "paths, schemes or types.");
  }
synchronized (mPackages) {
    if (mContext.checkCallingOrSelfPermission(android.Manifest.permission.SET_PREFERRED_APPLICATIONS) != PackageManager.PERMISSION_GRANTED) {
      if (getUidTargetSdkVersionLockedLPr(Binder.getCallingUid()) < Build.VERSION_CODES.FROYO) {
        Slog.w(TAG,"Ignoring replacePreferredActivity() from uid " + Binder.getCallingUid());
        return;
      }
      mContext.enforceCallingOrSelfPermission(android.Manifest.permission.SET_PREFERRED_APPLICATIONS,null);
    }
    final int callingUserId=UserHandle.getCallingUserId();
    ArrayList<PreferredActivity> removed=null;
    PreferredIntentResolver pir=mSettings.mPreferredActivities.get(callingUserId);
    if (pir != null) {
      Iterator<PreferredActivity> it=pir.filterIterator();
      String action=filter.getAction(0);
      String category=filter.getCategory(0);
      while (it.hasNext()) {
        PreferredActivity pa=it.next();
        if ((pa.countActions() == 0) || (pa.countCategories() == 0) || (pa.getAction(0).equals(action) && pa.getCategory(0).equals(category))) {
          if (removed == null) {
            removed=new ArrayList<PreferredActivity>();
          }
          removed.add(pa);
          if (DEBUG_PREFERRED) {
            Slog.i(TAG,"Removing preferred activity " + pa.mPref.mComponent + ":");
            filter.dump(new LogPrinter(Log.INFO,TAG),"  ");
          }
        }
      }
      if (removed != null) {
        for (int i=0; i < removed.size(); i++) {
          PreferredActivity pa=removed.get(i);
          pir.removeFilter(pa);
        }
      }
    }
    addPreferredActivityInternal(filter,match,set,activity,true,callingUserId);
  }
}
