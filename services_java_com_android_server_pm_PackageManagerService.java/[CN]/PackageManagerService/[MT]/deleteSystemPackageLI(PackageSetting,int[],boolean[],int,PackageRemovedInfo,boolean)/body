{
  final boolean applyUserRestrictions=(allUserHandles != null) && (perUserInstalled != null);
  PackageSetting disabledPs=null;
synchronized (mPackages) {
    disabledPs=mSettings.getDisabledSystemPkgLPr(newPs.name);
  }
  if (DEBUG_REMOVE)   Slog.d(TAG,"deleteSystemPackageLI: newPs=" + newPs + " disabledPs="+ disabledPs);
  if (disabledPs == null) {
    Slog.w(TAG,"Attempt to delete unknown system package " + newPs.name);
    return false;
  }
 else   if (DEBUG_REMOVE) {
    Slog.d(TAG,"Deleting system pkg from data partition");
  }
  if (DEBUG_REMOVE) {
    if (applyUserRestrictions) {
      Slog.d(TAG,"Remembering install states:");
      for (int i=0; i < allUserHandles.length; i++) {
        Slog.d(TAG,"   u=" + allUserHandles[i] + " inst="+ perUserInstalled[i]);
      }
    }
  }
  outInfo.isRemovedPackageSystemUpdate=true;
  if (disabledPs.versionCode < newPs.versionCode) {
    flags&=~PackageManager.DELETE_KEEP_DATA;
  }
 else {
    flags|=PackageManager.DELETE_KEEP_DATA;
  }
  boolean ret=deleteInstalledPackageLI(newPs,true,flags,allUserHandles,perUserInstalled,outInfo,writeSettings);
  if (!ret) {
    return false;
  }
synchronized (mPackages) {
    mSettings.enableSystemPackageLPw(newPs.name);
    NativeLibraryHelper.removeNativeBinariesLI(newPs.nativeLibraryPathString);
  }
  if (DEBUG_REMOVE)   Slog.d(TAG,"Re-installing system package: " + disabledPs);
  int parseFlags=PackageParser.PARSE_MUST_BE_APK | PackageParser.PARSE_IS_SYSTEM;
  if (locationIsPrivileged(disabledPs.codePath)) {
    parseFlags|=PackageParser.PARSE_IS_PRIVILEGED;
  }
  PackageParser.Package newPkg=scanPackageLI(disabledPs.codePath,parseFlags,SCAN_MONITOR | SCAN_NO_PATHS,0,null);
  if (newPkg == null) {
    Slog.w(TAG,"Failed to restore system package:" + newPs.name + " with error:"+ mLastScanError);
    return false;
  }
synchronized (mPackages) {
    updatePermissionsLPw(newPkg.packageName,newPkg,UPDATE_PERMISSIONS_ALL | UPDATE_PERMISSIONS_REPLACE_PKG);
    if (applyUserRestrictions) {
      if (DEBUG_REMOVE) {
        Slog.d(TAG,"Propagating install state across reinstall");
      }
      PackageSetting ps=mSettings.mPackages.get(newPkg.packageName);
      for (int i=0; i < allUserHandles.length; i++) {
        if (DEBUG_REMOVE) {
          Slog.d(TAG,"    user " + allUserHandles[i] + " => "+ perUserInstalled[i]);
        }
        ps.setInstalled(perUserInstalled[i],allUserHandles[i]);
      }
      mSettings.writeAllUsersPackageRestrictionsLPr();
    }
    if (writeSettings) {
      mSettings.writeLPr();
    }
  }
  return true;
}
