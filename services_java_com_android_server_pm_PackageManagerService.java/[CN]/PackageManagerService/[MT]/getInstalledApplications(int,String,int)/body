{
  if (!sUserManager.exists(userId))   return null;
  final ParceledListSlice<ApplicationInfo> list=new ParceledListSlice<ApplicationInfo>();
  final boolean listUninstalled=(flags & PackageManager.GET_UNINSTALLED_PACKAGES) != 0;
  final String[] keys;
synchronized (mPackages) {
    if (listUninstalled) {
      keys=mSettings.mPackages.keySet().toArray(new String[mSettings.mPackages.size()]);
    }
 else {
      keys=mPackages.keySet().toArray(new String[mPackages.size()]);
    }
    Arrays.sort(keys);
    int i=getContinuationPoint(keys,lastRead);
    final int N=keys.length;
    while (i < N) {
      final String packageName=keys[i++];
      ApplicationInfo ai=null;
      final PackageSetting ps=mSettings.mPackages.get(packageName);
      if (listUninstalled) {
        if (ps != null) {
          ai=generateApplicationInfoFromSettingsLPw(ps.name,flags,userId);
        }
      }
 else {
        final PackageParser.Package p=mPackages.get(packageName);
        if (p != null && ps != null) {
          ai=PackageParser.generateApplicationInfo(p,flags,ps.readUserState(userId),userId);
        }
      }
      if (ai != null && list.append(ai)) {
        break;
      }
    }
    if (i == N) {
      list.setLastSlice(true);
    }
  }
  return list;
}
