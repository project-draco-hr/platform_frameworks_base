{
  final ArrayList<ApplicationInfo> finalList=new ArrayList<ApplicationInfo>();
synchronized (mPackages) {
    final Iterator<PackageParser.Package> i=mPackages.values().iterator();
    final int userId=UserId.getCallingUserId();
    while (i.hasNext()) {
      final PackageParser.Package p=i.next();
      if (p.applicationInfo != null && (p.applicationInfo.flags & ApplicationInfo.FLAG_PERSISTENT) != 0 && (!mSafeMode || isSystemApp(p))) {
        PackageSetting ps=mSettings.mPackages.get(p.packageName);
        finalList.add(PackageParser.generateApplicationInfo(p,flags,ps != null ? ps.getStopped(userId) : false,ps != null ? ps.getEnabled(userId) : COMPONENT_ENABLED_STATE_DEFAULT,userId));
      }
    }
  }
  return finalList;
}
