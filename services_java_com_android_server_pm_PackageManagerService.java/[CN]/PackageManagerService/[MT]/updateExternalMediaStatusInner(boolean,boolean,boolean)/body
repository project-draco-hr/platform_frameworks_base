{
  int uidArr[]=null;
  HashSet<String> removeCids=new HashSet<String>();
  HashMap<AsecInstallArgs,String> processCids=new HashMap<AsecInstallArgs,String>();
  final String list[]=PackageHelper.getSecureContainerList();
  if (list == null || list.length == 0) {
    Log.i(TAG,"No secure containers on sdcard");
  }
 else {
    int uidList[]=new int[list.length];
    int num=0;
synchronized (mPackages) {
      for (      String cid : list) {
        if (DEBUG_SD_INSTALL)         Log.i(TAG,"Processing container " + cid);
        String pkgName=getAsecPackageName(cid);
        if (pkgName == null) {
          if (DEBUG_SD_INSTALL)           Log.i(TAG,"Container : " + cid + " stale");
          removeCids.add(cid);
          continue;
        }
        if (DEBUG_SD_INSTALL)         Log.i(TAG,"Looking for pkg : " + pkgName);
        final PackageSetting ps=mSettings.mPackages.get(pkgName);
        if (ps == null) {
          Log.i(TAG,"Deleting container with no matching settings " + cid);
          removeCids.add(cid);
          continue;
        }
        if (externalStorage && !isMounted && !isExternal(ps)) {
          continue;
        }
        final AsecInstallArgs args=new AsecInstallArgs(cid,isForwardLocked(ps));
        if (ps.codePathString != null && ps.codePathString.equals(args.getCodePath())) {
          if (DEBUG_SD_INSTALL) {
            Log.i(TAG,"Container : " + cid + " corresponds to pkg : "+ pkgName+ " at code path: "+ ps.codePathString);
          }
          processCids.put(args,ps.codePathString);
          final int uid=ps.appId;
          if (uid != -1) {
            uidList[num++]=uid;
          }
        }
 else {
          Log.i(TAG,"Deleting stale container for " + cid);
          removeCids.add(cid);
        }
      }
    }
    if (num > 0) {
      Arrays.sort(uidList,0,num);
      uidArr=new int[num];
      uidArr[0]=uidList[0];
      int di=0;
      for (int i=1; i < num; i++) {
        if (uidList[i - 1] != uidList[i]) {
          uidArr[di++]=uidList[i];
        }
      }
    }
  }
  if (isMounted) {
    if (DEBUG_SD_INSTALL)     Log.i(TAG,"Loading packages");
    loadMediaPackages(processCids,uidArr,removeCids);
    startCleaningPackages();
  }
 else {
    if (DEBUG_SD_INSTALL)     Log.i(TAG,"Unloading packages");
    unloadMediaPackages(processCids,uidArr,reportStatus);
  }
}
