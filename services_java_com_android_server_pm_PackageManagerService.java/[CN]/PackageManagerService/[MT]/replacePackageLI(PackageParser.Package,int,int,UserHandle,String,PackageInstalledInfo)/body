{
  PackageParser.Package oldPackage;
  String pkgName=pkg.packageName;
  int[] allUsers;
  boolean[] perUserInstalled;
synchronized (mPackages) {
    oldPackage=mPackages.get(pkgName);
    if (DEBUG_INSTALL)     Slog.d(TAG,"replacePackageLI: new=" + pkg + ", old="+ oldPackage);
    if (compareSignatures(oldPackage.mSignatures,pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) {
      Slog.w(TAG,"New package has a different signature: " + pkgName);
      res.returnCode=PackageManager.INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES;
      return;
    }
    PackageSetting ps=mSettings.mPackages.get(pkgName);
    allUsers=sUserManager.getUserIds();
    perUserInstalled=new boolean[allUsers.length];
    for (int i=0; i < allUsers.length; i++) {
      perUserInstalled[i]=ps != null ? ps.getInstalled(allUsers[i]) : false;
    }
  }
  boolean sysPkg=(isSystemApp(oldPackage));
  if (sysPkg) {
    replaceSystemPackageLI(oldPackage,pkg,parseFlags,scanMode,user,allUsers,perUserInstalled,installerPackageName,res);
  }
 else {
    replaceNonSystemPackageLI(oldPackage,pkg,parseFlags,scanMode,user,allUsers,perUserInstalled,installerPackageName,res);
  }
}
