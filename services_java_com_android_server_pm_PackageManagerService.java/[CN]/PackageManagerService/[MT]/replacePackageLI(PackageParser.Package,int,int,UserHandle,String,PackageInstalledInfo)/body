{
  PackageParser.Package oldPackage;
  String pkgName=pkg.packageName;
synchronized (mPackages) {
    oldPackage=mPackages.get(pkgName);
    if (compareSignatures(oldPackage.mSignatures,pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) {
      Slog.w(TAG,"New package has a different signature: " + pkgName);
      res.returnCode=PackageManager.INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES;
      return;
    }
  }
  boolean sysPkg=(isSystemApp(oldPackage));
  if (sysPkg) {
    replaceSystemPackageLI(oldPackage,pkg,parseFlags,scanMode,user,installerPackageName,res);
  }
 else {
    replaceNonSystemPackageLI(oldPackage,pkg,parseFlags,scanMode,user,installerPackageName,res);
  }
}
