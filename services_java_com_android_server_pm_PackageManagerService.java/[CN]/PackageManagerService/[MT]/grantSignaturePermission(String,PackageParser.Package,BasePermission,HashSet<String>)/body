{
  boolean allowed;
  allowed=(compareSignatures(bp.packageSetting.signatures.mSignatures,pkg.mSignatures) == PackageManager.SIGNATURE_MATCH) || (compareSignatures(mPlatformPackage.mSignatures,pkg.mSignatures) == PackageManager.SIGNATURE_MATCH);
  if (!allowed && (bp.protectionLevel & PermissionInfo.PROTECTION_FLAG_SYSTEM) != 0) {
    if (isSystemApp(pkg)) {
      if (isUpdatedSystemApp(pkg)) {
        final PackageSetting sysPs=mSettings.getDisabledSystemPkgLPr(pkg.packageName);
        final GrantedPermissions origGp=sysPs.sharedUser != null ? sysPs.sharedUser : sysPs;
        if (origGp.grantedPermissions.contains(perm)) {
          allowed=true;
        }
 else {
          allowed=false;
          if (sysPs.pkg != null) {
            for (int j=0; j < sysPs.pkg.requestedPermissions.size(); j++) {
              if (perm.equals(sysPs.pkg.requestedPermissions.get(j))) {
                allowed=true;
                break;
              }
            }
          }
        }
      }
 else {
        allowed=isPrivilegedApp(pkg);
      }
    }
  }
  if (!allowed && (bp.protectionLevel & PermissionInfo.PROTECTION_FLAG_DEVELOPMENT) != 0) {
    allowed=origPermissions.contains(perm);
  }
  return allowed;
}
