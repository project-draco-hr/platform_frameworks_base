{
  ApplicationInfo applicationInfo=p.applicationInfo;
  if (applicationInfo == null) {
    Slog.w(TAG,"Package " + p.packageName + " has no applicationInfo.");
    return false;
  }
  PackageSetting ps=null;
synchronized (mPackages) {
    ps=mSettings.getDisabledSystemPkgLPr(p.packageName);
  }
  if (ps == null) {
    Slog.w(TAG,"Attempt to delete unknown system package " + p.packageName);
    return false;
  }
 else {
    Log.i(TAG,"Deleting system pkg from data partition");
  }
  outInfo.isRemovedPackageSystemUpdate=true;
  if (ps.versionCode < p.mVersionCode) {
    flags&=~PackageManager.DELETE_KEEP_DATA;
  }
 else {
    flags|=PackageManager.DELETE_KEEP_DATA;
  }
  boolean ret=deleteInstalledPackageLI(p,true,flags,outInfo,writeSettings);
  if (!ret) {
    return false;
  }
synchronized (mPackages) {
    mSettings.enableSystemPackageLPw(p.packageName);
    NativeLibraryHelper.removeNativeBinariesLI(p.applicationInfo.nativeLibraryDir);
  }
  PackageParser.Package newPkg=scanPackageLI(ps.codePath,PackageParser.PARSE_MUST_BE_APK | PackageParser.PARSE_IS_SYSTEM,SCAN_MONITOR | SCAN_NO_PATHS,0,null);
  if (newPkg == null) {
    Slog.w(TAG,"Failed to restore system package:" + p.packageName + " with error:"+ mLastScanError);
    return false;
  }
synchronized (mPackages) {
    updatePermissionsLPw(newPkg.packageName,newPkg,UPDATE_PERMISSIONS_ALL | UPDATE_PERMISSIONS_REPLACE_PKG);
    if (writeSettings) {
      mSettings.writeLPr();
    }
  }
  return true;
}
