{
  int callingUid=Binder.getCallingUid();
  enforceCrossUserPermission(callingUid,userId,true,"add preferred activity");
synchronized (mPackages) {
    if (mContext.checkCallingOrSelfPermission(android.Manifest.permission.SET_PREFERRED_APPLICATIONS) != PackageManager.PERMISSION_GRANTED) {
      if (getUidTargetSdkVersionLockedLPr(callingUid) < Build.VERSION_CODES.FROYO) {
        Slog.w(TAG,"Ignoring addPreferredActivity() from uid " + callingUid);
        return;
      }
      mContext.enforceCallingOrSelfPermission(android.Manifest.permission.SET_PREFERRED_APPLICATIONS,null);
    }
    Slog.i(TAG,"Adding preferred activity " + activity + " for user "+ userId+ " :");
    filter.dump(new LogPrinter(Log.INFO,TAG),"  ");
    mSettings.mPreferredActivities.addFilter(new PreferredActivity(filter,match,set,activity,userId));
    scheduleWriteSettingsLocked();
  }
}
