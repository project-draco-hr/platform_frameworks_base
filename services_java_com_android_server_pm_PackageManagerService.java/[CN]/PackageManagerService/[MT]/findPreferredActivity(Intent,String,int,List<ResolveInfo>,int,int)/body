{
  if (!sUserManager.exists(userId))   return null;
synchronized (mPackages) {
    if (intent.getSelector() != null) {
      intent=intent.getSelector();
    }
    if (DEBUG_PREFERRED)     intent.addFlags(Intent.FLAG_DEBUG_LOG_RESOLUTION);
    List<PreferredActivity> prefs=mSettings.mPreferredActivities.queryIntent(intent,resolvedType,(flags & PackageManager.MATCH_DEFAULT_ONLY) != 0,userId);
    if (prefs != null && prefs.size() > 0) {
      int match=0;
      if (DEBUG_PREFERRED) {
        Log.v(TAG,"Figuring out best match...");
      }
      final int N=query.size();
      for (int j=0; j < N; j++) {
        final ResolveInfo ri=query.get(j);
        if (DEBUG_PREFERRED) {
          Log.v(TAG,"Match for " + ri.activityInfo + ": 0x"+ Integer.toHexString(match));
        }
        if (ri.match > match) {
          match=ri.match;
        }
      }
      if (DEBUG_PREFERRED) {
        Log.v(TAG,"Best match: 0x" + Integer.toHexString(match));
      }
      match&=IntentFilter.MATCH_CATEGORY_MASK;
      final int M=prefs.size();
      for (int i=0; i < M; i++) {
        final PreferredActivity pa=prefs.get(i);
        if (pa.mUserId != userId) {
          continue;
        }
        if (pa.mPref.mMatch != match) {
          continue;
        }
        final ActivityInfo ai=getActivityInfo(pa.mPref.mComponent,flags,userId);
        if (DEBUG_PREFERRED) {
          Log.v(TAG,"Got preferred activity:");
          if (ai != null) {
            ai.dump(new LogPrinter(Log.VERBOSE,TAG),"  ");
          }
 else {
            Log.v(TAG,"  null");
          }
        }
        if (ai == null) {
          Slog.w(TAG,"Removing dangling preferred activity: " + pa.mPref.mComponent);
          mSettings.mPreferredActivities.removeFilter(pa);
          continue;
        }
        for (int j=0; j < N; j++) {
          final ResolveInfo ri=query.get(j);
          if (!ri.activityInfo.applicationInfo.packageName.equals(ai.applicationInfo.packageName)) {
            continue;
          }
          if (!ri.activityInfo.name.equals(ai.name)) {
            continue;
          }
          if (!pa.mPref.sameSet(query,priority)) {
            Slog.i(TAG,"Result set changed, dropping preferred activity for " + intent + " type "+ resolvedType);
            mSettings.mPreferredActivities.removeFilter(pa);
            return null;
          }
          return ri;
        }
      }
    }
  }
  return null;
}
