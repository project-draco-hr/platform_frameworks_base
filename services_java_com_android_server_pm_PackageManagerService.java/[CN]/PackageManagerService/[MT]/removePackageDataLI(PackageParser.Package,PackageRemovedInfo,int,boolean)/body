{
  String packageName=p.packageName;
  if (outInfo != null) {
    outInfo.removedPackage=packageName;
  }
  removePackageLI(p,(flags & REMOVE_CHATTY) != 0);
  final PackageSetting deletedPs;
synchronized (mPackages) {
    deletedPs=mSettings.mPackages.get(packageName);
  }
  if ((flags & PackageManager.DONT_DELETE_DATA) == 0) {
    int retCode=mInstaller.remove(packageName,0);
    if (retCode < 0) {
      Slog.w(TAG,"Couldn't remove app data or cache directory for package: " + packageName + ", retcode="+ retCode);
    }
 else {
      mUserManager.removePackageForAllUsers(packageName);
    }
    schedulePackageCleaning(packageName);
  }
synchronized (mPackages) {
    if (deletedPs != null) {
      if ((flags & PackageManager.DONT_DELETE_DATA) == 0) {
        if (outInfo != null) {
          outInfo.removedUid=mSettings.removePackageLPw(packageName);
        }
        if (deletedPs != null) {
          updatePermissionsLPw(deletedPs.name,null,false,false,false);
          if (deletedPs.sharedUser != null) {
            mSettings.updateSharedUserPermsLPw(deletedPs,mGlobalGids);
          }
        }
      }
      ArrayList<PreferredActivity> removed=new ArrayList<PreferredActivity>();
      for (      PreferredActivity pa : mSettings.mPreferredActivities.filterSet()) {
        if (pa.mPref.mComponent.getPackageName().equals(deletedPs.name)) {
          removed.add(pa);
        }
      }
      for (      PreferredActivity pa : removed) {
        mSettings.mPreferredActivities.removeFilter(pa);
      }
    }
    if (writeSettings) {
      mSettings.writeLPr();
    }
  }
}
