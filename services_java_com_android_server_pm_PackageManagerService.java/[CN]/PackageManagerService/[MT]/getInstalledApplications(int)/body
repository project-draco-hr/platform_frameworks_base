{
  final ArrayList<ApplicationInfo> finalList=new ArrayList<ApplicationInfo>();
synchronized (mPackages) {
    if ((flags & PackageManager.GET_UNINSTALLED_PACKAGES) != 0) {
      final Iterator<PackageSetting> i=mSettings.mPackages.values().iterator();
      while (i.hasNext()) {
        final PackageSetting ps=i.next();
        ApplicationInfo ai=generateApplicationInfoFromSettingsLPw(ps.name,flags);
        if (ai != null) {
          finalList.add(ai);
        }
      }
    }
 else {
      final Iterator<PackageParser.Package> i=mPackages.values().iterator();
      while (i.hasNext()) {
        final PackageParser.Package p=i.next();
        if (p.applicationInfo != null) {
          ApplicationInfo ai=PackageParser.generateApplicationInfo(p,flags);
          if (ai != null) {
            finalList.add(ai);
          }
        }
      }
    }
  }
  return finalList;
}
