{
  final NetworkRequestType type=(networkCapabilities == null) ? NetworkRequestType.TRACK_DEFAULT : NetworkRequestType.REQUEST;
  if (type == NetworkRequestType.TRACK_DEFAULT) {
    networkCapabilities=new NetworkCapabilities(mDefaultRequest.networkCapabilities);
    enforceAccessPermission();
  }
 else {
    networkCapabilities=new NetworkCapabilities(networkCapabilities);
    enforceNetworkRequestPermissions(networkCapabilities);
  }
  enforceMeteredApnPolicy(networkCapabilities);
  ensureRequestableCapabilities(networkCapabilities);
  if (timeoutMs < 0 || timeoutMs > ConnectivityManager.MAX_NETWORK_REQUEST_TIMEOUT_MS) {
    throw new IllegalArgumentException("Bad timeout specified");
  }
  if (NetworkCapabilities.MATCH_ALL_REQUESTS_NETWORK_SPECIFIER.equals(networkCapabilities.getNetworkSpecifier())) {
    throw new IllegalArgumentException("Invalid network specifier - must not be '" + NetworkCapabilities.MATCH_ALL_REQUESTS_NETWORK_SPECIFIER + "'");
  }
  NetworkRequest networkRequest=new NetworkRequest(networkCapabilities,legacyType,nextNetworkRequestId());
  NetworkRequestInfo nri=new NetworkRequestInfo(messenger,networkRequest,binder,type);
  if (DBG)   log("requestNetwork for " + nri);
  mHandler.sendMessage(mHandler.obtainMessage(EVENT_REGISTER_NETWORK_REQUEST,nri));
  if (timeoutMs > 0) {
    mHandler.sendMessageDelayed(mHandler.obtainMessage(EVENT_TIMEOUT_NETWORK_REQUEST,nri),timeoutMs);
  }
  return networkRequest;
}
