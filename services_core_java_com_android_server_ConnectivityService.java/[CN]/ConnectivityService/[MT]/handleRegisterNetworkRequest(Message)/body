{
  final NetworkRequestInfo nri=(NetworkRequestInfo)(msg.obj);
  final NetworkCapabilities newCap=nri.request.networkCapabilities;
  int score=0;
  NetworkAgentInfo bestNetwork=null;
  for (  NetworkAgentInfo network : mNetworkAgentInfos.values()) {
    if (VDBG)     log("handleRegisterNetworkRequest checking " + network.name());
    if (newCap.satisfiedByNetworkCapabilities(network.networkCapabilities)) {
      if (VDBG)       log("apparently satisfied.  currentScore=" + network.currentScore);
      if ((bestNetwork == null) || bestNetwork.currentScore < network.currentScore) {
        bestNetwork=network;
      }
    }
  }
  if (bestNetwork != null) {
    if (VDBG)     log("using " + bestNetwork.name());
    if (nri.isRequest && bestNetwork.networkInfo.isConnected()) {
      bestNetwork.networkLingered.clear();
      bestNetwork.networkMonitor.sendMessage(NetworkMonitor.CMD_NETWORK_CONNECTED);
    }
    bestNetwork.addRequest(nri.request);
    mNetworkForRequestId.put(nri.request.requestId,bestNetwork);
    int legacyType=nri.request.legacyType;
    if (legacyType != TYPE_NONE) {
      mLegacyTypeTracker.add(legacyType,bestNetwork);
    }
    notifyNetworkCallback(bestNetwork,nri);
    score=bestNetwork.currentScore;
  }
  mNetworkRequests.put(nri.request,nri);
  if (msg.what == EVENT_REGISTER_NETWORK_REQUEST) {
    if (DBG)     log("sending new NetworkRequest to factories");
    for (    NetworkFactoryInfo nfi : mNetworkFactoryInfos.values()) {
      nfi.asyncChannel.sendMessage(android.net.NetworkFactory.CMD_REQUEST_NETWORK,score,0,nri.request);
    }
  }
}
