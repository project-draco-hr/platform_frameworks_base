{
  if (DBG)   log("releasing NetworkRequest " + request);
  NetworkRequestInfo nri=mNetworkRequests.remove(request);
  if (nri != null) {
    NetworkAgentInfo affectedNetwork=mNetworkForRequestId.get(nri.request.requestId);
    if (affectedNetwork != null) {
      mNetworkForRequestId.remove(nri.request.requestId);
      affectedNetwork.networkRequests.remove(nri.request.requestId);
      if (VDBG) {
        log(" Removing from current network " + affectedNetwork.name() + ", leaving "+ affectedNetwork.networkRequests.size()+ " requests.");
      }
    }
    if (nri.isRequest) {
      for (      AsyncChannel factory : mNetworkFactories) {
        factory.sendMessage(NetworkFactoryProtocol.CMD_CANCEL_REQUEST,nri.request);
      }
      if (affectedNetwork != null) {
        boolean keep=false;
        for (int i=0; i < affectedNetwork.networkRequests.size(); i++) {
          NetworkRequest r=affectedNetwork.networkRequests.valueAt(i);
          if (mNetworkRequests.get(r).isRequest) {
            keep=true;
            break;
          }
        }
        if (keep == false) {
          if (DBG)           log("no live requests for " + affectedNetwork.name() + "; disconnecting");
          affectedNetwork.asyncChannel.disconnect();
        }
      }
    }
    callCallbackForRequest(nri,null,ConnectivityManager.CALLBACK_RELEASED);
  }
}
