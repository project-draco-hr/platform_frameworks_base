{
  NetworkInfo info;
switch (msg.what) {
case AsyncChannel.CMD_CHANNEL_HALF_CONNECTED:
{
      handleAsyncChannelHalfConnect(msg);
      break;
    }
case AsyncChannel.CMD_CHANNEL_DISCONNECT:
{
    NetworkAgentInfo nai=mNetworkAgentInfos.get(msg.replyTo);
    if (nai != null)     nai.asyncChannel.disconnect();
    break;
  }
case AsyncChannel.CMD_CHANNEL_DISCONNECTED:
{
  handleAsyncChannelDisconnected(msg);
  break;
}
case NetworkAgent.EVENT_NETWORK_CAPABILITIES_CHANGED:
{
NetworkAgentInfo nai=mNetworkAgentInfos.get(msg.replyTo);
if (nai == null) {
  loge("EVENT_NETWORK_CAPABILITIES_CHANGED from unknown NetworkAgent");
}
 else {
  updateCapabilities(nai,(NetworkCapabilities)msg.obj);
}
break;
}
case NetworkAgent.EVENT_NETWORK_PROPERTIES_CHANGED:
{
NetworkAgentInfo nai=mNetworkAgentInfos.get(msg.replyTo);
if (nai == null) {
loge("NetworkAgent not found for EVENT_NETWORK_PROPERTIES_CHANGED");
}
 else {
if (VDBG) log("Update of Linkproperties for " + nai.name());
LinkProperties oldLp=nai.linkProperties;
synchronized (nai) {
  nai.linkProperties=(LinkProperties)msg.obj;
}
updateLinkProperties(nai,oldLp);
}
break;
}
case NetworkAgent.EVENT_NETWORK_INFO_CHANGED:
{
NetworkAgentInfo nai=mNetworkAgentInfos.get(msg.replyTo);
if (nai == null) {
loge("EVENT_NETWORK_INFO_CHANGED from unknown NetworkAgent");
break;
}
info=(NetworkInfo)msg.obj;
updateNetworkInfo(nai,info);
break;
}
case NetworkAgent.EVENT_NETWORK_SCORE_CHANGED:
{
NetworkAgentInfo nai=mNetworkAgentInfos.get(msg.replyTo);
if (nai == null) {
loge("EVENT_NETWORK_SCORE_CHANGED from unknown NetworkAgent");
break;
}
Integer score=(Integer)msg.obj;
if (score != null) updateNetworkScore(nai,score.intValue());
break;
}
case NetworkAgent.EVENT_UID_RANGES_ADDED:
{
NetworkAgentInfo nai=mNetworkAgentInfos.get(msg.replyTo);
if (nai == null) {
loge("EVENT_UID_RANGES_ADDED from unknown NetworkAgent");
break;
}
try {
mNetd.addVpnUidRanges(nai.network.netId,(UidRange[])msg.obj);
}
 catch (RemoteException e) {
}
break;
}
case NetworkAgent.EVENT_UID_RANGES_REMOVED:
{
NetworkAgentInfo nai=mNetworkAgentInfos.get(msg.replyTo);
if (nai == null) {
loge("EVENT_UID_RANGES_REMOVED from unknown NetworkAgent");
break;
}
try {
mNetd.removeVpnUidRanges(nai.network.netId,(UidRange[])msg.obj);
}
 catch (RemoteException e) {
}
break;
}
case NetworkMonitor.EVENT_NETWORK_VALIDATED:
{
NetworkAgentInfo nai=(NetworkAgentInfo)msg.obj;
handleConnectionValidated(nai);
break;
}
case NetworkMonitor.EVENT_NETWORK_LINGER_COMPLETE:
{
NetworkAgentInfo nai=(NetworkAgentInfo)msg.obj;
handleLingerComplete(nai);
break;
}
case NetworkMonitor.EVENT_PROVISIONING_NOTIFICATION:
{
if (msg.arg1 == 0) {
setProvNotificationVisibleIntent(false,msg.arg2,0,null,null);
}
 else {
NetworkAgentInfo nai=mNetworkForNetId.get(msg.arg2);
if (nai == null) {
loge("EVENT_PROVISIONING_NOTIFICATION from unknown NetworkMonitor");
break;
}
setProvNotificationVisibleIntent(true,msg.arg2,nai.networkInfo.getType(),nai.networkInfo.getExtraInfo(),(PendingIntent)msg.obj);
}
break;
}
case NetworkStateTracker.EVENT_STATE_CHANGED:
{
info=(NetworkInfo)msg.obj;
NetworkInfo.State state=info.getState();
if (VDBG || (state == NetworkInfo.State.CONNECTED) || (state == NetworkInfo.State.DISCONNECTED)|| (state == NetworkInfo.State.SUSPENDED)) {
log("ConnectivityChange for " + info.getTypeName() + ": "+ state+ "/"+ info.getDetailedState());
}
if (ConnectivityManager.isNetworkTypeMobile(info.getType()) && (0 != Settings.Global.getInt(mContext.getContentResolver(),Settings.Global.DEVICE_PROVISIONED,0)) && (((state == NetworkInfo.State.CONNECTED) && (info.getType() == ConnectivityManager.TYPE_MOBILE)) || info.isConnectedToProvisioningNetwork())) {
log("ConnectivityChange checkMobileProvisioning for" + " TYPE_MOBILE or ProvisioningNetwork");
checkMobileProvisioning(CheckMp.MAX_TIMEOUT_MS);
}
EventLogTags.writeConnectivityStateChanged(info.getType(),info.getSubtype(),info.getDetailedState().ordinal());
if (info.isConnectedToProvisioningNetwork()) {
LinkProperties lp=getLinkPropertiesForTypeInternal(info.getType());
if (DBG) {
log("EVENT_STATE_CHANGED: connected to provisioning network, lp=" + lp);
}
for (RouteInfo r : lp.getRoutes()) {
removeRoute(lp,r,TO_DEFAULT_TABLE,mNetTrackers[info.getType()].getNetwork().netId);
}
}
 else if (state == NetworkInfo.State.DISCONNECTED) {
}
 else if (state == NetworkInfo.State.SUSPENDED) {
}
 else if (state == NetworkInfo.State.CONNECTED) {
}
if (mLockdownTracker != null) {
mLockdownTracker.onNetworkInfoChanged(info);
}
break;
}
case NetworkStateTracker.EVENT_CONFIGURATION_CHANGED:
{
info=(NetworkInfo)msg.obj;
handleConnectivityChange(info.getType(),mCurrentLinkProperties[info.getType()],false);
break;
}
case NetworkStateTracker.EVENT_NETWORK_SUBTYPE_CHANGED:
{
info=(NetworkInfo)msg.obj;
int type=info.getType();
if (mNetConfigs[type].isDefault()) updateNetworkSettings(mNetTrackers[type]);
break;
}
}
}
