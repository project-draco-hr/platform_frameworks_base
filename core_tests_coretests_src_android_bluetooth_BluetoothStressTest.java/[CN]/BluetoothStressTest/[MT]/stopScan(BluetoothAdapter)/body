{
  int mask=DISCOVERY_FINISHED_FLAG;
  mReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("stopScan(): bluetooth not enabled");
  }
  if (!adapter.isDiscovering()) {
    return;
  }
  adapter.cancelDiscovery();
  long s=System.currentTimeMillis();
  while (System.currentTimeMillis() - s < CANCEL_DISCOVERY_TIMEOUT) {
    if (!adapter.isDiscovering() && ((mReceiver.getFiredFlags() & mask) == mask)) {
      mReceiver.resetFiredFlags();
      return;
    }
    sleep(POLL_TIME);
  }
  int firedFlags=mReceiver.getFiredFlags();
  mReceiver.resetFiredFlags();
  fail("stopScan() timeout: " + "isDiscovering=" + adapter.isDiscovering() + " "+ "flags="+ firedFlags+ " (expected "+ mask+ ")");
}
