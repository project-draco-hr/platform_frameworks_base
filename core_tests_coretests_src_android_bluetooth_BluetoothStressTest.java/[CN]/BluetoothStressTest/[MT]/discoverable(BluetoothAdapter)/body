{
  int mask=SCAN_MODE_CONNECTABLE_DISCOVERABLE_FLAG;
  mReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("discoverable() bluetooth not enabled");
  }
  int scanMode=adapter.getScanMode();
  if (scanMode == BluetoothAdapter.SCAN_MODE_CONNECTABLE_DISCOVERABLE) {
    return;
  }
  assertEquals(scanMode,BluetoothAdapter.SCAN_MODE_CONNECTABLE);
  assertTrue(adapter.setScanMode(BluetoothAdapter.SCAN_MODE_CONNECTABLE_DISCOVERABLE));
  long s=System.currentTimeMillis();
  while (System.currentTimeMillis() - s < SET_SCAN_MODE_TIMEOUT) {
    scanMode=adapter.getScanMode();
    if (scanMode == BluetoothAdapter.SCAN_MODE_CONNECTABLE_DISCOVERABLE) {
      if ((mReceiver.getFiredFlags() & mask) == mask) {
        mReceiver.resetFiredFlags();
        return;
      }
    }
 else {
      assertEquals(scanMode,BluetoothAdapter.SCAN_MODE_CONNECTABLE);
    }
    sleep(POLL_TIME);
  }
  int firedFlags=mReceiver.getFiredFlags();
  mReceiver.resetFiredFlags();
  fail("discoverable() timeout: " + "scanMode=" + scanMode + " (expected "+ BluetoothAdapter.SCAN_MODE_CONNECTABLE_DISCOVERABLE+ ") "+ "flags="+ firedFlags+ " (expected "+ mask+ ")");
}
