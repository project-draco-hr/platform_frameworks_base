{
  int mask=PROFILE_HEADSET_FLAG;
  int headsetMask=HEADSET_STATE_DISCONNECTED;
  mReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("disconnectHeadset() bluetooth not enabled");
  }
  if (!adapter.getBondedDevices().contains(device)) {
    fail("disconnectHeadset() device not paired: device=" + device);
  }
  while (!mHeadsetServiceListener.isConnected()) {
    sleep(POLL_TIME);
  }
  int state=mHeadset.getState(device);
switch (state) {
case BluetoothHeadset.STATE_CONNECTED:
    mHeadset.disconnectHeadset(device);
  break;
case BluetoothHeadset.STATE_CONNECTING:
mHeadset.disconnectHeadset(device);
break;
case BluetoothHeadset.STATE_DISCONNECTED:
return;
case BluetoothHeadset.STATE_ERROR:
fail("disconnectHeadset() error state");
break;
default :
fail("disconnectHeadset() invalid state: state=" + state);
}
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < DISCONNECT_HEADSET_TIMEOUT) {
state=mHeadset.getState(device);
if (state == BluetoothHeadset.STATE_DISCONNECTED) {
assertFalse(mHeadset.isConnected(device));
if ((mReceiver.getFiredFlags() & mask) == mask && (mReceiver.getHeadsetFiredFlags() & headsetMask) == headsetMask) {
mReceiver.resetFiredFlags();
writeOutput(String.format("disconnectHeadset() completed in %d ms: device=%s",(System.currentTimeMillis() - s),device));
return;
}
}
sleep(POLL_TIME);
}
int firedFlags=mReceiver.getFiredFlags();
int headsetFiredFlags=mReceiver.getHeadsetFiredFlags();
mReceiver.resetFiredFlags();
fail(String.format("disconnectHeadset() timeout: state=%d (expected %d), " + "flags=0x%x (expected 0x%x), headsetFlags=0x%s (expected 0x%x)",state,BluetoothHeadset.STATE_DISCONNECTED,firedFlags,mask,headsetFiredFlags,headsetMask));
}
