{
  int mask=PAIR_STATE_FLAG;
  int pairMask=PAIR_STATE_BONDING | PAIR_STATE_BONDED;
  mReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("pair() bluetooth not enabled");
  }
  int state=device.getBondState();
switch (state) {
case BluetoothDevice.BOND_BONDED:
    assertTrue(adapter.getBondedDevices().contains(device));
  return;
case BluetoothDevice.BOND_BONDING:
mask=pairMask=0;
break;
case BluetoothDevice.BOND_NONE:
assertFalse(adapter.getBondedDevices().contains(device));
assertTrue(device.createBond());
break;
default :
fail("pair() invalide state: state=" + state);
}
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < PAIR_TIMEOUT) {
state=device.getBondState();
if (state == BluetoothDevice.BOND_BONDED) {
assertTrue(adapter.getBondedDevices().contains(device));
if ((mReceiver.getFiredFlags() & mask) == mask && (mReceiver.getPairFiredFlags() & pairMask) == pairMask) {
writeOutput(String.format("pair() completed in %d ms: device=%s",(System.currentTimeMillis() - s),device));
return;
}
}
sleep(POLL_TIME);
}
int firedFlags=mReceiver.getFiredFlags();
int pairFiredFlags=mReceiver.getPairFiredFlags();
mReceiver.resetFiredFlags();
fail(String.format("pair() timeout: state=%d (expected %d), flags=0x%x (expected 0x%x), " + "pairFlags=0x%x (expected 0x%x)",state,BluetoothDevice.BOND_BONDED,firedFlags,mask,pairFiredFlags,pairMask));
}
