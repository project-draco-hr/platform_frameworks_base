{
  int mask=STATE_TURNING_ON_FLAG | STATE_ON_FLAG | SCAN_MODE_CONNECTABLE_FLAG;
  mReceiver.resetFiredFlags();
  int state=adapter.getState();
switch (state) {
case BluetoothAdapter.STATE_ON:
    assertTrue(adapter.isEnabled());
  return;
case BluetoothAdapter.STATE_OFF:
case BluetoothAdapter.STATE_TURNING_OFF:
assertFalse(adapter.isEnabled());
assertTrue(adapter.enable());
break;
case BluetoothAdapter.STATE_TURNING_ON:
assertFalse(adapter.isEnabled());
mask=0;
break;
default :
fail("enable() invalid state: state=" + state);
}
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < ENABLE_TIMEOUT) {
state=adapter.getState();
if (state == BluetoothAdapter.STATE_ON) {
assertTrue(adapter.isEnabled());
if ((mReceiver.getFiredFlags() & mask) == mask) {
mReceiver.resetFiredFlags();
return;
}
}
 else {
assertFalse(adapter.isEnabled());
assertEquals(BluetoothAdapter.STATE_TURNING_ON,state);
}
sleep(POLL_TIME);
}
int firedFlags=mReceiver.getFiredFlags();
mReceiver.resetFiredFlags();
fail("enable() timeout: " + "state=" + state + " (expected "+ BluetoothAdapter.STATE_OFF+ ") "+ "flags="+ firedFlags+ " (expected "+ mask+ ")");
}
