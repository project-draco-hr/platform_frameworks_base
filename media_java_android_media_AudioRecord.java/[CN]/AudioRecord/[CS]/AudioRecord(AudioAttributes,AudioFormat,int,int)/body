{
  mRecordingState=RECORDSTATE_STOPPED;
  if (attributes == null) {
    throw new IllegalArgumentException("Illegal null AudioAttributes");
  }
  if (format == null) {
    throw new IllegalArgumentException("Illegal null AudioFormat");
  }
  if ((mInitializationLooper=Looper.myLooper()) == null) {
    mInitializationLooper=Looper.getMainLooper();
  }
  if (attributes.getCapturePreset() == MediaRecorder.AudioSource.REMOTE_SUBMIX) {
    final AudioAttributes.Builder filteredAttr=new AudioAttributes.Builder();
    final Iterator<String> tagsIter=attributes.getTags().iterator();
    while (tagsIter.hasNext()) {
      final String tag=tagsIter.next();
      if (tag.equalsIgnoreCase(SUBMIX_FIXED_VOLUME)) {
        mIsSubmixFullVolume=true;
        Log.v(TAG,"Will record from REMOTE_SUBMIX at full fixed volume");
      }
 else {
        filteredAttr.addTag(tag);
      }
    }
    filteredAttr.setInternalCapturePreset(attributes.getCapturePreset());
    mAudioAttributes=filteredAttr.build();
  }
 else {
    mAudioAttributes=attributes;
  }
  int rate=format.getSampleRate();
  if (rate == AudioFormat.SAMPLE_RATE_UNSPECIFIED) {
    rate=0;
  }
  int encoding=AudioFormat.ENCODING_DEFAULT;
  if ((format.getPropertySetMask() & AudioFormat.AUDIO_FORMAT_HAS_PROPERTY_ENCODING) != 0) {
    encoding=format.getEncoding();
  }
  audioParamCheck(attributes.getCapturePreset(),rate,encoding);
  if ((format.getPropertySetMask() & AudioFormat.AUDIO_FORMAT_HAS_PROPERTY_CHANNEL_INDEX_MASK) != 0) {
    mChannelIndexMask=format.getChannelIndexMask();
    mChannelCount=format.getChannelCount();
  }
  if ((format.getPropertySetMask() & AudioFormat.AUDIO_FORMAT_HAS_PROPERTY_CHANNEL_MASK) != 0) {
    mChannelMask=getChannelMaskFromLegacyConfig(format.getChannelMask(),false);
    mChannelCount=format.getChannelCount();
  }
 else   if (mChannelIndexMask == 0) {
    mChannelMask=getChannelMaskFromLegacyConfig(AudioFormat.CHANNEL_IN_DEFAULT,false);
    mChannelCount=AudioFormat.channelCountFromInChannelMask(mChannelMask);
  }
  audioBuffSizeCheck(bufferSizeInBytes);
  int[] sampleRate=new int[]{mSampleRate};
  int[] session=new int[1];
  session[0]=sessionId;
  int initResult=native_setup(new WeakReference<AudioRecord>(this),mAudioAttributes,sampleRate,mChannelMask,mChannelIndexMask,mAudioFormat,mNativeBufferSizeInBytes,session,ActivityThread.currentOpPackageName(),0);
  if (initResult != SUCCESS) {
    loge("Error code " + initResult + " when initializing native AudioRecord object.");
    return;
  }
  mSampleRate=sampleRate[0];
  mSessionId=session[0];
  mState=STATE_INITIALIZED;
}
