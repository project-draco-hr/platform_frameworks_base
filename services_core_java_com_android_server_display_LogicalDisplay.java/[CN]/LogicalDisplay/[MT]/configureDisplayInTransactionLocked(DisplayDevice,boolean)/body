{
  device.setLayerStackInTransactionLocked(isBlanked ? BLANK_LAYER_STACK : mLayerStack);
  if (device == mPrimaryDisplayDevice) {
    device.requestColorTransformAndModeInTransactionLocked(mRequestedColorTransformId,mRequestedModeId);
  }
 else {
    device.requestColorTransformAndModeInTransactionLocked(0,0);
  }
  final DisplayInfo displayInfo=getDisplayInfoLocked();
  final DisplayDeviceInfo displayDeviceInfo=device.getDisplayDeviceInfoLocked();
  mTempLayerStackRect.set(0,0,displayInfo.logicalWidth,displayInfo.logicalHeight);
  int orientation=Surface.ROTATION_0;
  if ((displayDeviceInfo.flags & DisplayDeviceInfo.FLAG_ROTATES_WITH_CONTENT) != 0) {
    orientation=displayInfo.rotation;
  }
  orientation=(orientation + displayDeviceInfo.rotation) % 4;
  boolean rotated=(orientation == Surface.ROTATION_90 || orientation == Surface.ROTATION_270);
  int physWidth=rotated ? displayDeviceInfo.height : displayDeviceInfo.width;
  int physHeight=rotated ? displayDeviceInfo.width : displayDeviceInfo.height;
  int displayRectWidth, displayRectHeight;
  if ((displayInfo.flags & Display.FLAG_SCALING_DISABLED) != 0) {
    displayRectWidth=displayInfo.logicalWidth;
    displayRectHeight=displayInfo.logicalHeight;
  }
 else   if (physWidth * displayInfo.logicalHeight < physHeight * displayInfo.logicalWidth) {
    displayRectWidth=physWidth;
    displayRectHeight=displayInfo.logicalHeight * physWidth / displayInfo.logicalWidth;
  }
 else {
    displayRectWidth=displayInfo.logicalWidth * physHeight / displayInfo.logicalHeight;
    displayRectHeight=physHeight;
  }
  int displayRectTop=(physHeight - displayRectHeight) / 2;
  int displayRectLeft=(physWidth - displayRectWidth) / 2;
  mTempDisplayRect.set(displayRectLeft,displayRectTop,displayRectLeft + displayRectWidth,displayRectTop + displayRectHeight);
  mTempDisplayRect.left+=mDisplayOffsetX;
  mTempDisplayRect.right+=mDisplayOffsetX;
  mTempDisplayRect.top+=mDisplayOffsetY;
  mTempDisplayRect.bottom+=mDisplayOffsetY;
  device.setProjectionInTransactionLocked(orientation,mTempLayerStackRect,mTempDisplayRect);
}
