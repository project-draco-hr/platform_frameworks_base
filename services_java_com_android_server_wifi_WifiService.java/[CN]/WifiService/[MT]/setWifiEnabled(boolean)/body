{
  enforceChangePermission();
  Slog.d(TAG,"setWifiEnabled: " + enable + " pid="+ Binder.getCallingPid()+ ", uid="+ Binder.getCallingUid());
  if (DBG) {
    Slog.e(TAG,"Invoking mWifiStateMachine.setWifiEnabled\n");
  }
  long ident=Binder.clearCallingIdentity();
  try {
    if (!enable && isScanningAlwaysAvailable()) {
      boolean notifyUser=(Settings.Global.getInt(mContext.getContentResolver(),Settings.Global.WIFI_NOTIFY_SCAN_ALWAYS_AVAILABLE,1) == 1);
      if (notifyUser) {
        Intent intent=new Intent(WifiManager.ACTION_NOTIFY_SCAN_ALWAYS_AVAILABLE);
        mContext.startActivityAsUser(intent,null,UserHandle.CURRENT);
      }
    }
    if (!mSettingsStore.handleWifiToggled(enable)) {
      return true;
    }
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
  mWifiController.sendMessage(CMD_WIFI_TOGGLED);
  if (enable) {
    if (!mIsReceiverRegistered) {
      registerForBroadcasts();
      mIsReceiverRegistered=true;
    }
  }
 else   if (mIsReceiverRegistered) {
    mContext.unregisterReceiver(mReceiver);
    mIsReceiverRegistered=false;
  }
  return true;
}
