{
  mContext=context;
  mInterfaceName=SystemProperties.get("wifi.interface","wlan0");
  mWifiStateMachine=new WifiStateMachine(mContext,mInterfaceName);
  mWifiStateMachine.enableRssiPolling(true);
  mBatteryStats=BatteryStatsService.getService();
  mAppOps=(AppOpsManager)context.getSystemService(Context.APP_OPS_SERVICE);
  mNotificationController=new WifiNotificationController(mContext,mWifiStateMachine);
  mTrafficPoller=new WifiTrafficPoller(mContext,mInterfaceName);
  mSettingsStore=new WifiSettingsStore(mContext);
  HandlerThread wifiThread=new HandlerThread("WifiService");
  wifiThread.start();
  mClientHandler=new ClientHandler(wifiThread.getLooper());
  mWifiStateMachineHandler=new WifiStateMachineHandler(wifiThread.getLooper());
  mWifiController=new WifiController(mContext,this,wifiThread.getLooper());
  mWifiController.start();
  registerForScanModeChange();
  registerForDeviceProvisionedChange();
  registerForNotifyUserOnScanModeChange();
  mContext.registerReceiver(new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      if (mSettingsStore.handleAirplaneModeToggled()) {
        mWifiController.sendMessage(CMD_AIRPLANE_TOGGLED);
      }
    }
  }
,new IntentFilter(Intent.ACTION_AIRPLANE_MODE_CHANGED));
  mContext.registerReceiver(new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      if (intent.getAction().equals(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION)) {
        noteScanEnd();
      }
    }
  }
,new IntentFilter(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION));
}
