{
  mContext=context;
  mInterfaceName=SystemProperties.get("wifi.interface","wlan0");
  mWifiStateMachine=new WifiStateMachine(mContext,mInterfaceName);
  mWifiStateMachine.enableRssiPolling(true);
  mBatteryStats=BatteryStatsService.getService();
  mAppOps=(AppOpsManager)context.getSystemService(Context.APP_OPS_SERVICE);
  mAlarmManager=(AlarmManager)mContext.getSystemService(Context.ALARM_SERVICE);
  Intent idleIntent=new Intent(ACTION_DEVICE_IDLE,null);
  mIdleIntent=PendingIntent.getBroadcast(mContext,IDLE_REQUEST,idleIntent,0);
  mNotificationController=new WifiNotificationController(mContext,mWifiStateMachine);
  mTrafficPoller=new WifiTrafficPoller(mContext,mClients,mInterfaceName);
  mSettingsStore=new WifiSettingsStore(mContext);
  mContext.registerReceiver(new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      mSettingsStore.handleAirplaneModeToggled();
      updateWifiState();
    }
  }
,new IntentFilter(Intent.ACTION_AIRPLANE_MODE_CHANGED));
  mContext.registerReceiver(new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      if (intent.getAction().equals(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION)) {
        noteScanEnd();
      }
    }
  }
,new IntentFilter(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION));
  HandlerThread wifiThread=new HandlerThread("WifiService");
  wifiThread.start();
  mClientHandler=new ClientHandler(wifiThread.getLooper());
  mWifiStateMachineHandler=new WifiStateMachineHandler(wifiThread.getLooper());
}
