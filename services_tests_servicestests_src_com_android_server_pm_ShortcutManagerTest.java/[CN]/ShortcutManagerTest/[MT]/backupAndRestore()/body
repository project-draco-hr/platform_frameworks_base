{
  int prevUid=mInjectedCallingUid;
  mInjectedCallingUid=Process.SYSTEM_UID;
  dumpsysOnLogcat("Before backup");
  final byte[] payload=mService.getBackupPayload(USER_0);
  if (ENABLE_DUMP) {
    final String xml=new String(payload);
    Log.i(TAG,"Backup payload:");
    for (    String line : xml.split("\n")) {
      Log.i(TAG,line);
    }
  }
  for (  int userId : list(USER_0,USER_P0)) {
    for (    String pkg : list(CALLING_PACKAGE_1,CALLING_PACKAGE_2,CALLING_PACKAGE_3,LAUNCHER_1,LAUNCHER_2,LAUNCHER_3)) {
      uninstallPackage(userId,pkg);
    }
  }
  initService();
  mService.applyRestore(payload,USER_0);
  mService.handleUnlockUser(USER_0);
  dumpsysOnLogcat("After restore");
  mInjectedCallingUid=prevUid;
}
