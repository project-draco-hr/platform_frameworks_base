{
  String sdPath=Environment.getExternalStorageDirectory().getPath();
  StringBuilder fullPath=new StringBuilder(sdPath);
  if (subdirectory != null) {
    fullPath.append(File.separatorChar).append(subdirectory);
  }
  File file=null;
  if (filename == null) {
    file=File.createTempFile("DMTEST_",null,new File(fullPath.toString()));
  }
 else {
    fullPath.append(File.separatorChar).append(filename);
    file=new File(fullPath.toString());
    file.createNewFile();
  }
  DataOutputStream output=new DataOutputStream(new FileOutputStream(file));
  final int CHUNK_SIZE=1000000;
  long remaining=fileSize;
  int nextChunkSize=CHUNK_SIZE;
  byte[] randomData=null;
  Random rng=new LoggingRng();
  try {
    while (remaining > 0) {
      if (remaining < CHUNK_SIZE) {
        nextChunkSize=(int)remaining;
        remaining=0;
      }
 else {
        remaining-=CHUNK_SIZE;
      }
      randomData=generateData(nextChunkSize,type,rng);
      output.write(randomData);
    }
  }
 catch (  IOException e) {
    Log.e(LOG_TAG,"Error writing to file " + file.getAbsolutePath());
    file.delete();
    throw e;
  }
 finally {
    output.close();
  }
  return file;
}
