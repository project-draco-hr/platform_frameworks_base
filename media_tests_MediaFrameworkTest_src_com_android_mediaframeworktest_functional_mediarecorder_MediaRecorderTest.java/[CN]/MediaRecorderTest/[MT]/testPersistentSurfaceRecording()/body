{
  boolean success=false;
  int noOfFailure=0;
  Surface surface=null;
  try {
    int codec=MediaRecorder.VideoEncoder.H264;
    int frameRate=MediaProfileReader.getMaxFrameRateForCodec(codec);
    surface=MediaCodec.createPersistentInputSurface();
    for (int k=0; k < 2; k++) {
      String filename="/sdcard/surface_persistent" + k + ".3gp";
      Log.v(TAG,"test persistent surface - round " + k);
      success=recordVideoFromSurface(frameRate,0,352,288,codec,MediaRecorder.OutputFormat.THREE_GPP,filename,true,surface);
      if (success) {
        success=validateVideo(filename,352,288);
      }
      if (!success) {
        noOfFailure++;
      }
    }
  }
 catch (  Exception e) {
    Log.v(TAG,e.toString());
  }
 finally {
    if (surface != null) {
      Log.v(TAG,"releasing persistent surface");
      surface.release();
      surface=null;
    }
  }
  assertTrue("testPersistentSurfaceRecording",noOfFailure == 0);
}
