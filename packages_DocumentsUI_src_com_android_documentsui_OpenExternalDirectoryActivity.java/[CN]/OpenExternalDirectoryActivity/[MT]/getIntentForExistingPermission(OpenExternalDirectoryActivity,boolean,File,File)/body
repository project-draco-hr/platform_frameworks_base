{
  final String packageName=activity.getCallingPackage();
  final ContentProviderClient storageClient=activity.getExternalStorageClient();
  final Uri grantedUri=getGrantedUriPermission(activity,storageClient,file);
  final Uri rootUri=root.equals(file) ? grantedUri : getGrantedUriPermission(activity,storageClient,root);
  if (DEBUG)   Log.d(TAG,"checking if " + packageName + " already has permission for "+ grantedUri+ " or its root ("+ rootUri+ ")");
  final ActivityManager am=(ActivityManager)activity.getSystemService(Context.ACTIVITY_SERVICE);
  for (  UriPermission uriPermission : am.getGrantedUriPermissions(packageName).getList()) {
    final Uri uri=uriPermission.getUri();
    if (uri == null) {
      Log.w(TAG,"null URI for " + uriPermission);
      continue;
    }
    if (uri.equals(grantedUri) || uri.equals(rootUri)) {
      if (DEBUG)       Log.d(TAG,packageName + " already has permission: " + uriPermission);
      return createGrantedUriPermissionsIntent(grantedUri);
    }
  }
  if (DEBUG)   Log.d(TAG,packageName + " does not have permission for " + grantedUri);
  return null;
}
