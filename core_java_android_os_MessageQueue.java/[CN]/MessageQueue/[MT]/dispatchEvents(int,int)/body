{
  final FileDescriptorRecord record;
  final int oldWatchedEvents;
  final FileDescriptorCallback callback;
  final int seq;
synchronized (this) {
    record=mFileDescriptorRecords.get(fd);
    if (record == null) {
      return 0;
    }
    oldWatchedEvents=record.mEvents;
    events&=oldWatchedEvents;
    if (events == 0) {
      return oldWatchedEvents;
    }
    callback=record.mCallback;
    seq=record.mSeq;
  }
  int newWatchedEvents=callback.onFileDescriptorEvents(record.mDescriptor,events);
  if (newWatchedEvents != 0) {
    newWatchedEvents|=FileDescriptorCallback.EVENT_ERROR;
  }
  if (newWatchedEvents != oldWatchedEvents) {
synchronized (this) {
      int index=mFileDescriptorRecords.indexOfKey(fd);
      if (index >= 0 && mFileDescriptorRecords.valueAt(index) == record && record.mSeq == seq) {
        record.mEvents=newWatchedEvents;
        if (newWatchedEvents == 0) {
          mFileDescriptorRecords.removeAt(index);
        }
      }
    }
  }
  return newWatchedEvents;
}
