{
  final ImageView anchorButton=(ImageView)mPopupAnchor.findViewById(R.id.shelf_menu_anchor_anchor);
  anchorButton.setImageDrawable(appIcon.getDrawable());
  appIcon.getLocationOnScreen(mClickedIconLocation);
  anchorButton.setTranslationX(mClickedIconLocation[0]);
  anchorButton.setTranslationY(mClickedIconLocation[1]);
  final OnAttachStateChangeListener onAttachStateChangeListener=new OnAttachStateChangeListener(){
    @Override public void onViewAttachedToWindow(    View v){
      mPopupMenu.show();
    }
    @Override public void onViewDetachedFromWindow(    View v){
    }
  }
;
  anchorButton.addOnAttachStateChangeListener(onAttachStateChangeListener);
  mPopupMenu.setOnDismissListener(new PopupMenu.OnDismissListener(){
    @Override public void onDismiss(    PopupMenu menu){
      mWindowManager.removeView(mPopupAnchor);
      anchorButton.removeOnAttachStateChangeListener(onAttachStateChangeListener);
      mPopupMenu.setOnDismissListener(null);
      mPopupMenu.getMenu().clear();
      mIsPopupInUse=false;
    }
  }
);
  mWindowManager.addView(mPopupAnchor,mPopupAnchorLayoutParams);
  mIsPopupInUse=true;
}
