{
  final VMRuntime runtime=VMRuntime.getRuntime();
  final int SIXTEEN_MB=(16 * 1024 * 1024);
  final int MIN_SIZE=16;
  long totalAllocated=0;
  boolean success;
  success=false;
  try {
    int objSize=1 * 1024 * 1024;
    while (objSize >= MIN_SIZE) {
      boolean sawFailure=false;
      for (int i=0; i < SIXTEEN_MB / objSize; i++) {
        if (runtime.trackExternalAllocation(objSize)) {
          totalAllocated+=objSize;
        }
 else {
          sawFailure=true;
          break;
        }
      }
      if (!sawFailure) {
        throw new RuntimeException("Test failed: " + "no failure while filling heap");
      }
      objSize=(objSize * 4) / 5;
    }
    success=true;
  }
  finally {
    if (!success) {
      runtime.trackExternalFree(totalAllocated);
      totalAllocated=0;
    }
  }
  return totalAllocated;
}
