{
  Log.v(TAG,"onRegistrationDone(): " + session + ": "+ mSession);
synchronized (SipService.this) {
    if (!isStopped() && (session != mSession))     return;
    try {
      mProxy.onRegistrationDone(session,duration);
    }
 catch (    Throwable t) {
      Log.w(TAG,"onRegistrationDone()",t);
    }
    if (isStopped())     return;
    if (duration > 0) {
      mSession.clearReRegisterRequired();
      mExpiryTime=SystemClock.elapsedRealtime() + (duration * 1000);
      if (!mRegistered) {
        mRegistered=true;
        duration-=MIN_EXPIRY_TIME;
        if (duration < MIN_EXPIRY_TIME) {
          duration=MIN_EXPIRY_TIME;
        }
        restart(duration);
        if (isBehindNAT(mLocalIp) || mSession.getLocalProfile().getSendKeepAlive()) {
          if (mKeepAliveProcess == null) {
            mKeepAliveProcess=new KeepAliveProcess(mSession);
          }
          mKeepAliveProcess.start();
        }
      }
    }
 else {
      mRegistered=false;
      mExpiryTime=-1L;
      Log.v(TAG,"Refresh registration immediately");
      run();
    }
  }
}
