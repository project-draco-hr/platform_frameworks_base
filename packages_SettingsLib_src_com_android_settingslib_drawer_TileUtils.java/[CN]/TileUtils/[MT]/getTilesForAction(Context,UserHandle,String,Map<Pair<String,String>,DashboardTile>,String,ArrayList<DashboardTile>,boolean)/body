{
  PackageManager pm=context.getPackageManager();
  Intent intent=new Intent(action);
  List<ResolveInfo> results=pm.queryIntentActivitiesAsUser(intent,PackageManager.GET_META_DATA,user.getIdentifier());
  for (  ResolveInfo resolved : results) {
    if (requireSettings) {
      if (!SETTING_PKG.equals(resolved.activityInfo.applicationInfo.packageName)) {
        continue;
      }
    }
 else {
      if (!resolved.system) {
        continue;
      }
    }
    ActivityInfo activityInfo=resolved.activityInfo;
    Bundle metaData=activityInfo.metaData;
    String categoryKey=defaultCategory;
    if (((metaData == null) || !metaData.containsKey(EXTRA_CATEGORY_KEY)) && categoryKey == null) {
      Log.w(LOG_TAG,"Found " + resolved.activityInfo.name + " for action "+ action+ " missing metadata "+ (metaData == null ? "" : EXTRA_CATEGORY_KEY));
      continue;
    }
 else {
      categoryKey=metaData.getString(EXTRA_CATEGORY_KEY);
    }
    Pair<String,String> key=new Pair<String,String>(activityInfo.packageName,activityInfo.name);
    DashboardTile tile=addedCache.get(key);
    if (tile == null) {
      tile=new DashboardTile();
      tile.intent=new Intent().setClassName(activityInfo.packageName,activityInfo.name);
      tile.category=categoryKey;
      tile.priority=requireSettings ? resolved.priority : 0;
      tile.metaData=activityInfo.metaData;
      updateTileData(context,tile,activityInfo,activityInfo.applicationInfo,pm);
      if (DEBUG)       Log.d(LOG_TAG,"Adding tile " + tile.title);
      addedCache.put(key,tile);
    }
    if (!tile.userHandle.contains(user)) {
      tile.userHandle.add(user);
    }
    if (!outTiles.contains(tile)) {
      outTiles.add(tile);
    }
  }
}
