{
  long elapsedRealtime=0;
  long currentTime=0;
  NetworkState[] state=null;
  NetworkStats stats=null;
  Future<Void> future;
  Capture<String> tag;
  final long TIME_FEB_15=1171497600000L;
  final long TIME_MAR_10=1173484800000L;
  final int CYCLE_DAY=15;
  elapsedRealtime=0;
  currentTime=TIME_MAR_10 + elapsedRealtime;
  state=new NetworkState[]{};
{
    expectTime(currentTime);
    expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
    expectClearNotifications();
    future=expectMeteredIfacesChanged();
    replay();
    setNetworkPolicies(new NetworkPolicy(sTemplateWifi,CYCLE_DAY,1024L,2048L,SNOOZE_NEVER));
    future.get();
    verifyAndReset();
  }
  elapsedRealtime+=MINUTE_IN_MILLIS;
  currentTime=TIME_MAR_10 + elapsedRealtime;
  stats=new NetworkStats(elapsedRealtime,1).addIfaceValues(TEST_IFACE,0L,0L,0L,0L);
  state=new NetworkState[]{buildWifi()};
{
    expectTime(currentTime);
    expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
    expect(mStatsService.getSummaryForNetwork(sTemplateWifi,TIME_FEB_15,currentTime)).andReturn(stats).atLeastOnce();
    expectRemoveInterfaceQuota(TEST_IFACE);
    expectSetInterfaceQuota(TEST_IFACE,2048L);
    expectRemoveInterfaceAlert(TEST_IFACE);
    expectSetInterfaceAlert(TEST_IFACE,1024L);
    expectClearNotifications();
    future=expectMeteredIfacesChanged(TEST_IFACE);
    replay();
    mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION));
    future.get();
    verifyAndReset();
  }
  elapsedRealtime+=MINUTE_IN_MILLIS;
  currentTime=TIME_MAR_10 + elapsedRealtime;
  stats=new NetworkStats(elapsedRealtime,1).addIfaceValues(TEST_IFACE,1536L,15L,0L,0L);
{
    expectTime(currentTime);
    expect(mStatsService.getSummaryForNetwork(sTemplateWifi,TIME_FEB_15,currentTime)).andReturn(stats).atLeastOnce();
    expectForceUpdate();
    expectClearNotifications();
    tag=expectEnqueueNotification();
    replay();
    mNetworkObserver.limitReached(null,TEST_IFACE);
    assertNotificationType(TYPE_WARNING,tag.getValue());
    verifyAndReset();
  }
  elapsedRealtime+=MINUTE_IN_MILLIS;
  currentTime=TIME_MAR_10 + elapsedRealtime;
  stats=new NetworkStats(elapsedRealtime,1).addIfaceValues(TEST_IFACE,5120L,512L,0L,0L);
{
    expectTime(currentTime);
    expect(mStatsService.getSummaryForNetwork(sTemplateWifi,TIME_FEB_15,currentTime)).andReturn(stats).atLeastOnce();
    expectForceUpdate();
    expectClearNotifications();
    tag=expectEnqueueNotification();
    replay();
    mNetworkObserver.limitReached(null,TEST_IFACE);
    assertNotificationType(TYPE_LIMIT,tag.getValue());
    verifyAndReset();
  }
  elapsedRealtime+=MINUTE_IN_MILLIS;
  currentTime=TIME_MAR_10 + elapsedRealtime;
{
    expectTime(currentTime);
    expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
    expect(mStatsService.getSummaryForNetwork(sTemplateWifi,TIME_FEB_15,currentTime)).andReturn(stats).atLeastOnce();
    expectRemoveInterfaceQuota(TEST_IFACE);
    expectRemoveInterfaceAlert(TEST_IFACE);
    expectClearNotifications();
    tag=expectEnqueueNotification();
    future=expectMeteredIfacesChanged();
    replay();
    mService.snoozePolicy(sTemplateWifi);
    future.get();
    assertNotificationType(TYPE_LIMIT_SNOOZED,tag.getValue());
    verifyAndReset();
  }
}
