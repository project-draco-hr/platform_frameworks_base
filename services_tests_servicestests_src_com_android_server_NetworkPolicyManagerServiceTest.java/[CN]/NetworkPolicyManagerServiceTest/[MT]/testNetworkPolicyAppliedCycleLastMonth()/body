{
  long elapsedRealtime=0;
  NetworkState[] state=null;
  NetworkStats stats=null;
  Future<Void> future;
  final long TIME_FEB_15=1171497600000L;
  final long TIME_MAR_10=1173484800000L;
  final int CYCLE_DAY=15;
  state=new NetworkState[]{buildWifi()};
  expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
  expectTime(TIME_MAR_10 + elapsedRealtime);
  expectClearNotifications();
  future=expectMeteredIfacesChanged();
  replay();
  mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION));
  future.get();
  verifyAndReset();
  expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
  expectTime(TIME_MAR_10 + elapsedRealtime);
  stats=new NetworkStats(elapsedRealtime,1).addValues(TEST_IFACE,UID_ALL,TAG_NONE,256L,2L,256L,2L);
  expect(mStatsService.getSummaryForNetwork(sTemplateWifi,TIME_FEB_15,TIME_MAR_10)).andReturn(stats).atLeastOnce();
  expectRemoveInterfaceQuota(TEST_IFACE);
  expectSetInterfaceQuota(TEST_IFACE,1536L);
  expectRemoveInterfaceAlert(TEST_IFACE);
  expectSetInterfaceAlert(TEST_IFACE,512L);
  expectClearNotifications();
  future=expectMeteredIfacesChanged(TEST_IFACE);
  replay();
  setNetworkPolicies(new NetworkPolicy(sTemplateWifi,CYCLE_DAY,1024L,2048L,SNOOZE_NEVER));
  future.get();
  verifyAndReset();
}
