{
  NetworkState[] state=null;
  NetworkStats stats=null;
  Future<Void> future;
  final long TIME_FEB_15=1171497600000L;
  final long TIME_MAR_10=1173484800000L;
  final int CYCLE_DAY=15;
  setCurrentTimeMillis(TIME_MAR_10);
  state=new NetworkState[]{buildWifi()};
  expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
  expectCurrentTime();
  expectClearNotifications();
  future=expectMeteredIfacesChanged();
  replay();
  mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION_IMMEDIATE));
  future.get();
  verifyAndReset();
  expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
  expectCurrentTime();
  stats=new NetworkStats(getElapsedRealtime(),1).addIfaceValues(TEST_IFACE,256L,2L,256L,2L);
  expect(mStatsService.getSummaryForNetwork(sTemplateWifi,TIME_FEB_15,TIME_MAR_10)).andReturn(stats).atLeastOnce();
  expectRemoveInterfaceQuota(TEST_IFACE);
  expectSetInterfaceQuota(TEST_IFACE,1536L);
  expectClearNotifications();
  future=expectMeteredIfacesChanged(TEST_IFACE);
  replay();
  setNetworkPolicies(new NetworkPolicy(sTemplateWifi,CYCLE_DAY,1024L,2048L,SNOOZE_NEVER));
  future.get();
  verifyAndReset();
}
