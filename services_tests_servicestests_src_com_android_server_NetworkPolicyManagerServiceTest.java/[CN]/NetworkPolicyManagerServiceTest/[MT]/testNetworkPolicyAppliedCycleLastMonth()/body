{
  long elapsedRealtime=0;
  NetworkState[] state=null;
  NetworkStats stats=null;
  final long TIME_FEB_15=1171497600000L;
  final long TIME_MAR_10=1173484800000L;
  final int CYCLE_DAY=15;
  state=new NetworkState[]{buildWifi()};
  expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
  expectTime(TIME_MAR_10 + elapsedRealtime);
  expectMeteredIfacesChanged();
  replay();
  mServiceContext.sendBroadcast(new Intent(CONNECTIVITY_ACTION));
  verifyAndReset();
  expect(mConnManager.getAllNetworkState()).andReturn(state).atLeastOnce();
  expectTime(TIME_MAR_10 + elapsedRealtime);
  stats=new NetworkStats(elapsedRealtime,1).addEntry(TEST_IFACE,UID_ALL,256L,256L);
  expect(mStatsService.getSummaryForNetwork(TIME_FEB_15,TIME_MAR_10,TEMPLATE_WIFI,null)).andReturn(stats).atLeastOnce();
  expectClearNotifications();
  expectMeteredIfacesChanged(TEST_IFACE);
  replay();
  setNetworkPolicies(new NetworkPolicy(TEMPLATE_WIFI,null,CYCLE_DAY,1024L,2048L));
  verifyAndReset();
}
