{
  super.setUp();
  mServiceContext=new BroadcastInterceptingContext(getContext()){
    @Override public PackageManager getPackageManager(){
      return new MockPackageManager(){
        @Override public String[] getPackagesForUid(        int uid){
          return new String[]{"com.example"};
        }
        @Override public PackageInfo getPackageInfo(        String packageName,        int flags){
          final PackageInfo info=new PackageInfo();
          final Signature signature;
          if ("android".equals(packageName)) {
            signature=new Signature("F00D");
          }
 else {
            signature=new Signature("DEAD");
          }
          info.signatures=new Signature[]{signature};
          return info;
        }
      }
;
    }
  }
;
  mPolicyDir=getContext().getFilesDir();
  for (  File file : mPolicyDir.listFiles()) {
    file.delete();
  }
  mActivityManager=createMock(IActivityManager.class);
  mPowerManager=createMock(IPowerManager.class);
  mStatsService=createMock(INetworkStatsService.class);
  mNetworkManagement=createMock(INetworkManagementService.class);
  mPolicyListener=createMock(INetworkPolicyListener.class);
  mTime=createMock(TrustedTime.class);
  mConnManager=createMock(IConnectivityManager.class);
  mNotifManager=createMock(INotificationManager.class);
  mService=new NetworkPolicyManagerService(mServiceContext,mActivityManager,mPowerManager,mStatsService,mNetworkManagement,mTime,mPolicyDir);
  mService.bindConnectivityManager(mConnManager);
  mService.bindNotificationManager(mNotifManager);
  expect(mPolicyListener.asBinder()).andReturn(mStubBinder).atLeastOnce();
  replay();
  mService.registerListener(mPolicyListener);
  verifyAndReset();
  final Capture<IProcessObserver> processObserver=new Capture<IProcessObserver>();
  mActivityManager.registerProcessObserver(capture(processObserver));
  expectLastCall().atLeastOnce();
  expect(mPowerManager.isScreenOn()).andReturn(true).atLeastOnce();
  expectTime(System.currentTimeMillis());
  expect(mConnManager.getBackgroundDataSetting()).andReturn(true);
  replay();
  mService.systemReady();
  verifyAndReset();
  mProcessObserver=processObserver.getValue();
}
