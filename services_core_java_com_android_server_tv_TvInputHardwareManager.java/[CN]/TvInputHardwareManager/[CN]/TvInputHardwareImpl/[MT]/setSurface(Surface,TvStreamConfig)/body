{
synchronized (mImplLock) {
    if (mReleased) {
      throw new IllegalStateException("Device already released.");
    }
    if (surface != null && config == null) {
      return false;
    }
    if (surface == null && mActiveConfig == null) {
      return false;
    }
    if (mInfo.getType() == TvInputHal.TYPE_HDMI) {
      if (surface != null) {
        mActiveHdmiSources.add(mInfo.getDeviceId());
      }
 else {
        mActiveHdmiSources.remove(mInfo.getDeviceId());
        if (mActiveHdmiSources.size() == 0) {
        }
      }
    }
    if (mAudioSource != null && mAudioSink != null) {
      if (surface != null) {
        AudioPortConfig sourceConfig=mAudioSource.activeConfig();
        AudioPortConfig sinkConfig=mAudioSink.activeConfig();
        AudioPatch[] audioPatchArray=new AudioPatch[]{mAudioPatch};
        mAudioManager.createAudioPatch(audioPatchArray,new AudioPortConfig[]{sourceConfig},new AudioPortConfig[]{sinkConfig});
        mAudioPatch=audioPatchArray[0];
      }
 else {
        mAudioManager.releaseAudioPatch(mAudioPatch);
        mAudioPatch=null;
      }
    }
    int result=TvInputHal.ERROR_UNKNOWN;
    if (surface == null) {
      result=mHal.removeStream(mInfo.getDeviceId(),mActiveConfig);
      mActiveConfig=null;
    }
 else {
      if (config != mActiveConfig && mActiveConfig != null) {
        result=mHal.removeStream(mInfo.getDeviceId(),mActiveConfig);
        if (result != TvInputHal.SUCCESS) {
          mActiveConfig=null;
          return false;
        }
      }
      result=mHal.addStream(mInfo.getDeviceId(),surface,config);
      if (result == TvInputHal.SUCCESS) {
        mActiveConfig=config;
      }
    }
    return result == TvInputHal.SUCCESS;
  }
}
