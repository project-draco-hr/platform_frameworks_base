{
synchronized (mImplLock) {
    if (mReleased) {
      throw new IllegalStateException("Device already released.");
    }
    if (surface != null && config == null) {
      return false;
    }
    if (surface == null && mActiveConfig == null) {
      return false;
    }
    int result=TvInputHal.ERROR_UNKNOWN;
    if (surface == null) {
      result=mHal.removeStream(mInfo.getDeviceId(),mActiveConfig);
      mActiveConfig=null;
    }
 else {
      if (config != mActiveConfig && mActiveConfig != null) {
        result=mHal.removeStream(mInfo.getDeviceId(),mActiveConfig);
        if (result != TvInputHal.SUCCESS) {
          mActiveConfig=null;
          return false;
        }
      }
      result=mHal.addStream(mInfo.getDeviceId(),surface,config);
      if (result == TvInputHal.SUCCESS) {
        mActiveConfig=config;
      }
    }
    updateAudioConfigLocked();
    return result == TvInputHal.SUCCESS;
  }
}
