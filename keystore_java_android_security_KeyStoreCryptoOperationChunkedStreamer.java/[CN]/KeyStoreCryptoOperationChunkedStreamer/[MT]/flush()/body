{
  if (mBufferedLength <= 0) {
    return EmptyArray.BYTE;
  }
  byte[] chunk=ArrayUtils.subarray(mBuffered,mBufferedOffset,mBufferedLength);
  mBuffered=EmptyArray.BYTE;
  mBufferedLength=0;
  mBufferedOffset=0;
  OperationResult opResult=mKeyStoreStream.update(chunk);
  if (opResult == null) {
    throw new KeyStoreConnectException();
  }
 else   if (opResult.resultCode != KeyStore.NO_ERROR) {
    throw KeyStore.getKeyStoreException(opResult.resultCode);
  }
  if (opResult.inputConsumed < chunk.length) {
    throw new CryptoOperationException("Keystore failed to consume all input. Provided: " + chunk.length + ", consumed: "+ opResult.inputConsumed);
  }
 else   if (opResult.inputConsumed > chunk.length) {
    throw new CryptoOperationException("Keystore consumed more input than provided" + " . Provided: " + chunk.length + ", consumed: "+ opResult.inputConsumed);
  }
  return (opResult.output != null) ? opResult.output : EmptyArray.BYTE;
}
