{
  if (inputLength == 0) {
    input=EMPTY_BYTE_ARRAY;
    inputOffset=0;
  }
  byte[] output=update(input,inputOffset,inputLength);
  output=concat(output,flush());
  OperationResult opResult=mKeyStoreStream.finish();
  if (opResult == null) {
    throw new KeyStoreConnectException();
  }
 else   if (opResult.resultCode != KeyStore.NO_ERROR) {
    throw KeymasterUtils.getKeymasterException(opResult.resultCode);
  }
  return concat(output,opResult.output);
}
