{
  assertRunOnIoThread();
  int startAddress=preferredAddress;
  if (preferredAddress == Constants.ADDR_UNREGISTERED) {
    for (int i=0; i < NUM_LOGICAL_ADDRESS; ++i) {
      if (deviceType == HdmiUtils.getTypeFromAddress(i)) {
        startAddress=i;
        break;
      }
    }
  }
  int logicalAddress=Constants.ADDR_UNREGISTERED;
  for (int i=0; i < NUM_LOGICAL_ADDRESS; ++i) {
    int curAddress=(startAddress + i) % NUM_LOGICAL_ADDRESS;
    if (curAddress != Constants.ADDR_UNREGISTERED && deviceType == HdmiUtils.getTypeFromAddress(curAddress)) {
      if (!sendPollMessage(curAddress,curAddress,RETRY_COUNT_FOR_LOGICAL_ADDRESS_ALLOCATION)) {
        logicalAddress=curAddress;
        break;
      }
    }
  }
  final int assignedAddress=logicalAddress;
  if (callback != null) {
    runOnServiceThread(new Runnable(){
      @Override public void run(){
        callback.onAllocated(deviceType,assignedAddress);
      }
    }
);
  }
}
