{
  assertRunOnIoThread();
  int startAddress=preferredAddress;
  if (preferredAddress == Constants.ADDR_UNREGISTERED) {
    for (int i=0; i < NUM_LOGICAL_ADDRESS; ++i) {
      if (deviceType == HdmiUtils.getTypeFromAddress(i)) {
        startAddress=i;
        break;
      }
    }
  }
  int logicalAddress=Constants.ADDR_UNREGISTERED;
  for (int i=0; i < NUM_LOGICAL_ADDRESS; ++i) {
    int curAddress=(startAddress + i) % NUM_LOGICAL_ADDRESS;
    if (curAddress != Constants.ADDR_UNREGISTERED && deviceType == HdmiUtils.getTypeFromAddress(curAddress)) {
      int failedPollingCount=0;
      for (int j=0; j < HdmiConfig.ADDRESS_ALLOCATION_RETRY; ++j) {
        if (!sendPollMessage(curAddress,curAddress,1)) {
          failedPollingCount++;
        }
      }
      if (failedPollingCount * 2 > HdmiConfig.ADDRESS_ALLOCATION_RETRY) {
        logicalAddress=curAddress;
        break;
      }
    }
  }
  final int assignedAddress=logicalAddress;
  HdmiLogger.debug("New logical address for device [%d]: [preferred:%d, assigned:%d]",deviceType,preferredAddress,assignedAddress);
  if (callback != null) {
    runOnServiceThread(new Runnable(){
      @Override public void run(){
        callback.onAllocated(deviceType,assignedAddress);
      }
    }
);
  }
}
