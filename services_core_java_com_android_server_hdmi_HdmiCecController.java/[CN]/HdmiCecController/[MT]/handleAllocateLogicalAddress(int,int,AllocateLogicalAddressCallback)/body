{
  int startAddress=preferredAddress;
  if (preferredAddress == HdmiCec.ADDR_UNREGISTERED) {
    for (int i=0; i < NUM_LOGICAL_ADDRESS; ++i) {
      if (deviceType == HdmiCec.getTypeFromAddress(i)) {
        startAddress=i;
        break;
      }
    }
  }
  int logicalAddress=HdmiCec.ADDR_UNREGISTERED;
  for (int i=0; i < NUM_LOGICAL_ADDRESS; ++i) {
    int curAddress=(startAddress + i) % NUM_LOGICAL_ADDRESS;
    if (curAddress != HdmiCec.ADDR_UNREGISTERED && deviceType == HdmiCec.getTypeFromAddress(i)) {
      int error=nativeSendCecCommand(mNativePtr,curAddress,curAddress,EMPTY_BODY);
      if (error != HdmiControlService.SEND_RESULT_SUCCESS) {
        logicalAddress=curAddress;
        break;
      }
    }
  }
  final int assignedAddress=logicalAddress;
  if (callback != null) {
    runOnServiceThread(new Runnable(){
      @Override public void run(){
        callback.onAllocated(deviceType,assignedAddress);
      }
    }
);
  }
}
