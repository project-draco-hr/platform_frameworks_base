{
  if (isDestroyed()) {
    return false;
  }
  if (st.isPrepared)   return true;
  if ((mPreparedPanel != null) && (mPreparedPanel != st)) {
    closePanel(mPreparedPanel,false);
  }
  final Callback cb=getCallback();
  if (cb != null) {
    st.createdPanelView=cb.onCreatePanelView(st.featureId);
  }
  if (st.createdPanelView == null) {
    if (st.menu == null || st.refreshMenuContent) {
      if (st.menu == null) {
        if (!initializePanelMenu(st) || (st.menu == null)) {
          return false;
        }
      }
      st.menu.stopDispatchingItemsChanged();
      if ((cb == null) || !cb.onCreatePanelMenu(st.featureId,st.menu)) {
        st.menu=null;
        return false;
      }
      st.refreshMenuContent=false;
      if (mActionBar != null) {
        if (mActionMenuPresenterCallback == null) {
          mActionMenuPresenterCallback=new ActionMenuPresenterCallback();
        }
        mActionBar.setMenu(st.menu,mActionMenuPresenterCallback);
      }
    }
    st.menu.stopDispatchingItemsChanged();
    if (!cb.onPreparePanel(st.featureId,st.createdPanelView,st.menu)) {
      st.menu.startDispatchingItemsChanged();
      return false;
    }
    st.menu.startDispatchingItemsChanged();
    KeyCharacterMap kmap=KeyCharacterMap.load(event != null ? event.getDeviceId() : KeyCharacterMap.VIRTUAL_KEYBOARD);
    st.qwertyMode=kmap.getKeyboardType() != KeyCharacterMap.NUMERIC;
    st.menu.setQwertyMode(st.qwertyMode);
  }
  st.isPrepared=true;
  st.isHandled=false;
  mPreparedPanel=st;
  if (st.frozenActionViewState != null) {
    st.menu.restoreActionViewStates(st.frozenActionViewState);
    st.frozenActionViewState=null;
  }
  return true;
}
