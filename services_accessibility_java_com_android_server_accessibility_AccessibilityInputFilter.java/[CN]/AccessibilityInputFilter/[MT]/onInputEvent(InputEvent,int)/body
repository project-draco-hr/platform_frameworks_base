{
  if (DEBUG) {
    Slog.d(TAG,"Received event: " + event + ", policyFlags=0x"+ Integer.toHexString(policyFlags));
  }
  if (mEventHandler == null) {
    super.onInputEvent(event,policyFlags);
    return;
  }
  EventStreamState state=getEventStreamState(event);
  if (state == null) {
    super.onInputEvent(event,policyFlags);
    return;
  }
  int eventSource=event.getSource();
  if ((policyFlags & WindowManagerPolicy.FLAG_PASS_TO_USER) == 0) {
    state.reset();
    mEventHandler.clearEvents(eventSource);
    super.onInputEvent(event,policyFlags);
    return;
  }
  if (state.updateDeviceId(event.getDeviceId())) {
    mEventHandler.clearEvents(eventSource);
  }
  if (!state.deviceIdValid()) {
    super.onInputEvent(event,policyFlags);
    return;
  }
  if (event instanceof MotionEvent) {
    MotionEvent motionEvent=(MotionEvent)event;
    processMotionEvent(state,motionEvent,policyFlags);
  }
 else   if (event instanceof KeyEvent) {
    KeyEvent keyEvent=(KeyEvent)event;
    processKeyEvent(state,keyEvent,policyFlags);
  }
}
