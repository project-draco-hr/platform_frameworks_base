{
  int srclen=end - start;
  if (srclen < 0)   throw new StringIndexOutOfBoundsException();
  int len=ArrayUtils.idealCharArraySize(srclen + 1);
  mText=new char[len];
  mGapStart=srclen;
  mGapLength=len - srclen;
  TextUtils.getChars(text,start,end,mText,0);
  mSpanCount=0;
  int alloc=ArrayUtils.idealIntArraySize(0);
  mSpans=new Object[alloc];
  mSpanStarts=new int[alloc];
  mSpanEnds=new int[alloc];
  mSpanFlags=new int[alloc];
  if (text instanceof Spanned) {
    Spanned sp=(Spanned)text;
    Object[] spans=sp.getSpans(start,end,Object.class);
    for (int i=0; i < spans.length; i++) {
      if (spans[i] instanceof NoCopySpan) {
        continue;
      }
      int st=sp.getSpanStart(spans[i]) - start;
      int en=sp.getSpanEnd(spans[i]) - start;
      int fl=sp.getSpanFlags(spans[i]);
      if (st < 0)       st=0;
      if (st > end - start)       st=end - start;
      if (en < 0)       en=0;
      if (en > end - start)       en=end - start;
      setSpan(false,spans[i],st,en,fl);
    }
  }
}
