{
  if ((i & 1) != 0) {
    int left=leftChild(i);
    int spanMax=mSpanMax[left];
    if (spanMax > mGapStart) {
      spanMax-=mGapLength;
    }
    if (spanMax >= queryStart) {
      count=getSpansRec(queryStart,queryEnd,kind,left,ret,count);
    }
  }
  if (i >= mSpanCount)   return count;
  int spanStart=mSpanStarts[i];
  if (spanStart > mGapStart) {
    spanStart-=mGapLength;
  }
  if (spanStart <= queryEnd) {
    int spanEnd=mSpanEnds[i];
    if (spanEnd > mGapStart) {
      spanEnd-=mGapLength;
    }
    if (spanEnd >= queryStart && (spanStart == spanEnd || queryStart == queryEnd || (spanStart != queryEnd && spanEnd != queryStart)) && kind.isInstance(mSpans[i])) {
      int prio=mSpanFlags[i] & SPAN_PRIORITY;
      if (prio != 0) {
        int j;
        for (j=0; j < count; j++) {
          int p=getSpanFlags(ret[j]) & SPAN_PRIORITY;
          if (prio > p) {
            break;
          }
        }
        System.arraycopy(ret,j,ret,j + 1,count - j);
        ret[j]=(T)mSpans[i];
      }
 else {
        ret[count]=(T)mSpans[i];
      }
      count++;
    }
    if (count < ret.length && (i & 1) != 0) {
      count=getSpansRec(queryStart,queryEnd,kind,rightChild(i),ret,count);
    }
  }
  return count;
}
