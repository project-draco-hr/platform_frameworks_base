{
synchronized (sInstances) {
    KeyCharacterMap map=sInstances.get(deviceId);
    if (map == null) {
      String kcm=null;
      if (deviceId != VIRTUAL_KEYBOARD) {
        InputDevice device=InputDevice.getDevice(deviceId);
        if (device != null) {
          kcm=device.getKeyCharacterMapFile();
        }
      }
      if (kcm == null || kcm.length() == 0) {
        kcm="/system/usr/keychars/Virtual.kcm";
      }
      int ptr=nativeLoad(kcm);
      map=new KeyCharacterMap(deviceId,ptr);
      sInstances.put(deviceId,map);
    }
    return map;
  }
}
