{
  for (int conni=r.connections.size() - 1; conni >= 0; conni--) {
    ArrayList<ConnectionRecord> c=r.connections.valueAt(conni);
    for (int i=0; i < c.size(); i++) {
      ConnectionRecord cr=c.get(i);
      cr.serviceDead=true;
      try {
        cr.conn.connected(r.name,null);
      }
 catch (      Exception e) {
        Slog.w(TAG,"Failure disconnecting service " + r.name + " to connection "+ c.get(i).conn.asBinder()+ " (in "+ c.get(i).binding.client.processName+ ")",e);
      }
    }
  }
  if (r.app != null && r.app.thread != null) {
    for (int i=r.bindings.size() - 1; i >= 0; i--) {
      IntentBindRecord ibr=r.bindings.valueAt(i);
      if (DEBUG_SERVICE)       Slog.v(TAG_SERVICE,"Bringing down binding " + ibr + ": hasBound="+ ibr.hasBound);
      if (ibr.hasBound) {
        try {
          bumpServiceExecutingLocked(r,false,"bring down unbind");
          mAm.updateOomAdjLocked(r.app);
          ibr.hasBound=false;
          r.app.thread.scheduleUnbindService(r,ibr.intent.getIntent());
        }
 catch (        Exception e) {
          Slog.w(TAG,"Exception when unbinding service " + r.shortName,e);
          serviceProcessGoneLocked(r);
        }
      }
    }
  }
  if (DEBUG_SERVICE)   Slog.v(TAG_SERVICE,"Bringing down " + r + " "+ r.intent);
  r.destroyTime=SystemClock.uptimeMillis();
  if (LOG_SERVICE_START_STOP) {
    EventLogTags.writeAmDestroyService(r.userId,System.identityHashCode(r),(r.app != null) ? r.app.pid : -1);
  }
  final ServiceMap smap=getServiceMap(r.userId);
  smap.mServicesByName.remove(r.name);
  smap.mServicesByIntent.remove(r.intent);
  r.totalRestartCount=0;
  unscheduleServiceRestartLocked(r,0,true);
  for (int i=mPendingServices.size() - 1; i >= 0; i--) {
    if (mPendingServices.get(i) == r) {
      mPendingServices.remove(i);
      if (DEBUG_SERVICE)       Slog.v(TAG_SERVICE,"Removed pending: " + r);
    }
  }
  r.cancelNotification();
  r.isForeground=false;
  r.foregroundId=0;
  r.foregroundNoti=null;
  r.clearDeliveredStartsLocked();
  r.pendingStarts.clear();
  if (r.app != null) {
synchronized (r.stats.getBatteryStats()) {
      r.stats.stopLaunchedLocked();
    }
    r.app.services.remove(r);
    if (r.whitelistManager) {
      updateWhitelistManagerLocked(r.app);
    }
    if (r.app.thread != null) {
      updateServiceForegroundLocked(r.app,false);
      try {
        bumpServiceExecutingLocked(r,false,"destroy");
        mDestroyingServices.add(r);
        r.destroying=true;
        mAm.updateOomAdjLocked(r.app);
        r.app.thread.scheduleStopService(r);
      }
 catch (      Exception e) {
        Slog.w(TAG,"Exception when destroying service " + r.shortName,e);
        serviceProcessGoneLocked(r);
      }
    }
 else {
      if (DEBUG_SERVICE)       Slog.v(TAG_SERVICE,"Removed service that has no process: " + r);
    }
  }
 else {
    if (DEBUG_SERVICE)     Slog.v(TAG_SERVICE,"Removed service that is not running: " + r);
  }
  if (r.bindings.size() > 0) {
    r.bindings.clear();
  }
  if (r.restarter instanceof ServiceRestarter) {
    ((ServiceRestarter)r.restarter).setService(null);
  }
  int memFactor=mAm.mProcessStats.getMemFactorLocked();
  long now=SystemClock.uptimeMillis();
  if (r.tracker != null) {
    r.tracker.setStarted(false,memFactor,now);
    r.tracker.setBound(false,memFactor,now);
    if (r.executeNesting == 0) {
      r.tracker.clearCurrentOwner(r,false);
      r.tracker=null;
    }
  }
  smap.ensureNotStartingBackground(r);
}
