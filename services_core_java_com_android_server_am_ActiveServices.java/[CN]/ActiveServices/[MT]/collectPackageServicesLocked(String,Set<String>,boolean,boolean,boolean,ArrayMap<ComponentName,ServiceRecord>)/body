{
  boolean didSomething=false;
  for (int i=services.size() - 1; i >= 0; i--) {
    ServiceRecord service=services.valueAt(i);
    final boolean sameComponent=packageName == null || (service.packageName.equals(packageName) && (filterByClasses == null || filterByClasses.contains(service.name.getClassName())));
    if (sameComponent && (service.app == null || evenPersistent || !service.app.persistent)) {
      if (!doit) {
        return true;
      }
      didSomething=true;
      Slog.i(TAG,"  Force stopping service " + service);
      if (service.app != null) {
        service.app.removed=killProcess;
        if (!service.app.persistent) {
          service.app.services.remove(service);
          if (service.whitelistManager) {
            updateWhitelistManagerLocked(service.app);
          }
        }
      }
      service.app=null;
      service.isolatedProc=null;
      if (mTmpCollectionResults == null) {
        mTmpCollectionResults=new ArrayList<>();
      }
      mTmpCollectionResults.add(service);
    }
  }
  return didSomething;
}
