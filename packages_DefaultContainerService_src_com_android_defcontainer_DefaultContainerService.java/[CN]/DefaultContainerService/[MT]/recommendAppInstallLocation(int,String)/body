{
  String status=Environment.getExternalStorageState();
  long availSDSize=-1;
  boolean mediaAvailable=false;
  if (status.equals(Environment.MEDIA_MOUNTED)) {
    StatFs sdStats=new StatFs(Environment.getExternalStorageDirectory().getPath());
    availSDSize=(long)sdStats.getAvailableBlocks() * (long)sdStats.getBlockSize();
    mediaAvailable=true;
  }
  StatFs internalStats=new StatFs(Environment.getDataDirectory().getPath());
  long totalInternalSize=(long)internalStats.getBlockCount() * (long)internalStats.getBlockSize();
  long availInternalSize=(long)internalStats.getAvailableBlocks() * (long)internalStats.getBlockSize();
  double pctNandFree=(double)availInternalSize / (double)totalInternalSize;
  File apkFile=new File(archiveFilePath);
  long pkgLen=apkFile.length();
  boolean auto=true;
  long reqInstallSize=pkgLen;
  long reqInternalSize=0;
  boolean intThresholdOk=(pctNandFree >= LOW_NAND_FLASH_TRESHOLD);
  boolean intAvailOk=((reqInstallSize + reqInternalSize) < availInternalSize);
  boolean fitsOnSd=mediaAvailable && (reqInstallSize < availSDSize) && intThresholdOk&& (reqInternalSize < availInternalSize);
  boolean fitsOnInt=intThresholdOk && intAvailOk;
  boolean installOnlyOnSd=(installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL);
  boolean installOnlyInternal=(installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY);
  if (installOnlyInternal) {
    auto=false;
  }
 else   if (installOnlyOnSd) {
    if (fitsOnSd) {
      auto=false;
    }
  }
 else {
    boolean setInstallLoc=Settings.System.getInt(getApplicationContext().getContentResolver(),Settings.System.SET_INSTALL_LOCATION,0) != 0;
    if (setInstallLoc) {
      int installPreference=Settings.System.getInt(getApplicationContext().getContentResolver(),Settings.System.DEFAULT_INSTALL_LOCATION,PackageHelper.APP_INSTALL_AUTO);
      if (installPreference == PackageHelper.APP_INSTALL_INTERNAL) {
        installOnlyInternal=true;
        auto=false;
      }
 else       if (installPreference == PackageHelper.APP_INSTALL_EXTERNAL) {
        installOnlyOnSd=true;
        auto=false;
      }
    }
  }
  if (!auto) {
    if (installOnlyOnSd) {
      if (fitsOnSd) {
        return PackageHelper.RECOMMEND_INSTALL_EXTERNAL;
      }
      if (!mediaAvailable) {
        return PackageHelper.RECOMMEND_MEDIA_UNAVAILABLE;
      }
      return PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;
    }
 else     if (installOnlyInternal) {
      return fitsOnInt ? PackageHelper.RECOMMEND_INSTALL_INTERNAL : PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;
    }
  }
  if (fitsOnInt) {
    return PackageHelper.RECOMMEND_INSTALL_INTERNAL;
  }
  if (fitsOnSd) {
    return PackageHelper.RECOMMEND_INSTALL_EXTERNAL;
  }
  return PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;
}
