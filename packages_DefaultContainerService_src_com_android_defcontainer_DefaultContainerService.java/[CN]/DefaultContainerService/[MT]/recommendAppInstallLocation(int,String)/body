{
  String status=Environment.getExternalStorageState();
  long availSDSize=-1;
  if (status.equals(Environment.MEDIA_MOUNTED)) {
    StatFs sdStats=new StatFs(Environment.getExternalStorageDirectory().getPath());
    availSDSize=(long)sdStats.getAvailableBlocks() * (long)sdStats.getBlockSize();
  }
  StatFs internalStats=new StatFs(Environment.getDataDirectory().getPath());
  long totalInternalSize=(long)internalStats.getBlockCount() * (long)internalStats.getBlockSize();
  long availInternalSize=(long)internalStats.getAvailableBlocks() * (long)internalStats.getBlockSize();
  double pctNandFree=(double)availInternalSize / (double)totalInternalSize;
  File apkFile=new File(archiveFilePath);
  long pkgLen=apkFile.length();
  boolean auto=true;
  long reqInstallSize=pkgLen;
  long reqInternalSize=0;
  boolean intThresholdOk=(pctNandFree >= LOW_NAND_FLASH_TRESHOLD);
  boolean intAvailOk=((reqInstallSize + reqInternalSize) < availInternalSize);
  boolean fitsOnSd=(reqInstallSize < availSDSize) && intThresholdOk && (reqInternalSize < availInternalSize);
  boolean fitsOnInt=intThresholdOk && intAvailOk;
  boolean installOnlyOnSd=(installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL);
  boolean installOnlyInternal=(installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY);
  if (installOnlyInternal) {
    auto=false;
  }
 else   if (installOnlyOnSd) {
    if (fitsOnSd) {
      auto=false;
    }
  }
 else {
    boolean setInstallLoc=Settings.System.getInt(getApplicationContext().getContentResolver(),Settings.System.SET_INSTALL_LOCATION,0) != 0;
    if (setInstallLoc) {
      int installPreference=Settings.System.getInt(getApplicationContext().getContentResolver(),Settings.System.DEFAULT_INSTALL_LOCATION,PackageInfo.INSTALL_LOCATION_AUTO);
      if (installPreference == 1) {
        installOnlyInternal=true;
        auto=false;
      }
 else       if (installPreference == 2) {
        installOnlyOnSd=true;
        auto=false;
      }
    }
  }
  if (!auto) {
    if (installOnlyOnSd) {
      return fitsOnSd ? PackageManager.INSTALL_EXTERNAL : ERR_LOC;
    }
 else     if (installOnlyInternal) {
      return fitsOnInt ? 0 : ERR_LOC;
    }
  }
  if (fitsOnInt) {
    return 0;
  }
  if (fitsOnSd) {
    return PackageManager.INSTALL_EXTERNAL;
  }
  return ERR_LOC;
}
