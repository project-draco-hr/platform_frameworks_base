{
  final ArrayList<ShortcutInfo> ret=new ArrayList<>();
  final int cloneFlag=((queryFlags & ShortcutQuery.FLAG_GET_KEY_FIELDS_ONLY) == 0) ? ShortcutInfo.CLONE_REMOVE_FOR_LAUNCHER : ShortcutInfo.CLONE_REMOVE_NON_KEY_INFO;
  if (packageName == null) {
    shortcutIds=null;
  }
synchronized (mLock) {
    getLauncherShortcutsLocked(callingPackage,userId,launcherUserId).attemptToRestoreIfNeededAndSave(ShortcutService.this);
    if (packageName != null) {
      getShortcutsInnerLocked(launcherUserId,callingPackage,packageName,shortcutIds,changedSince,componentName,queryFlags,userId,ret,cloneFlag);
    }
 else {
      final ArrayMap<String,ShortcutPackage> packages=getUserShortcutsLocked(userId).getAllPackages();
      for (int i=packages.size() - 1; i >= 0; i--) {
        getShortcutsInnerLocked(launcherUserId,callingPackage,packages.keyAt(i),shortcutIds,changedSince,componentName,queryFlags,userId,ret,cloneFlag);
      }
    }
  }
  return ret;
}
