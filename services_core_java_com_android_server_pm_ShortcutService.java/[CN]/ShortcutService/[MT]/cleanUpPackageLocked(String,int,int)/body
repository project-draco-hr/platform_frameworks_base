{
  if (isPackageInstalled(packageName,packageUserId)) {
    wtf("Package " + packageName + " is still installed for user "+ packageUserId);
    return;
  }
  final boolean wasUserLoaded=isUserLoadedLocked(owningUserId);
  final ShortcutUser mUser=getUserShortcutsLocked(owningUserId);
  boolean doNotify=false;
  if (packageUserId == owningUserId) {
    if (mUser.removePackage(packageName) != null) {
      doNotify=true;
    }
  }
  mUser.removeLauncher(packageUserId,packageName);
  final ArrayMap<PackageWithUser,ShortcutLauncher> launchers=mUser.getAllLaunchers();
  for (int i=launchers.size() - 1; i >= 0; i--) {
    launchers.valueAt(i).cleanUpPackage(packageName,packageUserId);
  }
  for (int i=mUser.getAllPackages().size() - 1; i >= 0; i--) {
    mUser.getAllPackages().valueAt(i).refreshPinnedFlags(this);
  }
  scheduleSaveUser(owningUserId);
  if (doNotify) {
    notifyListeners(packageName,owningUserId);
  }
  if (!wasUserLoaded) {
    unloadUserLocked(owningUserId);
  }
}
