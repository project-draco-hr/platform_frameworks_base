{
  if (DEBUG) {
    Slog.d(TAG,"cleanupGonePackages() userId=" + userId);
  }
  ArrayList<PackageWithUser> gonePackages=null;
synchronized (mLock) {
    final ShortcutUser user=getUserShortcutsLocked(userId);
    final ArrayMap<PackageWithUser,ShortcutPackageInfo> infos=user.getAllPackageInfos();
    for (int i=infos.size() - 1; i >= 0; i--) {
      final ShortcutPackageInfo info=infos.valueAt(i);
      if (info.isShadow()) {
        continue;
      }
      if (isPackageInstalled(info.getPackageName(),info.getUserId())) {
        continue;
      }
      gonePackages=ArrayUtils.add(gonePackages,PackageWithUser.of(info.getUserId(),info.getPackageName()));
    }
    if (gonePackages != null) {
      for (int i=gonePackages.size() - 1; i >= 0; i--) {
        final PackageWithUser pu=gonePackages.get(i);
        cleanUpPackageLocked(pu.packageName,userId,pu.userId);
      }
    }
  }
}
