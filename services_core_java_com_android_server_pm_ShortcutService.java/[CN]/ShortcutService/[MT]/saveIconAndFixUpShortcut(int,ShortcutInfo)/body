{
  if (shortcut.hasIconFile() || shortcut.hasIconResource()) {
    return;
  }
  final long token=injectClearCallingIdentity();
  try {
    shortcut.setIconResourceId(0);
    shortcut.setBitmapPath(null);
    final Icon icon=shortcut.getIcon();
    if (icon == null) {
      return;
    }
    Bitmap bitmap=null;
    try {
switch (icon.getType()) {
case Icon.TYPE_RESOURCE:
{
          injectValidateIconResPackage(shortcut,icon);
          shortcut.setIconResourceId(icon.getResId());
          shortcut.addFlags(ShortcutInfo.FLAG_HAS_ICON_RES);
          return;
        }
case Icon.TYPE_BITMAP:
{
        bitmap=icon.getBitmap();
        break;
      }
case Icon.TYPE_URI:
{
      final Uri uri=ContentProvider.maybeAddUserId(icon.getUri(),userId);
      try (InputStream is=mContext.getContentResolver().openInputStream(uri)){
        bitmap=BitmapFactory.decodeStream(is);
      }
 catch (      IOException e) {
        Slog.e(TAG,"Unable to load icon from " + uri);
        return;
      }
      break;
    }
default :
  throw ShortcutInfo.getInvalidIconException();
}
if (bitmap == null) {
Slog.e(TAG,"Null bitmap detected");
return;
}
File path=null;
try {
final FileOutputStreamWithPath out=openIconFileForWrite(userId,shortcut);
try {
  path=out.getFile();
  shrinkBitmap(bitmap,mMaxIconDimension).compress(mIconPersistFormat,mIconPersistQuality,out);
  shortcut.setBitmapPath(out.getFile().getAbsolutePath());
  shortcut.addFlags(ShortcutInfo.FLAG_HAS_ICON_FILE);
}
  finally {
  IoUtils.closeQuietly(out);
}
}
 catch (IOException|RuntimeException e) {
Slog.wtf(ShortcutService.TAG,"Unable to write bitmap to file",e);
if (path != null && path.exists()) {
  path.delete();
}
}
}
  finally {
if (bitmap != null) {
bitmap.recycle();
}
shortcut.clearIcon();
}
}
  finally {
injectRestoreCallingIdentity(token);
}
}
