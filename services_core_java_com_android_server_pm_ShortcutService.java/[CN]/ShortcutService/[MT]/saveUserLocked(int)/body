{
  final File path=new File(injectUserDataPath(userId),FILENAME_USER_PACKAGES);
  if (DEBUG) {
    Slog.i(TAG,"Saving to " + path);
  }
  path.mkdirs();
  final AtomicFile file=new AtomicFile(path);
  FileOutputStream outs=null;
  try {
    outs=file.startWrite();
    XmlSerializer out=new FastXmlSerializer();
    out.setOutput(outs,StandardCharsets.UTF_8.name());
    out.startDocument(null,true);
    out.startTag(null,TAG_ROOT);
    final ArrayMap<String,PackageShortcuts> packages=getUserShortcutsLocked(userId);
    for (int i=0; i < packages.size(); i++) {
      final String packageName=packages.keyAt(i);
      final PackageShortcuts shortcuts=packages.valueAt(i);
      out.startTag(null,"package");
      writeAttr(out,"name",packageName);
      writeAttr(out,"dynamic-count",shortcuts.mDynamicShortcutCount);
      writeAttr(out,"call-count",shortcuts.mApiCallCountInner);
      writeAttr(out,"last-reset",shortcuts.mLastResetTime);
      final int size=shortcuts.getShortcuts().size();
      for (int j=0; j < size; j++) {
        saveShortcut(out,shortcuts.getShortcuts().valueAt(j));
      }
      out.endTag(null,"package");
    }
    out.endTag(null,TAG_ROOT);
    out.endDocument();
    file.finishWrite(outs);
  }
 catch (  IOException|XmlPullParserException e) {
    Slog.e(TAG,"Failed to write to file " + file.getBaseFile(),e);
    file.failWrite(outs);
  }
}
