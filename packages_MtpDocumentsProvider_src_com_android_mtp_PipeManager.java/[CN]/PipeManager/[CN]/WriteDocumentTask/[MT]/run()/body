{
  File tempFile=null;
  try {
    tempFile=File.createTempFile("mtp","tmp",mContext.getCacheDir());
    try (final FileOutputStream tempOutputStream=new ParcelFileDescriptor.AutoCloseOutputStream(ParcelFileDescriptor.open(tempFile,ParcelFileDescriptor.MODE_WRITE_ONLY));final ParcelFileDescriptor.AutoCloseInputStream inputStream=new ParcelFileDescriptor.AutoCloseInputStream(mDescriptors[0])){
      final byte[] buffer=new byte[32 * 1024];
      int bytes;
      while ((bytes=inputStream.read(buffer)) != -1) {
        mDescriptors[0].checkError();
        tempOutputStream.write(buffer,0,bytes);
      }
      tempOutputStream.flush();
    }
     final MtpObjectInfo placeholderObjectInfo=mManager.getObjectInfo(mIdentifier.mDeviceId,mIdentifier.mObjectHandle);
    mManager.deleteDocument(mIdentifier.mDeviceId,mIdentifier.mObjectHandle);
    final MtpObjectInfo targetObjectInfo=new MtpObjectInfo.Builder(placeholderObjectInfo).setCompressedSize(tempFile.length()).build();
    final ParcelFileDescriptor tempInputDescriptor=ParcelFileDescriptor.open(tempFile,ParcelFileDescriptor.MODE_READ_ONLY);
    final int newObjectHandle=mManager.createDocument(mIdentifier.mDeviceId,targetObjectInfo,tempInputDescriptor);
    final MtpObjectInfo newObjectInfo=mManager.getObjectInfo(mIdentifier.mDeviceId,newObjectHandle);
    final Identifier parentIdentifier=mDatabase.getParentIdentifier(mIdentifier.mDocumentId);
    mDatabase.updateObject(mIdentifier.mDocumentId,mIdentifier.mDeviceId,parentIdentifier.mDocumentId,mOperationsSupported,newObjectInfo,tempFile.length());
  }
 catch (  IOException error) {
    Log.w(MtpDocumentsProvider.TAG,"Failed to send a file because of: " + error.getMessage());
  }
 finally {
    if (tempFile != null) {
      tempFile.delete();
    }
  }
}
