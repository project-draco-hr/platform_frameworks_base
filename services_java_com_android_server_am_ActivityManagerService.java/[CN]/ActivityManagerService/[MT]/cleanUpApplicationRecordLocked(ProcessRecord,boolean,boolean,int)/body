{
  if (index >= 0) {
    mLruProcesses.remove(index);
  }
  mProcessesToGc.remove(app);
  if (app.crashDialog != null) {
    app.crashDialog.dismiss();
    app.crashDialog=null;
  }
  if (app.anrDialog != null) {
    app.anrDialog.dismiss();
    app.anrDialog=null;
  }
  if (app.waitDialog != null) {
    app.waitDialog.dismiss();
    app.waitDialog=null;
  }
  app.crashing=false;
  app.notResponding=false;
  app.resetPackageList();
  app.unlinkDeathRecipient();
  app.thread=null;
  app.forcingToForeground=null;
  app.foregroundServices=false;
  app.foregroundActivities=false;
  app.hasShownUi=false;
  app.hasAboveClient=false;
  mServices.killServicesLocked(app,allowRestart);
  boolean restart=false;
  if (!app.pubProviders.isEmpty()) {
    Iterator<ContentProviderRecord> it=app.pubProviders.values().iterator();
    while (it.hasNext()) {
      ContentProviderRecord cpr=it.next();
      final boolean always=app.bad || !allowRestart;
      if (removeDyingProviderLocked(app,cpr,always) || always) {
        restart=true;
      }
      cpr.provider=null;
      cpr.proc=null;
    }
    app.pubProviders.clear();
  }
  if (checkAppInLaunchingProvidersLocked(app,false)) {
    restart=true;
  }
  if (!app.conProviders.isEmpty()) {
    for (int i=0; i < app.conProviders.size(); i++) {
      ContentProviderConnection conn=app.conProviders.get(i);
      conn.provider.connections.remove(conn);
    }
    app.conProviders.clear();
  }
  if (false) {
    for (int i=0; i < mLaunchingProviders.size(); i++) {
      ContentProviderRecord cpr=(ContentProviderRecord)mLaunchingProviders.get(i);
      if (cpr.connections.size() <= 0 && !cpr.hasExternalProcessHandles()) {
synchronized (cpr) {
          cpr.launchingApp=null;
          cpr.notifyAll();
        }
      }
    }
  }
  skipCurrentReceiverLocked(app);
  if (app.receivers.size() > 0) {
    Iterator<ReceiverList> it=app.receivers.iterator();
    while (it.hasNext()) {
      removeReceiverLocked(it.next());
    }
    app.receivers.clear();
  }
  if (mBackupTarget != null && app.pid == mBackupTarget.app.pid) {
    if (DEBUG_BACKUP)     Slog.d(TAG,"App " + mBackupTarget.appInfo + " died during backup");
    try {
      IBackupManager bm=IBackupManager.Stub.asInterface(ServiceManager.getService(Context.BACKUP_SERVICE));
      bm.agentDisconnected(app.info.packageName);
    }
 catch (    RemoteException e) {
    }
  }
  for (int i=mPendingProcessChanges.size() - 1; i >= 0; i--) {
    ProcessChangeItem item=mPendingProcessChanges.get(i);
    if (item.pid == app.pid) {
      mPendingProcessChanges.remove(i);
      mAvailProcessChanges.add(item);
    }
  }
  mHandler.obtainMessage(DISPATCH_PROCESS_DIED,app.pid,app.info.uid,null).sendToTarget();
  if (restarting) {
    return;
  }
  if (!app.persistent || app.isolated) {
    if (DEBUG_PROCESSES)     Slog.v(TAG,"Removing non-persistent process during cleanup: " + app);
    mProcessNames.remove(app.processName,app.uid);
    mIsolatedProcesses.remove(app.uid);
    if (mHeavyWeightProcess == app) {
      mHandler.sendMessage(mHandler.obtainMessage(CANCEL_HEAVY_NOTIFICATION_MSG,mHeavyWeightProcess.userId,0));
      mHeavyWeightProcess=null;
    }
  }
 else   if (!app.removed) {
    if (mPersistentStartingProcesses.indexOf(app) < 0) {
      mPersistentStartingProcesses.add(app);
      restart=true;
    }
  }
  if (DEBUG_PROCESSES && mProcessesOnHold.contains(app))   Slog.v(TAG,"Clean-up removing on hold: " + app);
  mProcessesOnHold.remove(app);
  if (app == mHomeProcess) {
    mHomeProcess=null;
  }
  if (app == mPreviousProcess) {
    mPreviousProcess=null;
  }
  if (restart && !app.isolated) {
    mProcessNames.put(app.processName,app.uid,app);
    startProcessLocked(app,"restart",app.processName);
  }
 else   if (app.pid > 0 && app.pid != MY_PID) {
synchronized (mPidsSelfLocked) {
      mPidsSelfLocked.remove(app.pid);
      mHandler.removeMessages(PROC_START_TIMEOUT_MSG,app);
    }
    app.setPid(0);
  }
}
