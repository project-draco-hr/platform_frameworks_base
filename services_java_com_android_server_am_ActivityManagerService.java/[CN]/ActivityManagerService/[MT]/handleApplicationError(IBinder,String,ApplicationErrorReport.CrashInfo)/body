{
  AppErrorResult result=new AppErrorResult();
  ProcessRecord r=null;
  long timeMillis=System.currentTimeMillis();
  String shortMsg=crashInfo.exceptionClassName;
  String longMsg=crashInfo.exceptionMessage;
  String stackTrace=crashInfo.stackTrace;
  if (shortMsg != null && longMsg != null) {
    longMsg=shortMsg + ": " + longMsg;
  }
 else   if (shortMsg != null) {
    longMsg=shortMsg;
  }
synchronized (this) {
    if (app != null) {
      for (      SparseArray<ProcessRecord> apps : mProcessNames.getMap().values()) {
        final int NA=apps.size();
        for (int ia=0; ia < NA; ia++) {
          ProcessRecord p=apps.valueAt(ia);
          if (p.thread != null && p.thread.asBinder() == app) {
            r=p;
            break;
          }
        }
      }
    }
    if (r != null) {
      Process.sendSignal(r.pid,Process.SIGNAL_QUIT);
    }
    if (mController != null) {
      try {
        String name=r != null ? r.processName : null;
        int pid=r != null ? r.pid : Binder.getCallingPid();
        if (!mController.appCrashed(name,pid,tag,shortMsg,longMsg,timeMillis,crashInfo.stackTrace)) {
          Log.w(TAG,"Force-killing crashed app " + name + " at watcher's request");
          Process.killProcess(pid);
          return;
        }
      }
 catch (      RemoteException e) {
        mController=null;
      }
    }
    final long origId=Binder.clearCallingIdentity();
    if (r != null && r.instrumentationClass != null) {
      Log.w(TAG,"Error in app " + r.processName + " running instrumentation "+ r.instrumentationClass+ ":");
      if (shortMsg != null)       Log.w(TAG,"  " + shortMsg);
      if (longMsg != null)       Log.w(TAG,"  " + longMsg);
      Bundle info=new Bundle();
      info.putString("shortMsg",shortMsg);
      info.putString("longMsg",longMsg);
      finishInstrumentationLocked(r,Activity.RESULT_CANCELED,info);
      Binder.restoreCallingIdentity(origId);
      return;
    }
    if (r != null) {
      if (!makeAppCrashingLocked(r,tag,shortMsg,longMsg,stackTrace)) {
        return;
      }
    }
 else {
      Log.w(TAG,"Some application object " + app + " tag "+ tag+ " has crashed, but I don't know who it is.");
      Log.w(TAG,"ShortMsg:" + shortMsg);
      Log.w(TAG,"LongMsg:" + longMsg);
      Binder.restoreCallingIdentity(origId);
      return;
    }
    Message msg=Message.obtain();
    msg.what=SHOW_ERROR_MSG;
    HashMap data=new HashMap();
    data.put("result",result);
    data.put("app",r);
    msg.obj=data;
    mHandler.sendMessage(msg);
    Binder.restoreCallingIdentity(origId);
  }
  int res=result.get();
  Intent appErrorIntent=null;
synchronized (this) {
    if (r != null) {
      mProcessCrashTimes.put(r.info.processName,r.info.uid,SystemClock.uptimeMillis());
    }
    if (res == AppErrorDialog.FORCE_QUIT_AND_REPORT) {
      appErrorIntent=createAppErrorIntentLocked(r,timeMillis,crashInfo);
    }
  }
  if (appErrorIntent != null) {
    try {
      mContext.startActivity(appErrorIntent);
    }
 catch (    ActivityNotFoundException e) {
      Log.w(TAG,"bug report receiver dissappeared",e);
    }
  }
}
