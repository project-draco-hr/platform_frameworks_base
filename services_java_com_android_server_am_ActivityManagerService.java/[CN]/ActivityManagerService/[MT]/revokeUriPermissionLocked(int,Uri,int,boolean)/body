{
  if (DEBUG_URI_PERMISSION)   Slog.v(TAG,"Revoking all granted permissions to " + uri);
  final IPackageManager pm=AppGlobals.getPackageManager();
  final String authority=uri.getAuthority();
  final ProviderInfo pi=getProviderInfoLocked(authority,UserHandle.getUserId(callingUid));
  if (pi == null) {
    Slog.w(TAG,"No content provider found for permission revoke: " + uri.toSafeString());
    return;
  }
  if (!checkHoldingPermissionsLocked(pm,pi,uri,callingUid,modeFlags)) {
    throw new SecurityException("Uid " + callingUid + " does not have permission to uri "+ uri);
  }
  boolean persistChanged=false;
  final List<String> SEGMENTS=uri.getPathSegments();
  if (SEGMENTS != null) {
    final int NS=SEGMENTS.size();
    int N=mGrantedUriPermissions.size();
    for (int i=0; i < N; i++) {
      HashMap<Uri,UriPermission> perms=mGrantedUriPermissions.valueAt(i);
      Iterator<UriPermission> it=perms.values().iterator();
      toploop:       while (it.hasNext()) {
        UriPermission perm=it.next();
        Uri targetUri=perm.uri;
        if (!authority.equals(targetUri.getAuthority())) {
          continue;
        }
        List<String> targetSegments=targetUri.getPathSegments();
        if (targetSegments == null) {
          continue;
        }
        if (targetSegments.size() < NS) {
          continue;
        }
        for (int j=0; j < NS; j++) {
          if (!SEGMENTS.get(j).equals(targetSegments.get(j))) {
            continue toploop;
          }
        }
        if (DEBUG_URI_PERMISSION)         Slog.v(TAG,"Revoking " + perm.targetUid + " permission to "+ perm.uri);
        persistChanged|=perm.clearModes(modeFlags,persist);
        if (perm.modeFlags == 0) {
          it.remove();
        }
      }
      if (perms.size() == 0) {
        mGrantedUriPermissions.remove(mGrantedUriPermissions.keyAt(i));
        N--;
        i--;
      }
    }
  }
  if (persistChanged) {
    mHandler.removeMessages(PERSIST_URI_GRANTS);
    mHandler.obtainMessage(PERSIST_URI_GRANTS).sendToTarget();
  }
}
