{
  cleanUpApplicationRecordLocked(app,restarting,allowRestart,-1);
  if (!restarting) {
    mLruProcesses.remove(app);
  }
  if (mProfileProc == app) {
    clearProfilerLocked();
  }
  final int numStacks=mStacks.size();
  for (int stackNdx=0; stackNdx < numStacks; ++stackNdx) {
    final ActivityStack stack=mStacks.get(stackNdx);
    if (stack.mPausingActivity != null && stack.mPausingActivity.app == app) {
      if (DEBUG_PAUSE || DEBUG_CLEANUP)       Slog.v(TAG,"App died while pausing: " + stack.mPausingActivity);
      stack.mPausingActivity=null;
    }
    if (stack.mLastPausedActivity != null && stack.mLastPausedActivity.app == app) {
      stack.mLastPausedActivity=null;
    }
    boolean hasVisibleActivities=stack.removeHistoryRecordsForAppLocked(app);
    if (!restarting) {
      if (!stack.resumeTopActivityLocked(null)) {
        if (hasVisibleActivities) {
          stack.ensureActivitiesVisibleLocked(null,0);
        }
      }
    }
  }
  app.activities.clear();
  if (app.instrumentationClass != null) {
    Slog.w(TAG,"Crash of app " + app.processName + " running instrumentation "+ app.instrumentationClass);
    Bundle info=new Bundle();
    info.putString("shortMsg","Process crashed.");
    finishInstrumentationLocked(app,Activity.RESULT_CANCELED,info);
  }
}
