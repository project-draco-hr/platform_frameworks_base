{
  cleanUpApplicationRecordLocked(app,restarting,allowRestart,-1);
  if (!restarting) {
    mLruProcesses.remove(app);
  }
  if (mProfileProc == app) {
    clearProfilerLocked();
  }
  if (mMainStack.mPausingActivity != null && mMainStack.mPausingActivity.app == app) {
    if (DEBUG_PAUSE || DEBUG_CLEANUP)     Slog.v(TAG,"App died while pausing: " + mMainStack.mPausingActivity);
    mMainStack.mPausingActivity=null;
  }
  if (mMainStack.mLastPausedActivity != null && mMainStack.mLastPausedActivity.app == app) {
    mMainStack.mLastPausedActivity=null;
  }
  boolean hasVisibleActivities=mMainStack.removeHistoryRecordsForAppLocked(app);
  app.activities.clear();
  if (app.instrumentationClass != null) {
    Slog.w(TAG,"Crash of app " + app.processName + " running instrumentation "+ app.instrumentationClass);
    Bundle info=new Bundle();
    info.putString("shortMsg","Process crashed.");
    finishInstrumentationLocked(app,Activity.RESULT_CANCELED,info);
  }
  if (!restarting) {
    if (!mMainStack.resumeTopActivityLocked(null)) {
      if (hasVisibleActivities) {
        mMainStack.ensureActivitiesVisibleLocked(null,0);
      }
    }
  }
}
