{
  final boolean killProcesses=(flags & ActivityManager.REMOVE_TASK_KILL_PROCESS) != 0;
  Intent baseIntent=new Intent(tr.intent != null ? tr.intent : tr.affinityIntent);
  ComponentName component=baseIntent.getComponent();
  if (component == null) {
    Slog.w(TAG,"Now component for base intent of task: " + tr);
    return;
  }
  ArrayList<ServiceRecord> services=new ArrayList<ServiceRecord>();
  for (  ServiceRecord sr : mServiceMap.getAllServices(tr.userId)) {
    if (sr.packageName.equals(component.getPackageName())) {
      services.add(sr);
    }
  }
  for (int i=0; i < services.size(); i++) {
    ServiceRecord sr=services.get(i);
    if (sr.startRequested) {
      if ((sr.serviceInfo.flags & ServiceInfo.FLAG_STOP_WITH_TASK) != 0) {
        Slog.i(TAG,"Stopping service " + sr.shortName + ": remove task");
        stopServiceLocked(sr);
      }
 else {
        sr.pendingStarts.add(new ServiceRecord.StartItem(sr,true,sr.makeNextStartId(),baseIntent,null));
        if (sr.app != null && sr.app.thread != null) {
          sendServiceArgsLocked(sr,false);
        }
      }
    }
  }
  if (killProcesses) {
    final String pkg=component.getPackageName();
    ArrayList<ProcessRecord> procs=new ArrayList<ProcessRecord>();
    HashMap<String,SparseArray<ProcessRecord>> pmap=mProcessNames.getMap();
    for (    SparseArray<ProcessRecord> uids : pmap.values()) {
      for (int i=0; i < uids.size(); i++) {
        ProcessRecord proc=uids.valueAt(i);
        if (proc.userId != tr.userId) {
          continue;
        }
        if (!proc.pkgList.contains(pkg)) {
          continue;
        }
        procs.add(proc);
      }
    }
    for (int i=0; i < procs.size(); i++) {
      ProcessRecord pr=procs.get(i);
      if (pr.setSchedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE) {
        Slog.i(TAG,"Killing " + pr.toShortString() + ": remove task");
        EventLog.writeEvent(EventLogTags.AM_KILL,pr.pid,pr.processName,pr.setAdj,"remove task");
        pr.killedBackground=true;
        Process.killProcessQuiet(pr.pid);
      }
 else {
        pr.waitingToKill="remove task";
      }
    }
  }
}
