{
synchronized (this) {
    enforceCallingPermission(android.Manifest.permission.READ_FRAME_BUFFER,"getTaskThumbnail()");
    ActivityRecord resumed=mMainStack.mResumedActivity;
    final int N=mRecentTasks.size();
    for (int i=0; i < N; i++) {
      TaskRecord tr=mRecentTasks.get(i);
      if (tr.taskId == id) {
        final ActivityManager.TaskThumbnails thumbs=new ActivityManager.TaskThumbnails();
        if (resumed != null && resumed.thumbHolder == tr) {
          thumbs.mainThumbnail=resumed.stack.screenshotActivities(resumed);
        }
 else {
          thumbs.mainThumbnail=tr.lastThumbnail;
        }
        final int NA=mMainStack.mHistory.size();
        int j=0;
        ThumbnailHolder holder=null;
        while (j < NA) {
          ActivityRecord ar=(ActivityRecord)mMainStack.mHistory.get(j);
          j++;
          if (ar.task == tr) {
            holder=ar.thumbHolder;
            break;
          }
        }
        ArrayList<Bitmap> bitmaps=new ArrayList<Bitmap>();
        thumbs.otherThumbnails=bitmaps;
        ActivityRecord lastActivity=null;
        while (j < NA) {
          ActivityRecord ar=(ActivityRecord)mMainStack.mHistory.get(j);
          j++;
          if (ar.task != tr) {
            break;
          }
          lastActivity=ar;
          if (ar.thumbHolder != holder && holder != null) {
            thumbs.numSubThumbbails++;
            holder=ar.thumbHolder;
            bitmaps.add(holder.lastThumbnail);
          }
        }
        if (lastActivity != null && bitmaps.size() > 0) {
          if (resumed == lastActivity) {
            Bitmap bm=lastActivity.stack.screenshotActivities(lastActivity);
            if (bm != null) {
              bitmaps.remove(bitmaps.size() - 1);
              bitmaps.add(bm);
            }
          }
        }
        if (thumbs.numSubThumbbails > 0) {
          thumbs.retriever=new IThumbnailRetriever.Stub(){
            public Bitmap getThumbnail(            int index){
              if (index < 0 || index >= thumbs.otherThumbnails.size()) {
                return null;
              }
              return thumbs.otherThumbnails.get(index);
            }
          }
;
        }
        return thumbs;
      }
    }
  }
  return null;
}
