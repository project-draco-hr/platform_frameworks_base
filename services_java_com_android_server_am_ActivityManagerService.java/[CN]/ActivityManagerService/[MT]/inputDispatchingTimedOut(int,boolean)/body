{
  if (checkCallingPermission(android.Manifest.permission.FILTER_EVENTS) != PackageManager.PERMISSION_GRANTED) {
    throw new SecurityException("Requires permission " + android.Manifest.permission.FILTER_EVENTS);
  }
  ProcessRecord proc;
synchronized (this) {
synchronized (mPidsSelfLocked) {
      proc=mPidsSelfLocked.get(pid);
    }
    if (proc != null) {
      if (proc.debugging) {
        return -1;
      }
      if (mDidDexOpt) {
        mDidDexOpt=false;
        return -1;
      }
      if (proc.instrumentationClass != null) {
        Bundle info=new Bundle();
        info.putString("shortMsg","keyDispatchingTimedOut");
        info.putString("longMsg","Timed out while dispatching key event");
        finishInstrumentationLocked(proc,Activity.RESULT_CANCELED,info);
        proc=null;
      }
    }
  }
  if (proc != null) {
    final ProcessRecord pr=proc;
    mHandler.post(new Runnable(){
      @Override public void run(){
        appNotResponding(pr,null,null,aboveSystem,"keyDispatchingTimedOut");
      }
    }
);
    if (proc.instrumentationClass != null || proc.usingWrapper) {
      return INSTRUMENTATION_KEY_DISPATCHING_TIMEOUT;
    }
  }
  return KEY_DISPATCHING_TIMEOUT;
}
