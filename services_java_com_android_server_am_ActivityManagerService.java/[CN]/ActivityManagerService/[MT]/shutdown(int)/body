{
  if (checkCallingPermission(android.Manifest.permission.SHUTDOWN) != PackageManager.PERMISSION_GRANTED) {
    throw new SecurityException("Requires permission " + android.Manifest.permission.SHUTDOWN);
  }
  boolean timedout=false;
synchronized (this) {
    mShuttingDown=true;
    mWindowManager.setEventDispatching(false);
    if (mResumedActivity != null) {
      pauseIfSleepingLocked();
      final long endTime=System.currentTimeMillis() + timeout;
      while (mResumedActivity != null || mPausingActivity != null) {
        long delay=endTime - System.currentTimeMillis();
        if (delay <= 0) {
          Log.w(TAG,"Activity manager shutdown timed out");
          timedout=true;
          break;
        }
        try {
          this.wait();
        }
 catch (        InterruptedException e) {
        }
      }
    }
  }
  mUsageStatsService.shutdown();
  mBatteryStatsService.shutdown();
  return timedout;
}
