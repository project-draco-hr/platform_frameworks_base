{
  HistoryRecord prev=mPausingActivity;
  if (DEBUG_PAUSE)   Log.v(TAG,"Complete pause: " + prev);
  if (prev != null) {
    if (prev.finishing) {
      if (DEBUG_PAUSE)       Log.v(TAG,"Executing finish of activity: " + prev);
      prev=finishCurrentActivityLocked(prev,FINISH_AFTER_VISIBLE);
    }
 else     if (prev.app != null) {
      if (DEBUG_PAUSE)       Log.v(TAG,"Enqueueing pending stop: " + prev);
      if (prev.waitingVisible) {
        prev.waitingVisible=false;
        mWaitingVisibleActivities.remove(prev);
        if (DEBUG_SWITCH || DEBUG_PAUSE)         Log.v(TAG,"Complete pause, no longer waiting: " + prev);
      }
      if (prev.configDestroy) {
        if (DEBUG_PAUSE)         Log.v(TAG,"Destroying after pause: " + prev);
        destroyActivityLocked(prev,true);
      }
 else {
        mStoppingActivities.add(prev);
        if (mStoppingActivities.size() > 3) {
          if (DEBUG_PAUSE)           Log.v(TAG,"To many pending stops, forcing idle");
          Message msg=Message.obtain();
          msg.what=ActivityManagerService.IDLE_NOW_MSG;
          mHandler.sendMessage(msg);
        }
      }
    }
 else {
      if (DEBUG_PAUSE)       Log.v(TAG,"App died during pause, not stopping: " + prev);
      prev=null;
    }
    mPausingActivity=null;
  }
  if (!mSleeping) {
    resumeTopActivityLocked(prev);
  }
 else {
    if (mGoingToSleep.isHeld()) {
      mGoingToSleep.release();
    }
  }
  if (prev != null) {
    prev.resumeKeyDispatchingLocked();
  }
}
