{
  final int callingUserId=UserHandle.getUserId(callingUid);
  if (callingUserId != userId) {
    if (callingUid != 0 && callingUid != Process.SYSTEM_UID) {
      if ((requireFull || checkComponentPermission(android.Manifest.permission.INTERACT_ACROSS_USERS,callingPid,callingUid,-1,true) != PackageManager.PERMISSION_GRANTED) && checkComponentPermission(android.Manifest.permission.INTERACT_ACROSS_USERS_FULL,callingPid,callingUid,-1,true) != PackageManager.PERMISSION_GRANTED) {
        if (userId == UserHandle.USER_CURRENT_OR_SELF) {
          userId=callingUserId;
        }
 else {
          StringBuilder builder=new StringBuilder(128);
          builder.append("Permission Denial: ");
          builder.append(name);
          if (callerPackage != null) {
            builder.append(" from ");
            builder.append(callerPackage);
          }
          builder.append(" asks to run as user ");
          builder.append(userId);
          builder.append(" but is calling from user ");
          builder.append(UserHandle.getUserId(callingUid));
          builder.append("; this requires ");
          builder.append(android.Manifest.permission.INTERACT_ACROSS_USERS_FULL);
          if (!requireFull) {
            builder.append("or");
            builder.append(android.Manifest.permission.INTERACT_ACROSS_USERS);
          }
          String msg=builder.toString();
          Slog.w(TAG,msg);
          throw new SecurityException(msg);
        }
      }
    }
    if (userId == UserHandle.USER_CURRENT || userId == UserHandle.USER_CURRENT_OR_SELF) {
      userId=mCurrentUserId;
    }
    if (!allowAll && userId < 0) {
      throw new IllegalArgumentException("Call does not support special user #" + userId);
    }
  }
  return userId;
}
