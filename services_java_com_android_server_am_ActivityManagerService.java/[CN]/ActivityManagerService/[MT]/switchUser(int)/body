{
  final int callingUid=Binder.getCallingUid();
  if (callingUid != 0 && callingUid != Process.myUid()) {
    Slog.e(TAG,"Trying to switch user from unauthorized app");
    return false;
  }
  if (mCurrentUserId == userId)   return true;
synchronized (this) {
    if (mLoggedInUsers.indexOfKey(userId) < 0) {
      if (!userExists(userId)) {
        return false;
      }
      mLoggedInUsers.append(userId,userId);
    }
    mCurrentUserId=userId;
    boolean haveActivities=mMainStack.switchUser(userId);
    if (!haveActivities) {
      startHomeActivityLocked(userId);
    }
  }
  Intent addedIntent=new Intent(Intent.ACTION_USER_SWITCHED);
  addedIntent.putExtra(Intent.EXTRA_USER_HANDLE,userId);
  mContext.sendBroadcast(addedIntent,android.Manifest.permission.MANAGE_USERS);
  return true;
}
