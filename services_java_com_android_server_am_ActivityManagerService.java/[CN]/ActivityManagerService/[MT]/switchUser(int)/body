{
  final int callingUid=Binder.getCallingUid();
  if (callingUid != 0 && callingUid != Process.myUid()) {
    Slog.e(TAG,"Trying to switch user from unauthorized app");
    return false;
  }
  if (mCurrentUserId == userId)   return true;
  ArrayList<UserListener> listeners;
synchronized (this) {
    if (mLoggedInUsers.indexOfKey(userId) < 0) {
      if (!userExists(userId)) {
        return false;
      }
      mLoggedInUsers.append(userId,userId);
    }
    mCurrentUserId=userId;
    boolean haveActivities=mMainStack.switchUser(userId);
    if (!haveActivities) {
      startHomeActivityLocked(userId);
    }
    listeners=(ArrayList<UserListener>)mUserListeners.clone();
  }
  for (  UserListener listener : listeners) {
    listener.onUserChanged(userId);
  }
  return true;
}
