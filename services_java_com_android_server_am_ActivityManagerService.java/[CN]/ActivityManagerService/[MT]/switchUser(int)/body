{
  if (checkCallingPermission(android.Manifest.permission.INTERACT_ACROSS_USERS_FULL) != PackageManager.PERMISSION_GRANTED) {
    String msg="Permission Denial: switchUser() from pid=" + Binder.getCallingPid() + ", uid="+ Binder.getCallingUid()+ " requires "+ android.Manifest.permission.INTERACT_ACROSS_USERS_FULL;
    Slog.w(TAG,msg);
    throw new SecurityException(msg);
  }
  final long ident=Binder.clearCallingIdentity();
  try {
synchronized (this) {
      final int oldUserId=mCurrentUserId;
      if (oldUserId == userId) {
        return true;
      }
      final UserInfo userInfo=getUserManagerLocked().getUserInfo(userId);
      if (userInfo == null) {
        Slog.w(TAG,"No user info for user #" + userId);
        return false;
      }
      mWindowManager.startFreezingScreen(R.anim.screen_user_exit,R.anim.screen_user_enter);
      if (mStartedUsers.get(userId) == null) {
        mStartedUsers.put(userId,new UserStartedState(new UserHandle(userId),false));
        updateStartedUserArrayLocked();
      }
      mCurrentUserId=userId;
      mCurrentUserArray=new int[]{userId};
      final Integer userIdInt=Integer.valueOf(userId);
      mUserLru.remove(userIdInt);
      mUserLru.add(userIdInt);
      mWindowManager.setCurrentUser(userId);
      final UserStartedState uss=mStartedUsers.get(userId);
      mHandler.removeMessages(REPORT_USER_SWITCH_MSG);
      mHandler.removeMessages(USER_SWITCH_TIMEOUT_MSG);
      mHandler.sendMessage(mHandler.obtainMessage(REPORT_USER_SWITCH_MSG,oldUserId,userId,uss));
      mHandler.sendMessageDelayed(mHandler.obtainMessage(USER_SWITCH_TIMEOUT_MSG,oldUserId,userId,uss),USER_SWITCH_TIMEOUT);
      Intent intent=new Intent(Intent.ACTION_USER_STARTED);
      intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY | Intent.FLAG_RECEIVER_FOREGROUND);
      intent.putExtra(Intent.EXTRA_USER_HANDLE,userId);
      broadcastIntentLocked(null,null,intent,null,null,0,null,null,null,false,false,MY_PID,Process.SYSTEM_UID,userId);
      if ((userInfo.flags & UserInfo.FLAG_INITIALIZED) == 0) {
        if (userId != 0) {
          intent=new Intent(Intent.ACTION_USER_INITIALIZE);
          intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);
          broadcastIntentLocked(null,null,intent,null,new IIntentReceiver.Stub(){
            public void performReceive(            Intent intent,            int resultCode,            String data,            Bundle extras,            boolean ordered,            boolean sticky,            int sendingUser){
              userInitialized(uss);
            }
          }
,0,null,null,null,true,false,MY_PID,Process.SYSTEM_UID,userId);
          uss.initializing=true;
        }
 else {
          getUserManagerLocked().makeInitialized(userInfo.id);
        }
      }
      boolean haveActivities=mMainStack.switchUserLocked(userId,uss);
      if (!haveActivities) {
        startHomeActivityLocked(userId);
      }
      getUserManagerLocked().userForeground(userId);
      sendUserSwitchBroadcastsLocked(oldUserId,userId);
    }
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
  return true;
}
