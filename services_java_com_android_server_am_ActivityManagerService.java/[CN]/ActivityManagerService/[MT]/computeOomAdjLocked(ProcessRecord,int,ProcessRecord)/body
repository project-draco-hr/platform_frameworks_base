{
  if (mAdjSeq == app.adjSeq) {
    return app.curAdj;
  }
  if (app.thread == null) {
    app.adjSeq=mAdjSeq;
    return (app.curAdj=EMPTY_APP_ADJ);
  }
  app.isForeground=false;
  int adj;
  int N;
  if (app == TOP_APP || app.instrumentationClass != null || app.persistentActivities > 0) {
    adj=FOREGROUND_APP_ADJ;
    app.isForeground=true;
  }
 else   if (app.curReceiver != null || (mPendingBroadcast != null && mPendingBroadcast.curApp == app)) {
    adj=FOREGROUND_APP_ADJ;
  }
 else   if (app.executingServices.size() > 0) {
    adj=FOREGROUND_APP_ADJ;
  }
 else   if (app.foregroundServices || app.forcingToForeground != null) {
    adj=VISIBLE_APP_ADJ;
  }
 else   if (app == mHomeProcess) {
    adj=HOME_APP_ADJ;
  }
 else   if ((N=app.activities.size()) != 0) {
    adj=hiddenAdj;
    for (int j=0; j < N; j++) {
      if (((HistoryRecord)app.activities.get(j)).visible) {
        adj=VISIBLE_APP_ADJ;
        break;
      }
    }
  }
 else {
    adj=EMPTY_APP_ADJ;
  }
  app.adjSeq=mAdjSeq;
  app.curRawAdj=adj;
  app.curAdj=adj <= app.maxAdj ? adj : app.maxAdj;
  if (mBackupTarget != null && app == mBackupTarget.app) {
    if (adj > BACKUP_APP_ADJ) {
      if (DEBUG_BACKUP)       Log.v(TAG,"oom BACKUP_APP_ADJ for " + app);
      adj=BACKUP_APP_ADJ;
    }
  }
  if (app.services.size() != 0 && adj > FOREGROUND_APP_ADJ) {
    if (adj > hiddenAdj) {
      adj=hiddenAdj;
    }
    final long now=SystemClock.uptimeMillis();
    Iterator jt=app.services.iterator();
    while (jt.hasNext() && adj > FOREGROUND_APP_ADJ) {
      ServiceRecord s=(ServiceRecord)jt.next();
      if (s.startRequested) {
        if (now < (s.lastActivity + MAX_SERVICE_INACTIVITY)) {
          if (adj > SECONDARY_SERVER_ADJ) {
            adj=SECONDARY_SERVER_ADJ;
          }
        }
 else {
          if (adj > hiddenAdj) {
            adj=hiddenAdj;
          }
        }
      }
      if (s.connections.size() > 0 && adj > FOREGROUND_APP_ADJ) {
        Iterator<ConnectionRecord> kt=s.connections.values().iterator();
        while (kt.hasNext() && adj > FOREGROUND_APP_ADJ) {
          ConnectionRecord cr=kt.next();
          if (cr.binding.client == app) {
            continue;
          }
          if ((cr.flags & Context.BIND_AUTO_CREATE) != 0) {
            ProcessRecord client=cr.binding.client;
            int myHiddenAdj=hiddenAdj;
            if (myHiddenAdj > client.hiddenAdj) {
              if (client.hiddenAdj > VISIBLE_APP_ADJ) {
                myHiddenAdj=client.hiddenAdj;
              }
 else {
                myHiddenAdj=VISIBLE_APP_ADJ;
              }
            }
            int clientAdj=computeOomAdjLocked(client,myHiddenAdj,TOP_APP);
            if (adj > clientAdj) {
              adj=clientAdj > VISIBLE_APP_ADJ ? clientAdj : VISIBLE_APP_ADJ;
            }
          }
          HistoryRecord a=cr.activity;
          if (a != null && adj > FOREGROUND_APP_ADJ && (a.state == ActivityState.RESUMED || a.state == ActivityState.PAUSING)) {
            adj=FOREGROUND_APP_ADJ;
          }
        }
      }
    }
  }
  if (app.pubProviders.size() != 0 && adj > FOREGROUND_APP_ADJ) {
    if (adj > CONTENT_PROVIDER_ADJ) {
      adj=CONTENT_PROVIDER_ADJ;
    }
    Iterator jt=app.pubProviders.values().iterator();
    while (jt.hasNext() && adj > FOREGROUND_APP_ADJ) {
      ContentProviderRecord cpr=(ContentProviderRecord)jt.next();
      if (cpr.clients.size() != 0) {
        Iterator<ProcessRecord> kt=cpr.clients.iterator();
        while (kt.hasNext() && adj > FOREGROUND_APP_ADJ) {
          ProcessRecord client=kt.next();
          if (client == app) {
            continue;
          }
          int myHiddenAdj=hiddenAdj;
          if (myHiddenAdj > client.hiddenAdj) {
            if (client.hiddenAdj > FOREGROUND_APP_ADJ) {
              myHiddenAdj=client.hiddenAdj;
            }
 else {
              myHiddenAdj=FOREGROUND_APP_ADJ;
            }
          }
          int clientAdj=computeOomAdjLocked(client,myHiddenAdj,TOP_APP);
          if (adj > clientAdj) {
            adj=clientAdj > FOREGROUND_APP_ADJ ? clientAdj : FOREGROUND_APP_ADJ;
          }
        }
      }
      if (cpr.externals != 0) {
        if (adj > FOREGROUND_APP_ADJ) {
          adj=FOREGROUND_APP_ADJ;
        }
      }
    }
  }
  app.curRawAdj=adj;
  if (adj > app.maxAdj) {
    adj=app.maxAdj;
  }
  app.curAdj=adj;
  app.curSchedGroup=(adj > VISIBLE_APP_ADJ && !app.persistent) ? Process.THREAD_GROUP_BG_NONINTERACTIVE : Process.THREAD_GROUP_DEFAULT;
  return adj;
}
