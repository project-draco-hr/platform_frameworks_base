{
  cleanUpApplicationRecordLocked(app,restarting,-1);
  if (!restarting) {
    mLRUProcesses.remove(app);
  }
  if (mPausingActivity != null && mPausingActivity.app == app) {
    if (DEBUG_PAUSE)     Log.v(TAG,"App died while pausing: " + mPausingActivity);
    mPausingActivity=null;
  }
  if (mLastPausedActivity != null && mLastPausedActivity.app == app) {
    mLastPausedActivity=null;
  }
  removeHistoryRecordsForAppLocked(mLRUActivities,app);
  removeHistoryRecordsForAppLocked(mStoppingActivities,app);
  removeHistoryRecordsForAppLocked(mWaitingVisibleActivities,app);
  removeHistoryRecordsForAppLocked(mFinishingActivities,app);
  boolean atTop=true;
  boolean hasVisibleActivities=false;
  int i=mHistory.size();
  if (localLOGV)   Log.v(TAG,"Removing app " + app + " from history with "+ i+ " entries");
  while (i > 0) {
    i--;
    HistoryRecord r=(HistoryRecord)mHistory.get(i);
    if (localLOGV)     Log.v(TAG,"Record #" + i + " "+ r+ ": app="+ r.app);
    if (r.app == app) {
      if ((!r.haveState && !r.stateNotNeeded) || r.finishing) {
        if (localLOGV)         Log.v(TAG,"Removing this entry!  frozen=" + r.haveState + " finishing="+ r.finishing);
        mHistory.remove(i);
        r.inHistory=false;
        mWindowManager.removeAppToken(r);
        if (VALIDATE_TOKENS) {
          mWindowManager.validateAppTokens(mHistory);
        }
        removeActivityUriPermissionsLocked(r);
      }
 else {
        if (localLOGV)         Log.v(TAG,"Keeping entry, setting app to null");
        if (r.visible) {
          hasVisibleActivities=true;
        }
        r.app=null;
        r.nowVisible=false;
        if (!r.haveState) {
          r.icicle=null;
        }
      }
      cleanUpActivityLocked(r,true);
      r.state=ActivityState.STOPPED;
    }
    atTop=false;
  }
  app.activities.clear();
  if (app.instrumentationClass != null) {
    Log.w(TAG,"Crash of app " + app.processName + " running instrumentation "+ app.instrumentationClass);
    Bundle info=new Bundle();
    info.putString("shortMsg","Process crashed.");
    finishInstrumentationLocked(app,Activity.RESULT_CANCELED,info);
  }
  if (!restarting) {
    if (!resumeTopActivityLocked(null)) {
      if (hasVisibleActivities) {
        ensureActivitiesVisibleLocked(null,0);
      }
    }
  }
}
