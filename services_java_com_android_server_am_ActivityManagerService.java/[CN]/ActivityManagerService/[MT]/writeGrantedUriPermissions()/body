{
  if (DEBUG_URI_PERMISSION)   Slog.v(TAG,"writeGrantedUriPermissions()");
  ArrayList<UriPermission.Snapshot> persist=Lists.newArrayList();
synchronized (this) {
    final int size=mGrantedUriPermissions.size();
    for (int i=0; i < size; i++) {
      for (      UriPermission perm : mGrantedUriPermissions.valueAt(i).values()) {
        if (perm.persistedModeFlags != 0) {
          persist.add(perm.snapshot());
        }
      }
    }
  }
  FileOutputStream fos=null;
  try {
    fos=mGrantFile.startWrite();
    XmlSerializer out=new FastXmlSerializer();
    out.setOutput(fos,"utf-8");
    out.startDocument(null,true);
    out.startTag(null,TAG_URI_GRANTS);
    for (    UriPermission.Snapshot perm : persist) {
      out.startTag(null,TAG_URI_GRANT);
      writeIntAttribute(out,ATTR_USER_HANDLE,perm.userHandle);
      out.attribute(null,ATTR_SOURCE_PKG,perm.sourcePkg);
      out.attribute(null,ATTR_TARGET_PKG,perm.targetPkg);
      out.attribute(null,ATTR_URI,String.valueOf(perm.uri));
      writeIntAttribute(out,ATTR_MODE_FLAGS,perm.persistedModeFlags);
      writeLongAttribute(out,ATTR_CREATED_TIME,perm.persistedCreateTime);
      out.endTag(null,TAG_URI_GRANT);
    }
    out.endTag(null,TAG_URI_GRANTS);
    out.endDocument();
    mGrantFile.finishWrite(fos);
  }
 catch (  IOException e) {
    if (fos != null) {
      mGrantFile.failWrite(fos);
    }
  }
}
