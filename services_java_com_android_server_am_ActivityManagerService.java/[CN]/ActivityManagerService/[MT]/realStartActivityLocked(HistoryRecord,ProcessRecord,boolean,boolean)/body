{
  r.startFreezingScreenLocked(app,0);
  mWindowManager.setAppVisibility(r,true);
  if (checkConfig) {
    Configuration config=mWindowManager.updateOrientationFromAppTokens(mConfiguration,r.mayFreezeScreenLocked(app) ? r : null);
    updateConfigurationLocked(config,r);
  }
  r.app=app;
  if (localLOGV)   Log.v(TAG,"Launching: " + r);
  int idx=app.activities.indexOf(r);
  if (idx < 0) {
    app.activities.add(r);
  }
  updateLRUListLocked(app,true);
  try {
    if (app.thread == null) {
      throw new RemoteException();
    }
    List<ResultInfo> results=null;
    List<Intent> newIntents=null;
    if (andResume) {
      results=r.results;
      newIntents=r.newIntents;
    }
    if (DEBUG_SWITCH)     Log.v(TAG,"Launching: " + r + " icicle="+ r.icicle+ " with results="+ results+ " newIntents="+ newIntents+ " andResume="+ andResume);
    if (andResume) {
      EventLog.writeEvent(LOG_AM_RESTART_ACTIVITY,System.identityHashCode(r),r.task.taskId,r.shortComponentName);
    }
    if (r.isHomeActivity) {
      mHomeProcess=app;
    }
    ensurePackageDexOpt(r.intent.getComponent().getPackageName());
    app.thread.scheduleLaunchActivity(new Intent(r.intent),r,r.info,r.icicle,results,newIntents,!andResume,isNextTransitionForward());
    updateUsageStats(r,true);
  }
 catch (  RemoteException e) {
    if (r.launchFailed) {
      Log.e(TAG,"Second failure launching " + r.intent.getComponent().flattenToShortString() + ", giving up",e);
      appDiedLocked(app,app.pid,app.thread);
      requestFinishActivityLocked(r,Activity.RESULT_CANCELED,null,"2nd-crash");
      return false;
    }
    app.activities.remove(r);
    throw e;
  }
  r.launchFailed=false;
  if (updateLRUListLocked(r)) {
    Log.w(TAG,"Activity " + r + " being launched, but already in LRU list");
  }
  if (andResume) {
    r.state=ActivityState.RESUMED;
    r.icicle=null;
    r.haveState=false;
    r.stopped=false;
    mResumedActivity=r;
    r.task.touchActiveTime();
    completeResumeLocked(r);
    pauseIfSleepingLocked();
  }
 else {
    r.state=ActivityState.STOPPED;
    r.stopped=true;
  }
  return true;
}
