{
  if (mAdjSeq == app.adjSeq) {
    if (!recursed && app.hidden) {
      app.curAdj=app.curRawAdj=hiddenAdj;
    }
    return app.curRawAdj;
  }
  if (app.thread == null) {
    app.adjSeq=mAdjSeq;
    app.curSchedGroup=Process.THREAD_GROUP_BG_NONINTERACTIVE;
    return (app.curAdj=ProcessList.HIDDEN_APP_MAX_ADJ);
  }
  app.adjTypeCode=ActivityManager.RunningAppProcessInfo.REASON_UNKNOWN;
  app.adjSource=null;
  app.adjTarget=null;
  app.empty=false;
  app.hidden=false;
  final int activitiesSize=app.activities.size();
  if (app.maxAdj <= ProcessList.FOREGROUND_APP_ADJ) {
    app.adjType="fixed";
    app.adjSeq=mAdjSeq;
    app.curRawAdj=app.maxAdj;
    app.foregroundActivities=false;
    app.keeping=true;
    app.curSchedGroup=Process.THREAD_GROUP_DEFAULT;
    app.systemNoUi=true;
    if (app == TOP_APP) {
      app.systemNoUi=false;
    }
 else     if (activitiesSize > 0) {
      for (int j=0; j < activitiesSize; j++) {
        final ActivityRecord r=app.activities.get(j);
        if (r.visible) {
          app.systemNoUi=false;
          break;
        }
      }
    }
    return (app.curAdj=app.maxAdj);
  }
  final boolean hadForegroundActivities=app.foregroundActivities;
  app.foregroundActivities=false;
  app.keeping=false;
  app.systemNoUi=false;
  int adj;
  int schedGroup;
  if (app == TOP_APP) {
    adj=ProcessList.FOREGROUND_APP_ADJ;
    schedGroup=Process.THREAD_GROUP_DEFAULT;
    app.adjType="top-activity";
    app.foregroundActivities=true;
  }
 else   if (app.instrumentationClass != null) {
    adj=ProcessList.FOREGROUND_APP_ADJ;
    schedGroup=Process.THREAD_GROUP_DEFAULT;
    app.adjType="instrumentation";
  }
 else   if (app.curReceiver != null || (mPendingBroadcast != null && mPendingBroadcast.curApp == app)) {
    adj=ProcessList.FOREGROUND_APP_ADJ;
    schedGroup=Process.THREAD_GROUP_DEFAULT;
    app.adjType="broadcast";
  }
 else   if (app.executingServices.size() > 0) {
    adj=ProcessList.FOREGROUND_APP_ADJ;
    schedGroup=Process.THREAD_GROUP_DEFAULT;
    app.adjType="exec-service";
  }
 else   if (activitiesSize > 0) {
    adj=hiddenAdj;
    schedGroup=Process.THREAD_GROUP_BG_NONINTERACTIVE;
    app.hidden=true;
    app.adjType="bg-activities";
  }
 else {
    adj=hiddenAdj;
    schedGroup=Process.THREAD_GROUP_BG_NONINTERACTIVE;
    app.hidden=true;
    app.empty=true;
    app.adjType="bg-empty";
  }
  if (!app.foregroundActivities && activitiesSize > 0) {
    for (int j=0; j < activitiesSize; j++) {
      final ActivityRecord r=app.activities.get(j);
      if (r.visible) {
        if (adj > ProcessList.VISIBLE_APP_ADJ) {
          adj=ProcessList.VISIBLE_APP_ADJ;
          app.adjType="visible";
        }
        schedGroup=Process.THREAD_GROUP_DEFAULT;
        app.hidden=false;
        app.foregroundActivities=true;
        break;
      }
 else       if (r.state == ActivityState.PAUSING || r.state == ActivityState.PAUSED || r.state == ActivityState.STOPPING) {
        if (adj > ProcessList.PERCEPTIBLE_APP_ADJ) {
          adj=ProcessList.PERCEPTIBLE_APP_ADJ;
          app.adjType="stopping";
        }
        app.foregroundActivities=true;
      }
    }
  }
  if (adj > ProcessList.PERCEPTIBLE_APP_ADJ) {
    if (app.foregroundServices) {
      adj=ProcessList.PERCEPTIBLE_APP_ADJ;
      app.hidden=false;
      app.adjType="foreground-service";
      schedGroup=Process.THREAD_GROUP_DEFAULT;
    }
 else     if (app.forcingToForeground != null) {
      adj=ProcessList.PERCEPTIBLE_APP_ADJ;
      app.hidden=false;
      app.adjType="force-foreground";
      app.adjSource=app.forcingToForeground;
      schedGroup=Process.THREAD_GROUP_DEFAULT;
    }
  }
  if (adj > ProcessList.HEAVY_WEIGHT_APP_ADJ && app == mHeavyWeightProcess) {
    adj=ProcessList.HEAVY_WEIGHT_APP_ADJ;
    schedGroup=Process.THREAD_GROUP_BG_NONINTERACTIVE;
    app.hidden=false;
    app.adjType="heavy";
  }
  if (adj > ProcessList.HOME_APP_ADJ && app == mHomeProcess) {
    adj=ProcessList.HOME_APP_ADJ;
    schedGroup=Process.THREAD_GROUP_BG_NONINTERACTIVE;
    app.hidden=false;
    app.adjType="home";
  }
  if (false)   Slog.i(TAG,"OOM " + app + ": initial adj="+ adj+ " reason="+ app.adjType);
  app.adjSeq=mAdjSeq;
  app.curRawAdj=adj;
  if (mBackupTarget != null && app == mBackupTarget.app) {
    if (adj > ProcessList.BACKUP_APP_ADJ) {
      if (DEBUG_BACKUP)       Slog.v(TAG,"oom BACKUP_APP_ADJ for " + app);
      adj=ProcessList.BACKUP_APP_ADJ;
      app.adjType="backup";
      app.hidden=false;
    }
  }
  if (app.services.size() != 0 && (adj > ProcessList.FOREGROUND_APP_ADJ || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE)) {
    final long now=SystemClock.uptimeMillis();
    Iterator<ServiceRecord> jt=app.services.iterator();
    while (jt.hasNext() && adj > ProcessList.FOREGROUND_APP_ADJ) {
      ServiceRecord s=jt.next();
      if (s.startRequested) {
        if (app.hasShownUi && app != mHomeProcess) {
          if (adj > ProcessList.SERVICE_ADJ) {
            app.adjType="started-bg-ui-services";
          }
        }
 else {
          if (now < (s.lastActivity + MAX_SERVICE_INACTIVITY)) {
            if (adj > ProcessList.SERVICE_ADJ) {
              adj=ProcessList.SERVICE_ADJ;
              app.adjType="started-services";
              app.hidden=false;
            }
          }
          if (adj > ProcessList.SERVICE_ADJ) {
            app.adjType="started-bg-services";
          }
        }
        app.keeping=true;
      }
      if (s.connections.size() > 0 && (adj > ProcessList.FOREGROUND_APP_ADJ || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE)) {
        Iterator<ArrayList<ConnectionRecord>> kt=s.connections.values().iterator();
        while (kt.hasNext() && adj > ProcessList.FOREGROUND_APP_ADJ) {
          ArrayList<ConnectionRecord> clist=kt.next();
          for (int i=0; i < clist.size() && adj > ProcessList.FOREGROUND_APP_ADJ; i++) {
            ConnectionRecord cr=clist.get(i);
            if (cr.binding.client == app) {
              continue;
            }
            if ((cr.flags & Context.BIND_WAIVE_PRIORITY) == 0) {
              ProcessRecord client=cr.binding.client;
              int clientAdj=adj;
              int myHiddenAdj=hiddenAdj;
              if (myHiddenAdj > client.hiddenAdj) {
                if (client.hiddenAdj >= ProcessList.VISIBLE_APP_ADJ) {
                  myHiddenAdj=client.hiddenAdj;
                }
 else {
                  myHiddenAdj=ProcessList.VISIBLE_APP_ADJ;
                }
              }
              clientAdj=computeOomAdjLocked(client,myHiddenAdj,TOP_APP,true,doingAll);
              String adjType=null;
              if ((cr.flags & Context.BIND_ALLOW_OOM_MANAGEMENT) != 0) {
                if (app.hasShownUi && app != mHomeProcess) {
                  if (adj > clientAdj) {
                    adjType="bound-bg-ui-services";
                  }
                  app.hidden=false;
                  clientAdj=adj;
                }
 else {
                  if (now >= (s.lastActivity + MAX_SERVICE_INACTIVITY)) {
                    if (adj > clientAdj) {
                      adjType="bound-bg-services";
                    }
                    clientAdj=adj;
                  }
                }
              }
              if (adj > clientAdj) {
                if (app.hasShownUi && app != mHomeProcess && clientAdj > ProcessList.PERCEPTIBLE_APP_ADJ) {
                  adjType="bound-bg-ui-services";
                }
 else {
                  if ((cr.flags & (Context.BIND_ABOVE_CLIENT | Context.BIND_IMPORTANT)) != 0) {
                    adj=clientAdj;
                  }
 else                   if (clientAdj >= ProcessList.VISIBLE_APP_ADJ) {
                    adj=clientAdj;
                  }
 else {
                    adj=ProcessList.VISIBLE_APP_ADJ;
                  }
                  if (!client.hidden) {
                    app.hidden=false;
                  }
                  if (client.keeping) {
                    app.keeping=true;
                  }
                  adjType="service";
                }
              }
              if (adjType != null) {
                app.adjType=adjType;
                app.adjTypeCode=ActivityManager.RunningAppProcessInfo.REASON_SERVICE_IN_USE;
                app.adjSource=cr.binding.client;
                app.adjSourceOom=clientAdj;
                app.adjTarget=s.name;
              }
              if ((cr.flags & Context.BIND_NOT_FOREGROUND) == 0) {
                if (client.curSchedGroup == Process.THREAD_GROUP_DEFAULT) {
                  schedGroup=Process.THREAD_GROUP_DEFAULT;
                }
              }
            }
            if ((cr.flags & Context.BIND_ADJUST_WITH_ACTIVITY) != 0) {
              ActivityRecord a=cr.activity;
              if (a != null && adj > ProcessList.FOREGROUND_APP_ADJ && (a.visible || a.state == ActivityState.RESUMED || a.state == ActivityState.PAUSING)) {
                adj=ProcessList.FOREGROUND_APP_ADJ;
                if ((cr.flags & Context.BIND_NOT_FOREGROUND) == 0) {
                  schedGroup=Process.THREAD_GROUP_DEFAULT;
                }
                app.hidden=false;
                app.adjType="service";
                app.adjTypeCode=ActivityManager.RunningAppProcessInfo.REASON_SERVICE_IN_USE;
                app.adjSource=a;
                app.adjSourceOom=adj;
                app.adjTarget=s.name;
              }
            }
          }
        }
      }
    }
    if (adj > hiddenAdj) {
      adj=hiddenAdj;
      app.hidden=false;
      app.adjType="bg-services";
    }
  }
  if (app.pubProviders.size() != 0 && (adj > ProcessList.FOREGROUND_APP_ADJ || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE)) {
    Iterator<ContentProviderRecord> jt=app.pubProviders.values().iterator();
    while (jt.hasNext() && (adj > ProcessList.FOREGROUND_APP_ADJ || schedGroup == Process.THREAD_GROUP_BG_NONINTERACTIVE)) {
      ContentProviderRecord cpr=jt.next();
      if (cpr.clients.size() != 0) {
        Iterator<ProcessRecord> kt=cpr.clients.iterator();
        while (kt.hasNext() && adj > ProcessList.FOREGROUND_APP_ADJ) {
          ProcessRecord client=kt.next();
          if (client == app) {
            continue;
          }
          int myHiddenAdj=hiddenAdj;
          if (myHiddenAdj > client.hiddenAdj) {
            if (client.hiddenAdj > ProcessList.FOREGROUND_APP_ADJ) {
              myHiddenAdj=client.hiddenAdj;
            }
 else {
              myHiddenAdj=ProcessList.FOREGROUND_APP_ADJ;
            }
          }
          int clientAdj=computeOomAdjLocked(client,myHiddenAdj,TOP_APP,true,doingAll);
          if (adj > clientAdj) {
            if (app.hasShownUi && app != mHomeProcess && clientAdj > ProcessList.PERCEPTIBLE_APP_ADJ) {
              app.adjType="bg-ui-provider";
            }
 else {
              adj=clientAdj > ProcessList.FOREGROUND_APP_ADJ ? clientAdj : ProcessList.FOREGROUND_APP_ADJ;
              app.adjType="provider";
            }
            if (!client.hidden) {
              app.hidden=false;
            }
            if (client.keeping) {
              app.keeping=true;
            }
            app.adjTypeCode=ActivityManager.RunningAppProcessInfo.REASON_PROVIDER_IN_USE;
            app.adjSource=client;
            app.adjSourceOom=clientAdj;
            app.adjTarget=cpr.name;
          }
          if (client.curSchedGroup == Process.THREAD_GROUP_DEFAULT) {
            schedGroup=Process.THREAD_GROUP_DEFAULT;
          }
        }
      }
      if (cpr.externals != 0) {
        if (adj > ProcessList.FOREGROUND_APP_ADJ) {
          adj=ProcessList.FOREGROUND_APP_ADJ;
          schedGroup=Process.THREAD_GROUP_DEFAULT;
          app.hidden=false;
          app.keeping=true;
          app.adjType="provider";
          app.adjTarget=cpr.name;
        }
      }
    }
  }
  app.curRawAdj=adj;
  if (adj > app.maxAdj) {
    adj=app.maxAdj;
    if (app.maxAdj <= ProcessList.PERCEPTIBLE_APP_ADJ) {
      schedGroup=Process.THREAD_GROUP_DEFAULT;
    }
  }
  if (adj < ProcessList.HIDDEN_APP_MIN_ADJ) {
    app.keeping=true;
  }
  if (app.hasAboveClient) {
    if (adj < ProcessList.FOREGROUND_APP_ADJ) {
    }
 else     if (adj < ProcessList.VISIBLE_APP_ADJ) {
      adj=ProcessList.VISIBLE_APP_ADJ;
    }
 else     if (adj < ProcessList.PERCEPTIBLE_APP_ADJ) {
      adj=ProcessList.PERCEPTIBLE_APP_ADJ;
    }
 else     if (adj < ProcessList.HIDDEN_APP_MIN_ADJ) {
      adj=ProcessList.HIDDEN_APP_MIN_ADJ;
    }
 else     if (adj < ProcessList.HIDDEN_APP_MAX_ADJ) {
      adj++;
    }
  }
  if (adj == ProcessList.SERVICE_ADJ) {
    if (doingAll) {
      app.serviceb=mNewNumServiceProcs > (mNumServiceProcs / 3);
      mNewNumServiceProcs++;
    }
    if (app.serviceb) {
      adj=ProcessList.SERVICE_B_ADJ;
    }
  }
 else {
    app.serviceb=false;
  }
  app.curAdj=adj;
  app.curSchedGroup=schedGroup;
  if (hadForegroundActivities != app.foregroundActivities) {
    mHandler.obtainMessage(DISPATCH_FOREGROUND_ACTIVITIES_CHANGED,app.pid,app.info.uid,app.foregroundActivities).sendToTarget();
  }
  return app.curRawAdj;
}
