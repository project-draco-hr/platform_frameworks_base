{
  long now=SystemClock.uptimeMillis();
  Long crashTime=mProcessCrashTimes.get(app.info.processName,app.info.uid);
  if (crashTime != null && now < crashTime + MIN_CRASH_INTERVAL) {
    Slog.w(TAG,"Process " + app.info.processName + " has crashed too many times: killing!");
    EventLog.writeEvent(EventLogTags.AM_PROCESS_CRASHED_TOO_MUCH,app.info.processName,app.info.uid);
    for (int i=mMainStack.mHistory.size() - 1; i >= 0; i--) {
      ActivityRecord r=(ActivityRecord)mMainStack.mHistory.get(i);
      if (r.app == app) {
        Slog.w(TAG,"  Force finishing activity " + r.intent.getComponent().flattenToShortString());
        r.stack.finishActivityLocked(r,i,Activity.RESULT_CANCELED,null,"crashed");
      }
    }
    if (!app.persistent) {
      killServicesLocked(app,false);
      EventLog.writeEvent(EventLogTags.AM_PROC_BAD,app.info.uid,app.info.processName);
      mBadProcesses.put(app.info.processName,app.info.uid,now);
      app.bad=true;
      mProcessCrashTimes.remove(app.info.processName,app.info.uid);
      app.removed=true;
      removeProcessLocked(app,false);
      return false;
    }
  }
 else {
    ActivityRecord r=mMainStack.topRunningActivityLocked(null);
    if (r.app == app) {
      Slog.w(TAG,"  Force finishing activity " + r.intent.getComponent().flattenToShortString());
      int index=mMainStack.indexOfTokenLocked(r);
      r.stack.finishActivityLocked(r,index,Activity.RESULT_CANCELED,null,"crashed");
      index--;
      if (index >= 0) {
        r=(ActivityRecord)mMainStack.mHistory.get(index);
        if (r.state == ActivityState.RESUMED || r.state == ActivityState.PAUSING || r.state == ActivityState.PAUSED) {
          if (!r.isHomeActivity) {
            Slog.w(TAG,"  Force finishing activity " + r.intent.getComponent().flattenToShortString());
            r.stack.finishActivityLocked(r,index,Activity.RESULT_CANCELED,null,"crashed");
          }
        }
      }
    }
  }
  if (app.services.size() != 0) {
    Iterator<ServiceRecord> it=app.services.iterator();
    while (it.hasNext()) {
      ServiceRecord sr=it.next();
      sr.crashCount++;
    }
  }
  if (app == mHomeProcess && mHomeProcess.activities.size() > 0 && (mHomeProcess.info.flags & ApplicationInfo.FLAG_SYSTEM) == 0) {
    Iterator it=mHomeProcess.activities.iterator();
    while (it.hasNext()) {
      ActivityRecord r=(ActivityRecord)it.next();
      if (r.isHomeActivity) {
        Log.i(TAG,"Clearing package preferred activities from " + r.packageName);
        try {
          ActivityThread.getPackageManager().clearPackagePreferredActivities(r.packageName);
        }
 catch (        RemoteException c) {
        }
      }
    }
  }
  mProcessCrashTimes.put(app.info.processName,app.info.uid,now);
  return true;
}
