{
  TaskRecord lastTask=null;
  boolean needNL=false;
  final String innerPrefix=prefix + "      ";
  final String[] args=new String[0];
  for (int i=list.size() - 1; i >= 0; i--) {
    final ActivityRecord r=(ActivityRecord)list.get(i);
    if (dumpPackage != null && !dumpPackage.equals(r.packageName)) {
      continue;
    }
    final boolean full=!brief && (complete || !r.isInHistory());
    if (needNL) {
      pw.println(" ");
      needNL=false;
    }
    if (lastTask != r.task) {
      lastTask=r.task;
      pw.print(prefix);
      pw.print(full ? "* " : "  ");
      pw.println(lastTask);
      if (full) {
        lastTask.dump(pw,prefix + "  ");
      }
 else       if (complete) {
        if (lastTask.intent != null) {
          pw.print(prefix);
          pw.print("  ");
          pw.println(lastTask.intent.toInsecureStringWithClip());
        }
      }
    }
    pw.print(prefix);
    pw.print(full ? "  * " : "    ");
    pw.print(label);
    pw.print(" #");
    pw.print(i);
    pw.print(": ");
    pw.println(r);
    if (full) {
      r.dump(pw,innerPrefix);
    }
 else     if (complete) {
      pw.print(innerPrefix);
      pw.println(r.intent.toInsecureString());
      if (r.app != null) {
        pw.print(innerPrefix);
        pw.println(r.app);
      }
    }
    if (client && r.app != null && r.app.thread != null) {
      pw.flush();
      try {
        TransferPipe tp=new TransferPipe();
        try {
          r.app.thread.dumpActivity(tp.getWriteFd().getFileDescriptor(),r.appToken,innerPrefix,args);
          tp.go(fd,2000);
        }
  finally {
          tp.kill();
        }
      }
 catch (      IOException e) {
        pw.println(innerPrefix + "Failure while dumping the activity: " + e);
      }
catch (      RemoteException e) {
        pw.println(innerPrefix + "Got a RemoteException while dumping the activity");
      }
      needNL=true;
    }
  }
}
