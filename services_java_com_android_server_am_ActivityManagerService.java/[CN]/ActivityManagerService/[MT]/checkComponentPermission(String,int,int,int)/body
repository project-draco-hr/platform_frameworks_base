{
  Identity tlsIdentity=sCallerIdentity.get();
  if (tlsIdentity != null) {
    Log.d(TAG,"checkComponentPermission() adjusting {pid,uid} to {" + tlsIdentity.pid + ","+ tlsIdentity.uid+ "}");
    uid=tlsIdentity.uid;
    pid=tlsIdentity.pid;
  }
  if (uid == 0 || uid == Process.SYSTEM_UID || pid == MY_PID || !Process.supportsProcesses()) {
    return PackageManager.PERMISSION_GRANTED;
  }
  if (reqUid >= 0 && uid != reqUid) {
    Log.w(TAG,"Permission denied: checkComponentPermission() reqUid=" + reqUid);
    return PackageManager.PERMISSION_DENIED;
  }
  if (permission == null) {
    return PackageManager.PERMISSION_GRANTED;
  }
  try {
    return ActivityThread.getPackageManager().checkUidPermission(permission,uid);
  }
 catch (  RemoteException e) {
    Log.e(TAG,"PackageManager is dead?!?",e);
  }
  return PackageManager.PERMISSION_DENIED;
}
