{
  if (DEBUG_BROADCAST)   Slog.v(TAG,"Unregister receiver: " + receiver);
  final long origId=Binder.clearCallingIdentity();
  try {
    boolean doTrim=false;
synchronized (this) {
      ReceiverList rl=(ReceiverList)mRegisteredReceivers.get(receiver.asBinder());
      if (rl != null) {
        if (rl.curBroadcast != null) {
          BroadcastRecord r=rl.curBroadcast;
          final boolean doNext=finishReceiverLocked(receiver.asBinder(),r.resultCode,r.resultData,r.resultExtras,r.resultAbort,true);
          if (doNext) {
            doTrim=true;
            r.queue.processNextBroadcast(false);
          }
        }
        if (rl.app != null) {
          rl.app.receivers.remove(rl);
        }
        removeReceiverLocked(rl);
        if (rl.linkedToDeath) {
          rl.linkedToDeath=false;
          rl.receiver.asBinder().unlinkToDeath(rl,0);
        }
      }
    }
    if (doTrim) {
      trimApplications();
      return;
    }
  }
  finally {
    Binder.restoreCallingIdentity(origId);
  }
}
