{
  if (DEBUG_BROADCAST)   Log.v(TAG,"Unregister receiver: " + receiver);
  boolean doNext=false;
synchronized (this) {
    ReceiverList rl=(ReceiverList)mRegisteredReceivers.get(receiver.asBinder());
    if (rl != null) {
      if (rl.curBroadcast != null) {
        BroadcastRecord r=rl.curBroadcast;
        doNext=finishReceiverLocked(receiver.asBinder(),r.resultCode,r.resultData,r.resultExtras,r.resultAbort,true);
      }
      if (rl.app != null) {
        rl.app.receivers.remove(rl);
      }
      removeReceiverLocked(rl);
      if (rl.linkedToDeath) {
        rl.linkedToDeath=false;
        rl.receiver.asBinder().unlinkToDeath(rl,0);
      }
    }
  }
  if (!doNext) {
    return;
  }
  final long origId=Binder.clearCallingIdentity();
  processNextBroadcast(false);
  trimApplications();
  Binder.restoreCallingIdentity(origId);
}
