{
  if (DEBUG_URI_PERMISSION)   Slog.v(TAG,"Checking URI perm to data=" + (intent != null ? intent.getData() : null) + " clip="+ (intent != null ? intent.getClipData() : null)+ " from "+ intent+ "; flags=0x"+ Integer.toHexString(intent != null ? intent.getFlags() : 0));
  if (targetPkg == null) {
    throw new NullPointerException("targetPkg");
  }
  if (intent == null) {
    return null;
  }
  Uri data=intent.getData();
  ClipData clip=intent.getClipData();
  if (data == null && clip == null) {
    return null;
  }
  if (data != null) {
    int target=checkGrantUriPermissionLocked(callingUid,targetPkg,data,mode,needed != null ? needed.targetUid : -1);
    if (target > 0) {
      if (needed == null) {
        needed=new NeededUriGrants(targetPkg,target,mode);
      }
      needed.add(data);
    }
  }
  if (clip != null) {
    for (int i=0; i < clip.getItemCount(); i++) {
      Uri uri=clip.getItemAt(i).getUri();
      if (uri != null) {
        int target=-1;
        target=checkGrantUriPermissionLocked(callingUid,targetPkg,uri,mode,needed != null ? needed.targetUid : -1);
        if (target > 0) {
          if (needed == null) {
            needed=new NeededUriGrants(targetPkg,target,mode);
          }
          needed.add(uri);
        }
      }
 else {
        Intent clipIntent=clip.getItemAt(i).getIntent();
        if (clipIntent != null) {
          NeededUriGrants newNeeded=checkGrantUriPermissionFromIntentLocked(callingUid,targetPkg,clipIntent,mode,needed);
          if (newNeeded != null) {
            needed=newNeeded;
          }
        }
      }
    }
  }
  return needed;
}
