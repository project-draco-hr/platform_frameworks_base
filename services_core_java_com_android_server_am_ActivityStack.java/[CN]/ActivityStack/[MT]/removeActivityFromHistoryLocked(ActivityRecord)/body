{
  finishActivityResultsLocked(r,Activity.RESULT_CANCELED,null);
  r.makeFinishing();
  if (DEBUG_ADD_REMOVE) {
    RuntimeException here=new RuntimeException("here");
    here.fillInStackTrace();
    Slog.i(TAG,"Removing activity " + r + " from stack");
  }
  final TaskRecord task=r.task;
  if (task != null && task.removeActivity(r)) {
    if (DEBUG_STACK)     Slog.i(TAG,"removeActivityFromHistoryLocked: last activity removed from " + this);
    if (mStackSupervisor.isFrontStack(this) && task == topTask() && task.mOnTopOfHome) {
      mStackSupervisor.moveHomeToTop();
    }
    removeTask(task);
  }
  r.takeFromHistory();
  removeTimeoutsForActivityLocked(r);
  if (DEBUG_STATES)   Slog.v(TAG,"Moving to DESTROYED: " + r + " (removed from history)");
  r.state=ActivityState.DESTROYED;
  if (DEBUG_APP)   Slog.v(TAG,"Clearing app during remove for activity " + r);
  r.app=null;
  mWindowManager.removeAppToken(r.appToken);
  if (VALIDATE_TOKENS) {
    validateAppTokensLocked();
  }
  cleanUpActivityServicesLocked(r);
  r.removeUriPermissionsLocked();
}
