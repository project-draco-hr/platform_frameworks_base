{
  mStackSupervisor.endLockTaskModeIfTaskEnding(task);
  mWindowManager.removeTask(task.taskId);
  final ActivityRecord r=mResumedActivity;
  if (r != null && r.task == task) {
    mResumedActivity=null;
  }
  final int taskNdx=mTaskHistory.indexOf(task);
  final int topTaskNdx=mTaskHistory.size() - 1;
  if (task.mOnTopOfHome && taskNdx < topTaskNdx) {
    mTaskHistory.get(taskNdx + 1).mOnTopOfHome=true;
  }
  mTaskHistory.remove(task);
  if (task.mActivities.isEmpty()) {
    final boolean isVoiceSession=task.voiceSession != null;
    if (isVoiceSession) {
      try {
        task.voiceSession.taskFinished(task.intent,task.taskId);
      }
 catch (      RemoteException e) {
      }
    }
    if (task.autoRemoveFromRecents() || isVoiceSession) {
      mService.mRecentTasks.remove(task);
    }
  }
  if (mTaskHistory.isEmpty()) {
    if (DEBUG_STACK)     Slog.i(TAG,"removeTask: moving to back stack=" + this);
    if (isOnHomeDisplay()) {
      mStackSupervisor.moveHomeStack(!isHomeStack());
    }
    if (mStacks != null) {
      mStacks.remove(this);
      mStacks.add(0,this);
    }
  }
}
