{
  if (r.finishing) {
    Slog.w(TAG,"Duplicate finish request for " + r);
    return false;
  }
  r.makeFinishingLocked();
  final TaskRecord task=r.task;
  EventLog.writeEvent(EventLogTags.AM_FINISH_ACTIVITY,r.userId,System.identityHashCode(r),task.taskId,r.shortComponentName,reason);
  final ArrayList<ActivityRecord> activities=task.mActivities;
  final int index=activities.indexOf(r);
  if (index < (activities.size() - 1)) {
    task.setFrontOfTask();
    if ((r.intent.getFlags() & Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET) != 0) {
      ActivityRecord next=activities.get(index + 1);
      next.intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET);
    }
  }
  r.pauseKeyDispatchingLocked();
  adjustFocusedActivityLocked(r,"finishActivity");
  finishActivityResultsLocked(r,resultCode,resultData);
  final boolean endTask=index <= 0;
  final int transit=endTask ? TRANSIT_TASK_CLOSE : TRANSIT_ACTIVITY_CLOSE;
  if (mResumedActivity == r) {
    if (DEBUG_VISIBILITY || DEBUG_TRANSITION)     Slog.v(TAG_TRANSITION,"Prepare close transition: finishing " + r);
    mWindowManager.prepareAppTransition(transit,false);
    mWindowManager.setAppVisibility(r.appToken,false);
    if (mPausingActivity == null) {
      if (DEBUG_PAUSE)       Slog.v(TAG_PAUSE,"Finish needs to pause: " + r);
      if (DEBUG_USER_LEAVING)       Slog.v(TAG_USER_LEAVING,"finish() => pause with userLeaving=false");
      startPausingLocked(false,false,false,false);
    }
    if (endTask) {
      mStackSupervisor.removeLockedTaskLocked(task);
    }
  }
 else   if (r.state != ActivityState.PAUSING) {
    if (DEBUG_PAUSE)     Slog.v(TAG_PAUSE,"Finish not pausing: " + r);
    if (r.visible) {
      mWindowManager.prepareAppTransition(transit,false);
      mWindowManager.setAppVisibility(r.appToken,false);
      mWindowManager.executeAppTransition();
      if (!mStackSupervisor.mWaitingVisibleActivities.contains(r)) {
        mStackSupervisor.mWaitingVisibleActivities.add(r);
      }
    }
    return finishCurrentActivityLocked(r,(r.visible || r.nowVisible) ? FINISH_AFTER_VISIBLE : FINISH_AFTER_PAUSE,oomAdj) == null;
  }
 else {
    if (DEBUG_PAUSE)     Slog.v(TAG_PAUSE,"Finish waiting for pause of: " + r);
  }
  return false;
}
