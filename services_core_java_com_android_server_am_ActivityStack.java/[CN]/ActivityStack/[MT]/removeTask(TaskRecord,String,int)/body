{
  if (mode == REMOVE_TASK_MODE_DESTROYING) {
    mStackSupervisor.removeLockedTaskLocked(task);
    mWindowManager.removeTask(task.taskId);
    if (!StackId.persistTaskBounds(mStackId)) {
      task.updateOverrideConfiguration(null);
    }
  }
  final ActivityRecord r=mResumedActivity;
  if (r != null && r.task == task) {
    mResumedActivity=null;
  }
  final int taskNdx=mTaskHistory.indexOf(task);
  final int topTaskNdx=mTaskHistory.size() - 1;
  if (task.isOverHomeStack() && taskNdx < topTaskNdx) {
    final TaskRecord nextTask=mTaskHistory.get(taskNdx + 1);
    if (!nextTask.isOverHomeStack()) {
      nextTask.setTaskToReturnTo(HOME_ACTIVITY_TYPE);
    }
  }
  mTaskHistory.remove(task);
  updateTaskMovement(task,true);
  if (mode == REMOVE_TASK_MODE_DESTROYING && task.mActivities.isEmpty()) {
    final boolean isVoiceSession=task.voiceSession != null;
    if (isVoiceSession) {
      try {
        task.voiceSession.taskFinished(task.intent,task.taskId);
      }
 catch (      RemoteException e) {
      }
    }
    if (task.autoRemoveFromRecents() || isVoiceSession) {
      mRecentTasks.remove(task);
      task.removedFromRecents();
    }
  }
  if (mTaskHistory.isEmpty()) {
    if (DEBUG_STACK)     Slog.i(TAG_STACK,"removeTask: removing stack=" + this);
    if (isOnHomeDisplay() && mode != REMOVE_TASK_MODE_MOVING_TO_TOP && mStackSupervisor.isFocusedStack(this)) {
      String myReason=reason + " leftTaskHistoryEmpty";
      if (mFullscreen || !adjustFocusToNextFocusableStackLocked(task.getTaskToReturnTo(),myReason)) {
        mStackSupervisor.moveHomeStackToFront(myReason);
      }
    }
    if (mStacks != null) {
      mStacks.remove(this);
      mStacks.add(0,this);
    }
    if (!isHomeStack()) {
      mActivityContainer.onTaskListEmptyLocked();
    }
  }
  task.stack=null;
}
