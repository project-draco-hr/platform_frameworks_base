{
  int replyChainEnd=-1;
  final int taskId=task.taskId;
  final String taskAffinity=task.affinity;
  final ArrayList<ActivityRecord> activities=affinityTask.mActivities;
  final int numActivities=activities.size();
  final int rootActivityNdx=affinityTask.findEffectiveRootIndex();
  for (int i=numActivities - 1; i > rootActivityNdx; --i) {
    ActivityRecord target=activities.get(i);
    if (target.frontOfTask)     break;
    final int flags=target.info.flags;
    boolean finishOnTaskLaunch=(flags & ActivityInfo.FLAG_FINISH_ON_TASK_LAUNCH) != 0;
    boolean allowTaskReparenting=(flags & ActivityInfo.FLAG_ALLOW_TASK_REPARENTING) != 0;
    if (target.resultTo != null) {
      if (replyChainEnd < 0) {
        replyChainEnd=i;
      }
    }
 else     if (topTaskIsHigher && allowTaskReparenting && taskAffinity != null && taskAffinity.equals(target.taskAffinity)) {
      if (forceReset || finishOnTaskLaunch) {
        final int start=replyChainEnd >= 0 ? replyChainEnd : i;
        if (DEBUG_TASKS)         Slog.v(TAG_TASKS,"Finishing task at index " + start + " to "+ i);
        for (int srcPos=start; srcPos >= i; --srcPos) {
          final ActivityRecord p=activities.get(srcPos);
          if (p.finishing) {
            continue;
          }
          finishActivityLocked(p,Activity.RESULT_CANCELED,null,"move-affinity",false);
        }
      }
 else {
        if (taskInsertionPoint < 0) {
          taskInsertionPoint=task.mActivities.size();
        }
        final int start=replyChainEnd >= 0 ? replyChainEnd : i;
        if (DEBUG_TASKS)         Slog.v(TAG_TASKS,"Reparenting from task=" + affinityTask + ":"+ start+ "-"+ i+ " to task="+ task+ ":"+ taskInsertionPoint);
        for (int srcPos=start; srcPos >= i; --srcPos) {
          final ActivityRecord p=activities.get(srcPos);
          p.setTask(task,null);
          task.addActivityAtIndex(taskInsertionPoint,p);
          if (DEBUG_ADD_REMOVE)           Slog.i(TAG_ADD_REMOVE,"Removing and adding activity " + p + " to stack at "+ task+ " callers="+ Debug.getCallers(3));
          if (DEBUG_TASKS)           Slog.v(TAG_TASKS,"Pulling activity " + p + " from "+ srcPos+ " in to resetting task "+ task);
          setAppTask(p,task);
        }
        mWindowManager.moveTaskToTop(taskId);
        if (VALIDATE_TOKENS) {
          validateAppTokensLocked();
        }
        if (target.info.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP) {
          ArrayList<ActivityRecord> taskActivities=task.mActivities;
          int targetNdx=taskActivities.indexOf(target);
          if (targetNdx > 0) {
            ActivityRecord p=taskActivities.get(targetNdx - 1);
            if (p.intent.getComponent().equals(target.intent.getComponent())) {
              finishActivityLocked(p,Activity.RESULT_CANCELED,null,"replace",false);
            }
          }
        }
      }
      replyChainEnd=-1;
    }
  }
  return taskInsertionPoint;
}
