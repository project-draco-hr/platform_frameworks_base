{
  ActivityRecord top=topRunningActivityLocked();
  if (DEBUG_VISIBILITY)   Slog.v(TAG_VISIBILITY,"ensureActivitiesVisible behind " + top + " configChanges=0x"+ Integer.toHexString(configChanges));
  if (top != null) {
    checkTranslucentActivityWaiting(top);
  }
  boolean aboveTop=top != null;
  final boolean stackInvisible=!isStackVisibleLocked();
  boolean behindFullscreenActivity=stackInvisible;
  boolean noStackActivityResumed=(isInStackLocked(starting) == null);
  for (int taskNdx=mTaskHistory.size() - 1; taskNdx >= 0; --taskNdx) {
    final TaskRecord task=mTaskHistory.get(taskNdx);
    final ArrayList<ActivityRecord> activities=task.mActivities;
    for (int activityNdx=activities.size() - 1; activityNdx >= 0; --activityNdx) {
      final ActivityRecord r=activities.get(activityNdx);
      if (r.finishing) {
        continue;
      }
      final boolean isTop=r == top;
      if (aboveTop && !isTop) {
        continue;
      }
      aboveTop=false;
      if ((!behindFullscreenActivity || r.mLaunchTaskBehind) && okToShowLocked(r)) {
        if (DEBUG_VISIBILITY)         Slog.v(TAG_VISIBILITY,"Make visible? " + r + " finishing="+ r.finishing+ " state="+ r.state);
        if (r != starting) {
          ensureActivityConfigurationLocked(r,0,preserveWindows);
        }
        if (r.app == null || r.app.thread == null) {
          if (makeVisibleAndRestartIfNeeded(starting,configChanges,isTop,noStackActivityResumed,r)) {
            if (activityNdx >= activities.size()) {
              activityNdx=activities.size() - 1;
            }
 else {
              noStackActivityResumed=false;
            }
          }
        }
 else         if (r.visible) {
          if (handleAlreadyVisible(r)) {
            noStackActivityResumed=false;
          }
        }
 else {
          makeVisible(starting,r);
        }
        configChanges|=r.configChangeFlags;
        behindFullscreenActivity=updateBehindFullscreen(stackInvisible,behindFullscreenActivity,task,r);
      }
 else {
        makeInvisible(stackInvisible,behindFullscreenActivity,r);
      }
    }
    if (mStackId == FREEFORM_WORKSPACE_STACK_ID) {
      behindFullscreenActivity=stackInvisible;
    }
  }
  if (mTranslucentActivityWaiting != null && mUndrawnActivitiesBelowTopTranslucent.isEmpty()) {
    notifyActivityDrawnLocked(null);
  }
}
