{
  ActivityRecord prev=mPausingActivity;
  if (DEBUG_PAUSE)   Slog.v(TAG_PAUSE,"Complete pause: " + prev);
  if (prev != null) {
    final boolean wasStopping=prev.state == ActivityState.STOPPING;
    prev.state=ActivityState.PAUSED;
    if (prev.finishing) {
      if (DEBUG_PAUSE)       Slog.v(TAG_PAUSE,"Executing finish of activity: " + prev);
      prev=finishCurrentActivityLocked(prev,FINISH_AFTER_VISIBLE,false);
    }
 else     if (prev.app != null) {
      if (DEBUG_PAUSE)       Slog.v(TAG_PAUSE,"Enqueue pending stop if needed: " + prev + " wasStopping="+ wasStopping+ " visible="+ prev.visible);
      if (mStackSupervisor.mWaitingVisibleActivities.remove(prev)) {
        if (DEBUG_SWITCH || DEBUG_PAUSE)         Slog.v(TAG_PAUSE,"Complete pause, no longer waiting: " + prev);
      }
      if (prev.deferRelaunchUntilPaused) {
        if (DEBUG_PAUSE)         Slog.v(TAG_PAUSE,"Re-launching after pause: " + prev);
        relaunchActivityLocked(prev,prev.configChangeFlags,false,prev.preserveWindowOnDeferredRelaunch);
      }
 else       if (wasStopping) {
        prev.state=ActivityState.STOPPING;
      }
 else       if ((!prev.visible && !hasVisibleBehindActivity()) || mService.isSleepingOrShuttingDown()) {
        addToStopping(prev);
      }
    }
 else {
      if (DEBUG_PAUSE)       Slog.v(TAG_PAUSE,"App died during pause, not stopping: " + prev);
      prev=null;
    }
    prev.stopFreezingScreenLocked(true);
    mPausingActivity=null;
  }
  if (resumeNext) {
    final ActivityStack topStack=mStackSupervisor.getFocusedStack();
    if (!mService.isSleepingOrShuttingDown()) {
      mStackSupervisor.resumeFocusedStackTopActivityLocked(topStack,prev,null);
    }
 else {
      mStackSupervisor.checkReadyForSleepLocked();
      ActivityRecord top=topStack.topRunningActivityLocked();
      if (top == null || (prev != null && top != prev)) {
        mStackSupervisor.resumeFocusedStackTopActivityLocked();
      }
    }
  }
  if (prev != null) {
    prev.resumeKeyDispatchingLocked();
    if (prev.app != null && prev.cpuTimeAtResume > 0 && mService.mBatteryStatsService.isOnBattery()) {
      long diff=mService.mProcessCpuTracker.getCpuTimeForPid(prev.app.pid) - prev.cpuTimeAtResume;
      if (diff > 0) {
        BatteryStatsImpl bsi=mService.mBatteryStatsService.getActiveStatistics();
synchronized (bsi) {
          BatteryStatsImpl.Uid.Proc ps=bsi.getProcessStatsLocked(prev.info.applicationInfo.uid,prev.info.packageName);
          if (ps != null) {
            ps.addForegroundTimeLocked(diff);
          }
        }
      }
    }
    prev.cpuTimeAtResume=0;
  }
  if (mStackSupervisor.mAppVisibilitiesChangedSinceLastPause) {
    mService.notifyTaskStackChangedLocked();
    mStackSupervisor.mAppVisibilitiesChangedSinceLastPause=false;
  }
}
