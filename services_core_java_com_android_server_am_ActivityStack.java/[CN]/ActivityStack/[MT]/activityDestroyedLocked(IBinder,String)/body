{
  final long origId=Binder.clearCallingIdentity();
  try {
    ActivityRecord r=ActivityRecord.forTokenLocked(token);
    if (r != null) {
      mHandler.removeMessages(DESTROY_TIMEOUT_MSG,r);
    }
    if (DEBUG_CONTAINERS)     Slog.d(TAG_CONTAINERS,"activityDestroyedLocked: r=" + r);
    if (isInStackLocked(r) != null) {
      if (r.state == ActivityState.DESTROYING) {
        cleanUpActivityLocked(r,true,false);
        removeActivityFromHistoryLocked(r,null,reason);
      }
    }
    mStackSupervisor.resumeFocusedStackTopActivityLocked();
  }
  finally {
    Binder.restoreCallingIdentity(origId);
  }
}
