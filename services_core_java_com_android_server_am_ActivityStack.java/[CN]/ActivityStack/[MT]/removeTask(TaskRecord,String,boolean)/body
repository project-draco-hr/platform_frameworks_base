{
  mStackSupervisor.endLockTaskModeIfTaskEnding(task);
  if (removeFromWindowManager) {
    mWindowManager.removeTask(task.taskId);
  }
  final ActivityRecord r=mResumedActivity;
  if (r != null && r.task == task) {
    mResumedActivity=null;
  }
  final int taskNdx=mTaskHistory.indexOf(task);
  final int topTaskNdx=mTaskHistory.size() - 1;
  if (task.isOverHomeStack() && taskNdx < topTaskNdx) {
    final TaskRecord nextTask=mTaskHistory.get(taskNdx + 1);
    if (!nextTask.isOverHomeStack()) {
      nextTask.setTaskToReturnTo(HOME_ACTIVITY_TYPE);
    }
  }
  mTaskHistory.remove(task);
  updateTaskMovement(task,true);
  if (task.mActivities.isEmpty()) {
    final boolean isVoiceSession=task.voiceSession != null;
    if (isVoiceSession) {
      try {
        task.voiceSession.taskFinished(task.intent,task.taskId);
      }
 catch (      RemoteException e) {
      }
    }
    if (task.autoRemoveFromRecents() || isVoiceSession) {
      mRecentTasks.remove(task);
      task.removedFromRecents();
    }
  }
  if (mTaskHistory.isEmpty()) {
    if (DEBUG_STACK)     Slog.i(TAG_STACK,"removeTask: removing stack=" + this);
    final boolean notHomeStack=!isHomeStack();
    if (isOnHomeDisplay()) {
      String myReason=reason + " leftTaskHistoryEmpty";
      if (mFullscreen || !adjustFocusToNextVisibleStackLocked(null,myReason)) {
        mStackSupervisor.moveHomeStack(notHomeStack,myReason);
      }
    }
    if (mStacks != null) {
      mStacks.remove(this);
      mStacks.add(0,this);
    }
    if (notHomeStack) {
      mActivityContainer.onTaskListEmptyLocked();
    }
  }
  task.stack=null;
}
