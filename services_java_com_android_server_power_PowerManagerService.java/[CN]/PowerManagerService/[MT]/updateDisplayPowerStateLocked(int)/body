{
  if ((dirty & (DIRTY_WAKE_LOCKS | DIRTY_USER_ACTIVITY | DIRTY_WAKEFULNESS| DIRTY_ACTUAL_DISPLAY_POWER_STATE_UPDATED| DIRTY_BOOT_COMPLETED| DIRTY_SETTINGS)) != 0) {
    int newScreenState=getDesiredScreenPowerState();
    if (newScreenState != mDisplayPowerRequest.screenState) {
      if (newScreenState == DisplayPowerRequest.SCREEN_STATE_OFF && mDisplayPowerRequest.screenState != DisplayPowerRequest.SCREEN_STATE_OFF) {
        mLastScreenOffEventElapsedRealTime=SystemClock.elapsedRealtime();
      }
      mDisplayPowerRequest.screenState=newScreenState;
      nativeSetPowerState(newScreenState != DisplayPowerRequest.SCREEN_STATE_OFF,newScreenState == DisplayPowerRequest.SCREEN_STATE_BRIGHT);
    }
    int screenBrightness=mScreenBrightnessSettingDefault;
    float screenAutoBrightnessAdjustment=0.0f;
    boolean autoBrightness=(mScreenBrightnessModeSetting == Settings.System.SCREEN_BRIGHTNESS_MODE_AUTOMATIC);
    if (isValidBrightness(mScreenBrightnessOverrideFromWindowManager)) {
      screenBrightness=mScreenBrightnessOverrideFromWindowManager;
      autoBrightness=false;
    }
 else     if (isValidBrightness(mTemporaryScreenBrightnessSettingOverride)) {
      screenBrightness=mTemporaryScreenBrightnessSettingOverride;
    }
 else     if (isValidBrightness(mScreenBrightnessSetting)) {
      screenBrightness=mScreenBrightnessSetting;
    }
    if (autoBrightness) {
      screenBrightness=mScreenBrightnessSettingDefault;
      if (isValidAutoBrightnessAdjustment(mTemporaryScreenAutoBrightnessAdjustmentSettingOverride)) {
        screenAutoBrightnessAdjustment=mTemporaryScreenAutoBrightnessAdjustmentSettingOverride;
      }
 else       if (isValidAutoBrightnessAdjustment(mScreenAutoBrightnessAdjustmentSetting)) {
        screenAutoBrightnessAdjustment=mScreenAutoBrightnessAdjustmentSetting;
      }
    }
    screenBrightness=Math.max(Math.min(screenBrightness,mScreenBrightnessSettingMaximum),mScreenBrightnessSettingMinimum);
    screenAutoBrightnessAdjustment=Math.max(Math.min(screenAutoBrightnessAdjustment,1.0f),-1.0f);
    mDisplayPowerRequest.screenBrightness=screenBrightness;
    mDisplayPowerRequest.screenAutoBrightnessAdjustment=screenAutoBrightnessAdjustment;
    mDisplayPowerRequest.useAutoBrightness=autoBrightness;
    mDisplayPowerRequest.useProximitySensor=shouldUseProximitySensorLocked();
    mDisplayReady=mDisplayPowerController.requestPowerState(mDisplayPowerRequest,mRequestWaitForNegativeProximity);
    mRequestWaitForNegativeProximity=false;
    if (DEBUG_SPEW) {
      Slog.d(TAG,"updateScreenStateLocked: displayReady=" + mDisplayReady + ", newScreenState="+ newScreenState+ ", mWakefulness="+ mWakefulness+ ", mWakeLockSummary=0x"+ Integer.toHexString(mWakeLockSummary)+ ", mUserActivitySummary=0x"+ Integer.toHexString(mUserActivitySummary)+ ", mBootCompleted="+ mBootCompleted);
    }
  }
}
