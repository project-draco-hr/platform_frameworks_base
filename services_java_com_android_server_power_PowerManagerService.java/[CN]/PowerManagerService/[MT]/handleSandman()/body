{
  boolean startDreaming=false;
synchronized (mLock) {
    mSandmanScheduled=false;
    boolean canDream=canDreamLocked();
    if (DEBUG_SPEW) {
      Log.d(TAG,"handleSandman: canDream=" + canDream + ", mWakefulness="+ wakefulnessToString(mWakefulness));
    }
    if (canDream && mWakefulness == WAKEFULNESS_NAPPING) {
      startDreaming=true;
    }
  }
  boolean isDreaming=false;
  if (mDreamManager != null) {
    if (startDreaming) {
      mDreamManager.startDream();
    }
    isDreaming=mDreamManager.isDreaming();
  }
  boolean continueDreaming=false;
synchronized (mLock) {
    if (isDreaming && canDreamLocked()) {
      if (mWakefulness == WAKEFULNESS_NAPPING) {
        mWakefulness=WAKEFULNESS_DREAMING;
        mDirty|=DIRTY_WAKEFULNESS;
        updatePowerStateLocked();
        continueDreaming=true;
      }
 else       if (mWakefulness == WAKEFULNESS_DREAMING) {
        continueDreaming=true;
      }
    }
    if (!continueDreaming) {
      handleDreamFinishedLocked();
    }
  }
  if (mDreamManager != null) {
    if (!continueDreaming) {
      mDreamManager.stopDream();
    }
  }
}
