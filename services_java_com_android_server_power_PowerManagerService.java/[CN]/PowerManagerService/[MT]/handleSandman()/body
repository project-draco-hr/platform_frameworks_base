{
  boolean startDreaming=false;
synchronized (mLock) {
    mSandmanScheduled=false;
    boolean canDream=canDreamLocked();
    if (DEBUG_SPEW) {
      Slog.d(TAG,"handleSandman: canDream=" + canDream + ", mWakefulness="+ wakefulnessToString(mWakefulness));
    }
    if (canDream && mWakefulness == WAKEFULNESS_NAPPING) {
      startDreaming=true;
    }
  }
  boolean isDreaming=false;
  if (mDreamManager != null) {
    if (startDreaming) {
      mDreamManager.startDream();
    }
    isDreaming=mDreamManager.isDreaming();
  }
  boolean continueDreaming=false;
synchronized (mLock) {
    if (isDreaming && canDreamLocked()) {
      if (mWakefulness == WAKEFULNESS_NAPPING) {
        mWakefulness=WAKEFULNESS_DREAMING;
        mDirty|=DIRTY_WAKEFULNESS;
        mBatteryLevelWhenDreamStarted=mBatteryLevel;
        updatePowerStateLocked();
        continueDreaming=true;
      }
 else       if (mWakefulness == WAKEFULNESS_DREAMING) {
        if (!isBeingKeptAwakeLocked() && mBatteryLevel < mBatteryLevelWhenDreamStarted - DREAM_BATTERY_LEVEL_DRAIN_CUTOFF) {
          Slog.i(TAG,"Stopping dream because the battery appears to " + "be draining faster than it is charging.  " + "Battery level when dream started: " + mBatteryLevelWhenDreamStarted + "%.  "+ "Battery level now: "+ mBatteryLevel+ "%.");
        }
 else {
          continueDreaming=true;
        }
      }
    }
    if (!continueDreaming) {
      handleDreamFinishedLocked();
    }
  }
  if (mDreamManager != null) {
    if (!continueDreaming) {
      mDreamManager.stopDream();
    }
  }
}
