{
  if (!mSystemReady || mDirty == 0) {
    return;
  }
  if (!Thread.holdsLock(mLock)) {
    Slog.wtf(TAG,"Power manager lock was not held when calling updatePowerStateLocked");
  }
  updateIsPoweredLocked(mDirty);
  updateStayOnLocked(mDirty);
  final long now=SystemClock.uptimeMillis();
  int dirtyPhase2=0;
  for (; ; ) {
    int dirtyPhase1=mDirty;
    dirtyPhase2|=dirtyPhase1;
    mDirty=0;
    updateWakeLockSummaryLocked(dirtyPhase1);
    updateUserActivitySummaryLocked(now,dirtyPhase1);
    if (!updateWakefulnessLocked(dirtyPhase1)) {
      break;
    }
  }
  updateDreamLocked(dirtyPhase2);
  updateDisplayPowerStateLocked(dirtyPhase2);
  if (mDisplayReady) {
    sendPendingNotificationsLocked();
  }
  updateSuspendBlockerLocked();
}
