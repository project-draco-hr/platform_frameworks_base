{
  int brightness=-1;
  if ((state & BATTERY_LOW_BIT) != 0) {
    return state;
  }
  if (!mKeyboardVisible) {
    brightness=0;
  }
 else   if (mButtonBrightnessOverride >= 0) {
    brightness=mButtonBrightnessOverride;
  }
 else   if (mLightSensorKeyboardBrightness >= 0 && mUseSoftwareAutoBrightness) {
    brightness=mLightSensorKeyboardBrightness;
  }
  if (brightness > 0) {
    return state | KEYBOARD_BRIGHT_BIT;
  }
 else   if (brightness == 0) {
    return state & ~KEYBOARD_BRIGHT_BIT;
  }
 else {
    return state;
  }
}
