{
  int err;
  Header header=new Header();
  TreeMap<String,BackupHelper> helpers=(TreeMap<String,BackupHelper>)mHelpers.clone();
  FileDescriptor oldStateFD=null;
  FileDescriptor newStateFD=newState.getFileDescriptor();
  if (oldState != null) {
    oldStateFD=oldState.getFileDescriptor();
    while ((err=readHeader_native(header,oldStateFD)) >= 0) {
      if (err == 0) {
        BackupHelper helper=helpers.get(header.keyPrefix);
        Log.d(TAG,"handling existing helper '" + header.keyPrefix + "' "+ helper);
        if (helper != null) {
          doOneBackup(oldState,data,newState,header,helper);
          helpers.remove(header.keyPrefix);
        }
 else {
          skipChunk_native(oldStateFD,header.chunkSize);
        }
      }
    }
  }
  for (  Map.Entry<String,BackupHelper> entry : helpers.entrySet()) {
    header.keyPrefix=entry.getKey();
    Log.d(TAG,"handling new helper '" + header.keyPrefix + "'");
    BackupHelper helper=entry.getValue();
    doOneBackup(oldState,data,newState,header,helper);
  }
}
