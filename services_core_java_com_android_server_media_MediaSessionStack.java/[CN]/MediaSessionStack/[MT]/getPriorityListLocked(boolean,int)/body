{
  ArrayList<MediaSessionRecord> result=new ArrayList<MediaSessionRecord>();
  int lastLocalIndex=0;
  int lastActiveIndex=0;
  int lastPublishedIndex=0;
  int size=mSessions.size();
  for (int i=0; i < size; i++) {
    final MediaSessionRecord session=mSessions.get(i);
    if ((session.getFlags() & withFlags) != withFlags) {
      continue;
    }
    if (!session.isActive()) {
      if (!activeOnly) {
        result.add(session);
      }
      continue;
    }
    if (session.isSystemPriority()) {
      result.add(0,session);
      lastLocalIndex++;
      lastActiveIndex++;
      lastPublishedIndex++;
    }
 else     if (session.isPlaybackActive()) {
      if (session.getRoute() == null) {
        result.add(lastLocalIndex,session);
        lastLocalIndex++;
        lastActiveIndex++;
        lastPublishedIndex++;
      }
 else {
        result.add(lastActiveIndex,session);
        lastActiveIndex++;
        lastPublishedIndex++;
      }
    }
 else {
      result.add(lastPublishedIndex,session);
      lastPublishedIndex++;
    }
  }
  return result;
}
