{
  WindowState transWin=isStatusBarKeyguard() && !mHideLockScreen ? mStatusBar : mTopFullscreenOpaqueWindowState;
  vis=mStatusBarController.applyTranslucentFlagLw(transWin,vis,oldVis);
  vis=mNavigationBarController.applyTranslucentFlagLw(transWin,vis,oldVis);
  boolean statusBarHasFocus=win.getAttrs().type == TYPE_STATUS_BAR;
  if (statusBarHasFocus && !isStatusBarKeyguard()) {
    int flags=View.SYSTEM_UI_FLAG_FULLSCREEN | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_IMMERSIVE| View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY| View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR;
    if (mHideLockScreen) {
      flags|=View.STATUS_BAR_TRANSLUCENT | View.NAVIGATION_BAR_TRANSLUCENT;
    }
    vis=(vis & ~flags) | (oldVis & flags);
  }
  if (!areTranslucentBarsAllowed() && transWin != mStatusBar) {
    vis&=~(View.NAVIGATION_BAR_TRANSLUCENT | View.STATUS_BAR_TRANSLUCENT | View.SYSTEM_UI_TRANSPARENT);
  }
  boolean immersiveSticky=(vis & View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY) != 0;
  boolean hideStatusBarWM=mTopFullscreenOpaqueWindowState != null && (PolicyControl.getWindowFlags(mTopFullscreenOpaqueWindowState,null) & WindowManager.LayoutParams.FLAG_FULLSCREEN) != 0;
  boolean hideStatusBarSysui=(vis & View.SYSTEM_UI_FLAG_FULLSCREEN) != 0;
  boolean hideNavBarSysui=(vis & View.SYSTEM_UI_FLAG_HIDE_NAVIGATION) != 0;
  boolean transientStatusBarAllowed=mStatusBar != null && (hideStatusBarWM || (hideStatusBarSysui && immersiveSticky) || statusBarHasFocus);
  boolean transientNavBarAllowed=mNavigationBar != null && hideNavBarSysui && immersiveSticky;
  final long now=SystemClock.uptimeMillis();
  final boolean pendingPanic=mPendingPanicGestureUptime != 0 && now - mPendingPanicGestureUptime <= PANIC_GESTURE_EXPIRATION;
  if (pendingPanic && hideNavBarSysui && !isStatusBarKeyguard()&& mKeyguardDrawComplete) {
    mPendingPanicGestureUptime=0;
    mStatusBarController.showTransient();
    mNavigationBarController.showTransient();
  }
  boolean denyTransientStatus=mStatusBarController.isTransientShowRequested() && !transientStatusBarAllowed && hideStatusBarSysui;
  boolean denyTransientNav=mNavigationBarController.isTransientShowRequested() && !transientNavBarAllowed;
  if (denyTransientStatus || denyTransientNav) {
    clearClearableFlagsLw();
    vis&=~View.SYSTEM_UI_CLEARABLE_FLAGS;
  }
  vis=mStatusBarController.updateVisibilityLw(transientStatusBarAllowed,oldVis,vis);
  boolean oldImmersiveMode=isImmersiveMode(oldVis);
  boolean newImmersiveMode=isImmersiveMode(vis);
  if (win != null && oldImmersiveMode != newImmersiveMode) {
    final String pkg=win.getOwningPackage();
    mImmersiveModeConfirmation.immersiveModeChanged(pkg,newImmersiveMode,isUserSetupComplete());
  }
  vis=mNavigationBarController.updateVisibilityLw(transientNavBarAllowed,oldVis,vis);
  return vis;
}
