{
  if (mAvailability != STATE_KEYPHRASE_ENROLLED) {
    return;
  }
  boolean start=(mInternalState & FLAG_REQUESTED) != 0 && (mInternalState & FLAG_CALL_ACTIVE) == 0 && (mInternalState & FLAG_MICROPHONE_OPEN) == 0;
  boolean requested=(mInternalState & FLAG_REQUESTED) != 0;
  if (start && (mInternalState & FLAG_STARTED) == 0) {
    if (DBG)     Slog.d(TAG,"starting recognition...");
    int status=startRecognitionLocked();
    if (status == STATUS_OK) {
      mHandler.sendEmptyMessage(MSG_DETECTION_STARTED);
    }
 else {
      if (DBG)       Slog.d(TAG,"failed to start recognition: " + status);
      mHandler.sendEmptyMessage(MSG_DETECTION_ERROR);
    }
    return;
  }
  if (!start && (mInternalState & FLAG_STARTED) != 0) {
    if (DBG)     Slog.d(TAG,"stopping recognition...");
    int status=stopRecognitionLocked();
    if (status == STATUS_OK) {
      if (!requested)       mHandler.sendEmptyMessage(MSG_DETECTION_STOPPED);
    }
 else {
      if (!requested)       mHandler.sendEmptyMessage(MSG_DETECTION_ERROR);
      if (DBG)       Slog.d(TAG,"failed to stop recognition: " + status);
    }
    return;
  }
}
