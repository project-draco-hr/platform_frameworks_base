{
  int index=0;
  int msgType=(0xFF & pdu[index++]);
  if (msgType != 0) {
    Log.w(TAG,"Received a WAP SMS which is not WDP. Discard.");
    return Intents.RESULT_SMS_HANDLED;
  }
  int totalSegments=(0xFF & pdu[index++]);
  int segment=(0xFF & pdu[index++]);
  if (segment >= totalSegments) {
    Log.e(TAG,"WDP bad segment #" + segment + " expecting 0-"+ (totalSegments - 1));
    return Intents.RESULT_SMS_HANDLED;
  }
  int sourcePort=0;
  int destinationPort=0;
  if (segment == 0) {
    sourcePort=(0xFF & pdu[index++]) << 8;
    sourcePort|=0xFF & pdu[index++];
    destinationPort=(0xFF & pdu[index++]) << 8;
    destinationPort|=0xFF & pdu[index++];
    if (mCheckForDuplicatePortsInOmadmWapPush) {
      if (checkDuplicatePortOmadmWappush(pdu,index)) {
        index=index + 4;
      }
    }
  }
  Log.i(TAG,"Received WAP PDU. Type = " + msgType + ", originator = "+ address+ ", src-port = "+ sourcePort+ ", dst-port = "+ destinationPort+ ", ID = "+ referenceNumber+ ", segment# = "+ segment+ '/'+ totalSegments);
  byte[] userData=new byte[pdu.length - index];
  System.arraycopy(pdu,index,userData,0,pdu.length - index);
  return processMessagePart(userData,address,referenceNumber,segment,totalSegments,0L,destinationPort,true);
}
