{
  if (smsb == null) {
    Log.e(TAG,"dispatchMessage: message is null");
    return Intents.RESULT_SMS_GENERIC_ERROR;
  }
  String inEcm=SystemProperties.get(TelephonyProperties.PROPERTY_INECM_MODE,"false");
  if (inEcm.equals("true")) {
    return Activity.RESULT_OK;
  }
  SmsMessage sms=(SmsMessage)smsb;
  mLastDispatchedSmsFingerprint=sms.getIncomingSmsFingerprint();
  if (mLastAcknowledgedSmsFingerprint != null && Arrays.equals(mLastDispatchedSmsFingerprint,mLastAcknowledgedSmsFingerprint)) {
    return Intents.RESULT_SMS_HANDLED;
  }
  sms.parseSms();
  int teleService=sms.getTeleService();
  boolean handled=false;
  if ((SmsEnvelope.TELESERVICE_VMN == teleService) || (SmsEnvelope.TELESERVICE_MWI == teleService)) {
    int voicemailCount=sms.getNumOfVoicemails();
    Log.d(TAG,"Voicemail count=" + voicemailCount);
    SharedPreferences sp=PreferenceManager.getDefaultSharedPreferences(mPhone.getContext());
    SharedPreferences.Editor editor=sp.edit();
    editor.putInt(CDMAPhone.VM_COUNT_CDMA,voicemailCount);
    editor.commit();
    ((CDMAPhone)mPhone).updateMessageWaitingIndicator(voicemailCount);
    handled=true;
  }
 else   if (((SmsEnvelope.TELESERVICE_WMT == teleService) || (SmsEnvelope.TELESERVICE_WEMT == teleService)) && sms.isStatusReportMessage()) {
    handleCdmaStatusReport(sms);
    handled=true;
  }
 else   if ((sms.getUserData() == null)) {
    if (Config.LOGD) {
      Log.d(TAG,"Received SMS without user data");
    }
    handled=true;
  }
  if (handled) {
    return Intents.RESULT_SMS_HANDLED;
  }
  if (!mStorageAvailable && (sms.getMessageClass() != MessageClass.CLASS_0)) {
    return Intents.RESULT_SMS_OUT_OF_MEMORY;
  }
  if (SmsEnvelope.TELESERVICE_WAP == teleService) {
    return processCdmaWapPdu(sms.getUserData(),sms.messageRef,sms.getOriginatingAddress());
  }
  if ((SmsEnvelope.TELESERVICE_WMT != teleService) && (SmsEnvelope.TELESERVICE_WEMT != teleService) && (SmsEnvelope.MESSAGE_TYPE_BROADCAST != sms.getMessageType())) {
    return Intents.RESULT_SMS_UNSUPPORTED;
  }
  SmsHeader smsHeader=sms.getUserDataHeader();
  if ((smsHeader == null) || (smsHeader.concatRef == null)) {
    byte[][] pdus=new byte[1][];
    pdus[0]=sms.getPdu();
    if (smsHeader != null && smsHeader.portAddrs != null) {
      if (smsHeader.portAddrs.destPort == SmsHeader.PORT_WAP_PUSH) {
        return mWapPush.dispatchWapPdu(sms.getUserData());
      }
 else {
        dispatchPortAddressedPdus(pdus,smsHeader.portAddrs.destPort);
      }
    }
 else {
      dispatchPdus(pdus);
    }
    return Activity.RESULT_OK;
  }
 else {
    return processMessagePart(sms,smsHeader.concatRef,smsHeader.portAddrs);
  }
}
