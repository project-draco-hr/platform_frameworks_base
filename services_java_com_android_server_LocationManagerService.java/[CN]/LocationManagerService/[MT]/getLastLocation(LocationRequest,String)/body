{
  if (D)   Log.d(TAG,"getLastLocation: " + request);
  if (request == null)   request=DEFAULT_LOCATION_REQUEST;
  String perm=checkPermissionAndRequest(request);
  checkPackageName(packageName);
  if (mBlacklist.isBlacklisted(packageName)) {
    if (D)     Log.d(TAG,"not returning last loc for blacklisted app: " + packageName);
    return null;
  }
synchronized (mLock) {
    String name=request.getProvider();
    if (name == null)     name=LocationManager.FUSED_PROVIDER;
    LocationProviderInterface provider=mProvidersByName.get(name);
    if (provider == null)     return null;
    if (!isAllowedBySettingsLocked(name))     return null;
    Location location=mLastLocation.get(name);
    if (location == null) {
      return null;
    }
    if (ACCESS_FINE_LOCATION.equals(perm)) {
      return location;
    }
 else {
      Location noGPSLocation=location.getExtraLocation(Location.EXTRA_NO_GPS_LOCATION);
      if (noGPSLocation != null) {
        return mLocationFudger.getOrCreate(noGPSLocation);
      }
    }
  }
  return null;
}
