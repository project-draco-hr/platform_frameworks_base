{
  mPendingLayoutChanges=0;
  mCurrentTime=SystemClock.uptimeMillis();
  mBulkUpdateParams=0;
  Surface.openTransaction();
  try {
    testWallpaperAndBackgroundLocked();
    updateWindowsAppsAndRotationAnimationsLocked();
    performAnimationsLocked();
    if (mScreenRotationAnimation != null) {
      mScreenRotationAnimation.updateSurfaces();
    }
    mFinished.clear();
    for (    final WindowStateAnimator winAnimator : mWinAnimators) {
      if (winAnimator.mSurface == null) {
        mFinished.add(winAnimator);
      }
 else {
        winAnimator.prepareSurfaceLocked(true);
      }
    }
    for (    final WindowStateAnimator winAnimator : mFinished) {
      mWinAnimators.remove(winAnimator);
    }
    if (mDimParams != null) {
      mDimAnimator.updateParameters(mContext.getResources(),mDimParams,mCurrentTime);
    }
    if (mDimAnimator != null && mDimAnimator.mDimShown) {
      mAnimating|=mDimAnimator.updateSurface(isDimming(),mCurrentTime,!mService.okToDisplay());
    }
    if (mService.mBlackFrame != null) {
      if (mScreenRotationAnimation != null) {
        mService.mBlackFrame.setMatrix(mScreenRotationAnimation.getEnterTransformation().getMatrix());
      }
 else {
        mService.mBlackFrame.clearMatrix();
      }
    }
  }
 catch (  RuntimeException e) {
    Log.wtf(TAG,"Unhandled exception in Window Manager",e);
  }
 finally {
    Surface.closeTransaction();
  }
  mService.bulkSetParameters(mBulkUpdateParams);
}
