{
  mPendingLayoutChanges=0;
  mCurrentTime=SystemClock.uptimeMillis();
  Surface.openTransaction();
  try {
    updateWindowsAppsAndRotationAnimationsLocked();
    performAnimationsLocked();
    if (mScreenRotationAnimation != null) {
      mScreenRotationAnimation.updateSurfaces();
    }
    final int N=mService.mWindows.size();
    for (int i=N - 1; i >= 0; i--) {
      WindowState w=mService.mWindows.get(i);
      prepareSurfaceLocked(w,true);
    }
    if (mService.mDimAnimator != null && mService.mDimAnimator.mDimShown) {
      mAnimating|=mService.mDimAnimator.updateSurface(mService.mInnerFields.mDimming,mCurrentTime,!mService.okToDisplay());
    }
    if (mService.mBlackFrame != null) {
      if (mScreenRotationAnimation != null) {
        mService.mBlackFrame.setMatrix(mScreenRotationAnimation.getEnterTransformation().getMatrix());
      }
 else {
        mService.mBlackFrame.clearMatrix();
      }
    }
  }
 catch (  RuntimeException e) {
    Log.wtf(TAG,"Unhandled exception in Window Manager",e);
  }
 finally {
    Surface.closeTransaction();
  }
}
