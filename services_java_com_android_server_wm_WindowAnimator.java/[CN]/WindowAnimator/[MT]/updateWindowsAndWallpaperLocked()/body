{
  ++mTransactionSequence;
  ArrayList<WindowStateAnimator> unForceHiding=null;
  boolean wallpaperInUnForceHiding=false;
  for (int i=mService.mWindows.size() - 1; i >= 0; i--) {
    WindowState win=mService.mWindows.get(i);
    WindowStateAnimator winAnimator=win.mWinAnimator;
    final int flags=winAnimator.mAttrFlags;
    if (winAnimator.mSurface != null) {
      final boolean wasAnimating=winAnimator.mWasAnimating;
      final boolean nowAnimating=winAnimator.stepAnimationLocked(mCurrentTime);
      if (WindowManagerService.DEBUG_WALLPAPER) {
        Slog.v(TAG,win + ": wasAnimating=" + wasAnimating+ ", nowAnimating="+ nowAnimating);
      }
      if (nowAnimating) {
        if (winAnimator.mAnimation != null) {
          if ((flags & FLAG_SHOW_WALLPAPER) != 0 && winAnimator.mAnimation.getDetachWallpaper()) {
            mDetachedWallpaper=win;
          }
          final int backgroundColor=winAnimator.mAnimation.getBackgroundColor();
          if (backgroundColor != 0) {
            if (mWindowAnimationBackground == null || (winAnimator.mAnimLayer < mWindowAnimationBackground.mWinAnimator.mAnimLayer)) {
              mWindowAnimationBackground=win;
              mWindowAnimationBackgroundColor=backgroundColor;
            }
          }
        }
        mAnimating=true;
      }
      final AppWindowAnimator appAnimator=win.mAppToken == null ? null : win.mAppToken.mAppAnimator;
      if (appAnimator != null && appAnimator.animation != null && appAnimator.animating) {
        if ((flags & FLAG_SHOW_WALLPAPER) != 0 && appAnimator.animation.getDetachWallpaper()) {
          mDetachedWallpaper=win;
        }
        final int backgroundColor=appAnimator.animation.getBackgroundColor();
        if (backgroundColor != 0) {
          if (mWindowAnimationBackground == null || (winAnimator.mAnimLayer < mWindowAnimationBackground.mWinAnimator.mAnimLayer)) {
            mWindowAnimationBackground=win;
            mWindowAnimationBackgroundColor=backgroundColor;
          }
        }
      }
      if (wasAnimating && !winAnimator.mAnimating && mService.mWallpaperTarget == win) {
        mBulkUpdateParams|=SET_WALLPAPER_MAY_CHANGE;
        mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
        if (WindowManagerService.DEBUG_LAYOUT_REPEATS) {
          mService.debugLayoutRepeats("updateWindowsAndWallpaperLocked 2",mPendingLayoutChanges);
        }
      }
      if (mPolicy.doesForceHide(win,win.mAttrs)) {
        if (!wasAnimating && nowAnimating) {
          if (WindowManagerService.DEBUG_VISIBILITY)           Slog.v(TAG,"Animation started that could impact force hide: " + win);
          mBulkUpdateParams|=SET_FORCE_HIDING_CHANGED;
          mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
          if (WindowManagerService.DEBUG_LAYOUT_REPEATS) {
            mService.debugLayoutRepeats("updateWindowsAndWallpaperLocked 3",mPendingLayoutChanges);
          }
          mService.mFocusMayChange=true;
        }
 else         if (win.isReadyForDisplay() && winAnimator.mAnimation == null) {
          mForceHiding=true;
        }
      }
 else       if (mPolicy.canBeForceHidden(win,win.mAttrs)) {
        final boolean changed;
        if (mForceHiding) {
          changed=win.hideLw(false,false);
          if (WindowManagerService.DEBUG_VISIBILITY && changed)           Slog.v(TAG,"Now policy hidden: " + win);
        }
 else {
          changed=win.showLw(false,false);
          if (WindowManagerService.DEBUG_VISIBILITY && changed)           Slog.v(TAG,"Now policy shown: " + win);
          if (changed) {
            if ((mBulkUpdateParams & SET_FORCE_HIDING_CHANGED) != 0 && win.isVisibleNow()) {
              if (unForceHiding == null) {
                unForceHiding=new ArrayList<WindowStateAnimator>();
              }
              unForceHiding.add(winAnimator);
              if ((win.mAttrs.flags & WindowManager.LayoutParams.FLAG_SHOW_WALLPAPER) != 0) {
                wallpaperInUnForceHiding=true;
              }
            }
            if (mCurrentFocus == null || mCurrentFocus.mLayer < win.mLayer) {
              mService.mFocusMayChange=true;
            }
          }
        }
        if (changed && (flags & WindowManager.LayoutParams.FLAG_SHOW_WALLPAPER) != 0) {
          mBulkUpdateParams|=SET_WALLPAPER_MAY_CHANGE;
          mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
          if (WindowManagerService.DEBUG_LAYOUT_REPEATS) {
            mService.debugLayoutRepeats("updateWindowsAndWallpaperLocked 4",mPendingLayoutChanges);
          }
        }
      }
    }
    final AppWindowToken atoken=win.mAppToken;
    if (atoken != null && (!atoken.allDrawn || atoken.mAppAnimator.freezingScreen)) {
      if (atoken.lastTransactionSequence != mTransactionSequence) {
        atoken.lastTransactionSequence=mTransactionSequence;
        atoken.numInterestingWindows=atoken.numDrawnWindows=0;
        atoken.startingDisplayed=false;
      }
      if ((win.isOnScreen() || winAnimator.mAttrType == WindowManager.LayoutParams.TYPE_BASE_APPLICATION) && !win.mExiting && !win.mDestroying) {
        if (WindowManagerService.DEBUG_VISIBILITY || WindowManagerService.DEBUG_ORIENTATION) {
          Slog.v(TAG,"Eval win " + win + ": isDrawn="+ win.isDrawnLw()+ ", isAnimating="+ winAnimator.isAnimating());
          if (!win.isDrawnLw()) {
            Slog.v(TAG,"Not displayed: s=" + winAnimator.mSurface + " pv="+ win.mPolicyVisibility+ " mDrawState="+ winAnimator.mDrawState+ " ah="+ win.mAttachedHidden+ " th="+ atoken.hiddenRequested+ " a="+ winAnimator.mAnimating);
          }
        }
        if (win != atoken.startingWindow) {
          if (!atoken.mAppAnimator.freezingScreen || !win.mAppFreezing) {
            atoken.numInterestingWindows++;
            if (win.isDrawnLw()) {
              atoken.numDrawnWindows++;
              if (WindowManagerService.DEBUG_VISIBILITY || WindowManagerService.DEBUG_ORIENTATION)               Slog.v(TAG,"tokenMayBeDrawn: " + atoken + " freezingScreen="+ atoken.mAppAnimator.freezingScreen+ " mAppFreezing="+ win.mAppFreezing);
              mTokenMayBeDrawn=true;
            }
          }
        }
 else         if (win.isDrawnLw()) {
          atoken.startingDisplayed=true;
        }
      }
    }
 else     if (winAnimator.mDrawState == WindowStateAnimator.READY_TO_SHOW) {
      if (winAnimator.performShowLocked()) {
        mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_ANIM;
        if (WindowManagerService.DEBUG_LAYOUT_REPEATS) {
          mService.debugLayoutRepeats("updateWindowsAndWallpaperLocked 5",mPendingLayoutChanges);
        }
      }
    }
    final AppWindowAnimator appAnimator=atoken == null ? null : atoken.mAppAnimator;
    if (appAnimator != null && appAnimator.thumbnail != null) {
      if (appAnimator.thumbnailTransactionSeq != mTransactionSequence) {
        appAnimator.thumbnailTransactionSeq=mTransactionSequence;
        appAnimator.thumbnailLayer=0;
      }
      if (appAnimator.thumbnailLayer < winAnimator.mAnimLayer) {
        appAnimator.thumbnailLayer=winAnimator.mAnimLayer;
      }
    }
  }
  if (unForceHiding != null) {
    for (int i=unForceHiding.size() - 1; i >= 0; i--) {
      Animation a=mPolicy.createForceHideEnterAnimation(wallpaperInUnForceHiding);
      if (a != null) {
        final WindowStateAnimator winAnimator=unForceHiding.get(i);
        winAnimator.setAnimation(a);
        winAnimator.mAnimationIsEntrance=true;
      }
    }
  }
}
