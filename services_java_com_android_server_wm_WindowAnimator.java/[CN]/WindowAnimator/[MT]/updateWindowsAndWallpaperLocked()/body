{
  ++mTransactionSequence;
  for (int i=mService.mWindows.size() - 1; i >= 0; i--) {
    WindowState w=mService.mWindows.get(i);
    final WindowManager.LayoutParams attrs=w.mAttrs;
    if (w.mSurface != null) {
      if (w.commitFinishDrawingLocked(mCurrentTime)) {
        if ((w.mAttrs.flags & WindowManager.LayoutParams.FLAG_SHOW_WALLPAPER) != 0) {
          if (WindowManagerService.DEBUG_WALLPAPER)           Slog.v(TAG,"First draw done in potential wallpaper target " + w);
          mService.mInnerFields.mWallpaperMayChange=true;
          mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
        }
      }
      if (w.shouldAnimateMove()) {
        Animation a=AnimationUtils.loadAnimation(mContext,com.android.internal.R.anim.window_move_from_decor);
        w.setAnimation(a);
        w.mAnimDw=w.mLastFrame.left - w.mFrame.left;
        w.mAnimDh=w.mLastFrame.top - w.mFrame.top;
      }
 else {
        w.mAnimDw=mInnerDw;
        w.mAnimDh=mInnerDh;
      }
      final boolean wasAnimating=w.mWasAnimating;
      final boolean nowAnimating=w.stepAnimationLocked(mCurrentTime);
      if (WindowManagerService.DEBUG_WALLPAPER) {
        Slog.v(TAG,w + ": wasAnimating=" + wasAnimating+ ", nowAnimating="+ nowAnimating);
      }
      if (nowAnimating) {
        if (w.mAnimation != null) {
          if ((w.mAttrs.flags & FLAG_SHOW_WALLPAPER) != 0 && w.mAnimation.getDetachWallpaper()) {
            mService.mInnerFields.mDetachedWallpaper=w;
          }
          if (w.mAnimation.getBackgroundColor() != 0) {
            if (mWindowAnimationBackground == null || (w.mAnimLayer < mWindowAnimationBackground.mAnimLayer)) {
              mWindowAnimationBackground=w;
              mWindowAnimationBackgroundColor=w.mAnimation.getBackgroundColor();
            }
          }
        }
        mAnimating=true;
      }
      if (w.mAppToken != null && w.mAppToken.animation != null && w.mAppToken.animating) {
        if ((w.mAttrs.flags & FLAG_SHOW_WALLPAPER) != 0 && w.mAppToken.animation.getDetachWallpaper()) {
          mService.mInnerFields.mDetachedWallpaper=w;
        }
        if (w.mAppToken.animation.getBackgroundColor() != 0) {
          if (mWindowAnimationBackground == null || (w.mAnimLayer < mWindowAnimationBackground.mAnimLayer)) {
            mWindowAnimationBackground=w;
            mWindowAnimationBackgroundColor=w.mAppToken.animation.getBackgroundColor();
          }
        }
      }
      if (wasAnimating && !w.mAnimating && mService.mWallpaperTarget == w) {
        mService.mInnerFields.mWallpaperMayChange=true;
        mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
      }
      if (mPolicy.doesForceHide(w,attrs)) {
        if (!wasAnimating && nowAnimating) {
          if (WindowManagerService.DEBUG_VISIBILITY)           Slog.v(TAG,"Animation started that could impact force hide: " + w);
          mService.mInnerFields.mWallpaperForceHidingChanged=true;
          mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
          mService.mFocusMayChange=true;
        }
 else         if (w.isReadyForDisplay() && w.mAnimation == null) {
          mForceHiding=true;
        }
      }
 else       if (mPolicy.canBeForceHidden(w,attrs)) {
        boolean changed;
        if (mForceHiding) {
          changed=w.hideLw(false,false);
          if (WindowManagerService.DEBUG_VISIBILITY && changed)           Slog.v(TAG,"Now policy hidden: " + w);
        }
 else {
          changed=w.showLw(false,false);
          if (WindowManagerService.DEBUG_VISIBILITY && changed)           Slog.v(TAG,"Now policy shown: " + w);
          if (changed) {
            if (mService.mInnerFields.mWallpaperForceHidingChanged && w.isVisibleNow()) {
              Animation a=mPolicy.createForceHideEnterAnimation();
              if (a != null) {
                w.setAnimation(a);
              }
            }
            if (mCurrentFocus == null || mCurrentFocus.mLayer < w.mLayer) {
              mService.mFocusMayChange=true;
            }
          }
        }
        if (changed && (attrs.flags & WindowManager.LayoutParams.FLAG_SHOW_WALLPAPER) != 0) {
          mService.mInnerFields.mWallpaperMayChange=true;
          mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
        }
      }
    }
    final AppWindowToken atoken=w.mAppToken;
    if (atoken != null && (!atoken.allDrawn || atoken.freezingScreen)) {
      if (atoken.lastTransactionSequence != mTransactionSequence) {
        atoken.lastTransactionSequence=mTransactionSequence;
        atoken.numInterestingWindows=atoken.numDrawnWindows=0;
        atoken.startingDisplayed=false;
      }
      if ((w.isOnScreen() || w.mAttrs.type == WindowManager.LayoutParams.TYPE_BASE_APPLICATION) && !w.mExiting && !w.mDestroying) {
        if (WindowManagerService.DEBUG_VISIBILITY || WindowManagerService.DEBUG_ORIENTATION) {
          Slog.v(TAG,"Eval win " + w + ": isDrawn="+ w.isDrawnLw()+ ", isAnimating="+ w.isAnimating());
          if (!w.isDrawnLw()) {
            Slog.v(TAG,"Not displayed: s=" + w.mSurface + " pv="+ w.mPolicyVisibility+ " dp="+ w.mDrawPending+ " cdp="+ w.mCommitDrawPending+ " ah="+ w.mAttachedHidden+ " th="+ atoken.hiddenRequested+ " a="+ w.mAnimating);
          }
        }
        if (w != atoken.startingWindow) {
          if (!atoken.freezingScreen || !w.mAppFreezing) {
            atoken.numInterestingWindows++;
            if (w.isDrawnLw()) {
              atoken.numDrawnWindows++;
              if (WindowManagerService.DEBUG_VISIBILITY || WindowManagerService.DEBUG_ORIENTATION)               Slog.v(TAG,"tokenMayBeDrawn: " + atoken + " freezingScreen="+ atoken.freezingScreen+ " mAppFreezing="+ w.mAppFreezing);
              mTokenMayBeDrawn=true;
            }
          }
        }
 else         if (w.isDrawnLw()) {
          atoken.startingDisplayed=true;
        }
      }
    }
 else     if (w.mReadyToShow) {
      w.performShowLocked();
      mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_ANIM;
    }
    if (atoken != null && atoken.thumbnail != null) {
      if (atoken.thumbnailTransactionSeq != mTransactionSequence) {
        atoken.thumbnailTransactionSeq=mTransactionSequence;
        atoken.thumbnailLayer=0;
      }
      if (atoken.thumbnailLayer < w.mAnimLayer) {
        atoken.thumbnailLayer=w.mAnimLayer;
      }
    }
  }
}
