{
  final DisplayContentsAnimator displayAnimator=getDisplayContentsAnimatorLocked(displayId);
  final WindowList windows=mService.getWindowListLocked(displayId);
  WindowStateAnimator windowAnimationBackground=null;
  int windowAnimationBackgroundColor=0;
  WindowState detachedWallpaper=null;
  for (int i=windows.size() - 1; i >= 0; i--) {
    final WindowState win=windows.get(i);
    WindowStateAnimator winAnimator=win.mWinAnimator;
    if (winAnimator.mSurface == null) {
      continue;
    }
    final int flags=winAnimator.mAttrFlags;
    if (winAnimator.mAnimating) {
      if (winAnimator.mAnimation != null) {
        if ((flags & FLAG_SHOW_WALLPAPER) != 0 && winAnimator.mAnimation.getDetachWallpaper()) {
          detachedWallpaper=win;
        }
        final int backgroundColor=winAnimator.mAnimation.getBackgroundColor();
        if (backgroundColor != 0) {
          if (windowAnimationBackground == null || (winAnimator.mAnimLayer < windowAnimationBackground.mAnimLayer)) {
            windowAnimationBackground=winAnimator;
            windowAnimationBackgroundColor=backgroundColor;
          }
        }
      }
      mAnimating=true;
    }
    final AppWindowAnimator appAnimator=winAnimator.mAppAnimator;
    if (appAnimator != null && appAnimator.animation != null && appAnimator.animating) {
      if ((flags & FLAG_SHOW_WALLPAPER) != 0 && appAnimator.animation.getDetachWallpaper()) {
        detachedWallpaper=win;
      }
      final int backgroundColor=appAnimator.animation.getBackgroundColor();
      if (backgroundColor != 0) {
        if (windowAnimationBackground == null || (winAnimator.mAnimLayer < windowAnimationBackground.mAnimLayer)) {
          windowAnimationBackground=winAnimator;
          windowAnimationBackgroundColor=backgroundColor;
        }
      }
    }
  }
  if (mWindowDetachedWallpaper != detachedWallpaper) {
    if (WindowManagerService.DEBUG_WALLPAPER)     Slog.v(TAG,"Detached wallpaper changed from " + mWindowDetachedWallpaper + " to "+ detachedWallpaper);
    mWindowDetachedWallpaper=detachedWallpaper;
    mBulkUpdateParams|=SET_WALLPAPER_MAY_CHANGE;
  }
  if (windowAnimationBackgroundColor != 0) {
    int animLayer=windowAnimationBackground.mAnimLayer;
    WindowState win=windowAnimationBackground.mWin;
    if (mService.mWallpaperTarget == win || mService.mLowerWallpaperTarget == win || mService.mUpperWallpaperTarget == win) {
      final int N=windows.size();
      for (int i=0; i < N; i++) {
        WindowStateAnimator winAnimator=windows.get(i).mWinAnimator;
        if (winAnimator.mIsWallpaper) {
          animLayer=winAnimator.mAnimLayer;
          break;
        }
      }
    }
    displayAnimator.mWindowAnimationBackgroundSurface.show(animLayer - WindowManagerService.LAYER_OFFSET_DIM,((windowAnimationBackgroundColor >> 24) & 0xff) / 255f,0);
  }
 else {
    displayAnimator.mWindowAnimationBackgroundSurface.hide();
  }
}
