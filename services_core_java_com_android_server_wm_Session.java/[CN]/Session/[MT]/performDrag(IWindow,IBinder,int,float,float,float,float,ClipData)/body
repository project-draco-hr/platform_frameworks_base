{
  if (DEBUG_DRAG) {
    Slog.d(TAG_WM,"perform drag: win=" + window + " data="+ data);
  }
synchronized (mService.mWindowMap) {
    if (mService.mDragState == null) {
      Slog.w(TAG_WM,"No drag prepared");
      throw new IllegalStateException("performDrag() without prepareDrag()");
    }
    if (dragToken != mService.mDragState.mToken) {
      Slog.w(TAG_WM,"Performing mismatched drag");
      throw new IllegalStateException("performDrag() does not match prepareDrag()");
    }
    WindowState callingWin=mService.windowForClientLocked(null,window,false);
    if (callingWin == null) {
      Slog.w(TAG_WM,"Bad requesting window " + window);
      return false;
    }
    mService.mH.removeMessages(H.DRAG_START_TIMEOUT,window.asBinder());
    final DisplayContent displayContent=callingWin.getDisplayContent();
    if (displayContent == null) {
      return false;
    }
    Display display=displayContent.getDisplay();
    mService.mDragState.register(display);
    mService.mInputMonitor.updateInputWindowsLw(true);
    if (!mService.mInputManager.transferTouchFocus(callingWin.mInputChannel,mService.mDragState.mServerChannel)) {
      Slog.e(TAG_WM,"Unable to transfer touch focus");
      mService.mDragState.unregister();
      mService.mDragState=null;
      mService.mInputMonitor.updateInputWindowsLw(true);
      return false;
    }
    mService.mDragState.mData=data;
    mService.mDragState.broadcastDragStartedLw(touchX,touchY);
    mService.mDragState.overridePointerIconLw(touchSource);
    mService.mDragState.mThumbOffsetX=thumbCenterX;
    mService.mDragState.mThumbOffsetY=thumbCenterY;
    final SurfaceControl surfaceControl=mService.mDragState.mSurfaceControl;
    if (SHOW_LIGHT_TRANSACTIONS)     Slog.i(TAG_WM,">>> OPEN TRANSACTION performDrag");
    SurfaceControl.openTransaction();
    try {
      surfaceControl.setPosition(touchX - thumbCenterX,touchY - thumbCenterY);
      surfaceControl.setLayer(mService.mDragState.getDragLayerLw());
      surfaceControl.setLayerStack(display.getLayerStack());
      surfaceControl.show();
    }
  finally {
      SurfaceControl.closeTransaction();
      if (SHOW_LIGHT_TRANSACTIONS)       Slog.i(TAG_WM,"<<< CLOSE TRANSACTION performDrag");
    }
    mService.mDragState.notifyLocationLw(touchX,touchY);
  }
  return true;
}
