{
  if (DEBUG)   Slog.d(TAG,"updateWifiState: " + intent);
  final String action=intent.getAction();
  final boolean wasConnected=mWifiConnected;
  if (action.equals(WifiManager.WIFI_STATE_CHANGED_ACTION)) {
    mWifiEnabled=intent.getIntExtra(WifiManager.EXTRA_WIFI_STATE,WifiManager.WIFI_STATE_UNKNOWN) == WifiManager.WIFI_STATE_ENABLED;
  }
 else   if (action.equals(WifiManager.NETWORK_STATE_CHANGED_ACTION)) {
    final NetworkInfo networkInfo=(NetworkInfo)intent.getParcelableExtra(WifiManager.EXTRA_NETWORK_INFO);
    mWifiConnected=networkInfo != null && networkInfo.isConnected();
  }
 else   if (action.equals(WifiManager.SUPPLICANT_STATE_CHANGED_ACTION)) {
    final NetworkInfo.DetailedState detailedState=WifiInfo.getDetailedStateOf((SupplicantState)intent.getParcelableExtra(WifiManager.EXTRA_NEW_STATE));
    mWifiConnected=detailedState == NetworkInfo.DetailedState.CONNECTED;
  }
 else   if (action.equals(WifiManager.RSSI_CHANGED_ACTION)) {
    final int newRssi=intent.getIntExtra(WifiManager.EXTRA_NEW_RSSI,-200);
    int newSignalLevel=WifiManager.calculateSignalLevel(newRssi,6) * 20;
    mWifiLevel=mWifiConnected ? newSignalLevel : 0;
  }
  if (mWifiConnected && !wasConnected) {
    WifiInfo info=mWifiManager.getConnectionInfo();
    if (DEBUG)     Slog.d(TAG,"updateWifiState: just connected: info=" + info);
    if (info != null) {
      mWifiLevel=WifiManager.calculateSignalLevel(info.getRssi(),101);
      mWifiSsid=info.getSSID();
      if (mWifiSsid == null) {
        List<WifiConfiguration> networks=mWifiManager.getConfiguredNetworks();
        for (        WifiConfiguration net : networks) {
          if (net.networkId == info.getNetworkId()) {
            mWifiSsid=net.SSID;
            break;
          }
        }
      }
    }
  }
  refreshSignalMeters();
}
