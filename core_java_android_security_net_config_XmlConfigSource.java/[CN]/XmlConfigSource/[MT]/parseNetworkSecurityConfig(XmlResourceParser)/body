{
  Set<String> seenDomains=new ArraySet<>();
  List<Pair<NetworkSecurityConfig.Builder,Set<Domain>>> builders=new ArrayList<>();
  NetworkSecurityConfig.Builder baseConfigBuilder=null;
  boolean seenDebugOverrides=false;
  boolean seenBaseConfig=false;
  XmlUtils.beginDocument(parser,"network-security-config");
  int outerDepth=parser.getDepth();
  while (XmlUtils.nextElementWithin(parser,outerDepth)) {
    if ("base-config".equals(parser.getName())) {
      if (seenBaseConfig) {
        throw new ParserException(parser,"Only one base-config allowed");
      }
      seenBaseConfig=true;
      baseConfigBuilder=parseConfigEntry(parser,seenDomains,null,true).get(0).first;
    }
 else     if ("domain-config".equals(parser.getName())) {
      builders.addAll(parseConfigEntry(parser,seenDomains,baseConfigBuilder,false));
    }
 else {
      XmlUtils.skipCurrentTag(parser);
    }
  }
  NetworkSecurityConfig.Builder platformDefaultBuilder=NetworkSecurityConfig.getDefaultBuilder();
  if (baseConfigBuilder != null) {
    baseConfigBuilder.setParent(platformDefaultBuilder);
  }
 else {
    baseConfigBuilder=platformDefaultBuilder;
  }
  Set<Pair<Domain,NetworkSecurityConfig>> configs=new ArraySet<>();
  for (  Pair<NetworkSecurityConfig.Builder,Set<Domain>> entry : builders) {
    NetworkSecurityConfig.Builder builder=entry.first;
    Set<Domain> domains=entry.second;
    if (builder.getParent() == null) {
      builder.setParent(baseConfigBuilder);
    }
    NetworkSecurityConfig config=builder.build();
    for (    Domain domain : domains) {
      configs.add(new Pair<>(domain,config));
    }
  }
  mDefaultConfig=baseConfigBuilder.build();
  mDomainMap=configs;
}
