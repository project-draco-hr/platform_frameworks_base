{
  assert(offset >= 0 && count >= 0 && offset + count <= msg.length);
synchronized (mBuffer) {
    try {
      while (count > 0) {
        int length=packMessage(msg,offset,count,timestamp,mBuffer);
        mOutputStream.write(mBuffer,0,length);
        int sent=getMessageSize(mBuffer,length);
        assert(sent >= 0 && sent <= length);
        offset+=sent;
        count-=sent;
      }
    }
 catch (    IOException e) {
      IoUtils.closeQuietly(mOutputStream);
      onIOException();
      throw e;
    }
  }
}
