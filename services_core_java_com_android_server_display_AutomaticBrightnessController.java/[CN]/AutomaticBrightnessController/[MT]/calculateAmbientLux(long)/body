{
  final int N=mAmbientLightRingBuffer.size();
  if (N == 0) {
    Slog.e(TAG,"calculateAmbientLux: No ambient light readings available");
    return -1;
  }
  float sum=0;
  float totalWeight=0;
  long endTime=AMBIENT_LIGHT_PREDICTION_TIME_MILLIS;
  for (int i=N - 1; i >= 0; i--) {
    long startTime=(mAmbientLightRingBuffer.getTime(i) - now);
    float weight=calculateWeight(startTime,endTime);
    float lux=mAmbientLightRingBuffer.getLux(i);
    if (DEBUG) {
      Slog.d(TAG,"calculateAmbientLux: [" + (startTime) + ", "+ (endTime)+ "]: lux="+ lux+ ", weight="+ weight);
    }
    totalWeight+=weight;
    sum+=mAmbientLightRingBuffer.getLux(i) * weight;
    endTime=startTime;
  }
  if (DEBUG) {
    Slog.d(TAG,"calculateAmbientLux: totalWeight=" + totalWeight + ", newAmbientLux="+ (sum / totalWeight));
  }
  return sum / totalWeight;
}
