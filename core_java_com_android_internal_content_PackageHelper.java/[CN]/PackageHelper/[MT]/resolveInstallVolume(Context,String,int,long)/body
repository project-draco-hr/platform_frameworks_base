{
  final boolean forceAllowOnExternal=Settings.Global.getInt(context.getContentResolver(),Settings.Global.FORCE_ALLOW_ON_EXTERNAL,0) != 0;
  ApplicationInfo existingInfo=null;
  try {
    existingInfo=context.getPackageManager().getApplicationInfo(packageName,PackageManager.GET_UNINSTALLED_PACKAGES);
  }
 catch (  NameNotFoundException ignored) {
  }
  final StorageManager storageManager=context.getSystemService(StorageManager.class);
  final boolean fitsOnInternal=fitsOnInternal(context,sizeBytes);
  final ArraySet<String> allCandidates=new ArraySet<>();
  VolumeInfo bestCandidate=null;
  long bestCandidateAvailBytes=Long.MIN_VALUE;
  for (  VolumeInfo vol : storageManager.getVolumes()) {
    if (vol.type == VolumeInfo.TYPE_PRIVATE && vol.isMountedWritable()) {
      final long availBytes=storageManager.getStorageBytesUntilLow(new File(vol.path));
      if (availBytes >= sizeBytes) {
        allCandidates.add(vol.fsUuid);
      }
      if (availBytes >= bestCandidateAvailBytes) {
        bestCandidate=vol;
        bestCandidateAvailBytes=availBytes;
      }
    }
  }
  if (existingInfo != null && existingInfo.isSystemApp()) {
    installLocation=PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY;
  }
  if (!forceAllowOnExternal && installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY) {
    if (existingInfo != null && !Objects.equals(existingInfo.volumeUuid,StorageManager.UUID_PRIVATE_INTERNAL)) {
      throw new IOException("Cannot automatically move " + packageName + " from "+ existingInfo.volumeUuid+ " to internal storage");
    }
    if (fitsOnInternal) {
      return StorageManager.UUID_PRIVATE_INTERNAL;
    }
 else {
      throw new IOException("Requested internal only, but not enough space");
    }
  }
  if (existingInfo != null) {
    if (Objects.equals(existingInfo.volumeUuid,StorageManager.UUID_PRIVATE_INTERNAL) && fitsOnInternal) {
      return StorageManager.UUID_PRIVATE_INTERNAL;
    }
 else     if (allCandidates.contains(existingInfo.volumeUuid)) {
      return existingInfo.volumeUuid;
    }
 else {
      throw new IOException("Not enough space on existing volume " + existingInfo.volumeUuid + " for "+ packageName+ " upgrade");
    }
  }
  if (bestCandidate != null) {
    return bestCandidate.fsUuid;
  }
 else   if (fitsOnInternal) {
    return StorageManager.UUID_PRIVATE_INTERNAL;
  }
 else {
    throw new IOException("No special requests, but no room anywhere");
  }
}
