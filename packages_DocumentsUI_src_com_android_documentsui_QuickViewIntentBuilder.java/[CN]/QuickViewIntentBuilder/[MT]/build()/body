{
  if (DEBUG)   Log.d(TAG,"Preparing intent for doc:" + mDocument.documentId);
  String trustedPkg=mResources.getString(R.string.trusted_quick_viewer_package);
  if (!TextUtils.isEmpty(trustedPkg)) {
    Intent intent=new Intent(Intent.ACTION_QUICK_VIEW);
    intent.setDataAndType(mDocument.derivedUri,mDocument.mimeType);
    intent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
    intent.setPackage(trustedPkg);
    if (hasRegisteredHandler(intent)) {
      final ArrayList<Uri> uris=new ArrayList<Uri>();
      final int documentLocation=collectViewableUris(uris);
      final Range<Integer> range=computeSiblingsRange(uris,documentLocation);
      ClipData clipData=null;
      ClipData.Item item;
      Uri uri;
      for (int i=range.getLower(); i <= range.getUpper(); i++) {
        uri=uris.get(i);
        item=new ClipData.Item(uri);
        if (DEBUG)         Log.d(TAG,"Including file: " + uri);
        if (clipData == null) {
          clipData=new ClipData("URIs",new String[]{ClipDescription.MIMETYPE_TEXT_URILIST},item);
        }
 else {
          clipData.addItem(item);
        }
      }
      intent.putExtra(Intent.EXTRA_INDEX,documentLocation - range.getLower());
      intent.setClipData(clipData);
      return intent;
    }
 else {
      Log.e(TAG,"Can't resolve trusted quick view package: " + trustedPkg);
    }
  }
  return null;
}
