{
synchronized (mOtherDeviceTasksMap) {
    List<List<OtherDeviceTask>> chains=mOtherDeviceTasksMap.get(packageName);
    if (chains == null) {
      return;
    }
    for (int i=chains.size() - 1; i >= 0; i--) {
      List<OtherDeviceTask> chain=chains.get(i);
      if (!canAddOtherDeviceTaskChain(chain)) {
        if (DEBUG_RESTORER)         Slog.d(TAG,"Can't add task chain at index=" + i + " for package="+ packageName);
        continue;
      }
      List<TaskRecord> tasks=new ArrayList<>();
      TaskRecord prev=null;
      for (int j=chain.size() - 1; j >= 0; j--) {
        TaskRecord task=createTaskRecordLocked(chain.get(j));
        if (task == null) {
          if (DEBUG_RESTORER)           Slog.d(TAG,"Can't create task record for file=" + chain.get(j).mFile + " for package="+ packageName);
          break;
        }
        if (prev == null) {
          task.mPrevAffiliate=null;
          task.mPrevAffiliateTaskId=INVALID_TASK_ID;
          task.mAffiliatedTaskId=task.taskId;
        }
 else {
          prev.mNextAffiliate=task;
          prev.mNextAffiliateTaskId=task.taskId;
          task.mAffiliatedTaskId=prev.mAffiliatedTaskId;
          task.mPrevAffiliate=prev;
          task.mPrevAffiliateTaskId=prev.taskId;
        }
        prev=task;
        tasks.add(0,task);
      }
      if (tasks.size() == chain.size()) {
        int spaceLeft=ActivityManager.getMaxRecentTasksStatic() - mService.mRecentTasks.size();
        if (spaceLeft >= tasks.size()) {
          mService.mRecentTasks.addAll(mService.mRecentTasks.size(),tasks);
          for (int k=tasks.size() - 1; k >= 0; k--) {
            wakeup(tasks.get(k),false);
          }
          if (DEBUG_RESTORER)           Slog.d(TAG,"Added " + tasks.size() + " tasks to recent's for"+ " package="+ packageName);
        }
 else {
          if (DEBUG_RESTORER)           Slog.d(TAG,"Didn't add to recents. tasks.size(" + tasks.size() + ") != chain.size("+ chain.size()+ ") for package="+ packageName);
        }
      }
 else {
        if (DEBUG_RESTORER)         Slog.v(TAG,"Unable to add restored tasks to recents " + tasks.size() + " tasks for package="+ packageName);
      }
      for (int j=chain.size() - 1; j >= 0; j--) {
        chain.get(j).mFile.delete();
      }
      chains.remove(i);
      if (chains.isEmpty()) {
        mOtherDeviceTasksMap.remove(packageName);
        if (DEBUG_RESTORER)         Slog.d(TAG,"Removed package=" + packageName + " from restore map");
      }
    }
  }
}
