{
  BatteryInfo info=new BatteryInfo();
  info.mStats=stats;
  info.mBatteryLevel=Utils.getBatteryLevel(batteryBroadcast);
  info.batteryPercentString=Utils.formatPercentage(info.mBatteryLevel);
  info.mCharging=batteryBroadcast.getIntExtra(BatteryManager.EXTRA_PLUGGED,0) != 0;
  final Resources resources=context.getResources();
  if (!info.mCharging) {
    final long drainTime=stats.computeBatteryTimeRemaining(elapsedRealtimeUs);
    if (drainTime > 0) {
      info.remainingTimeUs=drainTime;
      String timeString=Formatter.formatShortElapsedTime(context,drainTime / 1000);
      info.remainingLabel=resources.getString(R.string.power_remaining_duration_only,timeString);
      info.mChargeLabelString=resources.getString(R.string.power_discharging_duration,info.batteryPercentString,timeString);
    }
 else {
      info.remainingLabel=null;
      info.mChargeLabelString=info.batteryPercentString;
    }
  }
 else {
    final long chargeTime=stats.computeChargeTimeRemaining(elapsedRealtimeUs);
    final String statusLabel=Utils.getBatteryStatus(resources,batteryBroadcast);
    final int status=batteryBroadcast.getIntExtra(BatteryManager.EXTRA_STATUS,BatteryManager.BATTERY_STATUS_UNKNOWN);
    if (chargeTime > 0 && status != BatteryManager.BATTERY_STATUS_FULL) {
      info.mDischarging=false;
      info.remainingTimeUs=chargeTime;
      String timeString=Formatter.formatShortElapsedTime(context,chargeTime / 1000);
      int plugType=batteryBroadcast.getIntExtra(BatteryManager.EXTRA_PLUGGED,0);
      int resId;
      if (plugType == BatteryManager.BATTERY_PLUGGED_AC) {
        resId=R.string.power_charging_duration_ac;
      }
 else       if (plugType == BatteryManager.BATTERY_PLUGGED_USB) {
        resId=R.string.power_charging_duration_usb;
      }
 else       if (plugType == BatteryManager.BATTERY_PLUGGED_WIRELESS) {
        resId=R.string.power_charging_duration_wireless;
      }
 else {
        resId=R.string.power_charging_duration;
      }
      info.remainingLabel=resources.getString(R.string.power_remaining_duration_only,timeString);
      info.mChargeLabelString=resources.getString(resId,info.batteryPercentString,timeString);
    }
 else {
      info.remainingLabel=statusLabel;
      info.mChargeLabelString=resources.getString(R.string.power_charging,info.batteryPercentString,statusLabel);
    }
  }
  return info;
}
