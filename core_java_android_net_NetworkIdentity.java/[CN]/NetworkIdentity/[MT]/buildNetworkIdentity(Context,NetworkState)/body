{
  final int type=state.networkInfo.getType();
  final int subType=state.networkInfo.getSubtype();
  String subscriberId=null;
  String networkId=null;
  boolean roaming=false;
  boolean metered=false;
  if (isNetworkTypeMobile(type)) {
    if (state.subscriberId == null) {
      Slog.w(TAG,"Active mobile network without subscriber!");
    }
    subscriberId=state.subscriberId;
    roaming=state.networkInfo.isRoaming();
    metered=!state.networkCapabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_NOT_METERED);
  }
 else   if (type == TYPE_WIFI) {
    if (state.networkId != null) {
      networkId=state.networkId;
    }
 else {
      final WifiManager wifi=(WifiManager)context.getSystemService(Context.WIFI_SERVICE);
      final WifiInfo info=wifi.getConnectionInfo();
      networkId=info != null ? info.getSSID() : null;
    }
  }
  return new NetworkIdentity(type,subType,subscriberId,networkId,roaming,metered);
}
