{
  if (!isRunningLocked()) {
    throw new IllegalStateException("VPN is not active");
  }
  if (mConfig.allowedApplications != null) {
    int start=-1, stop=-1;
    for (    int uid : getAppsUids(mConfig.allowedApplications,userHandle)) {
      if (start == -1) {
        start=uid;
      }
 else       if (uid != stop + 1) {
        mVpnUsers.add(new UidRange(start,stop));
        start=uid;
      }
      stop=uid;
    }
    if (start != -1)     mVpnUsers.add(new UidRange(start,stop));
  }
 else   if (mConfig.disallowedApplications != null) {
    final UidRange userRange=UidRange.createForUser(userHandle);
    int start=userRange.start;
    for (    int uid : getAppsUids(mConfig.disallowedApplications,userHandle)) {
      if (uid == start) {
        start++;
      }
 else {
        mVpnUsers.add(new UidRange(start,uid - 1));
        start=uid + 1;
      }
    }
    if (start <= userRange.stop)     mVpnUsers.add(new UidRange(start,userRange.stop));
  }
 else {
    mVpnUsers.add(UidRange.createForUser(userHandle));
  }
  prepareStatusIntent();
}
