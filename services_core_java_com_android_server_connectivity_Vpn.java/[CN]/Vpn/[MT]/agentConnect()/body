{
  LinkProperties lp=makeLinkProperties();
  if (lp.hasIPv4DefaultRoute() || lp.hasIPv6DefaultRoute()) {
    mNetworkCapabilities.addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET);
  }
 else {
    mNetworkCapabilities.removeCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET);
  }
  mNetworkInfo.setIsAvailable(true);
  mNetworkInfo.setDetailedState(DetailedState.CONNECTED,null,null);
  NetworkMisc networkMisc=new NetworkMisc();
  networkMisc.allowBypass=mConfig.allowBypass;
  long token=Binder.clearCallingIdentity();
  try {
    mNetworkAgent=new NetworkAgent(mLooper,mContext,NETWORKTYPE,mNetworkInfo,mNetworkCapabilities,lp,0,networkMisc){
      @Override public void unwanted(){
      }
    }
;
  }
  finally {
    Binder.restoreCallingIdentity(token);
  }
  addVpnUserLocked(mUserHandle);
  if (canHaveRestrictedProfile(mUserHandle)) {
    token=Binder.clearCallingIdentity();
    List<UserInfo> users;
    try {
      users=UserManager.get(mContext).getUsers();
    }
  finally {
      Binder.restoreCallingIdentity(token);
    }
    for (    UserInfo user : users) {
      if (user.isRestricted() && (user.restrictedProfileParentId == mUserHandle)) {
        addVpnUserLocked(user.id);
      }
    }
  }
  mNetworkAgent.addUidRanges(mVpnUsers.toArray(new UidRange[mVpnUsers.size()]));
}
