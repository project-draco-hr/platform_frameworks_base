{
  byte[] systemSettingsData=getSystemSettings();
  byte[] secureSettingsData=getSecureSettings();
  byte[] locale=mSettingsHelper.getLocaleData();
  byte[] wifiSupplicantData=getWifiSupplicant(FILE_WIFI_SUPPLICANT);
  byte[] wifiConfigData=getFileData(mWifiConfigFile);
  if (oldState != null) {
    long[] stateChecksums=readOldChecksums(oldState);
    stateChecksums[STATE_SYSTEM]=writeIfChanged(stateChecksums[STATE_SYSTEM],KEY_SYSTEM,systemSettingsData,data);
    stateChecksums[STATE_SECURE]=writeIfChanged(stateChecksums[STATE_SECURE],KEY_SECURE,secureSettingsData,data);
    stateChecksums[STATE_LOCALE]=writeIfChanged(stateChecksums[STATE_LOCALE],KEY_LOCALE,locale,data);
    stateChecksums[STATE_WIFI_SUPPLICANT]=writeIfChanged(stateChecksums[STATE_WIFI_SUPPLICANT],KEY_WIFI_SUPPLICANT,wifiSupplicantData,data);
    stateChecksums[STATE_WIFI_CONFIG]=writeIfChanged(stateChecksums[STATE_WIFI_CONFIG],KEY_WIFI_CONFIG,wifiConfigData,data);
    writeNewChecksums(stateChecksums,newState);
  }
 else {
    String root=getFilesDir().getAbsolutePath();
    File stage=new File(root,STAGE_FILE);
    FileOutputStream filestream=new FileOutputStream(stage);
    BufferedOutputStream bufstream=new BufferedOutputStream(filestream);
    DataOutputStream out=new DataOutputStream(bufstream);
    out.writeInt(systemSettingsData.length);
    out.write(systemSettingsData);
    out.writeInt(secureSettingsData.length);
    out.write(secureSettingsData);
    out.writeInt(locale.length);
    out.write(locale);
    out.writeInt(wifiSupplicantData.length);
    out.write(wifiSupplicantData);
    out.writeInt(wifiConfigData.length);
    out.write(wifiConfigData);
    out.flush();
    FullBackup.backupToTar(getPackageName(),FullBackup.DATA_TREE_TOKEN,null,root,stage.getAbsolutePath(),data);
  }
}
