{
  if (DEBUG_BACKUP)   Log.d(TAG,"onRestoreFile() invoked");
  FileInputStream instream=new FileInputStream(data.getFileDescriptor());
  DataInputStream in=new DataInputStream(instream);
  int version=in.readInt();
  if (DEBUG_BACKUP)   Log.d(TAG,"Flattened data version " + version);
  if (version == FULL_BACKUP_VERSION) {
    int nBytes=in.readInt();
    if (DEBUG_BACKUP)     Log.d(TAG,nBytes + " bytes of settings data");
    byte[] buffer=new byte[nBytes];
    in.read(buffer,0,nBytes);
    restoreSettings(buffer,nBytes,Settings.System.CONTENT_URI);
    nBytes=in.readInt();
    if (DEBUG_BACKUP)     Log.d(TAG,nBytes + " bytes of secure settings data");
    if (nBytes > buffer.length)     buffer=new byte[nBytes];
    in.read(buffer,0,nBytes);
    restoreSettings(buffer,nBytes,Settings.Secure.CONTENT_URI);
    nBytes=in.readInt();
    if (DEBUG_BACKUP)     Log.d(TAG,nBytes + " bytes of locale data");
    if (nBytes > buffer.length)     buffer=new byte[nBytes];
    in.read(buffer,0,nBytes);
    mSettingsHelper.setLocaleData(buffer,nBytes);
    nBytes=in.readInt();
    if (DEBUG_BACKUP)     Log.d(TAG,nBytes + " bytes of wifi supplicant data");
    if (nBytes > buffer.length)     buffer=new byte[nBytes];
    in.read(buffer,0,nBytes);
    int retainedWifiState=enableWifi(false);
    restoreWifiSupplicant(FILE_WIFI_SUPPLICANT,buffer,nBytes);
    FileUtils.setPermissions(FILE_WIFI_SUPPLICANT,FileUtils.S_IRUSR | FileUtils.S_IWUSR | FileUtils.S_IRGRP| FileUtils.S_IWGRP,Process.myUid(),Process.WIFI_UID);
    enableWifi(retainedWifiState == WifiManager.WIFI_STATE_ENABLED || retainedWifiState == WifiManager.WIFI_STATE_ENABLING);
    nBytes=in.readInt();
    if (DEBUG_BACKUP)     Log.d(TAG,nBytes + " bytes of wifi config data");
    if (nBytes > buffer.length)     buffer=new byte[nBytes];
    in.read(buffer,0,nBytes);
    restoreFileData(mWifiConfigFile,buffer,nBytes);
    if (DEBUG_BACKUP)     Log.d(TAG,"Full restore complete.");
  }
 else {
    data.close();
    throw new IOException("Invalid file schema");
  }
}
