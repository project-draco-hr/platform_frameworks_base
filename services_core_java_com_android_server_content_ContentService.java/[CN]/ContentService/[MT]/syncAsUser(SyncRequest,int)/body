{
  enforceCrossUserPermission(userId,"no permission to request sync as user: " + userId);
  int callerUid=Binder.getCallingUid();
  long identityToken=clearCallingIdentity();
  try {
    SyncManager syncManager=getSyncManager();
    if (syncManager == null) {
      return;
    }
    Bundle extras=request.getBundle();
    long flextime=request.getSyncFlexTime();
    long runAtTime=request.getSyncRunTime();
    if (request.isPeriodic()) {
      mContext.enforceCallingOrSelfPermission(Manifest.permission.WRITE_SYNC_SETTINGS,"no permission to write the sync settings");
      SyncStorageEngine.EndPoint info;
      info=new SyncStorageEngine.EndPoint(request.getAccount(),request.getProvider(),userId);
      if (runAtTime < 3600) {
        Slog.w(TAG,"Requested poll frequency of " + runAtTime + " seconds being rounded up to 1 hour.");
        runAtTime=3600;
      }
      getSyncManager().updateOrAddPeriodicSync(info,runAtTime,flextime,extras);
    }
 else {
      long beforeRuntimeMillis=(flextime) * 1000;
      long runtimeMillis=runAtTime * 1000;
      syncManager.scheduleSync(request.getAccount(),userId,callerUid,request.getProvider(),extras,beforeRuntimeMillis,runtimeMillis,false);
    }
  }
  finally {
    restoreCallingIdentity(identityToken);
  }
}
