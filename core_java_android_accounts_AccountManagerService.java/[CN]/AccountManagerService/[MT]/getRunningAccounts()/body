{
  final int[] runningUserIds;
  try {
    runningUserIds=ActivityManagerNative.getDefault().getRunningUserIds();
  }
 catch (  RemoteException e) {
    throw new RuntimeException(e);
  }
  final ArrayList<AccountAndUser> runningAccounts=Lists.newArrayList();
synchronized (mUsers) {
    for (    int userId : runningUserIds) {
      UserAccounts userAccounts=getUserAccounts(userId);
      if (userAccounts == null)       continue;
synchronized (userAccounts.cacheLock) {
        Account[] accounts=getAccountsFromCacheLocked(userAccounts,null);
        for (int a=0; a < accounts.length; a++) {
          runningAccounts.add(new AccountAndUser(accounts[a],userId));
        }
      }
    }
  }
  AccountAndUser[] accountsArray=new AccountAndUser[runningAccounts.size()];
  return runningAccounts.toArray(accountsArray);
}
