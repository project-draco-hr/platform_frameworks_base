{
  TelephonyManager telephonyManager=(TelephonyManager)context.getSystemService(Context.TELEPHONY_SERVICE);
  if (telephonyManager == null) {
    Log.w(TAG,"failed to get TelephonyManager");
    return;
  }
  String imsi=telephonyManager.getSubscriberId();
  if (TextUtils.isEmpty(imsi))   return;
  String storedImsi=getMetaValue("imsi");
  if (Log.isLoggable(TAG,Log.VERBOSE)) {
    Log.v(TAG,"current IMSI=" + imsi + "; stored IMSI="+ storedImsi);
  }
  if (imsi.equals(storedImsi))   return;
  if (telephonyManager.getPhoneType() == TelephonyManager.PHONE_TYPE_CDMA) {
    IBinder service=ServiceManager.checkService(Context.TELEPHONY_SERVICE);
    if (service == null) {
      Log.w(TAG,"call to checkService(TELEPHONY_SERVICE) failed");
      return;
    }
    ITelephony telephony=ITelephony.Stub.asInterface(service);
    if (telephony == null) {
      Log.w(TAG,"failed to get ITelephony interface");
      return;
    }
    boolean needsProvisioning;
    try {
      needsProvisioning=telephony.needsOtaServiceProvisioning();
    }
 catch (    RemoteException e) {
      Log.w(TAG,"exception while checking provisioning",e);
      needsProvisioning=true;
    }
    if (needsProvisioning) {
      if (Log.isLoggable(TAG,Log.VERBOSE)) {
        Log.v(TAG,"current IMSI=" + imsi + " (needs provisioning); stored IMSI="+ storedImsi);
      }
      return;
    }
  }
  if (!imsi.equals(storedImsi) && !TextUtils.isEmpty(storedImsi)) {
    Log.w(TAG,"wiping all passwords and authtokens because IMSI changed (" + "stored=" + storedImsi + ", current="+ imsi+ ")");
    SQLiteDatabase db=mOpenHelper.getWritableDatabase();
    db.beginTransaction();
    try {
      db.execSQL("DELETE from " + TABLE_AUTHTOKENS);
      db.execSQL("UPDATE " + TABLE_ACCOUNTS + " SET "+ ACCOUNTS_PASSWORD+ " = ''");
      sendAccountsChangedBroadcast();
      db.setTransactionSuccessful();
    }
  finally {
      db.endTransaction();
    }
  }
  setMetaValue("imsi",imsi);
}
