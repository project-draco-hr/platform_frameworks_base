{
  if (DEBUG) {
    Log.d(TAG,"Received input devices changed.");
  }
synchronized (mInputDevicesLock) {
    for (int i=mInputDevices.size(); --i > 0; ) {
      final int deviceId=mInputDevices.keyAt(i);
      if (!containsDeviceId(deviceIdAndGeneration,deviceId)) {
        if (DEBUG) {
          Log.d(TAG,"Device removed: " + deviceId);
        }
        mInputDevices.removeAt(i);
        sendMessageToInputDeviceListenersLocked(MSG_DEVICE_REMOVED,deviceId);
      }
    }
    for (int i=0; i < deviceIdAndGeneration.length; i+=2) {
      final int deviceId=deviceIdAndGeneration[i];
      int index=mInputDevices.indexOfKey(deviceId);
      if (index >= 0) {
        final InputDevice device=mInputDevices.valueAt(index);
        if (device != null) {
          final int generation=deviceIdAndGeneration[i + 1];
          if (device.getGeneration() != generation) {
            if (DEBUG) {
              Log.d(TAG,"Device changed: " + deviceId);
            }
            mInputDevices.setValueAt(index,null);
            sendMessageToInputDeviceListenersLocked(MSG_DEVICE_CHANGED,deviceId);
          }
        }
      }
 else {
        if (DEBUG) {
          Log.d(TAG,"Device added: " + deviceId);
        }
        mInputDevices.put(deviceId,null);
        sendMessageToInputDeviceListenersLocked(MSG_DEVICE_ADDED,deviceId);
      }
    }
  }
}
