{
  int width=MeasureSpec.getSize(widthMeasureSpec) - getPaddingLeft() - getPaddingRight();
  int childCount=getChildCount();
  int height=MeasureSpec.getSize(heightMeasureSpec) - getPaddingTop() - getPaddingBottom();
  int lineHeight=0;
  int xPos=getPaddingLeft();
  int yPos=getPaddingTop();
  int childHeightMeasureSpec;
  if (MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.AT_MOST) {
    childHeightMeasureSpec=MeasureSpec.makeMeasureSpec(height,MeasureSpec.AT_MOST);
  }
 else {
    childHeightMeasureSpec=MeasureSpec.makeMeasureSpec(0,MeasureSpec.UNSPECIFIED);
  }
  for (int i=0; i < childCount; i++) {
    View child=getChildAt(i);
    if (child.getVisibility() != GONE) {
      LayoutParams layoutParams=(LayoutParams)child.getLayoutParams();
      child.measure(MeasureSpec.makeMeasureSpec(width,MeasureSpec.AT_MOST),childHeightMeasureSpec);
      int childWidth=child.getMeasuredWidth();
      lineHeight=Math.max(lineHeight,child.getMeasuredHeight() + layoutParams.mVerticalSpacing);
      if (xPos + childWidth > width) {
        xPos=getPaddingLeft();
        yPos+=lineHeight;
      }
      xPos+=childWidth + layoutParams.mHorizontalSpacing;
    }
  }
  this.mLineHeight=lineHeight;
  if (MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.UNSPECIFIED) {
    height=yPos + lineHeight;
  }
 else   if (MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.AT_MOST) {
    if (yPos + lineHeight < height) {
      height=yPos + lineHeight;
    }
  }
  setMeasuredDimension(width,height);
}
