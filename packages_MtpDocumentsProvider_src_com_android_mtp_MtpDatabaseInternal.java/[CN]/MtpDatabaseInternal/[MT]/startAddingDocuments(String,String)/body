{
  mDatabase.beginTransaction();
  try {
    deleteDocumentsAndRootsRecursively(selection + " AND " + COLUMN_ROW_STATE+ "=?",strings(arg,ROW_STATE_PENDING));
    final ContentValues values=new ContentValues();
    values.put(COLUMN_ROW_STATE,ROW_STATE_INVALIDATED);
    mDatabase.update(TABLE_DOCUMENTS,values,selection,new String[]{arg});
    final boolean useNameForResolving=DatabaseUtils.queryNumEntries(mDatabase,TABLE_DOCUMENTS,selection + " AND " + COLUMN_STORAGE_ID+ " IS NULL",new String[]{arg}) > 0;
    mDatabase.setTransactionSuccessful();
    return useNameForResolving ? MAP_BY_NAME : MAP_BY_MTP_IDENTIFIER;
  }
  finally {
    mDatabase.endTransaction();
  }
}
