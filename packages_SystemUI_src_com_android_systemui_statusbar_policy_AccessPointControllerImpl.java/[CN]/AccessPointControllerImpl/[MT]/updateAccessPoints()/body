{
  final WifiInfo wifiInfo=mWifiManager.getConnectionInfo();
  final int connectedNetworkId=getConnectedNetworkId(wifiInfo);
  if (DEBUG)   Log.d(TAG,"connectedNetworkId: " + connectedNetworkId);
  final List<ScanResult> scanResults=mWifiManager.getScanResults();
  final ArrayMap<String,WifiConfiguration> configured=getConfiguredNetworksBySsid();
  if (DEBUG)   Log.d(TAG,"scanResults: " + scanResults);
  final List<AccessPoint> aps=new ArrayList<AccessPoint>(scanResults.size());
  final ArraySet<String> ssids=new ArraySet<String>();
  for (  ScanResult scanResult : scanResults) {
    if (scanResult == null) {
      continue;
    }
    final String ssid=scanResult.SSID;
    if (TextUtils.isEmpty(ssid) || ssids.contains(ssid))     continue;
    ssids.add(ssid);
    final WifiConfiguration config=configured.get(ssid);
    final int level=WifiManager.calculateSignalLevel(scanResult.level,ICONS.length);
    final AccessPoint ap=new AccessPoint();
    ap.isConfigured=config != null;
    ap.networkId=config != null ? config.networkId : AccessPoint.NO_NETWORK;
    ap.ssid=ssid;
    ap.iconId=ICONS[level];
    ap.isConnected=(ap.networkId != AccessPoint.NO_NETWORK && ap.networkId == connectedNetworkId) || (ap.networkId == WifiConfiguration.INVALID_NETWORK_ID && wifiInfo != null && ap.ssid.equals(trimDoubleQuotes(wifiInfo.getSSID())));
    ap.level=level;
    ap.hasSecurity=scanResult.capabilities.contains("WEP") || scanResult.capabilities.contains("PSK") || scanResult.capabilities.contains("EAP");
    aps.add(ap);
  }
  Collections.sort(aps,mByStrength);
  fireCallback(aps.toArray(new AccessPoint[aps.size()]));
}
