{
  String scheme=intent.getScheme();
  ArrayList<R> finalList=new ArrayList<R>();
  final boolean debug=localLOGV || ((intent.getFlags() & Intent.FLAG_DEBUG_LOG_RESOLUTION) != 0);
  if (debug)   Slog.v(TAG,"Resolving type " + resolvedType + " scheme "+ scheme+ " of intent "+ intent);
  F[] firstTypeCut=null;
  F[] secondTypeCut=null;
  F[] thirdTypeCut=null;
  F[] schemeCut=null;
  if (resolvedType != null) {
    int slashpos=resolvedType.indexOf('/');
    if (slashpos > 0) {
      final String baseType=resolvedType.substring(0,slashpos);
      if (!baseType.equals("*")) {
        if (resolvedType.length() != slashpos + 2 || resolvedType.charAt(slashpos + 1) != '*') {
          firstTypeCut=mTypeToFilter.get(resolvedType);
          if (debug)           Slog.v(TAG,"First type cut: " + firstTypeCut);
          secondTypeCut=mWildTypeToFilter.get(baseType);
          if (debug)           Slog.v(TAG,"Second type cut: " + secondTypeCut);
        }
 else {
          firstTypeCut=mBaseTypeToFilter.get(baseType);
          if (debug)           Slog.v(TAG,"First type cut: " + firstTypeCut);
          secondTypeCut=mWildTypeToFilter.get(baseType);
          if (debug)           Slog.v(TAG,"Second type cut: " + secondTypeCut);
        }
        thirdTypeCut=mWildTypeToFilter.get("*");
        if (debug)         Slog.v(TAG,"Third type cut: " + thirdTypeCut);
      }
 else       if (intent.getAction() != null) {
        firstTypeCut=mTypedActionToFilter.get(intent.getAction());
        if (debug)         Slog.v(TAG,"Typed Action list: " + firstTypeCut);
      }
    }
  }
  if (scheme != null) {
    schemeCut=mSchemeToFilter.get(scheme);
    if (debug)     Slog.v(TAG,"Scheme list: " + schemeCut);
  }
  if (resolvedType == null && scheme == null && intent.getAction() != null) {
    firstTypeCut=mActionToFilter.get(intent.getAction());
    if (debug)     Slog.v(TAG,"Action list: " + firstTypeCut);
  }
  FastImmutableArraySet<String> categories=getFastIntentCategories(intent);
  if (firstTypeCut != null) {
    buildResolveList(intent,categories,debug,defaultOnly,resolvedType,scheme,firstTypeCut,finalList,userId);
  }
  if (secondTypeCut != null) {
    buildResolveList(intent,categories,debug,defaultOnly,resolvedType,scheme,secondTypeCut,finalList,userId);
  }
  if (thirdTypeCut != null) {
    buildResolveList(intent,categories,debug,defaultOnly,resolvedType,scheme,thirdTypeCut,finalList,userId);
  }
  if (schemeCut != null) {
    buildResolveList(intent,categories,debug,defaultOnly,resolvedType,scheme,schemeCut,finalList,userId);
  }
  sortResults(finalList);
  if (VALIDATE) {
    List<R> oldList=mOldResolver.queryIntent(intent,resolvedType,defaultOnly,userId);
    if (oldList.size() != finalList.size()) {
      ValidationFailure here=new ValidationFailure();
      here.fillInStackTrace();
      Log.wtf(TAG,"Query result " + intent + " size is "+ finalList.size()+ "; old implementation is "+ oldList.size(),here);
    }
  }
  if (debug) {
    Slog.v(TAG,"Final result list:");
    for (    R r : finalList) {
      Slog.v(TAG,"  " + r);
    }
  }
  return finalList;
}
