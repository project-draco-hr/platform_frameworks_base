{
  final InputDevice device=getInputDevice(deviceId);
  if (device != null) {
    final String inputDeviceDescriptor=device.getDescriptor();
    final boolean changed;
    final String keyboardLayoutDescriptor;
synchronized (mDataStore) {
      try {
        changed=mDataStore.switchKeyboardLayout(inputDeviceDescriptor,direction);
        keyboardLayoutDescriptor=mDataStore.getCurrentKeyboardLayout(inputDeviceDescriptor);
      }
  finally {
        mDataStore.saveIfNeeded();
      }
    }
    if (changed) {
      if (mSwitchedKeyboardLayoutToast != null) {
        mSwitchedKeyboardLayoutToast.cancel();
        mSwitchedKeyboardLayoutToast=null;
      }
      if (keyboardLayoutDescriptor != null) {
        KeyboardLayout keyboardLayout=getKeyboardLayout(keyboardLayoutDescriptor);
        if (keyboardLayout != null) {
          mSwitchedKeyboardLayoutToast=Toast.makeText(mContext,keyboardLayout.getLabel(),Toast.LENGTH_SHORT);
          mSwitchedKeyboardLayoutToast.show();
        }
      }
      reloadKeyboardLayouts();
    }
  }
}
