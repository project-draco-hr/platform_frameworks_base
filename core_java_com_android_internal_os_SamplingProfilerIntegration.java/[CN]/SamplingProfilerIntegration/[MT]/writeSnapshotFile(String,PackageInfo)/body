{
  if (!enabled) {
    return;
  }
  INSTANCE.stop();
  long start=System.currentTimeMillis();
  String name=processName.replaceAll(":",".");
  String path=SNAPSHOT_DIR + "/" + name+ "-"+ System.currentTimeMillis()+ ".snapshot";
  PrintStream out=null;
  try {
    out=new PrintStream(new BufferedOutputStream(new FileOutputStream(path)));
  }
 catch (  IOException e) {
    Log.e(TAG,"Could not open " + path + ":"+ e);
    return;
  }
  try {
    generateSnapshotHeader(name,packageInfo,out);
    INSTANCE.writeHprofData(out);
  }
  finally {
    out.close();
  }
  if (out.checkError()) {
    Log.e(TAG,"Error writing snapshot.");
    return;
  }
  new File(path).setReadable(true,false);
  long elapsed=System.currentTimeMillis() - start;
  Log.i(TAG,"Wrote snapshot for " + name + " in "+ elapsed+ "ms.");
}
