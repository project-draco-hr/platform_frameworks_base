{
  if (!enabled) {
    return;
  }
  INSTANCE.stop();
  long start=System.currentTimeMillis();
  String name=processName.replaceAll(":",".");
  String path=SNAPSHOT_DIR + "/" + name+ "-"+ System.currentTimeMillis()+ ".snapshot";
  PrintStream out=null;
  try {
    out=new PrintStream(new BufferedOutputStream(new FileOutputStream(path)));
    generateSnapshotHeader(name,packageInfo,out);
    new AsciiHprofWriter(INSTANCE.getHprofData(),out).write();
    if (out.checkError()) {
      throw new IOException();
    }
  }
 catch (  IOException e) {
    Log.e(TAG,"Error writing snapshot to " + path,e);
    return;
  }
 finally {
    IoUtils.closeQuietly(out);
  }
  new File(path).setReadable(true,false);
  long elapsed=System.currentTimeMillis() - start;
  Log.i(TAG,"Wrote snapshot for " + name + " in "+ elapsed+ "ms.");
}
