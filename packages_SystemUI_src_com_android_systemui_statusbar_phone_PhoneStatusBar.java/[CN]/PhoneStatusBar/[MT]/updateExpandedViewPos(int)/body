{
  if (SPEW) {
    Slog.d(TAG,"updateExpandedViewPos before expandedPosition=" + expandedPosition + " mTrackingParams.y="+ ((mTrackingParams == null) ? "?" : mTrackingParams.y)+ " mTrackingPosition="+ mTrackingPosition);
  }
  int h=mStatusBarView.getHeight();
  int disph=mDisplayMetrics.heightPixels;
  if (!mExpandedVisible) {
    updateExpandedInvisiblePosition();
    return;
  }
  int pos;
  if (expandedPosition == EXPANDED_FULL_OPEN) {
    pos=h;
  }
 else   if (expandedPosition == EXPANDED_LEAVE_ALONE) {
    pos=mTrackingPosition;
  }
 else {
    if (expandedPosition <= disph) {
      pos=expandedPosition;
    }
 else {
      pos=disph;
    }
    pos-=disph - h;
  }
  mTrackingPosition=mTrackingParams.y=pos;
  mTrackingParams.height=disph - h;
  WindowManagerImpl.getDefault().updateViewLayout(mTrackingView,mTrackingParams);
  if (mExpandedParams != null) {
    if (mCloseView.getWindowVisibility() == View.VISIBLE) {
      mCloseView.getLocationInWindow(mPositionTmp);
      final int closePos=mPositionTmp[1];
      mExpandedContents.getLocationInWindow(mPositionTmp);
      final int contentsBottom=mPositionTmp[1] + mExpandedContents.getHeight();
      mExpandedParams.y=pos + mTrackingView.getHeight() - (mTrackingParams.height - closePos) - contentsBottom;
      if (SPEW) {
        Slog.d(PhoneStatusBar.TAG,"pos=" + pos + " trackingHeight="+ mTrackingView.getHeight()+ " (trackingParams.height - closePos)="+ (mTrackingParams.height - closePos)+ " contentsBottom="+ contentsBottom);
      }
    }
 else {
      mExpandedParams.y=-mDisplayMetrics.heightPixels;
    }
    int max=h;
    if (mExpandedParams.y > max) {
      mExpandedParams.y=max;
    }
    int min=mTrackingPosition;
    if (mExpandedParams.y < min) {
      mExpandedParams.y=min;
    }
    boolean visible=(mTrackingPosition + mTrackingView.getHeight()) > h;
    if (!visible) {
      mExpandedParams.y=-disph;
    }
    mExpandedDialog.getWindow().setAttributes(mExpandedParams);
    if (expandedPosition != EXPANDED_LEAVE_ALONE) {
      if (SPEW)       Slog.d(TAG,"updateExpandedViewPos visibilityChanged(" + visible + ")");
      visibilityChanged(visible);
    }
  }
  if (SPEW) {
    Slog.d(TAG,"updateExpandedViewPos after  expandedPosition=" + expandedPosition + " mTrackingParams.y="+ mTrackingParams.y+ " mTrackingPosition="+ mTrackingPosition+ " mExpandedParams.y="+ mExpandedParams.y+ " mExpandedParams.height="+ mExpandedParams.height);
  }
}
