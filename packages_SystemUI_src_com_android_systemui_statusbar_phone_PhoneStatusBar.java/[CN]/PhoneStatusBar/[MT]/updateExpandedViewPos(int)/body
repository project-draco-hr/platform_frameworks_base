{
  if (SPEW) {
    Slog.d(TAG,"updateExpandedViewPos: expandedPosition=" + expandedPosition + " mTracking="+ mTracking+ " mTrackingPosition="+ mTrackingPosition+ " mExpandedVisible="+ mExpandedVisible+ " mAnimating="+ mAnimating+ " mAnimatingReveal="+ mAnimatingReveal+ " mClosing="+ mClosing+ " gravity="+ mNotificationPanelGravity);
  }
  int panelh=0;
  final int disph=getExpandedViewMaxHeight();
  if (!mExpandedVisible) {
    if (SPEW)     Slog.d(TAG,"updateExpandedViewPos: view not visible, bailing");
    updateExpandedInvisiblePosition();
    return;
  }
  int pos;
  if (expandedPosition == EXPANDED_FULL_OPEN) {
    panelh=disph;
  }
 else   if (expandedPosition == EXPANDED_LEAVE_ALONE) {
    panelh=mTrackingPosition;
  }
 else {
    if (expandedPosition <= disph) {
      panelh=expandedPosition;
    }
 else {
      panelh=disph;
    }
  }
  if (panelh > 0 && ((panelh > disph) || (panelh < disph && !mTracking && !mAnimating))) {
    if (SPEW)     Slog.d(TAG,"updateExpandedViewPos: orientation change?");
    panelh=disph;
  }
 else   if (panelh < 0) {
    panelh=0;
  }
  if (SPEW)   Slog.d(TAG,"updateExpandedViewPos: adjusting size to panelh=" + panelh);
  if (panelh == mTrackingPosition) {
    if (SPEW)     Slog.d(TAG,"updateExpandedViewPos: panelh == mTrackingPosition, bailing");
    return;
  }
  mTrackingPosition=panelh;
  FrameLayout.LayoutParams lp=(FrameLayout.LayoutParams)mNotificationPanel.getLayoutParams();
  lp.height=panelh;
  lp.gravity=mNotificationPanelGravity;
  lp.leftMargin=mNotificationPanelMarginLeftPx;
  if (SPEW) {
    Slog.v(TAG,"updated cropView height=" + panelh + " grav="+ lp.gravity);
  }
  mNotificationPanel.setLayoutParams(lp);
  final int barh=getCloseViewHeight() + getStatusBarHeight();
  final float frac=saturate((float)(panelh - barh) / (disph - barh));
  if (DIM_BEHIND_EXPANDED_PANEL && ActivityManager.isHighEndGfx(mDisplay)) {
    final float k=(float)(1f - 0.5f * (1f - Math.cos(3.14159f * Math.pow(1f - frac,2.2f))));
    final int color=((int)(0xB0 * k)) << 24;
    mStatusBarWindow.setBackgroundColor(color);
  }
  updateCarrierLabelVisibility(false);
}
