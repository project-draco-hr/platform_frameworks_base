{
  final int oldVal=mSystemUiVisibility;
  final int newVal=(oldVal & ~mask) | (vis & mask);
  final int diff=newVal ^ oldVal;
  if (DEBUG)   Log.d(TAG,String.format("setSystemUiVisibility vis=%s mask=%s oldVal=%s newVal=%s diff=%s",Integer.toHexString(vis),Integer.toHexString(mask),Integer.toHexString(oldVal),Integer.toHexString(newVal),Integer.toHexString(diff)));
  if (diff != 0) {
    mSystemUiVisibility=newVal;
    if ((diff & View.SYSTEM_UI_FLAG_LOW_PROFILE) != 0) {
      final boolean lightsOut=(vis & View.SYSTEM_UI_FLAG_LOW_PROFILE) != 0;
      if (lightsOut) {
        animateCollapsePanels();
        if (mTicking) {
          haltTicker();
        }
      }
      if (mNavigationBarView != null) {
        mNavigationBarView.setLowProfile(lightsOut);
      }
      setStatusBarLowProfile(lightsOut);
    }
    int sbMode=updateBarMode(oldVal,newVal,mStatusBarView.getBarTransitions(),View.STATUS_BAR_TRANSIENT,View.SYSTEM_UI_FLAG_TRANSPARENT_STATUS,mStatusBarWindowState);
    int nbMode=updateBarMode(oldVal,newVal,mNavigationBarView.getBarTransitions(),View.NAVIGATION_BAR_TRANSIENT,View.SYSTEM_UI_FLAG_TRANSPARENT_NAVIGATION,mNavigationBarWindowState);
    if (sbMode != -1 || nbMode != -1) {
      if (sbMode == MODE_SEMI_TRANSPARENT || nbMode == MODE_SEMI_TRANSPARENT) {
        scheduleAutohide();
      }
 else {
        cancelAutohide();
      }
    }
    if ((vis & View.STATUS_BAR_UNHIDE) != 0) {
      mSystemUiVisibility&=~View.STATUS_BAR_UNHIDE;
    }
    if ((vis & View.NAVIGATION_BAR_UNHIDE) != 0) {
      mSystemUiVisibility&=~View.NAVIGATION_BAR_UNHIDE;
    }
    notifyUiVisibilityChanged(mSystemUiVisibility);
  }
}
