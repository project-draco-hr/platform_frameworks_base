{
  final int oldVal=mSystemUiVisibility;
  final int newVal=(oldVal & ~mask) | (vis & mask);
  final int diff=newVal ^ oldVal;
  if (DEBUG)   Log.d(TAG,String.format("setSystemUiVisibility vis=%s mask=%s oldVal=%s newVal=%s diff=%s",Integer.toHexString(vis),Integer.toHexString(mask),Integer.toHexString(oldVal),Integer.toHexString(newVal),Integer.toHexString(diff)));
  if (diff != 0) {
    mSystemUiVisibility=newVal;
    if ((diff & View.SYSTEM_UI_FLAG_LOW_PROFILE) != 0) {
      final boolean lightsOut=(vis & View.SYSTEM_UI_FLAG_LOW_PROFILE) != 0;
      if (lightsOut) {
        animateCollapsePanels();
        if (mTicking) {
          haltTicker();
        }
      }
      if (mNavigationBarView != null) {
        mNavigationBarView.setLowProfile(lightsOut);
      }
      setStatusBarLowProfile(lightsOut);
    }
    int sbMode=updateBarMode(oldVal,newVal,mStatusBarView,View.STATUS_BAR_TRANSIENT,View.SYSTEM_UI_FLAG_TRANSPARENT_STATUS);
    int nbMode=updateBarMode(oldVal,newVal,mNavigationBarView,View.NAVIGATION_BAR_TRANSIENT,View.SYSTEM_UI_FLAG_TRANSPARENT_NAVIGATION);
    if (sbMode != -1 || nbMode != -1) {
      if (sbMode == BAR_MODE_TRANSIENT || nbMode == BAR_MODE_TRANSIENT) {
        scheduleAutohide();
      }
 else {
        cancelAutohide();
      }
    }
    if (mNavigationBarView != null) {
      final int hidingNav=View.SYSTEM_UI_FLAG_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_ALLOW_TRANSIENT;
      boolean oldHidingNav=(oldVal & hidingNav) != 0;
      boolean newHidingNav=(newVal & hidingNav) != 0;
      if (!oldHidingNav && newHidingNav) {
        mHidingNavigationConfirmationDismissed=false;
      }
      setHidingNavigationConfirmationVisible(newHidingNav);
    }
    notifyUiVisibilityChanged(mSystemUiVisibility);
  }
}
