{
  final int oldVal=mSystemUiVisibility;
  final int newVal=(oldVal & ~mask) | (vis & mask);
  final int diff=newVal ^ oldVal;
  if (diff != 0) {
    mSystemUiVisibility=newVal;
    if (0 != (diff & View.SYSTEM_UI_FLAG_LOW_PROFILE)) {
      final boolean lightsOut=(0 != (vis & View.SYSTEM_UI_FLAG_LOW_PROFILE));
      if (lightsOut) {
        animateCollapsePanels();
        if (mTicking) {
          haltTicker();
        }
      }
      if (mNavigationBarView != null) {
        mNavigationBarView.setLowProfile(lightsOut);
      }
      setStatusBarLowProfile(lightsOut);
    }
    boolean sbOverlayChanged=0 != (diff & View.STATUS_BAR_OVERLAY);
    boolean nbOverlayChanged=0 != (diff & View.NAVIGATION_BAR_OVERLAY);
    if (sbOverlayChanged || nbOverlayChanged) {
      boolean sbOverlay=0 != (vis & View.STATUS_BAR_OVERLAY);
      boolean nbOverlay=0 != (vis & View.NAVIGATION_BAR_OVERLAY);
      if (sbOverlayChanged) {
        setTransparent(mStatusBarView,sbOverlay);
      }
      if (nbOverlayChanged) {
        setTransparent(mNavigationBarView,nbOverlay);
      }
      if (sbOverlayChanged && sbOverlay || nbOverlayChanged && nbOverlay) {
        scheduleAutohide();
      }
 else {
        cancelAutohide();
      }
    }
    notifyUiVisibilityChanged(mSystemUiVisibility);
  }
}
