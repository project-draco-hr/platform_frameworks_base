{
  final int oldVal=mSystemUiVisibility;
  final int newVal=(oldVal & ~mask) | (vis & mask);
  final int diff=newVal ^ oldVal;
  if (DEBUG)   Log.d(TAG,String.format("setSystemUiVisibility vis=%s mask=%s oldVal=%s newVal=%s diff=%s",Integer.toHexString(vis),Integer.toHexString(mask),Integer.toHexString(oldVal),Integer.toHexString(newVal),Integer.toHexString(diff)));
  if (diff != 0) {
    mSystemUiVisibility=newVal;
    if ((diff & View.SYSTEM_UI_FLAG_LOW_PROFILE) != 0) {
      final boolean lightsOut=(vis & View.SYSTEM_UI_FLAG_LOW_PROFILE) != 0;
      if (lightsOut) {
        animateCollapsePanels();
        if (mTicking) {
          haltTicker();
        }
      }
      setAreThereNotifications();
    }
    final int sbMode=computeBarMode(oldVal,newVal,mStatusBarView.getBarTransitions(),View.STATUS_BAR_TRANSIENT,View.SYSTEM_UI_FLAG_TRANSPARENT_STATUS);
    final int nbMode=mNavigationBarView == null ? -1 : computeBarMode(oldVal,newVal,mNavigationBarView.getBarTransitions(),View.NAVIGATION_BAR_TRANSIENT,View.SYSTEM_UI_FLAG_TRANSPARENT_NAVIGATION);
    final boolean sbModeChanged=sbMode != -1;
    final boolean nbModeChanged=nbMode != -1;
    boolean checkBarModes=false;
    if (sbModeChanged && sbMode != mStatusBarMode) {
      mStatusBarMode=sbMode;
      checkBarModes=true;
    }
    if (nbModeChanged && nbMode != mNavigationBarMode) {
      mNavigationBarMode=nbMode;
      checkBarModes=true;
    }
    if (checkBarModes) {
      checkBarModes();
    }
    if (sbModeChanged || nbModeChanged) {
      if (sbMode == MODE_SEMI_TRANSPARENT || nbMode == MODE_SEMI_TRANSPARENT) {
        scheduleAutohide();
      }
 else {
        cancelAutohide();
      }
    }
    if ((vis & View.STATUS_BAR_UNHIDE) != 0) {
      mSystemUiVisibility&=~View.STATUS_BAR_UNHIDE;
    }
    if ((vis & View.NAVIGATION_BAR_UNHIDE) != 0) {
      mSystemUiVisibility&=~View.NAVIGATION_BAR_UNHIDE;
    }
    notifyUiVisibilityChanged(mSystemUiVisibility);
  }
}
