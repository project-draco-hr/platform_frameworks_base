{
  boolean deferRemoval=false;
  if (mHeadsUpManager.isHeadsUp(key)) {
    deferRemoval=!mHeadsUpManager.removeNotification(key);
  }
  if (deferRemoval) {
    mLatestRankingMap=ranking;
    mHeadsUpEntriesToRemoveOnSwitch.add(mHeadsUpManager.getEntry(key));
    return;
  }
  StatusBarNotification old=removeNotificationViews(key,ranking);
  if (SPEW)   Log.d(TAG,"removeNotification key=" + key + " old="+ old);
  if (old != null) {
    if (CLOSE_PANEL_WHEN_EMPTIED && !hasActiveNotifications() && !mNotificationPanel.isTracking()&& !mNotificationPanel.isQsExpanded()) {
      if (mState == StatusBarState.SHADE) {
        animateCollapsePanels();
      }
 else       if (mState == StatusBarState.SHADE_LOCKED) {
        goToKeyguard();
      }
    }
  }
  setAreThereNotifications();
}
