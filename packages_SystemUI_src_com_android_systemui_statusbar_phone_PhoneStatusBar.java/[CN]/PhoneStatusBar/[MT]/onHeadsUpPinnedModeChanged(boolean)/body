{
  if (inPinnedMode) {
    mNotificationPanel.requestLayout();
    mStatusBarWindowManager.setHeadsUpShowing(true);
    mStatusBarWindowManager.setForceStatusBarVisible(true);
    mStatusBarWindowManager.setForceWindowCollapsed(true);
    mNotificationPanel.post(new Runnable(){
      @Override public void run(){
        mStatusBarWindowManager.setForceWindowCollapsed(false);
      }
    }
);
  }
 else {
    if (!mNotificationPanel.isFullyCollapsed()) {
      mStatusBarWindowManager.setHeadsUpShowing(false);
    }
 else {
      mHeadsUpManager.setHeadsUpGoingAway(true);
      mStackScroller.runAfterAnimationFinished(new Runnable(){
        @Override public void run(){
          if (!mHeadsUpManager.hasPinnedHeadsUp()) {
            mStatusBarWindowManager.setHeadsUpShowing(false);
            mHeadsUpManager.setHeadsUpGoingAway(false);
          }
        }
      }
);
    }
  }
}
