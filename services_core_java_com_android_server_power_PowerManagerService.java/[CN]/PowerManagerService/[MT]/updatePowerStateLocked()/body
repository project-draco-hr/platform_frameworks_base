{
  if (!mSystemReady || mDirty == 0) {
    return;
  }
  if (!Thread.holdsLock(mLock)) {
    Slog.wtf(TAG,"Power manager lock was not held when calling updatePowerStateLocked");
  }
  Trace.traceBegin(Trace.TRACE_TAG_POWER,"updatePowerState");
  try {
    updateIsPoweredLocked(mDirty);
    updateStayOnLocked(mDirty);
    final long now=SystemClock.uptimeMillis();
    int dirtyPhase2=0;
    for (; ; ) {
      int dirtyPhase1=mDirty;
      dirtyPhase2|=dirtyPhase1;
      mDirty=0;
      updateWakeLockSummaryLocked(dirtyPhase1);
      updateUserActivitySummaryLocked(now,dirtyPhase1);
      if (!updateWakefulnessLocked(dirtyPhase1)) {
        break;
      }
    }
    boolean displayBecameReady=updateDisplayPowerStateLocked(dirtyPhase2);
    updateDreamLocked(dirtyPhase2,displayBecameReady);
    if (mDisplayReady) {
      finishInteractiveStateChangeLocked();
    }
    updateSuspendBlockerLocked();
  }
  finally {
    Trace.traceEnd(Trace.TRACE_TAG_POWER);
  }
}
