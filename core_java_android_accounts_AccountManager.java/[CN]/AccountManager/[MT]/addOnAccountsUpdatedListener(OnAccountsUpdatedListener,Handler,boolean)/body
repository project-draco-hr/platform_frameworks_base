{
  if (listener == null) {
    throw new IllegalArgumentException("the listener is null");
  }
synchronized (mAccountsUpdatedListeners) {
    if (mAccountsUpdatedListeners.containsKey(listener)) {
      throw new IllegalStateException("this listener is already added");
    }
    final boolean wasEmpty=mAccountsUpdatedListeners.isEmpty();
    mAccountsUpdatedListeners.put(listener,handler);
    if (wasEmpty) {
      IntentFilter intentFilter=new IntentFilter();
      intentFilter.addAction(Constants.LOGIN_ACCOUNTS_CHANGED_ACTION);
      mContext.registerReceiver(mAccountsChangedBroadcastReceiver,intentFilter);
    }
  }
  if (updateImmediately) {
    getAccounts(new Future1Callback<Account[]>(){
      public void run(      Future1<Account[]> future){
        try {
          listener.onAccountsUpdated(future.getResult());
        }
 catch (        OperationCanceledException e) {
        }
      }
    }
,handler);
  }
}
