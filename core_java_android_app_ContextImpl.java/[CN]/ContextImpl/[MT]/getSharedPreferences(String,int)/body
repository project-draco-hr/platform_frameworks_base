{
  SharedPreferencesImpl sp;
  File prefsFile;
  boolean needInitialLoad=false;
synchronized (sSharedPrefs) {
    sp=sSharedPrefs.get(name);
    if (sp != null && !sp.hasFileChangedUnexpectedly()) {
      return sp;
    }
    prefsFile=getSharedPrefsFile(name);
    if (sp == null) {
      sp=new SharedPreferencesImpl(prefsFile,mode,null);
      sSharedPrefs.put(name,sp);
      needInitialLoad=true;
    }
  }
synchronized (sp) {
    if (needInitialLoad && sp.isLoaded()) {
      return sp;
    }
    File backup=makeBackupFile(prefsFile);
    if (backup.exists()) {
      prefsFile.delete();
      backup.renameTo(prefsFile);
    }
    if (prefsFile.exists() && !prefsFile.canRead()) {
      Log.w(TAG,"Attempt to read preferences file " + prefsFile + " without permission");
    }
    Map map=null;
    if (prefsFile.exists() && prefsFile.canRead()) {
      try {
        FileInputStream str=new FileInputStream(prefsFile);
        map=XmlUtils.readMapXml(str);
        str.close();
      }
 catch (      XmlPullParserException e) {
        Log.w(TAG,"getSharedPreferences",e);
      }
catch (      FileNotFoundException e) {
        Log.w(TAG,"getSharedPreferences",e);
      }
catch (      IOException e) {
        Log.w(TAG,"getSharedPreferences",e);
      }
    }
    sp.replace(map);
  }
  return sp;
}
