{
  boolean returnValue;
  boolean hasListeners;
  boolean changesMade=false;
  List<String> keysModified=null;
  Set<OnSharedPreferenceChangeListener> listeners=null;
synchronized (SharedPreferencesImpl.this) {
    hasListeners=mListeners.size() > 0;
    if (hasListeners) {
      keysModified=new ArrayList<String>();
      listeners=new HashSet<OnSharedPreferenceChangeListener>(mListeners.keySet());
    }
synchronized (this) {
      if (mClear) {
        if (!mMap.isEmpty()) {
          changesMade=true;
          mMap.clear();
        }
        mClear=false;
      }
      for (      Entry<String,Object> e : mModified.entrySet()) {
        String k=e.getKey();
        Object v=e.getValue();
        if (v == this) {
          if (mMap.containsKey(k)) {
            mMap.remove(k);
            changesMade=true;
          }
        }
 else {
          boolean isSame=false;
          if (mMap.containsKey(k)) {
            Object existingValue=mMap.get(k);
            isSame=existingValue != null && existingValue.equals(v);
          }
          if (!isSame) {
            mMap.put(k,v);
            changesMade=true;
          }
        }
        if (hasListeners) {
          keysModified.add(k);
        }
      }
      mModified.clear();
    }
    returnValue=writeFileLocked(changesMade);
  }
  if (hasListeners) {
    for (int i=keysModified.size() - 1; i >= 0; i--) {
      final String key=keysModified.get(i);
      for (      OnSharedPreferenceChangeListener listener : listeners) {
        if (listener != null) {
          listener.onSharedPreferenceChanged(SharedPreferencesImpl.this,key);
        }
      }
    }
  }
  return returnValue;
}
