{
  if (pkg == null) {
    return INSTALL_PARSE_FAILED_NOT_APK;
  }
  StatFs internalFlashStats=new StatFs(Environment.getDataDirectory().getPath());
  StatFs sdcardStats=new StatFs(Environment.getExternalStorageDirectory().getPath());
  long totalInternalFlashSize=(long)internalFlashStats.getBlockCount() * (long)internalFlashStats.getBlockSize();
  long availInternalFlashSize=(long)internalFlashStats.getAvailableBlocks() * (long)internalFlashStats.getBlockSize();
  long availSDSize=(long)sdcardStats.getAvailableBlocks() * (long)sdcardStats.getBlockSize();
  double pctNandFree=(double)availInternalFlashSize / (double)totalInternalFlashSize;
  final String archiveFilePath=pkg.mScanPath;
  File apkFile=new File(archiveFilePath);
  long pkgLen=apkFile.length();
  boolean auto=true;
  long reqInstallSize=pkgLen;
  long reqInternalSize=1 * pkgLen;
  boolean intThresholdOk=(pctNandFree >= LOW_NAND_FLASH_TRESHOLD);
  boolean intAvailOk=((reqInstallSize + reqInternalSize) < availInternalFlashSize);
  boolean fitsOnSd=(reqInstallSize < availSDSize) && intThresholdOk && (reqInternalSize < availInternalFlashSize);
  boolean fitsOnInt=intThresholdOk && intAvailOk;
  boolean installOnlyOnSd=(pkg.installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL);
  boolean installOnlyInternal=(pkg.installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY);
  if (installOnlyInternal) {
    auto=false;
  }
 else   if (installOnlyOnSd) {
    if (fitsOnSd) {
      auto=false;
    }
  }
 else {
    boolean setInstallLoc=Settings.System.getInt(mContext.getContentResolver(),Settings.System.SET_INSTALL_LOCATION,0) != 0;
    if (setInstallLoc) {
      int installPreference=Settings.System.getInt(mContext.getContentResolver(),Settings.System.DEFAULT_INSTALL_LOCATION,PackageInfo.INSTALL_LOCATION_AUTO);
      if (installPreference == 1) {
        installOnlyInternal=true;
        auto=false;
      }
 else       if (installPreference == 2) {
        installOnlyOnSd=true;
        auto=false;
      }
    }
  }
  if (!auto) {
    if (installOnlyOnSd) {
      return fitsOnSd ? INSTALL_ON_SDCARD : INSTALL_FAILED_INSUFFICIENT_STORAGE;
    }
 else     if (installOnlyInternal) {
      return fitsOnInt ? INSTALL_ON_INTERNAL_FLASH : INSTALL_FAILED_INSUFFICIENT_STORAGE;
    }
  }
  if (fitsOnInt) {
    return INSTALL_ON_INTERNAL_FLASH;
  }
  if (fitsOnSd) {
    return INSTALL_ON_SDCARD;
  }
  return INSTALL_FAILED_INSUFFICIENT_STORAGE;
}
