{
  rs.validate();
  Type t=typeFromBitmap(rs,b,mips);
  if (mips == MipmapControl.MIPMAP_NONE && t.getElement().isCompatible(Element.RGBA_8888(rs)) && usage == (USAGE_SHARED | USAGE_SCRIPT)) {
    int id=rs.nAllocationCreateBitmapBackedAllocation(t.getID(rs),mips.mID,b,usage);
    if (id == 0) {
      throw new RSRuntimeException("Load failed.");
    }
    Allocation alloc=new Allocation(id,rs,t,usage);
    alloc.setBitmap(b);
    return alloc;
  }
  int id=rs.nAllocationCreateFromBitmap(t.getID(rs),mips.mID,b,usage);
  if (id == 0) {
    throw new RSRuntimeException("Load failed.");
  }
  return new Allocation(id,rs,t,usage);
}
