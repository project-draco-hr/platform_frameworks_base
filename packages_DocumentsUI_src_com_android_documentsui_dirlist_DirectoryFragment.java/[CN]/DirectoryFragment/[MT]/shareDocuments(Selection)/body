{
  Metrics.logUserAction(getContext(),Metrics.USER_ACTION_SHARE);
  new GetDocumentsTask(){
    @Override void onDocumentsReady(    List<DocumentInfo> docs){
      Intent intent;
      List<DocumentInfo> docsForSend=new ArrayList<>();
      for (      DocumentInfo doc : docs) {
        if (!doc.isDirectory() && !doc.isVirtualDocument()) {
          docsForSend.add(doc);
        }
      }
      if (docsForSend.size() == 1) {
        final DocumentInfo doc=docsForSend.get(0);
        intent=new Intent(Intent.ACTION_SEND);
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
        intent.addCategory(Intent.CATEGORY_DEFAULT);
        intent.setType(doc.mimeType);
        intent.putExtra(Intent.EXTRA_STREAM,doc.derivedUri);
      }
 else       if (docsForSend.size() > 1) {
        intent=new Intent(Intent.ACTION_SEND_MULTIPLE);
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
        intent.addCategory(Intent.CATEGORY_DEFAULT);
        final ArrayList<String> mimeTypes=new ArrayList<>();
        final ArrayList<Uri> uris=new ArrayList<>();
        for (        DocumentInfo doc : docsForSend) {
          mimeTypes.add(doc.mimeType);
          uris.add(doc.derivedUri);
        }
        intent.setType(findCommonMimeType(mimeTypes));
        intent.putParcelableArrayListExtra(Intent.EXTRA_STREAM,uris);
      }
 else {
        return;
      }
      intent=Intent.createChooser(intent,getActivity().getText(R.string.share_via));
      startActivity(intent);
    }
  }
.execute(selected);
}
