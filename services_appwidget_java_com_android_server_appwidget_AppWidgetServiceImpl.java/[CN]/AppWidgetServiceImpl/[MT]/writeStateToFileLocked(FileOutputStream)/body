{
  int N;
  try {
    XmlSerializer out=new FastXmlSerializer();
    out.setOutput(stream,"utf-8");
    out.startDocument(null,true);
    out.startTag(null,"gs");
    out.attribute(null,"version",String.valueOf(CURRENT_VERSION));
    int providerIndex=0;
    N=mInstalledProviders.size();
    for (int i=0; i < N; i++) {
      Provider p=mInstalledProviders.get(i);
      if (p.instances.size() > 0) {
        serializeProvider(out,p);
        p.tag=providerIndex;
        providerIndex++;
      }
    }
    N=mHosts.size();
    for (int i=0; i < N; i++) {
      Host host=mHosts.get(i);
      serializeHost(out,host);
      host.tag=i;
    }
    N=mAppWidgetIds.size();
    for (int i=0; i < N; i++) {
      AppWidgetId id=mAppWidgetIds.get(i);
      serializeAppWidgetId(out,id);
    }
    Iterator<String> it=mPackagesWithBindWidgetPermission.iterator();
    while (it.hasNext()) {
      out.startTag(null,"b");
      out.attribute(null,"packageName",it.next());
      out.endTag(null,"b");
    }
    out.endTag(null,"gs");
    out.endDocument();
    return true;
  }
 catch (  IOException e) {
    Slog.w(TAG,"Failed to write state: " + e);
    return false;
  }
}
