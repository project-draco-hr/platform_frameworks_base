{
  if (DEBUG) {
    Slog.i(TAG,"restoreFinished for " + userId);
  }
  final UserHandle userHandle=new UserHandle(userId);
synchronized (mLock) {
    Set<Map.Entry<Provider,ArrayList<RestoreUpdateRecord>>> providerEntries=mUpdatesByProvider.entrySet();
    for (    Map.Entry<Provider,ArrayList<RestoreUpdateRecord>> e : providerEntries) {
      Provider provider=e.getKey();
      ArrayList<RestoreUpdateRecord> updates=e.getValue();
      final int pending=countPendingUpdates(updates);
      if (DEBUG) {
        Slog.i(TAG,"Provider " + provider + " pending: "+ pending);
      }
      if (pending > 0) {
        int[] oldIds=new int[pending];
        int[] newIds=new int[pending];
        final int N=updates.size();
        int nextPending=0;
        for (int i=0; i < N; i++) {
          RestoreUpdateRecord r=updates.get(i);
          if (!r.notified) {
            r.notified=true;
            oldIds[nextPending]=r.oldId;
            newIds[nextPending]=r.newId;
            nextPending++;
            if (DEBUG) {
              Slog.i(TAG,"   " + r.oldId + " => "+ r.newId);
            }
          }
        }
        sendWidgetRestoreBroadcastLocked(AppWidgetManager.ACTION_APPWIDGET_RESTORED,provider,null,oldIds,newIds,userHandle);
      }
    }
    Set<Map.Entry<Host,ArrayList<RestoreUpdateRecord>>> hostEntries=mUpdatesByHost.entrySet();
    for (    Map.Entry<Host,ArrayList<RestoreUpdateRecord>> e : hostEntries) {
      Host host=e.getKey();
      if (host.id.uid != UNKNOWN_UID) {
        ArrayList<RestoreUpdateRecord> updates=e.getValue();
        final int pending=countPendingUpdates(updates);
        if (DEBUG) {
          Slog.i(TAG,"Host " + host + " pending: "+ pending);
        }
        if (pending > 0) {
          int[] oldIds=new int[pending];
          int[] newIds=new int[pending];
          final int N=updates.size();
          int nextPending=0;
          for (int i=0; i < N; i++) {
            RestoreUpdateRecord r=updates.get(i);
            if (!r.notified) {
              r.notified=true;
              oldIds[nextPending]=r.oldId;
              newIds[nextPending]=r.newId;
              nextPending++;
              if (DEBUG) {
                Slog.i(TAG,"   " + r.oldId + " => "+ r.newId);
              }
            }
          }
          sendWidgetRestoreBroadcastLocked(AppWidgetManager.ACTION_APPWIDGET_HOST_RESTORED,null,host,oldIds,newIds,userHandle);
        }
      }
    }
  }
}
