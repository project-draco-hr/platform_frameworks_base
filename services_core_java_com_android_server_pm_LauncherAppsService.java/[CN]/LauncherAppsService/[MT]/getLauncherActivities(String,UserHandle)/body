{
  ensureInUserProfiles(user,"Cannot retrieve activities for unrelated profile " + user);
  final Intent mainIntent=new Intent(Intent.ACTION_MAIN,null);
  mainIntent.addCategory(Intent.CATEGORY_LAUNCHER);
  long ident=Binder.clearCallingIdentity();
  try {
    List<ResolveInfo> apps=mPm.queryIntentActivitiesAsUser(mainIntent,0,user.getIdentifier());
    return apps;
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
}
