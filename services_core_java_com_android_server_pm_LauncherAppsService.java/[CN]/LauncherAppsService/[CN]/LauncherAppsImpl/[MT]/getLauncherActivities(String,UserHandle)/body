{
  ensureInUserProfiles(user,"Cannot retrieve activities for unrelated profile " + user);
  if (!isUserEnabled(user)) {
    return new ArrayList<ResolveInfo>();
  }
  final Intent mainIntent=new Intent(Intent.ACTION_MAIN,null);
  mainIntent.addCategory(Intent.CATEGORY_LAUNCHER);
  mainIntent.setPackage(packageName);
  long ident=Binder.clearCallingIdentity();
  try {
    List<ResolveInfo> apps=mPm.queryIntentActivitiesAsUser(mainIntent,PackageManager.NO_CROSS_PROFILE,user.getIdentifier());
    return apps;
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
}
