{
  boolean success=false;
synchronized (mLock) {
    PrintJobInfo printJob=getPrintJobInfo(printJobId,PrintManager.APP_ID_ANY);
    if (printJob != null) {
      success=true;
      printJob.setState(state);
      printJob.setStateReason(error);
      mNotificationController.onPrintJobStateChanged(printJob);
      if (DEBUG_PRINT_JOB_LIFECYCLE) {
        Slog.i(LOG_TAG,"[STATE CHANGED] " + printJob);
      }
switch (state) {
case PrintJobInfo.STATE_COMPLETED:
case PrintJobInfo.STATE_CANCELED:
        removePrintJobLocked(printJob);
case PrintJobInfo.STATE_FAILED:
{
        PrinterId printerId=printJob.getPrinterId();
        if (printerId != null) {
          ComponentName service=printerId.getServiceName();
          if (!hasActivePrintJobsForServiceLocked(service)) {
            sendOnAllPrintJobsForServiceHandled(service);
          }
        }
      }
    break;
case PrintJobInfo.STATE_QUEUED:
{
    sendOnPrintJobQueued(new PrintJobInfo(printJob));
  }
break;
}
if (shouldPersistPrintJob(printJob)) {
mPersistanceManager.writeStateLocked();
}
if (!hasActivePrintJobsLocked()) {
notifyOnAllPrintJobsHandled();
}
}
}
return success;
}
