{
  boolean animating=false;
  for (int stackNdx=mStacks.size() - 1; stackNdx >= 0; --stackNdx) {
    final TaskStack stack=mStacks.get(stackNdx);
    if (stack.isAnimating()) {
      animating=true;
    }
 else {
      if (stack.mDeferDetach) {
        mService.detachStackLocked(this,stack);
      }
      final ArrayList<Task> tasks=stack.getTasks();
      for (int taskNdx=tasks.size() - 1; taskNdx >= 0; --taskNdx) {
        final Task task=tasks.get(taskNdx);
        AppTokenList tokens=task.mAppTokens;
        for (int tokenNdx=tokens.size() - 1; tokenNdx >= 0; --tokenNdx) {
          AppWindowToken wtoken=tokens.get(tokenNdx);
          if (wtoken.mDeferRemoval) {
            stack.mExitingAppTokens.remove(wtoken);
            wtoken.mDeferRemoval=false;
            mService.removeAppFromTaskLocked(wtoken);
          }
        }
        if (task.mDeferRemoval) {
          task.mDeferRemoval=false;
          mService.removeTaskLocked(task);
        }
      }
    }
  }
  if (!animating && mDeferredRemoval) {
    mService.onDisplayRemoved(mDisplayId);
  }
}
