{
  final E[] allSpans=spanned.getSpans(start,limit,classType);
  final int length=allSpans.length;
  if (length > 0 && (spans == null || spans.length < length)) {
    spans=(E[])Array.newInstance(classType,length);
    spanStarts=new int[length];
    spanEnds=new int[length];
    spanFlags=new int[length];
  }
  numberOfSpans=0;
  for (int i=0; i < length; i++) {
    final E span=allSpans[i];
    final int spanStart=spanned.getSpanStart(span);
    final int spanEnd=spanned.getSpanEnd(span);
    if (spanStart == spanEnd)     continue;
    final int spanFlag=spanned.getSpanFlags(span);
    spans[numberOfSpans]=span;
    spanStarts[numberOfSpans]=spanStart;
    spanEnds[numberOfSpans]=spanEnd;
    spanFlags[numberOfSpans]=spanFlag;
    numberOfSpans++;
  }
}
