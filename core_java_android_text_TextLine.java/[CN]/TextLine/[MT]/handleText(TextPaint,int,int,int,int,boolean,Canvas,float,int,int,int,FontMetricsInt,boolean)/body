{
  float ret=0;
  int runLen=end - start;
  int contextLen=contextEnd - contextStart;
  if (needWidth || (c != null && (wp.bgColor != 0 || runIsRtl))) {
    int flags=runIsRtl ? Paint.DIRECTION_RTL : Paint.DIRECTION_LTR;
    if (mCharsValid) {
      ret=wp.getTextRunAdvances(mChars,start,runLen,contextStart,contextLen,flags,null,0);
    }
 else {
      int delta=mStart;
      ret=wp.getTextRunAdvances(mText,delta + start,delta + end,delta + contextStart,delta + contextEnd,flags,null,0);
    }
  }
  if (fmi != null) {
    expandMetricsFromPaint(fmi,wp);
  }
  if (c != null) {
    if (runIsRtl) {
      x-=ret;
    }
    if (wp.bgColor != 0) {
      int color=wp.getColor();
      Paint.Style s=wp.getStyle();
      wp.setColor(wp.bgColor);
      wp.setStyle(Paint.Style.FILL);
      c.drawRect(x,top,x + ret,bottom,wp);
      wp.setStyle(s);
      wp.setColor(color);
    }
    drawTextRun(c,wp,start,end,contextStart,contextEnd,runIsRtl,x,y + wp.baselineShift);
  }
  return runIsRtl ? -ret : ret;
}
