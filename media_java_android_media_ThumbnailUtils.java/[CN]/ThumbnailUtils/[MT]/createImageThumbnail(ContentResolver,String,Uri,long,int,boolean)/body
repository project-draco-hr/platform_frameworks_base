{
  boolean wantMini=(kind == Images.Thumbnails.MINI_KIND || saveMini);
  int targetSize=wantMini ? THUMBNAIL_TARGET_SIZE : MINI_THUMB_TARGET_SIZE;
  int maxPixels=wantMini ? THUMBNAIL_MAX_NUM_PIXELS : MINI_THUMB_MAX_NUM_PIXELS;
  SizedThumbnailBitmap sizedThumbnailBitmap=new SizedThumbnailBitmap();
  Bitmap bitmap=null;
  MediaFileType fileType=MediaFile.getFileType(filePath);
  if (fileType != null && fileType.fileType == MediaFile.FILE_TYPE_JPEG) {
    createThumbnailFromEXIF(filePath,targetSize,maxPixels,sizedThumbnailBitmap);
    bitmap=sizedThumbnailBitmap.mBitmap;
  }
  if (bitmap == null) {
    bitmap=makeBitmap(targetSize,maxPixels,uri,cr);
  }
  if (bitmap == null) {
    return null;
  }
  if (saveMini) {
    if (sizedThumbnailBitmap.mThumbnailData != null) {
      storeThumbnail(cr,origId,sizedThumbnailBitmap.mThumbnailData,sizedThumbnailBitmap.mThumbnailWidth,sizedThumbnailBitmap.mThumbnailHeight);
    }
 else {
      storeThumbnail(cr,origId,bitmap);
    }
  }
  if (kind == Images.Thumbnails.MICRO_KIND) {
    bitmap=extractMiniThumb(bitmap,MINI_THUMB_TARGET_SIZE,MINI_THUMB_TARGET_SIZE,RECYCLE_INPUT);
  }
  return bitmap;
}
