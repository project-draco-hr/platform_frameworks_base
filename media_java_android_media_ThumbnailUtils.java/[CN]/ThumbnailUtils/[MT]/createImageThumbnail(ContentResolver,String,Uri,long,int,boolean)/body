{
  boolean wantMini=(kind == Images.Thumbnails.MINI_KIND || saveMini);
  int targetSize=wantMini ? TARGET_SIZE_MINI_THUMBNAIL : TARGET_SIZE_MICRO_THUMBNAIL;
  int maxPixels=wantMini ? MAX_NUM_PIXELS_THUMBNAIL : MAX_NUM_PIXELS_MICRO_THUMBNAIL;
  SizedThumbnailBitmap sizedThumbnailBitmap=new SizedThumbnailBitmap();
  Bitmap bitmap=null;
  MediaFileType fileType=MediaFile.getFileType(filePath);
  if (fileType != null && fileType.fileType == MediaFile.FILE_TYPE_JPEG) {
    createThumbnailFromEXIF(filePath,targetSize,maxPixels,sizedThumbnailBitmap);
    bitmap=sizedThumbnailBitmap.mBitmap;
  }
  if (bitmap == null) {
    bitmap=makeBitmap(targetSize,maxPixels,uri,cr);
  }
  if (bitmap == null) {
    return null;
  }
  if (saveMini) {
    if (sizedThumbnailBitmap.mThumbnailData != null) {
      storeThumbnail(cr,origId,sizedThumbnailBitmap.mThumbnailData,sizedThumbnailBitmap.mThumbnailWidth,sizedThumbnailBitmap.mThumbnailHeight);
    }
 else {
      storeThumbnail(cr,origId,bitmap);
    }
  }
  if (kind == Images.Thumbnails.MICRO_KIND) {
    bitmap=extractThumbnail(bitmap,TARGET_SIZE_MICRO_THUMBNAIL,TARGET_SIZE_MICRO_THUMBNAIL,OPTIONS_RECYCLE_INPUT);
  }
  return bitmap;
}
