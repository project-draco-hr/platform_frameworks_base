{
  final String action=intent.getAction();
  if (action.equals(Intent.ACTION_BATTERY_CHANGED)) {
    if (testmode && !intent.getBooleanExtra("testmode",false))     return;
    level=(int)(100f * intent.getIntExtra(BatteryManager.EXTRA_LEVEL,0) / intent.getIntExtra(BatteryManager.EXTRA_SCALE,100));
    plugType=intent.getIntExtra(BatteryManager.EXTRA_PLUGGED,0);
    plugged=plugType != 0;
    health=intent.getIntExtra(BatteryManager.EXTRA_HEALTH,BatteryManager.BATTERY_HEALTH_UNKNOWN);
    status=intent.getIntExtra(BatteryManager.EXTRA_STATUS,BatteryManager.BATTERY_STATUS_UNKNOWN);
    technology=intent.getStringExtra(BatteryManager.EXTRA_TECHNOLOGY);
    voltage=intent.getIntExtra(BatteryManager.EXTRA_VOLTAGE,0);
    temperature=intent.getIntExtra(BatteryManager.EXTRA_TEMPERATURE,0);
    setContentDescription(context.getString(R.string.accessibility_battery_level,level));
    postInvalidate();
  }
 else   if (action.equals(ACTION_LEVEL_TEST)) {
    testmode=true;
    post(new Runnable(){
      int curLevel=0;
      int incr=1;
      int saveLevel=level;
      int savePlugged=plugType;
      Intent dummy=new Intent(Intent.ACTION_BATTERY_CHANGED);
      @Override public void run(){
        if (curLevel < 0) {
          testmode=false;
          dummy.putExtra("level",saveLevel);
          dummy.putExtra("plugged",savePlugged);
          dummy.putExtra("testmode",false);
        }
 else {
          dummy.putExtra("level",curLevel);
          dummy.putExtra("plugged",incr > 0 ? BatteryManager.BATTERY_PLUGGED_AC : 0);
          dummy.putExtra("testmode",true);
        }
        getContext().sendBroadcast(dummy);
        if (!testmode)         return;
        curLevel+=incr;
        if (curLevel == 100) {
          incr*=-1;
        }
        postDelayed(this,200);
      }
    }
);
  }
}
