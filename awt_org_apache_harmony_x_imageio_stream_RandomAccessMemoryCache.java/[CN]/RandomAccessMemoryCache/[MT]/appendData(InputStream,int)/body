{
  if (count <= 0) {
    return 0;
  }
  long startPos=length;
  long lastPos=length + count - 1;
  grow(lastPos);
  int blockIdx=(int)(startPos >> BLOCK_SHIFT);
  int offset=(int)(startPos & BLOCK_MASK);
  int bytesAppended=0;
  while (count > 0) {
    byte[] block=blocks.get(blockIdx);
    int toCopy=Math.min(BLOCK_SIZE - offset,count);
    count-=toCopy;
    while (toCopy > 0) {
      int bytesRead=is.read(block,offset,toCopy);
      if (bytesRead < 0) {
        length-=(count - bytesAppended);
        return bytesAppended;
      }
      toCopy-=bytesRead;
      offset+=bytesRead;
    }
    blockIdx++;
    offset=0;
  }
  return count;
}
