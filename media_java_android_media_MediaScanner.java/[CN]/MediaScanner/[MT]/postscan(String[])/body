{
  Iterator<FileCacheEntry> iterator=mFileCache.values().iterator();
  Uri.Builder builder=mFilesUri.buildUpon();
  builder.appendQueryParameter(MediaStore.PARAM_DELETE_DATA,"false");
  MediaBulkDeleter deleter=new MediaBulkDeleter(mMediaProvider,builder.build());
  while (iterator.hasNext()) {
    FileCacheEntry entry=iterator.next();
    String path=entry.mPath;
    boolean fileMissing=false;
    if (!entry.mSeenInFileSystem && !MtpConstants.isAbstractObject(entry.mFormat)) {
      if (inScanDirectory(path,directories)) {
        fileMissing=true;
      }
 else {
        File testFile=new File(path);
        if (!testFile.exists()) {
          fileMissing=true;
        }
      }
    }
    if (fileMissing) {
      MediaFile.MediaFileType mediaFileType=MediaFile.getFileType(path);
      int fileType=(mediaFileType == null ? 0 : mediaFileType.fileType);
      if (!MediaFile.isPlayListFileType(fileType)) {
        deleter.delete(entry.mRowId);
        iterator.remove();
        if (entry.mPath.toLowerCase(Locale.US).endsWith("/.nomedia")) {
          deleter.flush();
          File f=new File(path);
          mMediaProvider.call(MediaStore.UNHIDE_CALL,f.getParent(),null);
        }
      }
    }
  }
  deleter.flush();
  if (mProcessPlaylists) {
    processPlayLists();
  }
  if (mOriginalCount == 0 && mImagesUri.equals(Images.Media.getContentUri("external")))   pruneDeadThumbnailFiles();
  mPlayLists=null;
  mFileCache=null;
  mMediaProvider=null;
}
