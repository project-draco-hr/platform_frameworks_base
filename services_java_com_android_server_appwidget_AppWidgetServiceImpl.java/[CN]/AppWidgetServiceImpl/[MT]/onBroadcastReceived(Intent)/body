{
  if (DBG)   log("onBroadcast " + intent);
  final String action=intent.getAction();
  boolean added=false;
  boolean changed=false;
  boolean providersModified=false;
  String pkgList[]=null;
  if (Intent.ACTION_EXTERNAL_APPLICATIONS_AVAILABLE.equals(action)) {
    pkgList=intent.getStringArrayExtra(Intent.EXTRA_CHANGED_PACKAGE_LIST);
    added=true;
  }
 else   if (Intent.ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE.equals(action)) {
    pkgList=intent.getStringArrayExtra(Intent.EXTRA_CHANGED_PACKAGE_LIST);
    added=false;
  }
 else {
    Uri uri=intent.getData();
    if (uri == null) {
      return;
    }
    String pkgName=uri.getSchemeSpecificPart();
    if (pkgName == null) {
      return;
    }
    pkgList=new String[]{pkgName};
    added=Intent.ACTION_PACKAGE_ADDED.equals(action);
    changed=Intent.ACTION_PACKAGE_CHANGED.equals(action);
  }
  if (pkgList == null || pkgList.length == 0) {
    return;
  }
  if (added || changed) {
synchronized (mAppWidgetIds) {
      ensureStateLoadedLocked();
      Bundle extras=intent.getExtras();
      if (changed || (extras != null && extras.getBoolean(Intent.EXTRA_REPLACING,false))) {
        for (        String pkgName : pkgList) {
          providersModified|=updateProvidersForPackageLocked(pkgName,null);
        }
      }
 else {
        for (        String pkgName : pkgList) {
          providersModified|=addProvidersForPackageLocked(pkgName);
        }
      }
      saveStateAsync();
    }
  }
 else {
    Bundle extras=intent.getExtras();
    if (extras != null && extras.getBoolean(Intent.EXTRA_REPLACING,false)) {
    }
 else {
synchronized (mAppWidgetIds) {
        ensureStateLoadedLocked();
        for (        String pkgName : pkgList) {
          providersModified|=removeProvidersForPackageLocked(pkgName);
          saveStateAsync();
        }
      }
    }
  }
  if (providersModified) {
synchronized (mAppWidgetIds) {
      ensureStateLoadedLocked();
      notifyHostsForProvidersChangedLocked();
    }
  }
}
