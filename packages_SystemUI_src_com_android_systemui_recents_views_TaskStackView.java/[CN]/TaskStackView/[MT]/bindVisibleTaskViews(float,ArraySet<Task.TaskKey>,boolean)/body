{
  ArrayList<Task> tasks=mStack.getStackTasks();
  int[] visibleTaskRange=computeVisibleTaskTransforms(mCurrentTaskTransforms,tasks,mStackScroller.getStackScroll(),targetStackScroll,ignoreTasksSet,ignoreTaskOverrides);
  mTmpTaskViewMap.clear();
  List<TaskView> taskViews=getTaskViews();
  int lastFocusedTaskIndex=-1;
  int taskViewCount=taskViews.size();
  for (int i=taskViewCount - 1; i >= 0; i--) {
    TaskView tv=taskViews.get(i);
    Task task=tv.getTask();
    if (ignoreTasksSet.contains(task.key)) {
      continue;
    }
    int taskIndex=mStack.indexOfStackTask(task);
    TaskViewTransform transform=null;
    if (taskIndex != -1) {
      transform=mCurrentTaskTransforms.get(taskIndex);
    }
    if (task.isFreeformTask() || (transform != null && transform.visible)) {
      mTmpTaskViewMap.put(task.key,tv);
    }
 else {
      if (mTouchExplorationEnabled) {
        lastFocusedTaskIndex=taskIndex;
        resetFocusedTask(task);
      }
      mViewPool.returnViewToPool(tv);
    }
  }
  for (int i=tasks.size() - 1; i >= 0; i--) {
    Task task=tasks.get(i);
    TaskViewTransform transform=mCurrentTaskTransforms.get(i);
    if (ignoreTasksSet.contains(task.key)) {
      continue;
    }
    if (!task.isFreeformTask() && !transform.visible) {
      continue;
    }
    TaskView tv=mTmpTaskViewMap.get(task.key);
    if (tv == null) {
      tv=mViewPool.pickUpViewFromPool(task,task);
      if (task.isFreeformTask()) {
        tv.updateViewPropertiesToTaskTransform(transform,AnimationProps.IMMEDIATE,mRequestUpdateClippingListener);
      }
 else {
        if (transform.rect.top <= mLayoutAlgorithm.mStackRect.top) {
          tv.updateViewPropertiesToTaskTransform(mLayoutAlgorithm.getBackOfStackTransform(),AnimationProps.IMMEDIATE,mRequestUpdateClippingListener);
        }
 else {
          tv.updateViewPropertiesToTaskTransform(mLayoutAlgorithm.getFrontOfStackTransform(),AnimationProps.IMMEDIATE,mRequestUpdateClippingListener);
        }
      }
    }
 else {
      final int taskIndex=mStack.indexOfStackTask(task);
      final int insertIndex=findTaskViewInsertIndex(task,taskIndex);
      if (insertIndex != getTaskViews().indexOf(tv)) {
        detachViewFromParent(tv);
        attachViewToParent(tv,insertIndex,tv.getLayoutParams());
        updateTaskViewsList();
      }
    }
  }
  if (lastFocusedTaskIndex != -1) {
    if (lastFocusedTaskIndex < visibleTaskRange[1]) {
      setFocusedTask(visibleTaskRange[1],false,true);
    }
 else {
      setFocusedTask(visibleTaskRange[0],false,true);
    }
  }
}
