{
  if (isConnected()) {
    throw new IllegalStateException("Already connected.");
  }
  mHandlerThread=new HandlerThread("UiTestAutomationBridge");
  mHandlerThread.setDaemon(true);
  mHandlerThread.start();
  Looper looper=mHandlerThread.getLooper();
  mListener=new IAccessibilityServiceClientWrapper(null,looper,new Callbacks(){
    @Override public void onServiceConnected(){
    }
    @Override public void onInterrupt(){
      UiTestAutomationBridge.this.onInterrupt();
    }
    @Override public void onAccessibilityEvent(    AccessibilityEvent event){
synchronized (mLock) {
        while (true) {
          mLastEvent=AccessibilityEvent.obtain(event);
          if (!mWaitingForEventDelivery) {
            mLock.notifyAll();
            break;
          }
          if (!mUnprocessedEventAvailable) {
            mUnprocessedEventAvailable=true;
            mLock.notifyAll();
            break;
          }
          try {
            mLock.wait();
          }
 catch (          InterruptedException ie) {
          }
        }
      }
      UiTestAutomationBridge.this.onAccessibilityEvent(event);
    }
    @Override public void onSetConnectionId(    int connectionId){
synchronized (mLock) {
        mConnectionId=connectionId;
        mLock.notifyAll();
      }
    }
    @Override public boolean onGesture(    int gestureId){
      return false;
    }
  }
);
  final IAccessibilityManager manager=IAccessibilityManager.Stub.asInterface(ServiceManager.getService(Context.ACCESSIBILITY_SERVICE));
  final AccessibilityServiceInfo info=new AccessibilityServiceInfo();
  info.eventTypes=AccessibilityEvent.TYPES_ALL_MASK;
  info.feedbackType=AccessibilityServiceInfo.FEEDBACK_GENERIC;
  info.flags|=AccessibilityServiceInfo.INCLUDE_NOT_IMPORTANT_VIEWS;
  try {
    manager.registerUiTestAutomationService(mListener,info);
  }
 catch (  RemoteException re) {
    throw new IllegalStateException("Cound not register UiAutomationService.",re);
  }
synchronized (mLock) {
    final long startTimeMillis=SystemClock.uptimeMillis();
    while (true) {
      if (isConnected()) {
        return;
      }
      final long elapsedTimeMillis=SystemClock.uptimeMillis() - startTimeMillis;
      final long remainingTimeMillis=TIMEOUT_REGISTER_SERVICE - elapsedTimeMillis;
      if (remainingTimeMillis <= 0) {
        throw new IllegalStateException("Cound not register UiAutomationService.");
      }
      try {
        mLock.wait(remainingTimeMillis);
      }
 catch (      InterruptedException ie) {
      }
    }
  }
}
