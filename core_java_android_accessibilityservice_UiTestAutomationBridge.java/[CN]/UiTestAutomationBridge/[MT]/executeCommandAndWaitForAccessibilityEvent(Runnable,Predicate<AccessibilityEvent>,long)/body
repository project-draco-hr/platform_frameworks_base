{
synchronized (mLock) {
    mWaitingForEventDelivery=true;
    mUnprocessedEventAvailable=false;
    if (mLastEvent != null) {
      mLastEvent.recycle();
      mLastEvent=null;
    }
    command.run();
    final long startTimeMillis=SystemClock.uptimeMillis();
    while (true) {
      if ((mUnprocessedEventAvailable && predicate.apply(mLastEvent))) {
        mWaitingForEventDelivery=false;
        mUnprocessedEventAvailable=false;
        mLock.notifyAll();
        return mLastEvent;
      }
      mWaitingForEventDelivery=true;
      mUnprocessedEventAvailable=false;
      mLock.notifyAll();
      final long elapsedTimeMillis=SystemClock.uptimeMillis() - startTimeMillis;
      final long remainingTimeMillis=timeoutMillis - elapsedTimeMillis;
      if (remainingTimeMillis <= 0) {
        mWaitingForEventDelivery=false;
        mUnprocessedEventAvailable=false;
        mLock.notifyAll();
        throw new TimeoutException("Expacted event not received within: " + timeoutMillis + " ms.");
      }
      try {
        mLock.wait(remainingTimeMillis);
      }
 catch (      InterruptedException ie) {
      }
    }
  }
}
