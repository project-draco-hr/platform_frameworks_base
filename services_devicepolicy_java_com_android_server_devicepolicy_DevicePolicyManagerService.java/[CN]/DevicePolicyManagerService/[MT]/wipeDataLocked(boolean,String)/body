{
  boolean forceExtWipe=!Environment.isExternalStorageRemovable() && isExtStorageEncrypted();
  if ((forceExtWipe || wipeExtRequested) && !Environment.isExternalStorageEmulated()) {
    Intent intent=new Intent(ExternalStorageFormatter.FORMAT_AND_FACTORY_RESET);
    intent.putExtra(ExternalStorageFormatter.EXTRA_ALWAYS_RESET,true);
    intent.putExtra(Intent.EXTRA_REASON,reason);
    intent.setComponent(ExternalStorageFormatter.COMPONENT_NAME);
    mWakeLock.acquire(10000);
    mContext.startService(intent);
  }
 else {
    try {
      RecoverySystem.rebootWipeUserData(mContext,reason);
    }
 catch (    IOException|SecurityException e) {
      Slog.w(LOG_TAG,"Failed requesting data wipe",e);
    }
  }
}
