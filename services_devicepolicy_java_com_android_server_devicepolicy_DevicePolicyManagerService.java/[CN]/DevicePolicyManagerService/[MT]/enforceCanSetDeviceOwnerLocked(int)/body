{
  if (mOwners.hasDeviceOwner()) {
    throw new IllegalStateException("Trying to set the device owner, but device owner " + "is already set.");
  }
  if (mOwners.hasProfileOwner(userId)) {
    throw new IllegalStateException("Trying to set the device owner, but the user already " + "has a profile owner.");
  }
  if (!mUserManager.isUserRunning(new UserHandle(userId))) {
    throw new IllegalStateException("User not running: " + userId);
  }
  int callingUid=mInjector.binderGetCallingUid();
  if (callingUid == Process.SHELL_UID || callingUid == Process.ROOT_UID) {
    if (!hasUserSetupCompleted(UserHandle.USER_SYSTEM)) {
      return;
    }
    if (!mInjector.userManagerIsSplitSystemUser()) {
      if (mUserManager.getUserCount() > 1) {
        throw new IllegalStateException("Not allowed to set the device owner because there " + "are already several users on the device");
      }
      if (AccountManager.get(mContext).getAccounts().length > 0) {
        throw new IllegalStateException("Not allowed to set the device owner because there " + "are already some accounts on the device");
      }
    }
    return;
  }
  mContext.enforceCallingOrSelfPermission(android.Manifest.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS,null);
  if (!mInjector.userManagerIsSplitSystemUser()) {
    if (hasUserSetupCompleted(UserHandle.USER_SYSTEM)) {
      throw new IllegalStateException("Cannot set the device owner if the device is " + "already set-up");
    }
  }
}
