{
  if (!mHasFeature) {
    return;
  }
  if (userHandle != mOwners.getDeviceOwnerUserId() && !mOwners.hasProfileOwner(userHandle) && getManagedUserId(userHandle) == -1) {
    throw new IllegalStateException("Not allowed to change provisioning state unless a " + "device or profile owner is set.");
  }
synchronized (this) {
    boolean transitionCheckNeeded=true;
    final int callingUid=mInjector.binderGetCallingUid();
    if (callingUid == Process.SHELL_UID || callingUid == Process.ROOT_UID) {
      if (getUserProvisioningState(userHandle) != DevicePolicyManager.STATE_USER_UNMANAGED || newState != DevicePolicyManager.STATE_USER_SETUP_FINALIZED) {
        throw new IllegalStateException("Not allowed to change provisioning state " + "unless current provisioning state is unmanaged, and new state is " + "finalized.");
      }
      transitionCheckNeeded=false;
    }
 else {
      mContext.enforceCallingOrSelfPermission(android.Manifest.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS,null);
    }
    final DevicePolicyData policyData=getUserData(userHandle);
    if (transitionCheckNeeded) {
      checkUserProvisioningStateTransition(policyData.mUserProvisioningState,newState);
    }
    policyData.mUserProvisioningState=newState;
    saveSettingsLocked(userHandle);
  }
}
