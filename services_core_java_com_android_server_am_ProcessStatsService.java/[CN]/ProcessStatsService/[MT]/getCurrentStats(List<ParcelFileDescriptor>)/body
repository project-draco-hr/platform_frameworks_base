{
  mAm.mContext.enforceCallingOrSelfPermission(android.Manifest.permission.PACKAGE_USAGE_STATS,null);
  Parcel current=Parcel.obtain();
synchronized (mAm) {
    long now=SystemClock.uptimeMillis();
    mProcessStats.mTimePeriodEndRealtime=SystemClock.elapsedRealtime();
    mProcessStats.mTimePeriodEndUptime=now;
    mProcessStats.writeToParcel(current,now,0);
  }
  mWriteLock.lock();
  try {
    if (historic != null) {
      ArrayList<String> files=getCommittedFiles(0,false,true);
      if (files != null) {
        for (int i=files.size() - 1; i >= 0; i--) {
          try {
            ParcelFileDescriptor pfd=ParcelFileDescriptor.open(new File(files.get(i)),ParcelFileDescriptor.MODE_READ_ONLY);
            historic.add(pfd);
          }
 catch (          IOException e) {
            Slog.w(TAG,"Failure opening procstat file " + files.get(i),e);
          }
        }
      }
    }
  }
  finally {
    mWriteLock.unlock();
  }
  return current.marshall();
}
