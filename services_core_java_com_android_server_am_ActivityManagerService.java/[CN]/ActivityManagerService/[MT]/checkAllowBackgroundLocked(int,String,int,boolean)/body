{
  UidRecord uidRec=mActiveUids.get(uid);
  if (!mLenientBackgroundCheck) {
    if (!allowWhenForeground || uidRec == null || uidRec.curProcState >= ActivityManager.PROCESS_STATE_IMPORTANT_BACKGROUND) {
      if (mAppOpsService.noteOperation(AppOpsManager.OP_RUN_IN_BACKGROUND,uid,packageName) != AppOpsManager.MODE_ALLOWED) {
        return ActivityManager.APP_START_MODE_DELAYED;
      }
    }
  }
 else   if (uidRec == null || uidRec.idle) {
    if (callingPid >= 0) {
      ProcessRecord proc;
synchronized (mPidsSelfLocked) {
        proc=mPidsSelfLocked.get(callingPid);
      }
      if (proc != null && proc.curProcState < ActivityManager.PROCESS_STATE_RECEIVER) {
        return ActivityManager.APP_START_MODE_NORMAL;
      }
    }
    if (mAppOpsService.noteOperation(AppOpsManager.OP_RUN_IN_BACKGROUND,uid,packageName) != AppOpsManager.MODE_ALLOWED) {
      return ActivityManager.APP_START_MODE_DELAYED;
    }
  }
  return ActivityManager.APP_START_MODE_NORMAL;
}
