{
  int pid=app.pid;
  boolean kept=cleanUpApplicationRecordLocked(app,restarting,allowRestart,-1);
  if (!kept && !restarting) {
    removeLruProcessLocked(app);
    if (pid > 0) {
      ProcessList.remove(pid);
    }
  }
  if (mProfileProc == app) {
    clearProfilerLocked();
  }
  boolean hasVisibleActivities=mStackSupervisor.handleAppDiedLocked(app);
  app.activities.clear();
  if (app.instrumentationClass != null) {
    Slog.w(TAG,"Crash of app " + app.processName + " running instrumentation "+ app.instrumentationClass);
    Bundle info=new Bundle();
    info.putString("shortMsg","Process crashed.");
    finishInstrumentationLocked(app,Activity.RESULT_CANCELED,info);
  }
  if (!restarting && hasVisibleActivities && !mStackSupervisor.resumeTopActivitiesLocked()) {
    mStackSupervisor.ensureActivitiesVisibleLocked(null,0,!PRESERVE_WINDOWS);
  }
}
