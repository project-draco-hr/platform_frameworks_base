{
  final long origId=Binder.clearCallingIdentity();
  try {
synchronized (this) {
      if (!mSupportsPictureInPicture) {
        throw new IllegalStateException("enterPictureInPictureMode: " + "Device doesn't support picture-in-picture mode.");
      }
      final ActivityRecord r=ActivityRecord.forTokenLocked(token);
      if (r == null) {
        throw new IllegalStateException("enterPictureInPictureMode: " + "Can't find activity for token=" + token);
      }
      if (!r.info.supportsPip) {
        throw new IllegalArgumentException("enterPictureInPictureMode: " + "Picture-In-Picture not supported for r=" + r);
      }
      final Rect bounds=(mStackSupervisor.getStack(PINNED_STACK_ID) == null) ? mDefaultPinnedStackBounds : null;
      mStackSupervisor.moveActivityToStackLocked(r,PINNED_STACK_ID,"enterPictureInPictureMode",bounds);
    }
  }
  finally {
    Binder.restoreCallingIdentity(origId);
  }
}
