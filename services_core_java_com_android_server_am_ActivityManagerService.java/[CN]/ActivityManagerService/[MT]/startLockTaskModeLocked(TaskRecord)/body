{
  final String pkg=task.intent.getComponent().getPackageName();
  boolean isSystemInitiated=Binder.getCallingUid() == Process.SYSTEM_UID;
  long ident=Binder.clearCallingIdentity();
  try {
    if (!isSystemInitiated && !isLockTaskAuthorizedLocked(pkg)) {
      StatusBarManagerInternal statusBarManager=LocalServices.getService(StatusBarManagerInternal.class);
      if (statusBarManager != null) {
        statusBarManager.showScreenPinningRequest();
      }
      return;
    }
    final ActivityStack stack=mStackSupervisor.getFocusedStack();
    if (!isSystemInitiated && (stack == null || task != stack.topTask())) {
      throw new IllegalArgumentException("Invalid task, not in foreground");
    }
    mStackSupervisor.setLockTaskModeLocked(task,isSystemInitiated ? ActivityManager.LOCK_TASK_MODE_PINNED : ActivityManager.LOCK_TASK_MODE_LOCKED,"startLockTask");
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
}
