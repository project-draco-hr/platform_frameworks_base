{
  long timeMillis=System.currentTimeMillis();
  String shortMsg=crashInfo.exceptionClassName;
  String longMsg=crashInfo.exceptionMessage;
  String stackTrace=crashInfo.stackTrace;
  if (shortMsg != null && longMsg != null) {
    longMsg=shortMsg + ": " + longMsg;
  }
 else   if (shortMsg != null) {
    longMsg=shortMsg;
  }
  AppErrorResult result=new AppErrorResult();
synchronized (this) {
    if (mController != null) {
      try {
        String name=r != null ? r.processName : null;
        int pid=r != null ? r.pid : Binder.getCallingPid();
        int uid=r != null ? r.info.uid : Binder.getCallingUid();
        if (!mController.appCrashed(name,pid,shortMsg,longMsg,timeMillis,crashInfo.stackTrace)) {
          if ("1".equals(SystemProperties.get(SYSTEM_DEBUGGABLE,"0")) && "Native crash".equals(crashInfo.exceptionClassName)) {
            Slog.w(TAG,"Skip killing native crashed app " + name + "("+ pid+ ") during testing");
          }
 else {
            Slog.w(TAG,"Force-killing crashed app " + name + " at watcher's request");
            if (r != null) {
              r.kill("crash",true);
            }
 else {
              Process.killProcess(pid);
              killProcessGroup(uid,pid);
            }
          }
          return;
        }
      }
 catch (      RemoteException e) {
        mController=null;
        Watchdog.getInstance().setActivityController(null);
      }
    }
    final long origId=Binder.clearCallingIdentity();
    if (r != null && r.instrumentationClass != null) {
      Slog.w(TAG,"Error in app " + r.processName + " running instrumentation "+ r.instrumentationClass+ ":");
      if (shortMsg != null)       Slog.w(TAG,"  " + shortMsg);
      if (longMsg != null)       Slog.w(TAG,"  " + longMsg);
      Bundle info=new Bundle();
      info.putString("shortMsg",shortMsg);
      info.putString("longMsg",longMsg);
      finishInstrumentationLocked(r,Activity.RESULT_CANCELED,info);
      Binder.restoreCallingIdentity(origId);
      return;
    }
    if (r != null) {
      mBatteryStatsService.noteProcessCrash(r.processName,r.uid);
    }
    if (r == null || !makeAppCrashingLocked(r,shortMsg,longMsg,stackTrace)) {
      Binder.restoreCallingIdentity(origId);
      return;
    }
    Message msg=Message.obtain();
    msg.what=SHOW_ERROR_MSG;
    HashMap data=new HashMap();
    data.put("result",result);
    data.put("app",r);
    msg.obj=data;
    mUiHandler.sendMessage(msg);
    Binder.restoreCallingIdentity(origId);
  }
  int res=result.get();
  Intent appErrorIntent=null;
synchronized (this) {
    if (r != null && !r.isolated) {
      mProcessCrashTimes.put(r.info.processName,r.uid,SystemClock.uptimeMillis());
    }
    if (res == AppErrorDialog.FORCE_QUIT_AND_REPORT) {
      appErrorIntent=createAppErrorIntentLocked(r,timeMillis,crashInfo);
    }
  }
  if (appErrorIntent != null) {
    try {
      mContext.startActivityAsUser(appErrorIntent,new UserHandle(r.userId));
    }
 catch (    ActivityNotFoundException e) {
      Slog.w(TAG,"bug report receiver dissappeared",e);
    }
  }
}
