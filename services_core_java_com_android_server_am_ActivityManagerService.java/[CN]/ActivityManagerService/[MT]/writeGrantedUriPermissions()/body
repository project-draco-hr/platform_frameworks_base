{
  if (DEBUG_URI_PERMISSION)   Slog.v(TAG_URI_PERMISSION,"writeGrantedUriPermissions()");
  ArrayList<UriPermission.Snapshot> persist=Lists.newArrayList();
synchronized (this) {
    final int size=mGrantedUriPermissions.size();
    for (int i=0; i < size; i++) {
      final ArrayMap<GrantUri,UriPermission> perms=mGrantedUriPermissions.valueAt(i);
      for (      UriPermission perm : perms.values()) {
        if (perm.persistedModeFlags != 0) {
          persist.add(perm.snapshot());
        }
      }
    }
  }
  FileOutputStream fos=null;
  try {
    fos=mGrantFile.startWrite();
    XmlSerializer out=new FastXmlSerializer();
    out.setOutput(fos,StandardCharsets.UTF_8.name());
    out.startDocument(null,true);
    out.startTag(null,TAG_URI_GRANTS);
    for (    UriPermission.Snapshot perm : persist) {
      out.startTag(null,TAG_URI_GRANT);
      writeIntAttribute(out,ATTR_SOURCE_USER_ID,perm.uri.sourceUserId);
      writeIntAttribute(out,ATTR_TARGET_USER_ID,perm.targetUserId);
      out.attribute(null,ATTR_SOURCE_PKG,perm.sourcePkg);
      out.attribute(null,ATTR_TARGET_PKG,perm.targetPkg);
      out.attribute(null,ATTR_URI,String.valueOf(perm.uri.uri));
      writeBooleanAttribute(out,ATTR_PREFIX,perm.uri.prefix);
      writeIntAttribute(out,ATTR_MODE_FLAGS,perm.persistedModeFlags);
      writeLongAttribute(out,ATTR_CREATED_TIME,perm.persistedCreateTime);
      out.endTag(null,TAG_URI_GRANT);
    }
    out.endTag(null,TAG_URI_GRANTS);
    out.endDocument();
    mGrantFile.finishWrite(fos);
  }
 catch (  IOException e) {
    if (fos != null) {
      mGrantFile.failWrite(fos);
    }
  }
}
