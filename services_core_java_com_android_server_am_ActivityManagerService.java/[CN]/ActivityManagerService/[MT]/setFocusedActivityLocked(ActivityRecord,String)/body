{
  if (r != null && mFocusedActivity != r) {
    if (DEBUG_FOCUS)     Slog.d(TAG_FOCUS,"setFocusedActivityLocked: r=" + r);
    ActivityRecord last=mFocusedActivity;
    mFocusedActivity=r;
    if (r.task.taskType != ActivityRecord.HOME_ACTIVITY_TYPE && r.task.taskType != ActivityRecord.RECENTS_ACTIVITY_TYPE) {
      if (mCurAppTimeTracker != r.appTimeTracker) {
        if (mCurAppTimeTracker != null) {
          mCurAppTimeTracker.stop();
          mHandler.obtainMessage(REPORT_TIME_TRACKER_MSG,mCurAppTimeTracker).sendToTarget();
          mStackSupervisor.clearOtherAppTimeTrackers(r.appTimeTracker);
          mCurAppTimeTracker=null;
        }
        if (r.appTimeTracker != null) {
          mCurAppTimeTracker=r.appTimeTracker;
          startTimeTrackingFocusedActivityLocked();
        }
      }
 else {
        startTimeTrackingFocusedActivityLocked();
      }
    }
 else {
      r.appTimeTracker=null;
    }
    if (r.task != null && r.task.voiceInteractor != null) {
      startRunningVoiceLocked(r.task.voiceSession,r.info.applicationInfo.uid);
    }
 else {
      finishRunningVoiceLocked();
      if (last != null && last.task.voiceSession != null) {
        finishVoiceTask(last.task.voiceSession);
      }
    }
    if (mStackSupervisor.setFocusedStack(r,reason + " setFocusedActivity")) {
      mWindowManager.setFocusedApp(r.appToken,true);
    }
    applyUpdateLockStateLocked(r);
    if (mFocusedActivity.userId != mLastFocusedUserId) {
      mHandler.removeMessages(FOREGROUND_PROFILE_CHANGED_MSG);
      mHandler.sendMessage(mHandler.obtainMessage(FOREGROUND_PROFILE_CHANGED_MSG,mFocusedActivity.userId,0));
      mLastFocusedUserId=mFocusedActivity.userId;
    }
  }
  EventLog.writeEvent(EventLogTags.AM_FOCUSED_ACTIVITY,mFocusedActivity == null ? -1 : mFocusedActivity.userId,mFocusedActivity == null ? "NULL" : mFocusedActivity.shortComponentName);
}
