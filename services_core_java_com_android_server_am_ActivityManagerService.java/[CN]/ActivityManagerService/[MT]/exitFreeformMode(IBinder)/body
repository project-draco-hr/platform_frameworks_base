{
synchronized (this) {
    long ident=Binder.clearCallingIdentity();
    try {
      final ActivityRecord r=ActivityRecord.forTokenLocked(token);
      if (r == null) {
        throw new IllegalArgumentException("exitFreeformMode: No activity record matching token=" + token);
      }
      final ActivityStack stack=r.getStackLocked(token);
      if (stack == null || stack.mStackId != FREEFORM_WORKSPACE_STACK_ID) {
        throw new IllegalStateException("exitFreeformMode: You can only go fullscreen from freeform.");
      }
      if (DEBUG_STACK)       Slog.d(TAG_STACK,"exitFreeformMode: " + r);
      mStackSupervisor.moveTaskToStackLocked(r.task.taskId,FULLSCREEN_WORKSPACE_STACK_ID,ON_TOP,!FORCE_FOCUS,"exitFreeformMode",ANIMATE);
    }
  finally {
      Binder.restoreCallingIdentity(ident);
    }
  }
}
