{
  String firstPackage="first";
  String secondPackage="second";
  WebViewProviderInfo[] packages=new WebViewProviderInfo[]{new WebViewProviderInfo(firstPackage,"",true,false,null),new WebViewProviderInfo(secondPackage,"",true,false,null)};
  setupWithPackages(packages);
  setEnabledAndValidPackageInfos(packages);
  mWebViewUpdateServiceImpl.prepareWebViewInSystemServer();
  Mockito.verify(mTestSystemImpl).onWebViewProviderChanged(Mockito.argThat(new IsPackageInfoWithName(firstPackage)));
  mWebViewUpdateServiceImpl.changeProviderAndSetting(secondPackage);
  mTestSystemImpl.setPackageInfo(createPackageInfo(firstPackage,true,false));
  mTestSystemImpl.setPackageInfo(createPackageInfo(secondPackage,true,false));
  mWebViewUpdateServiceImpl.notifyRelroCreationCompleted();
  WebViewProviderResponse response=mWebViewUpdateServiceImpl.waitForAndGetProvider();
  assertEquals(WebViewFactory.LIBLOAD_FAILED_LISTING_WEBVIEW_PACKAGES,response.status);
  mTestSystemImpl.setPackageInfo(createPackageInfo(firstPackage,true,true));
  mWebViewUpdateServiceImpl.packageStateChanged(firstPackage,WebViewUpdateService.PACKAGE_ADDED);
  Mockito.verify(mTestSystemImpl,Mockito.times(2)).onWebViewProviderChanged(Mockito.argThat(new IsPackageInfoWithName(firstPackage)));
  mWebViewUpdateServiceImpl.notifyRelroCreationCompleted();
  response=mWebViewUpdateServiceImpl.waitForAndGetProvider();
  assertEquals(WebViewFactory.LIBLOAD_SUCCESS,response.status);
  assertEquals(firstPackage,response.packageInfo.packageName);
}
