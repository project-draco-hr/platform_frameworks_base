{
  super.onPrepareOptionsMenu(menu);
  final Document cwd=getCurrentDirectory();
  final MenuItem createDir=menu.findItem(R.id.menu_create_dir);
  createDir.setVisible(mAction == ACTION_CREATE);
  createDir.setEnabled(cwd != null && cwd.isCreateSupported());
  final MenuItem search=menu.findItem(R.id.menu_search);
  search.setVisible(cwd != null && cwd.isSearchSupported());
  if (mAction == ACTION_CREATE) {
    final FragmentManager fm=getFragmentManager();
    SaveFragment.get(fm).setSaveEnabled(cwd != null && cwd.isCreateSupported());
  }
  menu.findItem(R.id.menu_grid).setVisible(mDisplayState.mode != DisplayState.MODE_GRID);
  menu.findItem(R.id.menu_list).setVisible(mDisplayState.mode != DisplayState.MODE_LIST);
  return true;
}
