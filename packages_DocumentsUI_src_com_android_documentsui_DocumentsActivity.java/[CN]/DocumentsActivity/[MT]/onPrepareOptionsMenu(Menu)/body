{
  super.onPrepareOptionsMenu(menu);
  final FragmentManager fm=getFragmentManager();
  final DocumentInfo cwd=getCurrentDirectory();
  final MenuItem createDir=menu.findItem(R.id.menu_create_dir);
  final MenuItem search=menu.findItem(R.id.menu_search);
  final MenuItem grid=menu.findItem(R.id.menu_grid);
  final MenuItem list=menu.findItem(R.id.menu_list);
  final MenuItem settings=menu.findItem(R.id.menu_settings);
  grid.setVisible(mDisplayState.mode != MODE_GRID);
  list.setVisible(mDisplayState.mode != MODE_LIST);
  final boolean searchVisible;
  if (mAction == ACTION_CREATE) {
    createDir.setVisible(cwd != null && cwd.isCreateSupported());
    searchVisible=false;
    if (cwd == null) {
      grid.setVisible(false);
      list.setVisible(false);
    }
    SaveFragment.get(fm).setSaveEnabled(cwd != null && cwd.isCreateSupported());
  }
 else {
    createDir.setVisible(false);
    searchVisible=cwd != null && cwd.isSearchSupported();
  }
  search.setVisible(searchVisible);
  settings.setVisible(mAction != ACTION_MANAGE);
  return true;
}
