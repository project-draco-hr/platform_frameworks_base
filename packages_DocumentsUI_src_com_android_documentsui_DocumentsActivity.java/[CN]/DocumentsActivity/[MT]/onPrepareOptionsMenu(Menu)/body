{
  super.onPrepareOptionsMenu(menu);
  final DocumentInfo cwd=getCurrentDirectory();
  final MenuItem createDir=menu.findItem(R.id.menu_create_dir);
  final MenuItem grid=menu.findItem(R.id.menu_grid);
  final MenuItem list=menu.findItem(R.id.menu_list);
  final MenuItem fileSize=menu.findItem(R.id.menu_file_size);
  final MenuItem settings=menu.findItem(R.id.menu_settings);
  boolean recents=cwd == null;
  boolean picking=mState.action == ACTION_CREATE || mState.action == ACTION_OPEN_TREE || mState.action == ACTION_PICK_COPY_DESTINATION;
  createDir.setVisible(picking && !recents && cwd.isCreateSupported());
  mSearchManager.showMenu(!picking);
  grid.setVisible(!(picking && recents));
  list.setVisible(!(picking && recents));
  fileSize.setVisible(fileSize.isVisible() && !picking);
  settings.setVisible(false);
  if (mState.action == ACTION_CREATE) {
    final FragmentManager fm=getFragmentManager();
    SaveFragment.get(fm).prepareForDirectory(cwd);
  }
  Menus.disableHiddenItems(menu);
  return true;
}
