{
  super.onPrepareOptionsMenu(menu);
  final RootInfo root=getCurrentRoot();
  final DocumentInfo cwd=getCurrentDirectory();
  final MenuItem createDir=menu.findItem(R.id.menu_create_dir);
  final MenuItem grid=menu.findItem(R.id.menu_grid);
  final MenuItem list=menu.findItem(R.id.menu_list);
  final MenuItem advanced=menu.findItem(R.id.menu_advanced);
  final MenuItem fileSize=menu.findItem(R.id.menu_file_size);
  final MenuItem settings=menu.findItem(R.id.menu_settings);
  boolean fileSizeVisible=mState.action != ACTION_BROWSE;
  if (mState.action == ACTION_CREATE || mState.action == ACTION_OPEN_TREE || mState.action == ACTION_OPEN_COPY_DESTINATION) {
    createDir.setVisible(cwd != null && cwd.isCreateSupported());
    mSearchManager.showMenu(false);
    if (cwd == null) {
      grid.setVisible(false);
      list.setVisible(false);
      fileSizeVisible=false;
    }
    if (mState.action == ACTION_CREATE) {
      final FragmentManager fm=getFragmentManager();
      SaveFragment.get(fm).setSaveEnabled(cwd != null && cwd.isCreateSupported());
    }
  }
 else {
    createDir.setVisible(false);
  }
  advanced.setVisible(mState.action != ACTION_BROWSE && !mState.forceAdvanced);
  fileSize.setVisible(fileSizeVisible);
  settings.setVisible(mState.action == ACTION_BROWSE && (root.flags & Root.FLAG_HAS_SETTINGS) != 0);
  return true;
}
