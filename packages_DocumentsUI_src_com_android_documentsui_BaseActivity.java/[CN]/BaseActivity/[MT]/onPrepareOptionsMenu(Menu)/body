{
  super.onPrepareOptionsMenu(menu);
  final RootInfo root=getCurrentRoot();
  final boolean inRecents=getCurrentDirectory() == null;
  final MenuItem sort=menu.findItem(R.id.menu_sort);
  final MenuItem sortSize=menu.findItem(R.id.menu_sort_size);
  final MenuItem grid=menu.findItem(R.id.menu_grid);
  final MenuItem list=menu.findItem(R.id.menu_list);
  final MenuItem advanced=menu.findItem(R.id.menu_advanced);
  final MenuItem fileSize=menu.findItem(R.id.menu_file_size);
  final MenuItem settings=menu.findItem(R.id.menu_settings);
  final MenuItem search=menu.findItem(R.id.menu_search);
  sort.setVisible(!inRecents && !mSearchManager.isSearching());
  grid.setVisible(mState.derivedMode != State.MODE_GRID);
  list.setVisible(mState.derivedMode != State.MODE_LIST);
  sortSize.setVisible(mState.showSize);
  fileSize.setVisible(!mState.forceSize);
  advanced.setVisible(!mState.forceAdvanced);
  settings.setVisible((root.flags & Root.FLAG_HAS_SETTINGS) != 0);
  search.setVisible(canSearchRoot());
  advanced.setTitle(LocalPreferences.getDisplayAdvancedDevices(this) ? R.string.menu_advanced_hide : R.string.menu_advanced_show);
  fileSize.setTitle(LocalPreferences.getDisplayFileSize(this) ? R.string.menu_file_size_hide : R.string.menu_file_size_show);
  return true;
}
