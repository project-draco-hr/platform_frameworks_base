{
  mContext=context;
  mDisplay=display;
  display.getMetrics(mDisplayMetrics);
  Bitmap screenshot=Surface.screenshot(0,0);
  if (screenshot != null) {
    mSnapshotRotation=0;
    mWidth=screenshot.getWidth();
    mHeight=screenshot.getHeight();
  }
 else {
    mSnapshotRotation=display.getRotation();
    mWidth=mDisplayMetrics.widthPixels;
    mHeight=mDisplayMetrics.heightPixels;
  }
  mOriginalRotation=display.getRotation();
  mOriginalWidth=mDisplayMetrics.widthPixels;
  mOriginalHeight=mDisplayMetrics.heightPixels;
  if (!inTransaction) {
    if (WindowManagerService.SHOW_TRANSACTIONS)     Slog.i(WindowManagerService.TAG,">>> OPEN TRANSACTION ScreenRotationAnimation");
    Surface.openTransaction();
  }
  try {
    try {
      mSurface=new Surface(session,0,"FreezeSurface",-1,mWidth,mHeight,PixelFormat.OPAQUE,0);
      mSurface.setLayer(FREEZE_LAYER + 1);
    }
 catch (    Surface.OutOfResourcesException e) {
      Slog.w(TAG,"Unable to allocate freeze surface",e);
    }
    setRotation(display.getRotation());
    if (mSurface != null) {
      Rect dirty=new Rect(0,0,mWidth,mHeight);
      Canvas c=null;
      try {
        c=mSurface.lockCanvas(dirty);
      }
 catch (      IllegalArgumentException e) {
        Slog.w(TAG,"Unable to lock surface",e);
        return;
      }
catch (      Surface.OutOfResourcesException e) {
        Slog.w(TAG,"Unable to lock surface",e);
        return;
      }
      if (c == null) {
        Slog.w(TAG,"Null surface");
        return;
      }
      if (screenshot != null) {
        Paint paint=new Paint(0);
        paint.setXfermode(new PorterDuffXfermode(PorterDuff.Mode.SRC));
        c.drawBitmap(screenshot,0,0,paint);
      }
 else {
        c.drawColor(Color.BLACK,PorterDuff.Mode.SRC);
      }
      mSurface.unlockCanvasAndPost(c);
    }
  }
  finally {
    if (!inTransaction) {
      Surface.closeTransaction();
      if (WindowManagerService.SHOW_TRANSACTIONS)       Slog.i(WindowManagerService.TAG,"<<< CLOSE TRANSACTION ScreenRotationAnimation");
    }
    if (screenshot != null) {
      screenshot.recycle();
    }
  }
}
