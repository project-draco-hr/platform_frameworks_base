{
  if (mInputEventConsistencyVerifier != null) {
    mInputEventConsistencyVerifier.onTouchEvent(event,0);
  }
  mCurrTime=event.getEventTime();
  final int action=event.getActionMasked();
  final boolean streamComplete=action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_CANCEL;
  if (action == MotionEvent.ACTION_DOWN || streamComplete) {
    if (mInProgress) {
      mListener.onScaleEnd(this);
      mInProgress=false;
      mInitialSpan=0;
    }
    if (streamComplete) {
      clearTouchHistory();
      return true;
    }
  }
  final boolean configChanged=action == MotionEvent.ACTION_DOWN || action == MotionEvent.ACTION_POINTER_UP || action == MotionEvent.ACTION_POINTER_DOWN;
  final boolean pointerUp=action == MotionEvent.ACTION_POINTER_UP;
  final int skipIndex=pointerUp ? event.getActionIndex() : -1;
  float sumX=0, sumY=0;
  final int count=event.getPointerCount();
  for (int i=0; i < count; i++) {
    if (skipIndex == i)     continue;
    sumX+=event.getX(i);
    sumY+=event.getY(i);
  }
  final int div=pointerUp ? count - 1 : count;
  final float focusX=sumX / div;
  final float focusY=sumY / div;
  addTouchHistory(event);
  float devSumX=0, devSumY=0;
  for (int i=0; i < count; i++) {
    if (skipIndex == i)     continue;
    final float touchSize=mTouchHistoryLastAccepted / 2;
    devSumX+=Math.abs(event.getX(i) - focusX) + touchSize;
    devSumY+=Math.abs(event.getY(i) - focusY) + touchSize;
  }
  final float devX=devSumX / div;
  final float devY=devSumY / div;
  final float spanX=devX * 2;
  final float spanY=devY * 2;
  final float span=FloatMath.sqrt(spanX * spanX + spanY * spanY);
  final boolean wasInProgress=mInProgress;
  mFocusX=focusX;
  mFocusY=focusY;
  if (mInProgress && (span < mMinSpan || configChanged)) {
    mListener.onScaleEnd(this);
    mInProgress=false;
    mInitialSpan=span;
  }
  if (configChanged) {
    mPrevSpanX=mCurrSpanX=spanX;
    mPrevSpanY=mCurrSpanY=spanY;
    mInitialSpan=mPrevSpan=mCurrSpan=span;
  }
  if (!mInProgress && span >= mMinSpan && (wasInProgress || Math.abs(span - mInitialSpan) > mSpanSlop)) {
    mPrevSpanX=mCurrSpanX=spanX;
    mPrevSpanY=mCurrSpanY=spanY;
    mPrevSpan=mCurrSpan=span;
    mPrevTime=mCurrTime;
    mInProgress=mListener.onScaleBegin(this);
  }
  if (action == MotionEvent.ACTION_MOVE) {
    mCurrSpanX=spanX;
    mCurrSpanY=spanY;
    mCurrSpan=span;
    boolean updatePrev=true;
    if (mInProgress) {
      updatePrev=mListener.onScale(this);
    }
    if (updatePrev) {
      mPrevSpanX=mCurrSpanX;
      mPrevSpanY=mCurrSpanY;
      mPrevSpan=mCurrSpan;
      mPrevTime=mCurrTime;
    }
  }
  return true;
}
