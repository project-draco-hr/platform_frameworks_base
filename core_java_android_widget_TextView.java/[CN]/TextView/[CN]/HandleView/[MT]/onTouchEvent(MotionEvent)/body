{
switch (ev.getActionMasked()) {
case MotionEvent.ACTION_DOWN:
{
      startTouchUpFilter(mController.getCurrentOffset(this));
      mDownPositionX=ev.getRawX();
      mDownPositionY=ev.getRawY();
      mTouchToWindowOffsetX=mDownPositionX - mPositionX;
      mTouchToWindowOffsetY=mDownPositionY - mPositionY;
      final int[] coords=mTempCoords;
      TextView.this.getLocationInWindow(coords);
      mLastParentX=coords[0];
      mLastParentY=coords[1];
      mIsDragging=true;
      break;
    }
case MotionEvent.ACTION_MOVE:
{
    final float rawX=ev.getRawX();
    final float rawY=ev.getRawY();
    final float previousVerticalOffset=mTouchToWindowOffsetY - mLastParentY;
    final float currentVerticalOffset=rawY - mPositionY - mLastParentY;
    float newVerticalOffset;
    if (previousVerticalOffset < mIdealVerticalOffset) {
      newVerticalOffset=Math.min(currentVerticalOffset,mIdealVerticalOffset);
      newVerticalOffset=Math.max(newVerticalOffset,previousVerticalOffset);
    }
 else {
      newVerticalOffset=Math.max(currentVerticalOffset,mIdealVerticalOffset);
      newVerticalOffset=Math.min(newVerticalOffset,previousVerticalOffset);
    }
    mTouchToWindowOffsetY=newVerticalOffset + mLastParentY;
    final float newPosX=rawX - mTouchToWindowOffsetX + mHotspotX;
    final float newPosY=rawY - mTouchToWindowOffsetY + mTouchOffsetY;
    mController.updatePosition(this,Math.round(newPosX),Math.round(newPosY));
    break;
  }
case MotionEvent.ACTION_UP:
if (mIsInsertionHandle) {
  final float deltaX=mDownPositionX - ev.getRawX();
  final float deltaY=mDownPositionY - ev.getRawY();
  final float distanceSquared=deltaX * deltaX + deltaY * deltaY;
  if (distanceSquared < mSquaredTouchSlopDistance) {
    if (mPastePopupWindow != null && mPastePopupWindow.isShowing()) {
      mPastePopupWindow.hide();
    }
 else {
      ((InsertionPointCursorController)mController).show(0);
    }
  }
}
filterOnTouchUp();
mIsDragging=false;
break;
case MotionEvent.ACTION_CANCEL:
mIsDragging=false;
break;
}
return true;
}
