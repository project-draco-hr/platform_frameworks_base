{
  final int selectionStart=getSelectionStart();
  final int selectionEnd=getSelectionEnd();
  final InputMethodState ims=mInputMethodState;
  if (ims != null && ims.mBatchEditNesting == 0) {
    InputMethodManager imm=InputMethodManager.peekInstance();
    if (imm != null) {
      if (imm.isActive(TextView.this)) {
        boolean reported=false;
        if (ims.mContentChanged || ims.mSelectionModeChanged) {
          reported=reportExtractedText();
        }
        if (!reported && highlight != null) {
          int candStart=-1;
          int candEnd=-1;
          if (mText instanceof Spannable) {
            Spannable sp=(Spannable)mText;
            candStart=EditableInputConnection.getComposingSpanStart(sp);
            candEnd=EditableInputConnection.getComposingSpanEnd(sp);
          }
          imm.updateSelection(TextView.this,selectionStart,selectionEnd,candStart,candEnd);
        }
      }
      if (imm.isWatchingCursor(TextView.this) && highlight != null) {
        highlight.computeBounds(ims.mTmpRectF,true);
        ims.mTmpOffset[0]=ims.mTmpOffset[1]=0;
        canvas.getMatrix().mapPoints(ims.mTmpOffset);
        ims.mTmpRectF.offset(ims.mTmpOffset[0],ims.mTmpOffset[1]);
        ims.mTmpRectF.offset(0,cursorOffsetVertical);
        ims.mCursorRectInWindow.set((int)(ims.mTmpRectF.left + 0.5),(int)(ims.mTmpRectF.top + 0.5),(int)(ims.mTmpRectF.right + 0.5),(int)(ims.mTmpRectF.bottom + 0.5));
        imm.updateCursor(TextView.this,ims.mCursorRectInWindow.left,ims.mCursorRectInWindow.top,ims.mCursorRectInWindow.right,ims.mCursorRectInWindow.bottom);
      }
    }
  }
  if (mCorrectionHighlighter != null) {
    mCorrectionHighlighter.draw(canvas,cursorOffsetVertical);
  }
  if (highlight != null && selectionStart == selectionEnd && mCursorCount > 0) {
    drawCursor(canvas,cursorOffsetVertical);
    highlight=null;
  }
  if (false && canHaveDisplayList() && canvas.isHardwareAccelerated()) {
    drawHardwareAccelerated(canvas,layout,highlight,cursorOffsetVertical);
  }
 else {
    layout.draw(canvas,highlight,mHighlightPaint,cursorOffsetVertical);
  }
  if (mMarquee != null && mMarquee.shouldDrawGhost()) {
    canvas.translate((int)mMarquee.getGhostOffset(),0.0f);
    layout.draw(canvas,highlight,mHighlightPaint,cursorOffsetVertical);
  }
}
