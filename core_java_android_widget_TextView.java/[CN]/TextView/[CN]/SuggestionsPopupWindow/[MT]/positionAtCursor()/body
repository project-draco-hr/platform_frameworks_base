{
  View contentView=mContainer.getContentView();
  int width=contentView.getMeasuredWidth();
  int height=contentView.getMeasuredHeight();
  final int offset=TextView.this.getSelectionStart();
  final int line=mLayout.getLineForOffset(offset);
  final int lineBottom=mLayout.getLineBottom(line);
  float primaryHorizontal=mLayout.getPrimaryHorizontal(offset);
  final Rect bounds=sCursorControllerTempRect;
  bounds.left=(int)(primaryHorizontal - width / 2.0f);
  bounds.top=lineBottom;
  bounds.right=bounds.left + width;
  bounds.bottom=bounds.top + height;
  convertFromViewportToContentCoordinates(bounds);
  final int[] coords=mTempCoords;
  TextView.this.getLocationInWindow(coords);
  coords[0]+=bounds.left;
  coords[1]+=bounds.top;
  final DisplayMetrics displayMetrics=mContext.getResources().getDisplayMetrics();
  final int screenHeight=displayMetrics.heightPixels;
  if (coords[1] + height > screenHeight) {
    contentView=mContainer.getContentView();
    width=contentView.getMeasuredWidth();
    height=contentView.getMeasuredHeight();
    final int lineTop=mLayout.getLineTop(line);
    final int lineHeight=lineBottom - lineTop;
    coords[1]-=height + lineHeight;
  }
  coords[0]=Math.max(0,coords[0]);
  coords[0]=Math.min(displayMetrics.widthPixels - width,coords[0]);
  mContainer.showAtLocation(TextView.this,Gravity.NO_GRAVITY,coords[0],coords[1]);
}
