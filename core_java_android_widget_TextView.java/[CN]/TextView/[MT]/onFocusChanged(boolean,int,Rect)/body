{
  if (mTemporaryDetach) {
    super.onFocusChanged(focused,direction,previouslyFocusedRect);
    return;
  }
  mShowCursor=SystemClock.uptimeMillis();
  ensureEndedBatchEdit();
  if (focused) {
    int selStart=getSelectionStart();
    int selEnd=getSelectionEnd();
    if (!mFrozenWithFocus || (selStart < 0 || selEnd < 0)) {
      boolean selMoved=mSelectionMoved;
      if (mSelectionModifierCursorController != null) {
        final int touchOffset=((SelectionModifierCursorController)mSelectionModifierCursorController).getMinTouchOffset();
        Selection.setSelection((Spannable)mText,touchOffset);
      }
      if (mMovement != null) {
        mMovement.onTakeFocus(this,(Spannable)mText,direction);
      }
      if (mSelectAllOnFocus) {
        Selection.setSelection((Spannable)mText,0,mText.length());
      }
      if (selMoved && selStart >= 0 && selEnd >= 0) {
        Selection.setSelection((Spannable)mText,selStart,selEnd);
      }
      mTouchFocusSelected=true;
    }
    mFrozenWithFocus=false;
    mSelectionMoved=false;
    if (mText instanceof Spannable) {
      Spannable sp=(Spannable)mText;
      MetaKeyKeyListener.resetMetaState(sp);
    }
    makeBlink();
    if (mError != null) {
      showError();
    }
    if (selStart != selEnd) {
      mShouldStartTextSelectionMode=true;
    }
  }
 else {
    if (mError != null) {
      hideError();
    }
    onEndBatchEdit();
    hideInsertionPointCursorController();
    terminateTextSelectionMode();
  }
  startStopMarquee(focused);
  if (mTransformation != null) {
    mTransformation.onFocusChanged(this,mText,focused,direction,previouslyFocusedRect);
  }
  super.onFocusChanged(focused,direction,previouslyFocusedRect);
}
