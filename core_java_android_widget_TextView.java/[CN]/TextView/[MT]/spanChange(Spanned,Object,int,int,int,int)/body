{
  boolean selChanged=false;
  int newSelStart=-1, newSelEnd=-1;
  final Editor.InputMethodState ims=mEditor == null ? null : mEditor.mInputMethodState;
  if (what == Selection.SELECTION_END) {
    selChanged=true;
    newSelEnd=newStart;
    if (oldStart >= 0 || newStart >= 0) {
      invalidateCursor(Selection.getSelectionStart(buf),oldStart,newStart);
      checkForResize();
      registerForPreDraw();
      if (mEditor != null)       mEditor.makeBlink();
    }
  }
  if (what == Selection.SELECTION_START) {
    selChanged=true;
    newSelStart=newStart;
    if (oldStart >= 0 || newStart >= 0) {
      int end=Selection.getSelectionEnd(buf);
      invalidateCursor(end,oldStart,newStart);
    }
  }
  if (selChanged) {
    mHighlightPathBogus=true;
    if (mEditor != null && !isFocused())     mEditor.mSelectionMoved=true;
    if ((buf.getSpanFlags(what) & Spanned.SPAN_INTERMEDIATE) == 0) {
      if (newSelStart < 0) {
        newSelStart=Selection.getSelectionStart(buf);
      }
      if (newSelEnd < 0) {
        newSelEnd=Selection.getSelectionEnd(buf);
      }
      if (mEditor != null) {
        mEditor.refreshTextActionMode();
        if (!hasSelection() && mEditor.mTextActionMode == null && hasTransientState()) {
          setHasTransientState(false);
        }
      }
      onSelectionChanged(newSelStart,newSelEnd);
    }
  }
  if (what instanceof UpdateAppearance || what instanceof ParagraphStyle || what instanceof CharacterStyle) {
    if (ims == null || ims.mBatchEditNesting == 0) {
      invalidate();
      mHighlightPathBogus=true;
      checkForResize();
    }
 else {
      ims.mContentChanged=true;
    }
    if (mEditor != null) {
      if (oldStart >= 0)       mEditor.invalidateTextDisplayList(mLayout,oldStart,oldEnd);
      if (newStart >= 0)       mEditor.invalidateTextDisplayList(mLayout,newStart,newEnd);
      mEditor.invalidateHandlesAndActionMode();
    }
  }
  if (MetaKeyKeyListener.isMetaTracker(buf,what)) {
    mHighlightPathBogus=true;
    if (ims != null && MetaKeyKeyListener.isSelectingMetaTracker(buf,what)) {
      ims.mSelectionModeChanged=true;
    }
    if (Selection.getSelectionStart(buf) >= 0) {
      if (ims == null || ims.mBatchEditNesting == 0) {
        invalidateCursor();
      }
 else {
        ims.mCursorChanged=true;
      }
    }
  }
  if (what instanceof ParcelableSpan) {
    if (ims != null && ims.mExtractedTextRequest != null) {
      if (ims.mBatchEditNesting != 0) {
        if (oldStart >= 0) {
          if (ims.mChangedStart > oldStart) {
            ims.mChangedStart=oldStart;
          }
          if (ims.mChangedStart > oldEnd) {
            ims.mChangedStart=oldEnd;
          }
        }
        if (newStart >= 0) {
          if (ims.mChangedStart > newStart) {
            ims.mChangedStart=newStart;
          }
          if (ims.mChangedStart > newEnd) {
            ims.mChangedStart=newEnd;
          }
        }
      }
 else {
        if (DEBUG_EXTRACT)         Log.v(LOG_TAG,"Span change outside of batch: " + oldStart + "-"+ oldEnd+ ","+ newStart+ "-"+ newEnd+ " "+ what);
        ims.mContentChanged=true;
      }
    }
  }
  if (mEditor != null && mEditor.mSpellChecker != null && newStart < 0 && what instanceof SpellCheckSpan) {
    mEditor.mSpellChecker.onSpellCheckSpanRemoved((SpellCheckSpan)what);
  }
}
