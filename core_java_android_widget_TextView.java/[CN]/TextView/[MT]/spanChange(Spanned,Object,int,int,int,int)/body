{
  boolean selChanged=false;
  int newSelStart=-1, newSelEnd=-1;
  final InputMethodState ims=mInputMethodState;
  if (what == Selection.SELECTION_END) {
    mHighlightPathBogus=true;
    selChanged=true;
    newSelEnd=newStart;
    if (!isFocused()) {
      mSelectionMoved=true;
    }
    if (oldStart >= 0 || newStart >= 0) {
      invalidateCursor(Selection.getSelectionStart(buf),oldStart,newStart);
      registerForPreDraw();
      if (isFocused()) {
        mShowCursor=SystemClock.uptimeMillis();
        makeBlink();
      }
    }
  }
  if (what == Selection.SELECTION_START) {
    mHighlightPathBogus=true;
    selChanged=true;
    newSelStart=newStart;
    if (!isFocused()) {
      mSelectionMoved=true;
    }
    if (oldStart >= 0 || newStart >= 0) {
      int end=Selection.getSelectionEnd(buf);
      invalidateCursor(end,oldStart,newStart);
    }
  }
  if (selChanged) {
    if ((buf.getSpanFlags(what) & Spanned.SPAN_INTERMEDIATE) == 0) {
      if (newSelStart < 0) {
        newSelStart=Selection.getSelectionStart(buf);
      }
      if (newSelEnd < 0) {
        newSelEnd=Selection.getSelectionEnd(buf);
      }
      onSelectionChanged(newSelStart,newSelEnd);
    }
  }
  if (what instanceof UpdateAppearance || what instanceof ParagraphStyle) {
    if (ims == null || ims.mBatchEditNesting == 0) {
      invalidate();
      mHighlightPathBogus=true;
      checkForResize();
    }
 else {
      ims.mContentChanged=true;
    }
  }
  if (MetaKeyKeyListener.isMetaTracker(buf,what)) {
    mHighlightPathBogus=true;
    if (ims != null && MetaKeyKeyListener.isSelectingMetaTracker(buf,what)) {
      ims.mSelectionModeChanged=true;
    }
    if (Selection.getSelectionStart(buf) >= 0) {
      if (ims == null || ims.mBatchEditNesting == 0) {
        invalidateCursor();
      }
 else {
        ims.mCursorChanged=true;
      }
    }
  }
  if (what instanceof ParcelableSpan) {
    if (ims != null && ims.mExtracting != null) {
      if (ims.mBatchEditNesting != 0) {
        if (oldStart >= 0) {
          if (ims.mChangedStart > oldStart) {
            ims.mChangedStart=oldStart;
          }
          if (ims.mChangedStart > oldEnd) {
            ims.mChangedStart=oldEnd;
          }
        }
        if (newStart >= 0) {
          if (ims.mChangedStart > newStart) {
            ims.mChangedStart=newStart;
          }
          if (ims.mChangedStart > newEnd) {
            ims.mChangedStart=newEnd;
          }
        }
      }
 else {
        if (DEBUG_EXTRACT)         Log.v(TAG,"Span change outside of batch: " + oldStart + "-"+ oldEnd+ ","+ newStart+ "-"+ newEnd+ what);
        ims.mContentChanged=true;
      }
    }
  }
}
