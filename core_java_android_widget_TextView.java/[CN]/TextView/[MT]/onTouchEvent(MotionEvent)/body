{
  final int action=event.getActionMasked();
  if (hasInsertionController()) {
    getInsertionController().onTouchEvent(event);
  }
  if (hasSelectionController()) {
    getSelectionController().onTouchEvent(event);
  }
  if (action == MotionEvent.ACTION_DOWN) {
    mLastDownPositionX=(int)event.getX();
    mLastDownPositionY=(int)event.getY();
    mTouchFocusSelected=false;
    mIgnoreActionUpEvent=false;
  }
  final boolean superResult=super.onTouchEvent(event);
  if (mDiscardNextActionUp && action == MotionEvent.ACTION_UP) {
    mDiscardNextActionUp=false;
    return superResult;
  }
  final boolean touchIsFinished=action == MotionEvent.ACTION_UP && !mIgnoreActionUpEvent && isFocused();
  if ((mMovement != null || onCheckIsTextEditor()) && isEnabled() && mText instanceof Spannable&& mLayout != null) {
    boolean handled=false;
    int oldSelStart=getSelectionStart();
    int oldSelEnd=getSelectionEnd();
    final int oldScrollX=mScrollX;
    final int oldScrollY=mScrollY;
    if (mMovement != null) {
      handled|=mMovement.onTouchEvent(this,(Spannable)mText,event);
    }
    if (mLinksClickable && mAutoLinkMask != 0 && mTextIsSelectable && touchIsFinished) {
      ClickableSpan[] links=((Spannable)mText).getSpans(getSelectionStart(),getSelectionEnd(),ClickableSpan.class);
      if (links.length != 0) {
        links[0].onClick(this);
        handled=true;
      }
    }
    if (isTextEditable() || mTextIsSelectable) {
      if (mScrollX != oldScrollX || mScrollY != oldScrollY) {
        hideInsertionPointCursorController();
        if (mSelectionModifierCursorController != null && mSelectionModifierCursorController.isShowing()) {
          mSelectionModifierCursorController.updatePosition();
        }
      }
      if (touchIsFinished) {
        CommitSelectionReceiver csr=null;
        if (getSelectionStart() != oldSelStart || getSelectionEnd() != oldSelEnd || didTouchFocusSelect()) {
          csr=new CommitSelectionReceiver(oldSelStart,oldSelEnd);
        }
        if (!mTextIsSelectable) {
          final InputMethodManager imm=InputMethodManager.peekInstance();
          handled|=imm != null && imm.showSoftInput(this,0,csr) && (csr != null);
        }
        stopSelectionActionMode();
        boolean selectAllGotFocus=mSelectAllOnFocus && mTouchFocusSelected;
        if (hasInsertionController() && !selectAllGotFocus) {
          getInsertionController().show();
        }
      }
    }
    if (handled) {
      return true;
    }
  }
  return superResult;
}
