{
  if (attrs.containsKey(TextAttribute.INPUT_METHOD_HIGHLIGHT)) {
    Map<TextAttribute,?> styles=null;
    Object val=attrs.get(TextAttribute.INPUT_METHOD_HIGHLIGHT);
    if (val instanceof Annotation) {
      val=((Annotation)val).getValue();
    }
    if (val instanceof InputMethodHighlight) {
      InputMethodHighlight ihl=((InputMethodHighlight)val);
      styles=ihl.getStyle();
      if (styles == null) {
        Toolkit tk=Toolkit.getDefaultToolkit();
        styles=tk.mapInputMethodHighlight(ihl);
      }
    }
    if (styles != null) {
      HashMap<Attribute,Object> newAttrs=new HashMap<Attribute,Object>();
      newAttrs.putAll(attrs);
      newAttrs.putAll(styles);
      return newAttrs;
    }
  }
  return attrs;
}
