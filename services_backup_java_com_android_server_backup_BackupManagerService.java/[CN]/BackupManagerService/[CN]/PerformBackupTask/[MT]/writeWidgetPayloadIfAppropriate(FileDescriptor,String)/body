{
  byte[] widgetState=AppWidgetBackupBridge.getWidgetState(pkgName,UserHandle.USER_SYSTEM);
  final File widgetFile=new File(mStateDir,pkgName + "_widget");
  final boolean priorStateExists=widgetFile.exists();
  if (MORE_DEBUG) {
    if (priorStateExists || widgetState != null) {
      Slog.i(TAG,"Checking widget update: state=" + (widgetState != null) + " prior="+ priorStateExists);
    }
  }
  if (!priorStateExists && widgetState == null) {
    return;
  }
  String newChecksum=null;
  if (widgetState != null) {
    newChecksum=SHA1Checksum(widgetState);
    if (priorStateExists) {
      final String priorChecksum;
      try (FileInputStream fin=new FileInputStream(widgetFile);DataInputStream in=new DataInputStream(fin)){
        priorChecksum=in.readUTF();
      }
       if (Objects.equals(newChecksum,priorChecksum)) {
        return;
      }
    }
  }
  BackupDataOutput out=new BackupDataOutput(fd);
  if (widgetState != null) {
    try (FileOutputStream fout=new FileOutputStream(widgetFile);DataOutputStream stateOut=new DataOutputStream(fout)){
      stateOut.writeUTF(newChecksum);
    }
     out.writeEntityHeader(KEY_WIDGET_STATE,widgetState.length);
    out.writeEntityData(widgetState,widgetState.length);
  }
 else {
    out.writeEntityHeader(KEY_WIDGET_STATE,-1);
    widgetFile.delete();
  }
}
