{
  int userVersion=mUserVersion;
  if (userVersion < 1) {
    UserInfo user=mUsers.get(UserHandle.USER_OWNER);
    if ("Primary".equals(user.name)) {
      user.name=mContext.getResources().getString(com.android.internal.R.string.owner_name);
      scheduleWriteUserLocked(user);
    }
    userVersion=1;
  }
  if (userVersion < 2) {
    UserInfo user=mUsers.get(UserHandle.USER_OWNER);
    if ((user.flags & UserInfo.FLAG_INITIALIZED) == 0) {
      user.flags|=UserInfo.FLAG_INITIALIZED;
      scheduleWriteUserLocked(user);
    }
    userVersion=2;
  }
  if (userVersion < 4) {
    userVersion=4;
  }
  if (userVersion < 5) {
    initDefaultGuestRestrictions();
    userVersion=5;
  }
  if (userVersion < 6) {
    final boolean splitSystemUser=UserManager.isSplitSystemUser();
    for (int i=0; i < mUsers.size(); i++) {
      UserInfo user=mUsers.valueAt(i);
      if (!splitSystemUser && user.isRestricted() && (user.restrictedProfileParentId == UserInfo.NO_PROFILE_GROUP_ID)) {
        user.restrictedProfileParentId=UserHandle.USER_SYSTEM;
        scheduleWriteUserLocked(user);
      }
    }
    userVersion=6;
  }
  if (userVersion < USER_VERSION) {
    Slog.w(LOG_TAG,"User version " + mUserVersion + " didn't upgrade as expected to "+ USER_VERSION);
  }
 else {
    mUserVersion=userVersion;
    writeUserListLocked();
  }
}
