{
  final long ident=Binder.clearCallingIdentity();
  UserInfo userInfo=null;
  try {
synchronized (mInstallLock) {
synchronized (mPackagesLock) {
        UserInfo profile=null;
        if (profileId != UserHandle.USER_NULL) {
          profile=getUserInfoLocked(profileId);
          if (profile == null)           return null;
        }
        if (isUserLimitReachedLocked())         return null;
        int userId=getNextAvailableIdLocked();
        userInfo=new UserInfo(userId,name,null,flags);
        File userPath=new File(mBaseUserPath,Integer.toString(userId));
        userInfo.serialNumber=mNextSerialNumber++;
        long now=System.currentTimeMillis();
        userInfo.creationTime=(now > EPOCH_PLUS_30_YEARS) ? now : 0;
        userInfo.partial=true;
        Environment.getUserSystemDirectory(userInfo.id).mkdirs();
        mUsers.put(userId,userInfo);
        writeUserListLocked();
        if (profile != null) {
          if (profile.profileGroupId == UserInfo.NO_PROFILE_GROUP_ID) {
            profile.profileGroupId=getNextProfileGroupIdLocked();
            writeUserLocked(profile);
          }
          userInfo.profileGroupId=profile.profileGroupId;
        }
        writeUserLocked(userInfo);
        mPm.createNewUserLILPw(userId,userPath);
        userInfo.partial=false;
        writeUserLocked(userInfo);
        updateUserIdsLocked();
        Bundle restrictions=new Bundle();
        mUserRestrictions.append(userId,restrictions);
      }
    }
    if (userInfo != null) {
      Intent addedIntent=new Intent(Intent.ACTION_USER_ADDED);
      addedIntent.putExtra(Intent.EXTRA_USER_HANDLE,userInfo.id);
      mContext.sendBroadcastAsUser(addedIntent,UserHandle.ALL,android.Manifest.permission.MANAGE_USERS);
    }
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
  return userInfo;
}
