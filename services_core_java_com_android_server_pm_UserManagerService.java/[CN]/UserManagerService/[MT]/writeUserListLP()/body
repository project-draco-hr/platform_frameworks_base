{
  if (DBG) {
    debug("writeUserList");
  }
  FileOutputStream fos=null;
  AtomicFile userListFile=new AtomicFile(mUserListFile);
  try {
    fos=userListFile.startWrite();
    final BufferedOutputStream bos=new BufferedOutputStream(fos);
    final XmlSerializer serializer=new FastXmlSerializer();
    serializer.setOutput(bos,StandardCharsets.UTF_8.name());
    serializer.startDocument(null,true);
    serializer.setFeature("http://xmlpull.org/v1/doc/features.html#indent-output",true);
    serializer.startTag(null,TAG_USERS);
    serializer.attribute(null,ATTR_NEXT_SERIAL_NO,Integer.toString(mNextSerialNumber));
    serializer.attribute(null,ATTR_USER_VERSION,Integer.toString(mUserVersion));
    serializer.startTag(null,TAG_GUEST_RESTRICTIONS);
synchronized (mGuestRestrictions) {
      UserRestrictionsUtils.writeRestrictions(serializer,mGuestRestrictions,TAG_RESTRICTIONS);
    }
    serializer.endTag(null,TAG_GUEST_RESTRICTIONS);
synchronized (mRestrictionsLock) {
      UserRestrictionsUtils.writeRestrictions(serializer,mDevicePolicyGlobalUserRestrictions,TAG_DEVICE_POLICY_RESTRICTIONS);
    }
    serializer.startTag(null,TAG_GLOBAL_RESTRICTION_OWNER_ID);
    serializer.attribute(null,ATTR_ID,Integer.toString(mGlobalRestrictionOwnerUserId));
    serializer.endTag(null,TAG_GLOBAL_RESTRICTION_OWNER_ID);
    int[] userIdsToWrite;
synchronized (mUsersLock) {
      userIdsToWrite=new int[mUsers.size()];
      for (int i=0; i < userIdsToWrite.length; i++) {
        UserInfo user=mUsers.valueAt(i).info;
        userIdsToWrite[i]=user.id;
      }
    }
    for (    int id : userIdsToWrite) {
      serializer.startTag(null,TAG_USER);
      serializer.attribute(null,ATTR_ID,Integer.toString(id));
      serializer.endTag(null,TAG_USER);
    }
    serializer.endTag(null,TAG_USERS);
    serializer.endDocument();
    userListFile.finishWrite(fos);
  }
 catch (  Exception e) {
    userListFile.failWrite(fos);
    Slog.e(LOG_TAG,"Error writing user list");
  }
}
