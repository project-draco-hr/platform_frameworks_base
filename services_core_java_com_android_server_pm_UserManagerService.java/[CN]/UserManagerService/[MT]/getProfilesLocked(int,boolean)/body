{
  DevicePolicyManager dpm=null;
  if (enabledOnly) {
    dpm=(DevicePolicyManager)mContext.getSystemService(Context.DEVICE_POLICY_SERVICE);
  }
  UserInfo user=getUserInfoLocked(userId);
  ArrayList<UserInfo> users=new ArrayList<UserInfo>(mUsers.size());
  for (int i=0; i < mUsers.size(); i++) {
    UserInfo profile=mUsers.valueAt(i);
    if (!isProfileOf(user,profile)) {
      continue;
    }
    if (enabledOnly && profile.isManagedProfile()) {
      if (dpm != null) {
        if (!dpm.isProfileEnabled(profile.id)) {
          continue;
        }
      }
 else {
        Log.w(LOG_TAG,"Attempting to reach DevicePolicyManager before it is started");
        throw new IllegalArgumentException(String.format("Attempting to get enabled profiles for %d before " + "DevicePolicyManagerService has been started.",userId));
      }
    }
    users.add(profile);
  }
  return users;
}
