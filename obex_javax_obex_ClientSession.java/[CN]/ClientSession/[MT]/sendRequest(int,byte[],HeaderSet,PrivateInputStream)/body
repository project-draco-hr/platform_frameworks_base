{
  if (head != null) {
    if ((head.length + 3) > ObexHelper.MAX_PACKET_SIZE_INT) {
      throw new IOException("header too large ");
    }
  }
  int bytesReceived;
  ByteArrayOutputStream out=new ByteArrayOutputStream();
  out.write((byte)code);
  if (head == null) {
    out.write(0x00);
    out.write(0x03);
  }
 else {
    out.write((byte)((head.length + 3) >> 8));
    out.write((byte)(head.length + 3));
    out.write(head);
  }
  mOutput.write(out.toByteArray());
  mOutput.flush();
  header.responseCode=mInput.read();
  int length=((mInput.read() << 8) | (mInput.read()));
  if (length > ObexHelper.MAX_PACKET_SIZE_INT) {
    throw new IOException("Packet received exceeds packet size limit");
  }
  if (length > 3) {
    byte[] data=null;
    if (code == 0x80) {
      int version=mInput.read();
      int flags=mInput.read();
      maxPacketSize=(mInput.read() << 8) + mInput.read();
      if (maxPacketSize > ObexHelper.MAX_PACKET_SIZE_INT) {
        maxPacketSize=ObexHelper.MAX_PACKET_SIZE_INT;
      }
      if (length > 7) {
        data=new byte[length - 7];
        bytesReceived=mInput.read(data);
        while (bytesReceived != (length - 7)) {
          bytesReceived+=mInput.read(data,bytesReceived,data.length - bytesReceived);
        }
      }
 else {
        return true;
      }
    }
 else {
      data=new byte[length - 3];
      bytesReceived=mInput.read(data);
      while (bytesReceived != (length - 3)) {
        bytesReceived+=mInput.read(data,bytesReceived,data.length - bytesReceived);
      }
      if (code == 0xFF) {
        return true;
      }
    }
    byte[] body=ObexHelper.updateHeaderSet(header,data);
    if ((privateInput != null) && (body != null)) {
      privateInput.writeBytes(body,1);
    }
    if (header.connectionID != null) {
      mConnectionId=new byte[4];
      System.arraycopy(header.connectionID,0,mConnectionId,0,4);
    }
    if (header.authResp != null) {
      if (!handleAuthResp(header.authResp)) {
        setRequestInactive();
        throw new IOException("Authentication Failed");
      }
    }
    if ((header.responseCode == ResponseCodes.OBEX_HTTP_UNAUTHORIZED) && (header.authChall != null)) {
      if (handleAuthChall(header)) {
        out.write((byte)0x4E);
        out.write((byte)((header.authResp.length + 3) >> 8));
        out.write((byte)(header.authResp.length + 3));
        out.write(header.authResp);
        header.authChall=null;
        header.authResp=null;
        byte[] sendHeaders=new byte[out.size() - 3];
        System.arraycopy(out.toByteArray(),3,sendHeaders,0,sendHeaders.length);
        return sendRequest(code,sendHeaders,header,privateInput);
      }
    }
  }
  return true;
}
