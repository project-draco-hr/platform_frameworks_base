{
  mContext=context;
  mInterfaceName=SystemProperties.get("wifi.interface","wlan0");
  mWifiStateMachine=new WifiStateMachine(mContext,mInterfaceName);
  mWifiStateMachine.enableRssiPolling(true);
  mBatteryStats=BatteryStatsService.getService();
  mAlarmManager=(AlarmManager)mContext.getSystemService(Context.ALARM_SERVICE);
  Intent idleIntent=new Intent(ACTION_DEVICE_IDLE,null);
  mIdleIntent=PendingIntent.getBroadcast(mContext,IDLE_REQUEST,idleIntent,0);
  mContext.registerReceiver(new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      mAirplaneModeOn.set(isAirplaneModeOn());
      handleAirplaneModeToggled(mAirplaneModeOn.get());
      updateWifiState();
    }
  }
,new IntentFilter(Intent.ACTION_AIRPLANE_MODE_CHANGED));
  IntentFilter filter=new IntentFilter();
  filter.addAction(WifiManager.WIFI_STATE_CHANGED_ACTION);
  filter.addAction(WifiManager.NETWORK_STATE_CHANGED_ACTION);
  filter.addAction(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION);
  mContext.registerReceiver(new BroadcastReceiver(){
    @Override public void onReceive(    Context context,    Intent intent){
      if (intent.getAction().equals(WifiManager.WIFI_STATE_CHANGED_ACTION)) {
        int wifiState=intent.getIntExtra(WifiManager.EXTRA_WIFI_STATE,WifiManager.WIFI_STATE_DISABLED);
        mWifiEnabled=(wifiState == WifiManager.WIFI_STATE_ENABLED);
        resetNotification();
      }
 else       if (intent.getAction().equals(WifiManager.NETWORK_STATE_CHANGED_ACTION)) {
        mNetworkInfo=(NetworkInfo)intent.getParcelableExtra(WifiManager.EXTRA_NETWORK_INFO);
switch (mNetworkInfo.getDetailedState()) {
case CONNECTED:
case DISCONNECTED:
case CAPTIVE_PORTAL_CHECK:
          evaluateTrafficStatsPolling();
        resetNotification();
      break;
  }
}
 else if (intent.getAction().equals(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION)) {
  noteScanEnd();
  checkAndSetNotification();
}
}
}
,filter);
HandlerThread wifiThread=new HandlerThread("WifiService");
wifiThread.start();
mAsyncServiceHandler=new AsyncServiceHandler(wifiThread.getLooper());
mWifiStateMachineHandler=new WifiStateMachineHandler(wifiThread.getLooper());
NOTIFICATION_REPEAT_DELAY_MS=Settings.Global.getInt(context.getContentResolver(),Settings.Global.WIFI_NETWORKS_AVAILABLE_REPEAT_DELAY,900) * 1000l;
mNotificationEnabledSettingObserver=new NotificationEnabledSettingObserver(new Handler());
mNotificationEnabledSettingObserver.register();
}
