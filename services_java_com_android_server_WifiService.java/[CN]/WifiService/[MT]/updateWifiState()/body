{
  boolean wifiEnabled=getPersistedWifiEnabled();
  boolean airplaneMode=isAirplaneModeOn();
  boolean lockHeld=mLocks.hasLocks();
  boolean wifiShouldBeEnabled=wifiEnabled && !airplaneMode;
  boolean wifiShouldBeStarted=!mDeviceIdle || lockHeld;
synchronized (mWifiHandler) {
    if (wifiShouldBeEnabled) {
      if (wifiShouldBeStarted) {
        mWakeLock.acquire();
        sendEnableMessage(true,false);
        mWakeLock.acquire();
        mWifiHandler.sendEmptyMessage(MESSAGE_START_WIFI);
      }
 else {
        int wakeLockTimeout=Settings.Secure.getInt(mContext.getContentResolver(),Settings.Secure.WIFI_MOBILE_DATA_TRANSITION_WAKELOCK_TIMEOUT_MS,DEFAULT_WAKELOCK_TIMEOUT);
        mDriverStopWakeLock.acquire();
        mWifiHandler.sendEmptyMessage(MESSAGE_STOP_WIFI);
        mWifiHandler.sendEmptyMessageDelayed(MESSAGE_RELEASE_WAKELOCK,wakeLockTimeout);
      }
    }
 else {
      mWakeLock.acquire();
      sendEnableMessage(false,false);
    }
  }
}
