{
  boolean wifiEnabled=getPersistedWifiEnabled();
  boolean airplaneMode=isAirplaneModeOn();
  boolean lockHeld=mLocks.hasLocks();
  boolean wifiShouldBeEnabled=wifiEnabled && !airplaneMode;
  boolean wifiShouldBeStarted=!mDeviceIdle || lockHeld;
synchronized (mWifiHandler) {
    if (wifiShouldBeEnabled) {
      if (wifiShouldBeStarted) {
        mWakeLock.acquire();
        mWifiHandler.obtainMessage(MESSAGE_ENABLE_WIFI).sendToTarget();
        mWakeLock.acquire();
        mWifiHandler.obtainMessage(MESSAGE_START_WIFI).sendToTarget();
      }
 else {
        mDriverStopWakeLock.acquire();
        mWifiHandler.obtainMessage(MESSAGE_STOP_WIFI).sendToTarget();
        mWifiHandler.sendEmptyMessageDelayed(MESSAGE_RELEASE_WAKELOCK,mWakelockTimeout);
      }
    }
 else {
      mWakeLock.acquire();
      mWifiHandler.obtainMessage(MESSAGE_DISABLE_WIFI).sendToTarget();
    }
  }
}
