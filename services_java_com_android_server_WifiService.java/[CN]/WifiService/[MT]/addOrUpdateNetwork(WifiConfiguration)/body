{
  enforceChangePermission();
  int netId=config.networkId;
  boolean newNetwork=netId == -1;
  boolean doReconfig;
  int currentPriority;
synchronized (mWifiStateTracker) {
    if (newNetwork) {
      netId=mWifiStateTracker.addNetwork();
      if (netId < 0) {
        if (DBG) {
          Slog.d(TAG,"Failed to add a network!");
        }
        return -1;
      }
      doReconfig=true;
    }
 else {
      String priorityVal=mWifiStateTracker.getNetworkVariable(netId,WifiConfiguration.priorityVarName);
      currentPriority=-1;
      if (!TextUtils.isEmpty(priorityVal)) {
        try {
          currentPriority=Integer.parseInt(priorityVal);
        }
 catch (        NumberFormatException ignore) {
        }
      }
      doReconfig=currentPriority != config.priority;
    }
    mNeedReconfig=mNeedReconfig || doReconfig;
  }
  setVariables: {
    if (config.SSID != null && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.ssidVarName,convertToQuotedString(config.SSID))) {
      if (DBG) {
        Slog.d(TAG,"failed to set SSID: " + config.SSID);
      }
      break setVariables;
    }
    if (config.BSSID != null && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.bssidVarName,config.BSSID)) {
      if (DBG) {
        Slog.d(TAG,"failed to set BSSID: " + config.BSSID);
      }
      break setVariables;
    }
    String allowedKeyManagementString=makeString(config.allowedKeyManagement,WifiConfiguration.KeyMgmt.strings);
    if (config.allowedKeyManagement.cardinality() != 0 && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.KeyMgmt.varName,allowedKeyManagementString)) {
      if (DBG) {
        Slog.d(TAG,"failed to set key_mgmt: " + allowedKeyManagementString);
      }
      break setVariables;
    }
    String allowedProtocolsString=makeString(config.allowedProtocols,WifiConfiguration.Protocol.strings);
    if (config.allowedProtocols.cardinality() != 0 && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.Protocol.varName,allowedProtocolsString)) {
      if (DBG) {
        Slog.d(TAG,"failed to set proto: " + allowedProtocolsString);
      }
      break setVariables;
    }
    String allowedAuthAlgorithmsString=makeString(config.allowedAuthAlgorithms,WifiConfiguration.AuthAlgorithm.strings);
    if (config.allowedAuthAlgorithms.cardinality() != 0 && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.AuthAlgorithm.varName,allowedAuthAlgorithmsString)) {
      if (DBG) {
        Slog.d(TAG,"failed to set auth_alg: " + allowedAuthAlgorithmsString);
      }
      break setVariables;
    }
    String allowedPairwiseCiphersString=makeString(config.allowedPairwiseCiphers,WifiConfiguration.PairwiseCipher.strings);
    if (config.allowedPairwiseCiphers.cardinality() != 0 && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.PairwiseCipher.varName,allowedPairwiseCiphersString)) {
      if (DBG) {
        Slog.d(TAG,"failed to set pairwise: " + allowedPairwiseCiphersString);
      }
      break setVariables;
    }
    String allowedGroupCiphersString=makeString(config.allowedGroupCiphers,WifiConfiguration.GroupCipher.strings);
    if (config.allowedGroupCiphers.cardinality() != 0 && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.GroupCipher.varName,allowedGroupCiphersString)) {
      if (DBG) {
        Slog.d(TAG,"failed to set group: " + allowedGroupCiphersString);
      }
      break setVariables;
    }
    if (config.preSharedKey != null && !config.preSharedKey.equals("*") && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.pskVarName,config.preSharedKey)) {
      if (DBG) {
        Slog.d(TAG,"failed to set psk: " + config.preSharedKey);
      }
      break setVariables;
    }
    boolean hasSetKey=false;
    if (config.wepKeys != null) {
      for (int i=0; i < config.wepKeys.length; i++) {
        if (config.wepKeys[i] != null && !config.wepKeys[i].equals("*")) {
          if (!mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.wepKeyVarNames[i],config.wepKeys[i])) {
            if (DBG) {
              Slog.d(TAG,"failed to set wep_key" + i + ": "+ config.wepKeys[i]);
            }
            break setVariables;
          }
          hasSetKey=true;
        }
      }
    }
    if (hasSetKey) {
      if (!mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.wepTxKeyIdxVarName,Integer.toString(config.wepTxKeyIndex))) {
        if (DBG) {
          Slog.d(TAG,"failed to set wep_tx_keyidx: " + config.wepTxKeyIndex);
        }
        break setVariables;
      }
    }
    if (!mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.priorityVarName,Integer.toString(config.priority))) {
      if (DBG) {
        Slog.d(TAG,config.SSID + ": failed to set priority: " + config.priority);
      }
      break setVariables;
    }
    if (config.hiddenSSID && !mWifiStateTracker.setNetworkVariable(netId,WifiConfiguration.hiddenSSIDVarName,Integer.toString(config.hiddenSSID ? 1 : 0))) {
      if (DBG) {
        Slog.d(TAG,config.SSID + ": failed to set hiddenSSID: " + config.hiddenSSID);
      }
      break setVariables;
    }
    for (    WifiConfiguration.EnterpriseField field : config.enterpriseFields) {
      String varName=field.varName();
      String value=field.value();
      if (value != null) {
        if (field != config.eap) {
          value=(value.length() == 0) ? "NULL" : convertToQuotedString(value);
        }
        if (!mWifiStateTracker.setNetworkVariable(netId,varName,value)) {
          if (DBG) {
            Slog.d(TAG,config.SSID + ": failed to set " + varName+ ": "+ value);
          }
          break setVariables;
        }
      }
    }
    return netId;
  }
  if (newNetwork) {
    removeNetwork(netId);
    if (DBG) {
      Slog.d(TAG,"Failed to set a network variable, removed network: " + netId);
    }
  }
  return -1;
}
