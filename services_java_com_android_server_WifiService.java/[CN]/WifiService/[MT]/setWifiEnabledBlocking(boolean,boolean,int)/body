{
  final int eventualWifiState=enable ? WIFI_STATE_ENABLED : WIFI_STATE_DISABLED;
  final int wifiState=mWifiStateTracker.getWifiState();
  if (wifiState == eventualWifiState) {
    return true;
  }
  if (enable && isAirplaneModeOn() && !mAirplaneModeOverwridden) {
    return false;
  }
  if ((wifiState == WIFI_STATE_UNKNOWN) && !enable) {
    return false;
  }
  if ((mWifiApState == WIFI_AP_STATE_ENABLED) && enable) {
    setWifiEnabledState(WIFI_STATE_UNKNOWN,uid);
    return false;
  }
  setWifiEnabledState(enable ? WIFI_STATE_ENABLING : WIFI_STATE_DISABLING,uid);
  if (enable) {
    if (!mWifiStateTracker.loadDriver()) {
      Slog.e(TAG,"Failed to load Wi-Fi driver.");
      setWifiEnabledState(WIFI_STATE_UNKNOWN,uid);
      return false;
    }
    if (!mWifiStateTracker.startSupplicant()) {
      mWifiStateTracker.unloadDriver();
      Slog.e(TAG,"Failed to start supplicant daemon.");
      setWifiEnabledState(WIFI_STATE_UNKNOWN,uid);
      return false;
    }
    registerForBroadcasts();
    mWifiStateTracker.startEventLoop();
  }
 else {
    mContext.unregisterReceiver(mReceiver);
    mWifiStateTracker.setNotificationVisible(false,0,false,0);
    boolean failedToStopSupplicantOrUnloadDriver=false;
    if (!mWifiStateTracker.stopSupplicant()) {
      Slog.e(TAG,"Failed to stop supplicant daemon.");
      setWifiEnabledState(WIFI_STATE_UNKNOWN,uid);
      failedToStopSupplicantOrUnloadDriver=true;
    }
    mWifiStateTracker.resetConnections(true);
    if (!mWifiStateTracker.unloadDriver()) {
      Slog.e(TAG,"Failed to unload Wi-Fi driver.");
      if (!failedToStopSupplicantOrUnloadDriver) {
        setWifiEnabledState(WIFI_STATE_UNKNOWN,uid);
        failedToStopSupplicantOrUnloadDriver=true;
      }
    }
    if (failedToStopSupplicantOrUnloadDriver) {
      return false;
    }
  }
  if (persist) {
    persistWifiEnabled(enable);
  }
  setWifiEnabledState(eventualWifiState,uid);
  return true;
}
