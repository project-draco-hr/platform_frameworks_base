{
  if (mChunkedStreamer != null) {
    return;
  }
  if (mKey == null) {
    throw new IllegalStateException("Not initialized");
  }
  KeymasterArguments keymasterArgs=new KeymasterArguments();
  keymasterArgs.addInt(KeymasterDefs.KM_TAG_ALGORITHM,KeymasterDefs.KM_ALGORITHM_HMAC);
  keymasterArgs.addInt(KeymasterDefs.KM_TAG_DIGEST,mKeymasterDigest);
  keymasterArgs.addInt(KeymasterDefs.KM_TAG_MAC_LENGTH,mMacSizeBits);
  KeymasterArguments keymasterOutputArgs=new KeymasterArguments();
  OperationResult opResult=mKeyStore.begin(mKey.getAlias(),KeymasterDefs.KM_PURPOSE_SIGN,true,keymasterArgs,null,keymasterOutputArgs);
  if (opResult == null) {
    throw new KeyStoreConnectException();
  }
 else   if ((opResult.resultCode != KeyStore.NO_ERROR) && (opResult.resultCode != KeyStore.OP_AUTH_NEEDED)) {
    throw mKeyStore.getInvalidKeyException(mKey.getAlias(),opResult.resultCode);
  }
  if (opResult.token == null) {
    throw new IllegalStateException("Keystore returned null operation token");
  }
  mOperationToken=opResult.token;
  mOperationHandle=opResult.operationHandle;
  mChunkedStreamer=new KeyStoreCryptoOperationChunkedStreamer(new KeyStoreCryptoOperationChunkedStreamer.MainDataStream(mKeyStore,mOperationToken));
  if (opResult.resultCode != KeyStore.NO_ERROR) {
    InvalidKeyException e=mKeyStore.getInvalidKeyException(mKey.getAlias(),opResult.resultCode);
    if (!(e instanceof UserNotAuthenticatedException)) {
      throw e;
    }
  }
}
