{
  IBinder operationToken=mOperationToken;
  if (operationToken != null) {
    mOperationToken=null;
    mKeyStore.abort(operationToken);
  }
  mOperationHandle=null;
  mChunkedStreamer=null;
  KeymasterArguments keymasterArgs=new KeymasterArguments();
  keymasterArgs.addInt(KeymasterDefs.KM_TAG_DIGEST,mDigest);
  OperationResult opResult=mKeyStore.begin(mKeyAliasInKeyStore,KeymasterDefs.KM_PURPOSE_SIGN,true,keymasterArgs,null,new KeymasterArguments());
  if (opResult == null) {
    throw new KeyStoreConnectException();
  }
 else   if (opResult.resultCode != KeyStore.NO_ERROR) {
    throw new CryptoOperationException("Failed to start keystore operation",KeymasterUtils.getExceptionForKeymasterError(opResult.resultCode));
  }
  mOperationToken=opResult.token;
  if (mOperationToken == null) {
    throw new CryptoOperationException("Keystore returned null operation token");
  }
  mOperationHandle=opResult.operationHandle;
  mChunkedStreamer=new KeyStoreCryptoOperationChunkedStreamer(new KeyStoreCryptoOperationChunkedStreamer.MainDataStream(mKeyStore,mOperationToken));
}
