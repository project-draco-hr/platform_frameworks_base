{
  final int anchorHeight=anchor.getHeight();
  final int anchorWidth=anchor.getWidth();
  if (mOverlapAnchor) {
    yoff-=anchorHeight;
  }
  anchor.getLocationInWindow(mDrawingLocation);
  p.x=mDrawingLocation[0] + xoff;
  p.y=mDrawingLocation[1] + anchorHeight + yoff;
  final int hgrav=Gravity.getAbsoluteGravity(gravity,anchor.getLayoutDirection()) & Gravity.HORIZONTAL_GRAVITY_MASK;
  if (hgrav == Gravity.RIGHT) {
    p.x-=mPopupWidth - anchorWidth;
  }
  boolean onTop=false;
  p.gravity=Gravity.LEFT | Gravity.TOP;
  anchor.getLocationOnScreen(mScreenLocation);
  final Rect displayFrame=new Rect();
  anchor.getWindowVisibleDisplayFrame(displayFrame);
  final int screenY=mScreenLocation[1] + anchorHeight + yoff;
  final View root=anchor.getRootView();
  if (screenY + mPopupHeight > displayFrame.bottom || p.x + mPopupWidth - root.getWidth() > 0) {
    if (mAllowScrollingAnchorParent) {
      final int scrollX=anchor.getScrollX();
      final int scrollY=anchor.getScrollY();
      final Rect r=new Rect(scrollX,scrollY,scrollX + mPopupWidth + xoff,scrollY + mPopupHeight + anchorHeight+ yoff);
      anchor.requestRectangleOnScreen(r,true);
    }
    anchor.getLocationInWindow(mDrawingLocation);
    p.x=mDrawingLocation[0] + xoff;
    p.y=mDrawingLocation[1] + anchorHeight + yoff;
    if (hgrav == Gravity.RIGHT) {
      p.x-=mPopupWidth - anchorWidth;
    }
    anchor.getLocationOnScreen(mScreenLocation);
    onTop=(displayFrame.bottom - mScreenLocation[1] - anchorHeight- yoff) < (mScreenLocation[1] - yoff - displayFrame.top);
    if (!mOverlapAnchor) {
      if (onTop) {
        p.gravity=Gravity.LEFT | Gravity.BOTTOM;
        p.y=root.getHeight() - mDrawingLocation[1] + yoff;
      }
 else {
        p.y=mDrawingLocation[1] + anchorHeight + yoff;
      }
    }
  }
  if (mClipToScreen) {
    final int displayFrameWidth=displayFrame.right - displayFrame.left;
    final int right=p.x + p.width;
    if (right > displayFrameWidth) {
      p.x-=right - displayFrameWidth;
    }
    if (p.x < displayFrame.left) {
      p.x=displayFrame.left;
      p.width=Math.min(p.width,displayFrameWidth);
    }
    if (mOverlapAnchor) {
      final int displayFrameHeight=displayFrame.bottom - displayFrame.top;
      final int bottom=p.y + p.height;
      if (bottom > displayFrame.bottom) {
        p.y-=bottom - displayFrameHeight;
      }
    }
 else {
      if (onTop) {
        final int popupTop=mScreenLocation[1] + yoff - mPopupHeight;
        if (popupTop < 0) {
          p.y+=popupTop;
        }
      }
 else {
        p.y=Math.max(p.y,displayFrame.top);
      }
    }
  }
  p.gravity|=Gravity.DISPLAY_CLIP_VERTICAL;
  return onTop;
}
