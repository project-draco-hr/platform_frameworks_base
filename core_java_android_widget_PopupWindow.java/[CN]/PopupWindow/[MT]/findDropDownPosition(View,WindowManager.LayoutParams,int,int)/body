{
  anchor.getLocationInWindow(mDrawingLocation);
  p.x=mDrawingLocation[0] + xoff;
  p.y=mDrawingLocation[1] + anchor.getHeight() + yoff;
  boolean onTop=false;
  p.gravity=Gravity.LEFT | Gravity.TOP;
  anchor.getLocationOnScreen(mScreenLocation);
  final Rect displayFrame=new Rect();
  anchor.getWindowVisibleDisplayFrame(displayFrame);
  final View root=anchor.getRootView();
  if (p.y + mPopupHeight > displayFrame.bottom || p.x + mPopupWidth - root.getWidth() > 0) {
    int scrollX=anchor.getScrollX();
    int scrollY=anchor.getScrollY();
    Rect r=new Rect(scrollX,scrollY,scrollX + mPopupWidth + xoff,scrollY + mPopupHeight + anchor.getHeight()+ yoff);
    anchor.requestRectangleOnScreen(r,true);
    anchor.getLocationInWindow(mDrawingLocation);
    p.x=mDrawingLocation[0] + xoff;
    p.y=mDrawingLocation[1] + anchor.getHeight() + yoff;
    anchor.getLocationOnScreen(mScreenLocation);
    onTop=(displayFrame.bottom - mScreenLocation[1] - anchor.getHeight()- yoff) < (mScreenLocation[1] - yoff - displayFrame.top);
    if (onTop) {
      p.gravity=Gravity.LEFT | Gravity.BOTTOM;
      p.y=root.getHeight() - mDrawingLocation[1] + yoff;
    }
 else {
      p.y=mDrawingLocation[1] + anchor.getHeight() + yoff;
    }
  }
  if (mClipToScreen) {
    final int displayFrameWidth=displayFrame.right - displayFrame.left;
    int right=p.x + p.width;
    if (right > displayFrameWidth) {
      p.x-=right - displayFrameWidth;
    }
    if (p.x < displayFrame.left) {
      p.x=displayFrame.left;
      p.width=Math.min(p.width,displayFrameWidth);
    }
    if (onTop) {
      int popupTop=mScreenLocation[1] + yoff - mPopupHeight;
      if (popupTop < 0) {
        p.y+=popupTop;
      }
    }
 else {
      p.y=Math.max(p.y,displayFrame.top);
    }
  }
  p.gravity|=Gravity.DISPLAY_CLIP_VERTICAL;
  return onTop;
}
