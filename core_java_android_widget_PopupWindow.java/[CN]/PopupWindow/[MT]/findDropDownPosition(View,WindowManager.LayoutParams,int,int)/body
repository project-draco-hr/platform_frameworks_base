{
  anchor.getLocationInWindow(mDrawingLocation);
  p.x=mDrawingLocation[0] + xoff;
  p.y=mDrawingLocation[1] + anchor.getMeasuredHeight() + yoff;
  boolean onTop=false;
  if (p.y + p.height > WindowManagerImpl.getDefault().getDefaultDisplay().getHeight()) {
    View root=anchor.getRootView();
    root.getLocationInWindow(mRootLocation);
    int delta=p.y + p.height - mRootLocation[1] - root.getHeight();
    if (delta > 0 || p.x + p.width - mRootLocation[0] - root.getWidth() > 0) {
      Rect r=new Rect(anchor.getScrollX(),anchor.getScrollY(),p.width,p.height + anchor.getMeasuredHeight());
      onTop=!anchor.requestRectangleOnScreen(r,true);
      if (onTop) {
        p.y-=anchor.getMeasuredHeight() + p.height;
      }
 else {
        anchor.getLocationOnScreen(mDrawingLocation);
        p.x=mDrawingLocation[0] + xoff;
        p.y=mDrawingLocation[1] + anchor.getMeasuredHeight() + yoff;
      }
    }
  }
  return onTop;
}
