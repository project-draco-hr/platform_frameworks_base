{
  ViewGroup hostView=resultState.getHostView();
  int childCount=hostView.getChildCount();
  state.visibleChildren.clear();
  state.visibleChildren.ensureCapacity(childCount);
  int notGoneIndex=0;
  TreeMap<String,HeadsUpManager.HeadsUpEntry> headsUpEntries=ambientState.getHeadsUpEntries();
  for (  String key : headsUpEntries.keySet()) {
    ExpandableView v=headsUpEntries.get(key).entry.row;
    notGoneIndex=updateNotGoneIndex(resultState,state,notGoneIndex,v);
  }
  for (int i=0; i < childCount; i++) {
    ExpandableView v=(ExpandableView)hostView.getChildAt(i);
    if (v.getVisibility() != View.GONE) {
      if (v instanceof ExpandableNotificationRow) {
        ExpandableNotificationRow row=(ExpandableNotificationRow)v;
        if (row.isHeadsUp()) {
          continue;
        }
        notGoneIndex=updateNotGoneIndex(resultState,state,notGoneIndex,v);
        List<ExpandableNotificationRow> children=row.getNotificationChildren();
        if (row.areChildrenExpanded() && children != null) {
          for (          ExpandableNotificationRow childRow : children) {
            if (childRow.getVisibility() != View.GONE) {
              StackViewState childState=resultState.getViewStateForView(childRow);
              childState.notGoneIndex=notGoneIndex;
              notGoneIndex++;
            }
          }
        }
      }
 else {
        notGoneIndex=updateNotGoneIndex(resultState,state,notGoneIndex,v);
      }
    }
  }
}
