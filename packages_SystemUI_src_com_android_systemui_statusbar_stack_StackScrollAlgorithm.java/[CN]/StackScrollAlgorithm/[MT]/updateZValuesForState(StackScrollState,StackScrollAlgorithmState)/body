{
  int childCount=algorithmState.visibleChildren.size();
  for (int i=0; i < childCount; i++) {
    View child=algorithmState.visibleChildren.get(i);
    StackScrollState.ViewState childViewState=resultState.getViewStateForView(child);
    if (i < algorithmState.itemsInTopStack) {
      float stackIndex=algorithmState.itemsInTopStack - i;
      float max=MAX_ITEMS_IN_TOP_STACK + (i == 0 ? 2.5f : 2);
      stackIndex=Math.min(stackIndex,max);
      if (i == 0 && algorithmState.itemsInTopStack < 2.0f) {
        stackIndex-=1.0f;
        if (algorithmState.scrollY > mCollapsedSize) {
          stackIndex=0.1f + stackIndex * 1.9f;
        }
      }
      childViewState.zTranslation=mZBasicHeight + stackIndex * mZDistanceBetweenElements;
    }
 else     if (i > (childCount - 1 - algorithmState.itemsInBottomStack)) {
      float numItemsAbove=i - (childCount - 1 - algorithmState.itemsInBottomStack);
      float translationZ=mZBasicHeight - numItemsAbove * mZDistanceBetweenElements;
      childViewState.zTranslation=translationZ;
    }
 else {
      childViewState.zTranslation=mZBasicHeight;
    }
  }
}
