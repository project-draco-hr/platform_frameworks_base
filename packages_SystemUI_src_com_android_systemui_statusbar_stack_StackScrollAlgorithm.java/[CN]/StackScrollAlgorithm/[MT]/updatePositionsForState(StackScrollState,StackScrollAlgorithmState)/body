{
  float stackHeight=getLayoutHeight();
  float transitioningPositionStart=stackHeight - mCollapsedSize - mBottomStackPeekSize;
  float currentYPosition=0.0f;
  float yPositionInScrollView=0.0f;
  ViewGroup hostView=resultState.getHostView();
  int childCount=hostView.getChildCount();
  int numberOfElementsCompletelyIn=(int)algorithmState.itemsInTopStack;
  for (int i=0; i < childCount; i++) {
    View child=hostView.getChildAt(i);
    StackScrollState.ViewState childViewState=resultState.getViewStateForView(child);
    childViewState.yTranslation=currentYPosition;
    int childHeight=child.getHeight();
    float nextYPosition=currentYPosition + childHeight + mPaddingBetweenElements;
    float yPositionInScrollViewAfterElement=yPositionInScrollView + childHeight + mPaddingBetweenElements;
    float scrollOffset=yPositionInScrollViewAfterElement - algorithmState.scrollY;
    if (i < algorithmState.lastTopStackIndex) {
      nextYPosition=updateStateForTopStackChild(algorithmState,numberOfElementsCompletelyIn,i,childViewState);
    }
 else     if (i == algorithmState.lastTopStackIndex) {
      nextYPosition=scrollOffset;
    }
 else     if (nextYPosition >= transitioningPositionStart) {
      if (currentYPosition >= transitioningPositionStart) {
        nextYPosition=updateStateForChildFullyInBottomStack(algorithmState,transitioningPositionStart,childViewState,childHeight);
      }
 else {
        nextYPosition=updateStateForChildTransitioningInBottom(algorithmState,stackHeight,transitioningPositionStart,currentYPosition,childViewState,childHeight,nextYPosition);
      }
    }
    currentYPosition=nextYPosition;
    yPositionInScrollView=yPositionInScrollViewAfterElement;
  }
}
