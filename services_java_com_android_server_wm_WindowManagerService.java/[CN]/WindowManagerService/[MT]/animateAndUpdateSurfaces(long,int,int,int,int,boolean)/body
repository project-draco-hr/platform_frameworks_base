{
  Surface.openTransaction();
  try {
    updateWindowsAppsAndRotationAnimationsLocked(currentTime,innerDw,innerDh);
    mPendingLayoutChanges=performAnimationsLocked(currentTime,dw,dh,innerDw,innerDh);
    if (mScreenRotationAnimation != null) {
      mScreenRotationAnimation.updateSurfaces();
    }
    final int N=mWindows.size();
    for (int i=N - 1; i >= 0; i--) {
      WindowState w=mWindows.get(i);
      prepareSurfaceLocked(w,recoveringMemory);
    }
    if (mDimAnimator != null && mDimAnimator.mDimShown) {
      mInnerFields.mAnimating|=mDimAnimator.updateSurface(mInnerFields.mDimming,currentTime,!okToDisplay());
    }
    if (mBlackFrame != null) {
      if (mScreenRotationAnimation != null) {
        mBlackFrame.setMatrix(mScreenRotationAnimation.getEnterTransformation().getMatrix());
      }
 else {
        mBlackFrame.clearMatrix();
      }
    }
  }
 catch (  RuntimeException e) {
    Log.wtf(TAG,"Unhandled exception in Window Manager",e);
  }
 finally {
    Surface.closeTransaction();
  }
}
