{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"addAppToken()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
  long inputDispatchingTimeoutNanos;
  try {
    inputDispatchingTimeoutNanos=token.getKeyDispatchingTimeout() * 1000000L;
  }
 catch (  RemoteException ex) {
    Slog.w(TAG,"Could not get dispatching timeout.",ex);
    inputDispatchingTimeoutNanos=DEFAULT_INPUT_DISPATCHING_TIMEOUT_NANOS;
  }
synchronized (mWindowMap) {
    AppWindowToken atoken=findAppWindowToken(token.asBinder());
    if (atoken != null) {
      Slog.w(TAG,"Attempted to add existing app token: " + token);
      return;
    }
    atoken=new AppWindowToken(this,token);
    atoken.inputDispatchingTimeoutNanos=inputDispatchingTimeoutNanos;
    atoken.groupId=taskId;
    atoken.appFullscreen=fullscreen;
    atoken.showWhenLocked=showWhenLocked;
    atoken.requestedOrientation=requestedOrientation;
    if (DEBUG_TOKEN_MOVEMENT || DEBUG_ADD_REMOVE)     Slog.v(TAG,"addAppToken: " + atoken + " to stack="+ stackId+ " task="+ taskId+ " at "+ addPos);
    Task task=mTaskIdToTask.get(taskId);
    if (task == null) {
      TaskStack stack=mStackIdToStack.get(stackId);
      if (stack == null) {
        throw new IllegalArgumentException("addAppToken: invalid stackId=" + stackId);
      }
      task=new Task(atoken,stack,userId);
      stack.addTask(task,true);
      stack.getDisplayContent().moveStack(stack,true);
      mTaskIdToTask.put(taskId,task);
    }
 else {
      task.addAppToken(addPos,atoken);
    }
    mTokenMap.put(token.asBinder(),atoken);
    atoken.hidden=true;
    atoken.hiddenRequested=true;
  }
}
