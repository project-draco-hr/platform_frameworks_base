{
  final IWindow client=win.mClient;
  final WindowToken token=win.mToken;
  final DisplayContent displayContent=win.mDisplayContent;
  final WindowList windows=win.getWindowList();
  final int N=windows.size();
  final WindowState attached=win.mAttachedWindow;
  int i;
  WindowList tokenWindowList=getTokenWindowsOnDisplay(token,displayContent);
  if (attached == null) {
    int tokenWindowsPos=0;
    int windowListPos=tokenWindowList.size();
    if (token.appWindowToken != null) {
      int index=windowListPos - 1;
      if (index >= 0) {
        if (win.mAttrs.type == TYPE_BASE_APPLICATION) {
          WindowState lowestWindow=tokenWindowList.get(0);
          placeWindowBefore(lowestWindow,win);
          tokenWindowsPos=token.windows.indexOf(lowestWindow);
        }
 else {
          AppWindowToken atoken=win.mAppToken;
          WindowState lastWindow=tokenWindowList.get(index);
          if (atoken != null && lastWindow == atoken.startingWindow) {
            placeWindowBefore(lastWindow,win);
            tokenWindowsPos=token.windows.indexOf(lastWindow);
          }
 else {
            int newIdx=findIdxBasedOnAppTokens(win);
            if (DEBUG_FOCUS || DEBUG_WINDOW_MOVEMENT || DEBUG_ADD_REMOVE) {
              Slog.v(TAG,"Adding window " + win + " at "+ (newIdx + 1)+ " of "+ N);
            }
            windows.add(newIdx + 1,win);
            if (newIdx < 0) {
              tokenWindowsPos=0;
            }
 else {
              tokenWindowsPos=token.windows.indexOf(windows.get(newIdx)) + 1;
            }
            mWindowsChanged=true;
          }
        }
      }
 else {
        if (localLOGV)         Slog.v(TAG,"Figuring out where to add app window " + client.asBinder() + " (token="+ token+ ")");
        final int NA=mAnimatingAppTokens.size();
        WindowState pos=null;
        for (i=NA - 1; i >= 0; i--) {
          AppWindowToken t=mAnimatingAppTokens.get(i);
          if (t == token) {
            i--;
            break;
          }
          tokenWindowList=getTokenWindowsOnDisplay(t,win.mDisplayContent);
          if (!t.sendingToBottom && tokenWindowList.size() > 0) {
            pos=tokenWindowList.get(0);
          }
        }
        if (pos != null) {
          WindowToken atoken=mTokenMap.get(pos.mClient.asBinder());
          if (atoken != null) {
            tokenWindowList=getTokenWindowsOnDisplay(atoken,win.mDisplayContent);
            final int NC=tokenWindowList.size();
            if (NC > 0) {
              WindowState bottom=tokenWindowList.get(0);
              if (bottom.mSubLayer < 0) {
                pos=bottom;
              }
            }
          }
          placeWindowBefore(pos,win);
        }
 else {
          while (i >= 0) {
            AppWindowToken t=mAnimatingAppTokens.get(i);
            tokenWindowList=getTokenWindowsOnDisplay(t,win.mDisplayContent);
            final int NW=tokenWindowList.size();
            if (NW > 0) {
              pos=tokenWindowList.get(NW - 1);
              break;
            }
            i--;
          }
          if (pos != null) {
            WindowToken atoken=mTokenMap.get(pos.mClient.asBinder());
            if (atoken != null) {
              final int NC=atoken.windows.size();
              if (NC > 0) {
                WindowState top=atoken.windows.get(NC - 1);
                if (top.mSubLayer >= 0) {
                  pos=top;
                }
              }
            }
            placeWindowAfter(pos,win);
          }
 else {
            final int myLayer=win.mBaseLayer;
            for (i=0; i < N; i++) {
              WindowState w=windows.get(i);
              if (w.mBaseLayer > myLayer) {
                break;
              }
            }
            if (DEBUG_FOCUS || DEBUG_WINDOW_MOVEMENT || DEBUG_ADD_REMOVE) {
              Slog.v(TAG,"Adding window " + win + " at "+ i+ " of "+ N);
            }
            windows.add(i,win);
            mWindowsChanged=true;
          }
        }
      }
    }
 else {
      final int myLayer=win.mBaseLayer;
      for (i=N - 1; i >= 0; i--) {
        if (windows.get(i).mBaseLayer <= myLayer) {
          break;
        }
      }
      i++;
      if (DEBUG_FOCUS || DEBUG_WINDOW_MOVEMENT || DEBUG_ADD_REMOVE)       Slog.v(TAG,"Adding window " + win + " at "+ i+ " of "+ N);
      windows.add(i,win);
      mWindowsChanged=true;
    }
    if (addToToken) {
      if (DEBUG_ADD_REMOVE)       Slog.v(TAG,"Adding " + win + " to "+ token);
      token.windows.add(tokenWindowsPos,win);
    }
  }
 else {
    final int NA=tokenWindowList.size();
    final int sublayer=win.mSubLayer;
    int largestSublayer=Integer.MIN_VALUE;
    WindowState windowWithLargestSublayer=null;
    for (i=0; i < NA; i++) {
      WindowState w=tokenWindowList.get(i);
      final int wSublayer=w.mSubLayer;
      if (wSublayer >= largestSublayer) {
        largestSublayer=wSublayer;
        windowWithLargestSublayer=w;
      }
      if (sublayer < 0) {
        if (wSublayer >= sublayer) {
          if (addToToken) {
            if (DEBUG_ADD_REMOVE)             Slog.v(TAG,"Adding " + win + " to "+ token);
            token.windows.add(i,win);
          }
          placeWindowBefore(wSublayer >= 0 ? attached : w,win);
          break;
        }
      }
 else {
        if (wSublayer > sublayer) {
          if (addToToken) {
            if (DEBUG_ADD_REMOVE)             Slog.v(TAG,"Adding " + win + " to "+ token);
            token.windows.add(i,win);
          }
          placeWindowBefore(w,win);
          break;
        }
      }
    }
    if (i >= NA) {
      if (addToToken) {
        if (DEBUG_ADD_REMOVE)         Slog.v(TAG,"Adding " + win + " to "+ token);
        token.windows.add(win);
      }
      if (sublayer < 0) {
        placeWindowBefore(attached,win);
      }
 else {
        placeWindowAfter(largestSublayer >= 0 ? windowWithLargestSublayer : attached,win);
      }
    }
  }
  if (win.mAppToken != null && addToToken) {
    win.mAppToken.allAppWindows.add(win);
  }
  if (windows.size() == 1) {
    mDisplayManagerService.setDisplayHasContent(win.getDisplayId(),true);
  }
}
