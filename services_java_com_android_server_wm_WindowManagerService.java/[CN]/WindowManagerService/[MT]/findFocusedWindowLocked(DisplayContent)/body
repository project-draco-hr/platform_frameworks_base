{
  final ArrayList<TaskList> tasks=displayContent.mTaskLists;
  int taskNdx=tasks.size() - 1;
  AppTokenList tokens=taskNdx >= 0 ? tasks.get(taskNdx).mAppTokens : null;
  int tokenNdx=tokens != null ? tokens.size() - 1 : -1;
  WindowToken nextApp=tokenNdx >= 0 ? tokens.get(tokenNdx) : null;
  --tokenNdx;
  if (tokenNdx < 0) {
    --taskNdx;
    if (taskNdx >= 0) {
      tokens=tasks.get(taskNdx).mAppTokens;
      tokenNdx=tokens.size() - 1;
    }
  }
  final WindowList windows=displayContent.getWindowList();
  for (int i=windows.size() - 1; i >= 0; i--) {
    final WindowState win=windows.get(i);
    if (localLOGV || DEBUG_FOCUS)     Slog.v(TAG,"Looking for focus: " + i + " = "+ win+ ", flags="+ win.mAttrs.flags+ ", canReceive="+ win.canReceiveKeys());
    AppWindowToken thisApp=win.mAppToken;
    if (thisApp != null && (thisApp.removed || thisApp.sendingToBottom)) {
      if (DEBUG_FOCUS)       Slog.v(TAG,"Skipping app because " + (thisApp.removed ? "removed" : "sendingToBottom"));
      continue;
    }
    if (thisApp != null && nextApp != null && thisApp != nextApp && win.mAttrs.type != TYPE_APPLICATION_STARTING) {
      final WindowToken origAppToken=nextApp;
      final int origTaskNdx=taskNdx;
      final int origTokenNdx=tokenNdx;
      for (; taskNdx >= 0; --taskNdx) {
        tokens=tasks.get(taskNdx).mAppTokens;
        for (; tokenNdx >= 0; --tokenNdx) {
          if (nextApp == mFocusedApp) {
            if (localLOGV || DEBUG_FOCUS)             Slog.v(TAG,"Reached focused app: " + mFocusedApp);
            return null;
          }
          nextApp=tokens.get(tokenNdx);
          if (nextApp == thisApp) {
            break;
          }
        }
        if (thisApp == nextApp) {
          break;
        }
      }
      if (thisApp != nextApp) {
        nextApp=origAppToken;
        taskNdx=origTaskNdx;
        tokenNdx=origTokenNdx;
      }
    }
    if (win.canReceiveKeys()) {
      if (DEBUG_FOCUS)       Slog.v(TAG,"Found focus @ " + i + " = "+ win);
      return win;
    }
  }
  return null;
}
