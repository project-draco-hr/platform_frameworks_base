{
  if (DEBUG_WINDOW_TRACE) {
    Slog.v(TAG,"performLayoutAndPlaceSurfacesLockedInner: entry. Called by " + Debug.getCallers(3));
  }
  if (mDefaultDisplay == null) {
    Slog.i(TAG,"skipping performLayoutAndPlaceSurfacesLockedInner with no mDisplay");
    return;
  }
  final WindowList windows=displayContent.getWindowList();
  final long currentTime=SystemClock.uptimeMillis();
  final DisplayInfo displayInfo=displayContent.getDisplayInfo();
  final int dw=displayInfo.logicalWidth;
  final int dh=displayInfo.logicalHeight;
  final int innerDw=displayInfo.appWidth;
  final int innerDh=displayInfo.appHeight;
  int i;
  if (mFocusMayChange) {
    mFocusMayChange=false;
    updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,false);
  }
  for (i=mExitingTokens.size() - 1; i >= 0; i--) {
    mExitingTokens.get(i).hasVisible=false;
  }
  for (i=mExitingAppTokens.size() - 1; i >= 0; i--) {
    mExitingAppTokens.get(i).hasVisible=false;
  }
  mInnerFields.mHoldScreen=null;
  mInnerFields.mScreenBrightness=-1;
  mInnerFields.mButtonBrightness=-1;
  mTransactionSequence++;
  if (SHOW_LIGHT_TRANSACTIONS)   Slog.i(TAG,">>> OPEN TRANSACTION performLayoutAndPlaceSurfaces");
  Surface.openTransaction();
  if (mWatermark != null) {
    mWatermark.positionSurface(dw,dh);
  }
  if (mStrictModeFlash != null) {
    mStrictModeFlash.positionSurface(dw,dh);
  }
  try {
    int repeats=0;
    do {
      repeats++;
      if (repeats > 6) {
        Slog.w(TAG,"Animation repeat aborted after too many iterations");
        mLayoutNeeded=false;
        break;
      }
      if (DEBUG_LAYOUT_REPEATS)       debugLayoutRepeats("On entry to LockedInner",mPendingLayoutChanges);
      if ((mPendingLayoutChanges & WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER) != 0) {
        if ((adjustWallpaperWindowsLocked() & ADJUST_WALLPAPER_LAYERS_CHANGED) != 0) {
          assignLayersLocked(windows);
          mLayoutNeeded=true;
        }
      }
      if ((mPendingLayoutChanges & WindowManagerPolicy.FINISH_LAYOUT_REDO_CONFIG) != 0) {
        if (DEBUG_LAYOUT)         Slog.v(TAG,"Computing new config from layout");
        if (updateOrientationFromAppTokensLocked(true)) {
          mLayoutNeeded=true;
          mH.sendEmptyMessage(H.SEND_NEW_CONFIGURATION);
        }
      }
      if ((mPendingLayoutChanges & WindowManagerPolicy.FINISH_LAYOUT_REDO_LAYOUT) != 0) {
        mLayoutNeeded=true;
      }
      if (repeats < 4) {
        performLayoutLockedInner(displayContent,repeats == 1,false);
      }
 else {
        Slog.w(TAG,"Layout repeat skipped after too many iterations");
      }
      mPendingLayoutChanges=0;
      if (DEBUG_LAYOUT_REPEATS)       debugLayoutRepeats("loop number " + mLayoutRepeatCount,mPendingLayoutChanges);
      mPolicy.beginAnimationLw(dw,dh);
      for (i=windows.size() - 1; i >= 0; i--) {
        WindowState w=windows.get(i);
        if (w.mHasSurface) {
          mPolicy.animatingWindowLw(w,w.mAttrs);
        }
      }
      mPendingLayoutChanges|=mPolicy.finishAnimationLw();
      if (DEBUG_LAYOUT_REPEATS)       debugLayoutRepeats("after finishAnimationLw",mPendingLayoutChanges);
    }
 while (mPendingLayoutChanges != 0);
    final boolean someoneLosingFocus=!mLosingFocus.isEmpty();
    mInnerFields.mObscured=false;
    mInnerFields.mDimming=false;
    mInnerFields.mSyswin=false;
    boolean focusDisplayed=false;
    boolean updateAllDrawn=false;
    final int N=windows.size();
    for (i=N - 1; i >= 0; i--) {
      WindowState w=windows.get(i);
      final boolean obscuredChanged=w.mObscured != mInnerFields.mObscured;
      w.mObscured=mInnerFields.mObscured;
      if (!mInnerFields.mObscured) {
        handleNotObscuredLocked(w,currentTime,innerDw,innerDh);
      }
      if (obscuredChanged && (mWallpaperTarget == w) && w.isVisibleLw()) {
        updateWallpaperVisibilityLocked();
      }
      final WindowStateAnimator winAnimator=w.mWinAnimator;
      if (w.mHasSurface && w.shouldAnimateMove()) {
        Animation a=AnimationUtils.loadAnimation(mContext,com.android.internal.R.anim.window_move_from_decor);
        winAnimator.setAnimation(a);
        winAnimator.mAnimDw=w.mLastFrame.left - w.mFrame.left;
        winAnimator.mAnimDh=w.mLastFrame.top - w.mFrame.top;
        try {
          w.mClient.moved(w.mFrame.left,w.mFrame.top);
        }
 catch (        RemoteException e) {
        }
      }
      w.mContentChanged=false;
      if (w.mHasSurface) {
        if (winAnimator.commitFinishDrawingLocked(currentTime)) {
          if ((w.mAttrs.flags & WindowManager.LayoutParams.FLAG_SHOW_WALLPAPER) != 0) {
            if (WindowManagerService.DEBUG_WALLPAPER)             Slog.v(TAG,"First draw done in potential wallpaper target " + w);
            mInnerFields.mWallpaperMayChange=true;
            mPendingLayoutChanges|=WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER;
            if (WindowManagerService.DEBUG_LAYOUT_REPEATS) {
              debugLayoutRepeats("wallpaper and commitFinishDrawingLocked true",mPendingLayoutChanges);
            }
          }
        }
        winAnimator.setSurfaceBoundaries(recoveringMemory);
        final AppWindowToken atoken=w.mAppToken;
        if (DEBUG_STARTING_WINDOW && atoken != null && w == atoken.startingWindow) {
          Slog.d(TAG,"updateWindows: starting " + w + " isOnScreen="+ w.isOnScreen()+ " allDrawn="+ atoken.allDrawn+ " freezingScreen="+ atoken.mAppAnimator.freezingScreen);
        }
        if (atoken != null && (!atoken.allDrawn || atoken.mAppAnimator.freezingScreen)) {
          if (atoken.lastTransactionSequence != mTransactionSequence) {
            atoken.lastTransactionSequence=mTransactionSequence;
            atoken.numInterestingWindows=atoken.numDrawnWindows=0;
            atoken.startingDisplayed=false;
          }
          if ((w.isOnScreen() || winAnimator.mAttrType == WindowManager.LayoutParams.TYPE_BASE_APPLICATION) && !w.mExiting && !w.mDestroying) {
            if (WindowManagerService.DEBUG_VISIBILITY || WindowManagerService.DEBUG_ORIENTATION) {
              Slog.v(TAG,"Eval win " + w + ": isDrawn="+ w.isDrawnLw()+ ", isAnimating="+ winAnimator.isAnimating());
              if (!w.isDrawnLw()) {
                Slog.v(TAG,"Not displayed: s=" + winAnimator.mSurface + " pv="+ w.mPolicyVisibility+ " mDrawState="+ winAnimator.mDrawState+ " ah="+ w.mAttachedHidden+ " th="+ atoken.hiddenRequested+ " a="+ winAnimator.mAnimating);
              }
            }
            if (w != atoken.startingWindow) {
              if (!atoken.mAppAnimator.freezingScreen || !w.mAppFreezing) {
                atoken.numInterestingWindows++;
                if (w.isDrawnLw()) {
                  atoken.numDrawnWindows++;
                  if (WindowManagerService.DEBUG_VISIBILITY || WindowManagerService.DEBUG_ORIENTATION)                   Slog.v(TAG,"tokenMayBeDrawn: " + atoken + " freezingScreen="+ atoken.mAppAnimator.freezingScreen+ " mAppFreezing="+ w.mAppFreezing);
                  updateAllDrawn=true;
                }
              }
            }
 else             if (w.isDrawnLw()) {
              atoken.startingDisplayed=true;
            }
          }
        }
      }
      if (someoneLosingFocus && w == mCurrentFocus && w.isDisplayedLw()) {
        focusDisplayed=true;
      }
      updateResizingWindows(w);
    }
    if (updateAllDrawn) {
      updateAllDrawnLocked();
    }
    if (focusDisplayed) {
      mH.sendEmptyMessage(H.REPORT_LOSING_FOCUS);
    }
    if (!mInnerFields.mDimming && mAnimator.isDimming()) {
      stopDimming();
    }
  }
 catch (  RuntimeException e) {
    Log.wtf(TAG,"Unhandled exception in Window Manager",e);
  }
 finally {
    Surface.closeTransaction();
  }
  if (mAppTransitionReady) {
    mPendingLayoutChanges|=handleAppTransitionReadyLocked(windows);
    if (DEBUG_LAYOUT_REPEATS)     debugLayoutRepeats("after handleAppTransitionReadyLocked",mPendingLayoutChanges);
  }
  mInnerFields.mAdjResult=0;
  if (!mAnimator.mAnimating && mAppTransitionRunning) {
    mPendingLayoutChanges|=handleAnimatingStoppedAndTransitionLocked();
    if (DEBUG_LAYOUT_REPEATS)     debugLayoutRepeats("after handleAnimStopAndXitionLock",mPendingLayoutChanges);
  }
  if (mInnerFields.mWallpaperForceHidingChanged && mPendingLayoutChanges == 0 && !mAppTransitionReady) {
    mPendingLayoutChanges|=animateAwayWallpaperLocked();
    if (DEBUG_LAYOUT_REPEATS)     debugLayoutRepeats("after animateAwayWallpaperLocked",mPendingLayoutChanges);
  }
  mInnerFields.mWallpaperForceHidingChanged=false;
  if (mInnerFields.mWallpaperMayChange) {
    if (WindowManagerService.DEBUG_WALLPAPER)     Slog.v(TAG,"Wallpaper may change!  Adjusting");
    mInnerFields.mAdjResult|=adjustWallpaperWindowsLocked();
  }
  if ((mInnerFields.mAdjResult & ADJUST_WALLPAPER_LAYERS_CHANGED) != 0) {
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"Wallpaper layer changed: assigning layers + relayout");
    mPendingLayoutChanges|=PhoneWindowManager.FINISH_LAYOUT_REDO_LAYOUT;
    assignLayersLocked(windows);
  }
 else   if ((mInnerFields.mAdjResult & ADJUST_WALLPAPER_VISIBILITY_CHANGED) != 0) {
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"Wallpaper visibility changed: relayout");
    mPendingLayoutChanges|=PhoneWindowManager.FINISH_LAYOUT_REDO_LAYOUT;
  }
  if (mFocusMayChange) {
    mFocusMayChange=false;
    if (updateFocusedWindowLocked(UPDATE_FOCUS_PLACING_SURFACES,false)) {
      mPendingLayoutChanges|=PhoneWindowManager.FINISH_LAYOUT_REDO_ANIM;
      mInnerFields.mAdjResult=0;
    }
  }
  if (mLayoutNeeded) {
    mPendingLayoutChanges|=PhoneWindowManager.FINISH_LAYOUT_REDO_LAYOUT;
    if (DEBUG_LAYOUT_REPEATS)     debugLayoutRepeats("mLayoutNeeded",mPendingLayoutChanges);
  }
  if (!mResizingWindows.isEmpty()) {
    for (i=mResizingWindows.size() - 1; i >= 0; i--) {
      WindowState win=mResizingWindows.get(i);
      final WindowStateAnimator winAnimator=win.mWinAnimator;
      try {
        if (DEBUG_RESIZE || DEBUG_ORIENTATION)         Slog.v(TAG,"Reporting new frame to " + win + ": "+ win.mCompatFrame);
        int diff=0;
        boolean configChanged=win.mConfiguration != mCurConfiguration && (win.mConfiguration == null || (diff=mCurConfiguration.diff(win.mConfiguration)) != 0);
        if ((DEBUG_RESIZE || DEBUG_ORIENTATION || DEBUG_CONFIGURATION) && configChanged) {
          Slog.i(TAG,"Sending new config to window " + win + ": "+ winAnimator.mSurfaceW+ "x"+ winAnimator.mSurfaceH+ " / "+ mCurConfiguration+ " / 0x"+ Integer.toHexString(diff));
        }
        win.mConfiguration=mCurConfiguration;
        if (DEBUG_ORIENTATION && winAnimator.mDrawState == WindowStateAnimator.DRAW_PENDING)         Slog.i(TAG,"Resizing " + win + " WITH DRAW PENDING");
        win.mClient.resized(win.mFrame,win.mLastContentInsets,win.mLastVisibleInsets,winAnimator.mDrawState == WindowStateAnimator.DRAW_PENDING,configChanged ? win.mConfiguration : null);
        win.mContentInsetsChanged=false;
        win.mVisibleInsetsChanged=false;
        winAnimator.mSurfaceResized=false;
      }
 catch (      RemoteException e) {
        win.mOrientationChanging=false;
      }
    }
    mResizingWindows.clear();
  }
  if (DEBUG_ORIENTATION && mDisplayFrozen)   Slog.v(TAG,"With display frozen, orientationChangeComplete=" + mInnerFields.mOrientationChangeComplete);
  if (mInnerFields.mOrientationChangeComplete) {
    if (mWindowsFreezingScreen) {
      mWindowsFreezingScreen=false;
      mH.removeMessages(H.WINDOW_FREEZE_TIMEOUT);
    }
    stopFreezingDisplayLocked();
  }
  boolean wallpaperDestroyed=false;
  i=mDestroySurface.size();
  if (i > 0) {
    do {
      i--;
      WindowState win=mDestroySurface.get(i);
      win.mDestroying=false;
      if (mInputMethodWindow == win) {
        mInputMethodWindow=null;
      }
      if (win == mWallpaperTarget) {
        wallpaperDestroyed=true;
      }
      win.mWinAnimator.destroySurfaceLocked();
    }
 while (i > 0);
    mDestroySurface.clear();
  }
  for (i=mExitingTokens.size() - 1; i >= 0; i--) {
    WindowToken token=mExitingTokens.get(i);
    if (!token.hasVisible) {
      mExitingTokens.remove(i);
      if (token.windowType == TYPE_WALLPAPER) {
        mWallpaperTokens.remove(token);
        updateLayoutToAnimWallpaperTokens();
      }
    }
  }
  for (i=mExitingAppTokens.size() - 1; i >= 0; i--) {
    AppWindowToken token=mExitingAppTokens.get(i);
    if (!token.hasVisible && !mClosingApps.contains(token)) {
      token.mAppAnimator.clearAnimation();
      token.mAppAnimator.animating=false;
      if (DEBUG_ADD_REMOVE || DEBUG_TOKEN_MOVEMENT)       Slog.v(TAG,"performLayout: App token exiting now removed" + token);
      mAppTokens.remove(token);
      mAnimatingAppTokens.remove(token);
      mExitingAppTokens.remove(i);
    }
  }
  if (!mAnimator.mAnimating && mRelayoutWhileAnimating.size() > 0) {
    for (int j=mRelayoutWhileAnimating.size() - 1; j >= 0; j--) {
      try {
        mRelayoutWhileAnimating.get(j).mClient.doneAnimating();
      }
 catch (      RemoteException e) {
      }
    }
    mRelayoutWhileAnimating.clear();
  }
  if (wallpaperDestroyed) {
    mLayoutNeeded|=adjustWallpaperWindowsLocked() != 0;
  }
  if (mPendingLayoutChanges != 0) {
    mLayoutNeeded=true;
  }
  mInputMonitor.updateInputWindowsLw(true);
  setHoldScreenLocked(mInnerFields.mHoldScreen);
  if (!mDisplayFrozen) {
    if (mInnerFields.mScreenBrightness < 0 || mInnerFields.mScreenBrightness > 1.0f) {
      mPowerManager.setScreenBrightnessOverrideFromWindowManager(-1);
    }
 else {
      mPowerManager.setScreenBrightnessOverrideFromWindowManager(toBrightnessOverride(mInnerFields.mScreenBrightness));
    }
    if (mInnerFields.mButtonBrightness < 0 || mInnerFields.mButtonBrightness > 1.0f) {
      mPowerManager.setButtonBrightnessOverrideFromWindowManager(-1);
    }
 else {
      mPowerManager.setButtonBrightnessOverrideFromWindowManager(toBrightnessOverride(mInnerFields.mButtonBrightness));
    }
  }
  if (mTurnOnScreen) {
    if (DEBUG_VISIBILITY)     Slog.v(TAG,"Turning screen on after layout!");
    mPowerManager.wakeUp(SystemClock.uptimeMillis());
    mTurnOnScreen=false;
  }
  if (mInnerFields.mUpdateRotation) {
    if (DEBUG_ORIENTATION)     Slog.d(TAG,"Performing post-rotate rotation");
    if (updateRotationUncheckedLocked(false)) {
      mH.sendEmptyMessage(H.SEND_NEW_CONFIGURATION);
    }
 else {
      mInnerFields.mUpdateRotation=false;
    }
  }
  if (mInnerFields.mOrientationChangeComplete && !mLayoutNeeded && !mInnerFields.mUpdateRotation) {
    checkDrawnWindowsLocked();
  }
  enableScreenIfNeededLocked();
  updateLayoutToAnimationLocked();
  if (DEBUG_WINDOW_TRACE) {
    Slog.e(TAG,"performLayoutAndPlaceSurfacesLockedInner exit: mPendingLayoutChanges=" + Integer.toHexString(mPendingLayoutChanges) + " mLayoutNeeded="+ mLayoutNeeded+ " animating="+ mAnimator.mAnimating);
  }
}
