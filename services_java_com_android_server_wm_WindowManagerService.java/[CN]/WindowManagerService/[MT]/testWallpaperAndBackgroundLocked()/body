{
  int changes=0;
  if (mWindowDetachedWallpaper != mInnerFields.mDetachedWallpaper) {
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"Detached wallpaper changed from " + mWindowDetachedWallpaper + " to "+ mInnerFields.mDetachedWallpaper);
    mWindowDetachedWallpaper=mInnerFields.mDetachedWallpaper;
    mInnerFields.mWallpaperMayChange=true;
  }
  if (mAnimator.mWindowAnimationBackgroundColor != 0) {
    WindowState target=mAnimator.mWindowAnimationBackground;
    if (mWallpaperTarget == target || mLowerWallpaperTarget == target || mUpperWallpaperTarget == target) {
      for (int i=0; i < mWindows.size(); i++) {
        WindowState w=mWindows.get(i);
        if (w.mIsWallpaper) {
          target=w;
          break;
        }
      }
    }
    if (mWindowAnimationBackgroundSurface == null) {
      mWindowAnimationBackgroundSurface=new DimSurface(mFxSession);
    }
    final int dw=mCurDisplayWidth;
    final int dh=mCurDisplayHeight;
    mWindowAnimationBackgroundSurface.show(dw,dh,target.mAnimLayer - LAYER_OFFSET_DIM,mAnimator.mWindowAnimationBackgroundColor);
  }
 else   if (mWindowAnimationBackgroundSurface != null) {
    mWindowAnimationBackgroundSurface.hide();
  }
  if (mInnerFields.mWallpaperMayChange) {
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"Wallpaper may change!  Adjusting");
    mInnerFields.mAdjResult|=adjustWallpaperWindowsLocked();
  }
  if ((mInnerFields.mAdjResult & ADJUST_WALLPAPER_LAYERS_CHANGED) != 0) {
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"Wallpaper layer changed: assigning layers + relayout");
    changes|=PhoneWindowManager.FINISH_LAYOUT_REDO_LAYOUT;
    assignLayersLocked();
  }
 else   if ((mInnerFields.mAdjResult & ADJUST_WALLPAPER_VISIBILITY_CHANGED) != 0) {
    if (DEBUG_WALLPAPER)     Slog.v(TAG,"Wallpaper visibility changed: relayout");
    changes|=PhoneWindowManager.FINISH_LAYOUT_REDO_LAYOUT;
  }
  if (mFocusMayChange) {
    mFocusMayChange=false;
    if (updateFocusedWindowLocked(UPDATE_FOCUS_PLACING_SURFACES,false)) {
      changes|=PhoneWindowManager.FINISH_LAYOUT_REDO_ANIM;
      mInnerFields.mAdjResult=0;
    }
  }
  return changes;
}
