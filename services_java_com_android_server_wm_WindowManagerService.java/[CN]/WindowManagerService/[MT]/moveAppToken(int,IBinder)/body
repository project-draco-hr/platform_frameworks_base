{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"moveAppToken()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
synchronized (mWindowMap) {
    if (DEBUG_REORDER)     Slog.v(TAG,"Initial app tokens:");
    if (DEBUG_REORDER)     dumpAppTokensLocked();
    final AppWindowToken wtoken=findAppWindowToken(token);
    DisplayContent displayContent=mTaskIdToDisplayContents.get(wtoken.groupId);
    final AppTokenList appTokens=displayContent.mAppTokens;
    final AppTokenList animatingAppTokens=displayContent.mAnimatingAppTokens;
    final int oldIndex=appTokens.indexOf(wtoken);
    if (DEBUG_TOKEN_MOVEMENT || DEBUG_REORDER)     Slog.v(TAG,"Start moving token " + wtoken + " initially at "+ oldIndex);
    if (oldIndex > index && mAppTransition.isTransitionSet()) {
      displayContent.refillAnimatingAppTokens();
    }
    if (wtoken == null || !appTokens.remove(wtoken)) {
      Slog.w(TAG,"Attempting to reorder token that doesn't exist: " + token + " ("+ wtoken+ ")");
      return;
    }
    appTokens.add(index,wtoken);
    if (DEBUG_REORDER)     Slog.v(TAG,"Moved " + token + " to "+ index+ ":");
 else     if (DEBUG_TOKEN_MOVEMENT)     Slog.v(TAG,"Moved " + token + " to "+ index);
    if (DEBUG_REORDER)     dumpAppTokensLocked();
    if (!mAppTransition.isTransitionSet()) {
      displayContent.refillAnimatingAppTokens();
      final long origId=Binder.clearCallingIdentity();
      if (DEBUG_REORDER)       Slog.v(TAG,"Removing windows in " + token + ":");
      if (DEBUG_REORDER)       dumpWindowsLocked();
      if (tmpRemoveAppWindowsLocked(wtoken)) {
        if (DEBUG_REORDER)         Slog.v(TAG,"Adding windows back in:");
        if (DEBUG_REORDER)         dumpWindowsLocked();
        DisplayContentsIterator iterator=new DisplayContentsIterator();
        while (iterator.hasNext()) {
          displayContent=iterator.next();
          final int pos=findWindowOffsetLocked(displayContent,index);
          final int newPos=reAddAppWindowsLocked(displayContent,pos,wtoken);
          if (pos != newPos) {
            displayContent.layoutNeeded=true;
          }
        }
        if (DEBUG_REORDER)         Slog.v(TAG,"Final window list:");
        if (DEBUG_REORDER)         dumpWindowsLocked();
        updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,false);
        mInputMonitor.setUpdateInputWindowsNeededLw();
        performLayoutAndPlaceSurfacesLocked();
        mInputMonitor.updateInputWindowsLw(false);
      }
      Binder.restoreCallingIdentity(origId);
    }
  }
}
