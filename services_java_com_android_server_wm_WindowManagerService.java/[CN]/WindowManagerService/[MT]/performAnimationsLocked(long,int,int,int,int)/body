{
  ++mTransactionSequence;
  if (DEBUG_APP_TRANSITIONS)   Slog.v(TAG,"*** ANIM STEP: seq=" + mTransactionSequence + " mAnimating="+ mInnerFields.mAnimating);
  mInnerFields.mTokenMayBeDrawn=false;
  mInnerFields.mWallpaperMayChange=false;
  mInnerFields.mForceHiding=false;
  mInnerFields.mDetachedWallpaper=null;
  mInnerFields.mWindowAnimationBackground=null;
  mInnerFields.mWindowAnimationBackgroundColor=0;
  int changes=updateWindowsAndWallpaperLocked(currentTime,dw,dh,innerDw,innerDh);
  if (mInnerFields.mTokenMayBeDrawn) {
    changes|=testTokenMayBeDrawnLocked();
  }
  if (mAppTransitionReady) {
    changes|=handleAppTransitionReadyLocked();
  }
  mInnerFields.mAdjResult=0;
  if (!mInnerFields.mAnimating && mAppTransitionRunning) {
    changes|=handleAnimatingStoppedAndTransitionLocked();
  }
  if (mInnerFields.mWallpaperForceHidingChanged && changes == 0 && !mAppTransitionReady) {
    changes|=animateAwayWallpaperLocked();
  }
  changes|=testWallpaperAndBackgroundLocked();
  if (mLayoutNeeded) {
    changes|=PhoneWindowManager.FINISH_LAYOUT_REDO_LAYOUT;
  }
  if (DEBUG_APP_TRANSITIONS)   Slog.v(TAG,"*** ANIM STEP: changes=0x" + Integer.toHexString(changes));
  return changes;
}
