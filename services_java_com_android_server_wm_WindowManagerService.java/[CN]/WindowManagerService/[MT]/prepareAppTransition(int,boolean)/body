{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"prepareAppTransition()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
synchronized (mWindowMap) {
    if (DEBUG_APP_TRANSITIONS)     Slog.v(TAG,"Prepare app transition: transit=" + transit + " "+ mAppTransition+ " alwaysKeepCurrent="+ alwaysKeepCurrent+ " Callers="+ Debug.getCallers(3));
    if (!mAppTransition.isTransitionSet() || mAppTransition.isTransitionNone()) {
      mAppTransition.setAppTransition(transit);
    }
 else     if (!alwaysKeepCurrent) {
      if (transit == AppTransition.TRANSIT_TASK_OPEN && mAppTransition.isTransitionEqual(AppTransition.TRANSIT_TASK_CLOSE)) {
        mAppTransition.setAppTransition(transit);
      }
 else       if (transit == AppTransition.TRANSIT_ACTIVITY_OPEN && mAppTransition.isTransitionEqual(AppTransition.TRANSIT_ACTIVITY_CLOSE)) {
        mAppTransition.setAppTransition(transit);
      }
    }
    if (okToDisplay()) {
      mAppTransition.prepare();
      mStartingIconInTransition=false;
      mSkipAppTransitionAnimation=false;
      mH.removeMessages(H.APP_TRANSITION_TIMEOUT);
      mH.sendEmptyMessageDelayed(H.APP_TRANSITION_TIMEOUT,5000);
    }
  }
}
