{
  int curGroup=0;
  int lastOrientation=ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED;
  boolean findingBehind=false;
  boolean haveGroup=false;
  boolean lastFullscreen=false;
  for (int pos=mAppTokens.size() - 1; pos >= 0; pos--) {
    AppWindowToken atoken=mAppTokens.get(pos);
    if (DEBUG_APP_ORIENTATION)     Slog.v(TAG,"Checking app orientation: " + atoken);
    if (!findingBehind && (!atoken.hidden && atoken.hiddenRequested)) {
      if (DEBUG_ORIENTATION)       Slog.v(TAG,"Skipping " + atoken + " -- going to hide");
      continue;
    }
    if (haveGroup == true && curGroup != atoken.groupId) {
      if (lastOrientation != ActivityInfo.SCREEN_ORIENTATION_BEHIND && lastFullscreen) {
        if (DEBUG_ORIENTATION)         Slog.v(TAG,"Done at " + atoken + " -- end of group, return "+ lastOrientation);
        return lastOrientation;
      }
    }
    if (atoken.hiddenRequested || atoken.willBeHidden) {
      if (DEBUG_ORIENTATION)       Slog.v(TAG,"Skipping " + atoken + " -- hidden on top");
      continue;
    }
    if (!haveGroup) {
      haveGroup=true;
      curGroup=atoken.groupId;
      lastOrientation=atoken.requestedOrientation;
    }
    int or=atoken.requestedOrientation;
    lastFullscreen=atoken.appFullscreen;
    if (lastFullscreen && or != ActivityInfo.SCREEN_ORIENTATION_BEHIND) {
      if (DEBUG_ORIENTATION)       Slog.v(TAG,"Done at " + atoken + " -- full screen, return "+ or);
      return or;
    }
    if (or != ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED && or != ActivityInfo.SCREEN_ORIENTATION_BEHIND) {
      if (DEBUG_ORIENTATION)       Slog.v(TAG,"Done at " + atoken + " -- explicitly set, return "+ or);
      return or;
    }
    findingBehind|=(or == ActivityInfo.SCREEN_ORIENTATION_BEHIND);
  }
  if (DEBUG_ORIENTATION)   Slog.v(TAG,"No app is requesting an orientation");
  return ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED;
}
