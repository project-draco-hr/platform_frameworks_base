{
  if (!mDisplayFrozen && mPolicy.isScreenOn()) {
    if (!mDrawPending && !mCommitDrawPending && mAnimation != null) {
      mHasTransformation=true;
      mHasLocalTransformation=true;
      if (!mLocalAnimating) {
        if (DEBUG_ANIM)         Slog.v(TAG,"Starting animation in " + this + " @ "+ currentTime+ ": ww="+ mFrame.width()+ " wh="+ mFrame.height()+ " dw="+ dw+ " dh="+ dh+ " scale="+ mWindowAnimationScale);
        mAnimation.initialize(mFrame.width(),mFrame.height(),dw,dh);
        mAnimation.setStartTime(currentTime);
        mLocalAnimating=true;
        mAnimating=true;
      }
      mTransformation.clear();
      final boolean more=mAnimation.getTransformation(currentTime,mTransformation);
      if (DEBUG_ANIM)       Slog.v(TAG,"Stepped animation in " + this + ": more="+ more+ ", xform="+ mTransformation);
      if (more) {
        return true;
      }
      if (DEBUG_ANIM)       Slog.v(TAG,"Finished animation in " + this + " @ "+ currentTime);
      if (mAnimation != null) {
        mAnimation.cancel();
        mAnimation=null;
      }
    }
    mHasLocalTransformation=false;
    if ((!mLocalAnimating || mAnimationIsEntrance) && mAppToken != null && mAppToken.animation != null) {
      mAnimating=true;
      mHasTransformation=true;
      mTransformation.clear();
      return false;
    }
 else     if (mHasTransformation) {
      mAnimating=true;
    }
 else     if (isAnimating()) {
      mAnimating=true;
    }
  }
 else   if (mAnimation != null) {
    mAnimating=true;
    mLocalAnimating=true;
    mAnimation.cancel();
    mAnimation=null;
  }
  if (!mAnimating && !mLocalAnimating) {
    return false;
  }
  if (DEBUG_ANIM)   Slog.v(TAG,"Animation done in " + this + ": exiting="+ mExiting+ ", reportedVisible="+ (mAppToken != null ? mAppToken.reportedVisible : false));
  mAnimating=false;
  mLocalAnimating=false;
  if (mAnimation != null) {
    mAnimation.cancel();
    mAnimation=null;
  }
  mAnimLayer=mLayer;
  if (mIsImWindow) {
    mAnimLayer+=mInputMethodAnimLayerAdjustment;
  }
 else   if (mIsWallpaper) {
    mAnimLayer+=mWallpaperAnimLayerAdjustment;
  }
  if (DEBUG_LAYERS)   Slog.v(TAG,"Stepping win " + this + " anim layer: "+ mAnimLayer);
  mHasTransformation=false;
  mHasLocalTransformation=false;
  if (mPolicyVisibility != mPolicyVisibilityAfterAnim) {
    if (DEBUG_VISIBILITY) {
      Slog.v(TAG,"Policy visibility changing after anim in " + this + ": "+ mPolicyVisibilityAfterAnim);
    }
    mPolicyVisibility=mPolicyVisibilityAfterAnim;
    if (!mPolicyVisibility) {
      if (mCurrentFocus == this) {
        mFocusMayChange=true;
      }
      enableScreenIfNeededLocked();
    }
  }
  mTransformation.clear();
  if (mHasDrawn && mAttrs.type == WindowManager.LayoutParams.TYPE_APPLICATION_STARTING && mAppToken != null && mAppToken.firstWindowDrawn && mAppToken.startingData != null) {
    if (DEBUG_STARTING_WINDOW)     Slog.v(TAG,"Finish starting " + mToken + ": first real window done animating");
    mFinishedStarting.add(mAppToken);
    mH.sendEmptyMessage(H.FINISHED_STARTING);
  }
  finishExit();
  if (mAppToken != null) {
    mAppToken.updateReportedVisibilityLocked();
  }
  return false;
}
