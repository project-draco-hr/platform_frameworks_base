{
  long thisPeriod=elapsedRealtime / PERIOD_DURATION;
  if (mLastPeriod != 0 && mLastPeriod < thisPeriod && (thisPeriod - mLastPeriod) < HISTORY_SIZE - 1) {
    int diff=(int)(thisPeriod - mLastPeriod);
    final int NUSERS=mIdleHistory.size();
    for (int u=0; u < NUSERS; u++) {
      userHistory=mIdleHistory.valueAt(u);
      for (      PackageHistory idleState : userHistory.values()) {
        System.arraycopy(idleState.recent,diff,idleState.recent,0,HISTORY_SIZE - diff);
        for (int i=0; i < diff; i++) {
          idleState.recent[HISTORY_SIZE - i - 1]=(byte)(idleState.recent[HISTORY_SIZE - diff - 1] & FLAG_LAST_STATE);
        }
      }
    }
  }
  mLastPeriod=thisPeriod;
}
