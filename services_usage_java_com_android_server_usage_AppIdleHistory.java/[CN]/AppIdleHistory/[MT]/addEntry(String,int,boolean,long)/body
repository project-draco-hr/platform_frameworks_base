{
  ArrayMap<String,byte[]> userHistory=idleHistory.get(userId);
  if (userHistory == null) {
    userHistory=new ArrayMap<>();
    idleHistory.put(userId,userHistory);
  }
  byte[] packageHistory=userHistory.get(packageName);
  if (packageHistory == null) {
    packageHistory=new byte[HISTORY_SIZE];
    userHistory.put(packageName,packageHistory);
  }
  long thisPeriod=timeNow / PERIOD_DURATION;
  if (lastPeriod != 0 && lastPeriod < thisPeriod && (thisPeriod - lastPeriod) < HISTORY_SIZE - 1) {
    int diff=(int)(thisPeriod - lastPeriod);
    final int NUSERS=idleHistory.size();
    for (int u=0; u < NUSERS; u++) {
      userHistory=idleHistory.valueAt(u);
      for (      byte[] history : userHistory.values()) {
        System.arraycopy(history,diff,history,0,HISTORY_SIZE - diff);
        for (int i=0; i < diff; i++) {
          history[HISTORY_SIZE - i - 1]=(byte)(history[HISTORY_SIZE - diff - 1] & FLAG_LAST_STATE);
        }
      }
    }
  }
  lastPeriod=thisPeriod;
  if (!idle) {
    packageHistory[HISTORY_SIZE - 1]=FLAG_LAST_STATE | FLAG_PARTIAL_ACTIVE;
  }
 else {
    packageHistory[HISTORY_SIZE - 1]&=~FLAG_LAST_STATE;
  }
}
