{
  Message msg;
  mGSMPhone.dial("+13125551212");
  do {
    mRadioControl.progressConnectingCallState();
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getForegroundCall().getState() != Call.State.ACTIVE);
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
  mRadioControl.triggerRing("18005551212");
  do {
    msg=mTestHandler.getNextMessage();
  }
 while (msg.what != EVENT_RINGING);
  assertEquals(Phone.State.RINGING,mGSMPhone.getState());
  assertTrue(mGSMPhone.getRingingCall().isRinging());
  assertEquals(Call.State.WAITING,mGSMPhone.getRingingCall().getState());
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
  mGSMPhone.handleInCallMmiCommands("1");
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getRingingCall().getState() == Call.State.WAITING);
  assertEquals(Phone.State.OFFHOOK,mGSMPhone.getState());
  assertFalse(mGSMPhone.getRingingCall().isRinging());
  assertEquals(Call.State.IDLE,mGSMPhone.getRingingCall().getState());
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals("18005551212",mGSMPhone.getForegroundCall().getConnections().get(0).getAddress());
  mGSMPhone.switchHoldingAndActive();
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getBackgroundCall().getState() == Call.State.IDLE);
  assertEquals(Call.State.IDLE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.HOLDING,mGSMPhone.getBackgroundCall().getState());
  mGSMPhone.handleInCallMmiCommands("1");
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getBackgroundCall().getState() != Call.State.IDLE);
  assertEquals(Phone.State.OFFHOOK,mGSMPhone.getState());
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
  assertEquals("18005551212",mGSMPhone.getForegroundCall().getConnections().get(0).getAddress());
  mRadioControl.triggerRing("16505550100");
  do {
    msg=mTestHandler.getNextMessage();
  }
 while (msg.what != EVENT_RINGING);
  assertEquals(Phone.State.RINGING,mGSMPhone.getState());
  assertTrue(mGSMPhone.getRingingCall().isRinging());
  assertEquals(Call.State.WAITING,mGSMPhone.getRingingCall().getState());
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
  mGSMPhone.handleInCallMmiCommands("12");
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getForegroundCall().getState() == Call.State.ACTIVE);
  assertEquals(Phone.State.RINGING,mGSMPhone.getState());
  assertTrue(mGSMPhone.getRingingCall().isRinging());
  assertEquals(Call.State.WAITING,mGSMPhone.getRingingCall().getState());
  assertEquals(Call.State.DISCONNECTED,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
  mGSMPhone.acceptCall();
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getState() != Phone.State.OFFHOOK);
  assertEquals(Phone.State.OFFHOOK,mGSMPhone.getState());
  assertFalse(mGSMPhone.getRingingCall().isRinging());
  assertEquals(Call.State.IDLE,mGSMPhone.getRingingCall().getState());
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
  mGSMPhone.dial("+13125551212");
  do {
    mRadioControl.progressConnectingCallState();
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getForegroundCall().getState() != Call.State.ACTIVE || mGSMPhone.getBackgroundCall().getState() != Call.State.HOLDING);
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.HOLDING,mGSMPhone.getBackgroundCall().getState());
  mGSMPhone.handleInCallMmiCommands("11");
  do {
    msg=mTestHandler.getNextMessage();
  }
 while (msg != null && msg.what != SUPP_SERVICE_FAILED);
  assertFalse("IncallMmiCallWaiting: command should not work on holding call",msg == null);
  mGSMPhone.handleInCallMmiCommands("12");
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getForegroundCall().getState() == Call.State.ACTIVE);
  assertEquals(Call.State.DISCONNECTED,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.HOLDING,mGSMPhone.getBackgroundCall().getState());
  mGSMPhone.handleInCallMmiCommands("1");
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getBackgroundCall().getState() != Call.State.IDLE);
  assertEquals(Phone.State.OFFHOOK,mGSMPhone.getState());
  assertEquals(Call.State.ACTIVE,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
  assertEquals("16505550100",mGSMPhone.getForegroundCall().getConnections().get(0).getAddress());
  mGSMPhone.handleInCallMmiCommands("11");
  do {
    mTestHandler.getNextMessage();
  }
 while (mGSMPhone.getForegroundCall().getState() == Call.State.ACTIVE);
  assertEquals(Call.State.DISCONNECTED,mGSMPhone.getForegroundCall().getState());
  assertEquals(Call.State.IDLE,mGSMPhone.getBackgroundCall().getState());
}
