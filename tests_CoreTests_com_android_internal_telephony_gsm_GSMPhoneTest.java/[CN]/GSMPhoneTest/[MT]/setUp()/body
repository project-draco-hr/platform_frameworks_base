{
  super.setUp();
  mTestHandler=TestHandler.create("GSMPhoneTest TestHandler",new Runnable(){
    public void run(){
      SimulatedCommands sc=new SimulatedCommands();
      mRadioControl=sc;
      mGSMPhone=new GSMPhone(mContext,sc,new TestPhoneNotifier(),true);
    }
  }
);
  mTestHandler.setFailTimeoutMillis(FAIL_TIMEOUT_MILLIS);
  mGSMPhone.registerForPhoneStateChanged(mTestHandler.hh,EVENT_PHONE_STATE_CHANGED,null);
  mGSMPhone.registerForNewRingingConnection(mTestHandler.hh,EVENT_RINGING,null);
  mGSMPhone.registerForDisconnect(mTestHandler.hh,EVENT_DISCONNECT,null);
  mGSMPhone.setOnPostDialCharacter(mTestHandler.hh,EVENT_POST_DIAL,null);
  mGSMPhone.registerForSuppServiceNotification(mTestHandler.hh,EVENT_SSN,null);
  mGSMPhone.registerForMmiInitiate(mTestHandler.hh,EVENT_MMI_INITIATE,null);
  mGSMPhone.registerForMmiComplete(mTestHandler.hh,EVENT_MMI_COMPLETE,null);
  mGSMPhone.registerForSuppServiceFailed(mTestHandler.hh,SUPP_SERVICE_FAILED,null);
  mGSMPhone.registerForServiceStateChanged(mTestHandler.hh,SERVICE_STATE_CHANGED,null);
  Message msg;
  ServiceState state;
  do {
    do {
      msg=mTestHandler.getNextMessage();
    }
 while (msg.what != SERVICE_STATE_CHANGED);
    state=(ServiceState)((AsyncResult)msg.obj).result;
  }
 while (state.getState() != ServiceState.STATE_IN_SERVICE);
}
