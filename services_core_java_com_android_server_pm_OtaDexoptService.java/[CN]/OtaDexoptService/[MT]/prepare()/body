{
  if (mDexoptCommands != null) {
    throw new IllegalStateException("already called prepare()");
  }
synchronized (mPackageManagerService.mPackages) {
    List<PackageParser.Package> important=PackageManagerServiceUtils.getPackagesForDexopt(mPackageManagerService.mPackages.values(),mPackageManagerService);
    List<PackageParser.Package> others=new ArrayList<>(mPackageManagerService.mPackages.values());
    others.removeAll(important);
    mDexoptCommands=new ArrayList<>(3 * mPackageManagerService.mPackages.size() / 2);
    for (    PackageParser.Package p : important) {
      int compilationReason=p.coreApp ? PackageManagerService.REASON_CORE_APP : PackageManagerService.REASON_AB_OTA;
      mDexoptCommands.addAll(generatePackageDexopts(p,compilationReason));
    }
    for (    PackageParser.Package p : others) {
      if (p.coreApp) {
        throw new IllegalStateException("Found a core app that's not important");
      }
      mDexoptCommands.addAll(generatePackageDexopts(p,PackageManagerService.REASON_FIRST_BOOT));
    }
  }
  completeSize=mDexoptCommands.size();
}
