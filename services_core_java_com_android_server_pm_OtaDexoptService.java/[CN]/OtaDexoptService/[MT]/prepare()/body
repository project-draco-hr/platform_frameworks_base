{
  if (mDexoptCommands != null) {
    throw new IllegalStateException("already called prepare()");
  }
  final List<PackageParser.Package> important;
  final List<PackageParser.Package> others;
synchronized (mPackageManagerService.mPackages) {
    important=PackageManagerServiceUtils.getPackagesForDexopt(mPackageManagerService.mPackages.values(),mPackageManagerService);
    others=new ArrayList<>(mPackageManagerService.mPackages.values());
    others.removeAll(important);
    mDexoptCommands=new ArrayList<>(3 * mPackageManagerService.mPackages.size() / 2);
  }
  for (  PackageParser.Package p : important) {
    int compilationReason=p.coreApp ? PackageManagerService.REASON_CORE_APP : PackageManagerService.REASON_AB_OTA;
    mDexoptCommands.addAll(generatePackageDexopts(p,compilationReason));
  }
  for (  PackageParser.Package p : others) {
    if (p.coreApp) {
      throw new IllegalStateException("Found a core app that's not important");
    }
    mDexoptCommands.addAll(generatePackageDexopts(p,PackageManagerService.REASON_FIRST_BOOT));
  }
  completeSize=mDexoptCommands.size();
}
