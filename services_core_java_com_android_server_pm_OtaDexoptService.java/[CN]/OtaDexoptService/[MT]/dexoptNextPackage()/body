{
  if (mDexoptPackages == null) {
    throw new IllegalStateException("dexoptNextPackage() called before prepare()");
  }
  if (mDexoptPackages.isEmpty()) {
    return;
  }
  PackageParser.Package nextPackage=mDexoptPackages.remove(0);
  if (DEBUG_DEXOPT) {
    Log.i(TAG,"Processing " + nextPackage.packageName + " for OTA dexopt.");
  }
  File dataDir=Environment.getDataDirectory();
  @SuppressWarnings("deprecation") long lowThreshold=StorageManager.from(mContext).getStorageLowBytes(dataDir);
  if (lowThreshold == 0) {
    throw new IllegalStateException("Invalid low memory threshold");
  }
  long usableSpace=dataDir.getUsableSpace();
  if (usableSpace < lowThreshold) {
    Log.w(TAG,"Not running dexopt on " + nextPackage.packageName + " due to low memory: "+ usableSpace);
    return;
  }
  PackageDexOptimizer optimizer=new OTADexoptPackageDexOptimizer(mPackageManagerService.mInstaller,mPackageManagerService.mInstallLock,mContext);
  optimizer.performDexOpt(nextPackage,nextPackage.usesLibraryFiles,null,false,getCompilerFilterForReason(PackageManagerService.REASON_AB_OTA),mPackageManagerService.getOrCreateCompilerPackageStats(nextPackage));
}
