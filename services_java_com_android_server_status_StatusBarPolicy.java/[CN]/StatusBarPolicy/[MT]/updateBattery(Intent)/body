{
  mBatteryData.iconId=intent.getIntExtra("icon-small",0);
  mBatteryData.iconLevel=intent.getIntExtra("level",0);
  mService.updateIcon(mBatteryIcon,mBatteryData,null);
  int plugged=intent.getIntExtra("plugged",0);
  int level=intent.getIntExtra("level",-1);
  if (false) {
    Log.d(TAG,"updateBattery level=" + level + " plugged="+ plugged+ " mBatteryPlugged="+ mBatteryPlugged+ " mBatteryLevel="+ mBatteryLevel+ " mBatteryThreshold="+ mBatteryThreshold+ " mBatteryFirst="+ mBatteryFirst);
  }
  int oldPlugged=mBatteryPlugged;
  int oldThreshold=mBatteryThreshold;
  pickNextBatteryLevel(level);
  mBatteryPlugged=plugged;
  mBatteryLevel=level;
  if (mBatteryFirst) {
    mBatteryFirst=false;
  }
  if (false) {
    Log.d(TAG,"plugged=" + plugged + " oldPlugged="+ oldPlugged+ " level="+ level+ " mBatteryThreshold="+ mBatteryThreshold+ " oldThreshold="+ oldThreshold);
  }
  if (plugged == 0 && ((oldPlugged != 0 && level < mBatteryThresholds[BATTERY_THRESHOLD_WARNING]) || (mBatteryThreshold > oldThreshold && mBatteryThreshold > BATTERY_THRESHOLD_WARNING))) {
    mSentLowBatteryBroadcast=true;
    Intent batIntent=new Intent(Intent.ACTION_BATTERY_LOW);
    batIntent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT);
    mContext.sendBroadcast(batIntent);
    if (SHOW_LOW_BATTERY_WARNING) {
      if (false) {
        Log.d(TAG,"mPhoneState=" + mPhoneState + " mLowBatteryDialog="+ mLowBatteryDialog+ " mBatteryShowLowOnEndCall="+ mBatteryShowLowOnEndCall);
      }
      if (mPhoneState == TelephonyManager.CALL_STATE_IDLE) {
        showLowBatteryWarning();
      }
 else {
        mBatteryShowLowOnEndCall=true;
      }
    }
  }
 else   if (mBatteryThreshold < BATTERY_THRESHOLD_WARNING) {
    if (mSentLowBatteryBroadcast == true) {
      mSentLowBatteryBroadcast=false;
      Intent batIntent=new Intent(Intent.ACTION_BATTERY_OKAY);
      batIntent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT);
      mContext.sendBroadcast(batIntent);
    }
    if (SHOW_LOW_BATTERY_WARNING) {
      if (mLowBatteryDialog != null) {
        mLowBatteryDialog.dismiss();
        mBatteryShowLowOnEndCall=false;
      }
    }
  }
}
