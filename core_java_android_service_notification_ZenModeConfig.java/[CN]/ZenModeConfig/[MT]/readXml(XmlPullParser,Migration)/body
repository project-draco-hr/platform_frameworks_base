{
  int type=parser.getEventType();
  if (type != XmlPullParser.START_TAG)   return null;
  String tag=parser.getName();
  if (!ZEN_TAG.equals(tag))   return null;
  final ZenModeConfig rt=new ZenModeConfig();
  final int version=safeInt(parser,ZEN_ATT_VERSION,XML_VERSION);
  if (version == 1) {
    final XmlV1 v1=XmlV1.readXml(parser);
    return migration.migrate(v1);
  }
  rt.user=safeInt(parser,ZEN_ATT_USER,rt.user);
  while ((type=parser.next()) != XmlPullParser.END_DOCUMENT) {
    tag=parser.getName();
    if (type == XmlPullParser.END_TAG && ZEN_TAG.equals(tag)) {
      return rt;
    }
    if (type == XmlPullParser.START_TAG) {
      if (ALLOW_TAG.equals(tag)) {
        rt.allowCalls=safeBoolean(parser,ALLOW_ATT_CALLS,false);
        rt.allowRepeatCallers=safeBoolean(parser,ALLOW_ATT_REPEAT_CALLERS,DEFAULT_ALLOW_REPEAT_CALLERS);
        rt.allowMessages=safeBoolean(parser,ALLOW_ATT_MESSAGES,false);
        rt.allowReminders=safeBoolean(parser,ALLOW_ATT_REMINDERS,DEFAULT_ALLOW_REMINDERS);
        rt.allowEvents=safeBoolean(parser,ALLOW_ATT_EVENTS,DEFAULT_ALLOW_EVENTS);
        final int from=safeInt(parser,ALLOW_ATT_FROM,-1);
        final int callsFrom=safeInt(parser,ALLOW_ATT_CALLS_FROM,-1);
        final int messagesFrom=safeInt(parser,ALLOW_ATT_MESSAGES_FROM,-1);
        if (isValidSource(callsFrom) && isValidSource(messagesFrom)) {
          rt.allowCallsFrom=callsFrom;
          rt.allowMessagesFrom=messagesFrom;
        }
 else         if (isValidSource(from)) {
          Slog.i(TAG,"Migrating existing shared 'from': " + sourceToString(from));
          rt.allowCallsFrom=from;
          rt.allowMessagesFrom=from;
        }
 else {
          rt.allowCallsFrom=DEFAULT_SOURCE;
          rt.allowMessagesFrom=DEFAULT_SOURCE;
        }
      }
 else       if (MANUAL_TAG.equals(tag)) {
        rt.manualRule=readRuleXml(parser);
      }
 else       if (AUTOMATIC_TAG.equals(tag)) {
        final String id=parser.getAttributeValue(null,RULE_ATT_ID);
        final ZenRule automaticRule=readRuleXml(parser);
        if (id != null && automaticRule != null) {
          automaticRule.id=id;
          rt.automaticRules.put(id,automaticRule);
        }
      }
    }
  }
  throw new IllegalStateException("Failed to reach END_DOCUMENT");
}
