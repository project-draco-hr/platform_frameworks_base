{
  if (hasPermission(permission.name,userId)) {
    return PERMISSION_OPERATION_FAILURE;
  }
  final boolean hasGids=permission.hasGids();
  final int[] oldGids=hasGids ? computeGids(userId) : NO_GIDS;
  if (mPermissions == null) {
    mPermissions=new ArrayMap<>();
  }
  PermissionData permissionData=mPermissions.get(permission.name);
  if (permissionData == null) {
    permissionData=new PermissionData(permission);
    mPermissions.put(permission.name,permissionData);
  }
  if (!permissionData.addUserId(userId)) {
    return PERMISSION_OPERATION_FAILURE;
  }
  if (hasGids) {
    final int[] newGids=computeGids(userId);
    if (oldGids.length != newGids.length) {
      return PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;
    }
  }
  return PERMISSION_OPERATION_SUCCESS;
}
