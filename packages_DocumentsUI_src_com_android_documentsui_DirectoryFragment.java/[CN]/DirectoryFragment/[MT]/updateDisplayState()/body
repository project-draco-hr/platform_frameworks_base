{
  final State state=getDisplayState(this);
  mFilter=new MimePredicate(state.acceptMimes);
  if (mLastMode == state.mode)   return;
  mLastMode=state.mode;
  mListView.setVisibility(state.mode == MODE_LIST ? View.VISIBLE : View.GONE);
  mGridView.setVisibility(state.mode == MODE_GRID ? View.VISIBLE : View.GONE);
  final int choiceMode;
  if (state.allowMultiple) {
    choiceMode=ListView.CHOICE_MODE_MULTIPLE_MODAL;
  }
 else {
    choiceMode=ListView.CHOICE_MODE_NONE;
  }
  final int thumbSize;
  if (state.mode == MODE_GRID) {
    thumbSize=getResources().getDimensionPixelSize(R.dimen.grid_width);
    mListView.setAdapter(null);
    mListView.setChoiceMode(ListView.CHOICE_MODE_NONE);
    mGridView.setAdapter(mAdapter);
    mGridView.setColumnWidth(getResources().getDimensionPixelSize(R.dimen.grid_width));
    mGridView.setNumColumns(GridView.AUTO_FIT);
    mGridView.setChoiceMode(choiceMode);
    mCurrentView=mGridView;
  }
 else   if (state.mode == MODE_LIST) {
    thumbSize=getResources().getDimensionPixelSize(R.dimen.icon_size);
    mGridView.setAdapter(null);
    mGridView.setChoiceMode(ListView.CHOICE_MODE_NONE);
    mListView.setAdapter(mAdapter);
    mListView.setChoiceMode(choiceMode);
    mCurrentView=mListView;
  }
 else {
    throw new IllegalStateException("Unknown state " + state.mode);
  }
  mThumbSize=new Point(thumbSize,thumbSize);
}
