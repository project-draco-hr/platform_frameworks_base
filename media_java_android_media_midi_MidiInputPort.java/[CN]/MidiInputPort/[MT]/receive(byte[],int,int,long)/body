{
  assert(offset >= 0 && count >= 0 && offset + count <= msg.length);
synchronized (mBuffer) {
    while (count > 0) {
      int length=MidiPortImpl.packMessage(msg,offset,count,timestamp,mBuffer);
      mOutputStream.write(mBuffer,0,length);
      int sent=MidiPortImpl.getMessageSize(mBuffer,length);
      assert(sent >= 0 && sent <= length);
      offset+=sent;
      count-=sent;
    }
  }
}
