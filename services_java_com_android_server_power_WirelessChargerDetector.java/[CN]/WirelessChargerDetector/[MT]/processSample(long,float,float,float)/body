{
synchronized (mLock) {
    if (!mDetectionInProgress) {
      return;
    }
    mTotalSamples+=1;
    if (mTotalSamples == 1) {
      mFirstSampleTime=timeNanos;
      mFirstSampleX=x;
      mFirstSampleY=y;
      mFirstSampleZ=z;
    }
 else {
      if (hasMoved(mFirstSampleX,mFirstSampleY,mFirstSampleZ,x,y,z)) {
        mMovingSamples+=1;
      }
    }
    if (mAtRest && hasMoved(mRestX,mRestY,mRestZ,x,y,z)) {
      if (DEBUG) {
        Slog.d(TAG,"No longer at rest: " + "mRestX=" + mRestX + ", mRestY="+ mRestY+ ", mRestZ="+ mRestZ+ ", x="+ x+ ", y="+ y+ ", z="+ z);
      }
      clearAtRestLocked();
    }
    if (timeNanos - mFirstSampleTime >= SETTLE_TIME_NANOS && mTotalSamples >= MIN_SAMPLES) {
      mSensorManager.unregisterListener(mListener);
      if (mMustUpdateRestPosition) {
        if (mMovingSamples == 0) {
          mAtRest=true;
          mRestX=x;
          mRestY=y;
          mRestZ=z;
        }
 else {
          clearAtRestLocked();
        }
        mMustUpdateRestPosition=false;
      }
      mDetectionInProgress=false;
      mSuspendBlocker.release();
      if (DEBUG) {
        Slog.d(TAG,"New state: mAtRest=" + mAtRest + ", mRestX="+ mRestX+ ", mRestY="+ mRestY+ ", mRestZ="+ mRestZ+ ", mTotalSamples="+ mTotalSamples+ ", mMovingSamples="+ mMovingSamples);
      }
    }
  }
}
