{
  if (DBG)   Log.d(TAG,"FileSynthesisRequest.done()");
synchronized (mStateLock) {
    if (mDone) {
      if (DBG)       Log.d(TAG,"Duplicate call to done()");
      return TextToSpeech.ERROR;
    }
    if (mStopped) {
      if (DBG)       Log.d(TAG,"Request has been aborted.");
      return TextToSpeech.ERROR;
    }
    if (mFileChannel == null) {
      Log.e(TAG,"File not open");
      return TextToSpeech.ERROR;
    }
    try {
      mFileChannel.position(0);
      int dataLength=(int)(mFileChannel.size() - WAV_HEADER_LENGTH);
      mFileChannel.write(makeWavHeader(mSampleRateInHz,mAudioFormat,mChannelCount,dataLength));
      closeFile();
      mDone=true;
      return TextToSpeech.SUCCESS;
    }
 catch (    IOException ex) {
      Log.e(TAG,"Failed to write to output file descriptor",ex);
      cleanUp();
      return TextToSpeech.ERROR;
    }
  }
}
