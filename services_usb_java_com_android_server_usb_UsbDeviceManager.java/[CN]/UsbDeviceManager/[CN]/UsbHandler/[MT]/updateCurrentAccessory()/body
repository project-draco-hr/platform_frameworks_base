{
  boolean enteringAccessoryMode=mAccessoryModeRequestTime > 0 && SystemClock.elapsedRealtime() < mAccessoryModeRequestTime + ACCESSORY_REQUEST_TIMEOUT;
  if (mConfigured && enteringAccessoryMode) {
    mAccessoryModeRequestTime=0;
    if (mAccessoryStrings != null) {
      mCurrentAccessory=new UsbAccessory(mAccessoryStrings);
      Slog.d(TAG,"entering USB accessory mode: " + mCurrentAccessory);
      if (mBootCompleted) {
        getCurrentSettings().accessoryAttached(mCurrentAccessory);
      }
    }
 else {
      Slog.e(TAG,"nativeGetAccessoryStrings failed");
    }
  }
 else   if (!enteringAccessoryMode) {
    Slog.d(TAG,"exited USB accessory mode");
    setEnabledFunctions(mDefaultFunctions,false);
    if (mCurrentAccessory != null) {
      if (mBootCompleted) {
        getCurrentSettings().accessoryDetached(mCurrentAccessory);
      }
      mCurrentAccessory=null;
      mAccessoryStrings=null;
    }
  }
}
