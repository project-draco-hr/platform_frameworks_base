{
  boolean oldStatus=getMediaState();
  StorageManager sm=(StorageManager)mContext.getSystemService(Context.STORAGE_SERVICE);
  MultipleStorageLis observer=new MultipleStorageLis();
  try {
    if (!getMediaState()) {
      mountMedia();
    }
    String path=Environment.getExternalStorageDirectory().toString();
    sm.registerListener(observer);
synchronized (observer) {
      for (int i=0; i < 5; i++) {
        getMs().unmountVolume(path,false);
      }
      long waitTime=0;
      while ((!observer.isDone()) && (waitTime < MAX_WAIT_TIME)) {
        observer.wait(WAIT_TIME_INCR);
        waitTime+=WAIT_TIME_INCR;
      }
      if (!observer.isDone()) {
        failStr("Timed out waiting for packageInstalled callback");
      }
    }
    assertEquals(observer.count,1);
  }
 catch (  Exception e) {
    failStr(e);
  }
 finally {
    sm.unregisterListener(observer);
    boolean currStatus=getMediaState();
    if (oldStatus != currStatus) {
      if (oldStatus) {
        mountMedia();
      }
 else {
        unmountMedia();
      }
    }
  }
}
