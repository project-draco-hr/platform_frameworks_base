{
  FileOutputStream fos=null;
  try {
    fos=mMetadataFile.startWrite();
    XmlSerializer out=new FastXmlSerializer();
    out.setOutput(fos,"utf-8");
    out.startDocument(null,true);
    out.startTag(null,TAG_VOLUMES);
    writeIntAttribute(out,ATTR_VERSION,VERSION_ADD_PRIMARY);
    writeStringAttribute(out,ATTR_PRIMARY_STORAGE_UUID,mPrimaryStorageUuid);
    final int size=mMetadata.size();
    for (int i=0; i < size; i++) {
      final VolumeMetadata meta=mMetadata.valueAt(i);
      VolumeMetadata.write(out,meta);
    }
    out.endTag(null,TAG_VOLUMES);
    out.endDocument();
    mMetadataFile.finishWrite(fos);
  }
 catch (  IOException e) {
    if (fos != null) {
      mMetadataFile.failWrite(fos);
    }
  }
}
