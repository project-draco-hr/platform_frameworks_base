{
  final String path=volume.getPath();
  final String oldState;
synchronized (mVolumesLock) {
    oldState=mVolumeStates.put(path,state);
    volume.setState(state);
  }
  if (state.equals(oldState)) {
    Slog.w(TAG,String.format("Duplicate state transition (%s -> %s) for %s",state,state,path));
    return;
  }
  Slog.d(TAG,"volume state changed for " + path + " ("+ oldState+ " -> "+ state+ ")");
  if (volume.isPrimary() && !volume.isEmulated()) {
    if (Environment.MEDIA_UNMOUNTED.equals(state)) {
      mPms.updateExternalMediaStatus(false,false);
      mObbActionHandler.sendMessage(mObbActionHandler.obtainMessage(OBB_FLUSH_MOUNT_STATE,path));
    }
 else     if (Environment.MEDIA_MOUNTED.equals(state)) {
      mPms.updateExternalMediaStatus(true,false);
    }
  }
synchronized (mListeners) {
    for (int i=mListeners.size() - 1; i >= 0; i--) {
      MountServiceBinderListener bl=mListeners.get(i);
      try {
        bl.mListener.onStorageStateChanged(path,oldState,state);
      }
 catch (      RemoteException rex) {
        Slog.e(TAG,"Listener dead");
        mListeners.remove(i);
      }
catch (      Exception ex) {
        Slog.e(TAG,"Listener failed",ex);
      }
    }
  }
}
