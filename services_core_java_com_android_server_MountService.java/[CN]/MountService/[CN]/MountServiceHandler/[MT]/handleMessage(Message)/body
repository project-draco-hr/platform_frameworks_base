{
switch (msg.what) {
case H_SYSTEM_READY:
{
      handleSystemReady();
      break;
    }
case H_DAEMON_CONNECTED:
{
    handleDaemonConnected();
    break;
  }
case H_FSTRIM:
{
  waitForReady();
  Slog.i(TAG,"Running fstrim idle maintenance");
  try {
    mLastMaintenance=System.currentTimeMillis();
    mLastMaintenanceFile.setLastModified(mLastMaintenance);
  }
 catch (  Exception e) {
    Slog.e(TAG,"Unable to record last fstrim!");
  }
  try {
    mConnector.execute("fstrim","dotrim");
    EventLogTags.writeFstrimStart(SystemClock.elapsedRealtime());
  }
 catch (  NativeDaemonConnectorException ndce) {
    Slog.e(TAG,"Failed to run fstrim!");
  }
  Runnable callback=(Runnable)msg.obj;
  if (callback != null) {
    callback.run();
  }
  break;
}
case H_SHUTDOWN:
{
final IMountShutdownObserver obs=(IMountShutdownObserver)msg.obj;
boolean success=false;
try {
  success=mConnector.execute("volume","shutdown").isClassOk();
}
 catch (NativeDaemonConnectorException ignored) {
}
if (obs != null) {
  try {
    obs.onShutDownComplete(success ? 0 : -1);
  }
 catch (  RemoteException ignored) {
  }
}
break;
}
case H_VOLUME_MOUNT:
{
final Volume vol=(Volume)msg.obj;
try {
vol.mount();
}
 catch (NativeDaemonConnectorException ignored) {
}
break;
}
case H_VOLUME_BROADCAST:
{
final StorageVolume userVol=(StorageVolume)msg.obj;
final String state=userVol.getState();
Slog.d(TAG,"Volume " + userVol.getId() + " broadcasting "+ state+ " to "+ userVol.getOwner());
final String action=sEnvironmentToBroadcast.get(state);
if (action != null) {
final Intent intent=new Intent(action,Uri.fromFile(userVol.getPathFile()));
intent.putExtra(StorageVolume.EXTRA_STORAGE_VOLUME,userVol);
intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT);
mContext.sendBroadcastAsUser(intent,userVol.getOwner());
}
break;
}
}
}
