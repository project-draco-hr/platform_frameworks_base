{
  if (DBG)   log("setupData: apnContext=" + apnContext);
  ApnSetting apn;
  GsmDataConnection dc;
  int profileId=getApnProfileID(apnContext.getApnType());
  apn=apnContext.getNextWaitingApn();
  if (apn == null) {
    if (DBG)     log("setupData: return for no apn found!");
    return false;
  }
  dc=findReadyDataConnection(apn);
  if (dc == null) {
    if (DBG)     log("setupData: No ready GsmDataConnection found!");
    dc=findFreeDataConnection();
  }
  if (dc == null) {
    dc=createDataConnection();
  }
  if (dc == null) {
    if (DBG)     log("setupData: No free GsmDataConnection found!");
    return false;
  }
  dc.setProfileId(profileId);
  dc.setActiveApnType(apnContext.getApnType());
  int refCount=dc.incAndGetRefCount();
  if (DBG)   log("setupData: init dc and apnContext refCount=" + refCount);
  if (refCount == 1) {
    configureRetry(dc,apnContext.getApnType());
  }
  DataConnectionAc dcac=mDataConnectionAsyncChannels.get(dc.getDataConnectionId());
  apnContext.setDataConnectionAc(mDataConnectionAsyncChannels.get(dc.getDataConnectionId()));
  apnContext.setApnSetting(apn);
  apnContext.setDataConnection(dc);
  Message msg=obtainMessage();
  msg.what=EVENT_DATA_SETUP_COMPLETE;
  msg.obj=apnContext;
  dc.bringUp(msg,apn);
  apnContext.setState(State.INITING);
  mPhone.notifyDataConnection(apnContext.getReason(),apnContext.getApnType());
  if (DBG)   log("setupData: initing!");
  return true;
}
