{
  if (apnContext == null) {
    if (DBG)     log("cleanUpConnection: apn context is null");
    return;
  }
  DataConnectionAc dcac=apnContext.getDataConnectionAc();
  if (DBG) {
    log("cleanUpConnection: E tearDown=" + tearDown + " reason="+ apnContext.getReason()+ " apnContext="+ apnContext);
  }
  if (tearDown) {
    if (apnContext.isDisconnected()) {
      apnContext.setState(State.IDLE);
      if (!apnContext.isReady()) {
        apnContext.setDataConnection(null);
        apnContext.setDataConnectionAc(null);
      }
    }
 else {
      if (dcac != null) {
        if (apnContext.getState() != State.DISCONNECTING) {
          boolean disconnectAll=false;
          if (Phone.APN_TYPE_DUN.equals(apnContext.getApnType())) {
            ApnSetting dunSetting=fetchDunApn();
            if (dunSetting != null && dunSetting.equals(apnContext.getApnSetting())) {
              if (DBG)               log("tearing down dedicated DUN connection");
              disconnectAll=true;
            }
          }
          if (DBG) {
            log("cleanUpConnection: tearing down" + (disconnectAll ? " all" : ""));
          }
          Message msg=obtainMessage(EVENT_DISCONNECT_DONE,apnContext);
          if (disconnectAll) {
            apnContext.getDataConnection().tearDownAll(apnContext.getReason(),msg);
          }
 else {
            apnContext.getDataConnection().tearDown(apnContext.getReason(),msg);
          }
          apnContext.setState(State.DISCONNECTING);
        }
      }
 else {
        apnContext.setState(State.IDLE);
        mPhone.notifyDataConnection(apnContext.getReason(),apnContext.getApnType());
      }
    }
  }
 else {
    if (dcac != null)     dcac.resetSync();
    apnContext.setState(State.IDLE);
    mPhone.notifyDataConnection(apnContext.getReason(),apnContext.getApnType());
    apnContext.setDataConnection(null);
    apnContext.setDataConnectionAc(null);
  }
  if (dcac != null) {
    Collection<ApnContext> apnList=dcac.getApnListSync();
    if (apnList.isEmpty()) {
      cancelReconnectAlarm(dcac);
    }
  }
  if (DBG) {
    log("cleanUpConnection: X tearDown=" + tearDown + " reason="+ apnContext.getReason()+ " apnContext="+ apnContext+ " dc="+ apnContext.getDataConnection());
  }
}
