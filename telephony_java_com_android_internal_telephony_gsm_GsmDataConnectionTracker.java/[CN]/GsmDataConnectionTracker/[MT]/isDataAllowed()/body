{
  final boolean internalDataEnabled;
synchronized (mDataEnabledLock) {
    internalDataEnabled=mInternalDataEnabled;
  }
  int gprsState=mPhone.getServiceStateTracker().getCurrentDataConnectionState();
  boolean desiredPowerState=mPhone.getServiceStateTracker().getDesiredPowerState();
  boolean allowed=(gprsState == ServiceState.STATE_IN_SERVICE || mAutoAttachOnCreation) && mPhone.mIccRecords.getRecordsLoaded() && (mPhone.getState() == Phone.State.IDLE || mPhone.getServiceStateTracker().isConcurrentVoiceAndDataAllowed())&& internalDataEnabled&& (!mPhone.getServiceState().getRoaming() || getDataOnRoamingEnabled())&& !mIsPsRestricted&& desiredPowerState;
  if (!allowed && DBG) {
    String reason="";
    if (!((gprsState == ServiceState.STATE_IN_SERVICE) || mAutoAttachOnCreation)) {
      reason+=" - gprs= " + gprsState;
    }
    if (!mPhone.mIccRecords.getRecordsLoaded())     reason+=" - SIM not loaded";
    if (mPhone.getState() != Phone.State.IDLE && !mPhone.getServiceStateTracker().isConcurrentVoiceAndDataAllowed()) {
      reason+=" - PhoneState= " + mPhone.getState();
      reason+=" - Concurrent voice and data not allowed";
    }
    if (!internalDataEnabled)     reason+=" - mInternalDataEnabled= false";
    if (mPhone.getServiceState().getRoaming() && !getDataOnRoamingEnabled()) {
      reason+=" - Roaming and data roaming not enabled";
    }
    if (mIsPsRestricted)     reason+=" - mIsPsRestricted= true";
    if (!desiredPowerState)     reason+=" - desiredPowerState= false";
    if (DBG)     log("isDataAllowed: not allowed due to" + reason);
  }
  return allowed;
}
