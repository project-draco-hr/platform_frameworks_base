{
  if (isPlaybackActive(false)) {
    flags&=~AudioManager.FLAG_PLAY_SOUND;
  }
  if (direction > 1) {
    direction=1;
  }
 else   if (direction < -1) {
    direction=-1;
  }
  if (mVolumeType == MediaSession.PLAYBACK_TYPE_LOCAL) {
    int stream=AudioAttributes.toLegacyStreamType(mAudioAttrs);
    mAudioManager.adjustStreamVolume(stream,direction,flags);
  }
 else {
    if (mVolumeControlType == VolumeProvider.VOLUME_CONTROL_FIXED) {
      return;
    }
    mSessionCb.adjustVolume(direction);
    int volumeBefore=(mOptimisticVolume < 0 ? mCurrentVolume : mOptimisticVolume);
    mOptimisticVolume=volumeBefore + direction;
    mOptimisticVolume=Math.max(0,Math.min(mOptimisticVolume,mMaxVolume));
    mHandler.removeCallbacks(mClearOptimisticVolumeRunnable);
    mHandler.postDelayed(mClearOptimisticVolumeRunnable,OPTIMISTIC_VOLUME_TIMEOUT);
    if (volumeBefore != mOptimisticVolume) {
      pushVolumeUpdate();
    }
    if (DEBUG) {
      Log.d(TAG,"Adjusted optimistic volume to " + mOptimisticVolume + " max is "+ mMaxVolume);
    }
  }
}
