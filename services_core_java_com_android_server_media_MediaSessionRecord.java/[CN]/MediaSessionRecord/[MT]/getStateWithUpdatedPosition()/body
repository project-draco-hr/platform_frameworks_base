{
  PlaybackState state=mPlaybackState;
  long duration=-1;
  if (mMetadata != null && mMetadata.containsKey(MediaMetadata.METADATA_KEY_DURATION)) {
    duration=mMetadata.getLong(MediaMetadata.METADATA_KEY_DURATION);
  }
  PlaybackState result=null;
  if (state != null) {
    if (state.getState() == PlaybackState.STATE_PLAYING || state.getState() == PlaybackState.STATE_FAST_FORWARDING || state.getState() == PlaybackState.STATE_REWINDING) {
      long updateTime=state.getLastPositionUpdateTime();
      if (updateTime > 0) {
        long position=(long)(state.getPlaybackRate() * (SystemClock.elapsedRealtime() - updateTime)) + state.getPosition();
        if (duration >= 0 && position > duration) {
          position=duration;
        }
 else         if (position < 0) {
          position=0;
        }
        result=new PlaybackState(state);
        result.setState(state.getState(),position,state.getPlaybackRate());
      }
    }
  }
  return result == null ? state : result;
}
