{
  ArrayMap<String,PackageSetting> packages=settings.mPackages;
  KeySetManagerService ksms=settings.mKeySetManagerService;
  assertEquals(2,KeySetUtils.getKeySetRefCount(ksms,1));
  assertEquals(1,KeySetUtils.getKeySetRefCount(ksms,2));
  assertEquals(1,KeySetUtils.getKeySetRefCount(ksms,3));
  assertEquals(1,KeySetUtils.getKeySetRefCount(ksms,4));
  assertEquals(2,KeySetUtils.getPubKeyRefCount(ksms,1));
  assertEquals(2,KeySetUtils.getPubKeyRefCount(ksms,2));
  assertEquals(1,KeySetUtils.getPubKeyRefCount(ksms,3));
  PublicKey keyA=PackageParser.parsePublicKey(KeySetStrings.ctsKeySetPublicKeyA);
  PublicKey keyB=PackageParser.parsePublicKey(KeySetStrings.ctsKeySetPublicKeyB);
  PublicKey keyC=PackageParser.parsePublicKey(KeySetStrings.ctsKeySetPublicKeyC);
  assertEquals(keyA,KeySetUtils.getPubKey(ksms,1));
  assertEquals(keyB,KeySetUtils.getPubKey(ksms,2));
  assertEquals(keyC,KeySetUtils.getPubKey(ksms,3));
  LongSparseArray<ArraySet<Long>> ksMapping=KeySetUtils.getKeySetMapping(ksms);
  ArraySet<Long> mapping=ksMapping.get(1);
  assertEquals(1,mapping.size());
  assertTrue(mapping.contains(new Long(1)));
  mapping=ksMapping.get(2);
  assertEquals(1,mapping.size());
  assertTrue(mapping.contains(new Long(2)));
  mapping=ksMapping.get(3);
  assertEquals(1,mapping.size());
  assertTrue(mapping.contains(new Long(3)));
  mapping=ksMapping.get(4);
  assertEquals(2,mapping.size());
  assertTrue(mapping.contains(new Long(1)));
  assertTrue(mapping.contains(new Long(2)));
  assertEquals(new Long(3),KeySetUtils.getLastIssuedKeyId(ksms));
  assertEquals(new Long(4),KeySetUtils.getLastIssuedKeySetId(ksms));
  PackageSetting ps=packages.get("com.google.app1");
  assertEquals(1,ps.keySetData.getProperSigningKeySet());
  ps=packages.get("com.google.app2");
  assertEquals(1,ps.keySetData.getProperSigningKeySet());
  assertEquals(new Long(4),ps.keySetData.getAliases().get("AB"));
  ps=packages.get("com.android.app3");
  assertEquals(2,ps.keySetData.getProperSigningKeySet());
  assertEquals(new Long(3),ps.keySetData.getAliases().get("C"));
  assertEquals(1,ps.keySetData.getUpgradeKeySets().length);
  assertEquals(3,ps.keySetData.getUpgradeKeySets()[0]);
}
