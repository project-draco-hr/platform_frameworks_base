{
  if (mIdleMaintenanceStarted) {
    final boolean batteryOk=batteryLevelAndMaintenanceTimeoutPermitsIdleMaintenanceRunning();
    if (!lastUserActivityPermitsIdleMaintenanceRunning() || !batteryOk) {
      unscheduleUpdateIdleMaintenanceState();
      mIdleMaintenanceStarted=false;
      if (!batteryOk) {
        scheduleUpdateIdleMaintenanceState(getNextIdleMaintenanceIntervalStartFromNow());
      }
      EventLogTags.writeIdleMaintenanceWindowFinish(SystemClock.elapsedRealtime(),mLastUserActivityElapsedTimeMillis,mBatteryService.getBatteryLevel(),isBatteryCharging() ? 1 : 0);
      scheduleIdleFinishTm();
    }
  }
 else   if (deviceStatePermitsIdleMaintenanceStart(noisy) && lastUserActivityPermitsIdleMaintenanceStart(noisy) && lastRunPermitsIdleMaintenanceStart(noisy)) {
    scheduleUpdateIdleMaintenanceState(MAX_IDLE_MAINTENANCE_DURATION);
    mIdleMaintenanceStarted=true;
    EventLogTags.writeIdleMaintenanceWindowStart(SystemClock.elapsedRealtime(),mLastUserActivityElapsedTimeMillis,mBatteryService.getBatteryLevel(),isBatteryCharging() ? 1 : 0);
    mLastIdleMaintenanceStartTimeMillis=SystemClock.elapsedRealtime();
    startIdleMaintenanceTm();
  }
 else   if (lastUserActivityPermitsIdleMaintenanceStart(noisy)) {
    if (lastRunPermitsIdleMaintenanceStart(noisy)) {
      scheduleUpdateIdleMaintenanceState(MIN_USER_INACTIVITY_IDLE_MAINTENANCE_START);
    }
 else {
      scheduleUpdateIdleMaintenanceState(getNextIdleMaintenanceIntervalStartFromNow());
    }
  }
}
