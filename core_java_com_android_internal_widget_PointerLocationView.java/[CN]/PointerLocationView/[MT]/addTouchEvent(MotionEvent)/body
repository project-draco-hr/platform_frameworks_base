{
synchronized (mPointers) {
    int action=event.getAction();
    int NP=mPointers.size();
    if (action == MotionEvent.ACTION_DOWN || (action & MotionEvent.ACTION_MASK) == MotionEvent.ACTION_POINTER_DOWN) {
      final int index=(action & MotionEvent.ACTION_POINTER_INDEX_MASK) >> MotionEvent.ACTION_POINTER_INDEX_SHIFT;
      if (action == MotionEvent.ACTION_DOWN) {
        for (int p=0; p < NP; p++) {
          final PointerState ps=mPointers.get(p);
          ps.clearTrace();
          ps.mCurDown=false;
        }
        mCurDown=true;
        mMaxNumPointers=0;
        mVelocity.clear();
      }
      final int id=event.getPointerId(index);
      while (NP <= id) {
        PointerState ps=new PointerState();
        mPointers.add(ps);
        NP++;
      }
      if (mActivePointerId < 0 || !mPointers.get(mActivePointerId).mCurDown) {
        mActivePointerId=id;
      }
      final PointerState ps=mPointers.get(id);
      ps.mCurDown=true;
      if (mPrintCoords) {
        Log.i(TAG,mText.clear().append("Pointer ").append(id + 1).append(": DOWN").toString());
      }
    }
    final int NI=event.getPointerCount();
    final boolean hover=(action == MotionEvent.ACTION_HOVER_MOVE);
    mCurDown=action != MotionEvent.ACTION_UP && action != MotionEvent.ACTION_CANCEL && !hover;
    mCurNumPointers=mCurDown ? NI : 0;
    if (mMaxNumPointers < mCurNumPointers) {
      mMaxNumPointers=mCurNumPointers;
    }
    mVelocity.addMovement(event);
    mVelocity.computeCurrentVelocity(1);
    for (int i=0; i < NI; i++) {
      final int id=event.getPointerId(i);
      final PointerState ps=hover ? null : mPointers.get(id);
      final PointerCoords coords=ps != null ? ps.mCoords : mHoverCoords;
      final int N=event.getHistorySize();
      for (int j=0; j < N; j++) {
        event.getHistoricalPointerCoords(i,j,coords);
        if (mPrintCoords) {
          logPointerCoords(coords,id);
        }
        if (ps != null) {
          ps.addTrace(event.getHistoricalX(i,j),event.getHistoricalY(i,j));
        }
      }
      event.getPointerCoords(i,coords);
      if (mPrintCoords) {
        logPointerCoords(coords,id);
      }
      if (ps != null) {
        ps.addTrace(coords.x,coords.y);
        ps.mXVelocity=mVelocity.getXVelocity(id);
        ps.mYVelocity=mVelocity.getYVelocity(id);
      }
    }
    if (action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_CANCEL || (action & MotionEvent.ACTION_MASK) == MotionEvent.ACTION_POINTER_UP) {
      final int index=(action & MotionEvent.ACTION_POINTER_INDEX_MASK) >> MotionEvent.ACTION_POINTER_INDEX_SHIFT;
      final int id=event.getPointerId(index);
      final PointerState ps=mPointers.get(id);
      ps.mCurDown=false;
      if (mPrintCoords) {
        Log.i(TAG,mText.clear().append("Pointer ").append(id + 1).append(": UP").toString());
      }
      if (action == MotionEvent.ACTION_UP || action == MotionEvent.ACTION_CANCEL) {
        mCurDown=false;
      }
 else {
        if (mActivePointerId == id) {
          mActivePointerId=event.getPointerId(index == 0 ? 1 : 0);
        }
        ps.addTrace(Float.NaN,Float.NaN);
      }
    }
    postInvalidate();
  }
}
