{
  FileOutputStream outstream=new FileOutputStream(stateFile.getFileDescriptor());
  BufferedOutputStream outbuf=new BufferedOutputStream(outstream);
  DataOutputStream out=new DataOutputStream(outbuf);
  try {
    out.writeUTF(STATE_FILE_HEADER);
    out.writeInt(STATE_FILE_VERSION);
    if (preferredHome != null) {
      out.writeUTF(DEFAULT_HOME_KEY);
      out.writeUTF(preferredHome.flattenToString());
      out.writeLong(homeVersion);
      writeSignatureHashArray(out,homeSigHashes);
    }
    out.writeUTF(GLOBAL_METADATA_KEY);
    out.writeInt(Build.VERSION.SDK_INT);
    out.writeUTF(Build.VERSION.INCREMENTAL);
    for (    PackageInfo pkg : pkgs) {
      out.writeUTF(pkg.packageName);
      out.writeInt(pkg.versionCode);
    }
    out.flush();
  }
 catch (  IOException e) {
    Slog.e(TAG,"Unable to write package manager state file!");
  }
}
