{
  if (WindowManagerService.DEBUG_DRAG) {
    Slog.d(WindowManagerService.TAG,"perform drag: win=" + window + " data="+ data);
  }
synchronized (mService.mWindowMap) {
    if (mService.mDragState == null) {
      Slog.w(WindowManagerService.TAG,"No drag prepared");
      throw new IllegalStateException("performDrag() without prepareDrag()");
    }
    if (dragToken != mService.mDragState.mToken) {
      Slog.w(WindowManagerService.TAG,"Performing mismatched drag");
      throw new IllegalStateException("performDrag() does not match prepareDrag()");
    }
    WindowState callingWin=mService.windowForClientLocked(null,window,false);
    if (callingWin == null) {
      Slog.w(WindowManagerService.TAG,"Bad requesting window " + window);
      return false;
    }
    mService.mH.removeMessages(H.DRAG_START_TIMEOUT,window.asBinder());
    Display display=callingWin.mDisplayContent.getDisplay();
    mService.mDragState.register(display);
    mService.mInputMonitor.updateInputWindowsLw(true);
    if (!mService.mInputManager.transferTouchFocus(callingWin.mInputChannel,mService.mDragState.mServerChannel)) {
      Slog.e(WindowManagerService.TAG,"Unable to transfer touch focus");
      mService.mDragState.unregister();
      mService.mDragState=null;
      mService.mInputMonitor.updateInputWindowsLw(true);
      return false;
    }
    mService.mDragState.mData=data;
    mService.mDragState.mCurrentX=touchX;
    mService.mDragState.mCurrentY=touchY;
    mService.mDragState.broadcastDragStartedLw(touchX,touchY);
    mService.mDragState.mThumbOffsetX=thumbCenterX;
    mService.mDragState.mThumbOffsetY=thumbCenterY;
    final Surface surface=mService.mDragState.mSurface;
    if (WindowManagerService.SHOW_LIGHT_TRANSACTIONS)     Slog.i(WindowManagerService.TAG,">>> OPEN TRANSACTION performDrag");
    Surface.openTransaction();
    try {
      surface.setPosition(touchX - thumbCenterX,touchY - thumbCenterY);
      surface.setAlpha(.7071f);
      surface.setLayer(mService.mDragState.getDragLayerLw());
      surface.setLayerStack(display.getLayerStack());
      surface.show();
    }
  finally {
      Surface.closeTransaction();
      if (WindowManagerService.SHOW_LIGHT_TRANSACTIONS)       Slog.i(WindowManagerService.TAG,"<<< CLOSE TRANSACTION performDrag");
    }
  }
  return true;
}
