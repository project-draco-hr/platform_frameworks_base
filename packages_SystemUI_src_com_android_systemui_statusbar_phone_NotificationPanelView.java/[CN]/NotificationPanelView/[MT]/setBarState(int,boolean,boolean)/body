{
  int oldState=mStatusBarState;
  boolean keyguardShowing=statusBarState == StatusBarState.KEYGUARD;
  setKeyguardStatusViewVisibility(statusBarState,keyguardFadingAway,goingToFullShade);
  setKeyguardBottomAreaVisibility(statusBarState,goingToFullShade);
  mStatusBarState=statusBarState;
  mKeyguardShowing=keyguardShowing;
  mQsContainer.setKeyguardShowing(mKeyguardShowing);
  if (goingToFullShade || (oldState == StatusBarState.KEYGUARD && statusBarState == StatusBarState.SHADE_LOCKED)) {
    animateKeyguardStatusBarOut();
    long delay=mStatusBarState == StatusBarState.SHADE_LOCKED ? 0 : mStatusBar.calculateGoingToFullShadeDelay();
    mQsContainer.animateHeaderSlidingIn(delay);
  }
 else   if (oldState == StatusBarState.SHADE_LOCKED && statusBarState == StatusBarState.KEYGUARD) {
    animateKeyguardStatusBarIn(StackStateAnimator.ANIMATION_DURATION_STANDARD);
    mQsContainer.animateHeaderSlidingOut();
  }
 else {
    mKeyguardStatusBar.setAlpha(1f);
    mKeyguardStatusBar.setVisibility(keyguardShowing ? View.VISIBLE : View.INVISIBLE);
    if (keyguardShowing && oldState != mStatusBarState) {
      mKeyguardBottomArea.updateLeftAffordance();
      mAfforanceHelper.updatePreviews();
    }
  }
  if (keyguardShowing) {
    updateDozingVisibilities(false);
  }
  resetVerticalPanelPosition();
  updateQsState();
}
