{
  verifyIncomingUid(uid);
  verifyIncomingOp(code);
  String resolvedPackageName=resolvePackageName(uid,packageName);
  if (resolvedPackageName == null) {
    return AppOpsManager.MODE_IGNORED;
  }
synchronized (this) {
    if (isOpRestricted(uid,code,resolvedPackageName)) {
      return AppOpsManager.MODE_IGNORED;
    }
    code=AppOpsManager.opToSwitch(code);
    UidState uidState=getUidStateLocked(uid,false);
    if (uidState != null && uidState.opModes != null) {
      final int uidMode=uidState.opModes.get(code);
      if (uidMode != AppOpsManager.MODE_ALLOWED) {
        return uidMode;
      }
    }
    Op op=getOpLocked(code,uid,resolvedPackageName,false);
    if (op == null) {
      return AppOpsManager.opToDefaultMode(code);
    }
    return op.mode;
  }
}
