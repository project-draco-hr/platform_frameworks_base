{
  verifyIncomingUid(uid);
  verifyIncomingOp(code);
  String resolvedPackageName=resolvePackageName(uid,packageName);
  if (resolvedPackageName == null) {
    return AppOpsManager.MODE_IGNORED;
  }
  ClientState client=(ClientState)token;
synchronized (this) {
    Ops ops=getOpsRawLocked(uid,resolvedPackageName,true);
    if (ops == null) {
      if (DEBUG)       Log.d(TAG,"startOperation: no op for code " + code + " uid "+ uid+ " package "+ resolvedPackageName);
      return AppOpsManager.MODE_ERRORED;
    }
    Op op=getOpLocked(ops,code,true);
    if (isOpRestricted(uid,code,resolvedPackageName)) {
      return AppOpsManager.MODE_IGNORED;
    }
    final int switchCode=AppOpsManager.opToSwitch(code);
    UidState uidState=ops.uidState;
    if (uidState.opModes != null) {
      final int uidMode=uidState.opModes.get(switchCode);
      if (uidMode != AppOpsManager.MODE_ALLOWED) {
        if (DEBUG)         Log.d(TAG,"noteOperation: reject #" + op.mode + " for code "+ switchCode+ " ("+ code+ ") uid "+ uid+ " package "+ resolvedPackageName);
        op.rejectTime=System.currentTimeMillis();
        return uidMode;
      }
    }
    final Op switchOp=switchCode != code ? getOpLocked(ops,switchCode,true) : op;
    if (switchOp.mode != AppOpsManager.MODE_ALLOWED) {
      if (DEBUG)       Log.d(TAG,"startOperation: reject #" + op.mode + " for code "+ switchCode+ " ("+ code+ ") uid "+ uid+ " package "+ resolvedPackageName);
      op.rejectTime=System.currentTimeMillis();
      return switchOp.mode;
    }
    if (DEBUG)     Log.d(TAG,"startOperation: allowing code " + code + " uid "+ uid+ " package "+ resolvedPackageName);
    if (op.nesting == 0) {
      op.time=System.currentTimeMillis();
      op.rejectTime=0;
      op.duration=-1;
    }
    op.nesting++;
    if (client.mStartedOps != null) {
      client.mStartedOps.add(op);
    }
    return AppOpsManager.MODE_ALLOWED;
  }
}
