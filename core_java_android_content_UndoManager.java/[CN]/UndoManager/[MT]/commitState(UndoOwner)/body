{
  if (mWorking != null && mWorking.hasData()) {
    if (owner == null || mWorking.hasOperation(owner)) {
      mWorking.setCanMerge(false);
      int commitId=mWorking.getCommitId();
      pushWorkingState();
      createWorkingState();
      mMerged=true;
      return commitId;
    }
  }
 else {
    UndoState state=getTopUndo(null);
    if (state != null && (owner == null || state.hasOperation(owner))) {
      state.setCanMerge(false);
      return state.getCommitId();
    }
  }
  return -1;
}
