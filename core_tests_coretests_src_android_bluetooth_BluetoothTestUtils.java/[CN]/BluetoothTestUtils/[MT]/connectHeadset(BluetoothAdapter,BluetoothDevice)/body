{
  int mask=PROFILE_HEADSET_FLAG;
  int headsetMask=HEADSET_STATE_CONNECTING | HEADSET_STATE_CONNECTED;
  mReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("connectHeadset() bluetooth not enabled");
  }
  if (!adapter.getBondedDevices().contains(device)) {
    fail("connectHeadset() device not paired: device=" + device);
  }
  while (!mHeadsetServiceListener.isConnected()) {
    sleep(POLL_TIME);
  }
  int state=mHeadset.getState(device);
switch (state) {
case BluetoothHeadset.STATE_CONNECTED:
    assertTrue(mHeadset.isConnected(device));
  return;
case BluetoothHeadset.STATE_DISCONNECTED:
assertFalse(mHeadset.isConnected(device));
mHeadset.connectHeadset(device);
break;
case BluetoothHeadset.STATE_CONNECTING:
assertFalse(mHeadset.isConnected(device));
mask=headsetMask=0;
break;
case BluetoothHeadset.STATE_ERROR:
fail("connectHeadset() error state");
break;
default :
fail("connectHeadset() invalid state: state=" + state);
}
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < CONNECT_HEADSET_TIMEOUT) {
state=mHeadset.getState(device);
if (state == BluetoothHeadset.STATE_CONNECTED) {
assertTrue(mHeadset.isConnected(device));
if ((mReceiver.getFiredFlags() & mask) == mask && (mReceiver.getHeadsetFiredFlags() & headsetMask) == headsetMask) {
mReceiver.resetFiredFlags();
writeOutput(String.format("connectHeadset() completed in %d ms: device=%s",(System.currentTimeMillis() - s),device));
return;
}
}
sleep(POLL_TIME);
}
int firedFlags=mReceiver.getFiredFlags();
int headsetFiredFlags=mReceiver.getHeadsetFiredFlags();
mReceiver.resetFiredFlags();
fail(String.format("connectHeadset() timeout: state=%d (expected %d), " + "flags=0x%x (expected 0x%x), headsetFlags=0x%s (expected 0x%x)",state,BluetoothHeadset.STATE_CONNECTED,firedFlags,mask,headsetFiredFlags,headsetMask));
}
