{
  int mask=BluetoothReceiver.DISCOVERY_FINISHED_FLAG;
  mBluetoothReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("stopScan() bluetooth not enabled");
  }
  if (!adapter.isDiscovering()) {
    return;
  }
  assertTrue(adapter.cancelDiscovery());
  long s=System.currentTimeMillis();
  while (System.currentTimeMillis() - s < CANCEL_DISCOVERY_TIMEOUT) {
    if (!adapter.isDiscovering() && ((mBluetoothReceiver.getFiredFlags() & mask) == mask)) {
      mBluetoothReceiver.resetFiredFlags();
      writeOutput(String.format("stopScan() completed in %d ms",(System.currentTimeMillis() - s)));
      return;
    }
    sleep(POLL_TIME);
  }
  int firedFlags=mBluetoothReceiver.getFiredFlags();
  mBluetoothReceiver.resetFiredFlags();
  fail(String.format("stopScan() timeout: isDiscovering=%b, flags=0x%x (expected 0x%x)",adapter.isDiscovering(),firedFlags,mask));
}
