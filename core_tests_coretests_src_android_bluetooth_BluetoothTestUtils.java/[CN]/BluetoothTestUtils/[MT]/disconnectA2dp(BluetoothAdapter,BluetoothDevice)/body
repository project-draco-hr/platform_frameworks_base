{
  int mask=BluetoothReceiver.PROFILE_A2DP_FLAG;
  int a2dpMask=(BluetoothReceiver.A2DP_STATE_DISCONNECTING | BluetoothReceiver.A2DP_STATE_DISCONNECTED);
  mBluetoothReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("disconnectA2dp() bluetooth not enabled");
  }
  if (!adapter.getBondedDevices().contains(device)) {
    fail("disconnectA2dp() device not paired: device=" + device);
  }
  int state=mA2dp.getSinkState(device);
switch (state) {
case BluetoothA2dp.STATE_DISCONNECTED:
    assertFalse(mA2dp.isSinkConnected(device));
  return;
case BluetoothA2dp.STATE_CONNECTED:
case BluetoothA2dp.STATE_PLAYING:
assertTrue(mA2dp.isSinkConnected(device));
assertTrue(mA2dp.disconnectSink(device));
break;
case BluetoothA2dp.STATE_CONNECTING:
assertFalse(mA2dp.isSinkConnected(device));
assertTrue(mA2dp.disconnectSink(device));
break;
case BluetoothA2dp.STATE_DISCONNECTING:
assertFalse(mA2dp.isSinkConnected(device));
mask=a2dpMask=0;
break;
default :
fail("disconnectA2dp() invalid state: state=" + state);
}
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < DISCONNECT_A2DP_TIMEOUT) {
state=mA2dp.getSinkState(device);
if (state == BluetoothA2dp.STATE_DISCONNECTED) {
assertFalse(mA2dp.isSinkConnected(device));
if ((mBluetoothReceiver.getFiredFlags() & mask) == mask && (mBluetoothReceiver.getA2dpFiredFlags() & a2dpMask) == a2dpMask) {
mBluetoothReceiver.resetFiredFlags();
writeOutput(String.format("disconnectA2dp() completed in %d ms: device=%s",(System.currentTimeMillis() - s),device));
return;
}
}
sleep(POLL_TIME);
}
int firedFlags=mBluetoothReceiver.getFiredFlags();
int a2dpFiredFlags=mBluetoothReceiver.getA2dpFiredFlags();
mBluetoothReceiver.resetFiredFlags();
fail(String.format("disconnectA2dp() timeout: state=%d (expected %d), " + "flags=0x%x (expected 0x%x), a2dpFlags=0x%x (expected 0x%x)",state,BluetoothA2dp.STATE_DISCONNECTED,firedFlags,mask,a2dpFiredFlags,a2dpMask));
}
