{
  int mask=(BluetoothReceiver.STATE_TURNING_OFF_FLAG | BluetoothReceiver.STATE_OFF_FLAG | BluetoothReceiver.SCAN_MODE_NONE_FLAG);
  mBluetoothReceiver.resetFiredFlags();
  int state=adapter.getState();
switch (state) {
case BluetoothAdapter.STATE_OFF:
    assertFalse(adapter.isEnabled());
  return;
case BluetoothAdapter.STATE_ON:
assertTrue(adapter.isEnabled());
assertTrue(adapter.disable());
break;
case BluetoothAdapter.STATE_TURNING_ON:
assertFalse(adapter.isEnabled());
assertTrue(adapter.disable());
break;
case BluetoothAdapter.STATE_TURNING_OFF:
assertFalse(adapter.isEnabled());
mask=0;
break;
default :
fail("disable() invalid state: state=" + state);
}
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < DISABLE_TIMEOUT) {
state=adapter.getState();
if (state == BluetoothAdapter.STATE_OFF) {
assertFalse(adapter.isEnabled());
if ((mBluetoothReceiver.getFiredFlags() & mask) == mask) {
mBluetoothReceiver.resetFiredFlags();
writeOutput(String.format("disable() completed in %d ms",(System.currentTimeMillis() - s)));
return;
}
}
 else {
assertFalse(adapter.isEnabled());
assertEquals(BluetoothAdapter.STATE_TURNING_OFF,state);
}
sleep(POLL_TIME);
}
int firedFlags=mBluetoothReceiver.getFiredFlags();
mBluetoothReceiver.resetFiredFlags();
fail(String.format("disable() timeout: state=%d (expected %d), flags=0x%x (expected 0x%x)",state,BluetoothAdapter.STATE_OFF,firedFlags,mask));
}
