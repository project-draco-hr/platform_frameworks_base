{
  int mask=PAIR_STATE_FLAG;
  int pairMask=PAIR_STATE_NONE;
  mReceiver.resetFiredFlags();
  if (!adapter.isEnabled()) {
    fail("unpair() bluetooth not enabled");
  }
  int state=device.getBondState();
switch (state) {
case BluetoothDevice.BOND_BONDED:
    assertTrue(adapter.getBondedDevices().contains(device));
  assertTrue(device.removeBond());
break;
case BluetoothDevice.BOND_BONDING:
assertTrue(device.removeBond());
break;
case BluetoothDevice.BOND_NONE:
assertFalse(adapter.getBondedDevices().contains(device));
return;
default :
fail("unpair() invalid state: state=" + state);
}
assertTrue(device.removeBond());
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < UNPAIR_TIMEOUT) {
if (device.getBondState() == BluetoothDevice.BOND_NONE) {
assertFalse(adapter.getBondedDevices().contains(device));
if ((mReceiver.getFiredFlags() & mask) == mask && (mReceiver.getPairFiredFlags() & pairMask) == pairMask) {
writeOutput(String.format("unpair() completed in %d ms: device=%s",(System.currentTimeMillis() - s),device));
return;
}
}
}
int firedFlags=mReceiver.getFiredFlags();
int pairFiredFlags=mReceiver.getPairFiredFlags();
mReceiver.resetFiredFlags();
fail(String.format("unpair() timeout: state=%d (expected %d), flags=0x%x (expected 0x%x), " + "pairFlags=0x%x (expected 0x%x)",state,BluetoothDevice.BOND_BONDED,firedFlags,mask,pairFiredFlags,pairMask));
}
