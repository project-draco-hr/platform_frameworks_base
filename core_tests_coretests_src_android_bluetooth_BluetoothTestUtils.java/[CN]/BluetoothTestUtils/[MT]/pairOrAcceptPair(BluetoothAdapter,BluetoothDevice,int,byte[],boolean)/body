{
  int mask=PairReceiver.STATE_BONDING_FLAG | PairReceiver.STATE_BONDED_FLAG;
  long start=-1;
  String methodName;
  if (shouldPair) {
    methodName=String.format("pair(device=%s)",device);
  }
 else {
    methodName=String.format("acceptPair(device=%s)",device);
  }
  if (!adapter.isEnabled()) {
    fail(String.format("%s bluetooth not enabled",methodName));
  }
  PairReceiver receiver=getPairReceiver(device,passkey,pin,mask);
  int state=device.getBondState();
switch (state) {
case BluetoothDevice.BOND_NONE:
    assertFalse(adapter.getBondedDevices().contains(device));
  start=System.currentTimeMillis();
if (shouldPair) {
  assertTrue(device.createBond());
}
break;
case BluetoothDevice.BOND_BONDING:
mask=0;
break;
case BluetoothDevice.BOND_BONDED:
assertTrue(adapter.getBondedDevices().contains(device));
return;
default :
removeReceiver(receiver);
fail(String.format("%s invalid state: state=%d",methodName,state));
}
long s=System.currentTimeMillis();
while (System.currentTimeMillis() - s < PAIR_UNPAIR_TIMEOUT) {
state=device.getBondState();
if (state == BluetoothDevice.BOND_BONDED && (receiver.getFiredFlags() & mask) == mask) {
assertTrue(adapter.getBondedDevices().contains(device));
long finish=receiver.getCompletedTime();
if (start != -1 && finish != -1) {
writeOutput(String.format("%s completed in %d ms",methodName,(finish - start)));
}
 else {
writeOutput(String.format("%s completed",methodName));
}
removeReceiver(receiver);
return;
}
sleep(POLL_TIME);
}
int firedFlags=receiver.getFiredFlags();
removeReceiver(receiver);
fail(String.format("%s timeout: state=%d (expected %d), flags=0x%x (expected 0x%x)",methodName,state,BluetoothDevice.BOND_BONDED,firedFlags,mask));
}
