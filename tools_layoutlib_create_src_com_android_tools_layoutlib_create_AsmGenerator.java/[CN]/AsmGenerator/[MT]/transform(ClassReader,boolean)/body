{
  boolean hasNativeMethods=hasNativeMethods(cr);
  String className=cr.getClassName();
  String newName=transformName(className);
  if (newName != className) {
    mRenameCount++;
    mClassesNotRenamed.remove(className);
  }
  mLog.debug("Transform %s%s%s%s",className,newName == className ? "" : " (renamed to " + newName + ")",hasNativeMethods ? " -- has natives" : "",stubNativesOnly ? " -- stub natives only" : "");
  ClassWriter cw=new ClassWriter(ClassWriter.COMPUTE_MAXS);
  ClassVisitor rv=cw;
  if (newName != className) {
    rv=new RenameClassAdapter(cw,className,newName);
  }
  Set<String> delegateMethods=mDelegateMethods.get(className);
  if (delegateMethods != null && !delegateMethods.isEmpty()) {
    if (hasNativeMethods || !(delegateMethods.size() == 1 && delegateMethods.contains(DelegateClassAdapter.ALL_NATIVES))) {
      rv=new DelegateClassAdapter(mLog,rv,className,delegateMethods);
    }
  }
  TransformClassAdapter cv=new TransformClassAdapter(mLog,mStubMethods,mDeleteReturns.get(className),newName,rv,stubNativesOnly,stubNativesOnly || hasNativeMethods);
  cr.accept(cv,0);
  return cw.toByteArray();
}
