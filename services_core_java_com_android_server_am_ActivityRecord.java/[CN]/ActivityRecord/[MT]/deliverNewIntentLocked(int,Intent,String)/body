{
  service.grantUriPermissionFromIntentLocked(callingUid,packageName,intent,getUriPermissionsLocked(),userId);
  final ReferrerIntent rintent=new ReferrerIntent(intent,referrer);
  boolean unsent=true;
  if ((state == ActivityState.RESUMED || (service.isSleeping() && task.stack != null && task.stack.topRunningActivityLocked() == this)) && app != null && app.thread != null) {
    try {
      ArrayList<ReferrerIntent> ar=new ArrayList<>(1);
      ar.add(rintent);
      app.thread.scheduleNewIntent(ar,appToken);
      unsent=false;
    }
 catch (    RemoteException e) {
      Slog.w(TAG,"Exception thrown sending new intent to " + this,e);
    }
catch (    NullPointerException e) {
      Slog.w(TAG,"Exception thrown sending new intent to " + this,e);
    }
  }
  if (unsent) {
    addNewIntentLocked(rintent);
  }
}
