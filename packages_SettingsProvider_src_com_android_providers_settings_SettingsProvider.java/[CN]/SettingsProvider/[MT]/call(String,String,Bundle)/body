{
  int callingUser=UserHandle.getCallingUserId();
  if (args != null) {
    int reqUser=args.getInt(Settings.CALL_METHOD_USER_KEY,callingUser);
    if (reqUser != callingUser) {
      callingUser=ActivityManager.handleIncomingUser(Binder.getCallingPid(),Binder.getCallingUid(),reqUser,false,true,"get/set setting for user",null);
      if (LOCAL_LOGV)       Slog.v(TAG,"   access setting for user " + callingUser);
    }
  }
  DatabaseHelper dbHelper;
  SettingsCache cache;
  if (Settings.CALL_METHOD_GET_SYSTEM.equals(method)) {
    if (LOCAL_LOGV)     Slog.v(TAG,"call(system:" + request + ") for "+ callingUser);
    if (isManagedProfile(callingUser) && sSystemCloneToManagedKeys.contains(request)) {
      callingUser=UserHandle.USER_OWNER;
    }
    dbHelper=getOrEstablishDatabase(callingUser);
    cache=sSystemCaches.get(callingUser);
    return lookupValue(dbHelper,TABLE_SYSTEM,cache,request);
  }
  if (Settings.CALL_METHOD_GET_SECURE.equals(method)) {
    if (LOCAL_LOGV)     Slog.v(TAG,"call(secure:" + request + ") for "+ callingUser);
    if (isManagedProfile(callingUser) && sSecureCloneToManagedKeys.contains(request)) {
      callingUser=UserHandle.USER_OWNER;
    }
    dbHelper=getOrEstablishDatabase(callingUser);
    cache=sSecureCaches.get(callingUser);
    return lookupValue(dbHelper,TABLE_SECURE,cache,request);
  }
  if (Settings.CALL_METHOD_GET_GLOBAL.equals(method)) {
    if (LOCAL_LOGV)     Slog.v(TAG,"call(global:" + request + ") for "+ callingUser);
    return lookupValue(getOrEstablishDatabase(UserHandle.USER_OWNER),TABLE_GLOBAL,sGlobalCache,request);
  }
  final String newValue=(args == null) ? null : args.getString(Settings.NameValueTable.VALUE);
  if (getContext().checkCallingOrSelfPermission(android.Manifest.permission.WRITE_SETTINGS) != PackageManager.PERMISSION_GRANTED) {
    throw new SecurityException(String.format("Permission denial: writing to settings requires %1$s",android.Manifest.permission.WRITE_SETTINGS));
  }
  if (getAppOpsManager().noteOp(AppOpsManager.OP_WRITE_SETTINGS,Binder.getCallingUid(),getCallingPackage()) != AppOpsManager.MODE_ALLOWED) {
    return null;
  }
  final ContentValues values=new ContentValues();
  values.put(Settings.NameValueTable.NAME,request);
  values.put(Settings.NameValueTable.VALUE,newValue);
  if (Settings.CALL_METHOD_PUT_SYSTEM.equals(method)) {
    if (LOCAL_LOGV) {
      Slog.v(TAG,"call_put(system:" + request + "="+ newValue+ ") for "+ callingUser);
    }
    if (callingUser != UserHandle.USER_OWNER && isManagedProfile(callingUser)) {
      if (sSystemCloneToManagedKeys.contains(request)) {
        return null;
      }
    }
    insertForUser(Settings.System.CONTENT_URI,values,callingUser);
    if (callingUser == UserHandle.USER_OWNER && mManagedProfiles != null && sSystemCloneToManagedKeys.contains(request)) {
      final long token=Binder.clearCallingIdentity();
      try {
        for (int i=mManagedProfiles.size() - 1; i >= 0; i--) {
          if (LOCAL_LOGV) {
            Slog.v(TAG,"putting to additional user " + mManagedProfiles.get(i).id);
          }
          insertForUser(Settings.System.CONTENT_URI,values,mManagedProfiles.get(i).id);
        }
      }
  finally {
        Binder.restoreCallingIdentity(token);
      }
    }
  }
 else   if (Settings.CALL_METHOD_PUT_SECURE.equals(method)) {
    if (LOCAL_LOGV) {
      Slog.v(TAG,"call_put(secure:" + request + "="+ newValue+ ") for "+ callingUser);
    }
    if (callingUser != UserHandle.USER_OWNER && isManagedProfile(callingUser)) {
      if (sSecureCloneToManagedKeys.contains(request)) {
        return null;
      }
    }
    insertForUser(Settings.Secure.CONTENT_URI,values,callingUser);
    if (callingUser == UserHandle.USER_OWNER && mManagedProfiles != null && sSecureCloneToManagedKeys.contains(request)) {
      final long token=Binder.clearCallingIdentity();
      try {
        for (int i=mManagedProfiles.size() - 1; i >= 0; i--) {
          if (LOCAL_LOGV) {
            Slog.v(TAG,"putting to additional user " + mManagedProfiles.get(i).id);
          }
          insertForUser(Settings.Secure.CONTENT_URI,values,mManagedProfiles.get(i).id);
        }
      }
  finally {
        Binder.restoreCallingIdentity(token);
      }
    }
  }
 else   if (Settings.CALL_METHOD_PUT_GLOBAL.equals(method)) {
    if (LOCAL_LOGV) {
      Slog.v(TAG,"call_put(global:" + request + "="+ newValue+ ") for "+ callingUser);
    }
    insertForUser(Settings.Global.CONTENT_URI,values,callingUser);
  }
 else {
    Slog.w(TAG,"call() with invalid method: " + method);
  }
  return null;
}
