{
  SettingsState secureSettings=getSettingsLocked(SETTINGS_TYPE_SECURE,mUserId);
  final int oldVersion=secureSettings.getVersionLocked();
  final int newVersion=SETTINGS_VERSION;
  if (oldVersion == newVersion) {
    return;
  }
  final int curVersion=onUpgradeLocked(mUserId,oldVersion,newVersion);
  if (curVersion != newVersion) {
    removeUserStateLocked(mUserId,true);
    DatabaseHelper dbHelper=new DatabaseHelper(getContext(),mUserId);
    SQLiteDatabase database=dbHelper.getWritableDatabase();
    dbHelper.recreateDatabase(database,newVersion,curVersion,oldVersion);
    migrateLegacySettingsForUserLocked(dbHelper,database,mUserId);
    onUpgradeLocked(mUserId,oldVersion,newVersion);
  }
  if (mUserId == UserHandle.USER_SYSTEM) {
    SettingsState globalSettings=getSettingsLocked(SETTINGS_TYPE_GLOBAL,mUserId);
    globalSettings.setVersionLocked(newVersion);
  }
  secureSettings.setVersionLocked(newVersion);
  SettingsState systemSettings=getSettingsLocked(SETTINGS_TYPE_SYSTEM,mUserId);
  systemSettings.setVersionLocked(newVersion);
}
