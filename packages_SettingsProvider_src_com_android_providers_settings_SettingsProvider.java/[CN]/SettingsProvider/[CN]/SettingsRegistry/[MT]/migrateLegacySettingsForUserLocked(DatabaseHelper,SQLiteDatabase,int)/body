{
  final int systemKey=makeKey(SETTINGS_TYPE_SYSTEM,userId);
  ensureSettingsStateLocked(systemKey);
  SettingsState systemSettings=mSettingsStates.get(systemKey);
  migrateLegacySettingsLocked(systemSettings,database,TABLE_SYSTEM);
  systemSettings.persistSyncLocked();
  final int secureKey=makeKey(SETTINGS_TYPE_SECURE,userId);
  ensureSettingsStateLocked(secureKey);
  SettingsState secureSettings=mSettingsStates.get(secureKey);
  migrateLegacySettingsLocked(secureSettings,database,TABLE_SECURE);
  ensureSecureSettingAndroidIdSetLocked(secureSettings);
  secureSettings.persistSyncLocked();
  if (userId == UserHandle.USER_SYSTEM) {
    final int globalKey=makeKey(SETTINGS_TYPE_GLOBAL,userId);
    ensureSettingsStateLocked(globalKey);
    SettingsState globalSettings=mSettingsStates.get(globalKey);
    migrateLegacySettingsLocked(globalSettings,database,TABLE_GLOBAL);
    globalSettings.persistSyncLocked();
  }
  if (DROP_DATABASE_ON_MIGRATION) {
    dbHelper.dropDatabase();
  }
 else {
    dbHelper.backupDatabase();
  }
}
