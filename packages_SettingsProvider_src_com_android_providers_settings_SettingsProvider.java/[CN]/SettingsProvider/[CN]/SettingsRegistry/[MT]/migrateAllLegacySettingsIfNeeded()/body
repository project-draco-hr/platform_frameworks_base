{
synchronized (mLock) {
    final int key=makeKey(SETTINGS_TYPE_GLOBAL,UserHandle.USER_OWNER);
    File globalFile=getSettingsFile(key);
    if (globalFile.exists()) {
      return;
    }
    final long identity=Binder.clearCallingIdentity();
    try {
      List<UserInfo> users=mUserManager.getUsers(true);
      final int userCount=users.size();
      for (int i=0; i < userCount; i++) {
        final int userId=users.get(i).id;
        DatabaseHelper dbHelper=new DatabaseHelper(getContext(),userId);
        SQLiteDatabase database=dbHelper.getWritableDatabase();
        migrateLegacySettingsForUserLocked(dbHelper,database,userId);
        UpgradeController upgrader=new UpgradeController(userId);
        upgrader.upgradeIfNeededLocked();
        if (!mUserManager.isUserRunning(new UserHandle(userId))) {
          removeUserStateLocked(userId,false);
        }
      }
    }
  finally {
      Binder.restoreCallingIdentity(identity);
    }
  }
}
