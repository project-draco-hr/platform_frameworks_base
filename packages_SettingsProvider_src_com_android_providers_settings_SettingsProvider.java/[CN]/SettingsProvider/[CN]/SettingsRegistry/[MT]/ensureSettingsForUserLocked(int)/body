{
  migrateLegacySettingsForUserIfNeededLocked(userId);
  if (userId == UserHandle.USER_SYSTEM) {
    final int globalKey=makeKey(SETTINGS_TYPE_GLOBAL,UserHandle.USER_SYSTEM);
    ensureSettingsStateLocked(globalKey);
  }
  final int secureKey=makeKey(SETTINGS_TYPE_SECURE,userId);
  ensureSettingsStateLocked(secureKey);
  SettingsState secureSettings=getSettingsLocked(SETTINGS_TYPE_SECURE,userId);
  ensureSecureSettingAndroidIdSetLocked(secureSettings);
  final int systemKey=makeKey(SETTINGS_TYPE_SYSTEM,userId);
  ensureSettingsStateLocked(systemKey);
  UpgradeController upgrader=new UpgradeController(userId);
  upgrader.upgradeIfNeededLocked();
}
