{
  mDisplay.getRealMetrics(mDisplayMetrics);
  float[] dims={mDisplayMetrics.widthPixels,mDisplayMetrics.heightPixels};
  float degrees=getDegreesForRotation(mDisplay.getRotation());
  boolean requiresRotation=(degrees > 0);
  if (requiresRotation) {
    mDisplayMatrix.reset();
    mDisplayMatrix.preRotate(-degrees);
    mDisplayMatrix.mapPoints(dims);
    dims[0]=Math.abs(dims[0]);
    dims[1]=Math.abs(dims[1]);
  }
  mScreenBitmap=Surface.screenshot((int)dims[0],(int)dims[1]);
  if (requiresRotation) {
    Bitmap ss=Bitmap.createBitmap(mDisplayMetrics.widthPixels,mDisplayMetrics.heightPixels,Bitmap.Config.ARGB_8888);
    Canvas c=new Canvas(ss);
    c.translate(ss.getWidth() / 2,ss.getHeight() / 2);
    c.rotate(360f - degrees);
    c.translate(-dims[0] / 2,-dims[1] / 2);
    c.drawBitmap(mScreenBitmap,0,0,null);
    mScreenBitmap=ss;
  }
  if (mScreenBitmap == null) {
    Toast.makeText(mContext,R.string.screenshot_failed_toast,Toast.LENGTH_SHORT).show();
    return;
  }
  startAnimation();
}
