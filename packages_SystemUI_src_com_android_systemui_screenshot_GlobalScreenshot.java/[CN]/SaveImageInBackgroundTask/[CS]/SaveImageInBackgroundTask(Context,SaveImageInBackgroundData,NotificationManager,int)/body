{
  Resources r=context.getResources();
  mImageTime=System.currentTimeMillis();
  String imageDate=new SimpleDateFormat("yyyy-MM-dd-HH-mm-ss").format(new Date(mImageTime));
  mImageFileName=String.format(SCREENSHOT_FILE_NAME_TEMPLATE,imageDate);
  mScreenshotDir=new File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES),SCREENSHOTS_DIR_NAME);
  mImageFilePath=new File(mScreenshotDir,mImageFileName).getAbsolutePath();
  mImageWidth=data.image.getWidth();
  mImageHeight=data.image.getHeight();
  int iconSize=data.iconSize;
  final int shortSide=mImageWidth < mImageHeight ? mImageWidth : mImageHeight;
  Bitmap preview=Bitmap.createBitmap(shortSide,shortSide,data.image.getConfig());
  Canvas c=new Canvas(preview);
  Paint paint=new Paint();
  ColorMatrix desat=new ColorMatrix();
  desat.setSaturation(0.25f);
  paint.setColorFilter(new ColorMatrixColorFilter(desat));
  Matrix matrix=new Matrix();
  matrix.postTranslate((shortSide - mImageWidth) / 2,(shortSide - mImageHeight) / 2);
  c.drawBitmap(data.image,matrix,paint);
  c.drawColor(0x40FFFFFF);
  c.setBitmap(null);
  Bitmap croppedIcon=Bitmap.createScaledBitmap(preview,iconSize,iconSize,true);
  mTickerAddSpace=!mTickerAddSpace;
  mNotificationId=nId;
  mNotificationManager=nManager;
  final long now=System.currentTimeMillis();
  mNotificationBuilder=new Notification.Builder(context).setTicker(r.getString(R.string.screenshot_saving_ticker) + (mTickerAddSpace ? " " : "")).setContentTitle(r.getString(R.string.screenshot_saving_title)).setContentText(r.getString(R.string.screenshot_saving_text)).setSmallIcon(R.drawable.stat_notify_image).setWhen(now);
  mNotificationStyle=new Notification.BigPictureStyle().bigPicture(preview);
  mNotificationBuilder.setStyle(mNotificationStyle);
  mPublicNotificationBuilder=new Notification.Builder(context).setContentTitle(r.getString(R.string.screenshot_saving_title)).setContentText(r.getString(R.string.screenshot_saving_text)).setSmallIcon(R.drawable.stat_notify_image).setCategory(Notification.CATEGORY_PROGRESS).setWhen(now);
  mNotificationBuilder.setPublicVersion(mPublicNotificationBuilder.build());
  Notification n=mNotificationBuilder.build();
  n.flags|=Notification.FLAG_NO_CLEAR;
  mNotificationManager.notify(nId,n);
  mNotificationBuilder.setLargeIcon(croppedIcon);
  mNotificationStyle.bigLargeIcon(null);
}
