{
  if (mProcessInProgress || mState != STATE_PREVIEW) {
    mCamera.addCallbackBuffer(data);
    return;
  }
  if (data == null) {
    return;
  }
  int expectedBytes=mPreviewSize.width * mPreviewSize.height * ImageFormat.getBitsPerPixel(ImageFormat.NV21) / 8;
  if (expectedBytes != data.length) {
    Log.e(TAG,"Mismatched size of buffer! Expected ");
    mState=STATE_NO_CALLBACKS;
    mCamera.setPreviewCallbackWithBuffer(null);
    return;
  }
  mProcessInProgress=true;
  if (mCallbackBitmap == null || mPreviewSize.width != mCallbackBitmap.getWidth() || mPreviewSize.height != mCallbackBitmap.getHeight()) {
    mCallbackBitmap=Bitmap.createBitmap(mPreviewSize.width,mPreviewSize.height,Bitmap.Config.ARGB_8888);
    mFilterYuv=new RsYuv(mRS,getResources(),mPreviewSize.width,mPreviewSize.height);
    mFormatView.setImageBitmap(mCallbackBitmap);
  }
  mFormatView.invalidate();
  mCamera.addCallbackBuffer(data);
  mProcessInProgress=true;
  new ProcessPreviewDataTask().execute(data);
}
