{
  InetSocketAddress addr=new InetSocketAddress(8383);
  final ServerSocket serverSock=new ServerSocket();
  serverSock.setReuseAddress(true);
  serverSock.bind(addr);
  final Semaphore semThreadEnd=new Semaphore(0);
  new Thread(){
    @Override public void run(){
      try {
        Socket sock=serverSock.accept();
        sock.getInputStream().read();
        sock.close();
      }
 catch (      IOException e) {
        serverError=e;
      }
      semThreadEnd.release();
    }
  }
.start();
  try {
    Thread.sleep(2000);
  }
 catch (  InterruptedException ex) {
  }
  Socket client=new Socket("localhost",8383);
  client.getOutputStream().write(1);
  try {
    semThreadEnd.acquire();
  }
 catch (  InterruptedException e) {
  }
  serverSock.close();
  ServerSocket serverSock2=new ServerSocket();
  serverSock2.setReuseAddress(true);
  serverSock2.bind(addr);
  serverSock2.close();
  if (serverError != null) {
    throw new RuntimeException("Server must complete without error",serverError);
  }
}
