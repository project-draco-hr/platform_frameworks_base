{
  if (!(text instanceof Spanned)) {
    return offset;
  }
  ReplacementSpan[] spans=((Spanned)text).getSpans(offset,offset,ReplacementSpan.class);
  for (int i=0; i < spans.length; i++) {
    final int start=((Spanned)text).getSpanStart(spans[i]);
    final int end=((Spanned)text).getSpanEnd(spans[i]);
    if (start < offset && end > offset) {
      offset=moveToStart ? start : end;
    }
  }
  return offset;
}
