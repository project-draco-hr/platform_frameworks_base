{
  File rootFile=new File(rootPath);
  if (rootFile.exists()) {
    LinkedList<File> scanQueue=new LinkedList<File>();
    scanQueue.add(rootFile);
    while (scanQueue.size() > 0) {
      File file=scanQueue.remove(0);
      String filePath;
      try {
        filePath=file.getCanonicalPath();
        if (excludes != null && excludes.contains(filePath)) {
          continue;
        }
        StructStat stat=Os.lstat(filePath);
        if (OsConstants.S_ISLNK(stat.st_mode)) {
          if (DEBUG)           Log.i(TAG,"Symlink (skipping)!: " + file);
          continue;
        }
 else         if (OsConstants.S_ISDIR(stat.st_mode)) {
          File[] contents=file.listFiles();
          if (contents != null) {
            for (            File entry : contents) {
              scanQueue.add(0,entry);
            }
          }
        }
      }
 catch (      IOException e) {
        if (DEBUG)         Log.w(TAG,"Error canonicalizing path of " + file);
        continue;
      }
catch (      ErrnoException e) {
        if (DEBUG)         Log.w(TAG,"Error scanning file " + file + " : "+ e);
        continue;
      }
      FullBackup.backupToTar(packageName,domain,null,rootPath,filePath,output.getData());
    }
  }
}
