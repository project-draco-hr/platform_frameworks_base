{
  String basePath=null;
  if (DEBUG)   Log.d(TAG,"onRestoreFile() size=" + size + " type="+ type+ " domain="+ domain+ " relpath="+ path+ " mode="+ mode+ " mtime="+ mtime);
  if (domain.equals(FullBackup.DATA_TREE_TOKEN)) {
    basePath=getFilesDir().getCanonicalPath();
  }
 else   if (domain.equals(FullBackup.DATABASE_TREE_TOKEN)) {
    basePath=getDatabasePath("foo").getParentFile().getCanonicalPath();
  }
 else   if (domain.equals(FullBackup.ROOT_TREE_TOKEN)) {
    basePath=new File(getApplicationInfo().dataDir).getCanonicalPath();
  }
 else   if (domain.equals(FullBackup.SHAREDPREFS_TREE_TOKEN)) {
    basePath=getSharedPrefsFile("foo").getParentFile().getCanonicalPath();
  }
 else   if (domain.equals(FullBackup.CACHE_TREE_TOKEN)) {
    basePath=getCacheDir().getCanonicalPath();
  }
 else   if (domain.equals(FullBackup.MANAGED_EXTERNAL_TREE_TOKEN)) {
    if (Process.myUid() != Process.SYSTEM_UID) {
      File efLocation=getExternalFilesDir(null);
      if (efLocation != null) {
        basePath=getExternalFilesDir(null).getCanonicalPath();
        mode=-1;
      }
    }
  }
 else   if (domain.equals(FullBackup.NO_BACKUP_TREE_TOKEN)) {
    basePath=getNoBackupFilesDir().getCanonicalPath();
  }
 else {
    Log.i(TAG,"Unrecognized domain " + domain);
  }
  if (basePath != null) {
    File outFile=new File(basePath,path);
    String outPath=outFile.getCanonicalPath();
    if (outPath.startsWith(basePath + File.separatorChar)) {
      if (DEBUG)       Log.i(TAG,"[" + domain + " : "+ path+ "] mapped to "+ outPath);
      onRestoreFile(data,size,outFile,type,mode,mtime);
      return;
    }
 else {
      if (DEBUG) {
        Log.e(TAG,"Cross-domain restore attempt: " + outPath);
      }
    }
  }
  if (DEBUG)   Log.i(TAG,"[ skipping file " + path + "]");
  FullBackup.restoreFile(data,size,type,mode,mtime,null);
}
