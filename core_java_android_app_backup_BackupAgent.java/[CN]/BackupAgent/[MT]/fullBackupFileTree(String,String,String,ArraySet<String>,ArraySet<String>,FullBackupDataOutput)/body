{
  String domainPath=FullBackup.getBackupScheme(this).tokenToDirectoryPath(domain);
  if (domainPath == null) {
    return;
  }
  File rootFile=new File(startingPath);
  if (rootFile.exists()) {
    LinkedList<File> scanQueue=new LinkedList<File>();
    scanQueue.add(rootFile);
    while (scanQueue.size() > 0) {
      File file=scanQueue.remove(0);
      String filePath;
      try {
        StructStat stat=Os.lstat(file.getPath());
        if (OsConstants.S_ISLNK(stat.st_mode)) {
          if (DEBUG)           Log.i(TAG,"Symlink (skipping)!: " + file);
          continue;
        }
        filePath=file.getCanonicalPath();
        if (manifestExcludes != null && manifestExcludes.contains(filePath)) {
          continue;
        }
        if (systemExcludes != null && systemExcludes.contains(filePath)) {
          continue;
        }
        if (OsConstants.S_ISDIR(stat.st_mode)) {
          File[] contents=file.listFiles();
          if (contents != null) {
            for (            File entry : contents) {
              scanQueue.add(0,entry);
            }
          }
        }
      }
 catch (      IOException e) {
        if (DEBUG)         Log.w(TAG,"Error canonicalizing path of " + file);
        if (Log.isLoggable(FullBackup.TAG_XML_PARSER,Log.VERBOSE)) {
          Log.v(FullBackup.TAG_XML_PARSER,"Error canonicalizing path of " + file);
        }
        continue;
      }
catch (      ErrnoException e) {
        if (DEBUG)         Log.w(TAG,"Error scanning file " + file + " : "+ e);
        if (Log.isLoggable(FullBackup.TAG_XML_PARSER,Log.VERBOSE)) {
          Log.v(FullBackup.TAG_XML_PARSER,"Error scanning file " + file + " : "+ e);
        }
        continue;
      }
      FullBackup.backupToTar(packageName,domain,null,domainPath,filePath,output);
    }
  }
}
