{
  if (Config.LOGD)   Log.d(TAG,"NetworkThread starting");
  SntpClient client=new SntpClient();
  GpsXtraDownloader xtraDownloader=null;
  if (native_supports_xtra()) {
    xtraDownloader=new GpsXtraDownloader(mContext,mProperties);
  }
  while (!mDone) {
    long waitTime=getWaitTime();
    do {
synchronized (this) {
        try {
          if (!mNetworkAvailable) {
            if (Config.LOGD)             Log.d(TAG,"NetworkThread wait for network");
            wait();
          }
 else           if (waitTime > 0) {
            if (Config.LOGD) {
              Log.d(TAG,"NetworkThread wait for " + waitTime + "ms");
            }
            wait(waitTime);
          }
        }
 catch (        InterruptedException e) {
          if (Config.LOGD) {
            Log.d(TAG,"InterruptedException in GpsNetworkThread");
          }
        }
      }
      waitTime=getWaitTime();
    }
 while (!mDone && ((!mXtraDownloadRequested && !mTimeInjectRequested && waitTime > 0) || !mNetworkAvailable));
    if (Config.LOGD)     Log.d(TAG,"NetworkThread out of wake loop");
    if (!mDone) {
      if (mNtpServer != null && (mTimeInjectRequested || mNextNtpTime <= System.currentTimeMillis())) {
        if (Config.LOGD) {
          Log.d(TAG,"Requesting time from NTP server " + mNtpServer);
        }
        mTimeInjectRequested=false;
        if (client.requestTime(mNtpServer,10000)) {
          long time=client.getNtpTime();
          long timeReference=client.getNtpTimeReference();
          int certainty=(int)(client.getRoundTripTime() / 2);
          long now=System.currentTimeMillis();
          long systemTimeOffset=time - now;
          Log.d(TAG,"NTP server returned: " + time + " ("+ new Date(time)+ ") reference: "+ timeReference+ " certainty: "+ certainty+ " system time offset: "+ systemTimeOffset);
          if (systemTimeOffset < 0) {
            systemTimeOffset=-systemTimeOffset;
          }
          if (systemTimeOffset < MAX_NTP_SYSTEM_TIME_OFFSET) {
            native_inject_time(time,timeReference,certainty);
          }
 else {
            Log.e(TAG,"NTP time differs from system time by " + systemTimeOffset + "ms.  Ignoring.");
          }
          mNextNtpTime=now + NTP_INTERVAL;
        }
 else {
          if (Config.LOGD)           Log.d(TAG,"requestTime failed");
          mNextNtpTime=System.currentTimeMillis() + RETRY_INTERVAL;
        }
      }
      if ((mXtraDownloadRequested || (mNextXtraTime > 0 && mNextXtraTime <= System.currentTimeMillis())) && xtraDownloader != null) {
        mXtraDownloadRequested=false;
        byte[] data=xtraDownloader.downloadXtraData();
        if (data != null) {
          if (Config.LOGD) {
            Log.d(TAG,"calling native_inject_xtra_data");
          }
          native_inject_xtra_data(data,data.length);
          mNextXtraTime=0;
        }
 else {
          mNextXtraTime=System.currentTimeMillis() + RETRY_INTERVAL;
        }
      }
    }
  }
  if (Config.LOGD)   Log.d(TAG,"NetworkThread exiting");
}
