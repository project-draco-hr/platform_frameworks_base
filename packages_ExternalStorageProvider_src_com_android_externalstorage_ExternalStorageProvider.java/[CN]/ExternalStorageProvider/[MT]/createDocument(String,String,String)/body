{
  final File parent=getFileForDocId(docId);
  if (!parent.isDirectory()) {
    throw new IllegalArgumentException("Parent document isn't a directory");
  }
  File file;
  if (Document.MIME_TYPE_DIR.equals(mimeType)) {
    file=new File(parent,displayName);
    if (!file.mkdir()) {
      throw new IllegalStateException("Failed to mkdir " + file);
    }
  }
 else {
    displayName=removeExtension(mimeType,displayName);
    file=new File(parent,addExtension(mimeType,displayName));
    int n=0;
    while (file.exists() && n++ < 32) {
      file=new File(parent,addExtension(mimeType,displayName + " (" + n+ ")"));
    }
    try {
      if (!file.createNewFile()) {
        throw new IllegalStateException("Failed to touch " + file);
      }
    }
 catch (    IOException e) {
      throw new IllegalStateException("Failed to touch " + file + ": "+ e);
    }
  }
  return getDocIdForFile(file);
}
