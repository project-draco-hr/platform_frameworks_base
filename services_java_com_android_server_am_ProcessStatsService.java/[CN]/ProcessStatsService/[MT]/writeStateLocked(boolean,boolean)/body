{
synchronized (mPendingWriteLock) {
    long now=SystemClock.uptimeMillis();
    if (mPendingWrite == null || !mPendingWriteCommitted) {
      mPendingWrite=Parcel.obtain();
      mProcessStats.mTimePeriodEndRealtime=SystemClock.elapsedRealtime();
      if (commit) {
        mProcessStats.mFlags|=ProcessStats.FLAG_COMPLETE;
      }
      mProcessStats.writeToParcel(mPendingWrite,0);
      mPendingWriteFile=new AtomicFile(mFile.getBaseFile());
      mPendingWriteCommitted=commit;
    }
    if (commit) {
      mProcessStats.resetSafely();
      updateFile();
    }
    mLastWriteTime=SystemClock.uptimeMillis();
    Slog.i(TAG,"Prepared write state in " + (SystemClock.uptimeMillis() - now) + "ms");
    if (!sync) {
      BackgroundThread.getHandler().post(new Runnable(){
        @Override public void run(){
          performWriteState();
        }
      }
);
      return;
    }
  }
  performWriteState();
}
