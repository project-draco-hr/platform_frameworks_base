{
  List<InputMethodInfo> imis=mSettings.getEnabledInputMethodListLocked();
  InputMethodInfo mostApplicableIMI=null;
  InputMethodSubtype mostApplicableSubtype=null;
  boolean foundInSystemIME=false;
  for (  InputMethodInfo imi : imis) {
    InputMethodSubtype subtype=null;
    if (mCurrentSubtype != null) {
      subtype=findLastResortApplicableSubtypeLocked(mSettings.getEnabledInputMethodSubtypeListLocked(imi),mode,mCurrentSubtype.getLocale(),NOT_A_SUBTYPE_ID);
      if (subtype == null) {
        subtype=findLastResortApplicableSubtypeLocked(imi.getSubtypes(),mode,mCurrentSubtype.getLocale(),NOT_A_SUBTYPE_ID);
      }
    }
    if (subtype == null) {
      subtype=findLastResortApplicableSubtypeLocked(mSettings.getEnabledInputMethodSubtypeListLocked(imi),mode,null,NOT_A_SUBTYPE_ID);
    }
    if (subtype == null) {
      subtype=findLastResortApplicableSubtypeLocked(imi.getSubtypes(),mode,null,NOT_A_SUBTYPE_ID);
    }
    if (subtype != null) {
      if (imi.getId().equals(mCurMethodId)) {
        mostApplicableIMI=imi;
        mostApplicableSubtype=subtype;
        break;
      }
 else       if ((imi.getServiceInfo().applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) != 0) {
        mostApplicableIMI=imi;
        mostApplicableSubtype=subtype;
        foundInSystemIME=true;
      }
 else       if (!foundInSystemIME) {
        mostApplicableIMI=imi;
        mostApplicableSubtype=subtype;
      }
    }
  }
  if (DEBUG) {
    if (mostApplicableIMI != null) {
      Slog.w(TAG,"Most applicable shortcut input method was:" + mostApplicableIMI.getId());
      if (mostApplicableSubtype != null) {
        Slog.w(TAG,"Most applicable shortcut input method subtype was:" + "," + mostApplicableSubtype.getMode() + ","+ mostApplicableSubtype.getLocale());
      }
    }
  }
  if (mostApplicableIMI != null) {
    return new Pair<InputMethodInfo,InputMethodSubtype>(mostApplicableIMI,mostApplicableSubtype);
  }
 else {
    return null;
  }
}
