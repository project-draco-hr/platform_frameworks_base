{
  List<InputMethodInfo> imis=mSettings.getEnabledInputMethodListLocked();
  InputMethodInfo mostApplicableIMI=null;
  InputMethodSubtype mostApplicableSubtype=null;
  boolean foundInSystemIME=false;
  for (  InputMethodInfo imi : imis) {
    final String imiId=imi.getId();
    if (foundInSystemIME && !imiId.equals(mCurMethodId)) {
      continue;
    }
    InputMethodSubtype subtype=null;
    final List<InputMethodSubtype> explicitlyEnabledSubtypes=mSettings.getEnabledInputMethodSubtypeListLocked(imi);
    if (mCurrentSubtype != null) {
      subtype=findLastResortApplicableSubtypeLocked(explicitlyEnabledSubtypes,mode,mCurrentSubtype.getLocale(),false);
    }
    if (subtype == null) {
      subtype=findLastResortApplicableSubtypeLocked(explicitlyEnabledSubtypes,mode,null,true);
    }
    if (subtype == null && mCurrentSubtype != null) {
      subtype=findLastResortApplicableSubtypeLocked(imi.getSubtypes(),mode,mCurrentSubtype.getLocale(),false);
    }
    if (subtype == null) {
      subtype=findLastResortApplicableSubtypeLocked(imi.getSubtypes(),mode,null,true);
    }
    if (subtype != null) {
      if (imiId.equals(mCurMethodId)) {
        mostApplicableIMI=imi;
        mostApplicableSubtype=subtype;
        break;
      }
 else       if (!foundInSystemIME) {
        mostApplicableIMI=imi;
        mostApplicableSubtype=subtype;
        if ((imi.getServiceInfo().applicationInfo.flags & ApplicationInfo.FLAG_SYSTEM) != 0) {
          foundInSystemIME=true;
        }
      }
    }
  }
  if (DEBUG) {
    if (mostApplicableIMI != null) {
      Slog.w(TAG,"Most applicable shortcut input method was:" + mostApplicableIMI.getId());
      if (mostApplicableSubtype != null) {
        Slog.w(TAG,"Most applicable shortcut input method subtype was:" + "," + mostApplicableSubtype.getMode() + ","+ mostApplicableSubtype.getLocale());
      }
    }
  }
  if (mostApplicableIMI != null) {
    return new Pair<InputMethodInfo,InputMethodSubtype>(mostApplicableIMI,mostApplicableSubtype);
  }
 else {
    return null;
  }
}
