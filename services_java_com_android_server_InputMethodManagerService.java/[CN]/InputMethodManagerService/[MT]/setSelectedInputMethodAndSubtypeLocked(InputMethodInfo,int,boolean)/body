{
  mSettings.saveCurrentInputMethodAndSubtypeToHistory(mCurMethodId,mCurrentSubtype);
  if (imi == null || subtypeId < 0) {
    mSettings.putSelectedSubtype(NOT_A_SUBTYPE_ID);
    mCurrentSubtype=null;
  }
 else {
    if (subtypeId < imi.getSubtypeCount()) {
      InputMethodSubtype subtype=imi.getSubtypeAt(subtypeId);
      mSettings.putSelectedSubtype(subtype.hashCode());
      mCurrentSubtype=subtype;
    }
 else {
      mSettings.putSelectedSubtype(NOT_A_SUBTYPE_ID);
      mCurrentSubtype=getCurrentInputMethodSubtypeLocked();
    }
  }
  if (mSystemReady && !setSubtypeOnly) {
    mSettings.putSelectedInputMethod(imi != null ? imi.getId() : "");
  }
}
