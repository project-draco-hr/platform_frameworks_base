{
  final String systemLocale=res.getConfiguration().locale.toString();
  if (TextUtils.isEmpty(systemLocale))   return new ArrayList<InputMethodSubtype>();
  HashMap<String,InputMethodSubtype> applicableModeAndSubtypesMap=new HashMap<String,InputMethodSubtype>();
  final int N=subtypes.size();
  boolean containsKeyboardSubtype=false;
  for (int i=0; i < N; ++i) {
    InputMethodSubtype subtype=subtypes.get(i);
    final String locale=subtype.getLocale();
    final String mode=subtype.getMode();
    if (systemLocale.startsWith(locale)) {
      InputMethodSubtype applicableSubtype=applicableModeAndSubtypesMap.get(mode);
      if (applicableSubtype != null && systemLocale.equals(applicableSubtype.getLocale()))       continue;
      applicableModeAndSubtypesMap.put(mode,subtype);
      if (!containsKeyboardSubtype && SUBTYPE_MODE_KEYBOARD.equalsIgnoreCase(subtype.getMode())) {
        containsKeyboardSubtype=true;
      }
    }
  }
  final ArrayList<InputMethodSubtype> applicableSubtypes=new ArrayList<InputMethodSubtype>(applicableModeAndSubtypesMap.values());
  if (!containsKeyboardSubtype) {
    InputMethodSubtype lastResortKeyboardSubtype=findLastResortApplicableSubtypeLocked(res,subtypes,SUBTYPE_MODE_KEYBOARD,systemLocale,true);
    if (lastResortKeyboardSubtype != null) {
      applicableSubtypes.add(lastResortKeyboardSubtype);
    }
  }
  return applicableSubtypes;
}
