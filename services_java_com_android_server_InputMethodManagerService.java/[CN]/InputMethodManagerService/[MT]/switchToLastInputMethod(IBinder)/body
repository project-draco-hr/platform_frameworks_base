{
synchronized (mMethodMap) {
    final Pair<String,String> lastIme=mSettings.getLastInputMethodAndSubtypeLocked();
    if (lastIme == null)     return false;
    final InputMethodInfo lastImi=mMethodMap.get(lastIme.first);
    if (lastImi == null)     return false;
    final boolean imiIdIsSame=lastImi.getId().equals(mCurMethodId);
    final int lastSubtypeHash=Integer.valueOf(lastIme.second);
    if (imiIdIsSame && lastSubtypeHash == NOT_A_SUBTYPE_ID)     return false;
    int currentSubtypeHash=mCurrentSubtype == null ? NOT_A_SUBTYPE_ID : mCurrentSubtype.hashCode();
    if (!imiIdIsSame || lastSubtypeHash != currentSubtypeHash) {
      if (DEBUG) {
        Slog.d(TAG,"Switch to: " + lastImi.getId() + ", "+ lastIme.second+ ", from: "+ mCurMethodId+ ", "+ currentSubtypeHash);
      }
      setInputMethodWithSubtypeId(token,lastIme.first,getSubtypeIdFromHashCode(lastImi,lastSubtypeHash));
      return true;
    }
    return false;
  }
}
