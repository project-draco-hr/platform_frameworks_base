{
  if (subtypes == null || subtypes.size() == 0) {
    return null;
  }
  if (TextUtils.isEmpty(locale)) {
    locale=mRes.getConfiguration().locale.toString();
  }
  final String language=locale.substring(0,2);
  boolean partialMatchFound=false;
  InputMethodSubtype applicableSubtype=null;
  final int N=subtypes.size();
  for (int i=0; i < N; ++i) {
    InputMethodSubtype subtype=subtypes.get(i);
    final String subtypeLocale=subtype.getLocale();
    if (subtypes.get(i).getMode().equalsIgnoreCase(mode)) {
      if (locale.equals(subtypeLocale)) {
        applicableSubtype=subtype;
        break;
      }
 else       if (!partialMatchFound && subtypeLocale.startsWith(language)) {
        applicableSubtype=subtype;
        partialMatchFound=true;
      }
    }
  }
  if (applicableSubtype == null && defaultSubtypeId != NOT_A_SUBTYPE_ID) {
    if (defaultSubtypeId >= 0 && N > defaultSubtypeId) {
      InputMethodSubtype defaultSubtype=subtypes.get(defaultSubtypeId);
      if (defaultSubtype.getMode().equalsIgnoreCase(mode)) {
        return defaultSubtype;
      }
    }
  }
  if (DEBUG) {
    if (applicableSubtype != null) {
      Slog.d(TAG,"Applicable InputMethodSubtype was found: " + applicableSubtype.getMode() + ","+ applicableSubtype.getLocale());
    }
  }
  return applicableSubtype;
}
