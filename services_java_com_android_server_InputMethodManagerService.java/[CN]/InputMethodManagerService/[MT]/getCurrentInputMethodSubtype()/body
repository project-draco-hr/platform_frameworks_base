{
  boolean subtypeIsSelected=false;
  try {
    subtypeIsSelected=Settings.Secure.getInt(mContext.getContentResolver(),Settings.Secure.SELECTED_INPUT_METHOD_SUBTYPE) != NOT_A_SUBTYPE_ID;
  }
 catch (  SettingNotFoundException e) {
  }
synchronized (mMethodMap) {
    if (!subtypeIsSelected || mCurrentSubtype == null) {
      String lastInputMethodId=Settings.Secure.getString(mContext.getContentResolver(),Settings.Secure.DEFAULT_INPUT_METHOD);
      int subtypeId=getSelectedInputMethodSubtypeId(lastInputMethodId);
      if (subtypeId == NOT_A_SUBTYPE_ID) {
        InputMethodInfo imi=mMethodMap.get(lastInputMethodId);
        if (imi != null) {
          List<InputMethodSubtype> explicitlyOrImplicitlyEnabledSubtypes=getEnabledInputMethodSubtypeList(imi,true);
          if (explicitlyOrImplicitlyEnabledSubtypes.size() == 1) {
            mCurrentSubtype=explicitlyOrImplicitlyEnabledSubtypes.get(0);
          }
 else           if (explicitlyOrImplicitlyEnabledSubtypes.size() > 1) {
            mCurrentSubtype=findLastResortApplicableSubtypeLocked(mRes,explicitlyOrImplicitlyEnabledSubtypes,SUBTYPE_MODE_KEYBOARD,null,true);
            if (mCurrentSubtype == null) {
              mCurrentSubtype=findLastResortApplicableSubtypeLocked(mRes,explicitlyOrImplicitlyEnabledSubtypes,null,null,true);
            }
          }
        }
      }
 else {
        mCurrentSubtype=mMethodMap.get(lastInputMethodId).getSubtypes().get(subtypeId);
      }
    }
    return mCurrentSubtype;
  }
}
