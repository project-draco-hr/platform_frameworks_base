{
  mContext=context;
  mHandler=new Handler(this);
  mIWindowManager=IWindowManager.Stub.asInterface(ServiceManager.getService(Context.WINDOW_SERVICE));
  mCaller=new HandlerCaller(context,new HandlerCaller.Callback(){
    public void executeMessage(    Message msg){
      handleMessage(msg);
    }
  }
);
  (new MyPackageMonitor()).register(mContext,true);
  IntentFilter screenOnOffFilt=new IntentFilter();
  screenOnOffFilt.addAction(Intent.ACTION_SCREEN_ON);
  screenOnOffFilt.addAction(Intent.ACTION_SCREEN_OFF);
  screenOnOffFilt.addAction(Intent.ACTION_CLOSE_SYSTEM_DIALOGS);
  mContext.registerReceiver(new ScreenOnOffReceiver(),screenOnOffFilt);
  mStatusBar=statusBar;
  statusBar.setIconVisibility("ime",false);
  buildInputMethodListLocked(mMethodList,mMethodMap);
  final String enabledStr=Settings.Secure.getString(mContext.getContentResolver(),Settings.Secure.ENABLED_INPUT_METHODS);
  Slog.i(TAG,"Enabled input methods: " + enabledStr);
  final String defaultIme=Settings.Secure.getString(mContext.getContentResolver(),Settings.Secure.DEFAULT_INPUT_METHOD);
  if (enabledStr == null || TextUtils.isEmpty(defaultIme)) {
    Slog.i(TAG,"Enabled input methods or default IME has not been set, enabling all");
    InputMethodInfo defIm=null;
    StringBuilder sb=new StringBuilder(256);
    final int N=mMethodList.size();
    for (int i=0; i < N; i++) {
      InputMethodInfo imi=mMethodList.get(i);
      Slog.i(TAG,"Adding: " + imi.getId());
      if (i > 0)       sb.append(':');
      sb.append(imi.getId());
      if (defIm == null && imi.getIsDefaultResourceId() != 0) {
        try {
          Resources res=mContext.createPackageContext(imi.getPackageName(),0).getResources();
          if (res.getBoolean(imi.getIsDefaultResourceId())) {
            defIm=imi;
            Slog.i(TAG,"Selected default: " + imi.getId());
          }
        }
 catch (        PackageManager.NameNotFoundException ex) {
        }
catch (        Resources.NotFoundException ex) {
        }
      }
    }
    if (defIm == null && N > 0) {
      defIm=mMethodList.get(0);
      Slog.i(TAG,"No default found, using " + defIm.getId());
    }
    Settings.Secure.putString(mContext.getContentResolver(),Settings.Secure.ENABLED_INPUT_METHODS,sb.toString());
    if (defIm != null) {
      Settings.Secure.putString(mContext.getContentResolver(),Settings.Secure.DEFAULT_INPUT_METHOD,defIm.getId());
    }
  }
  mSettingsObserver=new SettingsObserver(mHandler);
  updateFromSettingsLocked();
}
