{
  WeakReference<Resources> weakResourceRef=mActivityResourceReferences.get(activityToken);
  Resources resources=weakResourceRef != null ? weakResourceRef.get() : null;
  if (resources == null || !Objects.equals(resources.getClassLoader(),classLoader)) {
    resources=new Resources(classLoader);
    mActivityResourceReferences.put(activityToken,new WeakReference<>(resources));
    if (DEBUG) {
      Slog.d(TAG,"- creating new ref=" + resources);
    }
  }
 else {
    if (DEBUG) {
      Slog.d(TAG,"- using existing ref=" + resources);
    }
  }
  if (resources.getImpl() != impl) {
    if (DEBUG) {
      Slog.d(TAG,"- setting ref=" + resources + " with impl="+ impl);
    }
    resources.setImpl(impl);
  }
  return resources;
}
