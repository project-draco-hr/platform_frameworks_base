{
  final ArrayList<MenuItemImpl> visibleItems=mMenu.getVisibleItems();
  final int itemsSize=visibleItems.size();
  int maxActions=mMaxItems;
  int widthLimit=mActionItemWidthLimit;
  final int querySpec=MeasureSpec.makeMeasureSpec(0,MeasureSpec.UNSPECIFIED);
  final ViewGroup parent=(ViewGroup)mMenuView;
  int requiredItems=0;
  int requestedItems=0;
  int firstActionWidth=0;
  boolean hasOverflow=false;
  for (int i=0; i < itemsSize; i++) {
    MenuItemImpl item=visibleItems.get(i);
    if (item.requiresActionButton()) {
      requiredItems++;
    }
 else     if (item.requestsActionButton()) {
      requestedItems++;
    }
 else {
      hasOverflow=true;
    }
  }
  if (mReserveOverflow && (hasOverflow || requiredItems + requestedItems > maxActions)) {
    maxActions--;
  }
  maxActions-=requiredItems;
  final SparseBooleanArray seenGroups=mActionButtonGroups;
  seenGroups.clear();
  for (int i=0; i < itemsSize; i++) {
    MenuItemImpl item=visibleItems.get(i);
    if (item.requiresActionButton()) {
      View v=item.getActionView();
      if (v == null) {
        v=getItemView(item,mScrapActionButtonView,parent);
        if (mScrapActionButtonView == null) {
          mScrapActionButtonView=v;
        }
      }
      v.measure(querySpec,querySpec);
      final int measuredWidth=v.getMeasuredWidth();
      widthLimit-=measuredWidth;
      Log.d(TAG,"flagActionItems required item " + i + " measured width "+ measuredWidth+ " - "+ widthLimit+ " left");
      if (firstActionWidth == 0) {
        firstActionWidth=measuredWidth;
      }
      final int groupId=item.getGroupId();
      if (groupId != 0) {
        seenGroups.put(groupId,true);
      }
    }
 else     if (item.requestsActionButton()) {
      final int groupId=item.getGroupId();
      final boolean inGroup=seenGroups.get(groupId);
      boolean isAction=(maxActions > 0 || inGroup) && widthLimit > 0;
      maxActions--;
      if (isAction) {
        View v=item.getActionView();
        if (v == null) {
          v=getItemView(item,mScrapActionButtonView,parent);
          if (mScrapActionButtonView == null) {
            mScrapActionButtonView=v;
          }
        }
        v.measure(querySpec,querySpec);
        final int measuredWidth=v.getMeasuredWidth();
        widthLimit-=measuredWidth;
        Log.d(TAG,"flagActionItems requested item " + i + " measured width "+ measuredWidth+ " - "+ widthLimit+ " left");
        if (firstActionWidth == 0) {
          firstActionWidth=measuredWidth;
        }
        if (mStrictWidthLimit) {
          isAction=widthLimit >= 0;
          Log.d(TAG," --> strict width limit: isAction? " + isAction);
        }
 else {
          isAction=widthLimit + firstActionWidth > 0;
          Log.d(TAG," --> normal width limit: isAction? " + isAction);
        }
      }
      if (isAction && groupId != 0) {
        seenGroups.put(groupId,true);
      }
 else       if (inGroup) {
        seenGroups.put(groupId,false);
        for (int j=0; j < i; j++) {
          MenuItemImpl areYouMyGroupie=visibleItems.get(j);
          if (areYouMyGroupie.getGroupId() == groupId) {
            areYouMyGroupie.setIsActionButton(false);
          }
        }
      }
      item.setIsActionButton(isAction);
    }
  }
  return true;
}
