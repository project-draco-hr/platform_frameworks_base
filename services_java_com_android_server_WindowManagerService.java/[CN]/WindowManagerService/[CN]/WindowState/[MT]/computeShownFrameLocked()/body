{
  final boolean selfTransformation=mHasLocalTransformation;
  Transformation attachedTransformation=(mAttachedWindow != null && mAttachedWindow.mHasLocalTransformation) ? mAttachedWindow.mTransformation : null;
  Transformation appTransformation=(mAppToken != null && mAppToken.hasTransformation) ? mAppToken.transformation : null;
  if (mAttrs.type == TYPE_WALLPAPER && mLowerWallpaperTarget == null && mWallpaperTarget != null) {
    if (mWallpaperTarget.mHasLocalTransformation && mWallpaperTarget.mAnimation != null && !mWallpaperTarget.mAnimation.getDetachWallpaper()) {
      attachedTransformation=mWallpaperTarget.mTransformation;
      if (DEBUG_WALLPAPER && attachedTransformation != null) {
        Slog.v(TAG,"WP target attached xform: " + attachedTransformation);
      }
    }
    if (mWallpaperTarget.mAppToken != null && mWallpaperTarget.mAppToken.hasTransformation && mWallpaperTarget.mAppToken.animation != null && !mWallpaperTarget.mAppToken.animation.getDetachWallpaper()) {
      appTransformation=mWallpaperTarget.mAppToken.transformation;
      if (DEBUG_WALLPAPER && appTransformation != null) {
        Slog.v(TAG,"WP target app xform: " + appTransformation);
      }
    }
  }
  final boolean screenAnimation=mScreenRotationAnimation != null && mScreenRotationAnimation.isAnimating();
  if (selfTransformation || attachedTransformation != null || appTransformation != null || screenAnimation) {
    final Rect frame=mFrame;
    final float tmpFloats[]=mTmpFloats;
    final Matrix tmpMatrix=mTmpMatrix;
    tmpMatrix.setTranslate(0,0);
    if (selfTransformation) {
      tmpMatrix.postConcat(mTransformation.getMatrix());
    }
    tmpMatrix.postTranslate(frame.left,frame.top);
    if (attachedTransformation != null) {
      tmpMatrix.postConcat(attachedTransformation.getMatrix());
    }
    if (appTransformation != null) {
      tmpMatrix.postConcat(appTransformation.getMatrix());
    }
    if (screenAnimation) {
      tmpMatrix.postConcat(mScreenRotationAnimation.getEnterTransformation().getMatrix());
    }
    mHaveMatrix=true;
    tmpMatrix.getValues(tmpFloats);
    mDsDx=tmpFloats[Matrix.MSCALE_X];
    mDtDx=tmpFloats[Matrix.MSKEW_Y];
    mDsDy=tmpFloats[Matrix.MSKEW_X];
    mDtDy=tmpFloats[Matrix.MSCALE_Y];
    int x=(int)tmpFloats[Matrix.MTRANS_X] + mXOffset;
    int y=(int)tmpFloats[Matrix.MTRANS_Y] + mYOffset;
    int w=frame.width();
    int h=frame.height();
    mShownFrame.set(x,y,x + w,y + h);
    mShownAlpha=mAlpha;
    if (!mLimitedAlphaCompositing || (!PixelFormat.formatHasAlpha(mAttrs.format) || (isIdentityMatrix(mDsDx,mDtDx,mDsDy,mDtDy) && x == frame.left && y == frame.top))) {
      if (selfTransformation) {
        mShownAlpha*=mTransformation.getAlpha();
      }
      if (attachedTransformation != null) {
        mShownAlpha*=attachedTransformation.getAlpha();
      }
      if (appTransformation != null) {
        mShownAlpha*=appTransformation.getAlpha();
      }
      if (screenAnimation) {
        mShownAlpha*=mScreenRotationAnimation.getEnterTransformation().getAlpha();
      }
    }
 else {
    }
    if (localLOGV)     Slog.v(TAG,"Continuing animation in " + this + ": "+ mShownFrame+ ", alpha="+ mTransformation.getAlpha());
    return;
  }
  mShownFrame.set(mFrame);
  if (mXOffset != 0 || mYOffset != 0) {
    mShownFrame.offset(mXOffset,mYOffset);
  }
  mShownAlpha=mAlpha;
  mHaveMatrix=false;
  mDsDx=1;
  mDtDx=0;
  mDsDy=0;
  mDtDy=1;
}
