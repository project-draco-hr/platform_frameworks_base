{
  WindowState newFocus=computeFocusedWindowLocked();
  if (mCurrentFocus != newFocus) {
    mH.removeMessages(H.REPORT_FOCUS_CHANGE);
    mH.sendEmptyMessage(H.REPORT_FOCUS_CHANGE);
    if (localLOGV)     Log.v(TAG,"Changing focus from " + mCurrentFocus + " to "+ newFocus);
    final WindowState oldFocus=mCurrentFocus;
    mCurrentFocus=newFocus;
    mLosingFocus.remove(newFocus);
    final WindowState imWindow=mInputMethodWindow;
    if (newFocus != imWindow && oldFocus != imWindow) {
      if (moveInputMethodWindowsIfNeededLocked(mode != UPDATE_FOCUS_WILL_ASSIGN_LAYERS && mode != UPDATE_FOCUS_WILL_PLACE_SURFACES)) {
        mLayoutNeeded=true;
      }
      if (mode == UPDATE_FOCUS_PLACING_SURFACES) {
        performLayoutLockedInner();
      }
 else       if (mode == UPDATE_FOCUS_WILL_PLACE_SURFACES) {
        assignLayersLocked();
      }
    }
    if (newFocus != null && mode != UPDATE_FOCUS_WILL_ASSIGN_LAYERS) {
      mKeyWaiter.handleNewWindowLocked(newFocus);
    }
    return true;
  }
  return false;
}
