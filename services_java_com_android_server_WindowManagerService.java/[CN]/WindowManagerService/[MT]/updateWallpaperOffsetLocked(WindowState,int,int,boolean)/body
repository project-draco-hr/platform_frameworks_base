{
  boolean changed=false;
  boolean rawChanged=false;
  float wpx=mLastWallpaperX >= 0 ? mLastWallpaperX : 0.5f;
  int availw=wallpaperWin.mFrame.right - wallpaperWin.mFrame.left - dw;
  int offset=availw > 0 ? -(int)(availw * wpx + .5f) : 0;
  changed=wallpaperWin.mXOffset != offset;
  if (changed) {
    if (DEBUG_WALLPAPER)     Log.v(TAG,"Update wallpaper " + wallpaperWin + " x: "+ offset);
    wallpaperWin.mXOffset=offset;
  }
  if (wallpaperWin.mWallpaperX != wpx) {
    wallpaperWin.mWallpaperX=wpx;
    rawChanged=true;
  }
  float wpy=mLastWallpaperY >= 0 ? mLastWallpaperY : 0.5f;
  int availh=wallpaperWin.mFrame.bottom - wallpaperWin.mFrame.top - dh;
  offset=availh > 0 ? -(int)(availh * wpy + .5f) : 0;
  if (wallpaperWin.mYOffset != offset) {
    if (DEBUG_WALLPAPER)     Log.v(TAG,"Update wallpaper " + wallpaperWin + " y: "+ offset);
    changed=true;
    wallpaperWin.mYOffset=offset;
  }
  if (wallpaperWin.mWallpaperY != wpy) {
    wallpaperWin.mWallpaperY=wpy;
    rawChanged=true;
  }
  if (rawChanged) {
    try {
      if (DEBUG_WALLPAPER)       Log.v(TAG,"Report new wp offset " + wallpaperWin + " x="+ wallpaperWin.mWallpaperX+ " y="+ wallpaperWin.mWallpaperY);
      if (sync) {
synchronized (mWaitingOnWallpaperLock) {
          mWaitingOnWallpaper=wallpaperWin;
        }
      }
      wallpaperWin.mClient.dispatchWallpaperOffsets(wallpaperWin.mWallpaperX,wallpaperWin.mWallpaperY,sync);
      if (sync) {
synchronized (mWaitingOnWallpaperLock) {
          if (mWaitingOnWallpaper != null) {
            long start=SystemClock.uptimeMillis();
            if ((mLastWallpaperTimeoutTime + WALLPAPER_TIMEOUT_RECOVERY) < start) {
              try {
                if (DEBUG_WALLPAPER)                 Log.v(TAG,"Waiting for offset complete...");
                mWaitingOnWallpaperLock.wait(WALLPAPER_TIMEOUT);
              }
 catch (              InterruptedException e) {
              }
              if (DEBUG_WALLPAPER)               Log.v(TAG,"Offset complete!");
              if ((start + WALLPAPER_TIMEOUT) < SystemClock.uptimeMillis()) {
                Log.i(TAG,"Timeout waiting for wallpaper to offset: " + wallpaperWin);
                mLastWallpaperTimeoutTime=start;
              }
            }
            mWaitingOnWallpaper=null;
          }
        }
      }
    }
 catch (    RemoteException e) {
    }
  }
  return changed;
}
