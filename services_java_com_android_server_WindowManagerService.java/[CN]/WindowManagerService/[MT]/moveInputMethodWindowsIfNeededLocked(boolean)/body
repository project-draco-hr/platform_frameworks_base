{
  final WindowState imWin=mInputMethodWindow;
  final int DN=mInputMethodDialogs.size();
  if (imWin == null && DN == 0) {
    return false;
  }
  int imPos=findDesiredInputMethodWindowIndexLocked(true);
  if (imPos >= 0) {
    final int N=mWindows.size();
    WindowState firstImWin=imPos < N ? (WindowState)mWindows.get(imPos) : null;
    WindowState baseImWin=imWin != null ? imWin : mInputMethodDialogs.get(0);
    if (baseImWin.mChildWindows.size() > 0) {
      WindowState cw=(WindowState)baseImWin.mChildWindows.get(0);
      if (cw.mSubLayer < 0)       baseImWin=cw;
    }
    if (firstImWin == baseImWin) {
      int pos=imPos + 1;
      while (pos < N) {
        if (!((WindowState)mWindows.get(pos)).mIsImWindow) {
          break;
        }
        pos++;
      }
      pos++;
      while (pos < N) {
        if (((WindowState)mWindows.get(pos)).mIsImWindow) {
          break;
        }
        pos++;
      }
      if (pos >= N) {
        return false;
      }
    }
    if (imWin != null) {
      imPos=tmpRemoveWindowLocked(imPos,imWin);
      imWin.mTargetAppToken=mInputMethodTarget.mAppToken;
      reAddWindowLocked(imPos,imWin);
      if (DN > 0)       moveInputMethodDialogsLocked(imPos + 1);
    }
 else {
      moveInputMethodDialogsLocked(imPos);
    }
  }
 else {
    if (imWin != null) {
      tmpRemoveWindowLocked(0,imWin);
      imWin.mTargetAppToken=null;
      reAddWindowToListInOrderLocked(imWin);
      if (DN > 0)       moveInputMethodDialogsLocked(-1);
      ;
    }
 else {
      moveInputMethodDialogsLocked(-1);
      ;
    }
  }
  if (needAssignLayers) {
    assignLayersLocked();
  }
  return true;
}
