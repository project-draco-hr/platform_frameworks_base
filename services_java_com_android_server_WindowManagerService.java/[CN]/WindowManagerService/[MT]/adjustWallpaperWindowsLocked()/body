{
  boolean changed=false;
  final ArrayList localmWindows=mWindows;
  int N=localmWindows.size();
  WindowState w=null;
  int i=N;
  boolean visible=false;
  while (i > 0) {
    i--;
    w=(WindowState)localmWindows.get(i);
    if ((w.mAttrs.flags & FLAG_SHOW_WALLPAPER) != 0 && w.isReadyForDisplay() && !w.mDrawPending && !w.mCommitDrawPending) {
      visible=true;
      break;
    }
  }
  if (!visible)   w=null;
  if (DEBUG_WALLPAPER && mWallpaperTarget != w) {
    Log.v(TAG,"New wallpaper target: " + w);
  }
  mWallpaperTarget=w;
  if (visible) {
    visible=!w.mObscured;
    if (DEBUG_WALLPAPER)     Log.v(TAG,"Wallpaper visibility: " + visible);
    mWallpaperAnimLayerAdjustment=w.mAppToken != null ? w.mAppToken.animLayerAdjustment : 0;
    while (i > 0) {
      WindowState wb=(WindowState)localmWindows.get(i - 1);
      if (wb.mAttachedWindow != w && (wb.mAttrs.type != TYPE_APPLICATION_STARTING || wb.mToken != w.mToken)) {
        break;
      }
      w=wb;
      i--;
    }
  }
  w=i > 0 ? (WindowState)localmWindows.get(i - 1) : null;
  final int dw=mDisplay.getWidth();
  final int dh=mDisplay.getHeight();
  int curTokenIndex=mWallpaperTokens.size();
  while (curTokenIndex > 0) {
    curTokenIndex--;
    WindowToken token=mWallpaperTokens.get(curTokenIndex);
    int curWallpaperIndex=token.windows.size();
    while (curWallpaperIndex > 0) {
      curWallpaperIndex--;
      WindowState wallpaper=token.windows.get(curWallpaperIndex);
      if (visible) {
        updateWallpaperOffsetLocked(mWallpaperTarget,wallpaper,dw,dh);
      }
      if (wallpaper.mWallpaperVisible != visible) {
        wallpaper.mWallpaperVisible=visible;
        try {
          if (DEBUG_VISIBILITY || DEBUG_WALLPAPER)           Log.v(TAG,"Setting visibility of wallpaper " + wallpaper + ": "+ visible);
          wallpaper.mClient.dispatchAppVisibility(visible);
        }
 catch (        RemoteException e) {
        }
      }
      wallpaper.mAnimLayer=wallpaper.mLayer + mWallpaperAnimLayerAdjustment;
      if (DEBUG_LAYERS || DEBUG_WALLPAPER)       Log.v(TAG,"Wallpaper win " + wallpaper + " anim layer: "+ wallpaper.mAnimLayer);
      if (wallpaper == w) {
        i--;
        w=i > 0 ? (WindowState)localmWindows.get(i - 1) : null;
        continue;
      }
      int oldIndex=localmWindows.indexOf(wallpaper);
      if (oldIndex >= 0) {
        localmWindows.remove(oldIndex);
        if (oldIndex < i) {
          i--;
        }
      }
      if (DEBUG_WALLPAPER)       Log.v(TAG,"Moving wallpaper " + wallpaper + " from "+ oldIndex+ " to "+ i);
      localmWindows.add(i,wallpaper);
      changed=true;
    }
  }
  return changed;
}
