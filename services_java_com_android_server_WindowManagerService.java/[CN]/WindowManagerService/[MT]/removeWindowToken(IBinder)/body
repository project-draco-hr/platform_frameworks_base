{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"removeWindowToken()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
  final long origId=Binder.clearCallingIdentity();
synchronized (mWindowMap) {
    WindowToken wtoken=mTokenMap.remove(token);
    mTokenList.remove(wtoken);
    if (wtoken != null) {
      boolean delayed=false;
      if (!wtoken.hidden) {
        wtoken.hidden=true;
        final int N=wtoken.windows.size();
        boolean changed=false;
        for (int i=0; i < N; i++) {
          WindowState win=wtoken.windows.get(i);
          if (win.isAnimating()) {
            delayed=true;
          }
          if (win.isVisibleNow()) {
            applyAnimationLocked(win,WindowManagerPolicy.TRANSIT_EXIT,false);
            mKeyWaiter.finishedKey(win.mSession,win.mClient,true,KeyWaiter.RETURN_NOTHING);
            changed=true;
          }
        }
        if (changed) {
          mLayoutNeeded=true;
          performLayoutAndPlaceSurfacesLocked();
          updateFocusedWindowLocked(UPDATE_FOCUS_NORMAL);
        }
        if (delayed) {
          mExitingTokens.add(wtoken);
        }
 else         if (wtoken.windowType == TYPE_WALLPAPER) {
          mWallpaperTokens.remove(wtoken);
        }
      }
    }
 else {
      Log.w(TAG,"Attempted to remove non-existing token: " + token);
    }
  }
  Binder.restoreCallingIdentity(origId);
}
