{
  final int action=event.getAction();
  if (action == MotionEvent.ACTION_DOWN) {
    updateTouchFocusBeforeDownTd(event,policyFlags);
  }
 else {
    updateTouchFocusBeforeNonDownTd(event,policyFlags);
  }
  boolean skipDelivery=false;
  int touchTargetFlags=0;
  int injectionResult=InputManager.INPUT_EVENT_INJECTION_SUCCEEDED;
  WindowState focusedTouchTarget=mTouchFocus;
  if (focusedTouchTarget == null) {
    if (action != MotionEvent.ACTION_MOVE) {
      Slog.w(TAG,"No window to dispatch pointer action " + action);
      injectionResult=InputManager.INPUT_EVENT_INJECTION_FAILED;
    }
  }
 else {
    if (!checkInjectionPermissionTd(focusedTouchTarget,injectorPid,injectorUid)) {
      return InputManager.INPUT_EVENT_INJECTION_PERMISSION_DENIED;
    }
    wakeupIfNeeded(focusedTouchTarget,eventType(event));
    if ((focusedTouchTarget.mAttrs.flags & WindowManager.LayoutParams.FLAG_IGNORE_CHEEK_PRESSES) != 0) {
      boolean cheekPress=mPolicy.isCheekPressedAgainstScreen(event);
      if (cheekPress) {
        if ((action == MotionEvent.ACTION_DOWN)) {
          mFatTouch=true;
          skipDelivery=true;
        }
 else {
          if (!mFatTouch) {
            touchTargetFlags|=InputTarget.FLAG_CANCEL;
            mFatTouch=true;
          }
 else {
            skipDelivery=true;
          }
        }
      }
    }
  }
  if (!skipDelivery) {
    int outsideTargetCount=mOutsideTouchTargets.size();
    for (int i=0; i < outsideTargetCount; i++) {
      WindowState outsideTouchTarget=mOutsideTouchTargets.get(i);
      addInputTargetTd(inputTargets,outsideTouchTarget,InputTarget.FLAG_OUTSIDE | touchTargetFlags);
    }
    int wallpaperTargetCount=mWallpaperTouchTargets.size();
    for (int i=0; i < wallpaperTargetCount; i++) {
      WindowState wallpaperTouchTarget=mWallpaperTouchTargets.get(i);
      addInputTargetTd(inputTargets,wallpaperTouchTarget,touchTargetFlags);
    }
    if (focusedTouchTarget != null) {
      addInputTargetTd(inputTargets,focusedTouchTarget,InputTarget.FLAG_SYNC | touchTargetFlags);
    }
  }
  if (action == MotionEvent.ACTION_UP) {
    updateTouchFocusAfterUpTd(event,policyFlags);
  }
  return injectionResult;
}
