{
  boolean changed=false;
  Configuration config=null;
  long ident=Binder.clearCallingIdentity();
  try {
    int req=getOrientationFromWindowsLocked();
    if (req == ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED) {
      req=getOrientationFromAppTokensLocked();
    }
    if (req != mForcedAppOrientation) {
      changed=true;
      mForcedAppOrientation=req;
      mPolicy.setCurrentOrientation(req);
    }
    if (changed) {
      changed=setRotationUncheckedLocked(WindowManagerPolicy.USE_LAST_ROTATION);
      if (changed) {
        if (freezeThisOneIfNeeded != null) {
          AppWindowToken wtoken=findAppWindowToken(freezeThisOneIfNeeded);
          if (wtoken != null) {
            startAppFreezingScreenLocked(wtoken,ActivityInfo.CONFIG_ORIENTATION);
          }
        }
        return computeNewConfiguration();
      }
    }
  }
  finally {
    Binder.restoreCallingIdentity(ident);
  }
  return null;
}
