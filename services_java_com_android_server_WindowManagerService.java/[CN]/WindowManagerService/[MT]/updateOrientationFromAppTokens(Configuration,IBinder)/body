{
  if (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,"updateOrientationFromAppTokens()")) {
    throw new SecurityException("Requires MANAGE_APP_TOKENS permission");
  }
  Configuration config=null;
  long ident=Binder.clearCallingIdentity();
synchronized (mWindowMap) {
    if (updateOrientationFromAppTokensLocked()) {
      if (freezeThisOneIfNeeded != null) {
        AppWindowToken wtoken=findAppWindowToken(freezeThisOneIfNeeded);
        if (wtoken != null) {
          startAppFreezingScreenLocked(wtoken,ActivityInfo.CONFIG_ORIENTATION);
        }
      }
      config=computeNewConfigurationLocked();
    }
 else     if (currentConfig != null) {
      mTempConfiguration.setToDefaults();
      mTempConfiguration.fontScale=currentConfig.fontScale;
      if (computeNewConfigurationLocked(mTempConfiguration)) {
        if (currentConfig.diff(mTempConfiguration) != 0) {
          mWaitingForConfig=true;
          mLayoutNeeded=true;
          startFreezingDisplayLocked();
          config=new Configuration(mTempConfiguration);
        }
      }
    }
  }
  Binder.restoreCallingIdentity(ident);
  return config;
}
