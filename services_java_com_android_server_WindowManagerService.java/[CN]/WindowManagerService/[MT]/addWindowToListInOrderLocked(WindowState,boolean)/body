{
  final IWindow client=win.mClient;
  final WindowToken token=win.mToken;
  final ArrayList<WindowState> localmWindows=mWindows;
  final int N=localmWindows.size();
  final WindowState attached=win.mAttachedWindow;
  int i;
  if (attached == null) {
    int tokenWindowsPos=token.windows.size();
    if (token.appWindowToken != null) {
      int index=tokenWindowsPos - 1;
      if (index >= 0) {
        if (win.mAttrs.type == TYPE_BASE_APPLICATION) {
          placeWindowBefore(token.windows.get(0),win);
          tokenWindowsPos=0;
        }
 else {
          AppWindowToken atoken=win.mAppToken;
          if (atoken != null && token.windows.get(index) == atoken.startingWindow) {
            placeWindowBefore(token.windows.get(index),win);
            tokenWindowsPos--;
          }
 else {
            int newIdx=findIdxBasedOnAppTokens(win);
            if (newIdx != -1) {
              if (DEBUG_FOCUS || DEBUG_WINDOW_MOVEMENT)               Slog.v(TAG,"Adding window " + win + " at "+ (newIdx + 1)+ " of "+ N);
              localmWindows.add(newIdx + 1,win);
              mWindowsChanged=true;
            }
          }
        }
      }
 else {
        if (localLOGV)         Slog.v(TAG,"Figuring out where to add app window " + client.asBinder() + " (token="+ token+ ")");
        final int NA=mAppTokens.size();
        WindowState pos=null;
        for (i=NA - 1; i >= 0; i--) {
          AppWindowToken t=mAppTokens.get(i);
          if (t == token) {
            i--;
            break;
          }
          if (!t.sendingToBottom && t.windows.size() > 0) {
            pos=t.windows.get(0);
          }
        }
        if (pos != null) {
          WindowToken atoken=mTokenMap.get(pos.mClient.asBinder());
          if (atoken != null) {
            final int NC=atoken.windows.size();
            if (NC > 0) {
              WindowState bottom=atoken.windows.get(0);
              if (bottom.mSubLayer < 0) {
                pos=bottom;
              }
            }
          }
          placeWindowBefore(pos,win);
        }
 else {
          while (i >= 0) {
            AppWindowToken t=mAppTokens.get(i);
            final int NW=t.windows.size();
            if (NW > 0) {
              pos=t.windows.get(NW - 1);
              break;
            }
            i--;
          }
          if (pos != null) {
            WindowToken atoken=mTokenMap.get(pos.mClient.asBinder());
            if (atoken != null) {
              final int NC=atoken.windows.size();
              if (NC > 0) {
                WindowState top=atoken.windows.get(NC - 1);
                if (top.mSubLayer >= 0) {
                  pos=top;
                }
              }
            }
            placeWindowAfter(pos,win);
          }
 else {
            final int myLayer=win.mBaseLayer;
            for (i=0; i < N; i++) {
              WindowState w=localmWindows.get(i);
              if (w.mBaseLayer > myLayer) {
                break;
              }
            }
            if (DEBUG_FOCUS || DEBUG_WINDOW_MOVEMENT)             Slog.v(TAG,"Adding window " + win + " at "+ i+ " of "+ N);
            localmWindows.add(i,win);
            mWindowsChanged=true;
          }
        }
      }
    }
 else {
      final int myLayer=win.mBaseLayer;
      for (i=N - 1; i >= 0; i--) {
        if (localmWindows.get(i).mBaseLayer <= myLayer) {
          i++;
          break;
        }
      }
      if (i < 0)       i=0;
      if (DEBUG_FOCUS || DEBUG_WINDOW_MOVEMENT)       Slog.v(TAG,"Adding window " + win + " at "+ i+ " of "+ N);
      localmWindows.add(i,win);
      mWindowsChanged=true;
    }
    if (addToToken) {
      token.windows.add(tokenWindowsPos,win);
    }
  }
 else {
    final int NA=token.windows.size();
    final int sublayer=win.mSubLayer;
    int largestSublayer=Integer.MIN_VALUE;
    WindowState windowWithLargestSublayer=null;
    for (i=0; i < NA; i++) {
      WindowState w=token.windows.get(i);
      final int wSublayer=w.mSubLayer;
      if (wSublayer >= largestSublayer) {
        largestSublayer=wSublayer;
        windowWithLargestSublayer=w;
      }
      if (sublayer < 0) {
        if (wSublayer >= sublayer) {
          if (addToToken) {
            token.windows.add(i,win);
          }
          placeWindowBefore(wSublayer >= 0 ? attached : w,win);
          break;
        }
      }
 else {
        if (wSublayer > sublayer) {
          if (addToToken) {
            token.windows.add(i,win);
          }
          placeWindowBefore(w,win);
          break;
        }
      }
    }
    if (i >= NA) {
      if (addToToken) {
        token.windows.add(win);
      }
      if (sublayer < 0) {
        placeWindowBefore(attached,win);
      }
 else {
        placeWindowAfter(largestSublayer >= 0 ? windowWithLargestSublayer : attached,win);
      }
    }
  }
  if (win.mAppToken != null && addToToken) {
    win.mAppToken.allAppWindows.add(win);
  }
}
