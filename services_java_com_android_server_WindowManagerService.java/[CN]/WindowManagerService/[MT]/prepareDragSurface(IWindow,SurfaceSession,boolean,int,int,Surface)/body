{
  if (DEBUG_DRAG) {
    Slog.d(TAG,"prepare drag surface: w=" + width + " h="+ height+ " local="+ localOnly+ " win="+ window+ " asbinder="+ window.asBinder());
  }
  final int callerPid=Binder.getCallingPid();
  final long origId=Binder.clearCallingIdentity();
  IBinder token=null;
  try {
synchronized (mWindowMap) {
      try {
        if (mDragState == null) {
          Surface surface=new Surface(session,callerPid,"drag surface",0,width,height,PixelFormat.TRANSLUCENT,Surface.HIDDEN);
          outSurface.copyFrom(surface);
          final IBinder winBinder=window.asBinder();
          token=new Binder();
          mDragState=new DragState(token,surface,localOnly,winBinder);
          mDragState.mSurface=surface;
          mDragState.mLocalOnly=localOnly;
          token=mDragState.mToken=new Binder();
          mH.removeMessages(H.DRAG_START_TIMEOUT,winBinder);
          Message msg=mH.obtainMessage(H.DRAG_START_TIMEOUT,winBinder);
          mH.sendMessageDelayed(msg,5000);
        }
 else {
          Slog.w(TAG,"Drag already in progress");
        }
      }
 catch (      Surface.OutOfResourcesException e) {
        Slog.e(TAG,"Can't allocate drag surface w=" + width + " h="+ height,e);
        if (mDragState != null) {
          mDragState.reset();
          mDragState=null;
        }
      }
    }
  }
  finally {
    Binder.restoreCallingIdentity(origId);
  }
  return token;
}
