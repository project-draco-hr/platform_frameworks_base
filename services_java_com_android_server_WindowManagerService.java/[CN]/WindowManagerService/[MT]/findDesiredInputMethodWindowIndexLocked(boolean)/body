{
  final ArrayList localmWindows=mWindows;
  final int N=localmWindows.size();
  WindowState w=null;
  int i=N;
  while (i > 0) {
    i--;
    w=(WindowState)localmWindows.get(i);
    final int fl=w.mAttrs.flags & (FLAG_NOT_FOCUSABLE | FLAG_ALT_FOCUSABLE_IM);
    if (fl == 0 || fl == (FLAG_NOT_FOCUSABLE | FLAG_ALT_FOCUSABLE_IM)) {
      if (w.isVisibleOrAdding()) {
        break;
      }
    }
  }
  if (DEBUG_INPUT_METHOD)   Log.v(TAG,"Desired input method target=" + w + " willMove="+ willMove);
  if (willMove && w != null) {
    final WindowState curTarget=mInputMethodTarget;
    if (curTarget != null && curTarget.mAppToken != null) {
      int curIndex=-1;
      if (DEBUG_INPUT_METHOD)       Log.v(TAG,"mNextAppTransition=" + mNextAppTransition + " curTarget animating="+ curTarget.isAnimating()+ " layer="+ curTarget.mAnimLayer+ " new layer="+ w.mAnimLayer);
      if (mNextAppTransition != WindowManagerPolicy.TRANSIT_NONE) {
        mInputMethodTargetWaitingAnim=true;
        curIndex=localmWindows.indexOf(curTarget);
      }
 else       if (curTarget.isAnimating() && curTarget.mAnimLayer > w.mAnimLayer) {
        curIndex=localmWindows.indexOf(curTarget);
      }
      if (curIndex >= 0) {
        return curIndex + 1;
      }
    }
  }
  if (w != null) {
    if (willMove) {
      RuntimeException e=new RuntimeException();
      e.fillInStackTrace();
      if (DEBUG_INPUT_METHOD)       Log.w(TAG,"Moving IM target from " + mInputMethodTarget + " to "+ w,e);
      mInputMethodTarget=w;
      if (w.mAppToken != null) {
        setInputMethodAnimLayerAdjustment(w.mAppToken.animLayerAdjustment);
      }
 else {
        setInputMethodAnimLayerAdjustment(0);
      }
    }
    return i + 1;
  }
  if (willMove) {
    RuntimeException e=new RuntimeException();
    e.fillInStackTrace();
    if (DEBUG_INPUT_METHOD)     Log.w(TAG,"Moving IM target from " + mInputMethodTarget + " to null",e);
    mInputMethodTarget=null;
    setInputMethodAnimLayerAdjustment(0);
  }
  return -1;
}
