{
  final ArrayList localmWindows=mWindows;
  final int N=localmWindows.size();
  WindowState w=null;
  int i=N;
  while (i > 0) {
    i--;
    w=(WindowState)localmWindows.get(i);
    final int fl=w.mAttrs.flags & (FLAG_NOT_FOCUSABLE | FLAG_ALT_FOCUSABLE_IM);
    if (fl == 0 || fl == (FLAG_NOT_FOCUSABLE | FLAG_ALT_FOCUSABLE_IM)) {
      if (w.isVisibleOrAdding()) {
        break;
      }
    }
  }
  if (DEBUG_INPUT_METHOD)   Log.v(TAG,"Desired input method target=" + w + " willMove="+ willMove);
  if (willMove && w != null) {
    final WindowState curTarget=mInputMethodTarget;
    if (curTarget != null && curTarget.mAppToken != null) {
      AppWindowToken token=curTarget.mAppToken;
      WindowState highestTarget=null;
      int highestPos=0;
      if (token.animating || token.animation != null) {
        int pos=0;
        pos=localmWindows.indexOf(curTarget);
        while (pos >= 0) {
          WindowState win=(WindowState)localmWindows.get(pos);
          if (win.mAppToken != token) {
            break;
          }
          if (!win.mRemoved) {
            if (highestTarget == null || win.mAnimLayer > highestTarget.mAnimLayer) {
              highestTarget=win;
              highestPos=pos;
            }
          }
          pos--;
        }
      }
      if (highestTarget != null) {
        if (DEBUG_INPUT_METHOD)         Log.v(TAG,"mNextAppTransition=" + mNextAppTransition + " "+ highestTarget+ " animating="+ highestTarget.isAnimating()+ " layer="+ highestTarget.mAnimLayer+ " new layer="+ w.mAnimLayer);
        if (mNextAppTransition != WindowManagerPolicy.TRANSIT_NONE) {
          mInputMethodTargetWaitingAnim=true;
          mInputMethodTarget=highestTarget;
          return highestPos + 1;
        }
 else         if (highestTarget.isAnimating() && highestTarget.mAnimLayer > w.mAnimLayer) {
          mInputMethodTarget=highestTarget;
          return highestPos + 1;
        }
      }
    }
  }
  if (w != null) {
    if (willMove) {
      RuntimeException e=new RuntimeException();
      e.fillInStackTrace();
      if (DEBUG_INPUT_METHOD)       Log.w(TAG,"Moving IM target from " + mInputMethodTarget + " to "+ w,e);
      mInputMethodTarget=w;
      if (w.mAppToken != null) {
        setInputMethodAnimLayerAdjustment(w.mAppToken.animLayerAdjustment);
      }
 else {
        setInputMethodAnimLayerAdjustment(0);
      }
    }
    return i + 1;
  }
  if (willMove) {
    RuntimeException e=new RuntimeException();
    e.fillInStackTrace();
    if (DEBUG_INPUT_METHOD)     Log.w(TAG,"Moving IM target from " + mInputMethodTarget + " to null",e);
    mInputMethodTarget=null;
    setInputMethodAnimLayerAdjustment(0);
  }
  return -1;
}
