{
  if (localLOGV || DEBUG_FOCUS)   Slog.v(TAG,"Remove " + win + " client="+ Integer.toHexString(System.identityHashCode(win.mClient.asBinder()))+ ", surface="+ win.mSurface);
  final long origId=Binder.clearCallingIdentity();
  win.disposeInputChannel();
  if (DEBUG_APP_TRANSITIONS)   Slog.v(TAG,"Remove " + win + ": mSurface="+ win.mSurface+ " mExiting="+ win.mExiting+ " isAnimating="+ win.isAnimating()+ " app-animation="+ (win.mAppToken != null ? win.mAppToken.animation : null)+ " inPendingTransaction="+ (win.mAppToken != null ? win.mAppToken.inPendingTransaction : false)+ " mDisplayFrozen="+ mDisplayFrozen);
  boolean wasVisible=false;
  if (win.mSurface != null && !mDisplayFrozen && mPolicy.isScreenOn()) {
    if (wasVisible=win.isWinVisibleLw()) {
      int transit=WindowManagerPolicy.TRANSIT_EXIT;
      if (win.getAttrs().type == TYPE_APPLICATION_STARTING) {
        transit=WindowManagerPolicy.TRANSIT_PREVIEW_DONE;
      }
      if (applyAnimationLocked(win,transit,false)) {
        win.mExiting=true;
      }
    }
    if (win.mExiting || win.isAnimating()) {
      win.mExiting=true;
      win.mRemoveOnExit=true;
      mLayoutNeeded=true;
      updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,false);
      performLayoutAndPlaceSurfacesLocked();
      mInputMonitor.updateInputWindowsLw(false);
      if (win.mAppToken != null) {
        win.mAppToken.updateReportedVisibilityLocked();
      }
      Binder.restoreCallingIdentity(origId);
      return;
    }
  }
  removeWindowInnerLocked(session,win);
  if (wasVisible && computeForcedAppOrientationLocked() != mForcedAppOrientation && updateOrientationFromAppTokensLocked(false)) {
    mH.sendEmptyMessage(H.SEND_NEW_CONFIGURATION);
  }
  updateFocusedWindowLocked(UPDATE_FOCUS_NORMAL,true);
  Binder.restoreCallingIdentity(origId);
}
