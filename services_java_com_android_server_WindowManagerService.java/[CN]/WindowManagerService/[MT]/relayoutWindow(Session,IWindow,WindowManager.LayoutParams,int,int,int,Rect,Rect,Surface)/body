{
  boolean displayed=false;
  boolean inTouchMode;
  long origId=Binder.clearCallingIdentity();
synchronized (mWindowMap) {
    WindowState win=windowForClientLocked(session,client);
    if (win == null) {
      return 0;
    }
    win.mRequestedWidth=requestedWidth;
    win.mRequestedHeight=requestedHeight;
    if (attrs != null) {
      mPolicy.adjustWindowParamsLw(attrs);
    }
    boolean windowfocusabilityChanged=attrs != null && ((attrs.flags & WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE) != (win.mAttrs.flags & WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE));
    int attrChanges=0;
    if (attrs != null)     attrChanges=win.mAttrs.copyFrom(attrs);
    if (localLOGV)     Log.v(TAG,"Relayout given client " + client.asBinder() + " ("+ win.mAttrs.getTitle()+ ")");
    if ((attrChanges & WindowManager.LayoutParams.ALPHA_CHANGED) != 0) {
      win.mAlpha=attrs.alpha;
    }
    final boolean scaledWindow=((win.mAttrs.flags & WindowManager.LayoutParams.FLAG_SCALED) != 0);
    if (scaledWindow) {
      win.mHScale=(attrs.width != requestedWidth) ? (attrs.width / (float)requestedWidth) : 1.0f;
      win.mVScale=(attrs.height != requestedHeight) ? (attrs.height / (float)requestedHeight) : 1.0f;
    }
    boolean focusMayChange=win.mViewVisibility != viewVisibility || windowfocusabilityChanged || (!win.mRelayoutCalled);
    win.mRelayoutCalled=true;
    win.mViewVisibility=viewVisibility;
    if (viewVisibility == View.VISIBLE && (win.mAppToken == null || !win.mAppToken.clientHidden)) {
      displayed=!win.isVisible();
      if (win.mExiting) {
        win.mExiting=false;
        win.mAnimation=null;
      }
      if (win.mDestroying) {
        win.mDestroying=false;
        mDestroySurface.remove(win);
      }
      if (displayed && win.mSurface != null && !win.mDrawPending && !win.mCommitDrawPending && !mDisplayFrozen) {
        applyEnterAnimationLocked(win);
      }
      try {
        Surface surface=win.createSurfaceLocked();
        if (surface != null) {
          outSurface.copyFrom(surface);
        }
 else {
          outSurface.clear();
        }
      }
 catch (      Exception e) {
        Log.w(TAG,"Exception thrown when creating surface for client " + client + " ("+ win.mAttrs.getTitle()+ ")",e);
        Binder.restoreCallingIdentity(origId);
        return 0;
      }
      if (displayed) {
        focusMayChange=true;
      }
    }
 else {
      if (win.mSurface != null) {
        if (!win.mExiting) {
          int transit=WindowManagerPolicy.TRANSIT_EXIT;
          if (win.getAttrs().type == TYPE_APPLICATION_STARTING) {
            transit=WindowManagerPolicy.TRANSIT_PREVIEW_DONE;
          }
          if (!win.mExiting && !win.mDrawPending && applyAnimationLocked(win,transit,false)) {
            win.mExiting=true;
            mKeyWaiter.finishedKey(session,client,true,KeyWaiter.RETURN_NOTHING);
          }
 else           if (win.isAnimating()) {
            win.mExiting=true;
          }
 else {
            win.destroySurfaceLocked();
          }
        }
      }
      outSurface.clear();
    }
    mLayoutNeeded=true;
    performLayoutAndPlaceSurfacesLocked();
    if (win.mAppToken != null) {
      win.mAppToken.updateReportedVisibilityLocked();
    }
    outFrame.set(win.mFrame);
    outCoveredInsets.set(win.mCoveredInsets);
    if (localLOGV)     Log.v(TAG,"Relayout given client " + client.asBinder() + ", requestedWidth="+ requestedWidth+ ", requestedHeight="+ requestedHeight+ ", viewVisibility="+ viewVisibility+ "\nRelayout returning frame="+ outFrame+ ", surface="+ outSurface);
    if (localLOGV || DEBUG_FOCUS)     Log.v(TAG,"Relayout of " + win + ": focusMayChange="+ focusMayChange);
    if (focusMayChange) {
      updateFocusedWindowLocked();
    }
    inTouchMode=mInTouchMode;
  }
  Binder.restoreCallingIdentity(origId);
  return (inTouchMode ? WindowManagerImpl.RELAYOUT_IN_TOUCH_MODE : 0) | (displayed ? WindowManagerImpl.RELAYOUT_FIRST_TIME : 0);
}
