{
  if (!isSystemRule(automaticZenRule)) {
    ServiceInfo owner=getServiceInfo(automaticZenRule.getOwner());
    if (owner == null) {
      throw new IllegalArgumentException("Owner is not a condition provider service");
    }
    int ruleInstanceLimit=-1;
    if (owner.metaData != null) {
      ruleInstanceLimit=owner.metaData.getInt(ConditionProviderService.META_DATA_RULE_INSTANCE_LIMIT,-1);
    }
    if (ruleInstanceLimit > 0 && ruleInstanceLimit < (getCurrentInstanceCount(automaticZenRule.getOwner()) + 1)) {
      throw new IllegalArgumentException("Rule instance limit exceeded");
    }
  }
  ZenModeConfig newConfig;
synchronized (mConfig) {
    if (mConfig == null) {
      throw new AndroidRuntimeException("Could not create rule");
    }
    if (DEBUG) {
      Log.d(TAG,"addAutomaticZenRule rule= " + automaticZenRule + " reason="+ reason);
    }
    newConfig=mConfig.copy();
    ZenRule rule=new ZenRule();
    populateZenRule(automaticZenRule,rule,true);
    newConfig.automaticRules.put(rule.id,rule);
    if (setConfigLocked(newConfig,reason,true)) {
      return rule.id;
    }
 else {
      throw new AndroidRuntimeException("Could not create rule");
    }
  }
}
