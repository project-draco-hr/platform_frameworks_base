{
  final int mode=Global.getInt(mContext.getContentResolver(),Global.ZEN_MODE,Global.ZEN_MODE_OFF);
  if (mode != mZenMode) {
    ZenLog.traceUpdateZenMode(mZenMode,mode);
  }
  mZenMode=mode;
  final boolean zen=mZenMode != Global.ZEN_MODE_OFF;
  final String[] exceptionPackages=null;
  final boolean muteCalls=zen && !mConfig.allowCalls;
  mAppOps.setRestriction(AppOpsManager.OP_VIBRATE,USAGE_NOTIFICATION_RINGTONE,muteCalls ? AppOpsManager.MODE_IGNORED : AppOpsManager.MODE_ALLOWED,exceptionPackages);
  mAppOps.setRestriction(AppOpsManager.OP_PLAY_AUDIO,USAGE_NOTIFICATION_RINGTONE,muteCalls ? AppOpsManager.MODE_IGNORED : AppOpsManager.MODE_ALLOWED,exceptionPackages);
  final boolean muteAlarms=mZenMode == Global.ZEN_MODE_NO_INTERRUPTIONS;
  mAppOps.setRestriction(AppOpsManager.OP_VIBRATE,USAGE_ALARM,muteAlarms ? AppOpsManager.MODE_IGNORED : AppOpsManager.MODE_ALLOWED,exceptionPackages);
  mAppOps.setRestriction(AppOpsManager.OP_PLAY_AUDIO,USAGE_ALARM,muteAlarms ? AppOpsManager.MODE_IGNORED : AppOpsManager.MODE_ALLOWED,exceptionPackages);
  if (mAudioManager != null) {
    int ringerMode=mAudioManager.getRingerMode();
    int forcedRingerMode=-1;
    if (mZenMode == Global.ZEN_MODE_NO_INTERRUPTIONS) {
      if (ringerMode != AudioManager.RINGER_MODE_SILENT) {
        mPreviousRingerMode=ringerMode;
        if (DEBUG)         Slog.d(TAG,"Silencing ringer");
        forcedRingerMode=AudioManager.RINGER_MODE_SILENT;
      }
    }
 else {
      if (ringerMode == AudioManager.RINGER_MODE_SILENT) {
        if (DEBUG)         Slog.d(TAG,"Unsilencing ringer");
        forcedRingerMode=mPreviousRingerMode != -1 ? mPreviousRingerMode : AudioManager.RINGER_MODE_NORMAL;
        mPreviousRingerMode=-1;
      }
    }
    if (forcedRingerMode != -1) {
      mAudioManager.setRingerMode(forcedRingerMode);
      ZenLog.traceSetRingerMode(forcedRingerMode);
    }
  }
  dispatchOnZenModeChanged();
}
