{
  if (ImmersiveModeTesting.enabled) {
    vis=ImmersiveModeTesting.applyForced(mFocusedWindow,vis);
  }
  boolean statusBarHasFocus=mFocusedWindow.getAttrs().type == TYPE_STATUS_BAR;
  if (statusBarHasFocus) {
    int flags=View.SYSTEM_UI_FLAG_FULLSCREEN | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_ALLOW_TRANSIENT;
    vis=(vis & ~flags) | (mLastSystemUiFlags & flags);
  }
  if (mStatusTransientBar == TRANSIENT_BAR_SHOWING) {
    boolean transientAllowed=(vis & View.SYSTEM_UI_FLAG_ALLOW_TRANSIENT) != 0;
    boolean hideStatusBarWM=(mFocusedWindow.getAttrs().flags & WindowManager.LayoutParams.FLAG_FULLSCREEN) != 0;
    boolean hideStatusBarSysui=(vis & View.SYSTEM_UI_FLAG_FULLSCREEN) != 0;
    boolean transientStatusBarAllowed=hideStatusBarWM || (hideStatusBarSysui && transientAllowed) || statusBarHasFocus;
    if (mStatusBar == null || !transientStatusBarAllowed) {
      mStatusTransientBar=TRANSIENT_BAR_NONE;
      if (mStatusBar != null && hideStatusBarSysui) {
        int newVal=mResettingSystemUiFlags | View.SYSTEM_UI_CLEARABLE_FLAGS;
        if (newVal != mResettingSystemUiFlags) {
          mResettingSystemUiFlags=newVal;
          mWindowManagerFuncs.reevaluateStatusBarVisibility();
        }
      }
    }
 else {
      vis|=View.STATUS_BAR_TRANSIENT;
      if ((mLastSystemUiFlags & View.STATUS_BAR_TRANSIENT) == 0) {
        vis&=~View.SYSTEM_UI_FLAG_LOW_PROFILE;
        setBarShowingLw(mStatusBar,true);
      }
    }
  }
  boolean oldTransientNav=isNavigationBarTransient(oldVis);
  boolean isTransientNav=isNavigationBarTransient(vis);
  if (mFocusedWindow != null && oldTransientNav != isTransientNav) {
    final int uid=getCurrentUserId();
    final String pkg=mFocusedWindow.getOwningPackage();
    mTransientNavigationConfirmation.transientNavigationChanged(uid,pkg,isTransientNav);
  }
  if (mNavigationTransientBar == TRANSIENT_BAR_SHOWING) {
    if (!isTransientNav) {
      mNavigationTransientBar=TRANSIENT_BAR_NONE;
    }
 else {
      vis|=View.NAVIGATION_BAR_TRANSIENT;
      if ((mLastSystemUiFlags & View.NAVIGATION_BAR_TRANSIENT) == 0) {
        setBarShowingLw(mNavigationBar,true);
      }
    }
  }
  if (mStatusTransientBar != TRANSIENT_BAR_NONE || mNavigationTransientBar != TRANSIENT_BAR_NONE) {
    vis&=~View.SYSTEM_UI_FLAG_LOW_PROFILE;
  }
  return vis;
}
