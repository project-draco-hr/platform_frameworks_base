{
  if (mFocusedWindow == null) {
    return 0;
  }
  final int visibility=mFocusedWindow.getSystemUiVisibility() & ~mResettingSystemUiFlags & ~mForceClearedSystemUiFlags;
  int diff=visibility ^ mLastSystemUiFlags;
  final boolean needsMenu=(mFocusedWindow.getAttrs().flags & WindowManager.LayoutParams.FLAG_NEEDS_MENU_KEY) != 0;
  if (diff == 0 && mLastFocusNeedsMenu == needsMenu && mFocusedApp == mFocusedWindow.getAppToken()) {
    return 0;
  }
  mLastSystemUiFlags=visibility;
  mLastFocusNeedsMenu=needsMenu;
  mFocusedApp=mFocusedWindow.getAppToken();
  mHandler.post(new Runnable(){
    public void run(){
      if (mStatusBarService == null) {
        mStatusBarService=IStatusBarService.Stub.asInterface(ServiceManager.getService("statusbar"));
      }
      if (mStatusBarService != null) {
        try {
          mStatusBarService.setSystemUiVisibility(visibility);
          mStatusBarService.topAppWindowChanged(needsMenu);
        }
 catch (        RemoteException e) {
          mStatusBarService=null;
        }
      }
    }
  }
);
  return diff;
}
