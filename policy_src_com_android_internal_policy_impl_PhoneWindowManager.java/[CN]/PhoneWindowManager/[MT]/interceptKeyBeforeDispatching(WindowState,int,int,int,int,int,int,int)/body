{
  final boolean keyguardOn=keyguardOn();
  final boolean down=(action == KeyEvent.ACTION_DOWN);
  final boolean canceled=((flags & KeyEvent.FLAG_CANCELED) != 0);
  if (false) {
    Log.d(TAG,"interceptKeyTi keyCode=" + keyCode + " down="+ down+ " repeatCount="+ repeatCount+ " keyguardOn="+ keyguardOn+ " mHomePressed="+ mHomePressed);
  }
  if ((keyCode == KeyEvent.KEYCODE_HOME) && !down) {
    mHandler.removeCallbacks(mHomeLongPress);
  }
  if (mHomePressed) {
    if (keyCode == KeyEvent.KEYCODE_HOME) {
      if (!down) {
        mHomePressed=false;
        if (!canceled) {
          boolean incomingRinging=false;
          try {
            ITelephony telephonyService=getTelephonyService();
            if (telephonyService != null) {
              incomingRinging=telephonyService.isRinging();
            }
          }
 catch (          RemoteException ex) {
            Log.w(TAG,"RemoteException from getPhoneInterface()",ex);
          }
          if (incomingRinging) {
            Log.i(TAG,"Ignoring HOME; there's a ringing incoming call.");
          }
 else {
            launchHomeFromHotKey();
          }
        }
 else {
          Log.i(TAG,"Ignoring HOME; event canceled.");
        }
      }
    }
    return true;
  }
  if (keyCode == KeyEvent.KEYCODE_HOME) {
    WindowManager.LayoutParams attrs=win != null ? win.getAttrs() : null;
    if (attrs != null) {
      final int type=attrs.type;
      if (type == WindowManager.LayoutParams.TYPE_KEYGUARD || type == WindowManager.LayoutParams.TYPE_KEYGUARD_DIALOG) {
        return false;
      }
      final int typeCount=WINDOW_TYPES_WHERE_HOME_DOESNT_WORK.length;
      for (int i=0; i < typeCount; i++) {
        if (type == WINDOW_TYPES_WHERE_HOME_DOESNT_WORK[i]) {
          return true;
        }
      }
    }
    if (down && repeatCount == 0) {
      if (!keyguardOn) {
        mHandler.postDelayed(mHomeLongPress,ViewConfiguration.getGlobalActionKeyTimeout());
      }
      mHomePressed=true;
    }
    return true;
  }
 else   if (keyCode == KeyEvent.KEYCODE_MENU) {
    final int chordBug=KeyEvent.META_SHIFT_ON;
    if (down && repeatCount == 0) {
      if (mEnableShiftMenuBugReports && (metaState & chordBug) == chordBug) {
        Intent intent=new Intent(Intent.ACTION_BUG_REPORT);
        mContext.sendOrderedBroadcast(intent,null);
        return true;
      }
 else       if (SHOW_PROCESSES_ON_ALT_MENU && (metaState & KeyEvent.META_ALT_ON) == KeyEvent.META_ALT_ON) {
        Intent service=new Intent();
        service.setClassName(mContext,"com.android.server.LoadAverageService");
        ContentResolver res=mContext.getContentResolver();
        boolean shown=Settings.System.getInt(res,Settings.System.SHOW_PROCESSES,0) != 0;
        if (!shown) {
          mContext.startService(service);
        }
 else {
          mContext.stopService(service);
        }
        Settings.System.putInt(res,Settings.System.SHOW_PROCESSES,shown ? 0 : 1);
        return true;
      }
    }
  }
 else   if (keyCode == KeyEvent.KEYCODE_SEARCH) {
    if (down) {
      if (repeatCount == 0) {
        mSearchKeyPressed=true;
      }
    }
 else {
      mSearchKeyPressed=false;
      if (mConsumeSearchKeyUp) {
        mConsumeSearchKeyUp=false;
        return true;
      }
    }
  }
  if (mSearchKeyPressed) {
    if (down && repeatCount == 0 && !keyguardOn) {
      Intent shortcutIntent=mShortcutManager.getIntent(keyCode,metaState);
      if (shortcutIntent != null) {
        shortcutIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        mContext.startActivity(shortcutIntent);
        mConsumeSearchKeyUp=true;
        return true;
      }
    }
  }
  return false;
}
