{
  if (ImmersiveModeTesting.enabled) {
    vis=ImmersiveModeTesting.applyForced(mFocusedWindow,vis);
  }
  boolean statusBarHasFocus=mFocusedWindow.getAttrs().type == TYPE_STATUS_BAR;
  if (statusBarHasFocus) {
    int flags=View.SYSTEM_UI_FLAG_FULLSCREEN | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_IMMERSIVE;
    vis=(vis & ~flags) | (mLastSystemUiFlags & flags);
  }
  boolean transientAllowed=(vis & View.SYSTEM_UI_FLAG_IMMERSIVE) != 0;
  boolean hideStatusBarWM=(mFocusedWindow.getAttrs().flags & WindowManager.LayoutParams.FLAG_FULLSCREEN) != 0;
  boolean hideStatusBarSysui=(vis & View.SYSTEM_UI_FLAG_FULLSCREEN) != 0;
  boolean transientStatusBarAllowed=mStatusBar != null && (hideStatusBarWM || (hideStatusBarSysui && transientAllowed) || statusBarHasFocus);
  if (mStatusBarController.isTransientShowing() && !transientStatusBarAllowed && hideStatusBarSysui) {
    int newVal=mResettingSystemUiFlags | View.SYSTEM_UI_CLEARABLE_FLAGS;
    if (newVal != mResettingSystemUiFlags) {
      mResettingSystemUiFlags=newVal;
      mWindowManagerFuncs.reevaluateStatusBarVisibility();
    }
  }
  vis=mStatusBarController.updateVisibilityLw(transientStatusBarAllowed,oldVis,vis);
  boolean oldTransientNav=isTransientNavigationAllowed(oldVis);
  boolean isTransientNav=isTransientNavigationAllowed(vis);
  if (mFocusedWindow != null && oldTransientNav != isTransientNav) {
    final int uid=getCurrentUserId();
    final String pkg=mFocusedWindow.getOwningPackage();
    mTransientNavigationConfirmation.transientNavigationChanged(uid,pkg,isTransientNav);
  }
  vis=mNavigationBarController.updateVisibilityLw(isTransientNav,oldVis,vis);
  if (mStatusBarController.isHidden() && mNavigationBarController.isHidden()) {
    vis&=~View.SYSTEM_UI_FLAG_LOW_PROFILE;
  }
  return vis;
}
