{
  HttpURLConnection urlConnection=null;
  if (!mIsCaptivePortalCheckEnabled)   return false;
  mUrl="http://" + server.getHostAddress() + "/generate_204";
  if (DBG)   log("Checking " + mUrl);
  long requestTimestamp=-1;
  try {
    URL url=new URL(mUrl);
    urlConnection=(HttpURLConnection)url.openConnection();
    urlConnection.setInstanceFollowRedirects(false);
    urlConnection.setConnectTimeout(SOCKET_TIMEOUT_MS);
    urlConnection.setReadTimeout(SOCKET_TIMEOUT_MS);
    urlConnection.setUseCaches(false);
    requestTimestamp=SystemClock.elapsedRealtime();
    urlConnection.getInputStream();
    long responseTimestamp=SystemClock.elapsedRealtime();
    int rspCode=urlConnection.getResponseCode();
    boolean isCaptivePortal=rspCode != 204;
    sendNetworkConditionsBroadcast(true,isCaptivePortal,requestTimestamp,responseTimestamp);
    if (DBG)     log("isCaptivePortal: ret=" + isCaptivePortal + " rspCode="+ rspCode);
    return isCaptivePortal;
  }
 catch (  IOException e) {
    if (DBG)     log("Probably not a portal: exception " + e);
    if (requestTimestamp != -1) {
      sendFailedCaptivePortalCheckBroadcast(requestTimestamp);
    }
    return false;
  }
 finally {
    if (urlConnection != null) {
      urlConnection.disconnect();
    }
  }
}
