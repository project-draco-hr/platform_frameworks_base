{
  if (mShuttingDown) {
    return;
  }
synchronized (mPendingWriteLock) {
    long now=SystemClock.uptimeMillis();
    mPendingWrite=Parcel.obtain();
    mState.mTimePeriodEnd=System.currentTimeMillis();
    mState.writeToParcel(mPendingWrite);
    mLastWriteTime=SystemClock.uptimeMillis();
    Slog.i(TAG,"Prepared write state in " + (SystemClock.uptimeMillis() - now) + "ms");
    if (!sync) {
      BackgroundThread.getHandler().post(new Runnable(){
        @Override public void run(){
          commitWriteState();
        }
      }
);
      return;
    }
  }
  commitWriteState();
}
