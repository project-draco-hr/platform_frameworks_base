{
  if (mCurState != state) {
    if (mCurState != STATE_NOTHING) {
      long dur=now - mStartTime;
      int idx=State.binarySearch(mDurationsTable,mDurationsTableSize,mCurState);
      int off;
      if (idx >= 0) {
        off=mDurationsTable[idx];
      }
 else {
        mState.mFindTable=mDurationsTable;
        mState.mFindTableSize=mDurationsTableSize;
        off=mState.addLongData(~idx,mCurState,1);
        mDurationsTable=mState.mFindTable;
        mDurationsTableSize=mState.mFindTableSize;
      }
      long[] longs=mState.mLongs.get((off >> OFFSET_ARRAY_SHIFT) & OFFSET_ARRAY_MASK);
      longs[(off >> OFFSET_INDEX_SHIFT) & OFFSET_INDEX_MASK]+=dur;
    }
    mCurState=state;
    mStartTime=now;
  }
}
