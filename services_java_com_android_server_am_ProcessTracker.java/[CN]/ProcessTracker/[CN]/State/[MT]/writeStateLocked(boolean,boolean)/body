{
synchronized (mPendingWriteLock) {
    long now=SystemClock.uptimeMillis();
    if (mPendingWrite == null || !mPendingWriteCommitted) {
      mPendingWrite=Parcel.obtain();
      mTimePeriodEndRealtime=SystemClock.elapsedRealtime();
      if (commit) {
        mFlags|=State.FLAG_COMPLETE;
      }
      writeToParcel(mPendingWrite);
      mPendingWriteFile=new AtomicFile(mFile.getBaseFile());
      mPendingWriteCommitted=commit;
    }
    if (commit) {
      resetSafely();
    }
 else {
      mLastWriteTime=SystemClock.uptimeMillis();
    }
    Slog.i(TAG,"Prepared write state in " + (SystemClock.uptimeMillis() - now) + "ms");
    if (!sync) {
      BackgroundThread.getHandler().post(new Runnable(){
        @Override public void run(){
          performWriteState();
        }
      }
);
      return;
    }
  }
  performWriteState();
}
