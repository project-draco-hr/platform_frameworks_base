{
  File temp=null;
  OutputStream output=null;
  try {
    if ((flags & DropBoxEntry.IS_EMPTY) != 0)     throw new IllegalArgumentException();
    init();
    if (!isTagEnabled(tag))     return;
    long max=trimToFit();
    long lastTrim=System.currentTimeMillis();
    byte[] buffer=new byte[mBlockSize];
    FileInputStream input=new FileInputStream(data.getFileDescriptor());
    int read=0;
    while (read < buffer.length) {
      int n=input.read(buffer,read,buffer.length - read);
      if (n <= 0)       break;
      read+=n;
    }
    temp=new File(mDropBoxDir,"drop" + Thread.currentThread().getId() + ".tmp");
    output=new FileOutputStream(temp);
    if (read == buffer.length && ((flags & DropBoxEntry.IS_GZIPPED) == 0)) {
      output=new GZIPOutputStream(output);
      flags=flags | DropBoxEntry.IS_GZIPPED;
    }
    do {
      output.write(buffer,0,read);
      long now=System.currentTimeMillis();
      if (now - lastTrim > 30 * 1000) {
        max=trimToFit();
        lastTrim=now;
      }
      read=input.read(buffer);
      if (read <= 0) {
        output.close();
        output=null;
      }
 else {
        output.flush();
      }
      long len=temp.length();
      if (len > max) {
        Log.w(TAG,"Dropping: " + tag + " ("+ temp.length()+ " > "+ max+ " bytes)");
        temp.delete();
        temp=null;
        break;
      }
    }
 while (read > 0);
    createEntry(temp,tag,flags);
    temp=null;
  }
 catch (  IOException e) {
    Log.e(TAG,"Can't write: " + tag,e);
  }
 finally {
    try {
      if (output != null)       output.close();
    }
 catch (    IOException e) {
    }
    try {
      data.close();
    }
 catch (    IOException e) {
    }
    if (temp != null)     temp.delete();
  }
}
