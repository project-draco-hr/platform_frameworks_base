{
  if (mWifiOnlyFlag) {
    Log.v(LOG_TAG,this.getName() + " is excluded for wifi-only test");
    return;
  }
  assertNotNull("SSID is null",mTestAccessPoint);
  log("Enable airplane mode");
  cmActivity.setAirplaneMode(getInstrumentation().getContext(),true);
  NetworkInfo networkInfo;
  if (!mWifiOnlyFlag) {
    assertTrue(cmActivity.waitForNetworkState(ConnectivityManager.TYPE_MOBILE,State.DISCONNECTED,ConnectivityManagerTestActivity.LONG_TIMEOUT));
    networkInfo=cmActivity.mCM.getNetworkInfo(ConnectivityManager.TYPE_MOBILE);
    cmActivity.setStateTransitionCriteria(ConnectivityManager.TYPE_MOBILE,networkInfo.getState(),NetworkState.DO_NOTHING,State.DISCONNECTED);
  }
  networkInfo=cmActivity.mCM.getNetworkInfo(ConnectivityManager.TYPE_WIFI);
  cmActivity.setStateTransitionCriteria(ConnectivityManager.TYPE_WIFI,networkInfo.getState(),NetworkState.TO_CONNECTION,State.CONNECTED);
  assertTrue("failed to connect to " + mTestAccessPoint,cmActivity.connectToWifi(mTestAccessPoint));
  assertTrue(cmActivity.waitForNetworkState(ConnectivityManager.TYPE_WIFI,State.CONNECTED,ConnectivityManagerTestActivity.WIFI_CONNECTION_TIMEOUT));
  if (!cmActivity.validateNetworkStates(ConnectivityManager.TYPE_WIFI)) {
    log("state validate for Wifi failed");
    log("reason: " + cmActivity.getTransitionFailureReason(ConnectivityManager.TYPE_WIFI));
    assertTrue("State validation failed",false);
  }
  if (!mWifiOnlyFlag) {
    if (!cmActivity.validateNetworkStates(ConnectivityManager.TYPE_MOBILE)) {
      log("state validation for Mobile failed");
      log("reason: " + cmActivity.getTransitionFailureReason(ConnectivityManager.TYPE_MOBILE));
      assertTrue("state validation failed",false);
    }
  }
  cmActivity.setAirplaneMode(getInstrumentation().getContext(),false);
}
