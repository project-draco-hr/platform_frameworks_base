{
synchronized (mInterfaceLock) {
    if (DEBUG) {
      Log.d(TAG,"createCaptureSessionInternal");
    }
    checkIfCameraClosedOrInError();
    if (isConstrainedHighSpeed && inputConfig != null) {
      throw new IllegalArgumentException("Constrained high speed session doesn't support" + " input configuration yet.");
    }
    if (mCurrentSession != null) {
      mCurrentSession.replaceSessionClose();
    }
    boolean configureSuccess=true;
    CameraAccessException pendingException=null;
    Surface input=null;
    try {
      configureSuccess=configureStreamsChecked(inputConfig,outputConfigurations,isConstrainedHighSpeed);
      if (configureSuccess == true && inputConfig != null) {
        input=mRemoteDevice.getInputSurface();
      }
    }
 catch (    CameraAccessException e) {
      configureSuccess=false;
      pendingException=e;
      input=null;
      if (DEBUG) {
        Log.v(TAG,"createCaptureSession - failed with exception ",e);
      }
    }
    List<Surface> outSurfaces=new ArrayList<>(outputConfigurations.size());
    for (    OutputConfiguration config : outputConfigurations) {
      outSurfaces.add(config.getSurface());
    }
    CameraCaptureSessionCore newSession=null;
    if (isConstrainedHighSpeed) {
      newSession=new CameraConstrainedHighSpeedCaptureSessionImpl(mNextSessionId++,outSurfaces,callback,handler,this,mDeviceHandler,configureSuccess,mCharacteristics);
    }
 else {
      newSession=new CameraCaptureSessionImpl(mNextSessionId++,input,outSurfaces,callback,handler,this,mDeviceHandler,configureSuccess);
    }
    mCurrentSession=newSession;
    if (pendingException != null) {
      throw pendingException;
    }
    mSessionStateCallback=mCurrentSession.getDeviceStateCallback();
  }
}
