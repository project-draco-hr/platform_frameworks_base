{
  FileOutputStream fos=null;
  try {
    fos=mHistoryFile.startWrite();
    XmlSerializer out=new FastXmlSerializer();
    out.setOutput(fos,"utf-8");
    out.startDocument(null,true);
    out.setFeature("http://xmlpull.org/v1/doc/features.html#indent-output",true);
    out.startTag(null,"usage-history");
synchronized (mStatsLock) {
      int NP=mStats.mPackages.size();
      for (int i=0; i < NP; i++) {
        UsageStats.PackageStats ps=mStats.mPackages.valueAt(i);
        out.startTag(null,"pkg");
        out.attribute(null,"name",ps.getPackageName());
        ArrayMap<String,Long> comp=ps.componentResumeTimes;
        for (int j=0; j < comp.size(); j++) {
          out.startTag(null,"comp");
          out.attribute(null,"name",comp.keyAt(j));
          out.attribute(null,"lrt",comp.valueAt(j).toString());
          out.endTag(null,"comp");
        }
        out.endTag(null,"pkg");
      }
    }
    out.endTag(null,"usage-history");
    out.endDocument();
    mHistoryFile.finishWrite(fos);
  }
 catch (  IOException e) {
    Slog.w(TAG,"Error writing history stats" + e);
    if (fos != null) {
      mHistoryFile.failWrite(fos);
    }
  }
}
