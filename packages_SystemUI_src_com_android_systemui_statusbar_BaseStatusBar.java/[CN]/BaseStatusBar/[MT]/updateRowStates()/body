{
  int maxKeyguardNotifications=getMaxKeyguardNotifications();
  mKeyguardIconOverflowContainer.getIconsView().removeAllViews();
  ArrayList<Entry> activeNotifications=mNotificationData.getActiveNotifications();
  final int N=activeNotifications.size();
  int visibleNotifications=0;
  boolean onKeyguard=mState == StatusBarState.KEYGUARD;
  for (int i=0; i < N; i++) {
    NotificationData.Entry entry=activeNotifications.get(i);
    if (onKeyguard) {
      entry.row.setOnKeyguard(true);
    }
 else {
      entry.row.setOnKeyguard(false);
      boolean top=(i == 0);
      entry.row.setSystemExpanded(top);
    }
    boolean childNotification=mGroupManager.isChildInGroupWithSummary(entry.notification);
    boolean childWithVisibleSummary=childNotification && mGroupManager.getGroupSummary(entry.notification).getVisibility() == View.VISIBLE;
    boolean showOnKeyguard=shouldShowOnKeyguard(entry.notification);
    if ((isLockscreenPublicMode() && !mShowLockscreenNotifications) || (onKeyguard && (visibleNotifications >= maxKeyguardNotifications && !childWithVisibleSummary || !showOnKeyguard))) {
      entry.row.setVisibility(View.GONE);
      if (onKeyguard && showOnKeyguard && !childNotification) {
        mKeyguardIconOverflowContainer.getIconsView().addNotification(entry);
      }
    }
 else {
      boolean wasGone=entry.row.getVisibility() == View.GONE;
      entry.row.setVisibility(View.VISIBLE);
      if (!childNotification) {
        if (wasGone) {
          mStackScroller.generateAddAnimation(entry.row,true);
        }
        visibleNotifications++;
      }
    }
  }
  mStackScroller.updateOverflowContainerVisibility(onKeyguard && mKeyguardIconOverflowContainer.getIconsView().getChildCount() > 0);
  mStackScroller.changeViewPosition(mDismissView,mStackScroller.getChildCount() - 1);
  mStackScroller.changeViewPosition(mEmptyShadeView,mStackScroller.getChildCount() - 2);
  mStackScroller.changeViewPosition(mKeyguardIconOverflowContainer,mStackScroller.getChildCount() - 3);
}
