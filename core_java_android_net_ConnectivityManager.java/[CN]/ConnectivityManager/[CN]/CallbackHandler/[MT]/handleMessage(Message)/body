{
  Log.d(TAG,"CM callback handler got msg " + message.what);
switch (message.what) {
case CALLBACK_PRECHECK:
{
      NetworkRequest request=(NetworkRequest)getObject(message,NetworkRequest.class);
      NetworkCallback callbacks=getCallbacks(request);
      if (callbacks != null) {
        callbacks.onPreCheck((Network)getObject(message,Network.class));
      }
 else {
        Log.e(TAG,"callback not found for PRECHECK message");
      }
      break;
    }
case CALLBACK_AVAILABLE:
{
    NetworkRequest request=(NetworkRequest)getObject(message,NetworkRequest.class);
    NetworkCallback callbacks=getCallbacks(request);
    if (callbacks != null) {
      callbacks.onAvailable((Network)getObject(message,Network.class));
    }
 else {
      Log.e(TAG,"callback not found for AVAILABLE message");
    }
    break;
  }
case CALLBACK_LOSING:
{
  NetworkRequest request=(NetworkRequest)getObject(message,NetworkRequest.class);
  NetworkCallback callbacks=getCallbacks(request);
  if (callbacks != null) {
    callbacks.onLosing((Network)getObject(message,Network.class),message.arg1);
  }
 else {
    Log.e(TAG,"callback not found for LOSING message");
  }
  break;
}
case CALLBACK_LOST:
{
NetworkRequest request=(NetworkRequest)getObject(message,NetworkRequest.class);
NetworkCallback callbacks=getCallbacks(request);
if (callbacks != null) {
  callbacks.onLost((Network)getObject(message,Network.class));
}
 else {
  Log.e(TAG,"callback not found for LOST message");
}
break;
}
case CALLBACK_UNAVAIL:
{
NetworkRequest request=(NetworkRequest)getObject(message,NetworkRequest.class);
NetworkCallback callbacks=null;
synchronized (mCallbackMap) {
callbacks=mCallbackMap.get(request);
}
if (callbacks != null) {
callbacks.onUnavailable();
}
 else {
Log.e(TAG,"callback not found for UNAVAIL message");
}
break;
}
case CALLBACK_CAP_CHANGED:
{
NetworkRequest request=(NetworkRequest)getObject(message,NetworkRequest.class);
NetworkCallback callbacks=getCallbacks(request);
if (callbacks != null) {
Network network=(Network)getObject(message,Network.class);
NetworkCapabilities cap=(NetworkCapabilities)getObject(message,NetworkCapabilities.class);
callbacks.onCapabilitiesChanged(network,cap);
}
 else {
Log.e(TAG,"callback not found for CAP_CHANGED message");
}
break;
}
case CALLBACK_IP_CHANGED:
{
NetworkRequest request=(NetworkRequest)getObject(message,NetworkRequest.class);
NetworkCallback callbacks=getCallbacks(request);
if (callbacks != null) {
Network network=(Network)getObject(message,Network.class);
LinkProperties lp=(LinkProperties)getObject(message,LinkProperties.class);
callbacks.onLinkPropertiesChanged(network,lp);
}
 else {
Log.e(TAG,"callback not found for IP_CHANGED message");
}
break;
}
case CALLBACK_RELEASED:
{
NetworkRequest req=(NetworkRequest)getObject(message,NetworkRequest.class);
NetworkCallback callbacks=null;
synchronized (mCallbackMap) {
callbacks=mCallbackMap.remove(req);
}
if (callbacks != null) {
synchronized (mRefCount) {
if (mRefCount.decrementAndGet() == 0) {
getLooper().quit();
}
}
}
 else {
Log.e(TAG,"callback not found for CANCELED message");
}
break;
}
case CALLBACK_EXIT:
{
Log.d(TAG,"Listener quiting");
getLooper().quit();
break;
}
case EXPIRE_LEGACY_REQUEST:
{
expireRequest((NetworkCapabilities)message.obj,message.arg1);
break;
}
}
}
