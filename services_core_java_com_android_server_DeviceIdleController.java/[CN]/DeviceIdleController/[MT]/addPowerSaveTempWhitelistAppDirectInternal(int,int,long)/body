{
  final long timeNow=SystemClock.elapsedRealtime();
synchronized (this) {
    int callingAppId=UserHandle.getAppId(callingUid);
    if (callingAppId >= Process.FIRST_APPLICATION_UID) {
      if (!mPowerSaveWhitelistSystemAppIds.get(callingAppId)) {
        throw new SecurityException("Calling app " + UserHandle.formatUid(callingUid) + " is not on whitelist");
      }
    }
    duration=Math.min(duration,mConstants.MAX_TEMP_APP_WHITELIST_DURATION);
    long currentEndTime=mTempWhitelistAppIdEndTimes.get(appId);
    mTempWhitelistAppIdEndTimes.put(appId,timeNow + duration);
    if (DEBUG) {
      Slog.d(TAG,"Adding AppId " + appId + " to temp whitelist");
    }
    if (currentEndTime == 0) {
      postTempActiveTimeoutMessage(appId,duration);
      updateTempWhitelistAppIdsLocked();
      reportTempWhitelistChangedLocked();
    }
  }
}
