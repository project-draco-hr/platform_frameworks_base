{
  final PopupWindow previewPopup=mPreviewPopup;
  final Key[] keys=mKeys;
  Key key=keys[keyIndex];
  if (key.icon != null) {
    mPreviewText.setCompoundDrawables(null,null,null,key.iconPreview != null ? key.iconPreview : key.icon);
    mPreviewText.setText(null);
  }
 else {
    mPreviewText.setCompoundDrawables(null,null,null,null);
    mPreviewText.setText(getPreviewText(key));
    if (key.label.length() > 1 && key.codes.length < 2) {
      mPreviewText.setTextSize(mLabelTextSize);
      mPreviewText.setTypeface(Typeface.DEFAULT_BOLD);
    }
 else {
      mPreviewText.setTextSize(mPreviewTextSizeLarge);
      mPreviewText.setTypeface(Typeface.DEFAULT);
    }
  }
  mPreviewText.measure(MeasureSpec.makeMeasureSpec(0,MeasureSpec.UNSPECIFIED),MeasureSpec.makeMeasureSpec(0,MeasureSpec.UNSPECIFIED));
  int popupWidth=Math.max(mPreviewText.getMeasuredWidth(),key.width + mPreviewText.getPaddingLeft() + mPreviewText.getPaddingRight());
  final int popupHeight=mPreviewHeight;
  LayoutParams lp=mPreviewText.getLayoutParams();
  if (lp != null) {
    lp.width=popupWidth;
    lp.height=popupHeight;
  }
  if (!mPreviewCentered) {
    mPopupPreviewX=key.x - mPreviewText.getPaddingLeft() + mPaddingLeft;
    mPopupPreviewY=key.y - popupHeight + mPreviewOffset;
  }
 else {
    mPopupPreviewX=160 - mPreviewText.getMeasuredWidth() / 2;
    mPopupPreviewY=-mPreviewText.getMeasuredHeight();
  }
  mHandler.removeMessages(MSG_REMOVE_PREVIEW);
  if (mOffsetInWindow == null) {
    mOffsetInWindow=new int[2];
    getLocationInWindow(mOffsetInWindow);
    mOffsetInWindow[0]+=mMiniKeyboardOffsetX;
    mOffsetInWindow[1]+=mMiniKeyboardOffsetY;
  }
  mPreviewText.getBackground().setState(key.popupResId != 0 ? LONG_PRESSABLE_STATE_SET : EMPTY_STATE_SET);
  if (previewPopup.isShowing()) {
    previewPopup.update(mPopupPreviewX + mOffsetInWindow[0],mPopupPreviewY + mOffsetInWindow[1],popupWidth,popupHeight);
  }
 else {
    previewPopup.setWidth(popupWidth);
    previewPopup.setHeight(popupHeight);
    previewPopup.showAtLocation(mPopupParent,Gravity.NO_GRAVITY,mPopupPreviewX + mOffsetInWindow[0],mPopupPreviewY + mOffsetInWindow[1]);
  }
  mPreviewText.setVisibility(VISIBLE);
}
