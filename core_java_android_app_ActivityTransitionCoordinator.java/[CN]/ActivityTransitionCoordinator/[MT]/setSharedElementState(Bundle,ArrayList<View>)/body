{
  ArrayMap<ImageView,Pair<ImageView.ScaleType,Matrix>> originalImageState=new ArrayMap<ImageView,Pair<ImageView.ScaleType,Matrix>>();
  final int[] tempLoc=new int[2];
  if (sharedElementState != null) {
    for (int i=0; i < mSharedElements.size(); i++) {
      View sharedElement=mSharedElements.get(i);
      String name=mTargetSharedNames.get(i);
      Pair<ImageView.ScaleType,Matrix> originalState=getOldImageState(sharedElement,name,sharedElementState);
      if (originalState != null) {
        originalImageState.put((ImageView)sharedElement,originalState);
      }
      View parent=(View)sharedElement.getParent();
      parent.getLocationOnScreen(tempLoc);
      setSharedElementState(sharedElement,name,sharedElementState,tempLoc);
      sharedElement.requestLayout();
    }
  }
  mListener.onCaptureSharedElementStart(mTargetSharedNames,mSharedElements,acceptedOverlayViews);
  getDecor().getViewTreeObserver().addOnPreDrawListener(new ViewTreeObserver.OnPreDrawListener(){
    @Override public boolean onPreDraw(){
      getDecor().getViewTreeObserver().removeOnPreDrawListener(this);
      mListener.onCaptureSharedElementEnd(mTargetSharedNames,mSharedElements,acceptedOverlayViews);
      mSharedElementTransitionStarted=true;
      return true;
    }
  }
);
  return originalImageState;
}
