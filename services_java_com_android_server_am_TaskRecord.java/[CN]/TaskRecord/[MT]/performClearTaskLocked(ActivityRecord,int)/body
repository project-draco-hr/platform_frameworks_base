{
  final ArrayList<ActivityRecord> activities=mActivities;
  int numActivities=activities.size();
  for (int activityNdx=numActivities - 1; activityNdx >= 0; --activityNdx) {
    ActivityRecord r=activities.get(activityNdx);
    if (r.finishing) {
      continue;
    }
    if (r.realActivity.equals(newR.realActivity)) {
      ActivityRecord ret=r;
      for (++activityNdx; activityNdx < numActivities; ++activityNdx) {
        r=activities.get(activityNdx);
        if (r.finishing) {
          continue;
        }
        ActivityOptions opts=r.takeOptionsLocked();
        if (opts != null) {
          ret.updateOptionsLocked(opts);
        }
        if (stack.finishActivityLocked(r,Activity.RESULT_CANCELED,null,"clear",false)) {
          --activityNdx;
          --numActivities;
        }
      }
      if (ret.launchMode == ActivityInfo.LAUNCH_MULTIPLE && (launchFlags & Intent.FLAG_ACTIVITY_SINGLE_TOP) == 0) {
        if (!ret.finishing) {
          if (activities.contains(ret)) {
            stack.finishActivityLocked(ret,Activity.RESULT_CANCELED,null,"clear",false);
          }
          return null;
        }
      }
      return ret;
    }
  }
  return null;
}
