{
  final TaskRecord task=r.task;
  if (!mLeanbackOnlyDevice && (r.isApplicationActivity() || (task != null && task.isApplicationTask()))) {
    ActivityStack stack;
    if (task != null) {
      stack=task.stack;
      if (stack.isOnHomeDisplay()) {
        if (mFocusedStack != stack) {
          if (DEBUG_FOCUS || DEBUG_STACK)           Slog.d(TAG,"computeStackFocus: Setting " + "focused stack to r=" + r + " task="+ task);
        }
 else {
          if (DEBUG_FOCUS || DEBUG_STACK)           Slog.d(TAG,"computeStackFocus: Focused stack already=" + mFocusedStack);
        }
      }
      return stack;
    }
    final ActivityContainer container=r.mInitialActivityContainer;
    if (container != null) {
      r.mInitialActivityContainer=null;
      return container.mStack;
    }
    if (mFocusedStack != mHomeStack && (!newTask || mFocusedStack.mActivityContainer.isEligibleForNewTasks())) {
      if (DEBUG_FOCUS || DEBUG_STACK)       Slog.d(TAG,"computeStackFocus: Have a focused stack=" + mFocusedStack);
      return mFocusedStack;
    }
    final ArrayList<ActivityStack> homeDisplayStacks=mHomeStack.mStacks;
    for (int stackNdx=homeDisplayStacks.size() - 1; stackNdx >= 0; --stackNdx) {
      stack=homeDisplayStacks.get(stackNdx);
      if (!stack.isHomeStack()) {
        if (DEBUG_FOCUS || DEBUG_STACK)         Slog.d(TAG,"computeStackFocus: Setting focused stack=" + stack);
        return stack;
      }
    }
    stack=createStackOnDisplay(getNextStackId(),Display.DEFAULT_DISPLAY);
    if (DEBUG_FOCUS || DEBUG_STACK)     Slog.d(TAG,"computeStackFocus: New stack r=" + r + " stackId="+ stack.mStackId);
    return stack;
  }
  return mHomeStack;
}
