{
  TaskRecord firstTask=null;
  ArraySet<TaskRecord> tasks=null;
  if (DEBUG_RELEASE)   Slog.d(TAG,"Trying to release some activities in " + app);
  for (int i=0; i < app.activities.size(); i++) {
    ActivityRecord r=app.activities.get(i);
    if (r.finishing || r.state == ActivityState.DESTROYING || r.state == ActivityState.DESTROYED) {
      if (DEBUG_RELEASE)       Slog.d(TAG,"Abort release; already destroying: " + r);
      return;
    }
    if (r.visible || !r.stopped || !r.haveState|| r.state == ActivityState.RESUMED || r.state == ActivityState.PAUSING || r.state == ActivityState.PAUSED || r.state == ActivityState.STOPPING) {
      if (DEBUG_RELEASE)       Slog.d(TAG,"Not releasing in-use activity: " + r);
      continue;
    }
    if (r.task != null) {
      if (DEBUG_RELEASE)       Slog.d(TAG,"Collecting release task " + r.task + " from "+ r);
      if (firstTask == null) {
        firstTask=r.task;
      }
 else       if (firstTask != r.task) {
        if (tasks == null) {
          tasks=new ArraySet<>();
          tasks.add(firstTask);
        }
        tasks.add(r.task);
      }
    }
  }
  if (tasks == null) {
    if (DEBUG_RELEASE)     Slog.d(TAG,"Didn't find two or more tasks to release");
    return;
  }
  final int numDisplays=mActivityDisplays.size();
  for (int displayNdx=0; displayNdx < numDisplays; ++displayNdx) {
    final ArrayList<ActivityStack> stacks=mActivityDisplays.valueAt(displayNdx).mStacks;
    for (int stackNdx=0; stackNdx < stacks.size(); stackNdx++) {
      final ActivityStack stack=stacks.get(stackNdx);
      if (stack.releaseSomeActivitiesLocked(app,tasks,reason) > 0) {
        return;
      }
    }
  }
}
