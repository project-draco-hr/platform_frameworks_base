{
  final TaskRecord task=r.task;
  if (r.isApplicationActivity() || (task != null && task.isApplicationTask())) {
    if (task != null) {
      final ActivityStack taskStack=task.stack;
      if (taskStack.isOnHomeDisplay()) {
        if (mFocusedStack != taskStack) {
          if (DEBUG_FOCUS || DEBUG_STACK)           Slog.d(TAG,"adjustStackFocus: Setting " + "focused stack to r=" + r + " task="+ task);
          mFocusedStack=taskStack;
        }
 else {
          if (DEBUG_FOCUS || DEBUG_STACK)           Slog.d(TAG,"adjustStackFocus: Focused stack already=" + mFocusedStack);
        }
      }
      return taskStack;
    }
    final ActivityContainer container=r.mInitialActivityContainer;
    if (container != null) {
      r.mInitialActivityContainer=null;
      return container.mStack;
    }
    if (mFocusedStack != mHomeStack) {
      if (DEBUG_FOCUS || DEBUG_STACK)       Slog.d(TAG,"adjustStackFocus: Have a focused stack=" + mFocusedStack);
      return mFocusedStack;
    }
    final ArrayList<ActivityStack> homeDisplayStacks=mHomeStack.mStacks;
    for (int stackNdx=homeDisplayStacks.size() - 1; stackNdx >= 0; --stackNdx) {
      final ActivityStack stack=homeDisplayStacks.get(stackNdx);
      if (!stack.isHomeStack()) {
        if (DEBUG_FOCUS || DEBUG_STACK)         Slog.d(TAG,"adjustStackFocus: Setting focused stack=" + stack);
        mFocusedStack=stack;
        return mFocusedStack;
      }
    }
    int stackId=createStackOnDisplay(null,getNextStackId(),Display.DEFAULT_DISPLAY);
    if (DEBUG_FOCUS || DEBUG_STACK)     Slog.d(TAG,"adjustStackFocus: New stack r=" + r + " stackId="+ stackId);
    mFocusedStack=getStack(stackId);
    return mFocusedStack;
  }
  return mHomeStack;
}
