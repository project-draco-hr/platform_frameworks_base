{
  final ActivityRecord r=task.getTopActivity();
  final ActivityStack prevStack=task.stack;
  final boolean wasFocused=isFocusedStack(prevStack) && (topRunningActivityLocked() == r);
  final boolean wasResumed=wasFocused && (prevStack.mResumedActivity == r);
  final boolean wasFront=isFrontStack(prevStack) && (prevStack.topRunningActivityLocked() == r);
  final int resizeMode=task.mResizeMode;
  task.mResizeMode=RESIZE_MODE_UNRESIZEABLE;
  final ActivityStack stack=getStack(stackId,CREATE_IF_NEEDED,toTop);
  task.mResizeMode=resizeMode;
  mWindowManager.moveTaskToStack(task.taskId,stack.mStackId,toTop);
  stack.addTask(task,toTop,reason);
  stack.moveToFrontAndResumeStateIfNeeded(r,forceFocus || wasFocused || wasFront,wasResumed,reason);
  return stack;
}
