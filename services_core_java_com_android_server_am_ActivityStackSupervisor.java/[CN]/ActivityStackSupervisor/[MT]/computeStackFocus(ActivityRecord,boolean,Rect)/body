{
  final TaskRecord task=r.task;
  if (!mLeanbackOnlyDevice && (r.isApplicationActivity() || (task != null && task.isApplicationTask()))) {
    ActivityStack stack;
    if (task != null && task.stack != null) {
      stack=task.stack;
      if (stack.isOnHomeDisplay()) {
        if (mFocusedStack != stack) {
          if (DEBUG_FOCUS || DEBUG_STACK)           Slog.d(TAG_FOCUS,"computeStackFocus: Setting " + "focused stack to r=" + r + " task="+ task);
        }
 else {
          if (DEBUG_FOCUS || DEBUG_STACK)           Slog.d(TAG_FOCUS,"computeStackFocus: Focused stack already=" + mFocusedStack);
        }
      }
      return stack;
    }
    final ActivityContainer container=r.mInitialActivityContainer;
    if (container != null) {
      r.mInitialActivityContainer=null;
      return container.mStack;
    }
    final boolean canUseFocusedStack=mFocusedStack.mStackId == FULLSCREEN_WORKSPACE_STACK_ID || mFocusedStack.mStackId == FREEFORM_WORKSPACE_STACK_ID && r.info.resizeable;
    if (canUseFocusedStack && (!newTask || mFocusedStack.mActivityContainer.isEligibleForNewTasks())) {
      if (DEBUG_FOCUS || DEBUG_STACK)       Slog.d(TAG_FOCUS,"computeStackFocus: Have a focused stack=" + mFocusedStack);
      return mFocusedStack;
    }
    final ArrayList<ActivityStack> homeDisplayStacks=mHomeStack.mStacks;
    for (int stackNdx=homeDisplayStacks.size() - 1; stackNdx >= 0; --stackNdx) {
      stack=homeDisplayStacks.get(stackNdx);
      final boolean isDynamicStack=stack.mStackId >= FIRST_DYNAMIC_STACK_ID;
      if (isDynamicStack) {
        if (DEBUG_FOCUS || DEBUG_STACK)         Slog.d(TAG_FOCUS,"computeStackFocus: Setting focused stack=" + stack);
        return stack;
      }
    }
    final int stackId=task != null ? task.getLaunchStackId() : bounds != null ? FREEFORM_WORKSPACE_STACK_ID : FULLSCREEN_WORKSPACE_STACK_ID;
    stack=getStack(stackId,CREATE_IF_NEEDED,ON_TOP);
    if (DEBUG_FOCUS || DEBUG_STACK)     Slog.d(TAG_FOCUS,"computeStackFocus: New stack r=" + r + " stackId="+ stack.mStackId);
    return stack;
  }
  return mHomeStack;
}
