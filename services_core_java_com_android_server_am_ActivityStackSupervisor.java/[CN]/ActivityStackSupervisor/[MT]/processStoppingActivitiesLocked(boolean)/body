{
  ArrayList<ActivityRecord> stops=null;
  final boolean nowVisible=allResumedActivitiesVisible();
  for (int activityNdx=mStoppingActivities.size() - 1; activityNdx >= 0; --activityNdx) {
    ActivityRecord s=mStoppingActivities.get(activityNdx);
    final boolean waitingVisible=mWaitingVisibleActivities.contains(s);
    if (DEBUG_STATES)     Slog.v(TAG,"Stopping " + s + ": nowVisible="+ nowVisible+ " waitingVisible="+ waitingVisible+ " finishing="+ s.finishing);
    if (waitingVisible && nowVisible) {
      mWaitingVisibleActivities.remove(s);
      if (s.finishing) {
        if (DEBUG_STATES)         Slog.v(TAG,"Before stopping, can hide: " + s);
        mWindowManager.setAppVisibility(s.appToken,false);
      }
    }
    if ((!waitingVisible || mService.isSleepingOrShuttingDownLocked()) && remove) {
      if (DEBUG_STATES)       Slog.v(TAG,"Ready to stop: " + s);
      if (stops == null) {
        stops=new ArrayList<>();
      }
      stops.add(s);
      mStoppingActivities.remove(activityNdx);
    }
  }
  return stops;
}
