{
  ArrayList<TaskStack> stacks=mService.getDisplayContentLocked(displayId).getStacks();
  for (int stackNdx=stacks.size() - 1; stackNdx >= 0; --stackNdx) {
    final TaskStack stack=stacks.get(stackNdx);
    final ArrayList<Task> tasks=stack.getTasks();
    for (int taskNdx=tasks.size() - 1; taskNdx >= 0; --taskNdx) {
      final AppTokenList tokens=tasks.get(taskNdx).mAppTokens;
      for (int tokenNdx=tokens.size() - 1; tokenNdx >= 0; --tokenNdx) {
        final AppWindowAnimator appAnimator=tokens.get(tokenNdx).mAppAnimator;
        final boolean wasAnimating=appAnimator.animation != null && appAnimator.animation != AppWindowAnimator.sDummyAnimation;
        if (appAnimator.stepAnimationLocked(mCurrentTime)) {
          mAnimating=true;
        }
 else         if (wasAnimating) {
          setAppLayoutChanges(appAnimator,WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER,"appToken " + appAnimator.mAppToken + " done");
          if (WindowManagerService.DEBUG_ANIM)           Slog.v(TAG,"updateWindowsApps...: done animating " + appAnimator.mAppToken);
        }
      }
    }
    final AppTokenList exitingAppTokens=stack.mExitingAppTokens;
    final int NEAT=exitingAppTokens.size();
    for (int i=0; i < NEAT; i++) {
      final AppWindowAnimator appAnimator=exitingAppTokens.get(i).mAppAnimator;
      final boolean wasAnimating=appAnimator.animation != null && appAnimator.animation != AppWindowAnimator.sDummyAnimation;
      if (appAnimator.stepAnimationLocked(mCurrentTime)) {
        mAnimating=true;
      }
 else       if (wasAnimating) {
        setAppLayoutChanges(appAnimator,WindowManagerPolicy.FINISH_LAYOUT_REDO_WALLPAPER,"exiting appToken " + appAnimator.mAppToken + " done");
        if (WindowManagerService.DEBUG_ANIM)         Slog.v(TAG,"updateWindowsApps...: done animating exiting " + appAnimator.mAppToken);
      }
    }
  }
}
