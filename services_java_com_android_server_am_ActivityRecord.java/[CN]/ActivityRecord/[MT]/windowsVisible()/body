{
synchronized (service) {
    final ActivityStack stack=task.stack;
    stack.reportActivityVisibleLocked(this);
    if (ActivityManagerService.DEBUG_SWITCH)     Log.v(ActivityManagerService.TAG,"windowsVisible(): " + this);
    if (!nowVisible) {
      nowVisible=true;
      lastVisibleTime=SystemClock.uptimeMillis();
      if (!idle) {
        mStackSupervisor.processStoppingActivitiesLocked(false);
      }
 else {
        final int N=mStackSupervisor.mWaitingVisibleActivities.size();
        if (N > 0) {
          for (int i=0; i < N; i++) {
            ActivityRecord r=mStackSupervisor.mWaitingVisibleActivities.get(i);
            r.waitingVisible=false;
            if (ActivityManagerService.DEBUG_SWITCH)             Log.v(ActivityManagerService.TAG,"Was waiting for visible: " + r);
          }
          mStackSupervisor.mWaitingVisibleActivities.clear();
          Message msg=Message.obtain();
          msg.what=ActivityStack.IDLE_NOW_MSG;
          stack.mHandler.sendMessage(msg);
        }
      }
      service.scheduleAppGcsLocked();
    }
  }
}
