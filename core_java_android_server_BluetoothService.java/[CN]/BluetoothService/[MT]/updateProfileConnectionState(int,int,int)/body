{
  int numDev=1;
  int newHashState=newState;
  boolean update=true;
  Pair<Integer,Integer> stateNumDev=mProfileConnectionState.get(profile);
  if (stateNumDev != null) {
    int currHashState=stateNumDev.first;
    numDev=stateNumDev.second;
    if (newState == currHashState) {
      numDev++;
    }
 else     if (newState == BluetoothProfile.STATE_CONNECTED || (newState == BluetoothProfile.STATE_CONNECTING && currHashState != BluetoothProfile.STATE_CONNECTED)) {
      numDev=1;
    }
 else     if (numDev == 1 && oldState == currHashState) {
      update=true;
    }
 else     if (numDev > 1 && oldState == currHashState) {
      numDev--;
      if (currHashState == BluetoothProfile.STATE_CONNECTED || currHashState == BluetoothProfile.STATE_CONNECTING) {
        newHashState=currHashState;
      }
    }
 else {
      update=false;
    }
  }
  if (update) {
    mProfileConnectionState.put(profile,new Pair<Integer,Integer>(newHashState,numDev));
  }
}
