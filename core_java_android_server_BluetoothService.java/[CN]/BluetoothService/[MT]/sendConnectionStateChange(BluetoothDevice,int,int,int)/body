{
  if (getBluetoothStateInternal() == BluetoothAdapter.STATE_OFF)   return;
  if (!validateProfileConnectionState(state) || !validateProfileConnectionState(prevState)) {
    Log.e(TAG,"Error in sendConnectionStateChange: " + "prevState " + prevState + " state "+ state);
    return;
  }
  updateProfileConnectionState(profile,state,prevState);
  if (updateCountersAndCheckForConnectionStateChange(state,prevState)) {
    mAdapterConnectionState=state;
    if (state == BluetoothProfile.STATE_DISCONNECTED) {
      mBluetoothState.sendMessage(BluetoothAdapterStateMachine.ALL_DEVICES_DISCONNECTED);
    }
    Intent intent=new Intent(BluetoothAdapter.ACTION_CONNECTION_STATE_CHANGED);
    intent.putExtra(BluetoothDevice.EXTRA_DEVICE,device);
    intent.putExtra(BluetoothAdapter.EXTRA_CONNECTION_STATE,convertToAdapterState(state));
    intent.putExtra(BluetoothAdapter.EXTRA_PREVIOUS_CONNECTION_STATE,convertToAdapterState(prevState));
    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT);
    mContext.sendBroadcast(intent,BLUETOOTH_PERM);
    Log.d(TAG,"CONNECTION_STATE_CHANGE: " + device + ": "+ prevState+ " -> "+ state);
  }
}
