{
  int oldState=getBondState(address);
  if (oldState == state) {
    return;
  }
  if (oldState == BluetoothDevice.BOND_BONDING) {
    if (address.equals(mPendingOutgoingBonding)) {
      mPendingOutgoingBonding=null;
    }
  }
  if (state == BluetoothDevice.BOND_BONDED) {
    addProfileState(address);
  }
  if (DBG)   log(address + " bond state " + oldState+ " -> "+ state+ " ("+ reason+ ")");
  Intent intent=new Intent(BluetoothDevice.ACTION_BOND_STATE_CHANGED);
  intent.putExtra(BluetoothDevice.EXTRA_DEVICE,mAdapter.getRemoteDevice(address));
  intent.putExtra(BluetoothDevice.EXTRA_BOND_STATE,state);
  intent.putExtra(BluetoothDevice.EXTRA_PREVIOUS_BOND_STATE,oldState);
  if (state == BluetoothDevice.BOND_NONE) {
    if (reason <= 0) {
      Log.w(TAG,"setBondState() called to unbond device, but reason code is " + "invalid. Overriding reason code with BOND_RESULT_REMOVED");
      reason=BluetoothDevice.UNBOND_REASON_REMOVED;
    }
    intent.putExtra(BluetoothDevice.EXTRA_REASON,reason);
    mState.remove(address);
  }
 else {
    mState.put(address,state);
  }
  mContext.sendBroadcast(intent,BLUETOOTH_PERM);
}
