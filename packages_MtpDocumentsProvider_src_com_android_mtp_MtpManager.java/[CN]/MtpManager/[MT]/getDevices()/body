{
  final ArrayList<MtpDeviceRecord> devices=new ArrayList<>();
  for (  UsbDevice device : mManager.getDeviceList().values()) {
    if (!isMtpDevice(device)) {
      continue;
    }
    final boolean opened=mDevices.get(device.getDeviceId()) != null;
    final String name=device.getProductName();
    MtpRoot[] roots;
    if (opened) {
      try {
        roots=getRoots(device.getDeviceId());
      }
 catch (      IOException exp) {
        Log.e(MtpDocumentsProvider.TAG,exp.getMessage());
        roots=new MtpRoot[0];
      }
    }
 else {
      roots=new MtpRoot[0];
    }
    devices.add(new MtpDeviceRecord(device.getDeviceId(),name,opened,roots));
  }
  return devices.toArray(new MtpDeviceRecord[devices.size()]);
}
