{
  final ArrayList<MtpDeviceRecord> devices=new ArrayList<>();
  for (  UsbDevice device : mManager.getDeviceList().values()) {
    if (!isMtpDevice(device)) {
      continue;
    }
    final MtpDevice mtpDevice=mDevices.get(device.getDeviceId());
    final boolean opened=mtpDevice != null;
    final String name=device.getProductName();
    MtpRoot[] roots;
    int[] operationsSupported=null;
    if (opened) {
      try {
        roots=getRoots(device.getDeviceId());
      }
 catch (      IOException exp) {
        Log.e(MtpDocumentsProvider.TAG,exp.getMessage());
        roots=new MtpRoot[0];
      }
      final MtpDeviceInfo info=mtpDevice.getDeviceInfo();
      if (info != null) {
        operationsSupported=mtpDevice.getDeviceInfo().getOperationsSupported();
      }
      if (operationsSupported == null) {
        operationsSupported=new int[0];
      }
    }
 else {
      roots=new MtpRoot[0];
      operationsSupported=new int[0];
    }
    devices.add(new MtpDeviceRecord(device.getDeviceId(),name,opened,roots,operationsSupported));
  }
  return devices.toArray(new MtpDeviceRecord[devices.size()]);
}
