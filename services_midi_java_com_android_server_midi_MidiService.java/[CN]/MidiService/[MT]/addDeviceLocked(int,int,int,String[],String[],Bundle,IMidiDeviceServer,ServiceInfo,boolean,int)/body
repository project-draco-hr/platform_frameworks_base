{
  int id=mNextDeviceId++;
  MidiDeviceInfo deviceInfo=new MidiDeviceInfo(type,id,numInputPorts,numOutputPorts,inputPortNames,outputPortNames,properties,isPrivate);
  Device device=null;
  BluetoothDevice bluetoothDevice=null;
  if (type == MidiDeviceInfo.TYPE_BLUETOOTH) {
    bluetoothDevice=(BluetoothDevice)properties.getParcelable(MidiDeviceInfo.PROPERTY_BLUETOOTH_DEVICE);
    device=mBluetoothDevices.get(bluetoothDevice);
    if (device != null) {
      device.setDeviceInfo(deviceInfo);
    }
  }
  if (device == null) {
    device=new Device(server,deviceInfo,serviceInfo,uid);
  }
  mDevicesByInfo.put(deviceInfo,device);
  if (bluetoothDevice != null) {
    mBluetoothDevices.put(bluetoothDevice,device);
  }
synchronized (mClients) {
    for (    Client c : mClients.values()) {
      c.deviceAdded(device);
    }
  }
  return deviceInfo;
}
