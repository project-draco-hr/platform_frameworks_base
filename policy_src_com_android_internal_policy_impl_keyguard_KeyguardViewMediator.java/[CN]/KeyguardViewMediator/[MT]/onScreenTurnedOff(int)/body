{
synchronized (this) {
    mScreenOn=false;
    if (DEBUG)     Log.d(TAG,"onScreenTurnedOff(" + why + ")");
    final boolean lockImmediately=mLockPatternUtils.getPowerButtonInstantlyLocks() || !mLockPatternUtils.isSecure();
    if (mExitSecureCallback != null) {
      if (DEBUG)       Log.d(TAG,"pending exit secure callback cancelled");
      mExitSecureCallback.onKeyguardExitResult(false);
      mExitSecureCallback=null;
      if (!mExternallyEnabled) {
        hideLocked();
      }
    }
 else     if (mShowing) {
      notifyScreenOffLocked();
      resetStateLocked();
    }
 else     if (why == WindowManagerPolicy.OFF_BECAUSE_OF_TIMEOUT || (why == WindowManagerPolicy.OFF_BECAUSE_OF_USER && !lockImmediately)) {
      final ContentResolver cr=mContext.getContentResolver();
      long displayTimeout=Settings.System.getInt(cr,SCREEN_OFF_TIMEOUT,KEYGUARD_DISPLAY_TIMEOUT_DELAY_DEFAULT);
      final long lockAfterTimeout=Settings.Secure.getInt(cr,Settings.Secure.LOCK_SCREEN_LOCK_AFTER_TIMEOUT,KEYGUARD_LOCK_AFTER_DELAY_DEFAULT);
      final long policyTimeout=mLockPatternUtils.getDevicePolicyManager().getMaximumTimeToLock(null,mLockPatternUtils.getCurrentUser());
      long timeout;
      if (policyTimeout > 0) {
        displayTimeout=Math.max(displayTimeout,0);
        timeout=Math.min(policyTimeout - displayTimeout,lockAfterTimeout);
      }
 else {
        timeout=lockAfterTimeout;
      }
      if (timeout <= 0) {
        mSuppressNextLockSound=true;
        doKeyguardLocked();
      }
 else {
        long when=SystemClock.elapsedRealtime() + timeout;
        Intent intent=new Intent(DELAYED_KEYGUARD_ACTION);
        intent.putExtra("seq",mDelayedShowingSequence);
        PendingIntent sender=PendingIntent.getBroadcast(mContext,0,intent,PendingIntent.FLAG_CANCEL_CURRENT);
        mAlarmManager.set(AlarmManager.ELAPSED_REALTIME_WAKEUP,when,sender);
        if (DEBUG)         Log.d(TAG,"setting alarm to turn off keyguard, seq = " + mDelayedShowingSequence);
      }
    }
 else     if (why == WindowManagerPolicy.OFF_BECAUSE_OF_PROX_SENSOR) {
    }
 else {
      doKeyguardLocked();
    }
  }
}
