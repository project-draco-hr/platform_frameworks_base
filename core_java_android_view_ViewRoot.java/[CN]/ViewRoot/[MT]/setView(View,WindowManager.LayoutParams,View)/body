{
synchronized (this) {
    if (mView == null) {
      mView=view;
      mWindowAttributes.copyFrom(attrs);
      attrs=mWindowAttributes;
      Resources resources=mView.getContext().getResources();
      CompatibilityInfo compatibilityInfo=resources.getCompatibilityInfo();
      mTranslator=compatibilityInfo.getTranslator(attrs);
      if (mTranslator != null || !compatibilityInfo.supportsScreen()) {
        mSurface.setCompatibleDisplayMetrics(resources.getDisplayMetrics());
      }
      boolean restore=false;
      if (attrs != null && mTranslator != null) {
        restore=true;
        attrs.backup();
        mTranslator.translateWindowLayout(attrs);
      }
      if (DEBUG_LAYOUT)       Log.d(TAG,"WindowLayout in setView:" + attrs);
      if (!compatibilityInfo.supportsScreen()) {
        attrs.flags|=WindowManager.LayoutParams.FLAG_COMPATIBLE_WINDOW;
      }
      mSoftInputMode=attrs.softInputMode;
      mWindowAttributesChanged=true;
      mAttachInfo.mRootView=view;
      mAttachInfo.mScalingRequired=mTranslator == null ? false : true;
      mAttachInfo.mApplicationScale=mTranslator == null ? 1.0f : mTranslator.applicationScale;
      if (panelParentView != null) {
        mAttachInfo.mPanelParentWindowToken=panelParentView.getApplicationWindowToken();
      }
      mAdded=true;
      int res;
      requestLayout();
      try {
        res=sWindowSession.add(mWindow,mWindowAttributes,getHostVisibility(),mAttachInfo.mContentInsets);
      }
 catch (      RemoteException e) {
        mAdded=false;
        mView=null;
        mAttachInfo.mRootView=null;
        unscheduleTraversals();
        throw new RuntimeException("Adding window failed",e);
      }
 finally {
        if (restore) {
          attrs.restore();
        }
      }
      if (mTranslator != null) {
        mTranslator.translateRectInScreenToAppWindow(mAttachInfo.mContentInsets);
      }
      mPendingContentInsets.set(mAttachInfo.mContentInsets);
      mPendingVisibleInsets.set(0,0,0,0);
      if (Config.LOGV)       Log.v("ViewRoot","Added window " + mWindow);
      if (res < WindowManagerImpl.ADD_OKAY) {
        mView=null;
        mAttachInfo.mRootView=null;
        mAdded=false;
        unscheduleTraversals();
switch (res) {
case WindowManagerImpl.ADD_BAD_APP_TOKEN:
case WindowManagerImpl.ADD_BAD_SUBWINDOW_TOKEN:
          throw new WindowManagerImpl.BadTokenException("Unable to add window -- token " + attrs.token + " is not valid; is your activity running?");
case WindowManagerImpl.ADD_NOT_APP_TOKEN:
        throw new WindowManagerImpl.BadTokenException("Unable to add window -- token " + attrs.token + " is not for an application");
case WindowManagerImpl.ADD_APP_EXITING:
      throw new WindowManagerImpl.BadTokenException("Unable to add window -- app for token " + attrs.token + " is exiting");
case WindowManagerImpl.ADD_DUPLICATE_ADD:
    throw new WindowManagerImpl.BadTokenException("Unable to add window -- window " + mWindow + " has already been added");
case WindowManagerImpl.ADD_STARTING_NOT_NEEDED:
  return;
case WindowManagerImpl.ADD_MULTIPLE_SINGLETON:
throw new WindowManagerImpl.BadTokenException("Unable to add window " + mWindow + " -- another window of this type already exists");
case WindowManagerImpl.ADD_PERMISSION_DENIED:
throw new WindowManagerImpl.BadTokenException("Unable to add window " + mWindow + " -- permission denied for this window type");
}
throw new RuntimeException("Unable to add window -- unknown error code " + res);
}
view.assignParent(this);
mAddedTouchMode=(res & WindowManagerImpl.ADD_FLAG_IN_TOUCH_MODE) != 0;
mAppVisible=(res & WindowManagerImpl.ADD_FLAG_APP_VISIBLE) != 0;
}
}
}
