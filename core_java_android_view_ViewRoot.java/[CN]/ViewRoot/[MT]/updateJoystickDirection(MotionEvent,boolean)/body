{
  final long time=event.getEventTime();
  final int metaState=event.getMetaState();
  final int deviceId=event.getDeviceId();
  final int source=event.getSource();
  int xDirection=joystickAxisValueToDirection(event.getAxisValue(MotionEvent.AXIS_HAT_X));
  if (xDirection == 0) {
    xDirection=joystickAxisValueToDirection(event.getX());
  }
  int yDirection=joystickAxisValueToDirection(event.getAxisValue(MotionEvent.AXIS_HAT_Y));
  if (yDirection == 0) {
    yDirection=joystickAxisValueToDirection(event.getY());
  }
  if (xDirection != mLastJoystickXDirection) {
    if (mLastJoystickXKeyCode != 0) {
      deliverKeyEvent(new KeyEvent(time,time,KeyEvent.ACTION_UP,mLastJoystickXKeyCode,0,metaState,deviceId,0,KeyEvent.FLAG_FALLBACK,source),false);
      mLastJoystickXKeyCode=0;
    }
    mLastJoystickXDirection=xDirection;
    if (xDirection != 0 && synthesizeNewKeys) {
      mLastJoystickXKeyCode=xDirection > 0 ? KeyEvent.KEYCODE_DPAD_RIGHT : KeyEvent.KEYCODE_DPAD_LEFT;
      deliverKeyEvent(new KeyEvent(time,time,KeyEvent.ACTION_DOWN,mLastJoystickXKeyCode,0,metaState,deviceId,0,KeyEvent.FLAG_FALLBACK,source),false);
    }
  }
  if (yDirection != mLastJoystickYDirection) {
    if (mLastJoystickYKeyCode != 0) {
      deliverKeyEvent(new KeyEvent(time,time,KeyEvent.ACTION_UP,mLastJoystickYKeyCode,0,metaState,deviceId,0,KeyEvent.FLAG_FALLBACK,source),false);
      mLastJoystickYKeyCode=0;
    }
    mLastJoystickYDirection=yDirection;
    if (yDirection != 0 && synthesizeNewKeys) {
      mLastJoystickYKeyCode=yDirection > 0 ? KeyEvent.KEYCODE_DPAD_DOWN : KeyEvent.KEYCODE_DPAD_UP;
      deliverKeyEvent(new KeyEvent(time,time,KeyEvent.ACTION_DOWN,mLastJoystickYKeyCode,0,metaState,deviceId,0,KeyEvent.FLAG_FALLBACK,source),false);
    }
  }
}
