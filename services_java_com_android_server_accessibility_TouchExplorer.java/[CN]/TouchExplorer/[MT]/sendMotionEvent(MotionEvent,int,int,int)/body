{
  prototype.setAction(action);
  MotionEvent event=null;
  if (pointerIdBits == ALL_POINTER_ID_BITS) {
    event=prototype;
  }
 else {
    event=prototype.split(pointerIdBits);
  }
  if (action == MotionEvent.ACTION_DOWN) {
    event.setDownTime(event.getEventTime());
  }
 else {
    event.setDownTime(mInjectedPointerTracker.getLastInjectedDownEventTime());
  }
  if (mLongPressingPointerId >= 0) {
    final int remappedIndex=event.findPointerIndex(mLongPressingPointerId);
    final int pointerCount=event.getPointerCount();
    PointerProperties[] props=PointerProperties.createArray(pointerCount);
    PointerCoords[] coords=PointerCoords.createArray(pointerCount);
    for (int i=0; i < pointerCount; i++) {
      event.getPointerProperties(i,props[i]);
      event.getPointerCoords(i,coords[i]);
      if (i == remappedIndex) {
        coords[i].x-=mLongPressingPointerDeltaX;
        coords[i].y-=mLongPressingPointerDeltaY;
      }
    }
    MotionEvent remapped=MotionEvent.obtain(event.getDownTime(),event.getEventTime(),event.getAction(),event.getPointerCount(),props,coords,event.getMetaState(),event.getButtonState(),1.0f,1.0f,event.getDeviceId(),event.getEdgeFlags(),event.getSource(),event.getFlags());
    if (event != prototype) {
      event.recycle();
    }
    event=remapped;
  }
  if (DEBUG) {
    Slog.d(LOG_TAG,"Injecting event: " + event + ", policyFlags=0x"+ Integer.toHexString(policyFlags));
  }
  policyFlags|=WindowManagerPolicy.FLAG_PASS_TO_USER;
  if (mNext != null) {
    mNext.onMotionEvent(event,null,policyFlags);
  }
  mInjectedPointerTracker.onMotionEvent(event);
  if (event != prototype) {
    event.recycle();
  }
}
