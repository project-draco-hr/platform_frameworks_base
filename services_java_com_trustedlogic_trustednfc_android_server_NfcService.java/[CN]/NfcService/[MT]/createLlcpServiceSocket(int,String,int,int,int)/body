{
  if (!mIsNfcEnabled) {
    return ErrorCodes.ERROR_NOT_INITIALIZED;
  }
  mContext.enforceCallingPermission(android.Manifest.permission.NFC_LLCP,"NFC_LLCP permission required for LLCP operations with NFC service");
  if (mNbSocketCreated < LLCP_SOCKET_NB_MAX) {
    int sockeHandle=mGeneratedSocketHandle;
    if (mLlcpLinkState == NfcManager.LLCP_LINK_STATE_ACTIVATED) {
      NativeLlcpServiceSocket socket;
      socket=mManager.doCreateLlcpServiceSocket(sap,sn,miu,rw,linearBufferLength);
      if (socket != null) {
        mNbSocketCreated++;
        mSocketMap.put(sockeHandle,socket);
      }
 else {
        mGeneratedSocketHandle-=1;
        int errorStatus=mManager.doGetLastError();
switch (errorStatus) {
case ErrorCodes.ERROR_BUFFER_TO_SMALL:
          return ErrorCodes.ERROR_BUFFER_TO_SMALL;
case ErrorCodes.ERROR_INSUFFICIENT_RESOURCES:
        return ErrorCodes.ERROR_INSUFFICIENT_RESOURCES;
default :
      return ErrorCodes.ERROR_SOCKET_CREATION;
  }
}
}
 else {
if (!CheckSocketSap(sap)) {
  return ErrorCodes.ERROR_SAP_USED;
}
if (!CheckSocketServiceName(sn)) {
  return ErrorCodes.ERROR_SERVICE_NAME_USED;
}
if (!CheckSocketOptions(miu,rw,linearBufferLength)) {
  return ErrorCodes.ERROR_SOCKET_OPTIONS;
}
NativeLlcpServiceSocket socket=new NativeLlcpServiceSocket(sn);
mSocketMap.put(sockeHandle,socket);
mNbSocketCreated++;
RegisteredSocket registeredSocket=new RegisteredSocket(LLCP_SERVICE_SOCKET_TYPE,sockeHandle,sap,sn,miu,rw,linearBufferLength);
mRegisteredSocketList.add(registeredSocket);
}
mGeneratedSocketHandle+=1;
Log.d(TAG,"Llcp Service Socket Handle =" + sockeHandle);
return sockeHandle;
}
 else {
return ErrorCodes.ERROR_INSUFFICIENT_RESOURCES;
}
}
