{
synchronized (mLock) {
    throwIfNotConnectedLocked();
  }
  Display display=DisplayManagerGlobal.getInstance().getRealDisplay(Display.DEFAULT_DISPLAY);
  Point displaySize=new Point();
  display.getRealSize(displaySize);
  final int displayWidth=displaySize.x;
  final int displayHeight=displaySize.y;
  final float screenshotWidth;
  final float screenshotHeight;
  final int rotation=display.getRotation();
switch (rotation) {
case ROTATION_FREEZE_0:
{
      screenshotWidth=displayWidth;
      screenshotHeight=displayHeight;
    }
  break;
case ROTATION_FREEZE_90:
{
  screenshotWidth=displayHeight;
  screenshotHeight=displayWidth;
}
break;
case ROTATION_FREEZE_180:
{
screenshotWidth=displayWidth;
screenshotHeight=displayHeight;
}
break;
case ROTATION_FREEZE_270:
{
screenshotWidth=displayHeight;
screenshotHeight=displayWidth;
}
break;
default :
{
throw new IllegalArgumentException("Invalid rotation: " + rotation);
}
}
Bitmap screenShot=null;
try {
screenShot=mUiAutomationConnection.takeScreenshot((int)screenshotWidth,(int)screenshotHeight);
if (screenShot == null) {
return null;
}
}
 catch (RemoteException re) {
Log.e(LOG_TAG,"Error while taking screnshot!",re);
return null;
}
if (rotation != ROTATION_FREEZE_0) {
Bitmap unrotatedScreenShot=Bitmap.createBitmap(displayWidth,displayHeight,Bitmap.Config.ARGB_8888);
Canvas canvas=new Canvas(unrotatedScreenShot);
canvas.translate(unrotatedScreenShot.getWidth() / 2,unrotatedScreenShot.getHeight() / 2);
canvas.rotate(getDegreesForRotation(rotation));
canvas.translate(-screenshotWidth / 2,-screenshotHeight / 2);
canvas.drawBitmap(screenShot,0,0,null);
canvas.setBitmap(null);
screenShot=unrotatedScreenShot;
}
screenShot.setHasAlpha(false);
return screenShot;
}
