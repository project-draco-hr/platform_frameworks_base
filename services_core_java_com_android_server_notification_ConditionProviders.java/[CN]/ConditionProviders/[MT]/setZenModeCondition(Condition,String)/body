{
  if (DEBUG)   Slog.d(TAG,"setZenModeCondition " + condition);
synchronized (mMutex) {
    ComponentName conditionComponent=null;
    if (condition != null) {
      if (ZenModeConfig.isValidCountdownConditionId(condition.id)) {
        final ConditionRecord r=getRecordLocked(condition.id,CountdownConditionProvider.COMPONENT);
        if (r.info == null) {
          r.info=checkServiceTokenLocked(mCountdown.asInterface());
        }
      }
      if (ZenModeConfig.isValidDowntimeConditionId(condition.id)) {
        final ConditionRecord r=getRecordLocked(condition.id,DowntimeConditionProvider.COMPONENT);
        if (r.info == null) {
          r.info=checkServiceTokenLocked(mDowntime.asInterface());
        }
      }
    }
    final int N=mRecords.size();
    for (int i=0; i < N; i++) {
      final ConditionRecord r=mRecords.get(i);
      final boolean idEqual=condition != null && r.id.equals(condition.id);
      if (r.isManual && !idEqual) {
        unsubscribeLocked(r);
        r.isManual=false;
      }
 else       if (idEqual && !r.isManual) {
        subscribeLocked(r);
        r.isManual=true;
      }
      if (idEqual) {
        conditionComponent=r.component;
      }
    }
    if (!Objects.equals(mExitCondition,condition)) {
      mExitCondition=condition;
      mExitConditionComponent=conditionComponent;
      ZenLog.traceExitCondition(mExitCondition,mExitConditionComponent,reason);
      saveZenConfigLocked();
    }
  }
}
