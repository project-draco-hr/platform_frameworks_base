{
  if (DEBUG)   Slog.d(TAG,"setZenModeCondition " + condition + " reason="+ reason);
synchronized (mMutex) {
    ComponentName conditionComponent=null;
    if (condition != null) {
      if (mCountdown != null && ZenModeConfig.isValidCountdownConditionId(condition.id)) {
        ensureRecordExists(condition,mCountdown.asInterface(),CountdownConditionProvider.COMPONENT);
      }
      if (mDowntime != null && ZenModeConfig.isValidDowntimeConditionId(condition.id)) {
        ensureRecordExists(condition,mDowntime.asInterface(),DowntimeConditionProvider.COMPONENT);
      }
    }
    final int N=mRecords.size();
    for (int i=0; i < N; i++) {
      final ConditionRecord r=mRecords.get(i);
      final boolean idEqual=condition != null && r.id.equals(condition.id);
      if (r.isManual && !idEqual) {
        unsubscribeLocked(r);
        r.isManual=false;
      }
 else       if (idEqual && !r.isManual) {
        subscribeLocked(r);
        r.isManual=true;
      }
      if (idEqual) {
        conditionComponent=r.component;
      }
    }
    if (!Objects.equals(mExitCondition,condition)) {
      mExitCondition=condition;
      mExitConditionComponent=conditionComponent;
      ZenLog.traceExitCondition(mExitCondition,mExitConditionComponent,reason);
      saveZenConfigLocked();
    }
  }
}
