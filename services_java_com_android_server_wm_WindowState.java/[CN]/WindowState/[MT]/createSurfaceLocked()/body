{
  if (mSurface == null) {
    mReportDestroySurface=false;
    mSurfacePendingDestroy=false;
    mDrawPending=true;
    mCommitDrawPending=false;
    mReadyToShow=false;
    if (mAppToken != null) {
      mAppToken.allDrawn=false;
    }
    int flags=0;
    if ((mAttrs.flags & WindowManager.LayoutParams.FLAG_SECURE) != 0) {
      flags|=Surface.SECURE;
    }
    if (DEBUG_VISIBILITY)     Slog.v(WindowManagerService.TAG,"Creating surface in session " + mSession.mSurfaceSession + " window "+ this+ " w="+ mCompatFrame.width()+ " h="+ mCompatFrame.height()+ " format="+ mAttrs.format+ " flags="+ flags);
    int w=mCompatFrame.width();
    int h=mCompatFrame.height();
    if ((mAttrs.flags & LayoutParams.FLAG_SCALED) != 0) {
      w=mRequestedWidth;
      h=mRequestedHeight;
    }
    if (w <= 0)     w=1;
    if (h <= 0)     h=1;
    mSurfaceShown=false;
    mSurfaceLayer=0;
    mSurfaceAlpha=1;
    mSurfaceX=0;
    mSurfaceY=0;
    mSurfaceW=w;
    mSurfaceH=h;
    try {
      final boolean isHwAccelerated=(mAttrs.flags & WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED) != 0;
      final int format=isHwAccelerated ? PixelFormat.TRANSLUCENT : mAttrs.format;
      if (isHwAccelerated && mAttrs.format == PixelFormat.OPAQUE) {
        flags|=Surface.OPAQUE;
      }
      mSurface=new Surface(mSession.mSurfaceSession,mSession.mPid,mAttrs.getTitle().toString(),0,w,h,format,flags);
      if (SHOW_TRANSACTIONS || SHOW_SURFACE_ALLOC)       Slog.i(WindowManagerService.TAG,"  CREATE SURFACE " + mSurface + " IN SESSION "+ mSession.mSurfaceSession+ ": pid="+ mSession.mPid+ " format="+ mAttrs.format+ " flags=0x"+ Integer.toHexString(flags)+ " / "+ this);
    }
 catch (    Surface.OutOfResourcesException e) {
      Slog.w(WindowManagerService.TAG,"OutOfResourcesException creating surface");
      mService.reclaimSomeSurfaceMemoryLocked(this,"create",true);
      return null;
    }
catch (    Exception e) {
      Slog.e(WindowManagerService.TAG,"Exception creating surface",e);
      return null;
    }
    if (WindowManagerService.localLOGV)     Slog.v(WindowManagerService.TAG,"Got surface: " + mSurface + ", set left="+ mFrame.left+ " top="+ mFrame.top+ ", animLayer="+ mAnimLayer);
    if (SHOW_TRANSACTIONS) {
      Slog.i(WindowManagerService.TAG,">>> OPEN TRANSACTION createSurfaceLocked");
      WindowManagerService.logSurface(this,"CREATE pos=(" + mFrame.left + ","+ mFrame.top+ ") ("+ mCompatFrame.width()+ "x"+ mCompatFrame.height()+ "), layer="+ mAnimLayer+ " HIDE",null);
    }
    Surface.openTransaction();
    try {
      try {
        mSurfaceX=mFrame.left + mXOffset;
        mSurfaceY=mFrame.top + mYOffset;
        mSurface.setPosition(mSurfaceX,mSurfaceY);
        mSurfaceLayer=mAnimLayer;
        mSurface.setLayer(mAnimLayer);
        mSurfaceShown=false;
        mSurface.hide();
        if ((mAttrs.flags & WindowManager.LayoutParams.FLAG_DITHER) != 0) {
          if (SHOW_TRANSACTIONS)           WindowManagerService.logSurface(this,"DITHER",null);
          mSurface.setFlags(Surface.SURFACE_DITHER,Surface.SURFACE_DITHER);
        }
      }
 catch (      RuntimeException e) {
        Slog.w(WindowManagerService.TAG,"Error creating surface in " + w,e);
        mService.reclaimSomeSurfaceMemoryLocked(this,"create-init",true);
      }
      mLastHidden=true;
    }
  finally {
      Surface.closeTransaction();
      if (SHOW_TRANSACTIONS)       Slog.i(WindowManagerService.TAG,"<<< CLOSE TRANSACTION createSurfaceLocked");
    }
    if (WindowManagerService.localLOGV)     Slog.v(WindowManagerService.TAG,"Created surface " + this);
  }
  return mSurface;
}
