{
  Surface previewSurface=null;
  if (previewAllocation != null) {
    Parameters p=getParameters();
    Size previewSize=p.getPreviewSize();
    if (previewSize.width != previewAllocation.getType().getX() || previewSize.height != previewAllocation.getType().getY()) {
      throw new IllegalArgumentException("Allocation dimensions don't match preview dimensions: " + "Allocation is " + previewAllocation.getType().getX() + ", "+ previewAllocation.getType().getY()+ ". Preview is "+ previewSize.width+ ", "+ previewSize.height);
    }
    if ((previewAllocation.getUsage() & Allocation.USAGE_IO_INPUT) == 0) {
      throw new IllegalArgumentException("Allocation usage does not include USAGE_IO_INPUT");
    }
    if (previewAllocation.getType().getElement().getDataKind() != Element.DataKind.PIXEL_YUV) {
      throw new IllegalArgumentException("Allocation is not of a YUV type");
    }
    previewSurface=previewAllocation.getSurface();
    mUsingPreviewAllocation=true;
  }
 else {
    mUsingPreviewAllocation=false;
  }
  setPreviewCallbackSurface(previewSurface);
}
