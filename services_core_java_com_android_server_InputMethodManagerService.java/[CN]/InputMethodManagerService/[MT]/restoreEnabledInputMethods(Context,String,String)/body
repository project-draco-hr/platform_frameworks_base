{
  if (DEBUG_RESTORE) {
    Slog.i(TAG,"Restoring enabled input methods:");
    Slog.i(TAG,"prev=" + prevValue);
    Slog.i(TAG," new=" + newValue);
  }
  ArrayMap<String,ArraySet<String>> prevMap=InputMethodUtils.parseInputMethodsAndSubtypesString(prevValue);
  ArrayMap<String,ArraySet<String>> newMap=InputMethodUtils.parseInputMethodsAndSubtypesString(newValue);
  for (  ArrayMap.Entry<String,ArraySet<String>> entry : newMap.entrySet()) {
    final String imeId=entry.getKey();
    ArraySet<String> prevSubtypes=prevMap.get(imeId);
    if (prevSubtypes == null) {
      prevSubtypes=new ArraySet<>(2);
      prevMap.put(imeId,prevSubtypes);
    }
    prevSubtypes.addAll(entry.getValue());
  }
  final String mergedImesAndSubtypesString=InputMethodUtils.buildInputMethodsAndSubtypesString(prevMap);
  if (DEBUG_RESTORE) {
    Slog.i(TAG,"Merged IME string:");
    Slog.i(TAG,"     " + mergedImesAndSubtypesString);
  }
  Settings.Secure.putString(context.getContentResolver(),Settings.Secure.ENABLED_INPUT_METHODS,mergedImesAndSubtypesString);
}
