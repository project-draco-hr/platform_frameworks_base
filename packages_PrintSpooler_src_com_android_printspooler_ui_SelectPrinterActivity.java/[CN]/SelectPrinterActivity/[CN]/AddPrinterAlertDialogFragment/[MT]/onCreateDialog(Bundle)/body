{
  AlertDialog.Builder builder=new AlertDialog.Builder(getActivity()).setTitle(R.string.choose_print_service);
  final List<PrintServiceInfo> printServices=(List<PrintServiceInfo>)(List<?>)getArguments().getParcelableArrayList(FRAGMENT_ARGUMENT_PRINT_SERVICE_INFOS);
  final ArrayAdapter<String> adapter=new ArrayAdapter<>(getActivity(),android.R.layout.simple_list_item_1);
  final int printServiceCount=printServices.size();
  for (int i=0; i < printServiceCount; i++) {
    PrintServiceInfo printService=printServices.get(i);
    adapter.add(printService.getResolveInfo().loadLabel(getActivity().getPackageManager()).toString());
  }
  final String searchUri=Settings.Secure.getString(getActivity().getContentResolver(),Settings.Secure.PRINT_SERVICE_SEARCH_URI);
  final Intent viewIntent;
  if (!TextUtils.isEmpty(searchUri)) {
    Intent intent=new Intent(Intent.ACTION_VIEW,Uri.parse(searchUri));
    if (getActivity().getPackageManager().resolveActivity(intent,0) != null) {
      viewIntent=intent;
      mAddPrintServiceItem=getString(R.string.add_print_service_label);
      adapter.add(mAddPrintServiceItem);
    }
 else {
      viewIntent=null;
    }
  }
 else {
    viewIntent=null;
  }
  builder.setAdapter(adapter,new DialogInterface.OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int which){
      String item=adapter.getItem(which);
      if (item.equals(mAddPrintServiceItem)) {
        try {
          startActivity(viewIntent);
        }
 catch (        ActivityNotFoundException anfe) {
          Log.w(LOG_TAG,"Couldn't start add printer activity",anfe);
        }
      }
 else {
        PrintServiceInfo printService=printServices.get(which);
        ComponentName componentName=new ComponentName(printService.getResolveInfo().serviceInfo.packageName,printService.getAddPrintersActivityName());
        Intent intent=new Intent(Intent.ACTION_MAIN);
        intent.setComponent(componentName);
        try {
          startActivity(intent);
        }
 catch (        ActivityNotFoundException anfe) {
          Log.w(LOG_TAG,"Couldn't start add printer activity",anfe);
        }
      }
    }
  }
);
  return builder.create();
}
