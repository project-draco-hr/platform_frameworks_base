{
  mContext.enforceCallingOrSelfPermission(READ_NETWORK_USAGE_HISTORY,TAG);
synchronized (mStatsLock) {
    ensureUidStatsLoadedLocked();
    final long now=System.currentTimeMillis();
    final NetworkStats stats=new NetworkStats(end - start,24);
    final NetworkStats.Entry entry=new NetworkStats.Entry();
    NetworkStatsHistory.Entry historyEntry=null;
    for (    NetworkIdentitySet ident : mUidStats.keySet()) {
      if (templateMatches(template,ident)) {
        final LongSparseArray<NetworkStatsHistory> uidStats=mUidStats.get(ident);
        for (int i=0; i < uidStats.size(); i++) {
          final long packed=uidStats.keyAt(i);
          final int uid=unpackUid(packed);
          final int tag=unpackTag(packed);
          if (tag == TAG_NONE || includeTags) {
            final NetworkStatsHistory history=uidStats.valueAt(i);
            historyEntry=history.getValues(start,end,now,historyEntry);
            entry.iface=IFACE_ALL;
            entry.uid=uid;
            entry.tag=tag;
            entry.rxBytes=historyEntry.rxBytes;
            entry.rxPackets=historyEntry.rxPackets;
            entry.txBytes=historyEntry.txBytes;
            entry.txPackets=historyEntry.txPackets;
            entry.operations=historyEntry.operations;
            if (entry.rxBytes > 0 || entry.rxPackets > 0 || entry.txBytes > 0 || entry.txPackets > 0 || entry.operations > 0) {
              stats.combineValues(entry);
            }
          }
        }
      }
    }
    return stats;
  }
}
