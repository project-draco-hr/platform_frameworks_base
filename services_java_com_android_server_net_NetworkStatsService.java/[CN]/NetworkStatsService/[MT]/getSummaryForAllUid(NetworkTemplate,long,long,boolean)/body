{
  mContext.enforceCallingOrSelfPermission(READ_NETWORK_USAGE_HISTORY,TAG);
synchronized (mStatsLock) {
    ensureUidStatsLoadedLocked();
    final NetworkStats stats=new NetworkStats(end - start,24);
    long[] total=new long[2];
    for (    NetworkIdentitySet ident : mUidStats.keySet()) {
      if (templateMatches(template,ident)) {
        final LongSparseArray<NetworkStatsHistory> uidStats=mUidStats.get(ident);
        for (int i=0; i < uidStats.size(); i++) {
          final long packed=uidStats.keyAt(i);
          final int uid=unpackUid(packed);
          final int tag=unpackTag(packed);
          if (tag == TAG_NONE || includeTags) {
            final NetworkStatsHistory history=uidStats.valueAt(i);
            total=history.getTotalData(start,end,total);
            final long rx=total[0];
            final long tx=total[1];
            if (rx > 0 || tx > 0) {
              stats.combineEntry(IFACE_ALL,uid,tag,rx,tx);
            }
          }
        }
      }
    }
    return stats;
  }
}
