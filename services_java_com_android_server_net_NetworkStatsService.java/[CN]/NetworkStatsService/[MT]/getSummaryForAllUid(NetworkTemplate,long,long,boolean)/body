{
  mContext.enforceCallingOrSelfPermission(READ_NETWORK_USAGE_HISTORY,TAG);
synchronized (mStatsLock) {
    ensureUidStatsLoadedLocked();
    final NetworkStats stats=new NetworkStats(end - start,24);
    final NetworkStats.Entry entry=new NetworkStats.Entry();
    long[] total=new long[2];
    for (    NetworkIdentitySet ident : mUidStats.keySet()) {
      if (templateMatches(template,ident)) {
        final LongSparseArray<NetworkStatsHistory> uidStats=mUidStats.get(ident);
        for (int i=0; i < uidStats.size(); i++) {
          final long packed=uidStats.keyAt(i);
          final int uid=unpackUid(packed);
          final int tag=unpackTag(packed);
          if (tag == TAG_NONE || includeTags) {
            final NetworkStatsHistory history=uidStats.valueAt(i);
            total=history.getTotalData(start,end,total);
            entry.iface=IFACE_ALL;
            entry.uid=uid;
            entry.tag=tag;
            entry.rxBytes=total[0];
            entry.txBytes=total[1];
            if (entry.rxBytes > 0 || entry.txBytes > 0) {
              stats.combineValues(entry);
            }
          }
        }
      }
    }
    return stats;
  }
}
