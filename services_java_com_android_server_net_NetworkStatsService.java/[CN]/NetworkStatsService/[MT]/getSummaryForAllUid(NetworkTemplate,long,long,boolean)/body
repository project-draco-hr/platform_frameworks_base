{
  mContext.enforceCallingOrSelfPermission(READ_NETWORK_USAGE_HISTORY,TAG);
synchronized (mStatsLock) {
    ensureUidStatsLoadedLocked();
    final long now=System.currentTimeMillis();
    final NetworkStats stats=new NetworkStats(end - start,24);
    final NetworkStats.Entry entry=new NetworkStats.Entry();
    NetworkStatsHistory.Entry historyEntry=null;
    for (    UidStatsKey key : mUidStats.keySet()) {
      if (templateMatches(template,key.ident)) {
        if (key.tag == TAG_NONE || includeTags) {
          final NetworkStatsHistory history=mUidStats.get(key);
          historyEntry=history.getValues(start,end,now,historyEntry);
          entry.iface=IFACE_ALL;
          entry.uid=key.uid;
          entry.set=key.set;
          entry.tag=key.tag;
          entry.rxBytes=historyEntry.rxBytes;
          entry.rxPackets=historyEntry.rxPackets;
          entry.txBytes=historyEntry.txBytes;
          entry.txPackets=historyEntry.txPackets;
          entry.operations=historyEntry.operations;
          if (entry.rxBytes > 0 || entry.rxPackets > 0 || entry.txBytes > 0 || entry.txPackets > 0 || entry.operations > 0) {
            stats.combineValues(entry);
          }
        }
      }
    }
    return stats;
  }
}
