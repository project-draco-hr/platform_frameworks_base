{
  if (LOGV)   Slog.v(TAG,"writeUidStatsLocked()");
  if (!mUidStatsLoaded) {
    Slog.w(TAG,"asked to write UID stats when not loaded; skipping");
    return;
  }
  FileOutputStream fos=null;
  try {
    fos=mUidFile.startWrite();
    final DataOutputStream out=new DataOutputStream(new BufferedOutputStream(fos));
    out.writeInt(FILE_MAGIC);
    out.writeInt(VERSION_UID_WITH_TAG);
    final int size=mUidStats.size();
    out.writeInt(size);
    for (    NetworkIdentitySet ident : mUidStats.keySet()) {
      final LongSparseArray<NetworkStatsHistory> uidStats=mUidStats.get(ident);
      ident.writeToStream(out);
      final int childSize=uidStats.size();
      out.writeInt(childSize);
      for (int i=0; i < childSize; i++) {
        final long packed=uidStats.keyAt(i);
        final int uid=unpackUid(packed);
        final int tag=unpackTag(packed);
        final NetworkStatsHistory history=uidStats.valueAt(i);
        out.writeInt(uid);
        out.writeInt(tag);
        history.writeToStream(out);
      }
    }
    out.flush();
    mUidFile.finishWrite(fos);
  }
 catch (  IOException e) {
    if (fos != null) {
      mUidFile.failWrite(fos);
    }
  }
}
