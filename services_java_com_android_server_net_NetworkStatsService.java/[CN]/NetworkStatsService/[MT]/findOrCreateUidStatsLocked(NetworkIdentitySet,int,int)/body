{
  ensureUidStatsLoadedLocked();
  LongSparseArray<NetworkStatsHistory> uidStats=mUidStats.get(ident);
  if (uidStats == null) {
    uidStats=new LongSparseArray<NetworkStatsHistory>();
    mUidStats.put(ident,uidStats);
  }
  final long packed=packUidAndTag(uid,tag);
  final NetworkStatsHistory existing=uidStats.get(packed);
  final long bucketDuration=mSettings.getUidBucketDuration();
  NetworkStatsHistory updated=null;
  if (existing == null) {
    updated=new NetworkStatsHistory(bucketDuration,10);
  }
 else   if (existing.getBucketDuration() != bucketDuration) {
    updated=new NetworkStatsHistory(bucketDuration,estimateResizeBuckets(existing,bucketDuration));
    updated.recordEntireHistory(existing);
  }
  if (updated != null) {
    uidStats.put(packed,updated);
    return updated;
  }
 else {
    return existing;
  }
}
