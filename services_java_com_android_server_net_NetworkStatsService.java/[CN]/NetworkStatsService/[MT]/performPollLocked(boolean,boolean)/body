{
  if (LOGV)   Slog.v(TAG,"performPollLocked()");
  final long startRealtime=SystemClock.elapsedRealtime();
  if (mTime.getCacheAge() > mSettings.getTimeCacheMaxAge()) {
    mTime.forceRefresh();
  }
  final long currentTime=mTime.hasCache() ? mTime.currentTimeMillis() : System.currentTimeMillis();
  final long persistThreshold=mSettings.getPersistThreshold();
  final NetworkStats networkSnapshot;
  final NetworkStats uidSnapshot;
  try {
    networkSnapshot=mNetworkManager.getNetworkStatsSummary();
    uidSnapshot=detailedPoll ? mNetworkManager.getNetworkStatsUidDetail(UID_ALL) : null;
  }
 catch (  IllegalStateException e) {
    Slog.w(TAG,"problem reading network stats: " + e);
    return;
  }
catch (  RemoteException e) {
    Slog.w(TAG,"problem reading network stats: " + e);
    return;
  }
  performNetworkPollLocked(networkSnapshot,currentTime);
  final NetworkStats persistNetworkDelta=computeStatsDelta(mLastPersistNetworkSnapshot,networkSnapshot,true);
  if (forcePersist || persistNetworkDelta.getTotalBytes() > persistThreshold) {
    writeNetworkStatsLocked();
    mLastPersistNetworkSnapshot=networkSnapshot;
  }
  if (detailedPoll) {
    performUidPollLocked(uidSnapshot,currentTime);
    final NetworkStats persistUidDelta=computeStatsDelta(mLastPersistUidSnapshot,uidSnapshot,true);
    if (forcePersist || persistUidDelta.getTotalBytes() > persistThreshold) {
      writeUidStatsLocked();
      mLastPersistUidSnapshot=networkSnapshot;
    }
  }
  if (LOGV) {
    final long duration=SystemClock.elapsedRealtime() - startRealtime;
    Slog.v(TAG,"performPollLocked() took " + duration + "ms");
  }
  if (detailedPoll) {
    performSample();
  }
  final Intent updatedIntent=new Intent(ACTION_NETWORK_STATS_UPDATED);
  updatedIntent.setFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);
  mContext.sendBroadcast(updatedIntent,READ_NETWORK_USAGE_HISTORY);
}
