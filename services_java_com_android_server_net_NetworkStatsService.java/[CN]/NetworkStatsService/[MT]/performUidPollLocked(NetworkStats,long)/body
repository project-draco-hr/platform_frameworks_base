{
  ensureUidStatsLoadedLocked();
  final NetworkStats delta=computeStatsDelta(mLastPollUidSnapshot,uidSnapshot,false);
  final NetworkStats operationsDelta=computeStatsDelta(mLastPollOperationsSnapshot,mOperations,false);
  final long timeStart=currentTime - delta.getElapsedRealtime();
  NetworkStats.Entry entry=null;
  NetworkStats.Entry operationsEntry=null;
  for (int i=0; i < delta.size(); i++) {
    entry=delta.getValues(i,entry);
    final NetworkIdentitySet ident=mActiveIfaces.get(entry.iface);
    if (ident == null) {
      continue;
    }
    final int j=operationsDelta.findIndex(IFACE_ALL,entry.uid,entry.set,entry.tag);
    if (j != -1) {
      operationsEntry=operationsDelta.getValues(j,operationsEntry);
      entry.operations=operationsEntry.operations;
    }
    final NetworkStatsHistory history=findOrCreateUidStatsLocked(ident,entry.uid,entry.set,entry.tag);
    history.recordData(timeStart,currentTime,entry);
  }
  final long maxUidHistory=mSettings.getUidMaxHistory();
  final long maxTagHistory=mSettings.getTagMaxHistory();
  for (  UidStatsKey key : mUidStats.keySet()) {
    final NetworkStatsHistory history=mUidStats.get(key);
    if (key.tag == TAG_NONE) {
      history.removeBucketsBefore(currentTime - maxUidHistory);
    }
 else {
      history.removeBucketsBefore(currentTime - maxTagHistory);
    }
  }
  mLastPollUidSnapshot=uidSnapshot;
  mLastPollOperationsSnapshot=mOperations;
  mOperations=new NetworkStats(0L,10);
}
