{
  ensureUidStatsLoadedLocked();
  final NetworkStats delta=computeStatsDelta(mLastUidSnapshot,uidSnapshot);
  final long timeStart=currentTime - delta.getElapsedRealtime();
  NetworkStats.Entry entry=null;
  for (int i=0; i < delta.size(); i++) {
    entry=delta.getValues(i,entry);
    final NetworkIdentitySet ident=mActiveIfaces.get(entry.iface);
    if (ident == null) {
      continue;
    }
    final NetworkStatsHistory history=findOrCreateUidStatsLocked(ident,entry.uid,entry.tag);
    history.recordData(timeStart,currentTime,entry.rxBytes,entry.txBytes);
  }
  final long maxUidHistory=mSettings.getUidMaxHistory();
  final long maxTagHistory=mSettings.getTagMaxHistory();
  for (  LongSparseArray<NetworkStatsHistory> uidStats : mUidStats.values()) {
    for (int i=0; i < uidStats.size(); i++) {
      final long packed=uidStats.keyAt(i);
      final NetworkStatsHistory history=uidStats.valueAt(i);
      if (unpackTag(packed) == TAG_NONE) {
        history.removeBucketsBefore(currentTime - maxUidHistory);
      }
 else {
        history.removeBucketsBefore(currentTime - maxTagHistory);
      }
    }
  }
  mLastUidSnapshot=uidSnapshot;
}
