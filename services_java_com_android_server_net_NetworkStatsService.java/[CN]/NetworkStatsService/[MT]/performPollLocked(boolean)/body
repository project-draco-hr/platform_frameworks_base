{
  if (LOGV)   Slog.v(TAG,"performPollLocked()");
  if (mTime.getCacheAge() > mSettings.getTimeCacheMaxAge()) {
    mTime.forceRefresh();
  }
  final long currentTime=mTime.hasCache() ? mTime.currentTimeMillis() : System.currentTimeMillis();
  final NetworkStats networkStats;
  final NetworkStats uidStats;
  try {
    networkStats=mNetworkManager.getNetworkStatsSummary();
    uidStats=detailedPoll ? mNetworkManager.getNetworkStatsDetail() : null;
  }
 catch (  RemoteException e) {
    Slog.w(TAG,"problem reading network stats");
    return;
  }
  performNetworkPollLocked(networkStats,currentTime);
  if (detailedPoll) {
    performUidPollLocked(uidStats,currentTime);
  }
  final NetworkStats persistDelta=computeStatsDelta(mLastNetworkPersist,networkStats);
  final long persistThreshold=mSettings.getPersistThreshold();
  for (  String iface : persistDelta.getUniqueIfaces()) {
    final int index=persistDelta.findIndex(iface,UID_ALL);
    if (persistDelta.rx[index] > persistThreshold || persistDelta.tx[index] > persistThreshold) {
      writeNetworkStatsLocked();
      writeUidStatsLocked();
      mLastNetworkPersist=networkStats;
      break;
    }
  }
  final Intent updatedIntent=new Intent(ACTION_NETWORK_STATS_UPDATED);
  updatedIntent.setFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);
  mContext.sendBroadcast(updatedIntent,READ_NETWORK_USAGE_HISTORY);
}
