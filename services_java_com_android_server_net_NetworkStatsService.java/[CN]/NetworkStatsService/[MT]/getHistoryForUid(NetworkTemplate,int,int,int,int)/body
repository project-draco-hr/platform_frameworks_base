{
  mContext.enforceCallingOrSelfPermission(READ_NETWORK_USAGE_HISTORY,TAG);
synchronized (mStatsLock) {
    ensureUidStatsLoadedLocked();
    final NetworkStatsHistory combined=new NetworkStatsHistory(mSettings.getUidBucketDuration(),estimateUidBuckets(),fields);
    for (    UidStatsKey key : mUidStats.keySet()) {
      final boolean setMatches=set == SET_ALL || key.set == set;
      if (templateMatches(template,key.ident) && key.uid == uid && setMatches && key.tag == tag) {
        final NetworkStatsHistory history=mUidStats.get(key);
        combined.recordEntireHistory(history);
      }
    }
    return combined;
  }
}
