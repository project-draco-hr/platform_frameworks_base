{
  mContext.enforceCallingOrSelfPermission(READ_NETWORK_USAGE_HISTORY,TAG);
synchronized (mStatsLock) {
    final long now=System.currentTimeMillis();
    final NetworkStats stats=new NetworkStats(end - start,1);
    final NetworkStats.Entry entry=new NetworkStats.Entry();
    NetworkStatsHistory.Entry historyEntry=null;
    for (    NetworkIdentitySet ident : mNetworkStats.keySet()) {
      if (templateMatches(template,ident)) {
        final NetworkStatsHistory history=mNetworkStats.get(ident);
        historyEntry=history.getValues(start,end,now,historyEntry);
        entry.iface=IFACE_ALL;
        entry.uid=UID_ALL;
        entry.tag=TAG_NONE;
        entry.rxBytes=historyEntry.rxBytes;
        entry.rxPackets=historyEntry.rxPackets;
        entry.txBytes=historyEntry.txBytes;
        entry.txPackets=historyEntry.txPackets;
        stats.combineValues(entry);
      }
    }
    return stats;
  }
}
