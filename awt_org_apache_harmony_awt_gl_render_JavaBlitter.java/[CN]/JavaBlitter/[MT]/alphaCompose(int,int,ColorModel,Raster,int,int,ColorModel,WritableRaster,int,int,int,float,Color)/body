{
  Object srcPixel, dstPixel;
  int srcConstAllpha=(int)(alpha * 255 + 0.5f);
  int srcRGB, dstRGB=0;
  if (bgcolor != null) {
    dstRGB=bgcolor.getRGB();
  }
  for (int sy=srcY, dy=dstY, srcYMax=srcY + height; sy < srcYMax; sy++, dy++) {
    for (int sx=srcX, dx=dstX, srcXMax=srcX + width; sx < srcXMax; sx++, dx++) {
      srcPixel=srcRast.getDataElements(sx,sy,null);
      srcRGB=srcCM.getRGB(srcPixel);
      if (bgcolor == null) {
        dstPixel=dstRast.getDataElements(dx,dy,null);
        dstRGB=dstCM.getRGB(dstPixel);
      }
      dstRGB=compose(srcRGB,srcCM.isAlphaPremultiplied(),dstRGB,dstCM.hasAlpha(),dstCM.isAlphaPremultiplied(),rule,srcConstAllpha);
      dstPixel=dstCM.getDataElements(dstRGB,null);
      dstRast.setDataElements(dx,dy,dstPixel);
    }
  }
}
