{
  if (!mVisible) {
    if (DEBUG) {
      Log.d(TAG,"Suppressed drawFrame since wallpaper is not visible.");
    }
    return;
  }
  if (!mRedrawNeeded && !mOffsetsChanged) {
    if (DEBUG) {
      Log.d(TAG,"Suppressed drawFrame since redraw is not needed " + "and offsets have not changed.");
    }
    return;
  }
  if (mBackgroundWidth < 0 || mBackgroundHeight < 0) {
    updateWallpaperLocked();
  }
  SurfaceHolder sh=getSurfaceHolder();
  final Rect frame=sh.getSurfaceFrame();
  final int dw=frame.width();
  final int dh=frame.height();
  final int availw=dw - mBackgroundWidth;
  final int availh=dh - mBackgroundHeight;
  int xPixels=availw < 0 ? (int)(availw * mXOffset + .5f) : (availw / 2);
  int yPixels=availh < 0 ? (int)(availh * mYOffset + .5f) : (availh / 2);
  mOffsetsChanged=false;
  if (!mRedrawNeeded && xPixels == mLastXTranslation && yPixels == mLastYTranslation) {
    if (DEBUG) {
      Log.d(TAG,"Suppressed drawFrame since the image has not " + "actually moved an integral number of pixels.");
    }
    return;
  }
  mRedrawNeeded=false;
  mLastXTranslation=xPixels;
  mLastYTranslation=yPixels;
  if (mBackground == null) {
    updateWallpaperLocked();
  }
  Canvas c=sh.lockCanvas();
  if (c != null) {
    try {
      if (DEBUG) {
        Log.d(TAG,"Redrawing: xPixels=" + xPixels + ", yPixels="+ yPixels);
      }
      c.translate(xPixels,yPixels);
      if (availw < 0 || availh < 0) {
        c.save(Canvas.CLIP_SAVE_FLAG);
        c.clipRect(0,0,mBackgroundWidth,mBackgroundHeight,Op.DIFFERENCE);
        c.drawColor(0xff000000);
        c.restore();
      }
      if (mBackground != null) {
        mBackground.draw(c);
      }
    }
  finally {
      sh.unlockCanvasAndPost(c);
    }
  }
  if (FIXED_SIZED_SURFACE) {
    mBackground=null;
    mWallpaperManager.forgetLoadedWallpaper();
  }
}
