{
  SurfaceHolder sh=getSurfaceHolder();
  final Rect frame=sh.getSurfaceFrame();
  final int dw=frame.width();
  final int dh=frame.height();
  int newRotation=((WindowManager)getSystemService(WINDOW_SERVICE)).getDefaultDisplay().getRotation();
  boolean redrawNeeded=dw != mBackgroundWidth || dh != mBackgroundHeight || newRotation != mLastRotation;
  if (!redrawNeeded && !mOffsetsChanged) {
    if (DEBUG) {
      Log.d(TAG,"Suppressed drawFrame since redraw is not needed " + "and offsets have not changed.");
    }
    return;
  }
  mLastRotation=newRotation;
  if (mBackground == null || dw != mBackgroundWidth || dw != mBackgroundHeight) {
    if (DEBUG) {
      Log.d(TAG,"Reloading bitmap");
    }
    mWallpaperManager.forgetLoadedWallpaper();
    updateWallpaperLocked();
  }
  final int availw=dw - mBackgroundWidth;
  final int availh=dh - mBackgroundHeight;
  int xPixels=availw < 0 ? (int)(availw * mXOffset + .5f) : (availw / 2);
  int yPixels=availh < 0 ? (int)(availh * mYOffset + .5f) : (availh / 2);
  mOffsetsChanged=false;
  mRedrawNeeded=false;
  mLastXTranslation=xPixels;
  mLastYTranslation=yPixels;
  if (!redrawNeeded && xPixels == mLastXTranslation && yPixels == mLastYTranslation) {
    if (DEBUG) {
      Log.d(TAG,"Suppressed drawFrame since the image has not " + "actually moved an integral number of pixels.");
    }
    return;
  }
  if (DEBUG) {
    Log.d(TAG,"Redrawing wallpaper");
  }
  if (mIsHwAccelerated) {
    if (!drawWallpaperWithOpenGL(sh,availw,availh,xPixels,yPixels)) {
      drawWallpaperWithCanvas(sh,availw,availh,xPixels,yPixels);
    }
  }
 else {
    drawWallpaperWithCanvas(sh,availw,availh,xPixels,yPixels);
    if (FIXED_SIZED_SURFACE) {
      mBackground=null;
      mWallpaperManager.forgetLoadedWallpaper();
    }
  }
}
