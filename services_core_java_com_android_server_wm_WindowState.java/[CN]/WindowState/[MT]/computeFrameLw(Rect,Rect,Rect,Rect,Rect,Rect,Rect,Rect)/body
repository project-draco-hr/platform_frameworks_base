{
  if (mWillReplaceWindow && (mAnimatingExit || !mReplacingRemoveRequested)) {
    return;
  }
  mHaveFrame=true;
  final Task task=getTask();
  final boolean fullscreenTask=!inMultiWindowMode();
  final boolean windowsAreFloating=task != null && task.isFloating();
  if (fullscreenTask) {
    mInsetFrame.setEmpty();
  }
 else {
    task.getTempInsetBounds(mInsetFrame);
  }
  if (mInsetFrame.isEmpty() && (fullscreenTask || layoutInParentFrame())) {
    mContainingFrame.set(pf);
    mDisplayFrame.set(df);
  }
 else {
    task.getBounds(mContainingFrame);
    if (mAppToken != null && !mAppToken.mFrozenBounds.isEmpty()) {
      Rect frozen=mAppToken.mFrozenBounds.peek();
      mContainingFrame.right=mContainingFrame.left + frozen.width();
      mContainingFrame.bottom=mContainingFrame.top + frozen.height();
    }
    final WindowState imeWin=mService.mInputMethodWindow;
    if (imeWin != null && imeWin.isVisibleNow() && mService.mInputMethodTarget == this && mContainingFrame.bottom > cf.bottom) {
      mContainingFrame.top-=mContainingFrame.bottom - cf.bottom;
    }
    if (windowsAreFloating) {
      if (mContainingFrame.isEmpty()) {
        mContainingFrame.set(cf);
      }
    }
    mDisplayFrame.set(mContainingFrame);
  }
  final int pw=mContainingFrame.width();
  final int ph=mContainingFrame.height();
  if (!mParentFrame.equals(pf)) {
    mParentFrame.set(pf);
    mContentChanged=true;
  }
  if (mRequestedWidth != mLastRequestedWidth || mRequestedHeight != mLastRequestedHeight) {
    mLastRequestedWidth=mRequestedWidth;
    mLastRequestedHeight=mRequestedHeight;
    mContentChanged=true;
  }
  mOverscanFrame.set(of);
  mContentFrame.set(cf);
  mVisibleFrame.set(vf);
  mDecorFrame.set(dcf);
  mStableFrame.set(sf);
  final boolean hasOutsets=osf != null;
  if (hasOutsets) {
    mOutsetFrame.set(osf);
  }
  final int fw=mFrame.width();
  final int fh=mFrame.height();
  applyGravityAndUpdateFrame();
  if (hasOutsets) {
    mOutsets.set(Math.max(mContentFrame.left - mOutsetFrame.left,0),Math.max(mContentFrame.top - mOutsetFrame.top,0),Math.max(mOutsetFrame.right - mContentFrame.right,0),Math.max(mOutsetFrame.bottom - mContentFrame.bottom,0));
  }
 else {
    mOutsets.set(0,0,0,0);
  }
  final Rect frame=!mInsetFrame.isEmpty() ? mInsetFrame : mFrame;
  if (windowsAreFloating && !mFrame.isEmpty()) {
    final int height=Math.min(mFrame.height(),mContentFrame.height());
    final int width=Math.min(mContentFrame.width(),mFrame.width());
    final DisplayMetrics displayMetrics=getDisplayContent().getDisplayMetrics();
    final int minVisibleHeight=WindowManagerService.dipToPixel(MINIMUM_VISIBLE_HEIGHT_IN_DP,displayMetrics);
    final int minVisibleWidth=WindowManagerService.dipToPixel(MINIMUM_VISIBLE_WIDTH_IN_DP,displayMetrics);
    final int top=Math.max(mContentFrame.top,Math.min(mFrame.top,mContentFrame.bottom - minVisibleHeight));
    final int left=Math.max(mContentFrame.left + minVisibleWidth - width,Math.min(mFrame.left,mContentFrame.right - minVisibleWidth));
    mFrame.set(left,top,left + width,top + height);
    mContentFrame.set(mFrame);
    mVisibleFrame.set(mContentFrame);
    mStableFrame.set(mContentFrame);
  }
 else   if (mAttrs.type == TYPE_DOCK_DIVIDER) {
    mDisplayContent.getDockedDividerController().positionDockedStackedDivider(mFrame);
    mContentFrame.set(mFrame);
    if (!mFrame.equals(mLastFrame)) {
      mMovedByResize=true;
    }
  }
 else {
    mContentFrame.set(Math.max(mContentFrame.left,frame.left),Math.max(mContentFrame.top,frame.top),Math.min(mContentFrame.right,frame.right),Math.min(mContentFrame.bottom,frame.bottom));
    mVisibleFrame.set(Math.max(mVisibleFrame.left,frame.left),Math.max(mVisibleFrame.top,frame.top),Math.min(mVisibleFrame.right,frame.right),Math.min(mVisibleFrame.bottom,frame.bottom));
    mStableFrame.set(Math.max(mStableFrame.left,frame.left),Math.max(mStableFrame.top,frame.top),Math.min(mStableFrame.right,frame.right),Math.min(mStableFrame.bottom,frame.bottom));
  }
  if (fullscreenTask && !windowsAreFloating) {
    mOverscanInsets.set(Math.max(mOverscanFrame.left - frame.left,0),Math.max(mOverscanFrame.top - frame.top,0),Math.max(frame.right - mOverscanFrame.right,0),Math.max(frame.bottom - mOverscanFrame.bottom,0));
  }
  if (mAttrs.type == TYPE_DOCK_DIVIDER) {
    mStableInsets.set(Math.max(mStableFrame.left - mDisplayFrame.left,0),Math.max(mStableFrame.top - mDisplayFrame.top,0),Math.max(mDisplayFrame.right - mStableFrame.right,0),Math.max(mDisplayFrame.bottom - mStableFrame.bottom,0));
    mContentInsets.setEmpty();
    mVisibleInsets.setEmpty();
  }
 else {
    getDisplayContent().getLogicalDisplayRect(mContentInsets);
    boolean overrideRightInset=!fullscreenTask && mFrame.right > mContentInsets.right;
    boolean overrideBottomInset=!fullscreenTask && mFrame.bottom > mContentInsets.bottom;
    mContentInsets.set(mContentFrame.left - frame.left,mContentFrame.top - frame.top,overrideRightInset ? 0 : frame.right - mContentFrame.right,overrideBottomInset ? 0 : frame.bottom - mContentFrame.bottom);
    mVisibleInsets.set(mVisibleFrame.left - frame.left,mVisibleFrame.top - frame.top,overrideRightInset ? 0 : frame.right - mVisibleFrame.right,overrideBottomInset ? 0 : frame.bottom - mVisibleFrame.bottom);
    mStableInsets.set(Math.max(mStableFrame.left - frame.left,0),Math.max(mStableFrame.top - frame.top,0),overrideRightInset ? 0 : Math.max(frame.right - mStableFrame.right,0),overrideBottomInset ? 0 : Math.max(frame.bottom - mStableFrame.bottom,0));
  }
  if (!mInsetFrame.isEmpty()) {
    mContentFrame.set(mFrame);
    mContentFrame.top+=mContentInsets.top;
    mContentFrame.bottom-=mContentInsets.bottom;
    mContentFrame.left+=mContentInsets.left;
    mContentFrame.right-=mContentInsets.right;
    mVisibleFrame.set(mFrame);
    mVisibleFrame.top+=mVisibleInsets.top;
    mVisibleFrame.bottom-=mVisibleInsets.bottom;
    mVisibleFrame.left+=mVisibleInsets.left;
    mVisibleFrame.right-=mVisibleInsets.right;
    mStableFrame.set(mFrame);
    mStableFrame.top+=mStableInsets.top;
    mStableFrame.bottom-=mStableInsets.bottom;
    mStableFrame.left+=mStableInsets.left;
    mStableFrame.right-=mStableInsets.right;
  }
  mCompatFrame.set(mFrame);
  if (mEnforceSizeCompat) {
    mOverscanInsets.scale(mInvGlobalScale);
    mContentInsets.scale(mInvGlobalScale);
    mVisibleInsets.scale(mInvGlobalScale);
    mStableInsets.scale(mInvGlobalScale);
    mOutsets.scale(mInvGlobalScale);
    mCompatFrame.scale(mInvGlobalScale);
  }
  if (mIsWallpaper && (fw != mFrame.width() || fh != mFrame.height())) {
    final DisplayContent displayContent=getDisplayContent();
    if (displayContent != null) {
      final DisplayInfo displayInfo=displayContent.getDisplayInfo();
      mService.mWallpaperControllerLocked.updateWallpaperOffset(this,displayInfo.logicalWidth,displayInfo.logicalHeight,false);
    }
  }
  if (DEBUG_LAYOUT || WindowManagerService.localLOGV)   Slog.v(TAG,"Resolving (mRequestedWidth=" + mRequestedWidth + ", mRequestedheight="+ mRequestedHeight+ ") to"+ " (pw="+ pw+ ", ph="+ ph+ "): frame="+ mFrame.toShortString()+ " ci="+ mContentInsets.toShortString()+ " vi="+ mVisibleInsets.toShortString()+ " si="+ mStableInsets.toShortString()+ " of="+ mOutsets.toShortString());
}
